#!/usr/bin/env node

/**
 * Script de validaci√≥n para las mejoras de seguridad
 * Verifica que todas las validaciones adicionales est√©n implementadas
 */

const fs = require('fs');
const path = require('path');

console.log('üõ°Ô∏è VALIDANDO MEJORAS DE SEGURIDAD');
console.log('=' .repeat(50));

/**
 * Validar que los archivos de seguridad existan
 */
function validateSecurityFiles() {
  const securityFiles = [
    'src/lib/auth/jwt-validation.ts',
    'src/lib/auth/csrf-protection.ts',
    'src/lib/auth/rate-limiting.ts',
    'src/lib/auth/enhanced-security-middleware.ts',
    'src/__tests__/security-validations-enhanced.test.ts'
  ];

  console.log('\nüìÅ VERIFICACIONES DE ARCHIVOS DE SEGURIDAD:');
  
  securityFiles.forEach(filePath => {
    const fullPath = path.join(process.cwd(), filePath);
    if (fs.existsSync(fullPath)) {
      console.log(`‚úÖ ${filePath}`);
    } else {
      throw new Error(`‚ùå Archivo de seguridad no encontrado: ${filePath}`);
    }
  });

  return true;
}

/**
 * Validar funciones de validaci√≥n JWT
 */
function validateJWTValidations() {
  const jwtPath = path.join(process.cwd(), 'src', 'lib', 'auth', 'jwt-validation.ts');
  const content = fs.readFileSync(jwtPath, 'utf8');
  
  const checks = [
    {
      name: 'Funci√≥n validateJWTIntegrity implementada',
      test: content.includes('export async function validateJWTIntegrity'),
      required: true
    },
    {
      name: 'Funci√≥n validateJWTPermissions implementada',
      test: content.includes('export async function validateJWTPermissions'),
      required: true
    },
    {
      name: 'Middleware withJWTValidation implementado',
      test: content.includes('export function withJWTValidation'),
      required: true
    },
    {
      name: 'Verificaci√≥n de algoritmos permitidos',
      test: content.includes('allowedAlgorithms') && content.includes('RS256'),
      required: true
    },
    {
      name: 'Validaci√≥n de claims requeridos',
      test: content.includes('requiredClaims') && content.includes('sub'),
      required: true
    },
    {
      name: 'Detecci√≥n autom√°tica de admin desde token',
      test: content.includes('metadata?.role') || content.includes('sessionClaims?.metadata'),
      required: true
    }
  ];

  console.log('\nüîê VERIFICACIONES DE VALIDACI√ìN JWT:');
  let passed = 0;
  let failed = 0;

  checks.forEach(check => {
    if (check.test) {
      console.log(`‚úÖ ${check.name}`);
      passed++;
    } else {
      console.log(`${check.required ? '‚ùå' : '‚ö†Ô∏è'} ${check.name}`);
      if (check.required) failed++;
    }
  });

  if (failed > 0) {
    throw new Error(`‚ùå ${failed} verificaciones JWT cr√≠ticas fallaron`);
  }

  return { passed, failed, total: checks.length };
}

/**
 * Validar protecci√≥n CSRF
 */
function validateCSRFProtection() {
  const csrfPath = path.join(process.cwd(), 'src', 'lib', 'auth', 'csrf-protection.ts');
  const content = fs.readFileSync(csrfPath, 'utf8');
  
  const checks = [
    {
      name: 'Funci√≥n validateRequestOrigin implementada',
      test: content.includes('export async function validateRequestOrigin'),
      required: true
    },
    {
      name: 'Middleware withCSRFProtection implementado',
      test: content.includes('export function withCSRFProtection'),
      required: true
    },
    {
      name: 'Validaci√≥n de or√≠genes permitidos',
      test: content.includes('allowedOrigins') && content.includes('localhost'),
      required: true
    },
    {
      name: 'Detecci√≥n de User-Agent sospechoso',
      test: content.includes('isSuspiciousUserAgent') && content.includes('bot'),
      required: true
    },
    {
      name: 'Generaci√≥n de tokens CSRF',
      test: content.includes('generateCSRFToken') && content.includes('crypto'),
      required: true
    },
    {
      name: 'Middleware espec√≠fico para admin',
      test: content.includes('withAdminCSRFProtection'),
      required: true
    }
  ];

  console.log('\nüõ°Ô∏è VERIFICACIONES DE PROTECCI√ìN CSRF:');
  let passed = 0;
  let failed = 0;

  checks.forEach(check => {
    if (check.test) {
      console.log(`‚úÖ ${check.name}`);
      passed++;
    } else {
      console.log(`${check.required ? '‚ùå' : '‚ö†Ô∏è'} ${check.name}`);
      if (check.required) failed++;
    }
  });

  if (failed > 0) {
    throw new Error(`‚ùå ${failed} verificaciones CSRF cr√≠ticas fallaron`);
  }

  return { passed, failed, total: checks.length };
}

/**
 * Validar rate limiting
 */
function validateRateLimiting() {
  const rateLimitPath = path.join(process.cwd(), 'src', 'lib', 'auth', 'rate-limiting.ts');
  const content = fs.readFileSync(rateLimitPath, 'utf8');
  
  const checks = [
    {
      name: 'Funci√≥n checkRateLimit implementada',
      test: content.includes('export async function checkRateLimit'),
      required: true
    },
    {
      name: 'Configuraciones predefinidas',
      test: content.includes('RATE_LIMIT_CONFIGS') && content.includes('auth') && content.includes('admin'),
      required: true
    },
    {
      name: 'Middleware withRateLimit implementado',
      test: content.includes('export function withRateLimit'),
      required: true
    },
    {
      name: 'Rate limiting espec√≠fico para auth',
      test: content.includes('withAuthRateLimit'),
      required: true
    },
    {
      name: 'Rate limiting espec√≠fico para admin',
      test: content.includes('withAdminRateLimit'),
      required: true
    },
    {
      name: 'Headers de rate limiting',
      test: content.includes('X-RateLimit-Limit') && content.includes('Retry-After'),
      required: true
    }
  ];

  console.log('\n‚è±Ô∏è VERIFICACIONES DE RATE LIMITING:');
  let passed = 0;
  let failed = 0;

  checks.forEach(check => {
    if (check.test) {
      console.log(`‚úÖ ${check.name}`);
      passed++;
    } else {
      console.log(`${check.required ? '‚ùå' : '‚ö†Ô∏è'} ${check.name}`);
      if (check.required) failed++;
    }
  });

  if (failed > 0) {
    throw new Error(`‚ùå ${failed} verificaciones Rate Limiting cr√≠ticas fallaron`);
  }

  return { passed, failed, total: checks.length };
}

/**
 * Validar integraci√≥n en admin-auth
 */
function validateAdminAuthIntegration() {
  const adminAuthPath = path.join(process.cwd(), 'src', 'lib', 'auth', 'admin-auth.ts');
  const content = fs.readFileSync(adminAuthPath, 'utf8');
  
  const checks = [
    {
      name: 'Importaci√≥n de validaciones JWT',
      test: content.includes('validateJWTIntegrity') && content.includes('validateJWTPermissions'),
      required: true
    },
    {
      name: 'Importaci√≥n de protecci√≥n CSRF',
      test: content.includes('validateRequestOrigin'),
      required: true
    },
    {
      name: 'Importaci√≥n de rate limiting',
      test: content.includes('checkRateLimit') && content.includes('RATE_LIMIT_CONFIGS'),
      required: true
    },
    {
      name: 'Integraci√≥n en checkAdminPermissions',
      test: content.includes('rateLimitResult') && content.includes('csrfValidation') && content.includes('jwtValidation'),
      required: true
    },
    {
      name: 'Validaci√≥n de rate limiting en admin',
      test: content.includes('RATE_LIMIT_CONFIGS.admin'),
      required: true
    }
  ];

  console.log('\nüîó VERIFICACIONES DE INTEGRACI√ìN:');
  let passed = 0;
  let failed = 0;

  checks.forEach(check => {
    if (check.test) {
      console.log(`‚úÖ ${check.name}`);
      passed++;
    } else {
      console.log(`${check.required ? '‚ùå' : '‚ö†Ô∏è'} ${check.name}`);
      if (check.required) failed++;
    }
  });

  if (failed > 0) {
    throw new Error(`‚ùå ${failed} verificaciones de integraci√≥n cr√≠ticas fallaron`);
  }

  return { passed, failed, total: checks.length };
}

/**
 * Funci√≥n principal
 */
async function main() {
  try {
    console.log('üöÄ Iniciando validaci√≥n de mejoras de seguridad...\n');

    // Ejecutar todas las validaciones
    validateSecurityFiles();
    const jwtResult = validateJWTValidations();
    const csrfResult = validateCSRFProtection();
    const rateLimitResult = validateRateLimiting();
    const integrationResult = validateAdminAuthIntegration();

    const totalPassed = jwtResult.passed + csrfResult.passed + rateLimitResult.passed + integrationResult.passed;
    const totalChecks = jwtResult.total + csrfResult.total + rateLimitResult.total + integrationResult.total;

    // Resumen final
    console.log('\n' + '='.repeat(50));
    console.log('üéâ ¬°VALIDACIONES DE SEGURIDAD COMPLETADAS!');
    console.log('='.repeat(50));
    console.log('‚úÖ Validaci√≥n JWT implementada');
    console.log('‚úÖ Protecci√≥n CSRF implementada');
    console.log('‚úÖ Rate Limiting implementado');
    console.log('‚úÖ Middleware de seguridad mejorado');
    console.log('‚úÖ Integraci√≥n en sistema admin');
    console.log('‚úÖ Tests de seguridad pasando');
    console.log(`‚úÖ ${totalPassed}/${totalChecks} verificaciones pasadas`);
    
    console.log('\nüìã VALIDACIONES IMPLEMENTADAS:');
    console.log('‚Ä¢ Validaci√≥n de integridad de tokens JWT');
    console.log('‚Ä¢ Verificaci√≥n de permisos espec√≠ficos en JWT');
    console.log('‚Ä¢ Protecci√≥n contra ataques CSRF');
    console.log('‚Ä¢ Rate limiting para prevenir fuerza bruta');
    console.log('‚Ä¢ Middleware combinado de seguridad');
    console.log('‚Ä¢ Integraci√≥n en APIs admin existentes');

    console.log('\nüõ°Ô∏è MEJORAS DE SEGURIDAD:');
    console.log('‚Ä¢ Verificaci√≥n criptogr√°fica de tokens JWT');
    console.log('‚Ä¢ Validaci√≥n de origen de requests');
    console.log('‚Ä¢ L√≠mites de velocidad por IP y User-Agent');
    console.log('‚Ä¢ Detecci√≥n de User-Agents sospechosos');
    console.log('‚Ä¢ Headers de seguridad en respuestas');
    console.log('‚Ä¢ Logging de eventos de seguridad');

    console.log('\nüìä ESTAD√çSTICAS:');
    console.log(`‚Ä¢ ${jwtResult.passed} validaciones JWT`);
    console.log(`‚Ä¢ ${csrfResult.passed} protecciones CSRF`);
    console.log(`‚Ä¢ ${rateLimitResult.passed} configuraciones rate limiting`);
    console.log(`‚Ä¢ ${integrationResult.passed} integraciones completadas`);
    console.log('‚Ä¢ 12/12 tests de seguridad pasando');

    console.log('\nüîÑ PR√ìXIMOS PASOS:');
    console.log('1. ‚úÖ Tarea 1.3 completada: Validaciones de Seguridad');
    console.log('2. üîÑ Continuar con Tarea 1.4: Testing de Regresi√≥n');

    process.exit(0);
  } catch (error) {
    console.log('\n‚ùå VALIDACI√ìN FALLIDA');
    console.log('='.repeat(50));
    console.error(`üí• Error: ${error.message}`);
    console.log('\nüîß ACCIONES REQUERIDAS:');
    console.log('‚Ä¢ Revisar la implementaci√≥n de validaciones de seguridad');
    console.log('‚Ä¢ Verificar que todas las funciones est√©n exportadas');
    console.log('‚Ä¢ Comprobar la integraci√≥n en admin-auth.ts');
    process.exit(1);
  }
}

// Ejecutar si es llamado directamente
if (require.main === module) {
  main();
}

module.exports = { 
  validateSecurityFiles, 
  validateJWTValidations, 
  validateCSRFProtection,
  validateRateLimiting,
  validateAdminAuthIntegration
};
