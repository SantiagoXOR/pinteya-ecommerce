{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\hooks\\useCartWithClerk.ts"],"sourcesContent":["// ===================================\r\n// PINTEYA E-COMMERCE - CART HOOK WITH CLERK INTEGRATION\r\n// ===================================\r\n\r\nimport { useEffect, useCallback } from 'react';\r\nimport { useUser } from '@clerk/nextjs';\r\nimport { useAppDispatch, useAppSelector } from '@/redux/store';\r\nimport { \r\n  selectCartItems, \r\n  hydrateCart, \r\n  replaceCart,\r\n  removeAllItemsFromCart \r\n} from '@/redux/features/cart-slice';\r\nimport { \r\n  loadCartFromStorage, \r\n  clearCartFromStorage,\r\n  migrateTemporaryCart,\r\n  loadUserCart,\r\n  saveUserCart \r\n} from '@/redux/middleware/cartPersistence';\r\n\r\n// Hook personalizado para manejar el carrito con integración Clerk\r\nexport const useCartWithClerk = () => {\r\n  const { user, isLoaded } = useUser();\r\n  const dispatch = useAppDispatch();\r\n  const cartItems = useAppSelector(selectCartItems);\r\n\r\n  // Función para migrar carrito temporal a usuario autenticado\r\n  const migrateCart = useCallback(async (userId: string) => {\r\n    try {\r\n      // Obtener items del localStorage\r\n      const temporaryItems = loadCartFromStorage();\r\n      \r\n      if (temporaryItems.length > 0) {\r\n        console.log(`Migrating ${temporaryItems.length} items for user ${userId}`);\r\n        \r\n        // Migrar items al backend (implementación futura)\r\n        const migrationSuccess = await migrateTemporaryCart(temporaryItems, userId);\r\n        \r\n        if (migrationSuccess) {\r\n          // Limpiar localStorage después de migración exitosa\r\n          clearCartFromStorage();\r\n          console.log('Cart migration completed successfully');\r\n        }\r\n      }\r\n      \r\n      // Cargar carrito del usuario desde el backend (implementación futura)\r\n      const userCartItems = await loadUserCart(userId);\r\n      \r\n      // Si hay items del usuario, reemplazar el carrito actual\r\n      if (userCartItems.length > 0) {\r\n        dispatch(replaceCart(userCartItems));\r\n      }\r\n      \r\n    } catch (error) {\r\n      console.error('Error during cart migration:', error);\r\n    }\r\n  }, [dispatch]);\r\n\r\n  // Función para guardar carrito del usuario autenticado\r\n  const saveCart = useCallback(async (userId: string) => {\r\n    try {\r\n      if (cartItems.length > 0) {\r\n        await saveUserCart(userId, cartItems);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error saving user cart:', error);\r\n    }\r\n  }, [cartItems]);\r\n\r\n  // Efecto para manejar cambios en el estado de autenticación\r\n  useEffect(() => {\r\n    if (!isLoaded) return;\r\n\r\n    if (user) {\r\n      // Usuario autenticado - migrar carrito temporal si existe\r\n      migrateCart(user.id);\r\n    } else {\r\n      // Usuario no autenticado - cargar desde localStorage\r\n      const persistedItems = loadCartFromStorage();\r\n      if (persistedItems.length > 0) {\r\n        dispatch(hydrateCart(persistedItems));\r\n      }\r\n    }\r\n  }, [user, isLoaded, dispatch, migrateCart]);\r\n\r\n  // Efecto para guardar carrito de usuario autenticado cuando cambie\r\n  useEffect(() => {\r\n    if (!isLoaded || !user) return;\r\n\r\n    // Debounce para evitar guardados excesivos\r\n    const timeoutId = setTimeout(() => {\r\n      saveCart(user.id);\r\n    }, 1000);\r\n\r\n    return () => clearTimeout(timeoutId);\r\n  }, [cartItems, user, isLoaded, saveCart]);\r\n\r\n  // Función para limpiar carrito al cerrar sesión\r\n  const handleSignOut = useCallback(() => {\r\n    dispatch(removeAllItemsFromCart());\r\n    clearCartFromStorage();\r\n  }, [dispatch]);\r\n\r\n  return {\r\n    isAuthenticated: !!user,\r\n    userId: user?.id,\r\n    cartItems,\r\n    migrateCart,\r\n    saveCart,\r\n    handleSignOut,\r\n  };\r\n};\r\n\r\n// Hook simplificado para componentes que solo necesitan el estado del carrito\r\nexport const useCart = () => {\r\n  const cartItems = useAppSelector(selectCartItems);\r\n  const dispatch = useAppDispatch();\r\n\r\n  return {\r\n    cartItems,\r\n    dispatch,\r\n  };\r\n};\r\n"],"names":["useCart","useCartWithClerk","user","isLoaded","useUser","dispatch","useAppDispatch","cartItems","useAppSelector","selectCartItems","migrateCart","useCallback","userId","temporaryItems","loadCartFromStorage","length","console","log","migrationSuccess","migrateTemporaryCart","clearCartFromStorage","userCartItems","loadUserCart","replaceCart","error","saveCart","saveUserCart","useEffect","id","persistedItems","hydrateCart","timeoutId","setTimeout","clearTimeout","handleSignOut","removeAllItemsFromCart","isAuthenticated"],"mappings":"AAAA,sCAAsC;AACtC,wDAAwD;AACxD,sCAAsC;;;;;;;;;;;;IAiHzBA,OAAO;eAAPA;;IA7FAC,gBAAgB;eAAhBA;;;uBAlB0B;wBACf;uBACuB;2BAMxC;iCAOA;AAGA,MAAMA,mBAAmB;IAC9B,MAAM,EAAEC,IAAI,EAAEC,QAAQ,EAAE,GAAGC,IAAAA,eAAO;IAClC,MAAMC,WAAWC,IAAAA,qBAAc;IAC/B,MAAMC,YAAYC,IAAAA,qBAAc,EAACC,0BAAe;IAEhD,6DAA6D;IAC7D,MAAMC,cAAcC,IAAAA,kBAAW,EAAC,OAAOC;QACrC,IAAI;YACF,iCAAiC;YACjC,MAAMC,iBAAiBC,IAAAA,oCAAmB;YAE1C,IAAID,eAAeE,MAAM,GAAG,GAAG;gBAC7BC,QAAQC,GAAG,CAAC,CAAC,UAAU,EAAEJ,eAAeE,MAAM,CAAC,gBAAgB,EAAEH,QAAQ;gBAEzE,kDAAkD;gBAClD,MAAMM,mBAAmB,MAAMC,IAAAA,qCAAoB,EAACN,gBAAgBD;gBAEpE,IAAIM,kBAAkB;oBACpB,oDAAoD;oBACpDE,IAAAA,qCAAoB;oBACpBJ,QAAQC,GAAG,CAAC;gBACd;YACF;YAEA,sEAAsE;YACtE,MAAMI,gBAAgB,MAAMC,IAAAA,6BAAY,EAACV;YAEzC,yDAAyD;YACzD,IAAIS,cAAcN,MAAM,GAAG,GAAG;gBAC5BV,SAASkB,IAAAA,sBAAW,EAACF;YACvB;QAEF,EAAE,OAAOG,OAAO;YACdR,QAAQQ,KAAK,CAAC,gCAAgCA;QAChD;IACF,GAAG;QAACnB;KAAS;IAEb,uDAAuD;IACvD,MAAMoB,WAAWd,IAAAA,kBAAW,EAAC,OAAOC;QAClC,IAAI;YACF,IAAIL,UAAUQ,MAAM,GAAG,GAAG;gBACxB,MAAMW,IAAAA,6BAAY,EAACd,QAAQL;YAC7B;QACF,EAAE,OAAOiB,OAAO;YACdR,QAAQQ,KAAK,CAAC,2BAA2BA;QAC3C;IACF,GAAG;QAACjB;KAAU;IAEd,4DAA4D;IAC5DoB,IAAAA,gBAAS,EAAC;QACR,IAAI,CAACxB,UAAU;QAEf,IAAID,MAAM;YACR,0DAA0D;YAC1DQ,YAAYR,KAAK0B,EAAE;QACrB,OAAO;YACL,qDAAqD;YACrD,MAAMC,iBAAiBf,IAAAA,oCAAmB;YAC1C,IAAIe,eAAed,MAAM,GAAG,GAAG;gBAC7BV,SAASyB,IAAAA,sBAAW,EAACD;YACvB;QACF;IACF,GAAG;QAAC3B;QAAMC;QAAUE;QAAUK;KAAY;IAE1C,mEAAmE;IACnEiB,IAAAA,gBAAS,EAAC;QACR,IAAI,CAACxB,YAAY,CAACD,MAAM;QAExB,2CAA2C;QAC3C,MAAM6B,YAAYC,WAAW;YAC3BP,SAASvB,KAAK0B,EAAE;QAClB,GAAG;QAEH,OAAO,IAAMK,aAAaF;IAC5B,GAAG;QAACxB;QAAWL;QAAMC;QAAUsB;KAAS;IAExC,gDAAgD;IAChD,MAAMS,gBAAgBvB,IAAAA,kBAAW,EAAC;QAChCN,SAAS8B,IAAAA,iCAAsB;QAC/Bf,IAAAA,qCAAoB;IACtB,GAAG;QAACf;KAAS;IAEb,OAAO;QACL+B,iBAAiB,CAAC,CAAClC;QACnBU,QAAQV,MAAM0B;QACdrB;QACAG;QACAe;QACAS;IACF;AACF;AAGO,MAAMlC,UAAU;IACrB,MAAMO,YAAYC,IAAAA,qBAAc,EAACC,0BAAe;IAChD,MAAMJ,WAAWC,IAAAA,qBAAc;IAE/B,OAAO;QACLC;QACAF;IACF;AACF"}