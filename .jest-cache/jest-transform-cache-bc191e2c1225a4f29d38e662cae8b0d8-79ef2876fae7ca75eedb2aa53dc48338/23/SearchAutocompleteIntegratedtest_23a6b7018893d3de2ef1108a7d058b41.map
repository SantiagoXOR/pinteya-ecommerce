{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\__tests__\\components\\ui\\SearchAutocompleteIntegrated.test.tsx"],"sourcesContent":["// ===================================\r\n// TESTS: SearchAutocompleteIntegrated - Integración completa\r\n// ===================================\r\n\r\nimport React from 'react';\r\nimport { render, screen, waitFor } from '@testing-library/react';\r\nimport userEvent from '@testing-library/user-event';\r\nimport { useRouter, useSearchParams, usePathname } from 'next/navigation';\r\nimport { searchProducts } from '@/lib/api/products';\r\nimport { SearchAutocompleteIntegrated } from '@/components/ui/SearchAutocompleteIntegrated';\r\n\r\n// Mocks - Aplicando Patrón 1 exitoso: Imports faltantes\r\njest.mock('next/navigation', () => ({\r\n  useRouter: jest.fn(),\r\n  useSearchParams: jest.fn(),\r\n  usePathname: jest.fn(),\r\n}));\r\n\r\n// Patrón 3 exitoso: Comportamientos testing - mockear fetch en lugar de searchProducts\r\nglobal.fetch = jest.fn();\r\n\r\njest.mock('@/lib/api/products', () => ({\r\n  searchProducts: jest.fn(),\r\n}));\r\n\r\nconst mockPush = jest.fn();\r\nconst mockPrefetch = jest.fn(); // Patrón 1 exitoso: Import faltante\r\nconst mockSearchProducts = searchProducts as jest.MockedFunction<typeof searchProducts>;\r\nconst mockFetch = global.fetch as jest.MockedFunction<typeof fetch>; // Patrón 3 exitoso: Mock correcto\r\n\r\n// Mocks adicionales para Next.js navigation\r\nconst mockSearchParams = jest.fn();\r\nconst mockPathname = jest.fn();\r\n\r\nbeforeEach(() => {\r\n  jest.clearAllMocks();\r\n\r\n  // Configurar mocks de Next.js navigation - Patrón exitoso aplicado\r\n  (useRouter as jest.Mock).mockReturnValue({\r\n    push: mockPush,\r\n    prefetch: mockPrefetch, // Patrón 1 exitoso: Import faltante agregado\r\n  });\r\n\r\n  (useSearchParams as jest.Mock).mockReturnValue({\r\n    get: jest.fn(() => null),\r\n    has: jest.fn(() => false),\r\n    toString: jest.fn(() => ''),\r\n  });\r\n\r\n  (usePathname as jest.Mock).mockReturnValue('/');\r\n\r\n  // Configurar mock de fetch - Patrón 3 exitoso: Mock correcto\r\n  mockFetch.mockResolvedValue({\r\n    ok: true,\r\n    json: async () => ({\r\n      products: [],\r\n      pagination: { total: 0, page: 1, limit: 6, totalPages: 0 },\r\n    }),\r\n  } as Response);\r\n\r\n  // Configurar mock de searchProducts con respuesta por defecto\r\n  mockSearchProducts.mockResolvedValue({\r\n    products: [],\r\n    pagination: { total: 0, page: 1, limit: 6, totalPages: 0 },\r\n  });\r\n  \r\n  // Mock localStorage\r\n  Object.defineProperty(window, 'localStorage', {\r\n    value: {\r\n      getItem: jest.fn(() => null),\r\n      setItem: jest.fn(),\r\n      removeItem: jest.fn(),\r\n      clear: jest.fn(),\r\n    },\r\n    writable: true,\r\n  });\r\n});\r\n\r\ndescribe('SearchAutocompleteIntegrated', () => {\r\n  it('should render with default props', () => {\r\n    render(<SearchAutocompleteIntegrated />);\r\n    \r\n    // Patrón 2 exitoso: Expectativas específicas - usar searchbox en lugar de combobox\r\n    expect(screen.getByRole('searchbox')).toBeInTheDocument();\r\n    expect(screen.getByPlaceholderText('Látex interior blanco 20lts, rodillos, pinceles...')).toBeInTheDocument();\r\n  });\r\n\r\n  it('should integrate with useSearch hook and show suggestions', async () => {\r\n    const mockResponse = {\r\n      products: [\r\n        {\r\n          id: '1',\r\n          name: 'Pintura Látex Blanca',\r\n          category: { name: 'Pinturas' },\r\n          images: { previews: ['/test.jpg'] },\r\n          stock: 10\r\n        },\r\n        {\r\n          id: '2',\r\n          name: 'Pintura Esmalte Azul',\r\n          category: { name: 'Pinturas' },\r\n          images: { previews: ['/test2.jpg'] },\r\n          stock: 5\r\n        },\r\n      ],\r\n      pagination: { total: 2, page: 1, limit: 6, totalPages: 1 },\r\n    };\r\n\r\n    // Patrón 3 exitoso: Mock correcto - usar fetch en lugar de searchProducts\r\n    mockFetch.mockResolvedValue({\r\n      ok: true,\r\n      json: async () => mockResponse,\r\n    } as Response);\r\n\r\n    render(<SearchAutocompleteIntegrated debounceMs={100} />);\r\n    \r\n    const input = screen.getByRole('searchbox');\r\n    \r\n    await userEvent.type(input, 'pintura');\r\n\r\n    // Esperar más tiempo para el debounce + query execution\r\n    await new Promise(resolve => setTimeout(resolve, 200));\r\n\r\n    // Debug: verificar si fetch fue llamado\r\n    console.log('🔍 Test Debug: fetch calls:', mockFetch.mock.calls.length);\r\n    console.log('🔍 Test Debug: fetch calls details:', mockFetch.mock.calls);\r\n\r\n    // Esperar a que se llame fetch - Patrón 3 exitoso: Expectativa correcta\r\n    await waitFor(() => {\r\n      expect(mockFetch).toHaveBeenCalled();\r\n    }, { timeout: 3000 });\r\n\r\n    // Luego esperar a que aparezcan las sugerencias\r\n    await waitFor(() => {\r\n      expect(screen.getByText('Pintura Látex Blanca')).toBeInTheDocument();\r\n      expect(screen.getByText('Pintura Esmalte Azul')).toBeInTheDocument();\r\n    }, { timeout: 2000 });\r\n\r\n    // Verificar que se llamó a fetch con los parámetros correctos\r\n    expect(mockFetch).toHaveBeenCalledWith(\r\n      expect.stringContaining('/api/search?q=pintura&limit=6'),\r\n      expect.objectContaining({\r\n        method: 'GET',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      })\r\n    );\r\n  });\r\n\r\n  it('should execute search on Enter key', async () => {\r\n    const onSearchExecuted = jest.fn();\r\n    const mockResponse = {\r\n      success: true,\r\n      data: [{ id: '1', name: 'Test Product', category: { name: 'Test' } }],\r\n      pagination: { total: 1, page: 1, limit: 12, totalPages: 1 },\r\n    };\r\n\r\n    mockSearchProducts.mockResolvedValue(mockResponse);\r\n\r\n    render(\r\n      <SearchAutocompleteIntegrated \r\n        onSearchExecuted={onSearchExecuted}\r\n        debounceMs={100}\r\n      />\r\n    );\r\n    \r\n    const input = screen.getByRole('searchbox');\r\n    \r\n    await userEvent.type(input, 'test query');\r\n    await userEvent.keyboard('{Enter}');\r\n    \r\n    await waitFor(() => {\r\n      expect(mockPush).toHaveBeenCalledWith('/search?q=test%20query');\r\n    });\r\n  });\r\n\r\n  it('should handle suggestion selection', async () => {\r\n    const onSuggestionSelected = jest.fn();\r\n    const mockResponse = {\r\n      success: true,\r\n      data: [\r\n        { \r\n          id: '1', \r\n          name: 'Test Product', \r\n          category: { name: 'Test Category' },\r\n          images: { previews: ['/test.jpg'] },\r\n          stock: 10\r\n        },\r\n      ],\r\n      pagination: { total: 1, page: 1, limit: 6, totalPages: 1 },\r\n    };\r\n\r\n    mockSearchProducts.mockResolvedValue(mockResponse);\r\n\r\n    render(\r\n      <SearchAutocompleteIntegrated \r\n        onSuggestionSelected={onSuggestionSelected}\r\n        debounceMs={100}\r\n      />\r\n    );\r\n    \r\n    const input = screen.getByRole('searchbox');\r\n    \r\n    await userEvent.type(input, 'test');\r\n    \r\n    await waitFor(() => {\r\n      expect(screen.getByText('Test Product')).toBeInTheDocument();\r\n    });\r\n\r\n    await userEvent.click(screen.getByText('Test Product'));\r\n    \r\n    expect(onSuggestionSelected).toHaveBeenCalledWith(\r\n      expect.objectContaining({\r\n        title: 'Test Product',\r\n        type: 'product'\r\n      })\r\n    );\r\n  });\r\n\r\n  it('should clear search when clear button is clicked', async () => {\r\n    render(<SearchAutocompleteIntegrated />);\r\n    \r\n    const input = screen.getByRole('searchbox');\r\n    \r\n    await userEvent.type(input, 'test query');\r\n    \r\n    // Buscar el botón de limpiar\r\n    const clearButton = screen.getByLabelText('Clear search');\r\n    await userEvent.click(clearButton);\r\n    \r\n    expect(input).toHaveValue('');\r\n  });\r\n\r\n  it('should show loading state during search', async () => {\r\n    // Mock para simular búsqueda lenta\r\n    mockSearchProducts.mockImplementation(() => \r\n      new Promise(resolve => setTimeout(() => resolve({\r\n        success: true,\r\n        data: [],\r\n        pagination: { total: 0, page: 1, limit: 6, totalPages: 0 },\r\n      }), 1000))\r\n    );\r\n\r\n    render(<SearchAutocompleteIntegrated debounceMs={50} />);\r\n    \r\n    const input = screen.getByRole('searchbox');\r\n    \r\n    await userEvent.type(input, 'test');\r\n    \r\n    // Verificar que aparece el spinner de carga\r\n    await waitFor(() => {\r\n      const spinner = document.querySelector('.animate-spin');\r\n      expect(spinner).toBeInTheDocument();\r\n    });\r\n  });\r\n\r\n  it('should handle API errors gracefully', async () => {\r\n    mockSearchProducts.mockRejectedValue(new Error('API Error'));\r\n\r\n    render(<SearchAutocompleteIntegrated debounceMs={50} />);\r\n    \r\n    const input = screen.getByRole('searchbox');\r\n    \r\n    await userEvent.type(input, 'test');\r\n    \r\n    await waitFor(() => {\r\n      expect(mockSearchProducts).toHaveBeenCalled();\r\n    });\r\n\r\n    // El componente no debería crashear y debería mostrar estado sin resultados\r\n    expect(input).toBeInTheDocument();\r\n  });\r\n});\r\n"],"names":["jest","mock","useRouter","fn","useSearchParams","usePathname","searchProducts","global","fetch","mockPush","mockPrefetch","mockSearchProducts","mockFetch","mockSearchParams","mockPathname","beforeEach","clearAllMocks","mockReturnValue","push","prefetch","get","has","toString","mockResolvedValue","ok","json","products","pagination","total","page","limit","totalPages","Object","defineProperty","window","value","getItem","setItem","removeItem","clear","writable","describe","it","render","SearchAutocompleteIntegrated","expect","screen","getByRole","toBeInTheDocument","getByPlaceholderText","mockResponse","id","name","category","images","previews","stock","debounceMs","input","userEvent","type","Promise","resolve","setTimeout","console","log","calls","length","waitFor","toHaveBeenCalled","timeout","getByText","toHaveBeenCalledWith","stringContaining","objectContaining","method","headers","onSearchExecuted","success","data","keyboard","onSuggestionSelected","click","title","clearButton","getByLabelText","toHaveValue","mockImplementation","spinner","document","querySelector","mockRejectedValue","Error"],"mappings":"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"}