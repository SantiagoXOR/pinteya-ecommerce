82f9b6c11cba9f746c55e2faae40e847
// ===================================
// PINTEYA E-COMMERCE - WEBHOOK ROBUSTO DE CLERK
// VersiÃ³n mejorada con validaciÃ³n de firma, retry logic y auditorÃ­a
// ===================================
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "POST", {
    enumerable: true,
    get: function() {
        return POST;
    }
});
const _server = require("next/server");
const _svix = require("svix");
const _usersyncservice = require("../../../../lib/auth/user-sync-service");
const _securityaudit = require("../../../../lib/auth/security-audit");
// ===================================
// FUNCIONES DE UTILIDAD
// ===================================
/**
 * Valida los headers del webhook de Clerk
 */ function validateWebhookHeaders(request) {
    const svix_id = request.headers.get('svix-id');
    const svix_timestamp = request.headers.get('svix-timestamp');
    const svix_signature = request.headers.get('svix-signature');
    if (!svix_id || !svix_timestamp || !svix_signature) {
        return {
            valid: false,
            error: 'Headers de webhook faltantes (svix-id, svix-timestamp, svix-signature)'
        };
    }
    return {
        valid: true,
        headers: {
            svix_id,
            svix_timestamp,
            svix_signature
        }
    };
}
/**
 * Verifica la firma del webhook usando svix
 */ async function verifyWebhookSignature(payload, headers, secret) {
    try {
        const wh = new _svix.Webhook(secret);
        const evt = wh.verify(payload, {
            'svix-id': headers.svix_id,
            'svix-timestamp': headers.svix_timestamp,
            'svix-signature': headers.svix_signature
        });
        return {
            valid: true,
            event: evt
        };
    } catch (error) {
        console.error('[WEBHOOK] Error verificando firma:', error);
        return {
            valid: false,
            error: `Error verificando firma: ${error.message}`
        };
    }
}
/**
 * Procesa un evento de webhook especÃ­fico
 */ async function processWebhookEvent(event) {
    const startTime = Date.now();
    const eventType = event.type;
    const userData = event.data;
    console.log(`[WEBHOOK] Procesando evento: ${eventType} para usuario ${userData.id}`);
    try {
        switch(eventType){
            case 'user.created':
                const createResult = await (0, _usersyncservice.syncUserToSupabase)(userData, {
                    retryAttempts: 2,
                    retryDelay: 1000,
                    validateData: true,
                    createMissingRole: true,
                    logEvents: true
                });
                if (createResult.success) {
                    await (0, _securityaudit.logAdminAction)(userData.id, 'USER_CREATED_VIA_WEBHOOK', 'user_profile', {
                        userId: userData.id,
                        userRole: 'customer',
                        permissions: {},
                        metadata: {
                            source: 'clerk_webhook'
                        }
                    }, {
                        action: createResult.action,
                        email: userData.email_addresses[0]?.email_address,
                        webhook_event: eventType
                    });
                    return {
                        success: true,
                        eventType,
                        userId: userData.id,
                        action: createResult.action,
                        processingTime: Date.now() - startTime
                    };
                } else {
                    throw new Error(createResult.error || 'Error creando usuario');
                }
            case 'user.updated':
                const updateResult = await (0, _usersyncservice.syncUserToSupabase)(userData, {
                    retryAttempts: 2,
                    retryDelay: 1000,
                    validateData: true,
                    createMissingRole: false,
                    logEvents: true
                });
                if (updateResult.success) {
                    await (0, _securityaudit.logAdminAction)(userData.id, 'USER_UPDATED_VIA_WEBHOOK', 'user_profile', {
                        userId: userData.id,
                        userRole: 'customer',
                        permissions: {},
                        metadata: {
                            source: 'clerk_webhook'
                        }
                    }, {
                        action: updateResult.action,
                        email: userData.email_addresses[0]?.email_address,
                        webhook_event: eventType
                    });
                    return {
                        success: true,
                        eventType,
                        userId: userData.id,
                        action: updateResult.action,
                        processingTime: Date.now() - startTime
                    };
                } else {
                    throw new Error(updateResult.error || 'Error actualizando usuario');
                }
            case 'user.deleted':
                const deleteResult = await (0, _usersyncservice.deleteUserFromSupabase)(userData.id, {
                    retryAttempts: 2,
                    retryDelay: 1000,
                    logEvents: true
                });
                if (deleteResult.success) {
                    await (0, _securityaudit.logAdminAction)(userData.id, 'USER_DELETED_VIA_WEBHOOK', 'user_profile', {
                        userId: userData.id,
                        userRole: 'customer',
                        permissions: {},
                        metadata: {
                            source: 'clerk_webhook'
                        }
                    }, {
                        action: deleteResult.action,
                        webhook_event: eventType
                    });
                    return {
                        success: true,
                        eventType,
                        userId: userData.id,
                        action: deleteResult.action,
                        processingTime: Date.now() - startTime
                    };
                } else {
                    throw new Error(deleteResult.error || 'Error eliminando usuario');
                }
            default:
                console.log(`[WEBHOOK] Evento no manejado: ${eventType}`);
                return {
                    success: true,
                    eventType,
                    userId: userData.id,
                    action: 'ignored',
                    processingTime: Date.now() - startTime
                };
        }
    } catch (error) {
        console.error(`[WEBHOOK] Error procesando evento ${eventType}:`, error);
        // Log evento de error
        await (0, _securityaudit.logSecurityEvent)({
            user_id: userData.id,
            event_type: 'SECURITY_VIOLATION',
            event_category: 'data_access',
            severity: 'medium',
            description: `Error procesando webhook ${eventType}`,
            metadata: {
                eventType,
                error: error.message,
                webhook_event: true
            }
        });
        return {
            success: false,
            eventType,
            userId: userData.id,
            error: error.message,
            processingTime: Date.now() - startTime
        };
    }
}
async function POST(request) {
    console.log('[WEBHOOK] ðŸš« TEMPORALMENTE DESHABILITADO PARA EVITAR RECURSIÃ“N');
    // RESPUESTA TEMPORAL PARA EVITAR ERRORES
    return _server.NextResponse.json({
        success: false,
        message: 'Webhook temporalmente deshabilitado para evitar recursiÃ³n',
        timestamp: new Date().toISOString()
    }, {
        status: 503
    });
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbWFydGlcXERlc2t0b3BcXERFU0FSUk9MTE9TV1xcQk9JTEVSUExBVFRFIEUtQ09NTUVSQ0VcXHNyY1xcYXBwXFxhcGlcXGF1dGhcXHdlYmhvb2tcXHJvdXRlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBQSU5URVlBIEUtQ09NTUVSQ0UgLSBXRUJIT09LIFJPQlVTVE8gREUgQ0xFUktcbi8vIFZlcnNpw7NuIG1lam9yYWRhIGNvbiB2YWxpZGFjacOzbiBkZSBmaXJtYSwgcmV0cnkgbG9naWMgeSBhdWRpdG9yw61hXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5pbXBvcnQgeyBOZXh0UmVxdWVzdCwgTmV4dFJlc3BvbnNlIH0gZnJvbSAnbmV4dC9zZXJ2ZXInO1xuaW1wb3J0IHsgV2ViaG9vayB9IGZyb20gJ3N2aXgnO1xuaW1wb3J0IHtcbiAgc3luY1VzZXJUb1N1cGFiYXNlLFxuICBkZWxldGVVc2VyRnJvbVN1cGFiYXNlLFxuICB0eXBlIENsZXJrVXNlckRhdGFcbn0gZnJvbSAnQC9saWIvYXV0aC91c2VyLXN5bmMtc2VydmljZSc7XG5pbXBvcnQge1xuICBsb2dTZWN1cml0eUV2ZW50LFxuICBsb2dBZG1pbkFjdGlvblxufSBmcm9tICdAL2xpYi9hdXRoL3NlY3VyaXR5LWF1ZGl0JztcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFRJUE9TIFkgSU5URVJGQUNFU1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuaW50ZXJmYWNlIFdlYmhvb2tFdmVudERhdGEge1xuICBkYXRhOiBDbGVya1VzZXJEYXRhO1xuICBvYmplY3Q6IHN0cmluZztcbiAgdHlwZTogc3RyaW5nO1xuICB0aW1lc3RhbXA/OiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBXZWJob29rUHJvY2Vzc2luZ1Jlc3VsdCB7XG4gIHN1Y2Nlc3M6IGJvb2xlYW47XG4gIGV2ZW50VHlwZTogc3RyaW5nO1xuICB1c2VySWQ/OiBzdHJpbmc7XG4gIGFjdGlvbj86IHN0cmluZztcbiAgZXJyb3I/OiBzdHJpbmc7XG4gIHByb2Nlc3NpbmdUaW1lPzogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgV2ViaG9va01ldHJpY3Mge1xuICB0b3RhbEV2ZW50czogbnVtYmVyO1xuICBzdWNjZXNzZnVsRXZlbnRzOiBudW1iZXI7XG4gIGZhaWxlZEV2ZW50czogbnVtYmVyO1xuICBldmVudFR5cGVzOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+O1xuICBhdmVyYWdlUHJvY2Vzc2luZ1RpbWU6IG51bWJlcjtcbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIEZVTkNJT05FUyBERSBVVElMSURBRFxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuLyoqXG4gKiBWYWxpZGEgbG9zIGhlYWRlcnMgZGVsIHdlYmhvb2sgZGUgQ2xlcmtcbiAqL1xuZnVuY3Rpb24gdmFsaWRhdGVXZWJob29rSGVhZGVycyhyZXF1ZXN0OiBOZXh0UmVxdWVzdCk6IHtcbiAgdmFsaWQ6IGJvb2xlYW47XG4gIGhlYWRlcnM/OiB7XG4gICAgc3ZpeF9pZDogc3RyaW5nO1xuICAgIHN2aXhfdGltZXN0YW1wOiBzdHJpbmc7XG4gICAgc3ZpeF9zaWduYXR1cmU6IHN0cmluZztcbiAgfTtcbiAgZXJyb3I/OiBzdHJpbmc7XG59IHtcbiAgY29uc3Qgc3ZpeF9pZCA9IHJlcXVlc3QuaGVhZGVycy5nZXQoJ3N2aXgtaWQnKTtcbiAgY29uc3Qgc3ZpeF90aW1lc3RhbXAgPSByZXF1ZXN0LmhlYWRlcnMuZ2V0KCdzdml4LXRpbWVzdGFtcCcpO1xuICBjb25zdCBzdml4X3NpZ25hdHVyZSA9IHJlcXVlc3QuaGVhZGVycy5nZXQoJ3N2aXgtc2lnbmF0dXJlJyk7XG5cbiAgaWYgKCFzdml4X2lkIHx8ICFzdml4X3RpbWVzdGFtcCB8fCAhc3ZpeF9zaWduYXR1cmUpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdmFsaWQ6IGZhbHNlLFxuICAgICAgZXJyb3I6ICdIZWFkZXJzIGRlIHdlYmhvb2sgZmFsdGFudGVzIChzdml4LWlkLCBzdml4LXRpbWVzdGFtcCwgc3ZpeC1zaWduYXR1cmUpJ1xuICAgIH07XG4gIH1cblxuICByZXR1cm4ge1xuICAgIHZhbGlkOiB0cnVlLFxuICAgIGhlYWRlcnM6IHtcbiAgICAgIHN2aXhfaWQsXG4gICAgICBzdml4X3RpbWVzdGFtcCxcbiAgICAgIHN2aXhfc2lnbmF0dXJlXG4gICAgfVxuICB9O1xufVxuXG4vKipcbiAqIFZlcmlmaWNhIGxhIGZpcm1hIGRlbCB3ZWJob29rIHVzYW5kbyBzdml4XG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHZlcmlmeVdlYmhvb2tTaWduYXR1cmUoXG4gIHBheWxvYWQ6IHN0cmluZyxcbiAgaGVhZGVyczogeyBzdml4X2lkOiBzdHJpbmc7IHN2aXhfdGltZXN0YW1wOiBzdHJpbmc7IHN2aXhfc2lnbmF0dXJlOiBzdHJpbmcgfSxcbiAgc2VjcmV0OiBzdHJpbmdcbik6IFByb21pc2U8eyB2YWxpZDogYm9vbGVhbjsgZXZlbnQ/OiBXZWJob29rRXZlbnREYXRhOyBlcnJvcj86IHN0cmluZyB9PiB7XG4gIHRyeSB7XG4gICAgY29uc3Qgd2ggPSBuZXcgV2ViaG9vayhzZWNyZXQpO1xuXG4gICAgY29uc3QgZXZ0ID0gd2gudmVyaWZ5KHBheWxvYWQsIHtcbiAgICAgICdzdml4LWlkJzogaGVhZGVycy5zdml4X2lkLFxuICAgICAgJ3N2aXgtdGltZXN0YW1wJzogaGVhZGVycy5zdml4X3RpbWVzdGFtcCxcbiAgICAgICdzdml4LXNpZ25hdHVyZSc6IGhlYWRlcnMuc3ZpeF9zaWduYXR1cmUsXG4gICAgfSkgYXMgV2ViaG9va0V2ZW50RGF0YTtcblxuICAgIHJldHVybiB7IHZhbGlkOiB0cnVlLCBldmVudDogZXZ0IH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignW1dFQkhPT0tdIEVycm9yIHZlcmlmaWNhbmRvIGZpcm1hOicsIGVycm9yKTtcbiAgICByZXR1cm4ge1xuICAgICAgdmFsaWQ6IGZhbHNlLFxuICAgICAgZXJyb3I6IGBFcnJvciB2ZXJpZmljYW5kbyBmaXJtYTogJHtlcnJvci5tZXNzYWdlfWBcbiAgICB9O1xuICB9XG59XG5cbi8qKlxuICogUHJvY2VzYSB1biBldmVudG8gZGUgd2ViaG9vayBlc3BlY8OtZmljb1xuICovXG5hc3luYyBmdW5jdGlvbiBwcm9jZXNzV2ViaG9va0V2ZW50KGV2ZW50OiBXZWJob29rRXZlbnREYXRhKTogUHJvbWlzZTxXZWJob29rUHJvY2Vzc2luZ1Jlc3VsdD4ge1xuICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICBjb25zdCBldmVudFR5cGUgPSBldmVudC50eXBlO1xuICBjb25zdCB1c2VyRGF0YSA9IGV2ZW50LmRhdGE7XG5cbiAgY29uc29sZS5sb2coYFtXRUJIT09LXSBQcm9jZXNhbmRvIGV2ZW50bzogJHtldmVudFR5cGV9IHBhcmEgdXN1YXJpbyAke3VzZXJEYXRhLmlkfWApO1xuXG4gIHRyeSB7XG4gICAgc3dpdGNoIChldmVudFR5cGUpIHtcbiAgICAgIGNhc2UgJ3VzZXIuY3JlYXRlZCc6XG4gICAgICAgIGNvbnN0IGNyZWF0ZVJlc3VsdCA9IGF3YWl0IHN5bmNVc2VyVG9TdXBhYmFzZSh1c2VyRGF0YSwge1xuICAgICAgICAgIHJldHJ5QXR0ZW1wdHM6IDIsXG4gICAgICAgICAgcmV0cnlEZWxheTogMTAwMCxcbiAgICAgICAgICB2YWxpZGF0ZURhdGE6IHRydWUsXG4gICAgICAgICAgY3JlYXRlTWlzc2luZ1JvbGU6IHRydWUsXG4gICAgICAgICAgbG9nRXZlbnRzOiB0cnVlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChjcmVhdGVSZXN1bHQuc3VjY2Vzcykge1xuICAgICAgICAgIGF3YWl0IGxvZ0FkbWluQWN0aW9uKFxuICAgICAgICAgICAgdXNlckRhdGEuaWQsXG4gICAgICAgICAgICAnVVNFUl9DUkVBVEVEX1ZJQV9XRUJIT09LJyxcbiAgICAgICAgICAgICd1c2VyX3Byb2ZpbGUnLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICB1c2VySWQ6IHVzZXJEYXRhLmlkLFxuICAgICAgICAgICAgICB1c2VyUm9sZTogJ2N1c3RvbWVyJyxcbiAgICAgICAgICAgICAgcGVybWlzc2lvbnM6IHt9LFxuICAgICAgICAgICAgICBtZXRhZGF0YTogeyBzb3VyY2U6ICdjbGVya193ZWJob29rJyB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBhY3Rpb246IGNyZWF0ZVJlc3VsdC5hY3Rpb24sXG4gICAgICAgICAgICAgIGVtYWlsOiB1c2VyRGF0YS5lbWFpbF9hZGRyZXNzZXNbMF0/LmVtYWlsX2FkZHJlc3MsXG4gICAgICAgICAgICAgIHdlYmhvb2tfZXZlbnQ6IGV2ZW50VHlwZVxuICAgICAgICAgICAgfVxuICAgICAgICAgICk7XG5cbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICAgIGV2ZW50VHlwZSxcbiAgICAgICAgICAgIHVzZXJJZDogdXNlckRhdGEuaWQsXG4gICAgICAgICAgICBhY3Rpb246IGNyZWF0ZVJlc3VsdC5hY3Rpb24sXG4gICAgICAgICAgICBwcm9jZXNzaW5nVGltZTogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZVxuICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGNyZWF0ZVJlc3VsdC5lcnJvciB8fCAnRXJyb3IgY3JlYW5kbyB1c3VhcmlvJyk7XG4gICAgICAgIH1cblxuICAgICAgY2FzZSAndXNlci51cGRhdGVkJzpcbiAgICAgICAgY29uc3QgdXBkYXRlUmVzdWx0ID0gYXdhaXQgc3luY1VzZXJUb1N1cGFiYXNlKHVzZXJEYXRhLCB7XG4gICAgICAgICAgcmV0cnlBdHRlbXB0czogMixcbiAgICAgICAgICByZXRyeURlbGF5OiAxMDAwLFxuICAgICAgICAgIHZhbGlkYXRlRGF0YTogdHJ1ZSxcbiAgICAgICAgICBjcmVhdGVNaXNzaW5nUm9sZTogZmFsc2UsXG4gICAgICAgICAgbG9nRXZlbnRzOiB0cnVlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICh1cGRhdGVSZXN1bHQuc3VjY2Vzcykge1xuICAgICAgICAgIGF3YWl0IGxvZ0FkbWluQWN0aW9uKFxuICAgICAgICAgICAgdXNlckRhdGEuaWQsXG4gICAgICAgICAgICAnVVNFUl9VUERBVEVEX1ZJQV9XRUJIT09LJyxcbiAgICAgICAgICAgICd1c2VyX3Byb2ZpbGUnLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICB1c2VySWQ6IHVzZXJEYXRhLmlkLFxuICAgICAgICAgICAgICB1c2VyUm9sZTogJ2N1c3RvbWVyJyxcbiAgICAgICAgICAgICAgcGVybWlzc2lvbnM6IHt9LFxuICAgICAgICAgICAgICBtZXRhZGF0YTogeyBzb3VyY2U6ICdjbGVya193ZWJob29rJyB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBhY3Rpb246IHVwZGF0ZVJlc3VsdC5hY3Rpb24sXG4gICAgICAgICAgICAgIGVtYWlsOiB1c2VyRGF0YS5lbWFpbF9hZGRyZXNzZXNbMF0/LmVtYWlsX2FkZHJlc3MsXG4gICAgICAgICAgICAgIHdlYmhvb2tfZXZlbnQ6IGV2ZW50VHlwZVxuICAgICAgICAgICAgfVxuICAgICAgICAgICk7XG5cbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICAgIGV2ZW50VHlwZSxcbiAgICAgICAgICAgIHVzZXJJZDogdXNlckRhdGEuaWQsXG4gICAgICAgICAgICBhY3Rpb246IHVwZGF0ZVJlc3VsdC5hY3Rpb24sXG4gICAgICAgICAgICBwcm9jZXNzaW5nVGltZTogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZVxuICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHVwZGF0ZVJlc3VsdC5lcnJvciB8fCAnRXJyb3IgYWN0dWFsaXphbmRvIHVzdWFyaW8nKTtcbiAgICAgICAgfVxuXG4gICAgICBjYXNlICd1c2VyLmRlbGV0ZWQnOlxuICAgICAgICBjb25zdCBkZWxldGVSZXN1bHQgPSBhd2FpdCBkZWxldGVVc2VyRnJvbVN1cGFiYXNlKHVzZXJEYXRhLmlkLCB7XG4gICAgICAgICAgcmV0cnlBdHRlbXB0czogMixcbiAgICAgICAgICByZXRyeURlbGF5OiAxMDAwLFxuICAgICAgICAgIGxvZ0V2ZW50czogdHJ1ZVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoZGVsZXRlUmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgICAgICBhd2FpdCBsb2dBZG1pbkFjdGlvbihcbiAgICAgICAgICAgIHVzZXJEYXRhLmlkLFxuICAgICAgICAgICAgJ1VTRVJfREVMRVRFRF9WSUFfV0VCSE9PSycsXG4gICAgICAgICAgICAndXNlcl9wcm9maWxlJyxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgdXNlcklkOiB1c2VyRGF0YS5pZCxcbiAgICAgICAgICAgICAgdXNlclJvbGU6ICdjdXN0b21lcicsXG4gICAgICAgICAgICAgIHBlcm1pc3Npb25zOiB7fSxcbiAgICAgICAgICAgICAgbWV0YWRhdGE6IHsgc291cmNlOiAnY2xlcmtfd2ViaG9vaycgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgYWN0aW9uOiBkZWxldGVSZXN1bHQuYWN0aW9uLFxuICAgICAgICAgICAgICB3ZWJob29rX2V2ZW50OiBldmVudFR5cGVcbiAgICAgICAgICAgIH1cbiAgICAgICAgICApO1xuXG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICBldmVudFR5cGUsXG4gICAgICAgICAgICB1c2VySWQ6IHVzZXJEYXRhLmlkLFxuICAgICAgICAgICAgYWN0aW9uOiBkZWxldGVSZXN1bHQuYWN0aW9uLFxuICAgICAgICAgICAgcHJvY2Vzc2luZ1RpbWU6IERhdGUubm93KCkgLSBzdGFydFRpbWVcbiAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihkZWxldGVSZXN1bHQuZXJyb3IgfHwgJ0Vycm9yIGVsaW1pbmFuZG8gdXN1YXJpbycpO1xuICAgICAgICB9XG5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGNvbnNvbGUubG9nKGBbV0VCSE9PS10gRXZlbnRvIG5vIG1hbmVqYWRvOiAke2V2ZW50VHlwZX1gKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgIGV2ZW50VHlwZSxcbiAgICAgICAgICB1c2VySWQ6IHVzZXJEYXRhLmlkLFxuICAgICAgICAgIGFjdGlvbjogJ2lnbm9yZWQnLFxuICAgICAgICAgIHByb2Nlc3NpbmdUaW1lOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lXG4gICAgICAgIH07XG4gICAgfVxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoYFtXRUJIT09LXSBFcnJvciBwcm9jZXNhbmRvIGV2ZW50byAke2V2ZW50VHlwZX06YCwgZXJyb3IpO1xuXG4gICAgLy8gTG9nIGV2ZW50byBkZSBlcnJvclxuICAgIGF3YWl0IGxvZ1NlY3VyaXR5RXZlbnQoe1xuICAgICAgdXNlcl9pZDogdXNlckRhdGEuaWQsXG4gICAgICBldmVudF90eXBlOiAnU0VDVVJJVFlfVklPTEFUSU9OJyxcbiAgICAgIGV2ZW50X2NhdGVnb3J5OiAnZGF0YV9hY2Nlc3MnLFxuICAgICAgc2V2ZXJpdHk6ICdtZWRpdW0nLFxuICAgICAgZGVzY3JpcHRpb246IGBFcnJvciBwcm9jZXNhbmRvIHdlYmhvb2sgJHtldmVudFR5cGV9YCxcbiAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgIGV2ZW50VHlwZSxcbiAgICAgICAgZXJyb3I6IGVycm9yLm1lc3NhZ2UsXG4gICAgICAgIHdlYmhvb2tfZXZlbnQ6IHRydWVcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIGV2ZW50VHlwZSxcbiAgICAgIHVzZXJJZDogdXNlckRhdGEuaWQsXG4gICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSxcbiAgICAgIHByb2Nlc3NpbmdUaW1lOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lXG4gICAgfTtcbiAgfVxufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gRU5EUE9JTlQgUFJJTkNJUEFMIERFTCBXRUJIT09LXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLyoqXG4gKiBQT1NUIC9hcGkvYXV0aC93ZWJob29rIC0gV2ViaG9vayByb2J1c3RvIGRlIENsZXJrXG4gKiBNYW5lamEgZXZlbnRvcyBkZSB1c3VhcmlvIGNvbiB2YWxpZGFjacOzbiBkZSBmaXJtYSwgcmV0cnkgbG9naWMgeSBhdWRpdG9yw61hXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBQT1NUKHJlcXVlc3Q6IE5leHRSZXF1ZXN0KSB7XG4gIGNvbnNvbGUubG9nKCdbV0VCSE9PS10g8J+aqyBURU1QT1JBTE1FTlRFIERFU0hBQklMSVRBRE8gUEFSQSBFVklUQVIgUkVDVVJTScOTTicpO1xuXG4gIC8vIFJFU1BVRVNUQSBURU1QT1JBTCBQQVJBIEVWSVRBUiBFUlJPUkVTXG4gIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICB7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIG1lc3NhZ2U6ICdXZWJob29rIHRlbXBvcmFsbWVudGUgZGVzaGFiaWxpdGFkbyBwYXJhIGV2aXRhciByZWN1cnNpw7NuJyxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgfSxcbiAgICB7IHN0YXR1czogNTAzIH1cbiAgKTtcblxufVxuIl0sIm5hbWVzIjpbIlBPU1QiLCJ2YWxpZGF0ZVdlYmhvb2tIZWFkZXJzIiwicmVxdWVzdCIsInN2aXhfaWQiLCJoZWFkZXJzIiwiZ2V0Iiwic3ZpeF90aW1lc3RhbXAiLCJzdml4X3NpZ25hdHVyZSIsInZhbGlkIiwiZXJyb3IiLCJ2ZXJpZnlXZWJob29rU2lnbmF0dXJlIiwicGF5bG9hZCIsInNlY3JldCIsIndoIiwiV2ViaG9vayIsImV2dCIsInZlcmlmeSIsImV2ZW50IiwiY29uc29sZSIsIm1lc3NhZ2UiLCJwcm9jZXNzV2ViaG9va0V2ZW50Iiwic3RhcnRUaW1lIiwiRGF0ZSIsIm5vdyIsImV2ZW50VHlwZSIsInR5cGUiLCJ1c2VyRGF0YSIsImRhdGEiLCJsb2ciLCJpZCIsImNyZWF0ZVJlc3VsdCIsInN5bmNVc2VyVG9TdXBhYmFzZSIsInJldHJ5QXR0ZW1wdHMiLCJyZXRyeURlbGF5IiwidmFsaWRhdGVEYXRhIiwiY3JlYXRlTWlzc2luZ1JvbGUiLCJsb2dFdmVudHMiLCJzdWNjZXNzIiwibG9nQWRtaW5BY3Rpb24iLCJ1c2VySWQiLCJ1c2VyUm9sZSIsInBlcm1pc3Npb25zIiwibWV0YWRhdGEiLCJzb3VyY2UiLCJhY3Rpb24iLCJlbWFpbCIsImVtYWlsX2FkZHJlc3NlcyIsImVtYWlsX2FkZHJlc3MiLCJ3ZWJob29rX2V2ZW50IiwicHJvY2Vzc2luZ1RpbWUiLCJFcnJvciIsInVwZGF0ZVJlc3VsdCIsImRlbGV0ZVJlc3VsdCIsImRlbGV0ZVVzZXJGcm9tU3VwYWJhc2UiLCJsb2dTZWN1cml0eUV2ZW50IiwidXNlcl9pZCIsImV2ZW50X3R5cGUiLCJldmVudF9jYXRlZ29yeSIsInNldmVyaXR5IiwiZGVzY3JpcHRpb24iLCJOZXh0UmVzcG9uc2UiLCJqc29uIiwidGltZXN0YW1wIiwidG9JU09TdHJpbmciLCJzdGF0dXMiXSwibWFwcGluZ3MiOiJBQUFBLHNDQUFzQztBQUN0QyxnREFBZ0Q7QUFDaEQsb0VBQW9FO0FBQ3BF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