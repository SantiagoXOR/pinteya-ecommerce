{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\lib\\auth\\admin-auth.ts"],"sourcesContent":["/**\n * Sistema de Autenticación y Autorización para Panel Administrativo\n * Implementa verificación de roles y permisos granulares\n */\n\nimport { auth, currentUser, getAuth } from '@clerk/nextjs/server';\nimport { supabaseAdmin } from '@/lib/supabase';\nimport { NextRequest } from 'next/server';\nimport type { NextApiRequest, NextApiResponse } from 'next';\n\n// =====================================================\n// TIPOS Y INTERFACES\n// =====================================================\n\nexport interface UserProfile {\n  id: string;\n  supabase_user_id: string | null;\n  clerk_user_id: string | null;\n  email: string;\n  first_name: string | null;\n  last_name: string | null;\n  role_id: number;\n  is_active: boolean;\n  is_verified: boolean;\n  user_roles: {\n    id: number;\n    role_name: string;\n    display_name: string;\n    permissions: Record<string, any>;\n    is_active: boolean;\n  };\n}\n\nexport interface AdminAuthResult {\n  success: boolean;\n  user?: UserProfile;\n  error?: string;\n  status?: number;\n}\n\nexport interface PermissionCheck {\n  resource: string;\n  action: string;\n  userId?: string;\n}\n\n// =====================================================\n// FUNCIONES DE VERIFICACIÓN DE AUTENTICACIÓN\n// =====================================================\n\n/**\n * Obtiene el usuario autenticado usando métodos oficiales de Clerk\n * Mantiene compatibilidad con implementación anterior como fallback\n */\nexport async function getAuthenticatedUser(\n  request?: NextRequest | NextApiRequest\n): Promise<{ userId: string | null; sessionId?: string; error?: string }> {\n  try {\n    // Método 1: Usar getAuth oficial de Clerk para API Routes (PREFERIDO)\n    if (request && 'query' in request) {\n      // Es NextApiRequest (Pages Router)\n      const { userId, sessionId } = getAuth(request as NextApiRequest);\n      if (userId) {\n        console.log(`[AUTH] Usuario autenticado via getAuth: ${userId}`);\n        return { userId, sessionId };\n      }\n    }\n\n    // Método 2: Usar auth() para App Router Route Handlers\n    if (!request || !('query' in request)) {\n      try {\n        const { userId, sessionId } = await auth();\n        if (userId) {\n          console.log(`[AUTH] Usuario autenticado via auth(): ${userId}`);\n          return { userId, sessionId };\n        }\n      } catch (authError) {\n        console.warn('[AUTH] Error usando auth():', authError);\n        // Continuar con métodos fallback\n      }\n    }\n\n    // Método 3: Fallback a headers (compatibilidad con implementación anterior)\n    if (request && 'headers' in request) {\n      const clerkUserId = request.headers.get?.('x-clerk-user-id') ||\n                         (request.headers as any)['x-clerk-user-id'];\n      if (clerkUserId) {\n        console.warn('[AUTH] Usando header fallback para userId - considera migrar a getAuth()');\n        return { userId: clerkUserId };\n      }\n    }\n\n    // Método 4: Fallback a JWT en cookies (último recurso)\n    if (request && 'cookies' in request) {\n      try {\n        const sessionToken = request.cookies.get?.('__session')?.value ||\n                            (request.cookies as any)['__session'];\n        if (sessionToken) {\n          // Decodificar el JWT para obtener el userId\n          const payload = JSON.parse(atob(sessionToken.split('.')[1]));\n          if (payload.sub) {\n            console.warn('[AUTH] Usando JWT fallback para userId');\n            return { userId: payload.sub };\n          }\n        }\n      } catch (jwtError) {\n        console.warn('[AUTH] Error decoding JWT:', jwtError);\n      }\n    }\n\n    return { userId: null, error: 'No autorizado' };\n  } catch (error) {\n    console.error('[AUTH] Error getting authenticated user:', error);\n    return { userId: null, error: 'Error de autenticación' };\n  }\n}\n\n/**\n * Nueva función específica para Pages Router API Routes\n * Usa getAuth(req) oficial de Clerk\n */\nexport function getAuthFromApiRoute(req: NextApiRequest, res: NextApiResponse) {\n  const { userId, sessionId, getToken } = getAuth(req);\n\n  if (!userId) {\n    throw new Error('Usuario no autenticado');\n  }\n\n  console.log(`[AUTH] API Route autenticada: ${userId}`);\n  return { userId, sessionId, getToken };\n}\n\n/**\n * Nueva función específica para App Router Route Handlers\n * Usa auth() oficial de Clerk\n */\nexport async function getAuthFromRouteHandler() {\n  const { userId, sessionId, getToken } = await auth();\n\n  if (!userId) {\n    throw new Error('Usuario no autenticado');\n  }\n\n  console.log(`[AUTH] Route Handler autenticado: ${userId}`);\n  return { userId, sessionId, getToken };\n}\n\n/**\n * Función unificada que detecta automáticamente el tipo de ruta\n */\nexport async function getUnifiedAuth(request?: NextRequest | NextApiRequest) {\n  try {\n    // Detectar si es API Route (Pages Router)\n    if (request && 'query' in request) {\n      return getAuthFromApiRoute(request as NextApiRequest, {} as NextApiResponse);\n    }\n\n    // Detectar si es Route Handler (App Router) o sin request\n    if (!request || !('query' in request)) {\n      return await getAuthFromRouteHandler();\n    }\n\n    // Fallback a función original\n    return await getAuthenticatedUser(request);\n  } catch (error) {\n    console.error('[AUTH] Error en getUnifiedAuth:', error);\n    throw error;\n  }\n}\n\n/**\n * Obtiene el perfil completo del usuario desde Supabase\n */\nexport async function getUserProfile(clerkUserId: string): Promise<UserProfile | null> {\n  try {\n    if (!supabaseAdmin) {\n      throw new Error('Supabase admin client not available');\n    }\n\n    // Primero obtener el perfil del usuario\n    const { data: profile, error: profileError } = await supabaseAdmin\n      .from('user_profiles')\n      .select('*')\n      .eq('clerk_user_id', clerkUserId)\n      .eq('is_active', true)\n      .single();\n\n    if (profileError) {\n      console.error('Error fetching user profile:', profileError);\n      return null;\n    }\n\n    if (!profile) {\n      return null;\n    }\n\n    // Luego obtener el rol del usuario\n    const { data: role, error: roleError } = await supabaseAdmin\n      .from('user_roles')\n      .select('*')\n      .eq('id', profile.role_id)\n      .single();\n\n    if (roleError) {\n      console.error('Error fetching user role:', roleError);\n      return null;\n    }\n\n    // Combinar los datos\n    const userProfile: UserProfile = {\n      ...profile,\n      user_roles: role\n    };\n\n    return userProfile;\n  } catch (error) {\n    console.error('Error in getUserProfile:', error);\n    return null;\n  }\n}\n\n/**\n * Verifica si un usuario tiene acceso al panel administrativo\n */\nexport async function checkAdminAccess(clerkUserId: string): Promise<AdminAuthResult> {\n  try {\n    const profile = await getUserProfile(clerkUserId);\n    \n    if (!profile) {\n      return {\n        success: false,\n        error: 'Perfil de usuario no encontrado',\n        status: 404\n      };\n    }\n\n    if (!profile.user_roles || !profile.is_active) {\n      return {\n        success: false,\n        error: 'Rol de usuario no válido',\n        status: 403\n      };\n    }\n\n    // Verificar si tiene acceso al panel admin\n    const hasAdminAccess = hasPermission(profile, ['admin_panel', 'access']);\n    \n    if (!hasAdminAccess) {\n      return {\n        success: false,\n        error: 'Acceso denegado al panel administrativo',\n        status: 403\n      };\n    }\n\n    return {\n      success: true,\n      user: profile\n    };\n  } catch (error) {\n    console.error('Error in checkAdminAccess:', error);\n    return {\n      success: false,\n      error: 'Error interno del servidor',\n      status: 500\n    };\n  }\n}\n\n// =====================================================\n// FUNCIONES DE VERIFICACIÓN DE PERMISOS\n// =====================================================\n\n/**\n * Verifica si un usuario tiene un permiso específico\n */\nexport function hasPermission(\n  userProfile: UserProfile,\n  permissionPath: string[]\n): boolean {\n  try {\n    if (!userProfile.user_roles || !userProfile.user_roles.permissions) {\n      return false;\n    }\n\n    let current: any = userProfile.user_roles.permissions;\n    \n    for (const path of permissionPath) {\n      if (current[path] === undefined) {\n        return false;\n      }\n      current = current[path];\n    }\n\n    // Manejar diferentes tipos de valores de permisos\n    if (typeof current === 'boolean') {\n      return current;\n    }\n    \n    if (typeof current === 'string') {\n      // Para permisos como \"own\", \"own_limited\", etc.\n      return current !== 'false';\n    }\n\n    return false;\n  } catch (error) {\n    console.error('Error checking permission:', error);\n    return false;\n  }\n}\n\n/**\n * Verifica múltiples permisos\n */\nexport function hasAnyPermission(\n  userProfile: UserProfile,\n  permissions: string[][]\n): boolean {\n  return permissions.some(permission => hasPermission(userProfile, permission));\n}\n\n/**\n * Verifica todos los permisos\n */\nexport function hasAllPermissions(\n  userProfile: UserProfile,\n  permissions: string[][]\n): boolean {\n  return permissions.every(permission => hasPermission(userProfile, permission));\n}\n\n/**\n * Verifica si el usuario es administrador\n */\nexport function isAdmin(userProfile: UserProfile): boolean {\n  return userProfile.user_roles?.role_name === 'admin';\n}\n\n/**\n * Verifica si el usuario es moderador o administrador\n */\nexport function isModeratorOrAdmin(userProfile: UserProfile): boolean {\n  const role = userProfile.user_roles?.role_name;\n  return role === 'admin' || role === 'moderator';\n}\n\n// =====================================================\n// MIDDLEWARE DE AUTORIZACIÓN\n// =====================================================\n\n/**\n * Middleware principal para verificar permisos administrativos\n * Actualizado para usar métodos oficiales de Clerk\n */\nexport async function checkAdminPermissions(\n  requiredPermissions?: string[][],\n  request?: NextRequest | NextApiRequest\n): Promise<AdminAuthResult & { supabase?: typeof supabaseAdmin }> {\n  try {\n    // 1. Verificar autenticación con Clerk usando métodos oficiales\n    let userId: string;\n    let sessionId: string | undefined;\n\n    try {\n      const authResult = await getUnifiedAuth(request);\n      userId = authResult.userId;\n      sessionId = authResult.sessionId;\n    } catch (authError) {\n      console.warn('[AUTH] Error en autenticación unificada, intentando fallback');\n      const fallbackResult = await getAuthenticatedUser(request);\n      if (!fallbackResult.userId) {\n        return {\n          success: false,\n          error: fallbackResult.error || 'No autorizado',\n          status: 401\n        };\n      }\n      userId = fallbackResult.userId;\n      sessionId = fallbackResult.sessionId;\n    }\n\n    // 2. Verificar disponibilidad de Supabase\n    if (!supabaseAdmin) {\n      return {\n        success: false,\n        error: 'Servicio administrativo no disponible',\n        status: 503\n      };\n    }\n\n    // 3. Verificar acceso administrativo\n    const adminCheck = await checkAdminAccess(userId);\n    \n    if (!adminCheck.success) {\n      return adminCheck;\n    }\n\n    const userProfile = adminCheck.user!;\n\n    // 4. Verificar permisos específicos si se proporcionan\n    if (requiredPermissions && requiredPermissions.length > 0) {\n      const hasRequiredPermissions = hasAnyPermission(userProfile, requiredPermissions);\n      \n      if (!hasRequiredPermissions) {\n        return {\n          success: false,\n          error: 'Permisos insuficientes para esta operación',\n          status: 403\n        };\n      }\n    }\n\n    // 5. Registrar acceso en audit log (opcional)\n    await logAdminAccess(userProfile.id, 'API_ACCESS');\n\n    return {\n      success: true,\n      user: userProfile,\n      supabase: supabaseAdmin\n    };\n  } catch (error) {\n    console.error('Error in checkAdminPermissions:', error);\n    return {\n      success: false,\n      error: 'Error interno del servidor',\n      status: 500\n    };\n  }\n}\n\n/**\n * Middleware específico para operaciones CRUD\n * Actualizado para soportar tanto NextRequest como NextApiRequest\n */\nexport async function checkCRUDPermissions(\n  resource: string,\n  action: 'create' | 'read' | 'update' | 'delete',\n  request?: NextRequest | NextApiRequest\n): Promise<AdminAuthResult & { supabase?: typeof supabaseAdmin }> {\n  const requiredPermissions = [[resource, action]];\n  return checkAdminPermissions(requiredPermissions, request);\n}\n\n// =====================================================\n// FUNCIONES DE LOGGING Y AUDITORÍA\n// =====================================================\n\n/**\n * Registra acceso administrativo en el audit log\n */\nexport async function logAdminAccess(\n  userProfileId: string,\n  action: string,\n  resourceType?: string,\n  resourceId?: string,\n  additionalData?: Record<string, any>\n): Promise<void> {\n  try {\n    if (!supabaseAdmin) return;\n\n    await supabaseAdmin\n      .from('admin_audit_log')\n      .insert({\n        user_id: userProfileId,\n        action,\n        resource_type: resourceType || 'system',\n        resource_id: resourceId,\n        new_values: additionalData ? JSON.stringify(additionalData) : null\n      });\n  } catch (error) {\n    console.error('Error logging admin access:', error);\n    // No lanzar error para no interrumpir el flujo principal\n  }\n}\n\n/**\n * Registra cambios en recursos administrativos\n */\nexport async function logAdminAction(\n  userProfileId: string,\n  action: string,\n  resourceType: string,\n  resourceId: string,\n  oldValues?: any,\n  newValues?: any\n): Promise<void> {\n  try {\n    if (!supabaseAdmin) return;\n\n    await supabaseAdmin\n      .from('admin_audit_log')\n      .insert({\n        user_id: userProfileId,\n        action,\n        resource_type: resourceType,\n        resource_id: resourceId,\n        old_values: oldValues ? JSON.stringify(oldValues) : null,\n        new_values: newValues ? JSON.stringify(newValues) : null\n      });\n  } catch (error) {\n    console.error('Error logging admin action:', error);\n  }\n}\n\n// =====================================================\n// UTILIDADES PARA NEXT.JS API ROUTES\n// =====================================================\n\n/**\n * Wrapper para API routes que requieren autenticación admin (App Router)\n */\nexport function withAdminAuth(\n  handler: (\n    request: NextRequest,\n    context: { user: UserProfile; supabase: typeof supabaseAdmin }\n  ) => Promise<Response>,\n  requiredPermissions?: string[][]\n) {\n  return async (request: NextRequest): Promise<Response> => {\n    const authResult = await checkAdminPermissions(requiredPermissions, request);\n\n    if (!authResult.success) {\n      return new Response(\n        JSON.stringify({\n          success: false,\n          error: authResult.error\n        }),\n        {\n          status: authResult.status || 500,\n          headers: { 'Content-Type': 'application/json' }\n        }\n      );\n    }\n\n    return handler(request, {\n      user: authResult.user!,\n      supabase: authResult.supabase!\n    });\n  };\n}\n\n/**\n * Wrapper para Pages Router API Routes que requieren autenticación admin\n */\nexport function withAdminAuthPages(\n  handler: (\n    req: NextApiRequest,\n    res: NextApiResponse,\n    context: { user: UserProfile; supabase: typeof supabaseAdmin }\n  ) => Promise<void>,\n  requiredPermissions?: string[][]\n) {\n  return async (req: NextApiRequest, res: NextApiResponse): Promise<void> => {\n    const authResult = await checkAdminPermissions(requiredPermissions, req);\n\n    if (!authResult.success) {\n      return res.status(authResult.status || 500).json({\n        success: false,\n        error: authResult.error\n      });\n    }\n\n    return handler(req, res, {\n      user: authResult.user!,\n      supabase: authResult.supabase!\n    });\n  };\n}\n\n/**\n * Extrae información de la request para logging\n * Soporta tanto NextRequest como NextApiRequest\n */\nexport function getRequestInfo(request: NextRequest | NextApiRequest) {\n  if ('query' in request) {\n    // NextApiRequest (Pages Router)\n    const req = request as NextApiRequest;\n    return {\n      method: req.method || 'GET',\n      url: req.url || 'unknown',\n      userAgent: req.headers['user-agent'] || 'unknown',\n      ip: req.headers['x-forwarded-for'] ||\n          req.headers['x-real-ip'] ||\n          req.connection?.remoteAddress ||\n          'unknown'\n    };\n  } else {\n    // NextRequest (App Router)\n    const req = request as NextRequest;\n    return {\n      method: req.method,\n      url: req.url,\n      userAgent: req.headers.get('user-agent') || 'unknown',\n      ip: req.headers.get('x-forwarded-for') ||\n          req.headers.get('x-real-ip') ||\n          'unknown'\n    };\n  }\n}\n"],"names":["checkAdminAccess","checkAdminPermissions","checkCRUDPermissions","getAuthFromApiRoute","getAuthFromRouteHandler","getAuthenticatedUser","getRequestInfo","getUnifiedAuth","getUserProfile","hasAllPermissions","hasAnyPermission","hasPermission","isAdmin","isModeratorOrAdmin","logAdminAccess","logAdminAction","withAdminAuth","withAdminAuthPages","request","userId","sessionId","getAuth","console","log","auth","authError","warn","clerkUserId","headers","get","sessionToken","cookies","value","payload","JSON","parse","atob","split","sub","jwtError","error","req","res","getToken","Error","supabaseAdmin","data","profile","profileError","from","select","eq","single","role","roleError","role_id","userProfile","user_roles","success","status","is_active","hasAdminAccess","user","permissionPath","permissions","current","path","undefined","some","permission","every","role_name","requiredPermissions","authResult","fallbackResult","adminCheck","length","hasRequiredPermissions","id","supabase","resource","action","userProfileId","resourceType","resourceId","additionalData","insert","user_id","resource_type","resource_id","new_values","stringify","oldValues","newValues","old_values","handler","Response","json","method","url","userAgent","ip","connection","remoteAddress"],"mappings":"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"}