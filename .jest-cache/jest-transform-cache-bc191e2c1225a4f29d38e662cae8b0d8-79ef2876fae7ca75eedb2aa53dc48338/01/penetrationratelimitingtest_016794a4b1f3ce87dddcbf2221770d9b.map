{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\__tests__\\security\\penetration-rate-limiting.test.ts"],"sourcesContent":["/**\r\n * Tests de Penetración para Rate Limiting Enterprise\r\n * Simula ataques reales para validar la robustez del sistema\r\n */\r\n\r\n// Mock de Redis para tests\r\njest.mock('ioredis', () => {\r\n  const mockRedis = {\r\n    get: jest.fn(),\r\n    set: jest.fn(),\r\n    incr: jest.fn(),\r\n    expire: jest.fn(),\r\n    del: jest.fn(),\r\n    pipeline: jest.fn(() => ({\r\n      get: jest.fn(),\r\n      incr: jest.fn(),\r\n      expire: jest.fn(),\r\n      exec: jest.fn().mockResolvedValue([[null, '1'], [null, 'OK']])\r\n    })),\r\n    disconnect: jest.fn()\r\n  };\r\n  return jest.fn(() => mockRedis);\r\n});\r\n\r\njest.mock('@/lib/security/enterprise-audit-system', () => ({\r\n  enterpriseAuditSystem: {\r\n    logEnterpriseEvent: jest.fn()\r\n  }\r\n}));\r\n\r\nimport { NextRequest } from 'next/server';\r\nimport {\r\n  checkEnterpriseRateLimit,\r\n  ENTERPRISE_RATE_LIMIT_CONFIGS,\r\n  metricsCollector,\r\n  type EnterpriseRateLimitResult\r\n} from '@/lib/rate-limiting/enterprise-rate-limiter';\r\nimport { withEnterpriseRateLimit } from '@/lib/rate-limiting/enterprise-middleware';\r\n\r\ndescribe('Tests de Penetración - Rate Limiting Enterprise', () => {\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n    // Reset metrics collector\r\n    (metricsCollector as any).metrics = {\r\n      totalRequests: 0,\r\n      allowedRequests: 0,\r\n      blockedRequests: 0,\r\n      redisHits: 0,\r\n      memoryFallbacks: 0,\r\n      errors: 0,\r\n      averageResponseTime: 0,\r\n      topBlockedIPs: [],\r\n      topEndpoints: []\r\n    };\r\n  });\r\n\r\n  describe('Ataque de Fuerza Bruta - Admin APIs', () => {\r\n    it('debe bloquear múltiples requests rápidos desde la misma IP', async () => {\r\n      const attackerIP = '192.168.1.100';\r\n      const config = ENTERPRISE_RATE_LIMIT_CONFIGS.ADMIN_CRITICAL;\r\n      const results: EnterpriseRateLimitResult[] = [];\r\n\r\n      // Simular 20 requests rápidos (límite admin es 15/min)\r\n      for (let i = 0; i < 20; i++) {\r\n        const mockRequest = {\r\n          headers: new Map([\r\n            ['x-forwarded-for', attackerIP],\r\n            ['user-agent', 'AttackBot/1.0']\r\n          ]),\r\n          nextUrl: { pathname: '/api/admin/products' },\r\n          method: 'POST'\r\n        } as any;\r\n\r\n        const result = await checkEnterpriseRateLimit(\r\n          mockRequest,\r\n          config,\r\n          `admin_attack_${i}`\r\n        );\r\n        results.push(result);\r\n      }\r\n\r\n      // Verificar que los primeros requests pasan\r\n      expect(results.slice(0, 15).every(r => r.allowed)).toBe(true);\r\n      \r\n      // Verificar que los siguientes son bloqueados\r\n      expect(results.slice(15).every(r => !r.allowed)).toBe(true);\r\n      \r\n      // Verificar métricas de ataque\r\n      const metrics = metricsCollector.getMetrics();\r\n      expect(metrics.blockedRequests).toBeGreaterThan(0);\r\n      expect(metrics.topBlockedIPs.some(ip => ip.ip === attackerIP)).toBe(true);\r\n    });\r\n\r\n    it('debe detectar ataque distribuido desde múltiples IPs', async () => {\r\n      const attackerIPs = [\r\n        '192.168.1.100',\r\n        '192.168.1.101', \r\n        '192.168.1.102',\r\n        '192.168.1.103',\r\n        '192.168.1.104'\r\n      ];\r\n      const config = ENTERPRISE_RATE_LIMIT_CONFIGS.ADMIN_CRITICAL;\r\n      let totalBlocked = 0;\r\n\r\n      // Simular ataque distribuido\r\n      for (const ip of attackerIPs) {\r\n        for (let i = 0; i < 20; i++) {\r\n          const mockRequest = {\r\n            headers: new Map([\r\n              ['x-forwarded-for', ip],\r\n              ['user-agent', 'DistributedBot/1.0']\r\n            ]),\r\n            nextUrl: { pathname: '/api/admin/users' },\r\n            method: 'DELETE'\r\n          } as any;\r\n\r\n          const result = await checkEnterpriseRateLimit(\r\n            mockRequest,\r\n            config,\r\n            `distributed_attack_${ip}_${i}`\r\n          );\r\n\r\n          if (!result.allowed) {\r\n            totalBlocked++;\r\n          }\r\n        }\r\n      }\r\n\r\n      // Verificar que se bloquearon múltiples requests\r\n      expect(totalBlocked).toBeGreaterThan(20); // 5 IPs * 5 requests bloqueados cada una\r\n\r\n      // Verificar que múltiples IPs están en la lista de bloqueados\r\n      const metrics = metricsCollector.getMetrics();\r\n      expect(metrics.topBlockedIPs.length).toBeGreaterThan(3);\r\n    });\r\n\r\n    it('debe resistir ataque de bypass con headers falsos', async () => {\r\n      const config = ENTERPRISE_RATE_LIMIT_CONFIGS.ADMIN_CRITICAL;\r\n      const results: EnterpriseRateLimitResult[] = [];\r\n\r\n      // Intentar bypass con diferentes headers\r\n      const bypassAttempts = [\r\n        { 'x-forwarded-for': '127.0.0.1', 'x-real-ip': '192.168.1.100' },\r\n        { 'x-forwarded-for': '192.168.1.100', 'x-real-ip': '127.0.0.1' },\r\n        { 'x-forwarded-for': '192.168.1.100, 127.0.0.1' },\r\n        { 'x-forwarded-for': '192.168.1.100', 'cf-connecting-ip': '127.0.0.1' },\r\n        { 'x-forwarded-for': '192.168.1.100', 'x-client-ip': '10.0.0.1' }\r\n      ];\r\n\r\n      for (let attempt = 0; attempt < bypassAttempts.length; attempt++) {\r\n        for (let i = 0; i < 20; i++) {\r\n          const mockRequest = {\r\n            headers: new Map(Object.entries({\r\n              ...bypassAttempts[attempt],\r\n              'user-agent': 'BypassBot/1.0'\r\n            })),\r\n            nextUrl: { pathname: '/api/admin/settings' },\r\n            method: 'PUT'\r\n          } as any;\r\n\r\n          const result = await checkEnterpriseRateLimit(\r\n            mockRequest,\r\n            config,\r\n            `bypass_attempt_${attempt}_${i}`\r\n          );\r\n          results.push(result);\r\n        }\r\n      }\r\n\r\n      // Verificar que el sistema no fue burlado\r\n      const blockedCount = results.filter(r => !r.allowed).length;\r\n      expect(blockedCount).toBeGreaterThan(50); // Debería bloquear la mayoría\r\n    });\r\n  });\r\n\r\n  describe('Ataque de Agotamiento de Recursos', () => {\r\n    it('debe manejar requests con payloads extremadamente grandes', async () => {\r\n      const config = ENTERPRISE_RATE_LIMIT_CONFIGS.PAYMENT_HIGH;\r\n      const attackerIP = '10.0.0.50';\r\n\r\n      // Simular requests con diferentes tamaños de payload\r\n      const payloadSizes = [1000, 10000, 100000, 1000000]; // Bytes\r\n      const results: EnterpriseRateLimitResult[] = [];\r\n\r\n      for (const size of payloadSizes) {\r\n        for (let i = 0; i < 10; i++) {\r\n          const mockRequest = {\r\n            headers: new Map([\r\n              ['x-forwarded-for', attackerIP],\r\n              ['content-length', size.toString()],\r\n              ['user-agent', 'ResourceExhaustionBot/1.0']\r\n            ]),\r\n            nextUrl: { pathname: '/api/payments/process' },\r\n            method: 'POST'\r\n          } as any;\r\n\r\n          const result = await checkEnterpriseRateLimit(\r\n            mockRequest,\r\n            config,\r\n            `resource_attack_${size}_${i}`\r\n          );\r\n          results.push(result);\r\n        }\r\n      }\r\n\r\n      // Verificar que el sistema mantiene performance\r\n      const metrics = metricsCollector.getMetrics();\r\n      expect(metrics.averageResponseTime).toBeLessThan(100); // < 100ms\r\n      \r\n      // Verificar que se aplicó rate limiting\r\n      const blockedCount = results.filter(r => !r.allowed).length;\r\n      expect(blockedCount).toBeGreaterThan(0);\r\n    });\r\n\r\n    it('debe detectar patrones de scraping automatizado', async () => {\r\n      const config = ENTERPRISE_RATE_LIMIT_CONFIGS.PUBLIC_STANDARD;\r\n      const scraperIP = '203.0.113.100';\r\n      const results: EnterpriseRateLimitResult[] = [];\r\n\r\n      // Simular scraping con patrones regulares\r\n      const endpoints = [\r\n        '/api/products',\r\n        '/api/categories', \r\n        '/api/search',\r\n        '/api/products/1',\r\n        '/api/products/2'\r\n      ];\r\n\r\n      // Requests muy rápidos y regulares (típico de bots)\r\n      for (let round = 0; round < 10; round++) {\r\n        for (const endpoint of endpoints) {\r\n          const mockRequest = {\r\n            headers: new Map([\r\n              ['x-forwarded-for', scraperIP],\r\n              ['user-agent', 'ScrapingBot/2.0 (automated)']\r\n            ]),\r\n            nextUrl: { pathname: endpoint },\r\n            method: 'GET'\r\n          } as any;\r\n\r\n          const result = await checkEnterpriseRateLimit(\r\n            mockRequest,\r\n            config,\r\n            `scraping_${round}_${endpoint.replace('/', '_')}`\r\n          );\r\n          results.push(result);\r\n        }\r\n      }\r\n\r\n      // Verificar detección de scraping\r\n      const blockedCount = results.filter(r => !r.allowed).length;\r\n      expect(blockedCount).toBeGreaterThan(20); // Debería bloquear muchos requests\r\n\r\n      // Verificar que el endpoint está en top blocked\r\n      const metrics = metricsCollector.getMetrics();\r\n      expect(metrics.topEndpoints.length).toBeGreaterThan(0);\r\n    });\r\n  });\r\n\r\n  describe('Ataques de Timing y Concurrencia', () => {\r\n    it('debe manejar requests concurrentes masivos', async () => {\r\n      const config = ENTERPRISE_RATE_LIMIT_CONFIGS.PUBLIC_STANDARD;\r\n      const attackerIP = '198.51.100.50';\r\n\r\n      // Simular 100 requests concurrentes\r\n      const concurrentRequests = Array.from({ length: 100 }, (_, i) => {\r\n        const mockRequest = {\r\n          headers: new Map([\r\n            ['x-forwarded-for', attackerIP],\r\n            ['user-agent', 'ConcurrencyBot/1.0']\r\n          ]),\r\n          nextUrl: { pathname: '/api/products' },\r\n          method: 'GET'\r\n        } as any;\r\n\r\n        return checkEnterpriseRateLimit(\r\n          mockRequest,\r\n          config,\r\n          `concurrent_${i}`\r\n        );\r\n      });\r\n\r\n      const results = await Promise.all(concurrentRequests);\r\n\r\n      // Verificar que el sistema mantuvo consistencia\r\n      const allowedCount = results.filter(r => r.allowed).length;\r\n      const blockedCount = results.filter(r => !r.allowed).length;\r\n      \r\n      expect(allowedCount + blockedCount).toBe(100);\r\n      expect(blockedCount).toBeGreaterThan(50); // Debería bloquear la mayoría\r\n    });\r\n\r\n    it('debe resistir ataques de timing para encontrar ventanas', async () => {\r\n      const config = ENTERPRISE_RATE_LIMIT_CONFIGS.ADMIN_CRITICAL;\r\n      const attackerIP = '172.16.0.100';\r\n      const results: EnterpriseRateLimitResult[] = [];\r\n\r\n      // Intentar encontrar ventanas de tiempo donde el rate limit se resetea\r\n      for (let window = 0; window < 5; window++) {\r\n        // Burst inicial\r\n        for (let i = 0; i < 20; i++) {\r\n          const mockRequest = {\r\n            headers: new Map([\r\n              ['x-forwarded-for', attackerIP],\r\n              ['user-agent', 'TimingAttackBot/1.0']\r\n            ]),\r\n            nextUrl: { pathname: '/api/admin/critical' },\r\n            method: 'POST'\r\n          } as any;\r\n\r\n          const result = await checkEnterpriseRateLimit(\r\n            mockRequest,\r\n            config,\r\n            `timing_window_${window}_${i}`\r\n          );\r\n          results.push(result);\r\n        }\r\n\r\n        // Esperar un poco (simular espera para reset)\r\n        await new Promise(resolve => setTimeout(resolve, 100));\r\n      }\r\n\r\n      // Verificar que no se pudo explotar timing\r\n      const totalBlocked = results.filter(r => !r.allowed).length;\r\n      expect(totalBlocked).toBeGreaterThan(60); // Debería bloquear la mayoría\r\n    });\r\n  });\r\n\r\n  describe('Middleware de Rate Limiting bajo Ataque', () => {\r\n    it('debe mantener funcionalidad durante ataque DDoS simulado', async () => {\r\n      const mockHandler = jest.fn().mockResolvedValue(\r\n        new Response(JSON.stringify({ success: true }), { status: 200 })\r\n      );\r\n\r\n      const protectedHandler = withEnterpriseRateLimit({\r\n        configName: 'PUBLIC_STANDARD',\r\n        enableLogging: true\r\n      })(mockHandler);\r\n\r\n      // Simular DDoS con múltiples IPs\r\n      const attackIPs = Array.from({ length: 50 }, (_, i) => `10.0.${Math.floor(i/255)}.${i%255}`);\r\n      const results: Response[] = [];\r\n\r\n      for (const ip of attackIPs) {\r\n        for (let i = 0; i < 10; i++) {\r\n          const mockRequest = {\r\n            headers: new Map([\r\n              ['x-forwarded-for', ip],\r\n              ['user-agent', 'DDoSBot/1.0']\r\n            ]),\r\n            nextUrl: { pathname: '/api/public/test' },\r\n            method: 'GET'\r\n          } as any;\r\n\r\n          try {\r\n            const response = await protectedHandler(mockRequest);\r\n            results.push(response);\r\n          } catch (error) {\r\n            // Rate limit debería devolver respuesta, no error\r\n            expect(error).toBeUndefined();\r\n          }\r\n        }\r\n      }\r\n\r\n      // Verificar que el sistema respondió a todos los requests\r\n      expect(results.length).toBe(500);\r\n      \r\n      // Verificar que muchos fueron bloqueados (status 429)\r\n      const blockedResponses = results.filter(r => r.status === 429);\r\n      expect(blockedResponses.length).toBeGreaterThan(300);\r\n      \r\n      // Verificar que algunos requests legítimos pasaron\r\n      const successResponses = results.filter(r => r.status === 200);\r\n      expect(successResponses.length).toBeGreaterThan(0);\r\n    });\r\n\r\n    it('debe mantener performance durante ataque sostenido', async () => {\r\n      const mockHandler = jest.fn().mockResolvedValue(\r\n        new Response(JSON.stringify({ data: 'test' }), { status: 200 })\r\n      );\r\n\r\n      const protectedHandler = withEnterpriseRateLimit({\r\n        configName: 'ADMIN_CRITICAL',\r\n        enableLogging: false // Disable para performance\r\n      })(mockHandler);\r\n\r\n      const attackerIP = '192.0.2.100';\r\n      const startTime = Date.now();\r\n      const results: Response[] = [];\r\n\r\n      // Ataque sostenido por 1000 requests\r\n      for (let i = 0; i < 1000; i++) {\r\n        const mockRequest = {\r\n          headers: new Map([\r\n            ['x-forwarded-for', attackerIP],\r\n            ['user-agent', 'SustainedAttackBot/1.0']\r\n          ]),\r\n          nextUrl: { pathname: '/api/admin/test' },\r\n          method: 'GET'\r\n        } as any;\r\n\r\n        const response = await protectedHandler(mockRequest);\r\n        results.push(response);\r\n      }\r\n\r\n      const endTime = Date.now();\r\n      const totalTime = endTime - startTime;\r\n      const avgResponseTime = totalTime / 1000;\r\n\r\n      // Verificar performance (< 5ms por request en promedio)\r\n      expect(avgResponseTime).toBeLessThan(5);\r\n      \r\n      // Verificar que el rate limiting funcionó\r\n      const blockedCount = results.filter(r => r.status === 429).length;\r\n      expect(blockedCount).toBeGreaterThan(900); // Debería bloquear casi todos\r\n    });\r\n  });\r\n\r\n  describe('Recuperación y Resilencia', () => {\r\n    it('debe recuperarse después de un ataque masivo', async () => {\r\n      const config = ENTERPRISE_RATE_LIMIT_CONFIGS.PUBLIC_STANDARD;\r\n      const attackerIP = '203.0.113.200';\r\n\r\n      // Fase 1: Ataque masivo\r\n      for (let i = 0; i < 100; i++) {\r\n        const mockRequest = {\r\n          headers: new Map([\r\n            ['x-forwarded-for', attackerIP],\r\n            ['user-agent', 'MassiveAttackBot/1.0']\r\n          ]),\r\n          nextUrl: { pathname: '/api/products' },\r\n          method: 'GET'\r\n        } as any;\r\n\r\n        await checkEnterpriseRateLimit(mockRequest, config, `massive_attack_${i}`);\r\n      }\r\n\r\n      // Verificar que el atacante está bloqueado\r\n      const duringAttackRequest = {\r\n        headers: new Map([\r\n          ['x-forwarded-for', attackerIP],\r\n          ['user-agent', 'MassiveAttackBot/1.0']\r\n        ]),\r\n        nextUrl: { pathname: '/api/products' },\r\n        method: 'GET'\r\n      } as any;\r\n\r\n      const duringAttackResult = await checkEnterpriseRateLimit(\r\n        duringAttackRequest, \r\n        config, \r\n        'during_attack_check'\r\n      );\r\n      expect(duringAttackResult.allowed).toBe(false);\r\n\r\n      // Fase 2: Usuario legítimo debe poder acceder\r\n      const legitimateUserIP = '198.51.100.200';\r\n      const legitimateRequest = {\r\n        headers: new Map([\r\n          ['x-forwarded-for', legitimateUserIP],\r\n          ['user-agent', 'Mozilla/5.0 (legitimate browser)']\r\n        ]),\r\n        nextUrl: { pathname: '/api/products' },\r\n        method: 'GET'\r\n      } as any;\r\n\r\n      const legitimateResult = await checkEnterpriseRateLimit(\r\n        legitimateRequest,\r\n        config,\r\n        'legitimate_user'\r\n      );\r\n      expect(legitimateResult.allowed).toBe(true);\r\n\r\n      // Verificar métricas de recuperación\r\n      const metrics = metricsCollector.getMetrics();\r\n      expect(metrics.totalRequests).toBeGreaterThan(100);\r\n      expect(metrics.allowedRequests).toBeGreaterThan(0);\r\n    });\r\n  });\r\n});\r\n"],"names":["jest","mock","mockRedis","get","fn","set","incr","expire","del","pipeline","exec","mockResolvedValue","disconnect","enterpriseAuditSystem","logEnterpriseEvent","describe","beforeEach","clearAllMocks","metricsCollector","metrics","totalRequests","allowedRequests","blockedRequests","redisHits","memoryFallbacks","errors","averageResponseTime","topBlockedIPs","topEndpoints","it","attackerIP","config","ENTERPRISE_RATE_LIMIT_CONFIGS","ADMIN_CRITICAL","results","i","mockRequest","headers","Map","nextUrl","pathname","method","result","checkEnterpriseRateLimit","push","expect","slice","every","r","allowed","toBe","getMetrics","toBeGreaterThan","some","ip","attackerIPs","totalBlocked","length","bypassAttempts","attempt","Object","entries","blockedCount","filter","PAYMENT_HIGH","payloadSizes","size","toString","toBeLessThan","PUBLIC_STANDARD","scraperIP","endpoints","round","endpoint","replace","concurrentRequests","Array","from","_","Promise","all","allowedCount","window","resolve","setTimeout","mockHandler","Response","JSON","stringify","success","status","protectedHandler","withEnterpriseRateLimit","configName","enableLogging","attackIPs","Math","floor","response","error","toBeUndefined","blockedResponses","successResponses","data","startTime","Date","now","endTime","totalTime","avgResponseTime","duringAttackRequest","duringAttackResult","legitimateUserIP","legitimateRequest","legitimateResult"],"mappings":"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"}