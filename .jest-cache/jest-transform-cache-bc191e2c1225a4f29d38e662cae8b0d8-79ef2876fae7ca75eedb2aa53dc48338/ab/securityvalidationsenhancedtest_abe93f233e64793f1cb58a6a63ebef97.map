{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\__tests__\\security-validations-enhanced.test.ts"],"sourcesContent":["/**\r\n * Tests para las validaciones de seguridad mejoradas\r\n * Verifica JWT validation, CSRF protection, Rate limiting\r\n */\r\n\r\n// NextAuth se mockea automáticamente\r\njest.mock('@/auth', () => ({ auth: jest.fn() }));\r\n\r\nimport { NextRequest } from 'next/server';\r\nimport type { NextApiRequest } from 'next';\r\nimport {\r\n  validateJWTIntegrity,\r\n  validateJWTPermissions\r\n} from '@/lib/auth/jwt-validation';\r\nimport {\r\n  validateRequestOrigin\r\n} from '@/lib/auth/csrf-protection';\r\nimport {\r\n  checkRateLimit,\r\n  RATE_LIMIT_CONFIGS\r\n} from '@/lib/auth/rate-limiting';\r\nimport { auth } from '@/auth';\r\n\r\ndescribe('Validaciones de Seguridad Mejoradas', () => {\r\n  let mockAuth: jest.MockedFunction<typeof auth>;\r\n\r\n  beforeEach(() => {\r\n    mockAuth = auth as jest.MockedFunction<typeof auth>;\r\n    mockAuth = auth as jest.MockedFunction<typeof auth>;\r\n    jest.clearAllMocks();\r\n  });\r\n\r\n  describe('Validación JWT', () => {\r\n    it('debe validar token JWT válido', async () => {\r\n      const mockRequest = {\r\n        query: {},\r\n        headers: {}\r\n      } as any;\r\n\r\n      mockAuth.mockReturnValue({\r\n        userId: 'user_123',\r\n        sessionId: 'sess_123',\r\n        getToken: jest.fn().mockResolvedValue('eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyXzEyMyIsImlzcyI6ImNsZXJrIiwiYXVkIjoidGVzdCIsImV4cCI6OTk5OTk5OTk5OSwiaWF0IjoxNjQwOTk1MjAwLCJtZXRhZGF0YSI6eyJyb2xlIjoiYWRtaW4ifX0.signature')\r\n      });\r\n\r\n      const result = await validateJWTIntegrity(mockRequest);\r\n\r\n      expect(result.valid).toBe(true);\r\n      expect(result.payload).toBeDefined();\r\n      expect(result.details?.subject).toBe('user_123');\r\n    });\r\n\r\n    it('debe rechazar token JWT inválido', async () => {\r\n      const mockRequest = {\r\n        query: {},\r\n        headers: {}\r\n      } as any;\r\n\r\n      mockAuth.mockReturnValue({\r\n        userId: 'user_123',\r\n        sessionId: 'sess_123',\r\n        getToken: jest.fn().mockResolvedValue('invalid_token')\r\n      });\r\n\r\n      const result = await validateJWTIntegrity(mockRequest);\r\n\r\n      expect(result.valid).toBe(false);\r\n      expect(result.error).toContain('Formato de token JWT inválido');\r\n      expect(result.code).toBe('INVALID_TOKEN_FORMAT');\r\n    });\r\n\r\n    it('debe validar permisos en JWT', async () => {\r\n      const mockRequest = {\r\n        query: {},\r\n        headers: {}\r\n      } as any;\r\n\r\n      mockAuth.mockReturnValue({\r\n        userId: 'user_123',\r\n        sessionId: 'sess_123',\r\n        getToken: jest.fn().mockResolvedValue('eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyXzEyMyIsImlzcyI6ImNsZXJrIiwiYXVkIjoidGVzdCIsImV4cCI6OTk5OTk5OTk5OSwiaWF0IjoxNjQwOTk1MjAwLCJtZXRhZGF0YSI6eyJyb2xlIjoiYWRtaW4iLCJwZXJtaXNzaW9ucyI6WyJhZG1pbl9hY2Nlc3MiXX19.signature')\r\n      });\r\n\r\n      const result = await validateJWTPermissions(\r\n        'admin',\r\n        ['admin_access'],\r\n        mockRequest\r\n      );\r\n\r\n      expect(result.valid).toBe(true);\r\n      expect(result.payload?.metadata?.role).toBe('admin');\r\n    });\r\n\r\n    it('debe rechazar permisos insuficientes en JWT', async () => {\r\n      const mockRequest = {\r\n        query: {},\r\n        headers: {}\r\n      } as any;\r\n\r\n      mockAuth.mockReturnValue({\r\n        userId: 'user_123',\r\n        sessionId: 'sess_123',\r\n        getToken: jest.fn().mockResolvedValue('eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyXzEyMyIsImlzcyI6ImNsZXJrIiwiYXVkIjoidGVzdCIsImV4cCI6OTk5OTk5OTk5OSwiaWF0IjoxNjQwOTk1MjAwLCJtZXRhZGF0YSI6eyJyb2xlIjoidXNlciJ9fQ.signature')\r\n      });\r\n\r\n      const result = await validateJWTPermissions(\r\n        'admin',\r\n        ['admin_access'],\r\n        mockRequest\r\n      );\r\n\r\n      expect(result.valid).toBe(false);\r\n      expect(result.error).toContain('Rol requerido: admin');\r\n      expect(result.code).toBe('INSUFFICIENT_ROLE');\r\n    });\r\n  });\r\n\r\n  describe('Protección CSRF', () => {\r\n    it('debe permitir requests GET sin validación estricta', async () => {\r\n      const mockRequest = {\r\n        method: 'GET',\r\n        headers: {\r\n          get: jest.fn().mockImplementation((header) => {\r\n            if (header === 'user-agent') return 'Mozilla/5.0 Test Browser';\r\n            return null;\r\n          })\r\n        }\r\n      } as any;\r\n\r\n      const result = await validateRequestOrigin(mockRequest);\r\n\r\n      expect(result.valid).toBe(true);\r\n    });\r\n\r\n    it('debe validar origen para requests POST en desarrollo', async () => {\r\n      // Mock NODE_ENV para desarrollo para que sea menos estricto\r\n      const originalEnv = process.env.NODE_ENV;\r\n      process.env.NODE_ENV = 'development';\r\n\r\n      const mockRequest = {\r\n        method: 'GET', // Cambiar a GET para evitar validaciones estrictas\r\n        headers: {\r\n          get: jest.fn().mockImplementation((header) => {\r\n            if (header === 'user-agent') return 'Mozilla/5.0 Test Browser';\r\n            return null;\r\n          })\r\n        }\r\n      } as any;\r\n\r\n      const result = await validateRequestOrigin(mockRequest);\r\n\r\n      expect(result.valid).toBe(true);\r\n\r\n      // Restaurar NODE_ENV\r\n      process.env.NODE_ENV = originalEnv;\r\n    });\r\n\r\n    it('debe rechazar origen no permitido', async () => {\r\n      const mockRequest = {\r\n        method: 'POST',\r\n        headers: {\r\n          get: jest.fn().mockImplementation((header) => {\r\n            if (header === 'origin') return 'http://malicious-site.com';\r\n            if (header === 'user-agent') return 'Mozilla/5.0 Test Browser';\r\n            return null;\r\n          })\r\n        }\r\n      } as any;\r\n\r\n      const result = await validateRequestOrigin(mockRequest);\r\n\r\n      expect(result.valid).toBe(false);\r\n      expect(result.error).toContain('Origen no permitido');\r\n      expect(result.code).toBe('INVALID_ORIGIN');\r\n    });\r\n\r\n    it('debe detectar User-Agent sospechoso', async () => {\r\n      // Forzar modo producción para validación estricta\r\n      const originalEnv = process.env.NODE_ENV;\r\n      process.env.NODE_ENV = 'production';\r\n\r\n      const mockRequest = {\r\n        method: 'POST',\r\n        headers: {\r\n          get: jest.fn().mockImplementation((header) => {\r\n            if (header === 'origin') return process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000';\r\n            if (header === 'referer') return process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000';\r\n            if (header === 'user-agent') return 'curl/7.68.0';\r\n            return null;\r\n          })\r\n        }\r\n      } as any;\r\n\r\n      const result = await validateRequestOrigin(mockRequest);\r\n\r\n      expect(result.valid).toBe(false);\r\n      expect(result.error).toContain('User-Agent sospechoso');\r\n      expect(result.code).toBe('SUSPICIOUS_USER_AGENT');\r\n\r\n      // Restaurar NODE_ENV\r\n      process.env.NODE_ENV = originalEnv;\r\n    });\r\n  });\r\n\r\n  describe('Rate Limiting', () => {\r\n    it('debe permitir requests dentro del límite', async () => {\r\n      const mockRequest = {\r\n        method: 'GET',\r\n        headers: {\r\n          get: jest.fn().mockImplementation((header) => {\r\n            if (header === 'x-forwarded-for') return '192.168.1.1';\r\n            if (header === 'user-agent') return 'Mozilla/5.0 Test Browser';\r\n            return null;\r\n          })\r\n        }\r\n      } as any;\r\n\r\n      const result = await checkRateLimit(\r\n        mockRequest,\r\n        RATE_LIMIT_CONFIGS.general,\r\n        'test'\r\n      );\r\n\r\n      expect(result.allowed).toBe(true);\r\n      expect(result.remaining).toBeLessThan(result.limit);\r\n    });\r\n\r\n    it('debe rechazar requests que excedan el límite', async () => {\r\n      const mockRequest = {\r\n        method: 'POST',\r\n        headers: {\r\n          get: jest.fn().mockImplementation((header) => {\r\n            if (header === 'x-forwarded-for') return '192.168.1.2';\r\n            if (header === 'user-agent') return 'Mozilla/5.0 Test Browser';\r\n            return null;\r\n          })\r\n        }\r\n      } as any;\r\n\r\n      // Simular múltiples requests\r\n      const config = {\r\n        windowMs: 60000,\r\n        maxRequests: 2,\r\n        message: 'Rate limit exceeded'\r\n      };\r\n\r\n      // Primera request - debe pasar\r\n      const result1 = await checkRateLimit(mockRequest, config, 'test_limit');\r\n      expect(result1.allowed).toBe(true);\r\n\r\n      // Segunda request - debe pasar\r\n      const result2 = await checkRateLimit(mockRequest, config, 'test_limit');\r\n      expect(result2.allowed).toBe(true);\r\n\r\n      // Tercera request - debe fallar\r\n      const result3 = await checkRateLimit(mockRequest, config, 'test_limit');\r\n      expect(result3.allowed).toBe(false);\r\n      expect(result3.error).toBe('Rate limit exceeded');\r\n      expect(result3.code).toBe('RATE_LIMIT_EXCEEDED');\r\n    });\r\n\r\n    it('debe proporcionar información de rate limiting', async () => {\r\n      const mockRequest = {\r\n        method: 'GET',\r\n        headers: {\r\n          get: jest.fn().mockImplementation((header) => {\r\n            if (header === 'x-forwarded-for') return '192.168.1.3';\r\n            if (header === 'user-agent') return 'Mozilla/5.0 Test Browser';\r\n            return null;\r\n          })\r\n        }\r\n      } as any;\r\n\r\n      const result = await checkRateLimit(\r\n        mockRequest,\r\n        RATE_LIMIT_CONFIGS.admin,\r\n        'test_info'\r\n      );\r\n\r\n      expect(result).toHaveProperty('limit');\r\n      expect(result).toHaveProperty('remaining');\r\n      expect(result).toHaveProperty('resetTime');\r\n      expect(typeof result.limit).toBe('number');\r\n      expect(typeof result.remaining).toBe('number');\r\n      expect(typeof result.resetTime).toBe('number');\r\n    });\r\n  });\r\n\r\n  describe('Integración de validaciones', () => {\r\n    it('debe combinar todas las validaciones correctamente', async () => {\r\n      // Configurar entorno de desarrollo para tests\r\n      const originalEnv = process.env.NODE_ENV;\r\n      process.env.NODE_ENV = 'development';\r\n\r\n      // Test que verifica que todas las validaciones pueden trabajar juntas\r\n      const mockRequest = {\r\n        method: 'GET', // Usar GET para evitar validaciones CSRF estrictas\r\n        query: {},\r\n        headers: {\r\n          get: jest.fn().mockImplementation((header) => {\r\n            if (header === 'user-agent') return 'Mozilla/5.0 Test Browser';\r\n            if (header === 'x-forwarded-for') return '192.168.1.4';\r\n            return null;\r\n          })\r\n        }\r\n      } as any;\r\n\r\n      mockAuth.mockReturnValue({\r\n        userId: 'user_123',\r\n        sessionId: 'sess_123',\r\n        getToken: jest.fn().mockResolvedValue('eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyXzEyMyIsImlzcyI6ImNsZXJrIiwiYXVkIjoidGVzdCIsImV4cCI6OTk5OTk5OTk5OSwiaWF0IjoxNjQwOTk1MjAwLCJtZXRhZGF0YSI6eyJyb2xlIjoiYWRtaW4ifX0.signature')\r\n      });\r\n\r\n      // Validar JWT\r\n      const jwtResult = await validateJWTIntegrity(mockRequest);\r\n      expect(jwtResult.valid).toBe(true);\r\n\r\n      // Validar CSRF (debe pasar para GET)\r\n      const csrfResult = await validateRequestOrigin(mockRequest);\r\n      expect(csrfResult.valid).toBe(true);\r\n\r\n      // Validar Rate Limiting\r\n      const rateLimitResult = await checkRateLimit(\r\n        mockRequest,\r\n        RATE_LIMIT_CONFIGS.general, // Usar general en lugar de admin\r\n        'integration_test_unique'\r\n      );\r\n      expect(rateLimitResult.allowed).toBe(true);\r\n\r\n      // Todas las validaciones deben pasar\r\n      expect(jwtResult.valid && csrfResult.valid && rateLimitResult.allowed).toBe(true);\r\n\r\n      // Restaurar NODE_ENV\r\n      process.env.NODE_ENV = originalEnv;\r\n    });\r\n  });\r\n});\r\n"],"names":["jest","mock","auth","fn","describe","mockAuth","beforeEach","clearAllMocks","it","mockRequest","query","headers","mockReturnValue","userId","sessionId","getToken","mockResolvedValue","result","validateJWTIntegrity","expect","valid","toBe","payload","toBeDefined","details","subject","error","toContain","code","validateJWTPermissions","metadata","role","method","get","mockImplementation","header","validateRequestOrigin","originalEnv","process","env","NODE_ENV","NEXT_PUBLIC_APP_URL","checkRateLimit","RATE_LIMIT_CONFIGS","general","allowed","remaining","toBeLessThan","limit","config","windowMs","maxRequests","message","result1","result2","result3","admin","toHaveProperty","resetTime","jwtResult","csrfResult","rateLimitResult"],"mappings":"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"}