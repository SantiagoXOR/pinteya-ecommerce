{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\lib\\monitoring\\alert-system.ts"],"sourcesContent":["// ===================================\n// PINTEYA E-COMMERCE - ENTERPRISE ALERT SYSTEM\n// ===================================\n\nimport { logger, LogLevel, LogCategory } from '@/lib/logger';\nimport { getSupabaseClient } from '@/lib/supabase';\nimport { emailService } from '@/lib/notifications/email';\nimport { slackService } from '@/lib/notifications/slack';\n\n// ✅ IMPORT CONDICIONAL: Solo cargar CacheUtils en servidor para evitar errores de ioredis en cliente\nlet CacheUtils: any = null;\nif (typeof window === 'undefined') {\n  // Solo en servidor\n  try {\n    CacheUtils = require('@/lib/cache-manager').CacheUtils;\n  } catch (error) {\n    console.warn('[EnterpriseAlertSystem] CacheUtils not available:', error);\n  }\n}\n\n// Niveles de alerta con escalamiento\nexport enum AlertLevel {\n  INFO = 'info',\n  WARNING = 'warning', \n  CRITICAL = 'critical',\n  EMERGENCY = 'emergency'\n}\n\n// Tipos de notificación\nexport enum NotificationType {\n  EMAIL = 'email',\n  SLACK = 'slack',\n  WEBHOOK = 'webhook',\n  SMS = 'sms',\n  PUSH = 'push',\n  LOG = 'log'\n}\n\n// Estados de alerta\nexport enum AlertStatus {\n  ACTIVE = 'active',\n  ACKNOWLEDGED = 'acknowledged',\n  RESOLVED = 'resolved',\n  SUPPRESSED = 'suppressed'\n}\n\n// Configuración de canal de notificación\nexport interface NotificationChannel {\n  id: string;\n  type: NotificationType;\n  name: string;\n  config: Record<string, any>;\n  enabled: boolean;\n  levels: AlertLevel[];\n  rateLimit?: {\n    maxPerHour: number;\n    maxPerDay: number;\n  };\n}\n\n// Regla de escalamiento\nexport interface EscalationRule {\n  id: string;\n  name: string;\n  enabled: boolean;\n  conditions: {\n    level: AlertLevel;\n    duration: number; // minutos sin resolución\n    repeatCount?: number; // número de repeticiones\n  };\n  actions: {\n    escalateToLevel?: AlertLevel;\n    notifyChannels: string[]; // IDs de canales\n    assignToUser?: string;\n  };\n}\n\n// Configuración de alerta\nexport interface AlertRule {\n  id: string;\n  name: string;\n  description: string;\n  enabled: boolean;\n  metricName: string;\n  condition: 'gt' | 'lt' | 'eq' | 'gte' | 'lte';\n  threshold: number;\n  level: AlertLevel;\n  cooldownMinutes: number;\n  channels: string[]; // IDs de canales de notificación\n  escalationRules: string[]; // IDs de reglas de escalamiento\n  tags: Record<string, string>;\n  metadata?: Record<string, any>;\n}\n\n// Alerta activa\nexport interface Alert {\n  id: string;\n  ruleId: string;\n  ruleName: string;\n  level: AlertLevel;\n  status: AlertStatus;\n  message: string;\n  metricName: string;\n  value: number;\n  threshold: number;\n  triggeredAt: string;\n  acknowledgedAt?: string;\n  acknowledgedBy?: string;\n  resolvedAt?: string;\n  resolvedBy?: string;\n  escalatedAt?: string;\n  escalatedFrom?: AlertLevel;\n  notificationsSent: NotificationLog[];\n  tags: Record<string, string>;\n  metadata?: Record<string, any>;\n}\n\n// Log de notificación\nexport interface NotificationLog {\n  id: string;\n  channelId: string;\n  channelType: NotificationType;\n  sentAt: string;\n  success: boolean;\n  error?: string;\n  responseTime: number;\n}\n\n/**\n * Sistema de Alertas Enterprise con escalamiento automático\n */\nexport class EnterpriseAlertSystem {\n  private static instance: EnterpriseAlertSystem;\n  private alertRules: Map<string, AlertRule> = new Map();\n  private notificationChannels: Map<string, NotificationChannel> = new Map();\n  private escalationRules: Map<string, EscalationRule> = new Map();\n  private activeAlerts: Map<string, Alert> = new Map();\n  private escalationInterval: NodeJS.Timeout | null = null;\n\n  constructor() {\n    this.initializeDefaultChannels();\n    this.initializeDefaultRules();\n    this.startEscalationMonitoring();\n  }\n\n  static getInstance(): EnterpriseAlertSystem {\n    if (!EnterpriseAlertSystem.instance) {\n      EnterpriseAlertSystem.instance = new EnterpriseAlertSystem();\n    }\n    return EnterpriseAlertSystem.instance;\n  }\n\n  /**\n   * Configura un canal de notificación\n   */\n  setNotificationChannel(channel: NotificationChannel): void {\n    this.notificationChannels.set(channel.id, channel);\n    logger.info(LogLevel.INFO, `Notification channel configured: ${channel.id}`, {\n      type: channel.type,\n      enabled: channel.enabled,\n      levels: channel.levels\n    }, LogCategory.SYSTEM);\n  }\n\n  /**\n   * Configura una regla de escalamiento\n   */\n  setEscalationRule(rule: EscalationRule): void {\n    this.escalationRules.set(rule.id, rule);\n    logger.info(LogLevel.INFO, `Escalation rule configured: ${rule.id}`, {\n      level: rule.conditions.level,\n      duration: rule.conditions.duration,\n      enabled: rule.enabled\n    }, LogCategory.SYSTEM);\n  }\n\n  /**\n   * Configura una regla de alerta\n   */\n  setAlertRule(rule: AlertRule): void {\n    this.alertRules.set(rule.id, rule);\n    logger.info(LogLevel.INFO, `Alert rule configured: ${rule.id}`, {\n      metricName: rule.metricName,\n      threshold: rule.threshold,\n      level: rule.level,\n      enabled: rule.enabled\n    }, LogCategory.SYSTEM);\n  }\n\n  /**\n   * Dispara una alerta\n   */\n  async triggerAlert(\n    ruleId: string,\n    metricName: string,\n    value: number,\n    message?: string\n  ): Promise<Alert | null> {\n    const rule = this.alertRules.get(ruleId);\n    if (!rule || !rule.enabled) {\n      return null;\n    }\n\n    // Verificar cooldown\n    const existingAlert = Array.from(this.activeAlerts.values())\n      .find(alert => alert.ruleId === ruleId && alert.status === AlertStatus.ACTIVE);\n\n    if (existingAlert) {\n      const cooldownEnd = new Date(existingAlert.triggeredAt);\n      cooldownEnd.setMinutes(cooldownEnd.getMinutes() + rule.cooldownMinutes);\n      \n      if (new Date() < cooldownEnd) {\n        return null; // Aún en cooldown\n      }\n    }\n\n    // Crear nueva alerta\n    const alert: Alert = {\n      id: this.generateAlertId(),\n      ruleId: rule.id,\n      ruleName: rule.name,\n      level: rule.level,\n      status: AlertStatus.ACTIVE,\n      message: message || `${rule.description} - Value: ${value}, Threshold: ${rule.threshold}`,\n      metricName,\n      value,\n      threshold: rule.threshold,\n      triggeredAt: new Date().toISOString(),\n      notificationsSent: [],\n      tags: rule.tags,\n      metadata: rule.metadata\n    };\n\n    this.activeAlerts.set(alert.id, alert);\n\n    // Enviar notificaciones\n    await this.sendNotifications(alert, rule.channels);\n\n    // Almacenar en base de datos\n    await this.storeAlert(alert);\n\n    logger.warn(LogLevel.WARN, `Alert triggered: ${rule.name}`, {\n      alertId: alert.id,\n      level: alert.level,\n      metricName: alert.metricName,\n      value: alert.value,\n      threshold: alert.threshold\n    }, LogCategory.SYSTEM);\n\n    return alert;\n  }\n\n  /**\n   * Reconoce una alerta\n   */\n  async acknowledgeAlert(alertId: string, userId: string): Promise<boolean> {\n    const alert = this.activeAlerts.get(alertId);\n    if (!alert || alert.status !== AlertStatus.ACTIVE) {\n      return false;\n    }\n\n    alert.status = AlertStatus.ACKNOWLEDGED;\n    alert.acknowledgedAt = new Date().toISOString();\n    alert.acknowledgedBy = userId;\n\n    await this.updateAlert(alert);\n\n    logger.info(LogLevel.INFO, `Alert acknowledged: ${alertId}`, {\n      userId,\n      level: alert.level,\n      ruleName: alert.ruleName\n    }, LogCategory.SYSTEM);\n\n    return true;\n  }\n\n  /**\n   * Resuelve una alerta\n   */\n  async resolveAlert(alertId: string, userId?: string): Promise<boolean> {\n    const alert = this.activeAlerts.get(alertId);\n    if (!alert) {\n      return false;\n    }\n\n    alert.status = AlertStatus.RESOLVED;\n    alert.resolvedAt = new Date().toISOString();\n    alert.resolvedBy = userId;\n\n    await this.updateAlert(alert);\n    this.activeAlerts.delete(alertId);\n\n    logger.info(LogLevel.INFO, `Alert resolved: ${alertId}`, {\n      userId,\n      level: alert.level,\n      ruleName: alert.ruleName,\n      duration: this.calculateDuration(alert.triggeredAt, alert.resolvedAt!)\n    }, LogCategory.SYSTEM);\n\n    return true;\n  }\n\n  /**\n   * Envía notificaciones para una alerta\n   */\n  private async sendNotifications(alert: Alert, channelIds: string[]): Promise<void> {\n    const notifications = await Promise.allSettled(\n      channelIds.map(channelId => this.sendNotification(alert, channelId))\n    );\n\n    // Log resultados\n    notifications.forEach((result, index) => {\n      const channelId = channelIds[index];\n      if (result.status === 'fulfilled' && result.value) {\n        alert.notificationsSent.push(result.value);\n      } else if (result.status === 'rejected') {\n        logger.error(LogLevel.ERROR, `Failed to send notification to channel: ${channelId}`, {\n          alertId: alert.id,\n          error: result.reason\n        }, LogCategory.SYSTEM);\n      }\n    });\n  }\n\n  /**\n   * Envía notificación a un canal específico\n   */\n  private async sendNotification(alert: Alert, channelId: string): Promise<NotificationLog | null> {\n    const channel = this.notificationChannels.get(channelId);\n    if (!channel || !channel.enabled || !channel.levels.includes(alert.level)) {\n      return null;\n    }\n\n    // Verificar rate limiting\n    if (channel.rateLimit && !(await this.checkRateLimit(channelId, channel.rateLimit))) {\n      logger.warn(LogLevel.WARN, `Rate limit exceeded for channel: ${channelId}`, {\n        alertId: alert.id\n      }, LogCategory.SYSTEM);\n      return null;\n    }\n\n    const startTime = Date.now();\n    let success = false;\n    let error: string | undefined;\n\n    try {\n      switch (channel.type) {\n        case NotificationType.EMAIL:\n          await this.sendEmailNotification(alert, channel);\n          break;\n        case NotificationType.SLACK:\n          await this.sendSlackNotification(alert, channel);\n          break;\n        case NotificationType.WEBHOOK:\n          await this.sendWebhookNotification(alert, channel);\n          break;\n        case NotificationType.SMS:\n          await this.sendSMSNotification(alert, channel);\n          break;\n        case NotificationType.LOG:\n          await this.sendLogNotification(alert, channel);\n          break;\n        default:\n          throw new Error(`Unsupported notification type: ${channel.type}`);\n      }\n      success = true;\n    } catch (err) {\n      error = err instanceof Error ? err.message : 'Unknown error';\n    }\n\n    const notificationLog: NotificationLog = {\n      id: this.generateNotificationId(),\n      channelId,\n      channelType: channel.type,\n      sentAt: new Date().toISOString(),\n      success,\n      error,\n      responseTime: Date.now() - startTime\n    };\n\n    return notificationLog;\n  }\n\n  /**\n   * Monitoreo de escalamiento automático\n   */\n  private async checkEscalations(): Promise<void> {\n    for (const alert of this.activeAlerts.values()) {\n      if (alert.status !== AlertStatus.ACTIVE) {\n        continue;\n      }\n\n      const rule = this.alertRules.get(alert.ruleId);\n      if (!rule) {\n        continue;\n      }\n\n      // Verificar reglas de escalamiento\n      for (const escalationRuleId of rule.escalationRules) {\n        const escalationRule = this.escalationRules.get(escalationRuleId);\n        if (!escalationRule || !escalationRule.enabled) {\n          continue;\n        }\n\n        // Verificar condiciones de escalamiento\n        if (this.shouldEscalate(alert, escalationRule)) {\n          await this.escalateAlert(alert, escalationRule);\n        }\n      }\n    }\n  }\n\n  /**\n   * Verifica si una alerta debe escalarse\n   */\n  private shouldEscalate(alert: Alert, rule: EscalationRule): boolean {\n    // Verificar nivel\n    if (alert.level !== rule.conditions.level) {\n      return false;\n    }\n\n    // Verificar duración\n    const alertAge = Date.now() - new Date(alert.triggeredAt).getTime();\n    const requiredDuration = rule.conditions.duration * 60 * 1000; // convertir a ms\n\n    if (alertAge < requiredDuration) {\n      return false;\n    }\n\n    // Verificar si ya fue escalada\n    if (alert.escalatedAt) {\n      return false;\n    }\n\n    return true;\n  }\n\n  /**\n   * Escala una alerta\n   */\n  private async escalateAlert(alert: Alert, rule: EscalationRule): Promise<void> {\n    const originalLevel = alert.level;\n    \n    // Actualizar nivel si es necesario\n    if (rule.actions.escalateToLevel) {\n      alert.level = rule.actions.escalateToLevel;\n      alert.escalatedFrom = originalLevel;\n    }\n\n    alert.escalatedAt = new Date().toISOString();\n\n    // Enviar notificaciones de escalamiento\n    await this.sendNotifications(alert, rule.actions.notifyChannels);\n\n    // Asignar a usuario si es necesario\n    if (rule.actions.assignToUser) {\n      alert.metadata = {\n        ...alert.metadata,\n        assignedTo: rule.actions.assignToUser\n      };\n    }\n\n    await this.updateAlert(alert);\n\n    logger.error(LogLevel.ERROR, `Alert escalated: ${alert.id}`, {\n      originalLevel,\n      newLevel: alert.level,\n      escalationRule: rule.name,\n      duration: this.calculateDuration(alert.triggeredAt, alert.escalatedAt)\n    }, LogCategory.SYSTEM);\n  }\n\n  /**\n   * Implementaciones de notificación específicas\n   */\n  private async sendEmailNotification(alert: Alert, channel: NotificationChannel): Promise<void> {\n    try {\n      const subject = `[${alert.level.toUpperCase()}] ${alert.ruleName}`;\n      const emailData = {\n        to: channel.config.to || ['admin@example.com'],\n        subject,\n        template: 'alert-notification',\n        data: {\n          alert,\n          level: alert.level.toUpperCase(),\n          timestamp: new Date(alert.triggeredAt).toLocaleString(),\n          message: alert.message,\n          metricName: alert.metricName,\n          value: alert.value,\n          threshold: alert.threshold\n        },\n        priority: alert.level === AlertLevel.CRITICAL || alert.level === AlertLevel.EMERGENCY ? 'high' as const : 'normal' as const\n      };\n\n      await emailService.sendNotification(emailData);\n      \n      logger.info(LogLevel.INFO, `Email notification sent successfully`, {\n        alertId: alert.id,\n        to: channel.config.to,\n        subject\n      }, LogCategory.SYSTEM);\n    } catch (error) {\n      logger.error(LogLevel.ERROR, `Failed to send email notification`, {\n        alertId: alert.id,\n        error: error instanceof Error ? error.message : 'Unknown error'\n      }, LogCategory.SYSTEM);\n      throw error;\n    }\n  }\n\n  private async sendSlackNotification(alert: Alert, channel: NotificationChannel): Promise<void> {\n    try {\n      const alertData = {\n        title: `${alert.level.toUpperCase()}: ${alert.ruleName}`,\n        message: alert.message,\n        severity: alert.level === AlertLevel.CRITICAL || alert.level === AlertLevel.EMERGENCY ? 'error' as const : \n                 alert.level === AlertLevel.WARNING ? 'warning' as const : 'info' as const,\n        details: {\n          'Alert ID': alert.id,\n          'Timestamp': new Date(alert.triggeredAt).toLocaleString(),\n          'Metric': alert.metricName,\n          'Value': alert.value?.toString() || 'N/A',\n          'Threshold': alert.threshold?.toString() || 'N/A',\n          'Status': alert.status,\n          ...alert.tags\n        }\n      };\n\n      await slackService.sendSystemAlert(alertData);\n      \n      logger.info(LogLevel.INFO, `Slack notification sent successfully`, {\n        alertId: alert.id,\n        channel: channel.config.channel,\n        webhook: channel.config.webhookUrl ? 'configured' : 'missing'\n      }, LogCategory.SYSTEM);\n    } catch (error) {\n      logger.error(LogLevel.ERROR, `Failed to send Slack notification`, {\n        alertId: alert.id,\n        error: error instanceof Error ? error.message : 'Unknown error'\n      }, LogCategory.SYSTEM);\n      throw error;\n    }\n  }\n\n  private async sendWebhookNotification(alert: Alert, channel: NotificationChannel): Promise<void> {\n    if (!channel.config.url) {\n      throw new Error('Webhook URL not configured');\n    }\n\n    const response = await fetch(channel.config.url, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        ...(channel.config.headers || {})\n      },\n      body: JSON.stringify({\n        alert,\n        timestamp: new Date().toISOString(),\n        source: 'pinteya-ecommerce'\n      })\n    });\n\n    if (!response.ok) {\n      throw new Error(`Webhook failed: ${response.status} ${response.statusText}`);\n    }\n  }\n\n  private async sendSMSNotification(alert: Alert, channel: NotificationChannel): Promise<void> {\n    // TODO: Implementar envío de SMS\n    logger.info(LogLevel.INFO, `SMS notification sent`, {\n      alertId: alert.id,\n      to: channel.config.phoneNumber\n    }, LogCategory.SYSTEM);\n  }\n\n  private async sendLogNotification(alert: Alert, channel: NotificationChannel): Promise<void> {\n    const logLevel = alert.level === AlertLevel.EMERGENCY || alert.level === AlertLevel.CRITICAL \n      ? LogLevel.ERROR \n      : LogLevel.WARN;\n\n    logger.log(logLevel, `ALERT: ${alert.message}`, {\n      alertId: alert.id,\n      level: alert.level,\n      metricName: alert.metricName,\n      value: alert.value,\n      threshold: alert.threshold,\n      ruleName: alert.ruleName\n    }, LogCategory.SYSTEM);\n  }\n\n  /**\n   * Inicializa canales por defecto\n   */\n  private initializeDefaultChannels(): void {\n    // Canal de log por defecto\n    this.setNotificationChannel({\n      id: 'default_log',\n      type: NotificationType.LOG,\n      name: 'Default Log Channel',\n      config: {},\n      enabled: true,\n      levels: [AlertLevel.INFO, AlertLevel.WARNING, AlertLevel.CRITICAL, AlertLevel.EMERGENCY]\n    });\n\n    // Canal de webhook por defecto (deshabilitado)\n    this.setNotificationChannel({\n      id: 'default_webhook',\n      type: NotificationType.WEBHOOK,\n      name: 'Default Webhook Channel',\n      config: {\n        url: process.env.ALERT_WEBHOOK_URL || ''\n      },\n      enabled: false,\n      levels: [AlertLevel.CRITICAL, AlertLevel.EMERGENCY],\n      rateLimit: {\n        maxPerHour: 10,\n        maxPerDay: 50\n      }\n    });\n  }\n\n  /**\n   * Inicializa reglas por defecto\n   */\n  private initializeDefaultRules(): void {\n    // Regla de escalamiento para alertas críticas\n    this.setEscalationRule({\n      id: 'critical_escalation',\n      name: 'Critical Alert Escalation',\n      enabled: true,\n      conditions: {\n        level: AlertLevel.CRITICAL,\n        duration: 15 // 15 minutos\n      },\n      actions: {\n        escalateToLevel: AlertLevel.EMERGENCY,\n        notifyChannels: ['default_log', 'default_webhook']\n      }\n    });\n  }\n\n  /**\n   * Inicia monitoreo de escalamiento\n   */\n  private startEscalationMonitoring(): void {\n    this.escalationInterval = setInterval(() => {\n      this.checkEscalations();\n    }, 60000); // Verificar cada minuto\n  }\n\n  /**\n   * Funciones auxiliares\n   */\n  private generateAlertId(): string {\n    return `alert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  }\n\n  private generateNotificationId(): string {\n    return `notif_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  }\n\n  private calculateDuration(start: string, end: string): number {\n    return Math.round((new Date(end).getTime() - new Date(start).getTime()) / 1000 / 60); // minutos\n  }\n\n  private async checkRateLimit(channelId: string, rateLimit: { maxPerHour: number; maxPerDay: number }): Promise<boolean> {\n    // TODO: Implementar verificación de rate limiting con Redis\n    return true;\n  }\n\n  private async storeAlert(alert: Alert): Promise<void> {\n    try {\n      const supabase = getSupabaseClient(true);\n      if (!supabase) return;\n\n      await supabase.from('enterprise_alerts').insert({\n        id: alert.id,\n        rule_id: alert.ruleId,\n        rule_name: alert.ruleName,\n        level: alert.level,\n        status: alert.status,\n        message: alert.message,\n        metric_name: alert.metricName,\n        value: alert.value,\n        threshold: alert.threshold,\n        triggered_at: alert.triggeredAt,\n        acknowledged_at: alert.acknowledgedAt,\n        acknowledged_by: alert.acknowledgedBy,\n        resolved_at: alert.resolvedAt,\n        resolved_by: alert.resolvedBy,\n        escalated_at: alert.escalatedAt,\n        escalated_from: alert.escalatedFrom,\n        notifications_sent: alert.notificationsSent,\n        tags: alert.tags,\n        metadata: alert.metadata\n      });\n    } catch (error) {\n      logger.error(LogLevel.ERROR, 'Failed to store alert', {\n        error: error instanceof Error ? error.message : 'Unknown error',\n        alertId: alert.id\n      }, LogCategory.SYSTEM);\n    }\n  }\n\n  private async updateAlert(alert: Alert): Promise<void> {\n    try {\n      const supabase = getSupabaseClient(true);\n      if (!supabase) return;\n\n      await supabase\n        .from('enterprise_alerts')\n        .update({\n          level: alert.level,\n          status: alert.status,\n          acknowledged_at: alert.acknowledgedAt,\n          acknowledged_by: alert.acknowledgedBy,\n          resolved_at: alert.resolvedAt,\n          resolved_by: alert.resolvedBy,\n          escalated_at: alert.escalatedAt,\n          escalated_from: alert.escalatedFrom,\n          notifications_sent: alert.notificationsSent,\n          metadata: alert.metadata\n        })\n        .eq('id', alert.id);\n    } catch (error) {\n      logger.error(LogLevel.ERROR, 'Failed to update alert', {\n        error: error instanceof Error ? error.message : 'Unknown error',\n        alertId: alert.id\n      }, LogCategory.SYSTEM);\n    }\n  }\n\n  /**\n   * Limpia recursos\n   */\n  destroy(): void {\n    if (this.escalationInterval) {\n      clearInterval(this.escalationInterval);\n      this.escalationInterval = null;\n    }\n  }\n}\n\n// Instancia singleton\nexport const enterpriseAlertSystem = EnterpriseAlertSystem.getInstance();\n\n// Funciones de conveniencia\nexport const triggerAlert = enterpriseAlertSystem.triggerAlert.bind(enterpriseAlertSystem);\nexport const acknowledgeAlert = enterpriseAlertSystem.acknowledgeAlert.bind(enterpriseAlertSystem);\nexport const resolveAlert = enterpriseAlertSystem.resolveAlert.bind(enterpriseAlertSystem);\n"],"names":["AlertLevel","AlertStatus","EnterpriseAlertSystem","NotificationType","acknowledgeAlert","enterpriseAlertSystem","resolveAlert","triggerAlert","CacheUtils","window","require","error","console","warn","alertRules","Map","notificationChannels","escalationRules","activeAlerts","escalationInterval","initializeDefaultChannels","initializeDefaultRules","startEscalationMonitoring","getInstance","instance","setNotificationChannel","channel","set","id","logger","info","LogLevel","INFO","type","enabled","levels","LogCategory","SYSTEM","setEscalationRule","rule","level","conditions","duration","setAlertRule","metricName","threshold","ruleId","value","message","get","existingAlert","Array","from","values","find","alert","status","cooldownEnd","Date","triggeredAt","setMinutes","getMinutes","cooldownMinutes","generateAlertId","ruleName","name","description","toISOString","notificationsSent","tags","metadata","sendNotifications","channels","storeAlert","WARN","alertId","userId","acknowledgedAt","acknowledgedBy","updateAlert","resolvedAt","resolvedBy","delete","calculateDuration","channelIds","notifications","Promise","allSettled","map","channelId","sendNotification","forEach","result","index","push","ERROR","reason","includes","rateLimit","checkRateLimit","startTime","now","success","sendEmailNotification","sendSlackNotification","sendWebhookNotification","sendSMSNotification","sendLogNotification","Error","err","notificationLog","generateNotificationId","channelType","sentAt","responseTime","checkEscalations","escalationRuleId","escalationRule","shouldEscalate","escalateAlert","alertAge","getTime","requiredDuration","escalatedAt","originalLevel","actions","escalateToLevel","escalatedFrom","notifyChannels","assignToUser","assignedTo","newLevel","subject","toUpperCase","emailData","to","config","template","data","timestamp","toLocaleString","priority","emailService","alertData","title","severity","details","toString","slackService","sendSystemAlert","webhook","webhookUrl","url","response","fetch","method","headers","body","JSON","stringify","source","ok","statusText","phoneNumber","logLevel","log","process","env","ALERT_WEBHOOK_URL","maxPerHour","maxPerDay","setInterval","Math","random","substr","start","end","round","supabase","getSupabaseClient","insert","rule_id","rule_name","metric_name","triggered_at","acknowledged_at","acknowledged_by","resolved_at","resolved_by","escalated_at","escalated_from","notifications_sent","update","eq","destroy","clearInterval","bind"],"mappings":"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"}