{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\__tests__\\auth-migration.test.ts"],"sourcesContent":["/**\n * Tests para la migración de autenticación de headers a auth(req)\n * Verifica que el sistema migrado funciona correctamente\n */\n\n// NextAuth se mockea automáticamente\njest.mock('@/auth', () => ({ auth: jest.fn() }));\n\n// Mock de Supabase\njest.mock('@/lib/supabase', () => ({\n  supabaseAdmin: {\n    from: jest.fn(() => ({\n      select: jest.fn(() => ({\n        eq: jest.fn(() => ({\n          single: jest.fn()\n        }))\n      }))\n    }))\n  }\n}));\n\nimport {\n  authenticatedUser,\n  authenticatedAdmin,\n  authFromHeaders\n} from '@/lib/auth/admin-auth';\nimport { auth } from '@/auth';\n\ndescribe('Migración de Autenticación', () => {\n  let mockAuth: jest.MockedFunction<typeof auth>;\n\n  beforeEach(() => {\n    mockAuth = auth as jest.MockedFunction<typeof auth>;\n    mockAuth = auth as jest.MockedFunction<typeof auth>;\n    jest.clearAllMocks();\n  });\n\n  describe('authenticatedUser (migrado)', () => {\n    it('debe usar auth para NextApiRequest', async () => {\n      const mockRequest = {\n        query: {},\n        headers: {}\n      } as any;\n\n      mockAuth.mockReturnValue({\n        userId: 'user_123',\n        sessionId: 'sess_123',\n        getToken: jest.fn().mockResolvedValue('mock_token')\n      });\n\n      const result = await authenticatedUser(mockRequest);\n\n      expect(mockAuth).toHaveBeenCalledWith(mockRequest);\n      expect(result.userId).toBe('user_123');\n      expect(result.sessionId).toBe('sess_123');\n    });\n\n    it('debe usar auth() para App Router', async () => {\n      mockAuth.mockResolvedValue({\n        userId: 'user_456',\n        sessionId: 'sess_456',\n        sessionClaims: {\n          metadata: { role: 'admin' }\n        }\n      });\n\n      const result = await authenticatedUser();\n\n      expect(mockAuth).toHaveBeenCalled();\n      expect(result.userId).toBe('user_456');\n      expect(result.sessionId).toBe('sess_456');\n      expect(result.isAdmin).toBe(true);\n    });\n\n    it('debe manejar usuarios no autenticados', async () => {\n      mockAuth.mockResolvedValue({\n        userId: null,\n        sessionId: null\n      });\n\n      const result = await authenticatedUser();\n\n      expect(result.userId).toBeNull();\n      expect(result.error).toBe('Usuario no autenticado');\n    });\n\n    it('debe manejar errores de autenticación', async () => {\n      mockAuth.mockRejectedValue(new Error('Auth error'));\n\n      const result = await authenticatedUser();\n\n      expect(result.userId).toBeNull();\n      expect(result.error).toContain('Error de autenticación');\n    });\n  });\n\n  describe('authenticatedAdmin (nueva función)', () => {\n    it('debe combinar autenticación y verificación de admin', async () => {\n      mockAuth.mockResolvedValue({\n        userId: 'admin_123',\n        sessionId: 'sess_123',\n        sessionClaims: {\n          metadata: { role: 'admin' }\n        }\n      });\n\n      const result = await authenticatedAdmin();\n\n      expect(result.userId).toBe('admin_123');\n      expect(result.isAdmin).toBe(true);\n      expect(result.sessionId).toBe('sess_123');\n    });\n\n    it('debe rechazar usuarios no admin', async () => {\n      mockAuth.mockResolvedValue({\n        userId: 'user_123',\n        sessionId: 'sess_123',\n        sessionClaims: {\n          metadata: { role: 'user' }\n        }\n      });\n\n      const result = await authenticatedAdmin();\n\n      expect(result.userId).toBe('user_123');\n      expect(result.isAdmin).toBe(false);\n      expect(result.error).toBe('Permisos de administrador requeridos');\n      expect(result.status).toBe(403);\n    });\n\n    it('debe manejar usuarios no autenticados', async () => {\n      mockAuth.mockResolvedValue({\n        userId: null,\n        sessionId: null\n      });\n\n      const result = await authenticatedAdmin();\n\n      expect(result.userId).toBeNull();\n      expect(result.isAdmin).toBe(false);\n      expect(result.error).toBe('Usuario no autenticado');\n      expect(result.status).toBe(401);\n    });\n  });\n\n  describe('authFromHeaders (deprecada)', () => {\n    it('debe marcar como deprecada y funcionar', async () => {\n      const mockRequest = {\n        headers: {\n          get: jest.fn().mockReturnValue('user_123')\n        }\n      } as any;\n\n      const result = await authFromHeaders(mockRequest);\n\n      expect(result.userId).toBe('user_123');\n      expect(result.deprecated).toBe(true);\n    });\n\n    it('debe manejar headers faltantes', async () => {\n      const mockRequest = {\n        headers: {\n          get: jest.fn().mockReturnValue(null)\n        }\n      } as any;\n\n      const result = await authFromHeaders(mockRequest);\n\n      expect(result.userId).toBeNull();\n      expect(result.deprecated).toBe(true);\n      expect(result.error).toBe('Header x-clerk-user-id no encontrado');\n    });\n  });\n\n  describe('Migración completa', () => {\n    it('debe tener todas las funciones definidas', () => {\n      expect(typeof authenticatedUser).toBe('function');\n      expect(typeof authenticatedAdmin).toBe('function');\n      expect(typeof authFromHeaders).toBe('function');\n    });\n\n    it('debe retornar estructuras correctas', async () => {\n      mockAuth.mockResolvedValue({\n        userId: 'user_123',\n        sessionId: 'sess_123',\n        sessionClaims: {\n          metadata: { role: 'admin' }\n        }\n      });\n\n      const userResult = await authenticatedUser();\n      const adminResult = await authenticatedAdmin();\n\n      // Verificar estructura de authenticatedUser\n      expect(userResult).toHaveProperty('userId');\n      expect(userResult).toHaveProperty('sessionId');\n      expect(userResult).toHaveProperty('isAdmin');\n\n      // Verificar estructura de authenticatedAdmin\n      expect(adminResult).toHaveProperty('userId');\n      expect(adminResult).toHaveProperty('sessionId');\n      expect(adminResult).toHaveProperty('isAdmin');\n      // status solo está presente en casos de error\n    });\n\n    it('debe manejar diferentes tipos de request', async () => {\n      // Test con NextApiRequest\n      const apiRequest = { query: {}, headers: {} } as any;\n      mockAuth.mockReturnValue({\n        userId: 'user_api',\n        sessionId: 'sess_api',\n        getToken: jest.fn()\n      });\n\n      const apiResult = await authenticatedUser(apiRequest);\n      expect(mockAuth).toHaveBeenCalledWith(apiRequest);\n      expect(apiResult.userId).toBe('user_api');\n\n      // Test sin request (App Router)\n      mockAuth.mockResolvedValue({\n        userId: 'user_app',\n        sessionId: 'sess_app'\n      });\n\n      const appResult = await authenticatedUser();\n      expect(mockAuth).toHaveBeenCalled();\n      expect(appResult.userId).toBe('user_app');\n    });\n  });\n\n  describe('Compatibilidad y migración', () => {\n    it('debe mantener compatibilidad con APIs existentes', async () => {\n      // Test que verifica que las APIs migradas siguen funcionando\n      mockAuth.mockResolvedValue({\n        userId: 'user_123',\n        sessionId: 'sess_123'\n      });\n\n      const result = await authenticatedUser();\n      \n      // Debe retornar la misma estructura que antes\n      expect(result).toHaveProperty('userId');\n      expect(result).toHaveProperty('sessionId');\n      expect(typeof result.userId).toBe('string');\n    });\n\n    it('debe proporcionar información de migración', async () => {\n      const mockRequest = {\n        headers: {\n          get: jest.fn().mockReturnValue('user_123')\n        }\n      } as any;\n\n      const deprecatedResult = await authFromHeaders(mockRequest);\n      \n      expect(deprecatedResult.deprecated).toBe(true);\n      expect(deprecatedResult.userId).toBe('user_123');\n    });\n  });\n});\n"],"names":["jest","mock","auth","fn","supabaseAdmin","from","select","eq","single","describe","mockAuth","beforeEach","clearAllMocks","it","mockRequest","query","headers","mockReturnValue","userId","sessionId","getToken","mockResolvedValue","result","authenticatedUser","expect","toHaveBeenCalledWith","toBe","sessionClaims","metadata","role","toHaveBeenCalled","isAdmin","toBeNull","error","mockRejectedValue","Error","toContain","authenticatedAdmin","status","get","authFromHeaders","deprecated","userResult","adminResult","toHaveProperty","apiRequest","apiResult","appResult","deprecatedResult"],"mappings":"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"}