{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\lib\\auth\\security-audit-enhanced.ts"],"sourcesContent":["/**\n * Sistema de Auditoría de Seguridad Mejorado\n * Extiende el sistema base con análisis avanzado, alertas automáticas y reportes\n */\n\nimport { supabaseAdmin } from '@/lib/supabase';\nimport { \n  logSecurityEvent, \n  type SecurityEvent, \n  type SecuritySeverity,\n  type SecurityEventType,\n  type SecurityEventCategory \n} from './security-audit';\nimport { CacheManager, CACHE_CONFIGS } from '@/lib/cache-manager';\n\n// =====================================================\n// TIPOS Y INTERFACES EXTENDIDAS\n// =====================================================\n\nexport interface SecurityPattern {\n  id: string;\n  name: string;\n  description: string;\n  severity: SecuritySeverity;\n  conditions: PatternCondition[];\n  timeWindow: number; // en minutos\n  threshold: number;\n  enabled: boolean;\n  actions: SecurityAction[];\n}\n\nexport interface PatternCondition {\n  field: string;\n  operator: 'equals' | 'contains' | 'greater_than' | 'less_than' | 'in' | 'not_in';\n  value: any;\n  weight: number; // peso en el cálculo del patrón\n}\n\nexport interface SecurityAction {\n  type: 'log' | 'alert' | 'block_user' | 'notify_admin' | 'invalidate_sessions';\n  parameters?: Record<string, any>;\n}\n\nexport interface SecurityReport {\n  id: string;\n  period_start: string;\n  period_end: string;\n  total_events: number;\n  events_by_severity: Record<SecuritySeverity, number>;\n  events_by_category: Record<SecurityEventCategory, number>;\n  top_users: Array<{ user_id: string; event_count: number }>;\n  top_ips: Array<{ ip_address: string; event_count: number }>;\n  patterns_detected: Array<{ pattern_id: string; occurrences: number }>;\n  recommendations: string[];\n  generated_at: string;\n}\n\nexport interface SecurityMetrics {\n  total_events_24h: number;\n  critical_events_24h: number;\n  unique_users_24h: number;\n  auth_failures_24h: number;\n  suspicious_activities_24h: number;\n  blocked_users: number;\n  active_alerts: number;\n  avg_response_time: number;\n  security_score: number; // 0-100\n}\n\nexport interface SecurityAlert {\n  id: string;\n  pattern_id: string;\n  user_id: string;\n  severity: SecuritySeverity;\n  title: string;\n  description: string;\n  event_count: number;\n  first_occurrence: string;\n  last_occurrence: string;\n  status: 'open' | 'investigating' | 'resolved' | 'false_positive';\n  assigned_to?: string;\n  resolution_notes?: string;\n  metadata: Record<string, any>;\n}\n\n// =====================================================\n// PATRONES DE SEGURIDAD PREDEFINIDOS\n// =====================================================\n\nexport const DEFAULT_SECURITY_PATTERNS: SecurityPattern[] = [\n  {\n    id: 'brute_force_login',\n    name: 'Ataque de Fuerza Bruta',\n    description: 'Múltiples intentos de login fallidos desde la misma IP',\n    severity: 'high',\n    timeWindow: 15,\n    threshold: 5,\n    enabled: true,\n    conditions: [\n      { field: 'event_type', operator: 'equals', value: 'AUTH_FAILURE', weight: 1 },\n      { field: 'ip_address', operator: 'equals', value: 'same', weight: 1 }\n    ],\n    actions: [\n      { type: 'alert', parameters: { notify_admins: true } },\n      { type: 'log', parameters: { severity: 'high' } }\n    ]\n  },\n  {\n    id: 'privilege_escalation',\n    name: 'Escalación de Privilegios',\n    description: 'Intento de acceso a recursos sin permisos suficientes',\n    severity: 'critical',\n    timeWindow: 60,\n    threshold: 3,\n    enabled: true,\n    conditions: [\n      { field: 'event_type', operator: 'equals', value: 'PERMISSION_DENIED', weight: 1 },\n      { field: 'event_category', operator: 'equals', value: 'authorization', weight: 1 }\n    ],\n    actions: [\n      { type: 'alert', parameters: { notify_admins: true, priority: 'high' } },\n      { type: 'log', parameters: { severity: 'critical' } }\n    ]\n  },\n  {\n    id: 'suspicious_data_access',\n    name: 'Acceso Sospechoso a Datos',\n    description: 'Acceso masivo a datos sensibles en corto período',\n    severity: 'medium',\n    timeWindow: 30,\n    threshold: 10,\n    enabled: true,\n    conditions: [\n      { field: 'event_type', operator: 'equals', value: 'DATA_ACCESS', weight: 1 },\n      { field: 'event_category', operator: 'equals', value: 'data_access', weight: 1 }\n    ],\n    actions: [\n      { type: 'alert', parameters: { notify_admins: false } },\n      { type: 'log', parameters: { severity: 'medium' } }\n    ]\n  },\n  {\n    id: 'admin_action_burst',\n    name: 'Ráfaga de Acciones Administrativas',\n    description: 'Múltiples acciones administrativas en corto período',\n    severity: 'medium',\n    timeWindow: 10,\n    threshold: 5,\n    enabled: true,\n    conditions: [\n      { field: 'event_type', operator: 'equals', value: 'ADMIN_ACTION', weight: 1 },\n      { field: 'event_category', operator: 'equals', value: 'admin_operations', weight: 1 }\n    ],\n    actions: [\n      { type: 'alert', parameters: { notify_admins: true } },\n      { type: 'log', parameters: { severity: 'medium' } }\n    ]\n  },\n  {\n    id: 'geographic_anomaly',\n    name: 'Anomalía Geográfica',\n    description: 'Acceso desde ubicaciones geográficas inusuales',\n    severity: 'medium',\n    timeWindow: 60,\n    threshold: 2,\n    enabled: true,\n    conditions: [\n      { field: 'event_type', operator: 'equals', value: 'AUTH_SUCCESS', weight: 1 },\n      { field: 'ip_address', operator: 'not_in', value: 'usual_locations', weight: 1 }\n    ],\n    actions: [\n      { type: 'alert', parameters: { notify_user: true } },\n      { type: 'log', parameters: { severity: 'medium' } }\n    ]\n  }\n];\n\n// =====================================================\n// FUNCIONES DE ANÁLISIS AVANZADO\n// =====================================================\n\n/**\n * Analiza eventos de seguridad para detectar patrones\n */\nexport async function analyzeSecurityPatterns(\n  userId?: string,\n  timeWindowHours: number = 24\n): Promise<SecurityAlert[]> {\n  try {\n    console.log('[SECURITY] Iniciando análisis de patrones de seguridad');\n\n    if (!supabaseAdmin) {\n      throw new Error('Supabase admin client no disponible');\n    }\n\n    const timeThreshold = new Date(Date.now() - timeWindowHours * 60 * 60 * 1000).toISOString();\n    const alerts: SecurityAlert[] = [];\n\n    // Obtener eventos recientes\n    let query = supabaseAdmin\n      .from('security_events')\n      .select('*')\n      .gte('timestamp', timeThreshold)\n      .order('timestamp', { ascending: false });\n\n    if (userId) {\n      query = query.eq('user_id', userId);\n    }\n\n    const { data: events, error } = await query;\n\n    if (error) {\n      throw new Error(`Error obteniendo eventos: ${error.message}`);\n    }\n\n    if (!events || events.length === 0) {\n      return alerts;\n    }\n\n    // Analizar cada patrón\n    for (const pattern of DEFAULT_SECURITY_PATTERNS) {\n      if (!pattern.enabled) continue;\n\n      const patternAlerts = await detectPattern(pattern, events);\n      alerts.push(...patternAlerts);\n    }\n\n    // Guardar alertas en base de datos\n    if (alerts.length > 0) {\n      const { error: insertError } = await supabaseAdmin\n        .from('security_alerts')\n        .insert(alerts);\n\n      if (insertError) {\n        console.error('[SECURITY] Error guardando alertas:', insertError);\n      }\n    }\n\n    console.log(`[SECURITY] Análisis completado: ${alerts.length} alertas generadas`);\n    return alerts;\n  } catch (error) {\n    console.error('[SECURITY] Error en análisis de patrones:', error);\n    return [];\n  }\n}\n\n/**\n * Detecta un patrón específico en los eventos\n */\nasync function detectPattern(\n  pattern: SecurityPattern,\n  events: SecurityEvent[]\n): Promise<SecurityAlert[]> {\n  const alerts: SecurityAlert[] = [];\n  const timeWindow = pattern.timeWindow * 60 * 1000; // convertir a ms\n\n  // Agrupar eventos por usuario\n  const eventsByUser = events.reduce((acc, event) => {\n    if (!acc[event.user_id]) {\n      acc[event.user_id] = [];\n    }\n    acc[event.user_id].push(event);\n    return acc;\n  }, {} as Record<string, SecurityEvent[]>);\n\n  // Analizar cada usuario\n  for (const [userId, userEvents] of Object.entries(eventsByUser)) {\n    const matchingEvents = userEvents.filter(event => \n      matchesPatternConditions(event, pattern.conditions)\n    );\n\n    if (matchingEvents.length < pattern.threshold) continue;\n\n    // Verificar ventana de tiempo\n    const sortedEvents = matchingEvents.sort((a, b) => \n      new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime()\n    );\n\n    for (let i = 0; i <= sortedEvents.length - pattern.threshold; i++) {\n      const windowStart = new Date(sortedEvents[i].timestamp).getTime();\n      const windowEnd = windowStart + timeWindow;\n      \n      const eventsInWindow = sortedEvents.filter(event => {\n        const eventTime = new Date(event.timestamp).getTime();\n        return eventTime >= windowStart && eventTime <= windowEnd;\n      });\n\n      if (eventsInWindow.length >= pattern.threshold) {\n        // Patrón detectado\n        const alert: SecurityAlert = {\n          id: `${pattern.id}_${userId}_${Date.now()}`,\n          pattern_id: pattern.id,\n          user_id: userId,\n          severity: pattern.severity,\n          title: pattern.name,\n          description: `${pattern.description} - ${eventsInWindow.length} eventos detectados`,\n          event_count: eventsInWindow.length,\n          first_occurrence: eventsInWindow[0].timestamp,\n          last_occurrence: eventsInWindow[eventsInWindow.length - 1].timestamp,\n          status: 'open',\n          metadata: {\n            pattern_name: pattern.name,\n            events: eventsInWindow.map(e => e.id),\n            threshold: pattern.threshold,\n            time_window_minutes: pattern.timeWindow\n          }\n        };\n\n        alerts.push(alert);\n\n        // Ejecutar acciones del patrón\n        await executePatternActions(pattern.actions, alert, eventsInWindow);\n        break; // Solo una alerta por patrón por usuario\n      }\n    }\n  }\n\n  return alerts;\n}\n\n/**\n * Verifica si un evento coincide con las condiciones del patrón\n */\nfunction matchesPatternConditions(\n  event: SecurityEvent,\n  conditions: PatternCondition[]\n): boolean {\n  return conditions.every(condition => {\n    const eventValue = (event as any)[condition.field];\n    \n    switch (condition.operator) {\n      case 'equals':\n        return eventValue === condition.value;\n      case 'contains':\n        return typeof eventValue === 'string' && eventValue.includes(condition.value);\n      case 'greater_than':\n        return Number(eventValue) > Number(condition.value);\n      case 'less_than':\n        return Number(eventValue) < Number(condition.value);\n      case 'in':\n        return Array.isArray(condition.value) && condition.value.includes(eventValue);\n      case 'not_in':\n        return Array.isArray(condition.value) && !condition.value.includes(eventValue);\n      default:\n        return false;\n    }\n  });\n}\n\n/**\n * Ejecuta las acciones definidas para un patrón\n */\nasync function executePatternActions(\n  actions: SecurityAction[],\n  alert: SecurityAlert,\n  events: SecurityEvent[]\n): Promise<void> {\n  for (const action of actions) {\n    try {\n      switch (action.type) {\n        case 'log':\n          await logSecurityEvent({\n            user_id: alert.user_id,\n            event_type: 'SUSPICIOUS_ACTIVITY',\n            event_category: 'suspicious_behavior',\n            severity: action.parameters?.severity || alert.severity,\n            description: `Patrón detectado: ${alert.title}`,\n            metadata: {\n              pattern_id: alert.pattern_id,\n              alert_id: alert.id,\n              event_count: alert.event_count,\n              ...action.parameters\n            }\n          });\n          break;\n\n        case 'alert':\n          console.warn(`[SECURITY ALERT] ${alert.title} - Usuario: ${alert.user_id}`);\n          if (action.parameters?.notify_admins) {\n            // Aquí se podría integrar con un sistema de notificaciones\n            console.log('[SECURITY] Notificando a administradores...');\n          }\n          break;\n\n        case 'block_user':\n          console.log(`[SECURITY] Bloqueando usuario: ${alert.user_id}`);\n          // Implementar lógica de bloqueo\n          break;\n\n        case 'invalidate_sessions':\n          console.log(`[SECURITY] Invalidando sesiones del usuario: ${alert.user_id}`);\n          // Integrar con sistema de gestión de sesiones\n          break;\n\n        default:\n          console.warn(`[SECURITY] Acción no reconocida: ${action.type}`);\n      }\n    } catch (error) {\n      console.error(`[SECURITY] Error ejecutando acción ${action.type}:`, error);\n    }\n  }\n}\n\n// =====================================================\n// FUNCIONES DE MÉTRICAS Y REPORTES\n// =====================================================\n\n/**\n * Obtiene métricas de seguridad en tiempo real\n */\nexport async function getSecurityMetrics(): Promise<SecurityMetrics> {\n  try {\n    if (!supabaseAdmin) {\n      throw new Error('Supabase admin client no disponible');\n    }\n\n    const cache = CacheManager.getInstance();\n    const cacheKey = 'security_metrics';\n\n    // Intentar obtener desde cache\n    const cached = await cache.get(CACHE_CONFIGS.USER_SESSION, cacheKey);\n    if (cached) {\n      return cached as SecurityMetrics;\n    }\n\n    const now = new Date();\n    const last24h = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString();\n\n    // Obtener eventos de las últimas 24 horas\n    const { data: events, error } = await supabaseAdmin\n      .from('security_events')\n      .select('*')\n      .gte('timestamp', last24h);\n\n    if (error) {\n      throw new Error(`Error obteniendo eventos: ${error.message}`);\n    }\n\n    // Obtener alertas activas\n    const { data: alerts, error: alertsError } = await supabaseAdmin\n      .from('security_alerts')\n      .select('id')\n      .eq('status', 'open');\n\n    if (alertsError) {\n      console.error('[SECURITY] Error obteniendo alertas:', alertsError);\n    }\n\n    // Calcular métricas\n    const totalEvents = events?.length || 0;\n    const criticalEvents = events?.filter(e => e.severity === 'critical').length || 0;\n    const uniqueUsers = new Set(events?.map(e => e.user_id)).size;\n    const authFailures = events?.filter(e => e.event_type === 'AUTH_FAILURE').length || 0;\n    const suspiciousActivities = events?.filter(e => e.event_type === 'SUSPICIOUS_ACTIVITY').length || 0;\n    const activeAlerts = alerts?.length || 0;\n\n    // Calcular score de seguridad (0-100)\n    let securityScore = 100;\n    if (criticalEvents > 0) securityScore -= criticalEvents * 10;\n    if (authFailures > 10) securityScore -= (authFailures - 10) * 2;\n    if (suspiciousActivities > 5) securityScore -= (suspiciousActivities - 5) * 5;\n    if (activeAlerts > 0) securityScore -= activeAlerts * 3;\n    securityScore = Math.max(0, Math.min(100, securityScore));\n\n    const metrics: SecurityMetrics = {\n      total_events_24h: totalEvents,\n      critical_events_24h: criticalEvents,\n      unique_users_24h: uniqueUsers,\n      auth_failures_24h: authFailures,\n      suspicious_activities_24h: suspiciousActivities,\n      blocked_users: 0, // TODO: implementar cuando se tenga sistema de bloqueo\n      active_alerts: activeAlerts,\n      avg_response_time: 0, // TODO: calcular tiempo promedio de respuesta\n      security_score: securityScore\n    };\n\n    // Guardar en cache por 5 minutos\n    await cache.set(CACHE_CONFIGS.USER_SESSION, cacheKey, metrics);\n\n    return metrics;\n  } catch (error) {\n    console.error('[SECURITY] Error obteniendo métricas:', error);\n    return {\n      total_events_24h: 0,\n      critical_events_24h: 0,\n      unique_users_24h: 0,\n      auth_failures_24h: 0,\n      suspicious_activities_24h: 0,\n      blocked_users: 0,\n      active_alerts: 0,\n      avg_response_time: 0,\n      security_score: 0\n    };\n  }\n}\n\n/**\n * Genera un reporte de seguridad para un período específico\n */\nexport async function generateSecurityReport(\n  startDate: Date,\n  endDate: Date\n): Promise<SecurityReport> {\n  try {\n    if (!supabaseAdmin) {\n      throw new Error('Supabase admin client no disponible');\n    }\n\n    console.log(`[SECURITY] Generando reporte de seguridad: ${startDate.toISOString()} - ${endDate.toISOString()}`);\n\n    // Obtener eventos del período\n    const { data: events, error } = await supabaseAdmin\n      .from('security_events')\n      .select('*')\n      .gte('timestamp', startDate.toISOString())\n      .lte('timestamp', endDate.toISOString())\n      .order('timestamp', { ascending: false });\n\n    if (error) {\n      throw new Error(`Error obteniendo eventos: ${error.message}`);\n    }\n\n    const totalEvents = events?.length || 0;\n\n    // Agrupar por severidad\n    const eventsBySeverity: Record<SecuritySeverity, number> = {\n      low: 0,\n      medium: 0,\n      high: 0,\n      critical: 0\n    };\n\n    // Agrupar por categoría\n    const eventsByCategory: Record<SecurityEventCategory, number> = {\n      authentication: 0,\n      authorization: 0,\n      data_access: 0,\n      admin_operations: 0,\n      suspicious_behavior: 0\n    };\n\n    // Contadores de usuarios e IPs\n    const userCounts: Record<string, number> = {};\n    const ipCounts: Record<string, number> = {};\n\n    events?.forEach(event => {\n      // Contar por severidad\n      eventsBySeverity[event.severity]++;\n\n      // Contar por categoría\n      eventsByCategory[event.event_category]++;\n\n      // Contar por usuario\n      userCounts[event.user_id] = (userCounts[event.user_id] || 0) + 1;\n\n      // Contar por IP\n      if (event.ip_address) {\n        ipCounts[event.ip_address] = (ipCounts[event.ip_address] || 0) + 1;\n      }\n    });\n\n    // Top usuarios (más eventos)\n    const topUsers = Object.entries(userCounts)\n      .sort(([, a], [, b]) => b - a)\n      .slice(0, 10)\n      .map(([user_id, event_count]) => ({ user_id, event_count }));\n\n    // Top IPs (más eventos)\n    const topIps = Object.entries(ipCounts)\n      .sort(([, a], [, b]) => b - a)\n      .slice(0, 10)\n      .map(([ip_address, event_count]) => ({ ip_address, event_count }));\n\n    // Obtener patrones detectados\n    const { data: alerts, error: alertsError } = await supabaseAdmin\n      .from('security_alerts')\n      .select('pattern_id')\n      .gte('first_occurrence', startDate.toISOString())\n      .lte('last_occurrence', endDate.toISOString());\n\n    const patternsDetected: Array<{ pattern_id: string; occurrences: number }> = [];\n    if (!alertsError && alerts) {\n      const patternCounts: Record<string, number> = {};\n      alerts.forEach(alert => {\n        patternCounts[alert.pattern_id] = (patternCounts[alert.pattern_id] || 0) + 1;\n      });\n\n      Object.entries(patternCounts).forEach(([pattern_id, occurrences]) => {\n        patternsDetected.push({ pattern_id, occurrences });\n      });\n    }\n\n    // Generar recomendaciones\n    const recommendations = generateSecurityRecommendations(\n      eventsBySeverity,\n      eventsByCategory,\n      patternsDetected\n    );\n\n    const report: SecurityReport = {\n      id: `report_${Date.now()}`,\n      period_start: startDate.toISOString(),\n      period_end: endDate.toISOString(),\n      total_events: totalEvents,\n      events_by_severity: eventsBySeverity,\n      events_by_category: eventsByCategory,\n      top_users: topUsers,\n      top_ips: topIps,\n      patterns_detected: patternsDetected,\n      recommendations,\n      generated_at: new Date().toISOString()\n    };\n\n    // Guardar reporte en base de datos\n    const { error: insertError } = await supabaseAdmin\n      .from('security_reports')\n      .insert(report);\n\n    if (insertError) {\n      console.error('[SECURITY] Error guardando reporte:', insertError);\n    }\n\n    console.log(`[SECURITY] Reporte generado: ${totalEvents} eventos analizados`);\n    return report;\n  } catch (error) {\n    console.error('[SECURITY] Error generando reporte:', error);\n    throw error;\n  }\n}\n\n/**\n * Genera recomendaciones de seguridad basadas en los datos del reporte\n */\nfunction generateSecurityRecommendations(\n  eventsBySeverity: Record<SecuritySeverity, number>,\n  eventsByCategory: Record<SecurityEventCategory, number>,\n  patternsDetected: Array<{ pattern_id: string; occurrences: number }>\n): string[] {\n  const recommendations: string[] = [];\n\n  // Recomendaciones basadas en severidad\n  if (eventsBySeverity.critical > 0) {\n    recommendations.push(`Se detectaron ${eventsBySeverity.critical} eventos críticos. Revisar inmediatamente.`);\n  }\n\n  if (eventsBySeverity.high > 10) {\n    recommendations.push(`Alto número de eventos de severidad alta (${eventsBySeverity.high}). Considerar reforzar medidas de seguridad.`);\n  }\n\n  // Recomendaciones basadas en categorías\n  if (eventsByCategory.authentication > 50) {\n    recommendations.push(`Muchos eventos de autenticación (${eventsByCategory.authentication}). Considerar implementar MFA.`);\n  }\n\n  if (eventsByCategory.authorization > 20) {\n    recommendations.push(`Eventos de autorización elevados (${eventsByCategory.authorization}). Revisar permisos de usuarios.`);\n  }\n\n  if (eventsByCategory.suspicious_behavior > 5) {\n    recommendations.push(`Actividad sospechosa detectada (${eventsByCategory.suspicious_behavior} eventos). Monitorear de cerca.`);\n  }\n\n  // Recomendaciones basadas en patrones\n  const highFrequencyPatterns = patternsDetected.filter(p => p.occurrences > 3);\n  if (highFrequencyPatterns.length > 0) {\n    recommendations.push(`Patrones de seguridad recurrentes detectados. Considerar medidas preventivas adicionales.`);\n  }\n\n  // Recomendaciones generales\n  if (recommendations.length === 0) {\n    recommendations.push('No se detectaron problemas críticos de seguridad. Mantener monitoreo regular.');\n  }\n\n  return recommendations;\n}\n\n// =====================================================\n// FUNCIONES DE GESTIÓN DE ALERTAS\n// =====================================================\n\n/**\n * Obtiene alertas de seguridad activas\n */\nexport async function getActiveSecurityAlerts(\n  userId?: string,\n  severity?: SecuritySeverity\n): Promise<SecurityAlert[]> {\n  try {\n    if (!supabaseAdmin) {\n      throw new Error('Supabase admin client no disponible');\n    }\n\n    let query = supabaseAdmin\n      .from('security_alerts')\n      .select('*')\n      .eq('status', 'open')\n      .order('last_occurrence', { ascending: false });\n\n    if (userId) {\n      query = query.eq('user_id', userId);\n    }\n\n    if (severity) {\n      query = query.eq('severity', severity);\n    }\n\n    const { data: alerts, error } = await query;\n\n    if (error) {\n      throw new Error(`Error obteniendo alertas: ${error.message}`);\n    }\n\n    return alerts || [];\n  } catch (error) {\n    console.error('[SECURITY] Error obteniendo alertas activas:', error);\n    return [];\n  }\n}\n\n/**\n * Actualiza el estado de una alerta\n */\nexport async function updateSecurityAlert(\n  alertId: string,\n  updates: Partial<Pick<SecurityAlert, 'status' | 'assigned_to' | 'resolution_notes'>>\n): Promise<boolean> {\n  try {\n    if (!supabaseAdmin) {\n      throw new Error('Supabase admin client no disponible');\n    }\n\n    const { error } = await supabaseAdmin\n      .from('security_alerts')\n      .update({\n        ...updates,\n        updated_at: new Date().toISOString()\n      })\n      .eq('id', alertId);\n\n    if (error) {\n      throw new Error(`Error actualizando alerta: ${error.message}`);\n    }\n\n    console.log(`[SECURITY] Alerta ${alertId} actualizada: ${JSON.stringify(updates)}`);\n    return true;\n  } catch (error) {\n    console.error('[SECURITY] Error actualizando alerta:', error);\n    return false;\n  }\n}\n\n/**\n * Resuelve una alerta de seguridad\n */\nexport async function resolveSecurityAlert(\n  alertId: string,\n  resolutionNotes: string,\n  resolvedBy: string\n): Promise<boolean> {\n  return await updateSecurityAlert(alertId, {\n    status: 'resolved',\n    assigned_to: resolvedBy,\n    resolution_notes: resolutionNotes\n  });\n}\n\n/**\n * Marca una alerta como falso positivo\n */\nexport async function markAlertAsFalsePositive(\n  alertId: string,\n  notes: string,\n  markedBy: string\n): Promise<boolean> {\n  return await updateSecurityAlert(alertId, {\n    status: 'false_positive',\n    assigned_to: markedBy,\n    resolution_notes: notes\n  });\n}\n\n// =====================================================\n// FUNCIONES DE MONITOREO EN TIEMPO REAL\n// =====================================================\n\n/**\n * Inicia el monitoreo automático de seguridad\n */\nexport function startSecurityMonitoring(intervalMinutes: number = 5): NodeJS.Timeout {\n  console.log(`[SECURITY] Iniciando monitoreo automático cada ${intervalMinutes} minutos`);\n\n  return setInterval(async () => {\n    try {\n      console.log('[SECURITY] Ejecutando análisis automático...');\n\n      // Analizar patrones de seguridad\n      const alerts = await analyzeSecurityPatterns();\n\n      if (alerts.length > 0) {\n        console.log(`[SECURITY] ${alerts.length} nuevas alertas generadas`);\n\n        // Procesar alertas críticas inmediatamente\n        const criticalAlerts = alerts.filter(a => a.severity === 'critical');\n        if (criticalAlerts.length > 0) {\n          console.warn(`[SECURITY] ¡${criticalAlerts.length} alertas críticas detectadas!`);\n          // Aquí se podrían enviar notificaciones inmediatas\n        }\n      }\n\n      // Actualizar métricas\n      await getSecurityMetrics();\n\n    } catch (error) {\n      console.error('[SECURITY] Error en monitoreo automático:', error);\n    }\n  }, intervalMinutes * 60 * 1000);\n}\n\n/**\n * Detiene el monitoreo automático\n */\nexport function stopSecurityMonitoring(intervalId: NodeJS.Timeout): void {\n  clearInterval(intervalId);\n  console.log('[SECURITY] Monitoreo automático detenido');\n}\n\n/**\n * Ejecuta una verificación completa de seguridad\n */\nexport async function runSecurityHealthCheck(): Promise<{\n  status: 'healthy' | 'warning' | 'critical';\n  issues: string[];\n  recommendations: string[];\n  metrics: SecurityMetrics;\n}> {\n  try {\n    console.log('[SECURITY] Ejecutando verificación completa de seguridad...');\n\n    // Obtener métricas actuales\n    const metrics = await getSecurityMetrics();\n\n    // Obtener alertas activas\n    const activeAlerts = await getActiveSecurityAlerts();\n\n    const issues: string[] = [];\n    const recommendations: string[] = [];\n    let status: 'healthy' | 'warning' | 'critical' = 'healthy';\n\n    // Evaluar estado de seguridad\n    if (metrics.critical_events_24h > 0) {\n      issues.push(`${metrics.critical_events_24h} eventos críticos en las últimas 24 horas`);\n      status = 'critical';\n    }\n\n    if (metrics.auth_failures_24h > 20) {\n      issues.push(`Alto número de fallos de autenticación: ${metrics.auth_failures_24h}`);\n      if (status !== 'critical') status = 'warning';\n      recommendations.push('Considerar implementar medidas anti-brute force');\n    }\n\n    if (metrics.suspicious_activities_24h > 10) {\n      issues.push(`Actividad sospechosa elevada: ${metrics.suspicious_activities_24h} eventos`);\n      if (status !== 'critical') status = 'warning';\n      recommendations.push('Revisar patrones de actividad sospechosa');\n    }\n\n    if (metrics.active_alerts > 5) {\n      issues.push(`Muchas alertas activas sin resolver: ${metrics.active_alerts}`);\n      if (status !== 'critical') status = 'warning';\n      recommendations.push('Revisar y resolver alertas pendientes');\n    }\n\n    if (metrics.security_score < 70) {\n      issues.push(`Score de seguridad bajo: ${metrics.security_score}/100`);\n      if (status !== 'critical') status = 'warning';\n      recommendations.push('Implementar medidas para mejorar el score de seguridad');\n    }\n\n    // Recomendaciones generales\n    if (issues.length === 0) {\n      recommendations.push('Sistema de seguridad funcionando correctamente');\n      recommendations.push('Mantener monitoreo regular y actualizaciones de seguridad');\n    }\n\n    console.log(`[SECURITY] Verificación completada - Estado: ${status}`);\n\n    return {\n      status,\n      issues,\n      recommendations,\n      metrics\n    };\n  } catch (error) {\n    console.error('[SECURITY] Error en verificación de seguridad:', error);\n    return {\n      status: 'critical',\n      issues: ['Error ejecutando verificación de seguridad'],\n      recommendations: ['Revisar logs del sistema'],\n      metrics: await getSecurityMetrics()\n    };\n  }\n}\n\n// =====================================================\n// FUNCIONES DE UTILIDAD\n// =====================================================\n\n/**\n * Limpia eventos de seguridad antiguos\n */\nexport async function cleanupOldSecurityEvents(daysToKeep: number = 90): Promise<number> {\n  try {\n    if (!supabaseAdmin) {\n      throw new Error('Supabase admin client no disponible');\n    }\n\n    const cutoffDate = new Date(Date.now() - daysToKeep * 24 * 60 * 60 * 1000).toISOString();\n\n    const { data, error } = await supabaseAdmin\n      .from('security_events')\n      .delete()\n      .lt('timestamp', cutoffDate);\n\n    if (error) {\n      throw new Error(`Error limpiando eventos: ${error.message}`);\n    }\n\n    const deletedCount = Array.isArray(data) ? data.length : 0;\n    console.log(`[SECURITY] Limpieza completada: ${deletedCount} eventos eliminados`);\n\n    return deletedCount;\n  } catch (error) {\n    console.error('[SECURITY] Error en limpieza de eventos:', error);\n    return 0;\n  }\n}\n\n/**\n * Exporta eventos de seguridad para análisis externo\n */\nexport async function exportSecurityEvents(\n  startDate: Date,\n  endDate: Date,\n  format: 'json' | 'csv' = 'json'\n): Promise<string> {\n  try {\n    if (!supabaseAdmin) {\n      throw new Error('Supabase admin client no disponible');\n    }\n\n    const { data: events, error } = await supabaseAdmin\n      .from('security_events')\n      .select('*')\n      .gte('timestamp', startDate.toISOString())\n      .lte('timestamp', endDate.toISOString())\n      .order('timestamp', { ascending: true });\n\n    if (error) {\n      throw new Error(`Error exportando eventos: ${error.message}`);\n    }\n\n    if (format === 'json') {\n      return JSON.stringify(events, null, 2);\n    } else {\n      // Formato CSV\n      if (!events || events.length === 0) {\n        return 'No hay eventos para exportar';\n      }\n\n      const headers = Object.keys(events[0]).join(',');\n      const rows = events.map(event =>\n        Object.values(event).map(value =>\n          typeof value === 'string' ? `\"${value.replace(/\"/g, '\"\"')}\"` : value\n        ).join(',')\n      );\n\n      return [headers, ...rows].join('\\n');\n    }\n  } catch (error) {\n    console.error('[SECURITY] Error exportando eventos:', error);\n    throw error;\n  }\n}\n"],"names":["DEFAULT_SECURITY_PATTERNS","analyzeSecurityPatterns","cleanupOldSecurityEvents","exportSecurityEvents","generateSecurityReport","getActiveSecurityAlerts","getSecurityMetrics","markAlertAsFalsePositive","resolveSecurityAlert","runSecurityHealthCheck","startSecurityMonitoring","stopSecurityMonitoring","updateSecurityAlert","id","name","description","severity","timeWindow","threshold","enabled","conditions","field","operator","value","weight","actions","type","parameters","notify_admins","priority","notify_user","userId","timeWindowHours","console","log","supabaseAdmin","Error","timeThreshold","Date","now","toISOString","alerts","query","from","select","gte","order","ascending","eq","data","events","error","message","length","pattern","patternAlerts","detectPattern","push","insertError","insert","eventsByUser","reduce","acc","event","user_id","userEvents","Object","entries","matchingEvents","filter","matchesPatternConditions","sortedEvents","sort","a","b","timestamp","getTime","i","windowStart","windowEnd","eventsInWindow","eventTime","alert","pattern_id","title","event_count","first_occurrence","last_occurrence","status","metadata","pattern_name","map","e","time_window_minutes","executePatternActions","every","condition","eventValue","includes","Number","Array","isArray","action","logSecurityEvent","event_type","event_category","alert_id","warn","cache","CacheManager","getInstance","cacheKey","cached","get","CACHE_CONFIGS","USER_SESSION","last24h","alertsError","totalEvents","criticalEvents","uniqueUsers","Set","size","authFailures","suspiciousActivities","activeAlerts","securityScore","Math","max","min","metrics","total_events_24h","critical_events_24h","unique_users_24h","auth_failures_24h","suspicious_activities_24h","blocked_users","active_alerts","avg_response_time","security_score","set","startDate","endDate","lte","eventsBySeverity","low","medium","high","critical","eventsByCategory","authentication","authorization","data_access","admin_operations","suspicious_behavior","userCounts","ipCounts","forEach","ip_address","topUsers","slice","topIps","patternsDetected","patternCounts","occurrences","recommendations","generateSecurityRecommendations","report","period_start","period_end","total_events","events_by_severity","events_by_category","top_users","top_ips","patterns_detected","generated_at","highFrequencyPatterns","p","alertId","updates","update","updated_at","JSON","stringify","resolutionNotes","resolvedBy","assigned_to","resolution_notes","notes","markedBy","intervalMinutes","setInterval","criticalAlerts","intervalId","clearInterval","issues","daysToKeep","cutoffDate","delete","lt","deletedCount","format","headers","keys","join","rows","values","replace"],"mappings":"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"}