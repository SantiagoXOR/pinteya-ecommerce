{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\app\\api\\admin\\products\\[id]\\__tests__\\route.test.ts"],"sourcesContent":["// ðŸ§ª Enterprise Unit Tests - Individual Product API\n\nimport { NextRequest } from 'next/server';\nimport {\n  createMockRequest,\n  createMockSupabaseClient,\n  setupApiTestEnvironment,\n  cleanupApiTestEnvironment\n} from '@/__tests__/setup/api-mocks';\n\n// Dynamic import for API handlers to avoid module loading issues\nlet GET: any, PUT: any, DELETE: any;\n\nbeforeAll(async () => {\n  setupApiTestEnvironment();\n\n  // Import handlers after mocks are set up\n  const handlers = await import('../route');\n  GET = handlers.GET;\n  PUT = handlers.PUT;\n  DELETE = handlers.DELETE;\n});\n\ndescribe('/api/admin/products/[id] - Enterprise API Tests', () => {\n  let mockSupabase: any;\n  let mockRequest: any;\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n\n    mockSupabase = createMockSupabaseClient();\n    mockRequest = createMockRequest({\n      supabase: mockSupabase,\n    });\n  });\n\n  afterAll(() => {\n    cleanupApiTestEnvironment();\n  });\n\n  describe('GET /api/admin/products/[id]', () => {\n    it('should return product successfully', async () => {\n      const mockProduct = {\n        id: 'test-product-id',\n        name: 'Test Product',\n        price: 100,\n        stock: 10,\n        categories: { name: 'Test Category' },\n      };\n\n      mockSupabase.from().select().eq().single.mockResolvedValue({\n        data: mockProduct,\n        error: null,\n      });\n\n      const response = await GET(mockRequest, { params: { id: 'test-product-id' } });\n      const responseData = await response.json();\n\n      expect(response.status).toBe(200);\n      expect(responseData.success).toBe(true);\n      expect(responseData.data.name).toBe('Test Product');\n      expect(responseData.data.category_name).toBe('Test Category');\n    });\n\n    it('should handle product not found', async () => {\n      mockSupabase.from().select().eq().single.mockResolvedValue({\n        data: null,\n        error: { message: 'Not found' },\n      });\n\n      await expect(\n        GET(mockRequest, { params: { id: 'non-existent-id' } })\n      ).rejects.toThrow('Producto no encontrado');\n    });\n\n    it('should validate product ID format', async () => {\n      await expect(\n        GET(mockRequest, { params: { id: 'invalid-uuid' } })\n      ).rejects.toThrow('ID de producto invÃ¡lido');\n    });\n  });\n\n  describe('PUT /api/admin/products/[id]', () => {\n    beforeEach(() => {\n      mockRequest.validatedData = {\n        name: 'Updated Product',\n        price: 150,\n        stock: 20,\n      };\n\n      // Mock existing product check\n      mockSupabase.from().select().eq().single\n        .mockResolvedValueOnce({\n          data: { id: 'test-product-id', name: 'Original Product' },\n          error: null,\n        })\n        .mockResolvedValueOnce({\n          data: { id: 'category-id' },\n          error: null,\n        });\n    });\n\n    it('should update product successfully', async () => {\n      const mockUpdatedProduct = {\n        id: 'test-product-id',\n        name: 'Updated Product',\n        price: 150,\n        stock: 20,\n        categories: { name: 'Test Category' },\n      };\n\n      mockSupabase.from().update().eq().select().single.mockResolvedValue({\n        data: mockUpdatedProduct,\n        error: null,\n      });\n\n      const response = await PUT(mockRequest, { params: { id: 'test-product-id' } });\n      const responseData = await response.json();\n\n      expect(response.status).toBe(200);\n      expect(responseData.success).toBe(true);\n      expect(responseData.data.name).toBe('Updated Product');\n      expect(responseData.message).toBe('Producto actualizado exitosamente');\n    });\n\n    it('should generate slug when name is updated', async () => {\n      mockRequest.validatedData.name = 'New Product Name!';\n\n      mockSupabase.from().update().eq().select().single.mockResolvedValue({\n        data: { id: 'test-product-id', slug: 'new-product-name' },\n        error: null,\n      });\n\n      await PUT(mockRequest, { params: { id: 'test-product-id' } });\n\n      expect(mockSupabase.from().update).toHaveBeenCalledWith(\n        expect.objectContaining({\n          slug: 'new-product-name',\n        })\n      );\n    });\n\n    it('should validate category exists when updating category_id', async () => {\n      mockRequest.validatedData.category_id = 'invalid-category-id';\n\n      mockSupabase.from().select().eq().single\n        .mockResolvedValueOnce({\n          data: { id: 'test-product-id' },\n          error: null,\n        })\n        .mockResolvedValueOnce({\n          data: null,\n          error: { message: 'Not found' },\n        });\n\n      await expect(\n        PUT(mockRequest, { params: { id: 'test-product-id' } })\n      ).rejects.toThrow('CategorÃ­a no encontrada');\n    });\n\n    it('should handle database update errors', async () => {\n      mockSupabase.from().update().eq().select().single.mockResolvedValue({\n        data: null,\n        error: { message: 'Database error' },\n      });\n\n      await expect(\n        PUT(mockRequest, { params: { id: 'test-product-id' } })\n      ).rejects.toThrow('Error al actualizar producto');\n    });\n  });\n\n  describe('DELETE /api/admin/products/[id]', () => {\n    beforeEach(() => {\n      // Mock existing product check\n      mockSupabase.from().select().eq().single.mockResolvedValue({\n        data: { id: 'test-product-id', name: 'Test Product' },\n        error: null,\n      });\n    });\n\n    it('should perform soft delete when product has orders', async () => {\n      // Mock order items check - product has orders\n      mockSupabase.from().select().eq().limit.mockResolvedValue({\n        data: [{ id: 'order-item-id' }],\n        error: null,\n      });\n\n      // Mock soft delete update\n      mockSupabase.from().update().eq.mockResolvedValue({\n        error: null,\n      });\n\n      const response = await DELETE(mockRequest, { params: { id: 'test-product-id' } });\n      const responseData = await response.json();\n\n      expect(response.status).toBe(200);\n      expect(responseData.success).toBe(true);\n      expect(responseData.soft_delete).toBe(true);\n      expect(responseData.message).toContain('marcado como inactivo');\n    });\n\n    it('should perform hard delete when product has no orders', async () => {\n      // Mock order items check - no orders\n      mockSupabase.from().select().eq().limit.mockResolvedValue({\n        data: [],\n        error: null,\n      });\n\n      // Mock hard delete\n      mockSupabase.from().delete().eq.mockResolvedValue({\n        error: null,\n      });\n\n      const response = await DELETE(mockRequest, { params: { id: 'test-product-id' } });\n      const responseData = await response.json();\n\n      expect(response.status).toBe(200);\n      expect(responseData.success).toBe(true);\n      expect(responseData.hard_delete).toBe(true);\n      expect(responseData.message).toBe('Producto eliminado exitosamente');\n    });\n\n    it('should handle delete errors gracefully', async () => {\n      mockSupabase.from().select().eq().limit.mockResolvedValue({\n        data: [],\n        error: null,\n      });\n\n      mockSupabase.from().delete().eq.mockResolvedValue({\n        error: { message: 'Delete failed' },\n      });\n\n      await expect(\n        DELETE(mockRequest, { params: { id: 'test-product-id' } })\n      ).rejects.toThrow('Error al eliminar producto');\n    });\n  });\n\n  describe('Error Handling', () => {\n    it('should handle invalid UUID format', async () => {\n      await expect(\n        GET(mockRequest, { params: { id: 'not-a-uuid' } })\n      ).rejects.toThrow('ID de producto invÃ¡lido');\n    });\n\n    it('should handle missing product ID', async () => {\n      await expect(\n        GET(mockRequest, { params: { id: '' } })\n      ).rejects.toThrow('ID de producto invÃ¡lido');\n    });\n\n    it('should handle database connection errors', async () => {\n      mockSupabase.from().select().eq().single.mockRejectedValue(\n        new Error('Database connection failed')\n      );\n\n      await expect(\n        GET(mockRequest, { params: { id: 'test-product-id' } })\n      ).rejects.toThrow('Database connection failed');\n    });\n  });\n\n  describe('Audit Logging', () => {\n    it('should log update actions', async () => {\n      const { logAdminAction } = require('@/lib/api/api-logger');\n      \n      mockSupabase.from().select().eq().single.mockResolvedValue({\n        data: { id: 'test-product-id', name: 'Original' },\n        error: null,\n      });\n\n      mockSupabase.from().update().eq().select().single.mockResolvedValue({\n        data: { id: 'test-product-id', name: 'Updated' },\n        error: null,\n      });\n\n      await PUT(mockRequest, { params: { id: 'test-product-id' } });\n\n      expect(logAdminAction).toHaveBeenCalledWith(\n        'test-user-id',\n        'UPDATE',\n        'product',\n        'test-product-id',\n        expect.any(Object),\n        expect.any(Object)\n      );\n    });\n\n    it('should log delete actions', async () => {\n      const { logAdminAction } = require('@/lib/api/api-logger');\n      \n      mockSupabase.from().select().eq().limit.mockResolvedValue({\n        data: [],\n        error: null,\n      });\n\n      mockSupabase.from().delete().eq.mockResolvedValue({\n        error: null,\n      });\n\n      await DELETE(mockRequest, { params: { id: 'test-product-id' } });\n\n      expect(logAdminAction).toHaveBeenCalledWith(\n        'test-user-id',\n        'DELETE',\n        'product',\n        'test-product-id',\n        expect.any(Object),\n        null\n      );\n    });\n  });\n});\n"],"names":["GET","PUT","DELETE","beforeAll","setupApiTestEnvironment","handlers","describe","mockSupabase","mockRequest","beforeEach","jest","clearAllMocks","createMockSupabaseClient","createMockRequest","supabase","afterAll","cleanupApiTestEnvironment","it","mockProduct","id","name","price","stock","categories","from","select","eq","single","mockResolvedValue","data","error","response","params","responseData","json","expect","status","toBe","success","category_name","message","rejects","toThrow","validatedData","mockResolvedValueOnce","mockUpdatedProduct","update","slug","toHaveBeenCalledWith","objectContaining","category_id","limit","soft_delete","toContain","delete","hard_delete","mockRejectedValue","Error","logAdminAction","require","any","Object"],"mappings":"AAAA,oDAAoD;;;;;0BAQ7C;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEP,iEAAiE;AACjE,IAAIA,KAAUC,KAAUC;AAExBC,UAAU;IACRC,IAAAA,iCAAuB;IAEvB,yCAAyC;IACzC,MAAMC,WAAW,MAAM,mEAAA,QAAO;IAC9BL,MAAMK,SAASL,GAAG;IAClBC,MAAMI,SAASJ,GAAG;IAClBC,SAASG,SAASH,MAAM;AAC1B;AAEAI,SAAS,mDAAmD;IAC1D,IAAIC;IACJ,IAAIC;IAEJC,WAAW;QACTC,KAAKC,aAAa;QAElBJ,eAAeK,IAAAA,kCAAwB;QACvCJ,cAAcK,IAAAA,2BAAiB,EAAC;YAC9BC,UAAUP;QACZ;IACF;IAEAQ,SAAS;QACPC,IAAAA,mCAAyB;IAC3B;IAEAV,SAAS,gCAAgC;QACvCW,GAAG,sCAAsC;YACvC,MAAMC,cAAc;gBAClBC,IAAI;gBACJC,MAAM;gBACNC,OAAO;gBACPC,OAAO;gBACPC,YAAY;oBAAEH,MAAM;gBAAgB;YACtC;YAEAb,aAAaiB,IAAI,GAAGC,MAAM,GAAGC,EAAE,GAAGC,MAAM,CAACC,iBAAiB,CAAC;gBACzDC,MAAMX;gBACNY,OAAO;YACT;YAEA,MAAMC,WAAW,MAAM/B,IAAIQ,aAAa;gBAAEwB,QAAQ;oBAAEb,IAAI;gBAAkB;YAAE;YAC5E,MAAMc,eAAe,MAAMF,SAASG,IAAI;YAExCC,OAAOJ,SAASK,MAAM,EAAEC,IAAI,CAAC;YAC7BF,OAAOF,aAAaK,OAAO,EAAED,IAAI,CAAC;YAClCF,OAAOF,aAAaJ,IAAI,CAACT,IAAI,EAAEiB,IAAI,CAAC;YACpCF,OAAOF,aAAaJ,IAAI,CAACU,aAAa,EAAEF,IAAI,CAAC;QAC/C;QAEApB,GAAG,mCAAmC;YACpCV,aAAaiB,IAAI,GAAGC,MAAM,GAAGC,EAAE,GAAGC,MAAM,CAACC,iBAAiB,CAAC;gBACzDC,MAAM;gBACNC,OAAO;oBAAEU,SAAS;gBAAY;YAChC;YAEA,MAAML,OACJnC,IAAIQ,aAAa;gBAAEwB,QAAQ;oBAAEb,IAAI;gBAAkB;YAAE,IACrDsB,OAAO,CAACC,OAAO,CAAC;QACpB;QAEAzB,GAAG,qCAAqC;YACtC,MAAMkB,OACJnC,IAAIQ,aAAa;gBAAEwB,QAAQ;oBAAEb,IAAI;gBAAe;YAAE,IAClDsB,OAAO,CAACC,OAAO,CAAC;QACpB;IACF;IAEApC,SAAS,gCAAgC;QACvCG,WAAW;YACTD,YAAYmC,aAAa,GAAG;gBAC1BvB,MAAM;gBACNC,OAAO;gBACPC,OAAO;YACT;YAEA,8BAA8B;YAC9Bf,aAAaiB,IAAI,GAAGC,MAAM,GAAGC,EAAE,GAAGC,MAAM,CACrCiB,qBAAqB,CAAC;gBACrBf,MAAM;oBAAEV,IAAI;oBAAmBC,MAAM;gBAAmB;gBACxDU,OAAO;YACT,GACCc,qBAAqB,CAAC;gBACrBf,MAAM;oBAAEV,IAAI;gBAAc;gBAC1BW,OAAO;YACT;QACJ;QAEAb,GAAG,sCAAsC;YACvC,MAAM4B,qBAAqB;gBACzB1B,IAAI;gBACJC,MAAM;gBACNC,OAAO;gBACPC,OAAO;gBACPC,YAAY;oBAAEH,MAAM;gBAAgB;YACtC;YAEAb,aAAaiB,IAAI,GAAGsB,MAAM,GAAGpB,EAAE,GAAGD,MAAM,GAAGE,MAAM,CAACC,iBAAiB,CAAC;gBAClEC,MAAMgB;gBACNf,OAAO;YACT;YAEA,MAAMC,WAAW,MAAM9B,IAAIO,aAAa;gBAAEwB,QAAQ;oBAAEb,IAAI;gBAAkB;YAAE;YAC5E,MAAMc,eAAe,MAAMF,SAASG,IAAI;YAExCC,OAAOJ,SAASK,MAAM,EAAEC,IAAI,CAAC;YAC7BF,OAAOF,aAAaK,OAAO,EAAED,IAAI,CAAC;YAClCF,OAAOF,aAAaJ,IAAI,CAACT,IAAI,EAAEiB,IAAI,CAAC;YACpCF,OAAOF,aAAaO,OAAO,EAAEH,IAAI,CAAC;QACpC;QAEApB,GAAG,6CAA6C;YAC9CT,YAAYmC,aAAa,CAACvB,IAAI,GAAG;YAEjCb,aAAaiB,IAAI,GAAGsB,MAAM,GAAGpB,EAAE,GAAGD,MAAM,GAAGE,MAAM,CAACC,iBAAiB,CAAC;gBAClEC,MAAM;oBAAEV,IAAI;oBAAmB4B,MAAM;gBAAmB;gBACxDjB,OAAO;YACT;YAEA,MAAM7B,IAAIO,aAAa;gBAAEwB,QAAQ;oBAAEb,IAAI;gBAAkB;YAAE;YAE3DgB,OAAO5B,aAAaiB,IAAI,GAAGsB,MAAM,EAAEE,oBAAoB,CACrDb,OAAOc,gBAAgB,CAAC;gBACtBF,MAAM;YACR;QAEJ;QAEA9B,GAAG,6DAA6D;YAC9DT,YAAYmC,aAAa,CAACO,WAAW,GAAG;YAExC3C,aAAaiB,IAAI,GAAGC,MAAM,GAAGC,EAAE,GAAGC,MAAM,CACrCiB,qBAAqB,CAAC;gBACrBf,MAAM;oBAAEV,IAAI;gBAAkB;gBAC9BW,OAAO;YACT,GACCc,qBAAqB,CAAC;gBACrBf,MAAM;gBACNC,OAAO;oBAAEU,SAAS;gBAAY;YAChC;YAEF,MAAML,OACJlC,IAAIO,aAAa;gBAAEwB,QAAQ;oBAAEb,IAAI;gBAAkB;YAAE,IACrDsB,OAAO,CAACC,OAAO,CAAC;QACpB;QAEAzB,GAAG,wCAAwC;YACzCV,aAAaiB,IAAI,GAAGsB,MAAM,GAAGpB,EAAE,GAAGD,MAAM,GAAGE,MAAM,CAACC,iBAAiB,CAAC;gBAClEC,MAAM;gBACNC,OAAO;oBAAEU,SAAS;gBAAiB;YACrC;YAEA,MAAML,OACJlC,IAAIO,aAAa;gBAAEwB,QAAQ;oBAAEb,IAAI;gBAAkB;YAAE,IACrDsB,OAAO,CAACC,OAAO,CAAC;QACpB;IACF;IAEApC,SAAS,mCAAmC;QAC1CG,WAAW;YACT,8BAA8B;YAC9BF,aAAaiB,IAAI,GAAGC,MAAM,GAAGC,EAAE,GAAGC,MAAM,CAACC,iBAAiB,CAAC;gBACzDC,MAAM;oBAAEV,IAAI;oBAAmBC,MAAM;gBAAe;gBACpDU,OAAO;YACT;QACF;QAEAb,GAAG,sDAAsD;YACvD,8CAA8C;YAC9CV,aAAaiB,IAAI,GAAGC,MAAM,GAAGC,EAAE,GAAGyB,KAAK,CAACvB,iBAAiB,CAAC;gBACxDC,MAAM;oBAAC;wBAAEV,IAAI;oBAAgB;iBAAE;gBAC/BW,OAAO;YACT;YAEA,0BAA0B;YAC1BvB,aAAaiB,IAAI,GAAGsB,MAAM,GAAGpB,EAAE,CAACE,iBAAiB,CAAC;gBAChDE,OAAO;YACT;YAEA,MAAMC,WAAW,MAAM7B,OAAOM,aAAa;gBAAEwB,QAAQ;oBAAEb,IAAI;gBAAkB;YAAE;YAC/E,MAAMc,eAAe,MAAMF,SAASG,IAAI;YAExCC,OAAOJ,SAASK,MAAM,EAAEC,IAAI,CAAC;YAC7BF,OAAOF,aAAaK,OAAO,EAAED,IAAI,CAAC;YAClCF,OAAOF,aAAamB,WAAW,EAAEf,IAAI,CAAC;YACtCF,OAAOF,aAAaO,OAAO,EAAEa,SAAS,CAAC;QACzC;QAEApC,GAAG,yDAAyD;YAC1D,qCAAqC;YACrCV,aAAaiB,IAAI,GAAGC,MAAM,GAAGC,EAAE,GAAGyB,KAAK,CAACvB,iBAAiB,CAAC;gBACxDC,MAAM,EAAE;gBACRC,OAAO;YACT;YAEA,mBAAmB;YACnBvB,aAAaiB,IAAI,GAAG8B,MAAM,GAAG5B,EAAE,CAACE,iBAAiB,CAAC;gBAChDE,OAAO;YACT;YAEA,MAAMC,WAAW,MAAM7B,OAAOM,aAAa;gBAAEwB,QAAQ;oBAAEb,IAAI;gBAAkB;YAAE;YAC/E,MAAMc,eAAe,MAAMF,SAASG,IAAI;YAExCC,OAAOJ,SAASK,MAAM,EAAEC,IAAI,CAAC;YAC7BF,OAAOF,aAAaK,OAAO,EAAED,IAAI,CAAC;YAClCF,OAAOF,aAAasB,WAAW,EAAElB,IAAI,CAAC;YACtCF,OAAOF,aAAaO,OAAO,EAAEH,IAAI,CAAC;QACpC;QAEApB,GAAG,0CAA0C;YAC3CV,aAAaiB,IAAI,GAAGC,MAAM,GAAGC,EAAE,GAAGyB,KAAK,CAACvB,iBAAiB,CAAC;gBACxDC,MAAM,EAAE;gBACRC,OAAO;YACT;YAEAvB,aAAaiB,IAAI,GAAG8B,MAAM,GAAG5B,EAAE,CAACE,iBAAiB,CAAC;gBAChDE,OAAO;oBAAEU,SAAS;gBAAgB;YACpC;YAEA,MAAML,OACJjC,OAAOM,aAAa;gBAAEwB,QAAQ;oBAAEb,IAAI;gBAAkB;YAAE,IACxDsB,OAAO,CAACC,OAAO,CAAC;QACpB;IACF;IAEApC,SAAS,kBAAkB;QACzBW,GAAG,qCAAqC;YACtC,MAAMkB,OACJnC,IAAIQ,aAAa;gBAAEwB,QAAQ;oBAAEb,IAAI;gBAAa;YAAE,IAChDsB,OAAO,CAACC,OAAO,CAAC;QACpB;QAEAzB,GAAG,oCAAoC;YACrC,MAAMkB,OACJnC,IAAIQ,aAAa;gBAAEwB,QAAQ;oBAAEb,IAAI;gBAAG;YAAE,IACtCsB,OAAO,CAACC,OAAO,CAAC;QACpB;QAEAzB,GAAG,4CAA4C;YAC7CV,aAAaiB,IAAI,GAAGC,MAAM,GAAGC,EAAE,GAAGC,MAAM,CAAC6B,iBAAiB,CACxD,IAAIC,MAAM;YAGZ,MAAMtB,OACJnC,IAAIQ,aAAa;gBAAEwB,QAAQ;oBAAEb,IAAI;gBAAkB;YAAE,IACrDsB,OAAO,CAACC,OAAO,CAAC;QACpB;IACF;IAEApC,SAAS,iBAAiB;QACxBW,GAAG,6BAA6B;YAC9B,MAAM,EAAEyC,cAAc,EAAE,GAAGC,QAAQ;YAEnCpD,aAAaiB,IAAI,GAAGC,MAAM,GAAGC,EAAE,GAAGC,MAAM,CAACC,iBAAiB,CAAC;gBACzDC,MAAM;oBAAEV,IAAI;oBAAmBC,MAAM;gBAAW;gBAChDU,OAAO;YACT;YAEAvB,aAAaiB,IAAI,GAAGsB,MAAM,GAAGpB,EAAE,GAAGD,MAAM,GAAGE,MAAM,CAACC,iBAAiB,CAAC;gBAClEC,MAAM;oBAAEV,IAAI;oBAAmBC,MAAM;gBAAU;gBAC/CU,OAAO;YACT;YAEA,MAAM7B,IAAIO,aAAa;gBAAEwB,QAAQ;oBAAEb,IAAI;gBAAkB;YAAE;YAE3DgB,OAAOuB,gBAAgBV,oBAAoB,CACzC,gBACA,UACA,WACA,mBACAb,OAAOyB,GAAG,CAACC,SACX1B,OAAOyB,GAAG,CAACC;QAEf;QAEA5C,GAAG,6BAA6B;YAC9B,MAAM,EAAEyC,cAAc,EAAE,GAAGC,QAAQ;YAEnCpD,aAAaiB,IAAI,GAAGC,MAAM,GAAGC,EAAE,GAAGyB,KAAK,CAACvB,iBAAiB,CAAC;gBACxDC,MAAM,EAAE;gBACRC,OAAO;YACT;YAEAvB,aAAaiB,IAAI,GAAG8B,MAAM,GAAG5B,EAAE,CAACE,iBAAiB,CAAC;gBAChDE,OAAO;YACT;YAEA,MAAM5B,OAAOM,aAAa;gBAAEwB,QAAQ;oBAAEb,IAAI;gBAAkB;YAAE;YAE9DgB,OAAOuB,gBAAgBV,oBAAoB,CACzC,gBACA,UACA,WACA,mBACAb,OAAOyB,GAAG,CAACC,SACX;QAEJ;IACF;AACF"}