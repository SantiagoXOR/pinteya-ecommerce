{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\__tests__\\api\\user-profile.test.ts"],"sourcesContent":["// ===================================\r\n// PINTEYA E-COMMERCE - TESTS PARA API USER PROFILE\r\n// ===================================\r\n\r\nimport { NextRequest } from 'next/server';\r\nimport { GET, PUT } from '@/app/api/user/profile/route';\r\n\r\n// Mock NextAuth\r\njest.mock('@/auth', () => ({ auth: jest.fn() }));\r\n\r\n// Mock Supabase\r\njest.mock('@/lib/supabase', () => ({\r\n  supabaseAdmin: {\r\n    from: jest.fn(() => ({\r\n      select: jest.fn(() => ({\r\n        eq: jest.fn(() => ({\r\n          single: jest.fn(() => ({\r\n            data: {\r\n              id: '1',\r\n              clerk_id: 'clerk_123',\r\n              name: 'Juan Pérez',\r\n              email: 'juan@example.com',\r\n            },\r\n            error: null,\r\n          })),\r\n        })),\r\n      })),\r\n      insert: jest.fn(() => ({\r\n        select: jest.fn(() => ({\r\n          single: jest.fn(() => ({\r\n            data: {\r\n              id: '1',\r\n              clerk_id: 'clerk_123',\r\n              name: 'Usuario Demo',\r\n              email: 'usuario@demo.com',\r\n            },\r\n            error: null,\r\n          })),\r\n        })),\r\n      })),\r\n      update: jest.fn(() => ({\r\n        eq: jest.fn(() => ({\r\n          select: jest.fn(() => ({\r\n            single: jest.fn(() => ({\r\n              data: {\r\n                id: '1',\r\n                clerk_id: 'clerk_123',\r\n                name: 'Juan Carlos Pérez',\r\n                email: 'juan@example.com',\r\n              },\r\n              error: null,\r\n            })),\r\n          })),\r\n        })),\r\n      })),\r\n    })),\r\n  },\r\n}));\r\n\r\nconst mockUser = {\r\n  id: 'clerk_123',\r\n  emailAddresses: [{ emailAddress: 'juan@example.com' }],\r\n  firstName: 'Juan',\r\n  lastName: 'Pérez',\r\n};\r\n\r\ndescribe('/api/user/profile', () => {\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n\r\n    // Configurar mock de auth por defecto\r\n    const { auth } = require('@clerk/nextjs/server');\r\n    auth.mockResolvedValue(mockUser);\r\n\r\n    // Resetear el mock de Supabase a su estado por defecto\r\n    const { supabaseAdmin } = require('@/lib/supabase');\r\n    supabaseAdmin.from.mockReturnValue({\r\n      select: jest.fn(() => ({\r\n        eq: jest.fn(() => ({\r\n          single: jest.fn(() => ({\r\n            data: {\r\n              id: '1',\r\n              clerk_id: 'clerk_123',\r\n              name: 'Juan Pérez',\r\n              email: 'juan@example.com',\r\n            },\r\n            error: null,\r\n          })),\r\n        })),\r\n      })),\r\n      insert: jest.fn(() => ({\r\n        select: jest.fn(() => ({\r\n          single: jest.fn(() => ({\r\n            data: {\r\n              id: '1',\r\n              clerk_id: 'clerk_123',\r\n              name: 'Usuario Demo',\r\n              email: 'usuario@demo.com',\r\n            },\r\n            error: null,\r\n          })),\r\n        })),\r\n      })),\r\n      update: jest.fn(() => ({\r\n        eq: jest.fn(() => ({\r\n          select: jest.fn(() => ({\r\n            single: jest.fn(() => ({\r\n              data: {\r\n                id: '1',\r\n                clerk_id: 'clerk_123',\r\n                name: 'Juan Carlos Pérez',\r\n                email: 'juan@example.com',\r\n              },\r\n              error: null,\r\n            })),\r\n          })),\r\n        })),\r\n      })),\r\n    });\r\n  });\r\n\r\n  describe('GET', () => {\r\n    it('should return user profile successfully', async () => {\r\n      // Asegurar que auth devuelve un usuario válido\r\n      const { auth } = require('@clerk/nextjs/server');\r\n      auth.mockResolvedValue(mockUser);\r\n\r\n      // Asegurar que Supabase devuelve datos válidos\r\n      const { supabaseAdmin } = require('@/lib/supabase');\r\n      supabaseAdmin.from.mockReturnValue({\r\n        select: jest.fn(() => ({\r\n          eq: jest.fn(() => ({\r\n            single: jest.fn(() => Promise.resolve({\r\n              data: {\r\n                id: '1',\r\n                clerk_id: 'clerk_123',\r\n                name: 'Juan Pérez',\r\n                email: 'juan@example.com',\r\n              },\r\n              error: null,\r\n            })),\r\n          })),\r\n        })),\r\n      });\r\n\r\n      const request = new NextRequest('http://localhost:3000/api/user/profile');\r\n\r\n      const response = await GET(request);\r\n      const data = await response.json();\r\n\r\n      // Si el test falla, mostrar la respuesta real para debug\r\n      if (response.status !== 200) {\r\n        console.log('Response status:', response.status);\r\n        console.log('Response data:', data);\r\n      }\r\n\r\n      expect(response.status).toBe(200);\r\n      expect(data.success).toBe(true);\r\n      expect(data.user).toEqual({\r\n        id: '1',\r\n        clerk_id: 'clerk_123',\r\n        name: 'Juan Pérez',\r\n        email: 'juan@example.com',\r\n      });\r\n    });\r\n\r\n    it('should handle unauthenticated user (currently returns demo user)', async () => {\r\n      const { auth } = require('@clerk/nextjs/server');\r\n      auth.mockResolvedValue(null);\r\n\r\n      const request = new NextRequest('http://localhost:3000/api/user/profile');\r\n\r\n      const response = await GET(request);\r\n      const data = await response.json();\r\n\r\n      // La API actual devuelve un usuario demo cuando no hay autenticación\r\n      expect(response.status).toBe(200);\r\n      expect(data.success).toBe(true);\r\n      expect(data.user).toBeDefined();\r\n    });\r\n\r\n    it('should create demo user when not found in database', async () => {\r\n      const { auth } = require('@clerk/nextjs/server');\r\n      auth.mockResolvedValue(mockUser);\r\n\r\n      const { supabaseAdmin } = require('@/lib/supabase');\r\n      supabaseAdmin.from.mockReturnValue({\r\n        select: jest.fn(() => ({\r\n          eq: jest.fn(() => ({\r\n            single: jest.fn(() => ({\r\n              data: null,\r\n              error: { code: 'PGRST116' },\r\n            })),\r\n          })),\r\n        })),\r\n        insert: jest.fn(() => ({\r\n          select: jest.fn(() => ({\r\n            single: jest.fn(() => ({\r\n              data: {\r\n                id: '1',\r\n                clerk_id: 'demo-user-id',\r\n                name: 'Usuario Demo',\r\n                email: 'usuario@demo.com',\r\n              },\r\n              error: null,\r\n            })),\r\n          })),\r\n        })),\r\n      });\r\n\r\n      const request = new NextRequest('http://localhost:3000/api/user/profile');\r\n\r\n      const response = await GET(request);\r\n      const data = await response.json();\r\n\r\n      expect(response.status).toBe(200);\r\n      expect(data.success).toBe(true);\r\n      expect(data.user.name).toBe('Usuario Demo');\r\n    });\r\n  });\r\n\r\n  describe('PUT', () => {\r\n    it('should update user profile successfully', async () => {\r\n      const { auth } = require('@clerk/nextjs/server');\r\n      auth.mockResolvedValue(mockUser);\r\n\r\n      const requestBody = { name: 'Juan Carlos Pérez', email: 'juan@example.com' };\r\n      const request = new NextRequest('http://localhost:3000/api/user/profile', {\r\n        method: 'PUT',\r\n        body: JSON.stringify(requestBody),\r\n      });\r\n\r\n      const response = await PUT(request);\r\n      const data = await response.json();\r\n\r\n      expect(response.status).toBe(200);\r\n      expect(data.success).toBe(true);\r\n      expect(data.user.name).toBe('Juan Carlos Pérez');\r\n    });\r\n\r\n    it('should handle missing required fields', async () => {\r\n      const { auth } = require('@clerk/nextjs/server');\r\n      auth.mockResolvedValue(mockUser);\r\n\r\n      const request = new NextRequest('http://localhost:3000/api/user/profile', {\r\n        method: 'PUT',\r\n        body: JSON.stringify({ name: 'Juan Carlos Pérez' }), // Falta email\r\n      });\r\n\r\n      const response = await PUT(request);\r\n      const data = await response.json();\r\n\r\n      expect(response.status).toBe(400);\r\n      expect(data.error).toBe('Nombre y email son requeridos');\r\n    });\r\n\r\n    it('should handle database update error', async () => {\r\n      const { auth } = require('@clerk/nextjs/server');\r\n      auth.mockResolvedValue(mockUser);\r\n\r\n      const { supabaseAdmin } = require('@/lib/supabase');\r\n      supabaseAdmin.from.mockReturnValue({\r\n        update: jest.fn(() => ({\r\n          eq: jest.fn(() => ({\r\n            select: jest.fn(() => ({\r\n              single: jest.fn(() => ({\r\n                data: null,\r\n                error: { message: 'Update failed' },\r\n              })),\r\n            })),\r\n          })),\r\n        })),\r\n      });\r\n\r\n      const requestBody = { name: 'Juan Carlos Pérez', email: 'juan@example.com' };\r\n      const request = new NextRequest('http://localhost:3000/api/user/profile', {\r\n        method: 'PUT',\r\n        body: JSON.stringify(requestBody),\r\n      });\r\n\r\n      const response = await PUT(request);\r\n      const data = await response.json();\r\n\r\n      expect(response.status).toBe(500);\r\n      expect(data.error).toBe('Error al actualizar perfil de usuario');\r\n    });\r\n  });\r\n});\r\n"],"names":["jest","mock","auth","fn","supabaseAdmin","from","select","eq","single","data","id","clerk_id","name","email","error","insert","update","mockUser","emailAddresses","emailAddress","firstName","lastName","describe","beforeEach","clearAllMocks","require","mockResolvedValue","mockReturnValue","it","Promise","resolve","request","NextRequest","response","GET","json","status","console","log","expect","toBe","success","user","toEqual","toBeDefined","code","requestBody","method","body","JSON","stringify","PUT","message"],"mappings":"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"}