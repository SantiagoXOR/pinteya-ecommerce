94de005dfc6786767ce8fceca7c29a5c
// ===================================
// API: /api/search/trending - B√∫squedas populares/trending
// ===================================
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: all[name]
    });
}
_export(exports, {
    GET: function() {
        return GET;
    },
    POST: function() {
        return POST;
    }
});
const _server = require("next/server");
const _supabase = require("../../../../lib/supabase");
// B√∫squedas trending por defecto (fallback)
const defaultTrendingSearches = [
    {
        id: "trending-1",
        query: "Pintura l√°tex",
        count: 156,
        category: "pinturas",
        href: "/search?q=pintura+latex",
        type: "trending"
    },
    {
        id: "trending-2",
        query: "Sherwin Williams",
        count: 142,
        category: "marcas",
        href: "/search?q=sherwin+williams",
        type: "trending"
    },
    {
        id: "trending-3",
        query: "Rodillos premium",
        count: 98,
        category: "herramientas",
        href: "/search?q=rodillos+premium",
        type: "trending"
    },
    {
        id: "trending-4",
        query: "Pinceles",
        count: 87,
        category: "herramientas",
        href: "/search?q=pinceles",
        type: "trending"
    },
    {
        id: "trending-5",
        query: "Impermeabilizante",
        count: 76,
        category: "pinturas",
        href: "/search?q=impermeabilizante",
        type: "trending"
    },
    {
        id: "trending-6",
        query: "Petrilac",
        count: 65,
        category: "marcas",
        href: "/search?q=petrilac",
        type: "trending"
    }
];
async function GET(request) {
    try {
        const { searchParams } = new URL(request.url);
        const limit = parseInt(searchParams.get('limit') || '6');
        const days = parseInt(searchParams.get('days') || '7');
        const category = searchParams.get('category');
        console.log('üî• API /api/search/trending: Obteniendo b√∫squedas trending', {
            limit,
            days,
            category
        });
        const supabase = (0, _supabase.getSupabaseClient)();
        let trendingSearches = [];
        // Intentar obtener b√∫squedas trending reales del sistema de analytics
        if (supabase) {
            try {
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - days);
                // Query para obtener b√∫squedas m√°s populares de analytics_events
                let query = supabase.from('analytics_events').select('label, metadata').eq('category', 'search').eq('action', 'search_query').gte('created_at', startDate.toISOString()).not('label', 'is', null);
                if (category) {
                    query = query.eq('metadata->>category', category);
                }
                const { data: analyticsData, error } = await query;
                if (!error && analyticsData && analyticsData.length > 0) {
                    // Procesar datos de analytics para obtener trending
                    const searchCounts = new Map();
                    const searchCategories = new Map();
                    analyticsData.forEach((event)=>{
                        if (event.label) {
                            const query = event.label.toLowerCase().trim();
                            if (query.length > 2) {
                                searchCounts.set(query, (searchCounts.get(query) || 0) + 1);
                                // Extraer categor√≠a del metadata si existe
                                if (event.metadata && event.metadata.category) {
                                    searchCategories.set(query, event.metadata.category);
                                }
                            }
                        }
                    });
                    // Convertir a array y ordenar por popularidad
                    const sortedSearches = Array.from(searchCounts.entries()).sort((a, b)=>b[1] - a[1]).slice(0, limit);
                    trendingSearches = sortedSearches.map(([query, count], index)=>({
                            id: `trending-real-${index + 1}`,
                            query: query.charAt(0).toUpperCase() + query.slice(1),
                            count,
                            category: searchCategories.get(query),
                            href: `/search?q=${encodeURIComponent(query)}`,
                            type: 'trending'
                        }));
                    console.log('‚úÖ B√∫squedas trending obtenidas de analytics:', trendingSearches.length);
                }
            } catch (analyticsError) {
                console.warn('‚ö†Ô∏è Error obteniendo trending de analytics, usando fallback:', analyticsError);
            }
        }
        // Si no hay datos reales o hay pocos, usar datos por defecto
        if (trendingSearches.length < 3) {
            console.log('üìã Usando b√∫squedas trending por defecto');
            let filteredDefaults = defaultTrendingSearches;
            // Filtrar por categor√≠a si se especifica
            if (category) {
                filteredDefaults = defaultTrendingSearches.filter((search)=>search.category === category);
            }
            // Combinar datos reales con defaults si es necesario
            const needed = limit - trendingSearches.length;
            const additionalSearches = filteredDefaults.slice(0, needed);
            trendingSearches = [
                ...trendingSearches,
                ...additionalSearches
            ];
        }
        // Limitar al n√∫mero solicitado
        trendingSearches = trendingSearches.slice(0, limit);
        const response = {
            data: {
                trending: trendingSearches,
                lastUpdated: new Date().toISOString()
            },
            success: true
        };
        console.log('üî• Trending searches response:', {
            count: trendingSearches.length,
            hasRealData: trendingSearches.some((s)=>s.id.includes('real')),
            categories: [
                ...new Set(trendingSearches.map((s)=>s.category).filter(Boolean))
            ]
        });
        return _server.NextResponse.json(response);
    } catch (error) {
        console.error('‚ùå Error en /api/search/trending:', error);
        // En caso de error, devolver b√∫squedas por defecto
        const fallbackResponse = {
            data: {
                trending: defaultTrendingSearches.slice(0, parseInt(request.nextUrl.searchParams.get('limit') || '6')),
                lastUpdated: new Date().toISOString()
            },
            success: true
        };
        return _server.NextResponse.json(fallbackResponse);
    }
}
async function POST(request) {
    try {
        const { query, category, userId, sessionId } = await request.json();
        if (!query || typeof query !== 'string') {
            return _server.NextResponse.json({
                error: 'Query de b√∫squeda requerida'
            }, {
                status: 400
            });
        }
        const supabase = (0, _supabase.getSupabaseClient)();
        if (supabase) {
            // Registrar la b√∫squeda en analytics
            const { error } = await supabase.from('analytics_events').insert({
                event_name: 'search_query',
                category: 'search',
                action: 'search_query',
                label: query.toLowerCase().trim(),
                user_id: userId,
                session_id: sessionId || 'anonymous',
                page: '/search',
                metadata: {
                    category: category,
                    timestamp: new Date().toISOString()
                }
            });
            if (error) {
                console.error('Error registrando b√∫squeda en analytics:', error);
            } else {
                console.log('‚úÖ B√∫squeda registrada en analytics:', query);
            }
        }
        return _server.NextResponse.json({
            success: true
        });
    } catch (error) {
        console.error('‚ùå Error registrando b√∫squeda:', error);
        return _server.NextResponse.json({
            error: 'Error interno del servidor'
        }, {
            status: 500
        });
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbWFydGlcXERlc2t0b3BcXERFU0FSUk9MTE9TV1xcQk9JTEVSUExBVFRFIEUtQ09NTUVSQ0VcXHNyY1xcYXBwXFxhcGlcXHNlYXJjaFxcdHJlbmRpbmdcXHJvdXRlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBBUEk6IC9hcGkvc2VhcmNoL3RyZW5kaW5nIC0gQsO6c3F1ZWRhcyBwb3B1bGFyZXMvdHJlbmRpbmdcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmltcG9ydCB7IE5leHRSZXF1ZXN0LCBOZXh0UmVzcG9uc2UgfSBmcm9tICduZXh0L3NlcnZlcic7XG5pbXBvcnQgeyBnZXRTdXBhYmFzZUNsaWVudCB9IGZyb20gJ0AvbGliL3N1cGFiYXNlJztcbmltcG9ydCB7IEFwaVJlc3BvbnNlIH0gZnJvbSAnQC90eXBlcy9hcGknO1xuXG5leHBvcnQgaW50ZXJmYWNlIFRyZW5kaW5nU2VhcmNoIHtcbiAgaWQ6IHN0cmluZztcbiAgcXVlcnk6IHN0cmluZztcbiAgY291bnQ6IG51bWJlcjtcbiAgY2F0ZWdvcnk/OiBzdHJpbmc7XG4gIGhyZWY6IHN0cmluZztcbiAgdHlwZTogJ3RyZW5kaW5nJztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUcmVuZGluZ1NlYXJjaGVzUmVzcG9uc2Uge1xuICB0cmVuZGluZzogVHJlbmRpbmdTZWFyY2hbXTtcbiAgbGFzdFVwZGF0ZWQ6IHN0cmluZztcbn1cblxuLy8gQsO6c3F1ZWRhcyB0cmVuZGluZyBwb3IgZGVmZWN0byAoZmFsbGJhY2spXG5jb25zdCBkZWZhdWx0VHJlbmRpbmdTZWFyY2hlczogVHJlbmRpbmdTZWFyY2hbXSA9IFtcbiAge1xuICAgIGlkOiBcInRyZW5kaW5nLTFcIixcbiAgICBxdWVyeTogXCJQaW50dXJhIGzDoXRleFwiLFxuICAgIGNvdW50OiAxNTYsXG4gICAgY2F0ZWdvcnk6IFwicGludHVyYXNcIixcbiAgICBocmVmOiBcIi9zZWFyY2g/cT1waW50dXJhK2xhdGV4XCIsXG4gICAgdHlwZTogXCJ0cmVuZGluZ1wiXG4gIH0sXG4gIHtcbiAgICBpZDogXCJ0cmVuZGluZy0yXCIsIFxuICAgIHF1ZXJ5OiBcIlNoZXJ3aW4gV2lsbGlhbXNcIixcbiAgICBjb3VudDogMTQyLFxuICAgIGNhdGVnb3J5OiBcIm1hcmNhc1wiLFxuICAgIGhyZWY6IFwiL3NlYXJjaD9xPXNoZXJ3aW4rd2lsbGlhbXNcIixcbiAgICB0eXBlOiBcInRyZW5kaW5nXCJcbiAgfSxcbiAge1xuICAgIGlkOiBcInRyZW5kaW5nLTNcIixcbiAgICBxdWVyeTogXCJSb2RpbGxvcyBwcmVtaXVtXCIsXG4gICAgY291bnQ6IDk4LFxuICAgIGNhdGVnb3J5OiBcImhlcnJhbWllbnRhc1wiLFxuICAgIGhyZWY6IFwiL3NlYXJjaD9xPXJvZGlsbG9zK3ByZW1pdW1cIixcbiAgICB0eXBlOiBcInRyZW5kaW5nXCJcbiAgfSxcbiAge1xuICAgIGlkOiBcInRyZW5kaW5nLTRcIixcbiAgICBxdWVyeTogXCJQaW5jZWxlc1wiLFxuICAgIGNvdW50OiA4NyxcbiAgICBjYXRlZ29yeTogXCJoZXJyYW1pZW50YXNcIiwgXG4gICAgaHJlZjogXCIvc2VhcmNoP3E9cGluY2VsZXNcIixcbiAgICB0eXBlOiBcInRyZW5kaW5nXCJcbiAgfSxcbiAge1xuICAgIGlkOiBcInRyZW5kaW5nLTVcIixcbiAgICBxdWVyeTogXCJJbXBlcm1lYWJpbGl6YW50ZVwiLFxuICAgIGNvdW50OiA3NixcbiAgICBjYXRlZ29yeTogXCJwaW50dXJhc1wiLFxuICAgIGhyZWY6IFwiL3NlYXJjaD9xPWltcGVybWVhYmlsaXphbnRlXCIsXG4gICAgdHlwZTogXCJ0cmVuZGluZ1wiXG4gIH0sXG4gIHtcbiAgICBpZDogXCJ0cmVuZGluZy02XCIsXG4gICAgcXVlcnk6IFwiUGV0cmlsYWNcIixcbiAgICBjb3VudDogNjUsXG4gICAgY2F0ZWdvcnk6IFwibWFyY2FzXCIsXG4gICAgaHJlZjogXCIvc2VhcmNoP3E9cGV0cmlsYWNcIixcbiAgICB0eXBlOiBcInRyZW5kaW5nXCJcbiAgfVxuXTtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIEdFVChyZXF1ZXN0OiBOZXh0UmVxdWVzdCkge1xuICB0cnkge1xuICAgIGNvbnN0IHsgc2VhcmNoUGFyYW1zIH0gPSBuZXcgVVJMKHJlcXVlc3QudXJsKTtcbiAgICBjb25zdCBsaW1pdCA9IHBhcnNlSW50KHNlYXJjaFBhcmFtcy5nZXQoJ2xpbWl0JykgfHwgJzYnKTtcbiAgICBjb25zdCBkYXlzID0gcGFyc2VJbnQoc2VhcmNoUGFyYW1zLmdldCgnZGF5cycpIHx8ICc3Jyk7XG4gICAgY29uc3QgY2F0ZWdvcnkgPSBzZWFyY2hQYXJhbXMuZ2V0KCdjYXRlZ29yeScpO1xuXG4gICAgY29uc29sZS5sb2coJ/CflKUgQVBJIC9hcGkvc2VhcmNoL3RyZW5kaW5nOiBPYnRlbmllbmRvIGLDunNxdWVkYXMgdHJlbmRpbmcnLCB7XG4gICAgICBsaW1pdCxcbiAgICAgIGRheXMsXG4gICAgICBjYXRlZ29yeVxuICAgIH0pO1xuXG4gICAgY29uc3Qgc3VwYWJhc2UgPSBnZXRTdXBhYmFzZUNsaWVudCgpO1xuXG4gICAgbGV0IHRyZW5kaW5nU2VhcmNoZXM6IFRyZW5kaW5nU2VhcmNoW10gPSBbXTtcblxuICAgIC8vIEludGVudGFyIG9idGVuZXIgYsO6c3F1ZWRhcyB0cmVuZGluZyByZWFsZXMgZGVsIHNpc3RlbWEgZGUgYW5hbHl0aWNzXG4gICAgaWYgKHN1cGFiYXNlKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBzdGFydERhdGUgPSBuZXcgRGF0ZSgpO1xuICAgICAgICBzdGFydERhdGUuc2V0RGF0ZShzdGFydERhdGUuZ2V0RGF0ZSgpIC0gZGF5cyk7XG5cbiAgICAgICAgLy8gUXVlcnkgcGFyYSBvYnRlbmVyIGLDunNxdWVkYXMgbcOhcyBwb3B1bGFyZXMgZGUgYW5hbHl0aWNzX2V2ZW50c1xuICAgICAgICBsZXQgcXVlcnkgPSBzdXBhYmFzZVxuICAgICAgICAgIC5mcm9tKCdhbmFseXRpY3NfZXZlbnRzJylcbiAgICAgICAgICAuc2VsZWN0KCdsYWJlbCwgbWV0YWRhdGEnKVxuICAgICAgICAgIC5lcSgnY2F0ZWdvcnknLCAnc2VhcmNoJylcbiAgICAgICAgICAuZXEoJ2FjdGlvbicsICdzZWFyY2hfcXVlcnknKVxuICAgICAgICAgIC5ndGUoJ2NyZWF0ZWRfYXQnLCBzdGFydERhdGUudG9JU09TdHJpbmcoKSlcbiAgICAgICAgICAubm90KCdsYWJlbCcsICdpcycsIG51bGwpO1xuXG4gICAgICAgIGlmIChjYXRlZ29yeSkge1xuICAgICAgICAgIHF1ZXJ5ID0gcXVlcnkuZXEoJ21ldGFkYXRhLT4+Y2F0ZWdvcnknLCBjYXRlZ29yeSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB7IGRhdGE6IGFuYWx5dGljc0RhdGEsIGVycm9yIH0gPSBhd2FpdCBxdWVyeTtcblxuICAgICAgICBpZiAoIWVycm9yICYmIGFuYWx5dGljc0RhdGEgJiYgYW5hbHl0aWNzRGF0YS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgLy8gUHJvY2VzYXIgZGF0b3MgZGUgYW5hbHl0aWNzIHBhcmEgb2J0ZW5lciB0cmVuZGluZ1xuICAgICAgICAgIGNvbnN0IHNlYXJjaENvdW50cyA9IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XG4gICAgICAgICAgY29uc3Qgc2VhcmNoQ2F0ZWdvcmllcyA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XG5cbiAgICAgICAgICBhbmFseXRpY3NEYXRhLmZvckVhY2goKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBpZiAoZXZlbnQubGFiZWwpIHtcbiAgICAgICAgICAgICAgY29uc3QgcXVlcnkgPSBldmVudC5sYWJlbC50b0xvd2VyQ2FzZSgpLnRyaW0oKTtcbiAgICAgICAgICAgICAgaWYgKHF1ZXJ5Lmxlbmd0aCA+IDIpIHsgLy8gU29sbyBxdWVyaWVzIGRlIG3DoXMgZGUgMiBjYXJhY3RlcmVzXG4gICAgICAgICAgICAgICAgc2VhcmNoQ291bnRzLnNldChxdWVyeSwgKHNlYXJjaENvdW50cy5nZXQocXVlcnkpIHx8IDApICsgMSk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gRXh0cmFlciBjYXRlZ29yw61hIGRlbCBtZXRhZGF0YSBzaSBleGlzdGVcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQubWV0YWRhdGEgJiYgZXZlbnQubWV0YWRhdGEuY2F0ZWdvcnkpIHtcbiAgICAgICAgICAgICAgICAgIHNlYXJjaENhdGVnb3JpZXMuc2V0KHF1ZXJ5LCBldmVudC5tZXRhZGF0YS5jYXRlZ29yeSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICAvLyBDb252ZXJ0aXIgYSBhcnJheSB5IG9yZGVuYXIgcG9yIHBvcHVsYXJpZGFkXG4gICAgICAgICAgY29uc3Qgc29ydGVkU2VhcmNoZXMgPSBBcnJheS5mcm9tKHNlYXJjaENvdW50cy5lbnRyaWVzKCkpXG4gICAgICAgICAgICAuc29ydCgoYSwgYikgPT4gYlsxXSAtIGFbMV0pXG4gICAgICAgICAgICAuc2xpY2UoMCwgbGltaXQpO1xuXG4gICAgICAgICAgdHJlbmRpbmdTZWFyY2hlcyA9IHNvcnRlZFNlYXJjaGVzLm1hcCgoW3F1ZXJ5LCBjb3VudF0sIGluZGV4KSA9PiAoe1xuICAgICAgICAgICAgaWQ6IGB0cmVuZGluZy1yZWFsLSR7aW5kZXggKyAxfWAsXG4gICAgICAgICAgICBxdWVyeTogcXVlcnkuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBxdWVyeS5zbGljZSgxKSxcbiAgICAgICAgICAgIGNvdW50LFxuICAgICAgICAgICAgY2F0ZWdvcnk6IHNlYXJjaENhdGVnb3JpZXMuZ2V0KHF1ZXJ5KSxcbiAgICAgICAgICAgIGhyZWY6IGAvc2VhcmNoP3E9JHtlbmNvZGVVUklDb21wb25lbnQocXVlcnkpfWAsXG4gICAgICAgICAgICB0eXBlOiAndHJlbmRpbmcnIGFzIGNvbnN0XG4gICAgICAgICAgfSkpO1xuXG4gICAgICAgICAgY29uc29sZS5sb2coJ+KchSBCw7pzcXVlZGFzIHRyZW5kaW5nIG9idGVuaWRhcyBkZSBhbmFseXRpY3M6JywgdHJlbmRpbmdTZWFyY2hlcy5sZW5ndGgpO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChhbmFseXRpY3NFcnJvcikge1xuICAgICAgICBjb25zb2xlLndhcm4oJ+KaoO+4jyBFcnJvciBvYnRlbmllbmRvIHRyZW5kaW5nIGRlIGFuYWx5dGljcywgdXNhbmRvIGZhbGxiYWNrOicsIGFuYWx5dGljc0Vycm9yKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBTaSBubyBoYXkgZGF0b3MgcmVhbGVzIG8gaGF5IHBvY29zLCB1c2FyIGRhdG9zIHBvciBkZWZlY3RvXG4gICAgaWYgKHRyZW5kaW5nU2VhcmNoZXMubGVuZ3RoIDwgMykge1xuICAgICAgY29uc29sZS5sb2coJ/Cfk4sgVXNhbmRvIGLDunNxdWVkYXMgdHJlbmRpbmcgcG9yIGRlZmVjdG8nKTtcbiAgICAgIFxuICAgICAgbGV0IGZpbHRlcmVkRGVmYXVsdHMgPSBkZWZhdWx0VHJlbmRpbmdTZWFyY2hlcztcbiAgICAgIFxuICAgICAgLy8gRmlsdHJhciBwb3IgY2F0ZWdvcsOtYSBzaSBzZSBlc3BlY2lmaWNhXG4gICAgICBpZiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgZmlsdGVyZWREZWZhdWx0cyA9IGRlZmF1bHRUcmVuZGluZ1NlYXJjaGVzLmZpbHRlcihcbiAgICAgICAgICBzZWFyY2ggPT4gc2VhcmNoLmNhdGVnb3J5ID09PSBjYXRlZ29yeVxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgXG4gICAgICAvLyBDb21iaW5hciBkYXRvcyByZWFsZXMgY29uIGRlZmF1bHRzIHNpIGVzIG5lY2VzYXJpb1xuICAgICAgY29uc3QgbmVlZGVkID0gbGltaXQgLSB0cmVuZGluZ1NlYXJjaGVzLmxlbmd0aDtcbiAgICAgIGNvbnN0IGFkZGl0aW9uYWxTZWFyY2hlcyA9IGZpbHRlcmVkRGVmYXVsdHMuc2xpY2UoMCwgbmVlZGVkKTtcbiAgICAgIFxuICAgICAgdHJlbmRpbmdTZWFyY2hlcyA9IFsuLi50cmVuZGluZ1NlYXJjaGVzLCAuLi5hZGRpdGlvbmFsU2VhcmNoZXNdO1xuICAgIH1cblxuICAgIC8vIExpbWl0YXIgYWwgbsO6bWVybyBzb2xpY2l0YWRvXG4gICAgdHJlbmRpbmdTZWFyY2hlcyA9IHRyZW5kaW5nU2VhcmNoZXMuc2xpY2UoMCwgbGltaXQpO1xuXG4gICAgY29uc3QgcmVzcG9uc2U6IEFwaVJlc3BvbnNlPFRyZW5kaW5nU2VhcmNoZXNSZXNwb25zZT4gPSB7XG4gICAgICBkYXRhOiB7XG4gICAgICAgIHRyZW5kaW5nOiB0cmVuZGluZ1NlYXJjaGVzLFxuICAgICAgICBsYXN0VXBkYXRlZDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICB9LFxuICAgICAgc3VjY2VzczogdHJ1ZVxuICAgIH07XG5cbiAgICBjb25zb2xlLmxvZygn8J+UpSBUcmVuZGluZyBzZWFyY2hlcyByZXNwb25zZTonLCB7XG4gICAgICBjb3VudDogdHJlbmRpbmdTZWFyY2hlcy5sZW5ndGgsXG4gICAgICBoYXNSZWFsRGF0YTogdHJlbmRpbmdTZWFyY2hlcy5zb21lKHMgPT4gcy5pZC5pbmNsdWRlcygncmVhbCcpKSxcbiAgICAgIGNhdGVnb3JpZXM6IFsuLi5uZXcgU2V0KHRyZW5kaW5nU2VhcmNoZXMubWFwKHMgPT4gcy5jYXRlZ29yeSkuZmlsdGVyKEJvb2xlYW4pKV1cbiAgICB9KTtcblxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihyZXNwb25zZSk7XG5cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgZW4gL2FwaS9zZWFyY2gvdHJlbmRpbmc6JywgZXJyb3IpO1xuXG4gICAgLy8gRW4gY2FzbyBkZSBlcnJvciwgZGV2b2x2ZXIgYsO6c3F1ZWRhcyBwb3IgZGVmZWN0b1xuICAgIGNvbnN0IGZhbGxiYWNrUmVzcG9uc2U6IEFwaVJlc3BvbnNlPFRyZW5kaW5nU2VhcmNoZXNSZXNwb25zZT4gPSB7XG4gICAgICBkYXRhOiB7XG4gICAgICAgIHRyZW5kaW5nOiBkZWZhdWx0VHJlbmRpbmdTZWFyY2hlcy5zbGljZSgwLCBwYXJzZUludChyZXF1ZXN0Lm5leHRVcmwuc2VhcmNoUGFyYW1zLmdldCgnbGltaXQnKSB8fCAnNicpKSxcbiAgICAgICAgbGFzdFVwZGF0ZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgICAgfSxcbiAgICAgIHN1Y2Nlc3M6IHRydWVcbiAgICB9O1xuXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKGZhbGxiYWNrUmVzcG9uc2UpO1xuICB9XG59XG5cbi8vIE3DqXRvZG8gUE9TVCBwYXJhIHJlZ2lzdHJhciB1bmEgYsO6c3F1ZWRhIChwYXJhIGFuYWx5dGljcylcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBQT1NUKHJlcXVlc3Q6IE5leHRSZXF1ZXN0KSB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBxdWVyeSwgY2F0ZWdvcnksIHVzZXJJZCwgc2Vzc2lvbklkIH0gPSBhd2FpdCByZXF1ZXN0Lmpzb24oKTtcblxuICAgIGlmICghcXVlcnkgfHwgdHlwZW9mIHF1ZXJ5ICE9PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IGVycm9yOiAnUXVlcnkgZGUgYsO6c3F1ZWRhIHJlcXVlcmlkYScgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQwMCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2VDbGllbnQoKTtcblxuICAgIGlmIChzdXBhYmFzZSkge1xuICAgICAgLy8gUmVnaXN0cmFyIGxhIGLDunNxdWVkYSBlbiBhbmFseXRpY3NcbiAgICAgIGNvbnN0IHsgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgICAgIC5mcm9tKCdhbmFseXRpY3NfZXZlbnRzJylcbiAgICAgICAgLmluc2VydCh7XG4gICAgICAgICAgZXZlbnRfbmFtZTogJ3NlYXJjaF9xdWVyeScsXG4gICAgICAgICAgY2F0ZWdvcnk6ICdzZWFyY2gnLFxuICAgICAgICAgIGFjdGlvbjogJ3NlYXJjaF9xdWVyeScsXG4gICAgICAgICAgbGFiZWw6IHF1ZXJ5LnRvTG93ZXJDYXNlKCkudHJpbSgpLFxuICAgICAgICAgIHVzZXJfaWQ6IHVzZXJJZCxcbiAgICAgICAgICBzZXNzaW9uX2lkOiBzZXNzaW9uSWQgfHwgJ2Fub255bW91cycsXG4gICAgICAgICAgcGFnZTogJy9zZWFyY2gnLFxuICAgICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgICBjYXRlZ29yeTogY2F0ZWdvcnksXG4gICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciByZWdpc3RyYW5kbyBiw7pzcXVlZGEgZW4gYW5hbHl0aWNzOicsIGVycm9yKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCfinIUgQsO6c3F1ZWRhIHJlZ2lzdHJhZGEgZW4gYW5hbHl0aWNzOicsIHF1ZXJ5KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBzdWNjZXNzOiB0cnVlIH0pO1xuXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIHJlZ2lzdHJhbmRvIGLDunNxdWVkYTonLCBlcnJvcik7XG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgeyBlcnJvcjogJ0Vycm9yIGludGVybm8gZGVsIHNlcnZpZG9yJyB9LFxuICAgICAgeyBzdGF0dXM6IDUwMCB9XG4gICAgKTtcbiAgfVxufVxuIl0sIm5hbWVzIjpbIkdFVCIsIlBPU1QiLCJkZWZhdWx0VHJlbmRpbmdTZWFyY2hlcyIsImlkIiwicXVlcnkiLCJjb3VudCIsImNhdGVnb3J5IiwiaHJlZiIsInR5cGUiLCJyZXF1ZXN0Iiwic2VhcmNoUGFyYW1zIiwiVVJMIiwidXJsIiwibGltaXQiLCJwYXJzZUludCIsImdldCIsImRheXMiLCJjb25zb2xlIiwibG9nIiwic3VwYWJhc2UiLCJnZXRTdXBhYmFzZUNsaWVudCIsInRyZW5kaW5nU2VhcmNoZXMiLCJzdGFydERhdGUiLCJEYXRlIiwic2V0RGF0ZSIsImdldERhdGUiLCJmcm9tIiwic2VsZWN0IiwiZXEiLCJndGUiLCJ0b0lTT1N0cmluZyIsIm5vdCIsImRhdGEiLCJhbmFseXRpY3NEYXRhIiwiZXJyb3IiLCJsZW5ndGgiLCJzZWFyY2hDb3VudHMiLCJNYXAiLCJzZWFyY2hDYXRlZ29yaWVzIiwiZm9yRWFjaCIsImV2ZW50IiwibGFiZWwiLCJ0b0xvd2VyQ2FzZSIsInRyaW0iLCJzZXQiLCJtZXRhZGF0YSIsInNvcnRlZFNlYXJjaGVzIiwiQXJyYXkiLCJlbnRyaWVzIiwic29ydCIsImEiLCJiIiwic2xpY2UiLCJtYXAiLCJpbmRleCIsImNoYXJBdCIsInRvVXBwZXJDYXNlIiwiZW5jb2RlVVJJQ29tcG9uZW50IiwiYW5hbHl0aWNzRXJyb3IiLCJ3YXJuIiwiZmlsdGVyZWREZWZhdWx0cyIsImZpbHRlciIsInNlYXJjaCIsIm5lZWRlZCIsImFkZGl0aW9uYWxTZWFyY2hlcyIsInJlc3BvbnNlIiwidHJlbmRpbmciLCJsYXN0VXBkYXRlZCIsInN1Y2Nlc3MiLCJoYXNSZWFsRGF0YSIsInNvbWUiLCJzIiwiaW5jbHVkZXMiLCJjYXRlZ29yaWVzIiwiU2V0IiwiQm9vbGVhbiIsIk5leHRSZXNwb25zZSIsImpzb24iLCJmYWxsYmFja1Jlc3BvbnNlIiwibmV4dFVybCIsInVzZXJJZCIsInNlc3Npb25JZCIsInN0YXR1cyIsImluc2VydCIsImV2ZW50X25hbWUiLCJhY3Rpb24iLCJ1c2VyX2lkIiwic2Vzc2lvbl9pZCIs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