{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\lib\\analytics.ts"],"sourcesContent":["/**\r\n * Sistema de Analytics para Pinteya E-commerce\r\n * Tracking de eventos, métricas de conversión y análisis de comportamiento\r\n */\r\n\r\nexport interface AnalyticsEvent {\r\n  event: string;\r\n  category: string;\r\n  action: string;\r\n  label?: string;\r\n  value?: number;\r\n  userId?: string;\r\n  sessionId: string;\r\n  timestamp: number;\r\n  page: string;\r\n  userAgent: string;\r\n  metadata?: Record<string, any>;\r\n}\r\n\r\nexport interface ConversionMetrics {\r\n  cartAdditions: number;\r\n  cartRemovals: number;\r\n  checkoutStarts: number;\r\n  checkoutCompletions: number;\r\n  productViews: number;\r\n  categoryViews: number;\r\n  searchQueries: number;\r\n  conversionRate: number;\r\n  averageOrderValue: number;\r\n  cartAbandonmentRate: number;\r\n}\r\n\r\nexport interface UserInteraction {\r\n  type: 'click' | 'hover' | 'scroll' | 'focus' | 'input';\r\n  element: string;\r\n  x: number;\r\n  y: number;\r\n  timestamp: number;\r\n  page: string;\r\n  sessionId: string;\r\n}\r\n\r\nclass AnalyticsManager {\r\n  private events: AnalyticsEvent[] = [];\r\n  private interactions: UserInteraction[] = [];\r\n  private sessionId: string;\r\n  private isEnabled: boolean = true;\r\n  private isInitialized: boolean = false;\r\n  private initializationPromise: Promise<void> | null = null;\r\n\r\n  constructor() {\r\n    this.sessionId = this.generateSessionId();\r\n    // No inicializar automáticamente - usar lazy initialization\r\n  }\r\n\r\n  private generateSessionId(): string {\r\n    return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n  }\r\n\r\n  private async ensureInitialized(): Promise<void> {\r\n    // Si ya está inicializado, no hacer nada\r\n    if (this.isInitialized) return;\r\n\r\n    // Si ya hay una inicialización en progreso, esperar a que termine\r\n    if (this.initializationPromise) {\r\n      return this.initializationPromise;\r\n    }\r\n\r\n    // Crear la promesa de inicialización\r\n    this.initializationPromise = this.initializeTracking();\r\n\r\n    try {\r\n      await this.initializationPromise;\r\n    } catch (error) {\r\n      // En caso de error, limpiar la promesa para permitir reintentos\r\n      this.initializationPromise = null;\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private async initializeTracking(): Promise<void> {\r\n    if (typeof window === 'undefined') return;\r\n    if (this.isInitialized) return;\r\n\r\n    try {\r\n      // Esperar a que el DOM esté listo\r\n      if (document.readyState === 'loading') {\r\n        await new Promise(resolve => {\r\n          document.addEventListener('DOMContentLoaded', resolve, { once: true });\r\n        });\r\n      }\r\n\r\n      // Marcar como inicializado ANTES de hacer cualquier tracking\r\n      // para evitar recursión infinita\r\n      this.isInitialized = true;\r\n\r\n      // Track page views automáticamente (ahora que ya está inicializado)\r\n      this.trackPageView();\r\n\r\n      // Track clicks globalmente\r\n      document.addEventListener('click', this.handleClick.bind(this));\r\n\r\n      // Track scroll events\r\n      let scrollTimeout: NodeJS.Timeout;\r\n      document.addEventListener('scroll', () => {\r\n        clearTimeout(scrollTimeout);\r\n        scrollTimeout = setTimeout(() => {\r\n          this.trackInteraction('scroll', 'page', window.scrollX, window.scrollY);\r\n        }, 100);\r\n      });\r\n\r\n      // Track form interactions\r\n      document.addEventListener('input', this.handleInput.bind(this));\r\n      document.addEventListener('focus', this.handleFocus.bind(this));\r\n\r\n    } catch (error) {\r\n      console.warn('Error initializing analytics tracking:', error);\r\n      // En caso de error, resetear el estado de inicialización\r\n      this.isInitialized = false;\r\n    }\r\n  }\r\n\r\n  private handleClick(event: MouseEvent): void {\r\n    const target = event.target as HTMLElement;\r\n    const elementInfo = this.getElementInfo(target);\r\n    \r\n    this.trackInteraction('click', elementInfo, event.clientX, event.clientY);\r\n    \r\n    // Track specific e-commerce events\r\n    if (target.closest('[data-analytics=\"add-to-cart\"]')) {\r\n      this.trackEcommerceEvent('add_to_cart', {\r\n        productId: target.getAttribute('data-product-id'),\r\n        productName: target.getAttribute('data-product-name'),\r\n        price: target.getAttribute('data-product-price'),\r\n      });\r\n    }\r\n    \r\n    if (target.closest('[data-analytics=\"remove-from-cart\"]')) {\r\n      this.trackEcommerceEvent('remove_from_cart', {\r\n        productId: target.getAttribute('data-product-id'),\r\n      });\r\n    }\r\n    \r\n    if (target.closest('[data-analytics=\"checkout-start\"]')) {\r\n      this.trackEcommerceEvent('begin_checkout', {\r\n        cartValue: target.getAttribute('data-cart-value'),\r\n        itemCount: target.getAttribute('data-item-count'),\r\n      });\r\n    }\r\n  }\r\n\r\n  private handleInput(event: Event): void {\r\n    const target = event.target as HTMLElement;\r\n    const elementInfo = this.getElementInfo(target);\r\n    this.trackInteraction('input', elementInfo, 0, 0);\r\n  }\r\n\r\n  private handleFocus(event: FocusEvent): void {\r\n    const target = event.target as HTMLElement;\r\n    const elementInfo = this.getElementInfo(target);\r\n    this.trackInteraction('focus', elementInfo, 0, 0);\r\n  }\r\n\r\n  private getElementInfo(element: HTMLElement): string {\r\n    const id = element.id ? `#${element.id}` : '';\r\n\r\n    // Manejar className que puede ser string o DOMTokenList\r\n    let className = '';\r\n    if (element.className) {\r\n      // Si className es un DOMTokenList, convertir a string\r\n      const classNameValue = element.className as string | DOMTokenList;\r\n      const classNameStr = typeof classNameValue === 'string'\r\n        ? classNameValue\r\n        : classNameValue.toString();\r\n\r\n      // Solo procesar si hay clases\r\n      if (classNameStr.trim()) {\r\n        className = `.${classNameStr.split(' ').filter(cls => cls.trim()).join('.')}`;\r\n      }\r\n    }\r\n\r\n    const tagName = element.tagName.toLowerCase();\r\n    const dataAnalytics = element.getAttribute('data-analytics') || '';\r\n\r\n    return `${tagName}${id}${className}${dataAnalytics ? `[${dataAnalytics}]` : ''}`;\r\n  }\r\n\r\n  public async trackEvent(\r\n    event: string,\r\n    category: string,\r\n    action: string,\r\n    label?: string,\r\n    value?: number,\r\n    metadata?: Record<string, any>\r\n  ): Promise<void> {\r\n    if (!this.isEnabled) return;\r\n\r\n    // Solo inicializar si no está ya inicializado para evitar recursión\r\n    if (!this.isInitialized) {\r\n      await this.ensureInitialized();\r\n    }\r\n\r\n    const analyticsEvent: AnalyticsEvent = {\r\n      event,\r\n      category,\r\n      action,\r\n      label,\r\n      value,\r\n      sessionId: this.sessionId,\r\n      timestamp: Date.now(),\r\n      page: typeof window !== 'undefined' ? window.location.pathname : '',\r\n      userAgent: typeof window !== 'undefined' ? window.navigator.userAgent : '',\r\n      metadata,\r\n    };\r\n\r\n    this.events.push(analyticsEvent);\r\n    this.sendToAnalytics(analyticsEvent);\r\n  }\r\n\r\n  public async trackEcommerceEvent(action: string, data: Record<string, any>): Promise<void> {\r\n    await this.trackEvent('ecommerce', 'shop', action, undefined, undefined, data);\r\n  }\r\n\r\n  public async trackPageView(page?: string): Promise<void> {\r\n    const currentPage = page || (typeof window !== 'undefined' ? window.location.pathname : '');\r\n    await this.trackEvent('page_view', 'navigation', 'view', currentPage);\r\n  }\r\n\r\n  public async trackInteraction(\r\n    type: UserInteraction['type'],\r\n    element: string,\r\n    x: number,\r\n    y: number\r\n  ): Promise<void> {\r\n    if (!this.isEnabled) return;\r\n\r\n    // Solo inicializar si no está ya inicializado para evitar recursión\r\n    if (!this.isInitialized) {\r\n      await this.ensureInitialized();\r\n    }\r\n\r\n    const interaction: UserInteraction = {\r\n      type,\r\n      element,\r\n      x,\r\n      y,\r\n      timestamp: Date.now(),\r\n      page: typeof window !== 'undefined' ? window.location.pathname : '',\r\n      sessionId: this.sessionId,\r\n    };\r\n\r\n    this.interactions.push(interaction);\r\n  }\r\n\r\n  public async trackConversion(type: string, value?: number, metadata?: Record<string, any>): Promise<void> {\r\n    await this.trackEvent('conversion', 'ecommerce', type, undefined, value, metadata);\r\n  }\r\n\r\n  private sendToAnalytics(event: AnalyticsEvent): void {\r\n    // Solo ejecutar en el cliente\r\n    if (typeof window === 'undefined') return;\r\n\r\n    // Enviar a Google Analytics 4\r\n    if ((window as any).gtag) {\r\n      try {\r\n        (window as any).gtag('event', event.action, {\r\n          event_category: event.category,\r\n          event_label: event.label,\r\n          value: event.value,\r\n          custom_parameter_session_id: event.sessionId,\r\n          ...event.metadata,\r\n        });\r\n      } catch (error) {\r\n        console.warn('Error sending event to GA:', error);\r\n      }\r\n    }\r\n\r\n    // Enviar a nuestro endpoint interno con mejor manejo de errores\r\n    this.sendToInternalAPI(event);\r\n  }\r\n\r\n  private eventQueue: AnalyticsEvent[] = [];\r\n  private isProcessingQueue: boolean = false;\r\n  private queueTimeout: NodeJS.Timeout | null = null;\r\n\r\n  private async sendToInternalAPI(event: AnalyticsEvent): Promise<void> {\r\n    // Agregar evento a la cola en lugar de enviarlo inmediatamente\r\n    this.eventQueue.push(event);\r\n\r\n    // Procesar la cola con debounce\r\n    this.debouncedProcessQueue();\r\n  }\r\n\r\n  private debouncedProcessQueue(): void {\r\n    if (this.queueTimeout) {\r\n      clearTimeout(this.queueTimeout);\r\n    }\r\n\r\n    this.queueTimeout = setTimeout(() => {\r\n      this.processEventQueue();\r\n    }, 100); // Debounce de 100ms\r\n  }\r\n\r\n  private async processEventQueue(): Promise<void> {\r\n    if (this.isProcessingQueue || this.eventQueue.length === 0) return;\r\n    if (typeof window === 'undefined') return;\r\n\r\n    this.isProcessingQueue = true;\r\n\r\n    try {\r\n      // Verificar que el documento está listo\r\n      if (document.readyState === 'loading') {\r\n        await new Promise(resolve => {\r\n          document.addEventListener('DOMContentLoaded', resolve, { once: true });\r\n        });\r\n      }\r\n\r\n      // Procesar eventos en lotes\r\n      const eventsToProcess = [...this.eventQueue];\r\n      this.eventQueue = [];\r\n\r\n      // Enviar eventos en lotes de 5 para evitar rate limiting\r\n      const batchSize = 5;\r\n      for (let i = 0; i < eventsToProcess.length; i += batchSize) {\r\n        const batch = eventsToProcess.slice(i, i + batchSize);\r\n\r\n        for (const event of batch) {\r\n          try {\r\n            const response = await fetch('/api/analytics/events', {\r\n              method: 'POST',\r\n              headers: {\r\n                'Content-Type': 'application/json',\r\n              },\r\n              body: JSON.stringify(event),\r\n            });\r\n\r\n            if (!response.ok) {\r\n              throw new Error(`HTTP error! status: ${response.status}`);\r\n            }\r\n          } catch (error) {\r\n            // En caso de error, almacenar el evento para reintento\r\n            this.storeEventForRetry(event);\r\n          }\r\n        }\r\n\r\n        // Pausa entre lotes para evitar rate limiting\r\n        if (i + batchSize < eventsToProcess.length) {\r\n          await new Promise(resolve => setTimeout(resolve, 50));\r\n        }\r\n      }\r\n    } catch (error) {\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.warn('Analytics queue processing error (non-critical):', error);\r\n      }\r\n    } finally {\r\n      this.isProcessingQueue = false;\r\n    }\r\n  }\r\n\r\n  private storeEventForRetry(event: AnalyticsEvent): void {\r\n    try {\r\n      if (typeof window !== 'undefined' && window.localStorage) {\r\n        // Usar parsing seguro para evitar errores JSON\r\n        const stored = localStorage.getItem('analytics_failed_events') || '[]';\r\n        let failedEvents: AnalyticsEvent[] = [];\r\n\r\n        try {\r\n          failedEvents = JSON.parse(stored);\r\n          // Verificar que sea un array válido\r\n          if (!Array.isArray(failedEvents)) {\r\n            failedEvents = [];\r\n          }\r\n        } catch (parseError) {\r\n          console.warn('Error parsing analytics failed events, resetting:', parseError);\r\n          failedEvents = [];\r\n        }\r\n\r\n        failedEvents.push(event);\r\n\r\n        // Limitar a los últimos 50 eventos fallidos\r\n        if (failedEvents.length > 50) {\r\n          failedEvents.splice(0, failedEvents.length - 50);\r\n        }\r\n\r\n        localStorage.setItem('analytics_failed_events', JSON.stringify(failedEvents));\r\n      }\r\n    } catch (error) {\r\n      // Ignorar errores de localStorage\r\n      console.warn('Error storing analytics event for retry:', error);\r\n    }\r\n  }\r\n\r\n  public getEvents(): AnalyticsEvent[] {\r\n    return [...this.events];\r\n  }\r\n\r\n  public getInteractions(): UserInteraction[] {\r\n    return [...this.interactions];\r\n  }\r\n\r\n  public getSessionId(): string {\r\n    return this.sessionId;\r\n  }\r\n\r\n  public clearData(): void {\r\n    this.events = [];\r\n    this.interactions = [];\r\n    this.eventQueue = [];\r\n\r\n    // Limpiar timeouts\r\n    if (this.queueTimeout) {\r\n      clearTimeout(this.queueTimeout);\r\n      this.queueTimeout = null;\r\n    }\r\n  }\r\n\r\n  public disable(): void {\r\n    this.isEnabled = false;\r\n  }\r\n\r\n  public enable(): void {\r\n    this.isEnabled = true;\r\n  }\r\n\r\n  public async initialize(): Promise<void> {\r\n    await this.ensureInitialized();\r\n  }\r\n\r\n  public getConversionMetrics(): ConversionMetrics {\r\n    const ecommerceEvents = this.events.filter(e => e.category === 'shop');\r\n    \r\n    const cartAdditions = ecommerceEvents.filter(e => e.action === 'add_to_cart').length;\r\n    const cartRemovals = ecommerceEvents.filter(e => e.action === 'remove_from_cart').length;\r\n    const checkoutStarts = ecommerceEvents.filter(e => e.action === 'begin_checkout').length;\r\n    const checkoutCompletions = ecommerceEvents.filter(e => e.action === 'purchase').length;\r\n    const productViews = this.events.filter(e => e.category === 'navigation' && e.label?.includes('/product/')).length;\r\n    const categoryViews = this.events.filter(e => e.category === 'navigation' && e.label?.includes('/category/')).length;\r\n    const searchQueries = ecommerceEvents.filter(e => e.action === 'search').length;\r\n\r\n    const conversionRate = checkoutStarts > 0 ? (checkoutCompletions / checkoutStarts) * 100 : 0;\r\n    const cartAbandonmentRate = cartAdditions > 0 ? ((cartAdditions - checkoutCompletions) / cartAdditions) * 100 : 0;\r\n    \r\n    // Calcular AOV desde los eventos de compra\r\n    const purchaseEvents = ecommerceEvents.filter(e => e.action === 'purchase');\r\n    const totalValue = purchaseEvents.reduce((sum, event) => sum + (event.value || 0), 0);\r\n    const averageOrderValue = purchaseEvents.length > 0 ? totalValue / purchaseEvents.length : 0;\r\n\r\n    return {\r\n      cartAdditions,\r\n      cartRemovals,\r\n      checkoutStarts,\r\n      checkoutCompletions,\r\n      productViews,\r\n      categoryViews,\r\n      searchQueries,\r\n      conversionRate,\r\n      averageOrderValue,\r\n      cartAbandonmentRate,\r\n    };\r\n  }\r\n}\r\n\r\n// Singleton instance\r\nexport const analytics = new AnalyticsManager();\r\n\r\n// Utility functions con manejo de errores\r\nexport const trackEvent = async (\r\n  event: string,\r\n  category: string,\r\n  action: string,\r\n  label?: string,\r\n  value?: number,\r\n  metadata?: Record<string, any>\r\n): Promise<void> => {\r\n  try {\r\n    await optimizedAnalytics.trackEvent(event, category, action, label, value, metadata);\r\n  } catch (error) {\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.warn('Analytics trackEvent error:', error);\r\n    }\r\n  }\r\n};\r\n\r\nexport const trackEcommerceEvent = async (action: string, data: Record<string, any>): Promise<void> => {\r\n  try {\r\n    await analytics.trackEcommerceEvent(action, data);\r\n  } catch (error) {\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.warn('Analytics trackEcommerceEvent error:', error);\r\n    }\r\n  }\r\n};\r\n\r\nexport const trackPageView = async (page?: string): Promise<void> => {\r\n  try {\r\n    await analytics.trackPageView(page);\r\n  } catch (error) {\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.warn('Analytics trackPageView error:', error);\r\n    }\r\n  }\r\n};\r\n\r\nexport const trackConversion = async (type: string, value?: number, metadata?: Record<string, any>): Promise<void> => {\r\n  try {\r\n    await analytics.trackConversion(type, value, metadata);\r\n  } catch (error) {\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.warn('Analytics trackConversion error:', error);\r\n    }\r\n  }\r\n};\r\n\r\nexport const initializeAnalytics = async (): Promise<void> => {\r\n  try {\r\n    await analytics.initialize();\r\n  } catch (error) {\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.warn('Analytics initialization error:', error);\r\n    }\r\n  }\r\n};\r\n"],"names":["analytics","initializeAnalytics","trackConversion","trackEcommerceEvent","trackEvent","trackPageView","AnalyticsManager","constructor","events","interactions","isEnabled","isInitialized","initializationPromise","eventQueue","isProcessingQueue","queueTimeout","sessionId","generateSessionId","Date","now","Math","random","toString","substr","ensureInitialized","initializeTracking","error","window","document","readyState","Promise","resolve","addEventListener","once","handleClick","bind","scrollTimeout","clearTimeout","setTimeout","trackInteraction","scrollX","scrollY","handleInput","handleFocus","console","warn","event","target","elementInfo","getElementInfo","clientX","clientY","closest","productId","getAttribute","productName","price","cartValue","itemCount","element","id","className","classNameValue","classNameStr","trim","split","filter","cls","join","tagName","toLowerCase","dataAnalytics","category","action","label","value","metadata","analyticsEvent","timestamp","page","location","pathname","userAgent","navigator","push","sendToAnalytics","data","undefined","currentPage","type","x","y","interaction","gtag","event_category","event_label","custom_parameter_session_id","sendToInternalAPI","debouncedProcessQueue","processEventQueue","length","eventsToProcess","batchSize","i","batch","slice","response","fetch","method","headers","body","JSON","stringify","ok","Error","status","storeEventForRetry","process","env","NODE_ENV","localStorage","stored","getItem","failedEvents","parse","Array","isArray","parseError","splice","setItem","getEvents","getInteractions","getSessionId","clearData","disable","enable","initialize","getConversionMetrics","ecommerceEvents","e","cartAdditions","cartRemovals","checkoutStarts","checkoutCompletions","productViews","includes","categoryViews","searchQueries","conversionRate","cartAbandonmentRate","purchaseEvents","totalValue","reduce","sum","averageOrderValue","optimizedAnalytics"],"mappings":"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"}