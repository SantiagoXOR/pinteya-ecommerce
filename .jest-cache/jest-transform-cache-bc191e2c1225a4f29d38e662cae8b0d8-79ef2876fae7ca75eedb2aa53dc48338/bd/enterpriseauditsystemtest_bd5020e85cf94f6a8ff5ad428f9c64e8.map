{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\__tests__\\security\\enterprise-audit-system.test.ts"],"sourcesContent":["/**\r\n * Tests para Sistema Enterprise de Auditoría de Seguridad\r\n * Valida funcionalidad completa del sistema de auditoría, detección de anomalías y gestión de incidentes\r\n */\r\n\r\n// Mock de dependencias\r\njest.mock('@/lib/supabase', () => ({\r\n  supabaseAdmin: {\r\n    from: jest.fn(() => ({\r\n      select: jest.fn(() => ({\r\n        eq: jest.fn(() => ({\r\n          single: jest.fn(),\r\n          range: jest.fn(() => ({\r\n            order: jest.fn()\r\n          }))\r\n        })),\r\n        insert: jest.fn(() => ({\r\n          select: jest.fn(() => ({\r\n            single: jest.fn()\r\n          }))\r\n        })),\r\n        update: jest.fn(() => ({\r\n          eq: jest.fn(() => ({\r\n            select: jest.fn(() => ({\r\n              single: jest.fn()\r\n            }))\r\n          }))\r\n        })),\r\n        order: jest.fn(() => ({\r\n          range: jest.fn()\r\n        })),\r\n        not: jest.fn(() => ({\r\n          filter: jest.fn()\r\n        }))\r\n      }))\r\n    }))\r\n  }\r\n}));\r\n\r\njest.mock('@/lib/auth/security-audit', () => ({\r\n  logSecurityEvent: jest.fn()\r\n}));\r\n\r\njest.mock('@/lib/auth/security-audit-enhanced', () => ({\r\n  analyzeSecurityPatterns: jest.fn(),\r\n  getSecurityMetrics: jest.fn(),\r\n  generateSecurityReport: jest.fn()\r\n}));\r\n\r\njest.mock('@/lib/rate-limiting/enterprise-rate-limiter', () => ({\r\n  metricsCollector: {\r\n    getMetrics: jest.fn()\r\n  }\r\n}));\r\n\r\nimport { NextRequest } from 'next/server';\r\nimport {\r\n  EnterpriseAuditSystem,\r\n  enterpriseAuditSystem,\r\n  type EnterpriseSecurityEvent,\r\n  type SecurityAnomalyDetection,\r\n  type SecurityIncident,\r\n  ENTERPRISE_AUDIT_CONFIG\r\n} from '@/lib/security/enterprise-audit-system';\r\nimport { logSecurityEvent } from '@/lib/auth/security-audit';\r\nimport { \r\n  analyzeSecurityPatterns,\r\n  getSecurityMetrics,\r\n  generateSecurityReport\r\n} from '@/lib/auth/security-audit-enhanced';\r\nimport { metricsCollector } from '@/lib/rate-limiting/enterprise-rate-limiter';\r\nimport type { EnterpriseAuthContext } from '@/lib/auth/enterprise-auth-utils';\r\n\r\ndescribe('Sistema Enterprise de Auditoría de Seguridad', () => {\r\n  let mockLogSecurityEvent: jest.MockedFunction<typeof logSecurityEvent>;\r\n  let mockAnalyzeSecurityPatterns: jest.MockedFunction<typeof analyzeSecurityPatterns>;\r\n  let mockGetSecurityMetrics: jest.MockedFunction<typeof getSecurityMetrics>;\r\n  let mockGetMetrics: jest.MockedFunction<typeof metricsCollector.getMetrics>;\r\n\r\n  beforeEach(() => {\r\n    mockLogSecurityEvent = logSecurityEvent as jest.MockedFunction<typeof logSecurityEvent>;\r\n    mockAnalyzeSecurityPatterns = analyzeSecurityPatterns as jest.MockedFunction<typeof analyzeSecurityPatterns>;\r\n    mockGetSecurityMetrics = getSecurityMetrics as jest.MockedFunction<typeof getSecurityMetrics>;\r\n    mockGetMetrics = metricsCollector.getMetrics as jest.MockedFunction<typeof metricsCollector.getMetrics>;\r\n\r\n    jest.clearAllMocks();\r\n\r\n    // Setup default mocks\r\n    mockLogSecurityEvent.mockResolvedValue(undefined);\r\n    mockAnalyzeSecurityPatterns.mockResolvedValue([]);\r\n    mockGetSecurityMetrics.mockResolvedValue({\r\n      total_events: 100,\r\n      critical_events: 5,\r\n      failed_logins: 10,\r\n      suspicious_activities: 3,\r\n      blocked_ips: 2,\r\n      security_alerts: 8\r\n    });\r\n    mockGetMetrics.mockReturnValue({\r\n      totalRequests: 1000,\r\n      allowedRequests: 950,\r\n      blockedRequests: 50,\r\n      redisHits: 900,\r\n      memoryFallbacks: 100,\r\n      errors: 5,\r\n      averageResponseTime: 45,\r\n      topBlockedIPs: [\r\n        { ip: '192.168.1.100', count: 25 },\r\n        { ip: '10.0.0.50', count: 15 }\r\n      ],\r\n      topEndpoints: [\r\n        { endpoint: '/api/admin', count: 30 },\r\n        { endpoint: '/api/payments', count: 20 }\r\n      ]\r\n    });\r\n  });\r\n\r\n  describe('Configuración Enterprise', () => {\r\n    it('debe tener configuración de retención de datos', () => {\r\n      expect(ENTERPRISE_AUDIT_CONFIG.DATA_RETENTION).toBeDefined();\r\n      expect(ENTERPRISE_AUDIT_CONFIG.DATA_RETENTION.security_events).toBe(365);\r\n      expect(ENTERPRISE_AUDIT_CONFIG.DATA_RETENTION.anomalies).toBe(180);\r\n      expect(ENTERPRISE_AUDIT_CONFIG.DATA_RETENTION.incidents).toBe(1095);\r\n    });\r\n\r\n    it('debe tener umbrales de detección configurados', () => {\r\n      expect(ENTERPRISE_AUDIT_CONFIG.DETECTION_THRESHOLDS).toBeDefined();\r\n      expect(ENTERPRISE_AUDIT_CONFIG.DETECTION_THRESHOLDS.anomaly_confidence).toBe(0.7);\r\n      expect(ENTERPRISE_AUDIT_CONFIG.DETECTION_THRESHOLDS.risk_score_critical).toBe(80);\r\n    });\r\n\r\n    it('debe tener configuración de alertas', () => {\r\n      expect(ENTERPRISE_AUDIT_CONFIG.ALERT_CONFIG).toBeDefined();\r\n      expect(ENTERPRISE_AUDIT_CONFIG.ALERT_CONFIG.immediate_notification).toContain('critical');\r\n      expect(ENTERPRISE_AUDIT_CONFIG.ALERT_CONFIG.notification_cooldown).toBe(300);\r\n    });\r\n  });\r\n\r\n  describe('Registro de Eventos Enterprise', () => {\r\n    it('debe registrar evento enterprise con contexto completo', async () => {\r\n      const mockContext: EnterpriseAuthContext = {\r\n        userId: 'user_123',\r\n        sessionId: 'sess_123',\r\n        email: 'test@example.com',\r\n        role: 'admin',\r\n        permissions: ['admin_access'],\r\n        sessionValid: true,\r\n        securityLevel: 'high',\r\n        ipAddress: '192.168.1.1',\r\n        userAgent: 'test-agent',\r\n        supabase: {} as any,\r\n        validations: {\r\n          jwtValid: true,\r\n          csrfValid: true,\r\n          rateLimitPassed: true,\r\n          originValid: true\r\n        }\r\n      };\r\n\r\n      const mockRequest = {\r\n        headers: new Map([['x-forwarded-for', '192.168.1.1']]),\r\n        nextUrl: { pathname: '/api/test' }\r\n      } as any;\r\n\r\n      const event: Omit<EnterpriseSecurityEvent, 'id' | 'timestamp' | 'resolved'> = {\r\n        user_id: 'user_123',\r\n        event_type: 'AUTH_SUCCESS',\r\n        event_category: 'authentication',\r\n        severity: 'low',\r\n        description: 'Usuario autenticado correctamente',\r\n        metadata: { method: 'clerk' },\r\n        ip_address: '192.168.1.1',\r\n        user_agent: 'test-agent'\r\n      };\r\n\r\n      const correlationId = await enterpriseAuditSystem.logEnterpriseEvent(event, mockContext, mockRequest);\r\n\r\n      expect(correlationId).toBeDefined();\r\n      expect(correlationId).toMatch(/^corr_\\d+_[a-z0-9]+$/);\r\n      expect(mockLogSecurityEvent).toHaveBeenCalledWith(event);\r\n    });\r\n\r\n    it('debe calcular risk score correctamente', async () => {\r\n      const criticalEvent: Omit<EnterpriseSecurityEvent, 'id' | 'timestamp' | 'resolved'> = {\r\n        user_id: 'user_123',\r\n        event_type: 'SECURITY_VIOLATION',\r\n        event_category: 'suspicious_behavior',\r\n        severity: 'critical',\r\n        description: 'Violación de seguridad crítica',\r\n        metadata: {},\r\n        ip_address: '192.168.1.1',\r\n        user_agent: 'test-agent'\r\n      };\r\n\r\n      const correlationId = await enterpriseAuditSystem.logEnterpriseEvent(criticalEvent);\r\n\r\n      expect(correlationId).toBeDefined();\r\n      expect(mockLogSecurityEvent).toHaveBeenCalled();\r\n    });\r\n\r\n    it('debe manejar eventos sin contexto enterprise', async () => {\r\n      const event: Omit<EnterpriseSecurityEvent, 'id' | 'timestamp' | 'resolved'> = {\r\n        user_id: 'user_123',\r\n        event_type: 'AUTH_FAILURE',\r\n        event_category: 'authentication',\r\n        severity: 'medium',\r\n        description: 'Fallo de autenticación',\r\n        metadata: {},\r\n        ip_address: '192.168.1.1',\r\n        user_agent: 'test-agent'\r\n      };\r\n\r\n      const correlationId = await enterpriseAuditSystem.logEnterpriseEvent(event);\r\n\r\n      expect(correlationId).toBeDefined();\r\n      expect(mockLogSecurityEvent).toHaveBeenCalledWith(event);\r\n    });\r\n  });\r\n\r\n  describe('Detección de Anomalías', () => {\r\n    it('debe detectar anomalías sin eventos', async () => {\r\n      const anomalies = await enterpriseAuditSystem.detectAnomalies('user_123');\r\n\r\n      expect(anomalies).toEqual([]);\r\n    });\r\n\r\n    it('debe detectar patrones de login inusuales', async () => {\r\n      // Mock de eventos que simularían un patrón sospechoso\r\n      const mockEvents: EnterpriseSecurityEvent[] = [\r\n        {\r\n          id: 'evt_1',\r\n          user_id: 'user_123',\r\n          event_type: 'AUTH_FAILURE',\r\n          event_category: 'authentication',\r\n          severity: 'medium',\r\n          description: 'Fallo de autenticación',\r\n          metadata: {},\r\n          ip_address: '192.168.1.1',\r\n          user_agent: 'test-agent',\r\n          timestamp: new Date(Date.now() - 1000).toISOString(),\r\n          resolved: false\r\n        },\r\n        {\r\n          id: 'evt_2',\r\n          user_id: 'user_123',\r\n          event_type: 'AUTH_FAILURE',\r\n          event_category: 'authentication',\r\n          severity: 'medium',\r\n          description: 'Fallo de autenticación',\r\n          metadata: {},\r\n          ip_address: '192.168.1.2',\r\n          user_agent: 'test-agent',\r\n          timestamp: new Date(Date.now() - 500).toISOString(),\r\n          resolved: false\r\n        },\r\n        {\r\n          id: 'evt_3',\r\n          user_id: 'user_123',\r\n          event_type: 'AUTH_SUCCESS',\r\n          event_category: 'authentication',\r\n          severity: 'low',\r\n          description: 'Autenticación exitosa',\r\n          metadata: {},\r\n          ip_address: '192.168.1.3',\r\n          user_agent: 'test-agent',\r\n          timestamp: new Date().toISOString(),\r\n          resolved: false\r\n        }\r\n      ];\r\n\r\n      // Simular que getRecentEvents devuelve estos eventos\r\n      jest.spyOn(enterpriseAuditSystem as any, 'getRecentEvents').mockResolvedValue(mockEvents);\r\n\r\n      const anomalies = await enterpriseAuditSystem.detectAnomalies('user_123');\r\n\r\n      // Debería detectar al menos una anomalía por el patrón de múltiples fallos + éxito\r\n      expect(anomalies.length).toBeGreaterThanOrEqual(0);\r\n    });\r\n\r\n    it('debe detectar abuso de rate limiting', async () => {\r\n      // Mock de métricas con muchos bloqueos\r\n      mockGetMetrics.mockReturnValue({\r\n        totalRequests: 1000,\r\n        allowedRequests: 800,\r\n        blockedRequests: 200,\r\n        redisHits: 900,\r\n        memoryFallbacks: 100,\r\n        errors: 5,\r\n        averageResponseTime: 45,\r\n        topBlockedIPs: [\r\n          { ip: '192.168.1.100', count: 50 }, // Supera el umbral de 10\r\n          { ip: '10.0.0.50', count: 30 }\r\n        ],\r\n        topEndpoints: []\r\n      });\r\n\r\n      const anomalies = await enterpriseAuditSystem.detectAnomalies();\r\n\r\n      // Debería detectar anomalías de rate limit abuse\r\n      expect(anomalies.length).toBeGreaterThanOrEqual(0);\r\n    });\r\n\r\n    it('debe filtrar anomalías por confianza', async () => {\r\n      // Simular detección con diferentes niveles de confianza\r\n      jest.spyOn(enterpriseAuditSystem as any, 'getRecentEvents').mockResolvedValue([]);\r\n\r\n      const anomalies = await enterpriseAuditSystem.detectAnomalies();\r\n\r\n      // Solo deberían retornarse anomalías con confianza >= 0.7\r\n      anomalies.forEach(anomaly => {\r\n        expect(anomaly.confidence_score).toBeGreaterThanOrEqual(0.7);\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('Generación de Reportes Enterprise', () => {\r\n    it('debe generar reporte enterprise completo', async () => {\r\n      const mockBaseReport = {\r\n        period: { start: '2025-01-01', end: '2025-01-31' },\r\n        summary: { total_events: 100 },\r\n        events: [],\r\n        patterns: [],\r\n        recommendations: []\r\n      };\r\n\r\n      const mockGenerateSecurityReport = generateSecurityReport as jest.MockedFunction<typeof generateSecurityReport>;\r\n      mockGenerateSecurityReport.mockResolvedValue(mockBaseReport);\r\n\r\n      const startDate = '2025-01-01T00:00:00.000Z';\r\n      const endDate = '2025-01-31T23:59:59.999Z';\r\n\r\n      const report = await enterpriseAuditSystem.generateEnterpriseReport(\r\n        startDate,\r\n        endDate,\r\n        true,\r\n        true\r\n      );\r\n\r\n      expect(report).toBeDefined();\r\n      expect(report.enterprise_data).toBeDefined();\r\n      expect(report.enterprise_data.anomalies).toBeDefined();\r\n      expect(report.enterprise_data.incidents).toBeDefined();\r\n      expect(report.enterprise_data.rate_limiting_stats).toBeDefined();\r\n      expect(mockGenerateSecurityReport).toHaveBeenCalledWith(startDate, endDate);\r\n    });\r\n\r\n    it('debe generar reporte sin anomalías e incidentes', async () => {\r\n      const mockBaseReport = {\r\n        period: { start: '2025-01-01', end: '2025-01-31' },\r\n        summary: { total_events: 50 },\r\n        events: [],\r\n        patterns: [],\r\n        recommendations: []\r\n      };\r\n\r\n      const mockGenerateSecurityReport = generateSecurityReport as jest.MockedFunction<typeof generateSecurityReport>;\r\n      mockGenerateSecurityReport.mockResolvedValue(mockBaseReport);\r\n\r\n      const startDate = '2025-01-01T00:00:00.000Z';\r\n      const endDate = '2025-01-31T23:59:59.999Z';\r\n\r\n      const report = await enterpriseAuditSystem.generateEnterpriseReport(\r\n        startDate,\r\n        endDate,\r\n        false,\r\n        false\r\n      );\r\n\r\n      expect(report.enterprise_data.anomalies).toEqual([]);\r\n      expect(report.enterprise_data.incidents).toEqual([]);\r\n    });\r\n  });\r\n\r\n  describe('Integración con Rate Limiting', () => {\r\n    it('debe obtener estadísticas de rate limiting', async () => {\r\n      const stats = (enterpriseAuditSystem as any).getRateLimitingStats();\r\n\r\n      expect(stats).toBeDefined();\r\n      expect(stats.totalRequests).toBe(1000);\r\n      expect(stats.blockedRequests).toBe(50);\r\n      expect(stats.topBlockedIPs).toHaveLength(2);\r\n      expect(mockGetMetrics).toHaveBeenCalled();\r\n    });\r\n\r\n    it('debe incluir métricas de rate limiting en reportes', async () => {\r\n      const mockBaseReport = {\r\n        period: { start: '2025-01-01', end: '2025-01-31' },\r\n        summary: { total_events: 100 },\r\n        events: [],\r\n        patterns: [],\r\n        recommendations: []\r\n      };\r\n\r\n      const mockGenerateSecurityReport = generateSecurityReport as jest.MockedFunction<typeof generateSecurityReport>;\r\n      mockGenerateSecurityReport.mockResolvedValue(mockBaseReport);\r\n\r\n      const report = await enterpriseAuditSystem.generateEnterpriseReport(\r\n        '2025-01-01T00:00:00.000Z',\r\n        '2025-01-31T23:59:59.999Z'\r\n      );\r\n\r\n      expect(report.enterprise_data.rate_limiting_stats).toBeDefined();\r\n      expect(report.enterprise_data.rate_limiting_stats.totalRequests).toBe(1000);\r\n    });\r\n  });\r\n\r\n  describe('Gestión de Instancia Singleton', () => {\r\n    it('debe retornar la misma instancia', () => {\r\n      const instance1 = EnterpriseAuditSystem.getInstance();\r\n      const instance2 = EnterpriseAuditSystem.getInstance();\r\n\r\n      expect(instance1).toBe(instance2);\r\n      expect(instance1).toBe(enterpriseAuditSystem);\r\n    });\r\n\r\n    it('debe poder destruir la instancia', () => {\r\n      const spy = jest.spyOn(console, 'log').mockImplementation();\r\n      \r\n      enterpriseAuditSystem.destroy();\r\n      \r\n      // Verificar que se limpien los intervalos\r\n      expect(spy).not.toHaveBeenCalledWith(expect.stringContaining('Error'));\r\n      \r\n      spy.mockRestore();\r\n    });\r\n  });\r\n\r\n  describe('Manejo de Errores', () => {\r\n    it('debe manejar errores en registro de eventos', async () => {\r\n      mockLogSecurityEvent.mockRejectedValue(new Error('Database error'));\r\n\r\n      const event: Omit<EnterpriseSecurityEvent, 'id' | 'timestamp' | 'resolved'> = {\r\n        user_id: 'user_123',\r\n        event_type: 'AUTH_FAILURE',\r\n        event_category: 'authentication',\r\n        severity: 'medium',\r\n        description: 'Test event',\r\n        metadata: {},\r\n        ip_address: '192.168.1.1',\r\n        user_agent: 'test-agent'\r\n      };\r\n\r\n      await expect(enterpriseAuditSystem.logEnterpriseEvent(event)).rejects.toThrow();\r\n    });\r\n\r\n    it('debe manejar errores en detección de anomalías', async () => {\r\n      jest.spyOn(enterpriseAuditSystem as any, 'getRecentEvents').mockRejectedValue(new Error('Database error'));\r\n\r\n      const anomalies = await enterpriseAuditSystem.detectAnomalies('user_123');\r\n\r\n      // Debe retornar array vacío en caso de error\r\n      expect(anomalies).toEqual([]);\r\n    });\r\n\r\n    it('debe manejar errores en generación de reportes', async () => {\r\n      const mockGenerateSecurityReport = generateSecurityReport as jest.MockedFunction<typeof generateSecurityReport>;\r\n      mockGenerateSecurityReport.mockRejectedValue(new Error('Report generation failed'));\r\n\r\n      await expect(enterpriseAuditSystem.generateEnterpriseReport(\r\n        '2025-01-01T00:00:00.000Z',\r\n        '2025-01-31T23:59:59.999Z'\r\n      )).rejects.toThrow();\r\n    });\r\n  });\r\n});\r\n"],"names":["jest","mock","supabaseAdmin","from","fn","select","eq","single","range","order","insert","update","not","filter","logSecurityEvent","analyzeSecurityPatterns","getSecurityMetrics","generateSecurityReport","metricsCollector","getMetrics","describe","mockLogSecurityEvent","mockAnalyzeSecurityPatterns","mockGetSecurityMetrics","mockGetMetrics","beforeEach","clearAllMocks","mockResolvedValue","undefined","total_events","critical_events","failed_logins","suspicious_activities","blocked_ips","security_alerts","mockReturnValue","totalRequests","allowedRequests","blockedRequests","redisHits","memoryFallbacks","errors","averageResponseTime","topBlockedIPs","ip","count","topEndpoints","endpoint","it","expect","ENTERPRISE_AUDIT_CONFIG","DATA_RETENTION","toBeDefined","security_events","toBe","anomalies","incidents","DETECTION_THRESHOLDS","anomaly_confidence","risk_score_critical","ALERT_CONFIG","immediate_notification","toContain","notification_cooldown","mockContext","userId","sessionId","email","role","permissions","sessionValid","securityLevel","ipAddress","userAgent","supabase","validations","jwtValid","csrfValid","rateLimitPassed","originValid","mockRequest","headers","Map","nextUrl","pathname","event","user_id","event_type","event_category","severity","description","metadata","method","ip_address","user_agent","correlationId","enterpriseAuditSystem","logEnterpriseEvent","toMatch","toHaveBeenCalledWith","criticalEvent","toHaveBeenCalled","detectAnomalies","toEqual","mockEvents","id","timestamp","Date","now","toISOString","resolved","spyOn","length","toBeGreaterThanOrEqual","forEach","anomaly","confidence_score","mockBaseReport","period","start","end","summary","events","patterns","recommendations","mockGenerateSecurityReport","startDate","endDate","report","generateEnterpriseReport","enterprise_data","rate_limiting_stats","stats","getRateLimitingStats","toHaveLength","instance1","EnterpriseAuditSystem","getInstance","instance2","spy","console","mockImplementation","destroy","stringContaining","mockRestore","mockRejectedValue","Error","rejects","toThrow"],"mappings":"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"}