e98343db1ac24a6ca543cfb8540457ca
/**
 * Security Validations
 * Validaciones de seguridad y permisos para el sistema enterprise
 */ "use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: Object.getOwnPropertyDescriptor(all, name).get
    });
}
_export(exports, {
    get ROLE_PERMISSIONS () {
        return ROLE_PERMISSIONS;
    },
    get getPermissionsByRole () {
        return getPermissionsByRole;
    },
    get getUserPermissions () {
        return getUserPermissions;
    },
    get getUserRole () {
        return getUserRole;
    },
    get hasAllPermissions () {
        return hasAllPermissions;
    },
    get hasAnyPermission () {
        return hasAnyPermission;
    },
    get hasPermission () {
        return hasPermission;
    },
    get isAdmin () {
        return isAdmin;
    },
    get isModerator () {
        return isModerator;
    },
    get requireAdmin () {
        return requireAdmin;
    },
    get requirePermission () {
        return requirePermission;
    },
    get requireRole () {
        return requireRole;
    },
    get roleHasPermission () {
        return roleHasPermission;
    },
    get validateResourceAccess () {
        return validateResourceAccess;
    }
});
const _supabase = require("../supabase");
const _logger = require("../logger");
const ROLE_PERMISSIONS = {
    admin: [
        'read:products',
        'write:products',
        'delete:products',
        'read:orders',
        'write:orders',
        'delete:orders',
        'read:users',
        'write:users',
        'delete:users',
        'admin:dashboard',
        'admin:settings',
        'admin:reports',
        'moderate:content',
        'moderate:users'
    ],
    moderator: [
        'read:products',
        'write:products',
        'read:orders',
        'write:orders',
        'read:users',
        'moderate:content',
        'moderate:users'
    ],
    customer: [
        'read:products',
        'read:orders'
    ]
};
function getPermissionsByRole(role) {
    return ROLE_PERMISSIONS[role] || [];
}
function roleHasPermission(role, permission) {
    const permissions = getPermissionsByRole(role);
    return permissions.includes(permission);
}
async function hasPermission(userId, permission) {
    try {
        const { data: user, error } = await _supabase.supabaseAdmin.from('users').select('role, permissions').eq('id', userId).eq('is_active', true).single();
        if (error || !user) {
            _logger.logger.error('Error obteniendo usuario para validación de permisos:', error);
            return false;
        }
        // Verificar permisos del rol
        const rolePermissions = getPermissionsByRole(user.role);
        if (rolePermissions.includes(permission)) {
            return true;
        }
        // Verificar permisos específicos del usuario
        const userPermissions = user.permissions || [];
        return userPermissions.includes(permission);
    } catch (error) {
        _logger.logger.error('Error en hasPermission:', error);
        return false;
    }
}
async function hasAnyPermission(userId, permissions) {
    for (const permission of permissions){
        if (await hasPermission(userId, permission)) {
            return true;
        }
    }
    return false;
}
async function hasAllPermissions(userId, permissions) {
    for (const permission of permissions){
        if (!await hasPermission(userId, permission)) {
            return false;
        }
    }
    return true;
}
async function isAdmin(userId) {
    try {
        const { data: user, error } = await _supabase.supabaseAdmin.from('users').select('role').eq('id', userId).eq('is_active', true).single();
        if (error || !user) {
            return false;
        }
        return user.role === 'admin';
    } catch (error) {
        _logger.logger.error('Error en isAdmin:', error);
        return false;
    }
}
async function isModerator(userId) {
    try {
        const { data: user, error } = await _supabase.supabaseAdmin.from('users').select('role').eq('id', userId).eq('is_active', true).single();
        if (error || !user) {
            return false;
        }
        return [
            'admin',
            'moderator'
        ].includes(user.role);
    } catch (error) {
        _logger.logger.error('Error en isModerator:', error);
        return false;
    }
}
async function getUserRole(userId) {
    try {
        const { data: user, error } = await _supabase.supabaseAdmin.from('users').select('role').eq('id', userId).eq('is_active', true).single();
        if (error || !user) {
            return null;
        }
        return user.role;
    } catch (error) {
        _logger.logger.error('Error en getUserRole:', error);
        return null;
    }
}
async function validateResourceAccess(userId, resourceType, action, resourceId) {
    const permission = `${action}:${resourceType}s`;
    // Verificar permiso básico
    if (!await hasPermission(userId, permission)) {
        return false;
    }
    // Validaciones adicionales por tipo de recurso
    if (resourceType === 'order' && resourceId) {
        // Los customers solo pueden acceder a sus propias órdenes
        const userRole = await getUserRole(userId);
        if (userRole === 'customer') {
            return await validateOrderOwnership(userId, resourceId);
        }
    }
    return true;
}
/**
 * Valida que un usuario sea propietario de una orden
 */ async function validateOrderOwnership(userId, orderId) {
    try {
        const { data: order, error } = await _supabase.supabaseAdmin.from('orders').select('user_id').eq('id', orderId).single();
        if (error || !order) {
            return false;
        }
        return order.user_id === userId;
    } catch (error) {
        _logger.logger.error('Error validando propiedad de orden:', error);
        return false;
    }
}
function requirePermission(permission) {
    return async (userId)=>{
        return await hasPermission(userId, permission);
    };
}
function requireRole(role) {
    return async (userId)=>{
        const userRole = await getUserRole(userId);
        return userRole === role;
    };
}
function requireAdmin() {
    return async (userId)=>{
        return await isAdmin(userId);
    };
}
async function getUserPermissions(userId) {
    try {
        const { data: user, error } = await _supabase.supabaseAdmin.from('users').select('role, permissions').eq('id', userId).eq('is_active', true).single();
        if (error || !user) {
            return [];
        }
        const rolePermissions = getPermissionsByRole(user.role);
        const userPermissions = user.permissions || [];
        // Combinar permisos del rol y permisos específicos del usuario
        const allPermissions = [
            ...rolePermissions,
            ...userPermissions
        ];
        // Eliminar duplicados
        return [
            ...new Set(allPermissions)
        ];
    } catch (error) {
        _logger.logger.error('Error en getUserPermissions:', error);
        return [];
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbWFydGlcXERlc2t0b3BcXERFU0FSUk9MTE9TV1xcQk9JTEVSUExBVFRFIEUtQ09NTUVSQ0VcXHNyY1xcbGliXFxhdXRoXFxzZWN1cml0eS12YWxpZGF0aW9ucy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFNlY3VyaXR5IFZhbGlkYXRpb25zXG4gKiBWYWxpZGFjaW9uZXMgZGUgc2VndXJpZGFkIHkgcGVybWlzb3MgcGFyYSBlbCBzaXN0ZW1hIGVudGVycHJpc2VcbiAqL1xuXG5pbXBvcnQgeyBhdXRoIH0gZnJvbSAnQC9hdXRoJztcbmltcG9ydCB7IHN1cGFiYXNlQWRtaW4gfSBmcm9tICdAL2xpYi9zdXBhYmFzZSc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICdAL2xpYi9sb2dnZXInO1xuXG5leHBvcnQgdHlwZSBQZXJtaXNzaW9uID0gXG4gIHwgJ3JlYWQ6cHJvZHVjdHMnXG4gIHwgJ3dyaXRlOnByb2R1Y3RzJ1xuICB8ICdkZWxldGU6cHJvZHVjdHMnXG4gIHwgJ3JlYWQ6b3JkZXJzJ1xuICB8ICd3cml0ZTpvcmRlcnMnXG4gIHwgJ2RlbGV0ZTpvcmRlcnMnXG4gIHwgJ3JlYWQ6dXNlcnMnXG4gIHwgJ3dyaXRlOnVzZXJzJ1xuICB8ICdkZWxldGU6dXNlcnMnXG4gIHwgJ2FkbWluOmRhc2hib2FyZCdcbiAgfCAnYWRtaW46c2V0dGluZ3MnXG4gIHwgJ2FkbWluOnJlcG9ydHMnXG4gIHwgJ21vZGVyYXRlOmNvbnRlbnQnXG4gIHwgJ21vZGVyYXRlOnVzZXJzJztcblxuZXhwb3J0IHR5cGUgUm9sZSA9ICdhZG1pbicgfCAnY3VzdG9tZXInIHwgJ21vZGVyYXRvcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUm9sZVBlcm1pc3Npb25zIHtcbiAgW2tleTogc3RyaW5nXTogUGVybWlzc2lvbltdO1xufVxuXG4vKipcbiAqIERlZmluaWNpw7NuIGRlIHBlcm1pc29zIHBvciByb2xcbiAqL1xuZXhwb3J0IGNvbnN0IFJPTEVfUEVSTUlTU0lPTlM6IFJvbGVQZXJtaXNzaW9ucyA9IHtcbiAgYWRtaW46IFtcbiAgICAncmVhZDpwcm9kdWN0cycsXG4gICAgJ3dyaXRlOnByb2R1Y3RzJyxcbiAgICAnZGVsZXRlOnByb2R1Y3RzJyxcbiAgICAncmVhZDpvcmRlcnMnLFxuICAgICd3cml0ZTpvcmRlcnMnLFxuICAgICdkZWxldGU6b3JkZXJzJyxcbiAgICAncmVhZDp1c2VycycsXG4gICAgJ3dyaXRlOnVzZXJzJyxcbiAgICAnZGVsZXRlOnVzZXJzJyxcbiAgICAnYWRtaW46ZGFzaGJvYXJkJyxcbiAgICAnYWRtaW46c2V0dGluZ3MnLFxuICAgICdhZG1pbjpyZXBvcnRzJyxcbiAgICAnbW9kZXJhdGU6Y29udGVudCcsXG4gICAgJ21vZGVyYXRlOnVzZXJzJyxcbiAgXSxcbiAgbW9kZXJhdG9yOiBbXG4gICAgJ3JlYWQ6cHJvZHVjdHMnLFxuICAgICd3cml0ZTpwcm9kdWN0cycsXG4gICAgJ3JlYWQ6b3JkZXJzJyxcbiAgICAnd3JpdGU6b3JkZXJzJyxcbiAgICAncmVhZDp1c2VycycsXG4gICAgJ21vZGVyYXRlOmNvbnRlbnQnLFxuICAgICdtb2RlcmF0ZTp1c2VycycsXG4gIF0sXG4gIGN1c3RvbWVyOiBbXG4gICAgJ3JlYWQ6cHJvZHVjdHMnLFxuICAgICdyZWFkOm9yZGVycycsXG4gIF0sXG59O1xuXG4vKipcbiAqIE9idGllbmUgbG9zIHBlcm1pc29zIGRlIHVuIHJvbCBlc3BlY8OtZmljb1xuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGVybWlzc2lvbnNCeVJvbGUocm9sZTogUm9sZSk6IFBlcm1pc3Npb25bXSB7XG4gIHJldHVybiBST0xFX1BFUk1JU1NJT05TW3JvbGVdIHx8IFtdO1xufVxuXG4vKipcbiAqIFZlcmlmaWNhIHNpIHVuIHJvbCB0aWVuZSB1biBwZXJtaXNvIGVzcGVjw61maWNvXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByb2xlSGFzUGVybWlzc2lvbihyb2xlOiBSb2xlLCBwZXJtaXNzaW9uOiBQZXJtaXNzaW9uKTogYm9vbGVhbiB7XG4gIGNvbnN0IHBlcm1pc3Npb25zID0gZ2V0UGVybWlzc2lvbnNCeVJvbGUocm9sZSk7XG4gIHJldHVybiBwZXJtaXNzaW9ucy5pbmNsdWRlcyhwZXJtaXNzaW9uKTtcbn1cblxuLyoqXG4gKiBWZXJpZmljYSBzaSB1biB1c3VhcmlvIHRpZW5lIHVuIHBlcm1pc28gZXNwZWPDrWZpY29cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGhhc1Blcm1pc3Npb24odXNlcklkOiBzdHJpbmcsIHBlcm1pc3Npb246IFBlcm1pc3Npb24pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IGRhdGE6IHVzZXIsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXG4gICAgICAuZnJvbSgndXNlcnMnKVxuICAgICAgLnNlbGVjdCgncm9sZSwgcGVybWlzc2lvbnMnKVxuICAgICAgLmVxKCdpZCcsIHVzZXJJZClcbiAgICAgIC5lcSgnaXNfYWN0aXZlJywgdHJ1ZSlcbiAgICAgIC5zaW5nbGUoKTtcblxuICAgIGlmIChlcnJvciB8fCAhdXNlcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciBvYnRlbmllbmRvIHVzdWFyaW8gcGFyYSB2YWxpZGFjacOzbiBkZSBwZXJtaXNvczonLCBlcnJvcik7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gVmVyaWZpY2FyIHBlcm1pc29zIGRlbCByb2xcbiAgICBjb25zdCByb2xlUGVybWlzc2lvbnMgPSBnZXRQZXJtaXNzaW9uc0J5Um9sZSh1c2VyLnJvbGUgYXMgUm9sZSk7XG4gICAgaWYgKHJvbGVQZXJtaXNzaW9ucy5pbmNsdWRlcyhwZXJtaXNzaW9uKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLy8gVmVyaWZpY2FyIHBlcm1pc29zIGVzcGVjw61maWNvcyBkZWwgdXN1YXJpb1xuICAgIGNvbnN0IHVzZXJQZXJtaXNzaW9ucyA9IHVzZXIucGVybWlzc2lvbnMgfHwgW107XG4gICAgcmV0dXJuIHVzZXJQZXJtaXNzaW9ucy5pbmNsdWRlcyhwZXJtaXNzaW9uKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGVuIGhhc1Blcm1pc3Npb246JywgZXJyb3IpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG4vKipcbiAqIFZlcmlmaWNhIHNpIHVuIHVzdWFyaW8gdGllbmUgYWxndW5vIGRlIGxvcyBwZXJtaXNvcyBlc3BlY2lmaWNhZG9zXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYXNBbnlQZXJtaXNzaW9uKHVzZXJJZDogc3RyaW5nLCBwZXJtaXNzaW9uczogUGVybWlzc2lvbltdKTogUHJvbWlzZTxib29sZWFuPiB7XG4gIGZvciAoY29uc3QgcGVybWlzc2lvbiBvZiBwZXJtaXNzaW9ucykge1xuICAgIGlmIChhd2FpdCBoYXNQZXJtaXNzaW9uKHVzZXJJZCwgcGVybWlzc2lvbikpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbi8qKlxuICogVmVyaWZpY2Egc2kgdW4gdXN1YXJpbyB0aWVuZSB0b2RvcyBsb3MgcGVybWlzb3MgZXNwZWNpZmljYWRvc1xuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaGFzQWxsUGVybWlzc2lvbnModXNlcklkOiBzdHJpbmcsIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uW10pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgZm9yIChjb25zdCBwZXJtaXNzaW9uIG9mIHBlcm1pc3Npb25zKSB7XG4gICAgaWYgKCEoYXdhaXQgaGFzUGVybWlzc2lvbih1c2VySWQsIHBlcm1pc3Npb24pKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gdHJ1ZTtcbn1cblxuLyoqXG4gKiBWZXJpZmljYSBzaSB1biB1c3VhcmlvIGVzIGFkbWluaXN0cmFkb3JcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGlzQWRtaW4odXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IGRhdGE6IHVzZXIsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXG4gICAgICAuZnJvbSgndXNlcnMnKVxuICAgICAgLnNlbGVjdCgncm9sZScpXG4gICAgICAuZXEoJ2lkJywgdXNlcklkKVxuICAgICAgLmVxKCdpc19hY3RpdmUnLCB0cnVlKVxuICAgICAgLnNpbmdsZSgpO1xuXG4gICAgaWYgKGVycm9yIHx8ICF1c2VyKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHVzZXIucm9sZSA9PT0gJ2FkbWluJztcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGVuIGlzQWRtaW46JywgZXJyb3IpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG4vKipcbiAqIFZlcmlmaWNhIHNpIHVuIHVzdWFyaW8gZXMgbW9kZXJhZG9yIG8gYWRtaW5pc3RyYWRvclxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaXNNb2RlcmF0b3IodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IGRhdGE6IHVzZXIsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXG4gICAgICAuZnJvbSgndXNlcnMnKVxuICAgICAgLnNlbGVjdCgncm9sZScpXG4gICAgICAuZXEoJ2lkJywgdXNlcklkKVxuICAgICAgLmVxKCdpc19hY3RpdmUnLCB0cnVlKVxuICAgICAgLnNpbmdsZSgpO1xuXG4gICAgaWYgKGVycm9yIHx8ICF1c2VyKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIFsnYWRtaW4nLCAnbW9kZXJhdG9yJ10uaW5jbHVkZXModXNlci5yb2xlKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGVuIGlzTW9kZXJhdG9yOicsIGVycm9yKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuLyoqXG4gKiBPYnRpZW5lIGVsIHJvbCBkZSB1biB1c3VhcmlvXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRVc2VyUm9sZSh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8Um9sZSB8IG51bGw+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IGRhdGE6IHVzZXIsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXG4gICAgICAuZnJvbSgndXNlcnMnKVxuICAgICAgLnNlbGVjdCgncm9sZScpXG4gICAgICAuZXEoJ2lkJywgdXNlcklkKVxuICAgICAgLmVxKCdpc19hY3RpdmUnLCB0cnVlKVxuICAgICAgLnNpbmdsZSgpO1xuXG4gICAgaWYgKGVycm9yIHx8ICF1c2VyKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gdXNlci5yb2xlIGFzIFJvbGU7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKCdFcnJvciBlbiBnZXRVc2VyUm9sZTonLCBlcnJvcik7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cblxuLyoqXG4gKiBWYWxpZGEgYWNjZXNvIGEgcmVjdXJzbyBlc3BlY8OtZmljb1xuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdmFsaWRhdGVSZXNvdXJjZUFjY2VzcyhcbiAgdXNlcklkOiBzdHJpbmcsXG4gIHJlc291cmNlVHlwZTogJ3Byb2R1Y3QnIHwgJ29yZGVyJyB8ICd1c2VyJyxcbiAgYWN0aW9uOiAncmVhZCcgfCAnd3JpdGUnIHwgJ2RlbGV0ZScsXG4gIHJlc291cmNlSWQ/OiBzdHJpbmdcbik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICBjb25zdCBwZXJtaXNzaW9uID0gYCR7YWN0aW9ufToke3Jlc291cmNlVHlwZX1zYCBhcyBQZXJtaXNzaW9uO1xuICBcbiAgLy8gVmVyaWZpY2FyIHBlcm1pc28gYsOhc2ljb1xuICBpZiAoIShhd2FpdCBoYXNQZXJtaXNzaW9uKHVzZXJJZCwgcGVybWlzc2lvbikpKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLy8gVmFsaWRhY2lvbmVzIGFkaWNpb25hbGVzIHBvciB0aXBvIGRlIHJlY3Vyc29cbiAgaWYgKHJlc291cmNlVHlwZSA9PT0gJ29yZGVyJyAmJiByZXNvdXJjZUlkKSB7XG4gICAgLy8gTG9zIGN1c3RvbWVycyBzb2xvIHB1ZWRlbiBhY2NlZGVyIGEgc3VzIHByb3BpYXMgw7NyZGVuZXNcbiAgICBjb25zdCB1c2VyUm9sZSA9IGF3YWl0IGdldFVzZXJSb2xlKHVzZXJJZCk7XG4gICAgaWYgKHVzZXJSb2xlID09PSAnY3VzdG9tZXInKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdmFsaWRhdGVPcmRlck93bmVyc2hpcCh1c2VySWQsIHJlc291cmNlSWQpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB0cnVlO1xufVxuXG4vKipcbiAqIFZhbGlkYSBxdWUgdW4gdXN1YXJpbyBzZWEgcHJvcGlldGFyaW8gZGUgdW5hIG9yZGVuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHZhbGlkYXRlT3JkZXJPd25lcnNoaXAodXNlcklkOiBzdHJpbmcsIG9yZGVySWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICB0cnkge1xuICAgIGNvbnN0IHsgZGF0YTogb3JkZXIsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXG4gICAgICAuZnJvbSgnb3JkZXJzJylcbiAgICAgIC5zZWxlY3QoJ3VzZXJfaWQnKVxuICAgICAgLmVxKCdpZCcsIG9yZGVySWQpXG4gICAgICAuc2luZ2xlKCk7XG5cbiAgICBpZiAoZXJyb3IgfHwgIW9yZGVyKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIG9yZGVyLnVzZXJfaWQgPT09IHVzZXJJZDtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIHZhbGlkYW5kbyBwcm9waWVkYWQgZGUgb3JkZW46JywgZXJyb3IpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG4vKipcbiAqIE1pZGRsZXdhcmUgZGUgdmFsaWRhY2nDs24gZGUgcGVybWlzb3NcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVQZXJtaXNzaW9uKHBlcm1pc3Npb246IFBlcm1pc3Npb24pIHtcbiAgcmV0dXJuIGFzeW5jICh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4gPT4ge1xuICAgIHJldHVybiBhd2FpdCBoYXNQZXJtaXNzaW9uKHVzZXJJZCwgcGVybWlzc2lvbik7XG4gIH07XG59XG5cbi8qKlxuICogTWlkZGxld2FyZSBkZSB2YWxpZGFjacOzbiBkZSByb2xcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVSb2xlKHJvbGU6IFJvbGUpIHtcbiAgcmV0dXJuIGFzeW5jICh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4gPT4ge1xuICAgIGNvbnN0IHVzZXJSb2xlID0gYXdhaXQgZ2V0VXNlclJvbGUodXNlcklkKTtcbiAgICByZXR1cm4gdXNlclJvbGUgPT09IHJvbGU7XG4gIH07XG59XG5cbi8qKlxuICogTWlkZGxld2FyZSBkZSB2YWxpZGFjacOzbiBkZSBhZG1pbmlzdHJhZG9yXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZXF1aXJlQWRtaW4oKSB7XG4gIHJldHVybiBhc3luYyAodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+ID0+IHtcbiAgICByZXR1cm4gYXdhaXQgaXNBZG1pbih1c2VySWQpO1xuICB9O1xufVxuXG4vKipcbiAqIE9idGllbmUgdG9kb3MgbG9zIHBlcm1pc29zIGRlIHVuIHVzdWFyaW9cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFVzZXJQZXJtaXNzaW9ucyh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8UGVybWlzc2lvbltdPiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBkYXRhOiB1c2VyLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VBZG1pblxuICAgICAgLmZyb20oJ3VzZXJzJylcbiAgICAgIC5zZWxlY3QoJ3JvbGUsIHBlcm1pc3Npb25zJylcbiAgICAgIC5lcSgnaWQnLCB1c2VySWQpXG4gICAgICAuZXEoJ2lzX2FjdGl2ZScsIHRydWUpXG4gICAgICAuc2luZ2xlKCk7XG5cbiAgICBpZiAoZXJyb3IgfHwgIXVzZXIpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICBjb25zdCByb2xlUGVybWlzc2lvbnMgPSBnZXRQZXJtaXNzaW9uc0J5Um9sZSh1c2VyLnJvbGUgYXMgUm9sZSk7XG4gICAgY29uc3QgdXNlclBlcm1pc3Npb25zID0gdXNlci5wZXJtaXNzaW9ucyB8fCBbXTtcbiAgICBcbiAgICAvLyBDb21iaW5hciBwZXJtaXNvcyBkZWwgcm9sIHkgcGVybWlzb3MgZXNwZWPDrWZpY29zIGRlbCB1c3VhcmlvXG4gICAgY29uc3QgYWxsUGVybWlzc2lvbnMgPSBbLi4ucm9sZVBlcm1pc3Npb25zLCAuLi51c2VyUGVybWlzc2lvbnNdO1xuICAgIFxuICAgIC8vIEVsaW1pbmFyIGR1cGxpY2Fkb3NcbiAgICByZXR1cm4gWy4uLm5ldyBTZXQoYWxsUGVybWlzc2lvbnMpXTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGVuIGdldFVzZXJQZXJtaXNzaW9uczonLCBlcnJvcik7XG4gICAgcmV0dXJuIFtdO1xuICB9XG59XG4iXSwibmFtZXMiOlsiUk9MRV9QRVJNSVNTSU9OUyIsImdldFBlcm1pc3Npb25zQnlSb2xlIiwiZ2V0VXNlclBlcm1pc3Npb25zIiwiZ2V0VXNlclJvbGUiLCJoYXNBbGxQZXJtaXNzaW9ucyIsImhhc0FueVBlcm1pc3Npb24iLCJoYXNQZXJtaXNzaW9uIiwiaXNBZG1pbiIsImlzTW9kZXJhdG9yIiwicmVxdWlyZUFkbWluIiwicmVxdWlyZVBlcm1pc3Npb24iLCJyZXF1aXJlUm9sZSIsInJvbGVIYXNQZXJtaXNzaW9uIiwidmFsaWRhdGVSZXNvdXJjZUFjY2VzcyIsImFkbWluIiwibW9kZXJhdG9yIiwiY3VzdG9tZXIiLCJyb2xlIiwicGVybWlzc2lvbiIsInBlcm1pc3Npb25zIiwiaW5jbHVkZXMiLCJ1c2VySWQiLCJkYXRhIiwidXNlciIsImVycm9yIiwic3VwYWJhc2VBZG1pbiIsImZyb20iLCJzZWxlY3QiLCJlcSIsInNpbmdsZSIsImxvZ2dlciIsInJvbGVQZXJtaXNzaW9ucyIsInVzZXJQZXJtaXNzaW9ucyIsInJlc291cmNlVHlwZSIsImFjdGlvbiIsInJlc291cmNlSWQiLCJ1c2VyUm9sZSIsInZhbGlkYXRlT3JkZXJPd25lcnNoaXAiLCJvcmRlcklkIiwib3JkZXIiLCJ1c2VyX2lkIiwiYWxsUGVybWlzc2lvbnMiLCJTZXQiXSwibWFwcGluZ3MiOiJBQUFBOzs7Q0FHQzs7Ozs7Ozs7Ozs7UUErQllBO2VBQUFBOztRQW1DR0M7ZUFBQUE7O1FBME5NQztlQUFBQTs7UUFyR0FDO2VBQUFBOztRQTFEQUM7ZUFBQUE7O1FBWkFDO2VBQUFBOztRQWhDQUM7ZUFBQUE7O1FBd0RBQztlQUFBQTs7UUF1QkFDO2VBQUFBOztRQW1ITkM7ZUFBQUE7O1FBbkJBQztlQUFBQTs7UUFTQUM7ZUFBQUE7O1FBaE1BQztlQUFBQTs7UUFxSU1DO2VBQUFBOzs7MEJBM01RO3dCQUNQO0FBMkJoQixNQUFNYixtQkFBb0M7SUFDL0NjLE9BQU87UUFDTDtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO0tBQ0Q7SUFDREMsV0FBVztRQUNUO1FBQ0E7UUFDQTtRQUNBO1FBQ0E7UUFDQTtRQUNBO0tBQ0Q7SUFDREMsVUFBVTtRQUNSO1FBQ0E7S0FDRDtBQUNIO0FBS08sU0FBU2YscUJBQXFCZ0IsSUFBVTtJQUM3QyxPQUFPakIsZ0JBQWdCLENBQUNpQixLQUFLLElBQUksRUFBRTtBQUNyQztBQUtPLFNBQVNMLGtCQUFrQkssSUFBVSxFQUFFQyxVQUFzQjtJQUNsRSxNQUFNQyxjQUFjbEIscUJBQXFCZ0I7SUFDekMsT0FBT0UsWUFBWUMsUUFBUSxDQUFDRjtBQUM5QjtBQUtPLGVBQWVaLGNBQWNlLE1BQWMsRUFBRUgsVUFBc0I7SUFDeEUsSUFBSTtRQUNGLE1BQU0sRUFBRUksTUFBTUMsSUFBSSxFQUFFQyxLQUFLLEVBQUUsR0FBRyxNQUFNQyx1QkFBYSxDQUM5Q0MsSUFBSSxDQUFDLFNBQ0xDLE1BQU0sQ0FBQyxxQkFDUEMsRUFBRSxDQUFDLE1BQU1QLFFBQ1RPLEVBQUUsQ0FBQyxhQUFhLE1BQ2hCQyxNQUFNO1FBRVQsSUFBSUwsU0FBUyxDQUFDRCxNQUFNO1lBQ2xCTyxjQUFNLENBQUNOLEtBQUssQ0FBQyx5REFBeURBO1lBQ3RFLE9BQU87UUFDVDtRQUVBLDZCQUE2QjtRQUM3QixNQUFNTyxrQkFBa0I5QixxQkFBcUJzQixLQUFLTixJQUFJO1FBQ3RELElBQUljLGdCQUFnQlgsUUFBUSxDQUFDRixhQUFhO1lBQ3hDLE9BQU87UUFDVDtRQUVBLDZDQUE2QztRQUM3QyxNQUFNYyxrQkFBa0JULEtBQUtKLFdBQVcsSUFBSSxFQUFFO1FBQzlDLE9BQU9hLGdCQUFnQlosUUFBUSxDQUFDRjtJQUNsQyxFQUFFLE9BQU9NLE9BQU87UUFDZE0sY0FBTSxDQUFDTixLQUFLLENBQUMsMkJBQTJCQTtRQUN4QyxPQUFPO0lBQ1Q7QUFDRjtBQUtPLGVBQWVuQixpQkFBaUJnQixNQUFjLEVBQUVGLFdBQXlCO0lBQzlFLEtBQUssTUFBTUQsY0FBY0MsWUFBYTtRQUNwQyxJQUFJLE1BQU1iLGNBQWNlLFFBQVFILGFBQWE7WUFDM0MsT0FBTztRQUNUO0lBQ0Y7SUFDQSxPQUFPO0FBQ1Q7QUFLTyxlQUFlZCxrQkFBa0JpQixNQUFjLEVBQUVGLFdBQXlCO0lBQy9FLEtBQUssTUFBTUQsY0FBY0MsWUFBYTtRQUNwQyxJQUFJLENBQUUsTUFBTWIsY0FBY2UsUUFBUUgsYUFBYztZQUM5QyxPQUFPO1FBQ1Q7SUFDRjtJQUNBLE9BQU87QUFDVDtBQUtPLGVBQWVYLFFBQVFjLE1BQWM7SUFDMUMsSUFBSTtRQUNGLE1BQU0sRUFBRUMsTUFBTUMsSUFBSSxFQUFFQyxLQUFLLEVBQUUsR0FBRyxNQUFNQyx1QkFBYSxDQUM5Q0MsSUFBSSxDQUFDLFNBQ0xDLE1BQU0sQ0FBQyxRQUNQQyxFQUFFLENBQUMsTUFBTVAsUUFDVE8sRUFBRSxDQUFDLGFBQWEsTUFDaEJDLE1BQU07UUFFVCxJQUFJTCxTQUFTLENBQUNELE1BQU07WUFDbEIsT0FBTztRQUNUO1FBRUEsT0FBT0EsS0FBS04sSUFBSSxLQUFLO0lBQ3ZCLEVBQUUsT0FBT08sT0FBTztRQUNkTSxjQUFNLENBQUNOLEtBQUssQ0FBQyxxQkFBcUJBO1FBQ2xDLE9BQU87SUFDVDtBQUNGO0FBS08sZUFBZWhCLFlBQVlhLE1BQWM7SUFDOUMsSUFBSTtRQUNGLE1BQU0sRUFBRUMsTUFBTUMsSUFBSSxFQUFFQyxLQUFLLEVBQUUsR0FBRyxNQUFNQyx1QkFBYSxDQUM5Q0MsSUFBSSxDQUFDLFNBQ0xDLE1BQU0sQ0FBQyxRQUNQQyxFQUFFLENBQUMsTUFBTVAsUUFDVE8sRUFBRSxDQUFDLGFBQWEsTUFDaEJDLE1BQU07UUFFVCxJQUFJTCxTQUFTLENBQUNELE1BQU07WUFDbEIsT0FBTztRQUNUO1FBRUEsT0FBTztZQUFDO1lBQVM7U0FBWSxDQUFDSCxRQUFRLENBQUNHLEtBQUtOLElBQUk7SUFDbEQsRUFBRSxPQUFPTyxPQUFPO1FBQ2RNLGNBQU0sQ0FBQ04sS0FBSyxDQUFDLHlCQUF5QkE7UUFDdEMsT0FBTztJQUNUO0FBQ0Y7QUFLTyxlQUFlckIsWUFBWWtCLE1BQWM7SUFDOUMsSUFBSTtRQUNGLE1BQU0sRUFBRUMsTUFBTUMsSUFBSSxFQUFFQyxLQUFLLEVBQUUsR0FBRyxNQUFNQyx1QkFBYSxDQUM5Q0MsSUFBSSxDQUFDLFNBQ0xDLE1BQU0sQ0FBQyxRQUNQQyxFQUFFLENBQUMsTUFBTVAsUUFDVE8sRUFBRSxDQUFDLGFBQWEsTUFDaEJDLE1BQU07UUFFVCxJQUFJTCxTQUFTLENBQUNELE1BQU07WUFDbEIsT0FBTztRQUNUO1FBRUEsT0FBT0EsS0FBS04sSUFBSTtJQUNsQixFQUFFLE9BQU9PLE9BQU87UUFDZE0sY0FBTSxDQUFDTixLQUFLLENBQUMseUJBQXlCQTtRQUN0QyxPQUFPO0lBQ1Q7QUFDRjtBQUtPLGVBQWVYLHVCQUNwQlEsTUFBYyxFQUNkWSxZQUEwQyxFQUMxQ0MsTUFBbUMsRUFDbkNDLFVBQW1CO0lBRW5CLE1BQU1qQixhQUFhLEdBQUdnQixPQUFPLENBQUMsRUFBRUQsYUFBYSxDQUFDLENBQUM7SUFFL0MsMkJBQTJCO0lBQzNCLElBQUksQ0FBRSxNQUFNM0IsY0FBY2UsUUFBUUgsYUFBYztRQUM5QyxPQUFPO0lBQ1Q7SUFFQSwrQ0FBK0M7SUFDL0MsSUFBSWUsaUJBQWlCLFdBQVdFLFlBQVk7UUFDMUMsMERBQTBEO1FBQzFELE1BQU1DLFdBQVcsTUFBTWpDLFlBQVlrQjtRQUNuQyxJQUFJZSxhQUFhLFlBQVk7WUFDM0IsT0FBTyxNQUFNQyx1QkFBdUJoQixRQUFRYztRQUM5QztJQUNGO0lBRUEsT0FBTztBQUNUO0FBRUE7O0NBRUMsR0FDRCxlQUFlRSx1QkFBdUJoQixNQUFjLEVBQUVpQixPQUFlO0lBQ25FLElBQUk7UUFDRixNQUFNLEVBQUVoQixNQUFNaUIsS0FBSyxFQUFFZixLQUFLLEVBQUUsR0FBRyxNQUFNQyx1QkFBYSxDQUMvQ0MsSUFBSSxDQUFDLFVBQ0xDLE1BQU0sQ0FBQyxXQUNQQyxFQUFFLENBQUMsTUFBTVUsU0FDVFQsTUFBTTtRQUVULElBQUlMLFNBQVMsQ0FBQ2UsT0FBTztZQUNuQixPQUFPO1FBQ1Q7UUFFQSxPQUFPQSxNQUFNQyxPQUFPLEtBQUtuQjtJQUMzQixFQUFFLE9BQU9HLE9BQU87UUFDZE0sY0FBTSxDQUFDTixLQUFLLENBQUMsdUNBQXVDQTtRQUNwRCxPQUFPO0lBQ1Q7QUFDRjtBQUtPLFNBQVNkLGtCQUFrQlEsVUFBc0I7SUFDdEQsT0FBTyxPQUFPRztRQUNaLE9BQU8sTUFBTWYsY0FBY2UsUUFBUUg7SUFDckM7QUFDRjtBQUtPLFNBQVNQLFlBQVlNLElBQVU7SUFDcEMsT0FBTyxPQUFPSTtRQUNaLE1BQU1lLFdBQVcsTUFBTWpDLFlBQVlrQjtRQUNuQyxPQUFPZSxhQUFhbkI7SUFDdEI7QUFDRjtBQUtPLFNBQVNSO0lBQ2QsT0FBTyxPQUFPWTtRQUNaLE9BQU8sTUFBTWQsUUFBUWM7SUFDdkI7QUFDRjtBQUtPLGVBQWVuQixtQkFBbUJtQixNQUFjO0lBQ3JELElBQUk7UUFDRixNQUFNLEVBQUVDLE1BQU1DLElBQUksRUFBRUMsS0FBSyxFQUFFLEdBQUcsTUFBTUMsdUJBQWEsQ0FDOUNDLElBQUksQ0FBQyxTQUNMQyxNQUFNLENBQUMscUJBQ1BDLEVBQUUsQ0FBQyxNQUFNUCxRQUNUTyxFQUFFLENBQUMsYUFBYSxNQUNoQkMsTUFBTTtRQUVULElBQUlMLFNBQVMsQ0FBQ0QsTUFBTTtZQUNsQixPQUFPLEVBQUU7UUFDWDtRQUVBLE1BQU1RLGtCQUFrQjlCLHFCQUFxQnNCLEtBQUtOLElBQUk7UUFDdEQsTUFBTWUsa0JBQWtCVCxLQUFLSixXQUFXLElBQUksRUFBRTtRQUU5QywrREFBK0Q7UUFDL0QsTUFBTXNCLGlCQUFpQjtlQUFJVjtlQUFvQkM7U0FBZ0I7UUFFL0Qsc0JBQXNCO1FBQ3RCLE9BQU87ZUFBSSxJQUFJVSxJQUFJRDtTQUFnQjtJQUNyQyxFQUFFLE9BQU9qQixPQUFPO1FBQ2RNLGNBQU0sQ0FBQ04sS0FBSyxDQUFDLGdDQUFnQ0E7UUFDN0MsT0FBTyxFQUFFO0lBQ1g7QUFDRiJ9