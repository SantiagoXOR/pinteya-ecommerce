{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\utils\\api-monitoring.ts"],"sourcesContent":["// ===================================\n// PINTEYA E-COMMERCE - API MONITORING SYSTEM\n// Sistema de monitoreo para detectar problemas de renderizado y API\n// ===================================\n\ninterface ApiMonitoringEvent {\n  timestamp: string;\n  endpoint: string;\n  expectedCount: number;\n  actualCount: number;\n  discrepancy: number;\n  userAgent: string;\n  sessionId: string;\n}\n\ninterface RenderingIssue {\n  timestamp: string;\n  component: string;\n  expectedItems: number;\n  renderedItems: number;\n  filterCriteria?: Record<string, unknown>;\n  errorDetails?: string;\n}\n\nclass ApiMonitoringService {\n  private static instance: ApiMonitoringService;\n  private events: ApiMonitoringEvent[] = [];\n  private renderingIssues: RenderingIssue[] = [];\n  private sessionId: string;\n\n  constructor() {\n    this.sessionId = this.generateSessionId();\n  }\n\n  static getInstance(): ApiMonitoringService {\n    if (!ApiMonitoringService.instance) {\n      ApiMonitoringService.instance = new ApiMonitoringService();\n    }\n    return ApiMonitoringService.instance;\n  }\n\n  private generateSessionId(): string {\n    return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  }\n\n  /**\n   * Registra una discrepancia entre datos de API y renderizado\n   */\n  recordApiDiscrepancy(\n    endpoint: string,\n    expectedCount: number,\n    actualCount: number\n  ): void {\n    const event: ApiMonitoringEvent = {\n      timestamp: new Date().toISOString(),\n      endpoint,\n      expectedCount,\n      actualCount,\n      discrepancy: expectedCount - actualCount,\n      userAgent: navigator.userAgent,\n      sessionId: this.sessionId\n    };\n\n    this.events.push(event);\n    \n    // Log cr칤tico si hay discrepancia significativa\n    if (event.discrepancy > 0) {\n      console.error('游뚿 API Discrepancy Detected:', {\n        endpoint: event.endpoint,\n        expected: event.expectedCount,\n        actual: event.actualCount,\n        lost: event.discrepancy,\n        percentage: ((event.discrepancy / event.expectedCount) * 100).toFixed(2) + '%'\n      });\n      \n      // Enviar alerta si la discrepancia es mayor al 20%\n      if (event.discrepancy / event.expectedCount > 0.2) {\n        this.sendCriticalAlert(event);\n      }\n    }\n\n    // Mantener solo los 칰ltimos 100 eventos\n    if (this.events.length > 100) {\n      this.events = this.events.slice(-100);\n    }\n  }\n\n  /**\n   * Registra un problema de renderizado\n   */\n  recordRenderingIssue(\n    component: string,\n    expectedItems: number,\n    renderedItems: number,\n    filterCriteria?: Record<string, unknown>,\n    errorDetails?: string\n  ): void {\n    const issue: RenderingIssue = {\n      timestamp: new Date().toISOString(),\n      component,\n      expectedItems,\n      renderedItems,\n      filterCriteria,\n      errorDetails\n    };\n\n    this.renderingIssues.push(issue);\n\n    console.warn('丘멆잺 Rendering Issue Detected:', {\n      component: issue.component,\n      expected: issue.expectedItems,\n      rendered: issue.renderedItems,\n      filters: issue.filterCriteria,\n      error: issue.errorDetails\n    });\n\n    // Mantener solo los 칰ltimos 50 problemas\n    if (this.renderingIssues.length > 50) {\n      this.renderingIssues = this.renderingIssues.slice(-50);\n    }\n  }\n\n  /**\n   * Env칤a una alerta cr칤tica (en producci칩n se enviar칤a a un servicio de monitoreo)\n   */\n  private sendCriticalAlert(event: ApiMonitoringEvent): void {\n    // En desarrollo, solo log\n    if (process.env.NODE_ENV === 'development') {\n      console.error('游뚿 CRITICAL ALERT:', {\n        message: 'Significant data loss detected',\n        event,\n        recommendation: 'Check API validation logic and data filtering'\n      });\n      return;\n    }\n\n    // En producci칩n, enviar a servicio de monitoreo\n    // fetch('/api/monitoring/alerts', {\n    //   method: 'POST',\n    //   headers: { 'Content-Type': 'application/json' },\n    //   body: JSON.stringify({ type: 'api_discrepancy', event })\n    // }).catch(console.error);\n  }\n\n  /**\n   * Obtiene estad칤sticas de monitoreo\n   */\n  getMonitoringStats(): {\n    totalEvents: number;\n    totalIssues: number;\n    criticalEvents: number;\n    averageDiscrepancy: number;\n    recentEvents: ApiMonitoringEvent[];\n    recentIssues: RenderingIssue[];\n  } {\n    const criticalEvents = this.events.filter(e => e.discrepancy > 0).length;\n    const totalDiscrepancy = this.events.reduce((sum, e) => sum + Math.abs(e.discrepancy), 0);\n    const averageDiscrepancy = this.events.length > 0 ? totalDiscrepancy / this.events.length : 0;\n\n    return {\n      totalEvents: this.events.length,\n      totalIssues: this.renderingIssues.length,\n      criticalEvents,\n      averageDiscrepancy,\n      recentEvents: this.events.slice(-10),\n      recentIssues: this.renderingIssues.slice(-10)\n    };\n  }\n\n  /**\n   * Limpia los datos de monitoreo\n   */\n  clearMonitoringData(): void {\n    this.events = [];\n    this.renderingIssues = [];\n    console.log('游빛 Monitoring data cleared');\n  }\n\n  /**\n   * Exporta datos de monitoreo para an치lisis\n   */\n  exportMonitoringData(): string {\n    const data = {\n      sessionId: this.sessionId,\n      exportTimestamp: new Date().toISOString(),\n      events: this.events,\n      renderingIssues: this.renderingIssues,\n      stats: this.getMonitoringStats()\n    };\n\n    return JSON.stringify(data, null, 2);\n  }\n}\n\n// Instancia singleton\nexport const apiMonitoring = ApiMonitoringService.getInstance();\n\n// Hook para usar el monitoreo en componentes React\nexport function useApiMonitoring() {\n  return {\n    recordDiscrepancy: apiMonitoring.recordApiDiscrepancy.bind(apiMonitoring),\n    recordRenderingIssue: apiMonitoring.recordRenderingIssue.bind(apiMonitoring),\n    getStats: apiMonitoring.getMonitoringStats.bind(apiMonitoring),\n    clearData: apiMonitoring.clearMonitoringData.bind(apiMonitoring),\n    exportData: apiMonitoring.exportMonitoringData.bind(apiMonitoring)\n  };\n}\n\n// Utilidad para detectar autom치ticamente discrepancias\nexport function detectApiDiscrepancy(\n  endpoint: string,\n  apiResponse: { total?: number; count?: number; length?: number },\n  renderedItems: unknown[]\n): void {\n  const expectedCount = apiResponse.total || apiResponse.count || apiResponse.length || 0;\n  const actualCount = Array.isArray(renderedItems) ? renderedItems.length : 0;\n  \n  if (expectedCount !== actualCount) {\n    apiMonitoring.recordApiDiscrepancy(endpoint, expectedCount, actualCount);\n  }\n}\n\n// Decorator para monitorear autom치ticamente funciones de API\nexport function monitorApiCall(endpoint: string) {\n  return function (target: any, propertyName: string, descriptor: PropertyDescriptor) {\n    const method = descriptor.value;\n    \n    descriptor.value = async function (...args: any[]) {\n      const startTime = Date.now();\n      \n      try {\n        const result = await method.apply(this, args);\n        \n        // Si el resultado tiene datos paginados, verificar discrepancias\n        if (result && typeof result === 'object') {\n          if ('data' in result && 'pagination' in result.data) {\n            const { data } = result;\n            detectApiDiscrepancy(endpoint, data.pagination, data.orders || data.items || []);\n          }\n        }\n        \n        return result;\n      } catch (error) {\n        const duration = Date.now() - startTime;\n        console.error(`API call failed for ${endpoint} after ${duration}ms:`, error);\n        throw error;\n      }\n    };\n    \n    return descriptor;\n  };\n}"],"names":["apiMonitoring","detectApiDiscrepancy","monitorApiCall","useApiMonitoring","ApiMonitoringService","events","renderingIssues","sessionId","generateSessionId","getInstance","instance","Date","now","Math","random","toString","substr","recordApiDiscrepancy","endpoint","expectedCount","actualCount","event","timestamp","toISOString","discrepancy","userAgent","navigator","push","console","error","expected","actual","lost","percentage","toFixed","sendCriticalAlert","length","slice","recordRenderingIssue","component","expectedItems","renderedItems","filterCriteria","errorDetails","issue","warn","rendered","filters","process","env","NODE_ENV","message","recommendation","getMonitoringStats","criticalEvents","filter","e","totalDiscrepancy","reduce","sum","abs","averageDiscrepancy","totalEvents","totalIssues","recentEvents","recentIssues","clearMonitoringData","log","exportMonitoringData","data","exportTimestamp","stats","JSON","stringify","recordDiscrepancy","bind","getStats","clearData","exportData","apiResponse","total","count","Array","isArray","target","propertyName","descriptor","method","value","args","startTime","result","apply","pagination","orders","items","duration"],"mappings":"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"}