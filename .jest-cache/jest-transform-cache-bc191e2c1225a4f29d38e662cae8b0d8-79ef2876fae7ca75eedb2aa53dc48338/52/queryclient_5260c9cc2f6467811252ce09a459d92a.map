{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\lib\\query-client.ts"],"sourcesContent":["// ===================================\r\n// CONFIGURACIÓN: TanStack Query Client\r\n// ===================================\r\n\r\nimport { QueryClient } from '@tanstack/react-query';\r\n\r\n// Función para detectar errores de red que deben ser reintentados\r\nfunction shouldRetryError(error: any): boolean {\r\n  // Errores de red comunes que deben ser reintentados\r\n  const networkErrors = [\r\n    'ERR_NETWORK',\r\n    'ERR_INTERNET_DISCONNECTED',\r\n    'ERR_CONNECTION_REFUSED',\r\n    'ERR_CONNECTION_RESET',\r\n    'ERR_CONNECTION_TIMED_OUT',\r\n    'ERR_ABORTED', // Incluir ERR_ABORTED para reintentos\r\n    'NETWORK_ERROR',\r\n    'TIMEOUT_ERROR'\r\n  ];\r\n\r\n  // Verificar si es un error de red\r\n  if (error?.code && networkErrors.includes(error.code)) {\r\n    return true;\r\n  }\r\n\r\n  // Verificar por mensaje de error\r\n  if (error?.message) {\r\n    const message = error.message.toLowerCase();\r\n    if (message.includes('network') ||\r\n        message.includes('fetch') ||\r\n        message.includes('aborted') ||\r\n        message.includes('timeout') ||\r\n        message.includes('connection')) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  // Errores HTTP 5xx (servidor) deben ser reintentados\r\n  if (error?.status >= 500) {\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\n// Configuración optimizada para e-commerce con manejo robusto de errores de red\r\nexport const queryClientConfig = {\r\n  defaultOptions: {\r\n    queries: {\r\n      // Cache por 5 minutos para datos de productos\r\n      staleTime: 5 * 60 * 1000,\r\n      // Mantener en cache por 10 minutos\r\n      gcTime: 10 * 60 * 1000,\r\n      // Retry logic inteligente con manejo de errores de red\r\n      retry: (failureCount: number, error: any) => {\r\n        // No retry para errores 4xx (cliente) excepto 408 (timeout)\r\n        if (error?.status >= 400 && error?.status < 500 && error?.status !== 408) {\r\n          return false;\r\n        }\r\n\r\n        // Retry para errores de red detectados\r\n        if (shouldRetryError(error)) {\r\n          return failureCount < 3; // Más reintentos para errores de red\r\n        }\r\n\r\n        // Máximo 2 reintentos para otros errores de servidor\r\n        return failureCount < 2;\r\n      },\r\n      // Intervalo de retry con backoff exponencial más agresivo para errores de red\r\n      retryDelay: (attemptIndex: number, error: any) => {\r\n        // Delay más corto para errores de red\r\n        if (shouldRetryError(error)) {\r\n          return Math.min(500 * 2 ** attemptIndex, 5000);\r\n        }\r\n        // Delay normal para otros errores\r\n        return Math.min(1000 * 2 ** attemptIndex, 30000);\r\n      },\r\n      // Refetch en focus para datos críticos\r\n      refetchOnWindowFocus: false,\r\n      // Refetch en reconexión\r\n      refetchOnReconnect: true,\r\n      // No refetch en mount si los datos están frescos\r\n      refetchOnMount: true,\r\n      // Configuración de red más robusta\r\n      networkMode: 'online',\r\n    },\r\n    mutations: {\r\n      // Retry para mutaciones críticas con manejo de errores de red\r\n      retry: (failureCount: number, error: any) => {\r\n        // Retry para errores de red en mutaciones\r\n        if (shouldRetryError(error)) {\r\n          return failureCount < 2;\r\n        }\r\n        // Un solo retry para otros errores\r\n        return failureCount < 1;\r\n      },\r\n      retryDelay: (attemptIndex: number, error: any) => {\r\n        // Delay más corto para errores de red en mutaciones\r\n        if (shouldRetryError(error)) {\r\n          return Math.min(300 * 2 ** attemptIndex, 3000);\r\n        }\r\n        return 1000;\r\n      },\r\n      networkMode: 'online',\r\n    },\r\n  },\r\n};\r\n\r\n// Función para crear QueryClient con configuración optimizada\r\nexport function createQueryClient() {\r\n  return new QueryClient(queryClientConfig);\r\n}\r\n\r\n// Instancia singleton para uso en la aplicación\r\nexport const queryClient = createQueryClient();\r\n\r\n// Configuración específica para búsquedas\r\nexport const searchQueryConfig = {\r\n  // Cache más agresivo para búsquedas\r\n  staleTime: 2 * 60 * 1000, // 2 minutos\r\n  gcTime: 5 * 60 * 1000,    // 5 minutos\r\n  // Retry más conservador para búsquedas\r\n  retry: 1,\r\n  retryDelay: 500,\r\n  // No refetch automático para búsquedas\r\n  refetchOnWindowFocus: false,\r\n  refetchOnReconnect: false,\r\n  refetchOnMount: false,\r\n};\r\n\r\n// Keys para queries de búsqueda\r\nexport const searchQueryKeys = {\r\n  all: ['search'] as const,\r\n  searches: () => [...searchQueryKeys.all, 'searches'] as const,\r\n  search: (query: string) => [...searchQueryKeys.searches(), query] as const,\r\n  suggestions: (query: string) => [...searchQueryKeys.all, 'suggestions', query] as const,\r\n  recent: () => [...searchQueryKeys.all, 'recent'] as const,\r\n  trending: () => [...searchQueryKeys.all, 'trending'] as const,\r\n} as const;\r\n\r\n// Utilidades para invalidación de cache\r\nexport const searchQueryUtils = {\r\n  // Invalidar todas las búsquedas\r\n  invalidateAll: () => queryClient.invalidateQueries({ queryKey: searchQueryKeys.all }),\r\n  \r\n  // Invalidar búsquedas específicas\r\n  invalidateSearch: (query: string) => \r\n    queryClient.invalidateQueries({ queryKey: searchQueryKeys.search(query) }),\r\n  \r\n  // Limpiar cache de búsquedas\r\n  clearSearchCache: () => queryClient.removeQueries({ queryKey: searchQueryKeys.all }),\r\n  \r\n  // Prefetch de búsqueda\r\n  prefetchSearch: (query: string) => \r\n    queryClient.prefetchQuery({\r\n      queryKey: searchQueryKeys.search(query),\r\n      queryFn: () => import('@/lib/api/products').then(m => m.searchProducts(query, 6)),\r\n      ...searchQueryConfig,\r\n    }),\r\n};\r\n"],"names":["createQueryClient","queryClient","queryClientConfig","searchQueryConfig","searchQueryKeys","searchQueryUtils","shouldRetryError","error","networkErrors","code","includes","message","toLowerCase","status","defaultOptions","queries","staleTime","gcTime","retry","failureCount","retryDelay","attemptIndex","Math","min","refetchOnWindowFocus","refetchOnReconnect","refetchOnMount","networkMode","mutations","QueryClient","all","searches","search","query","suggestions","recent","trending","invalidateAll","invalidateQueries","queryKey","invalidateSearch","clearSearchCache","removeQueries","prefetchSearch","prefetchQuery","queryFn","then","m","searchProducts"],"mappings":"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"}