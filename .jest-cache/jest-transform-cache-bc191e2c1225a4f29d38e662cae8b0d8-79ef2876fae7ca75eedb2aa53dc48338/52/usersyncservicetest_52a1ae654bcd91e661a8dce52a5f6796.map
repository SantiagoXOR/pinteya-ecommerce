{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\__tests__\\user-sync-service.test.ts"],"sourcesContent":["/**\n * Tests para el servicio de sincronización automática de usuarios\n * Verifica la sincronización robusta entre Clerk y Supabase\n */\n\nimport { NextRequest } from 'next/server';\n\n// Mock de Clerk\njest.mock('@clerk/nextjs/server', () => ({\n  clerkClient: jest.fn(() => ({\n    users: {\n      getUser: jest.fn(),\n      getUserList: jest.fn()\n    }\n  }))\n}));\n\n// Mock de Supabase\nconst mockSupabaseChain = {\n  single: jest.fn(),\n  eq: jest.fn(() => mockSupabaseChain),\n  or: jest.fn(() => mockSupabaseChain),\n  select: jest.fn(() => mockSupabaseChain),\n  insert: jest.fn(() => mockSupabaseChain),\n  update: jest.fn(() => mockSupabaseChain)\n};\n\njest.mock('@/lib/supabase', () => ({\n  supabaseAdmin: {\n    from: jest.fn(() => mockSupabaseChain)\n  }\n}));\n\n// Mock de security audit\njest.mock('@/lib/auth/security-audit', () => ({\n  logSecurityEvent: jest.fn(),\n  logAdminAction: jest.fn()\n}));\n\nimport {\n  syncUserToSupabase,\n  syncUserFromClerk,\n  deleteUserFromSupabase,\n  bulkSyncUsersFromClerk,\n  type ClerkUserData,\n  type SyncOptions\n} from '@/lib/auth/user-sync-service';\nimport { clerkClient } from '@clerk/nextjs/server';\nimport { supabaseAdmin } from '@/lib/supabase';\n\ndescribe('Servicio de Sincronización de Usuarios', () => {\n  let mockClerkClient: jest.MockedFunction<typeof clerkClient>;\n\n  beforeEach(() => {\n    mockClerkClient = clerkClient as jest.MockedFunction<typeof clerkClient>;\n    jest.clearAllMocks();\n\n    // Reset mock chain\n    mockSupabaseChain.single.mockReset();\n    mockSupabaseChain.eq.mockReturnValue(mockSupabaseChain);\n    mockSupabaseChain.or.mockReturnValue(mockSupabaseChain);\n    mockSupabaseChain.select.mockReturnValue(mockSupabaseChain);\n    mockSupabaseChain.insert.mockReturnValue(mockSupabaseChain);\n    mockSupabaseChain.update.mockReturnValue(mockSupabaseChain);\n  });\n\n  const mockClerkUserData: ClerkUserData = {\n    id: 'user_123',\n    email_addresses: [{\n      email_address: 'test@example.com',\n      id: 'email_123',\n      verification: {\n        status: 'verified',\n        strategy: 'email_code'\n      }\n    }],\n    first_name: 'John',\n    last_name: 'Doe',\n    created_at: Date.now(),\n    updated_at: Date.now(),\n    image_url: 'https://example.com/avatar.jpg',\n    public_metadata: { role: 'customer' }\n  };\n\n  describe('syncUserToSupabase', () => {\n    it('debe crear un nuevo usuario exitosamente', async () => {\n      // Mock: usuario no existe\n      mockSupabaseChain.single\n        .mockResolvedValueOnce({\n          data: null,\n          error: { code: 'PGRST116' }\n        })\n        // Mock: rol por defecto existe\n        .mockResolvedValueOnce({\n          data: { id: 1 },\n          error: null\n        })\n        // Mock: inserción exitosa\n        .mockResolvedValueOnce({\n          data: { id: 'user_456', email: 'test@example.com' },\n          error: null\n        });\n\n      const result = await syncUserToSupabase(mockClerkUserData);\n\n      expect(result.success).toBe(true);\n      expect(result.action).toBe('created');\n      expect(result.userId).toBe('user_456');\n    });\n\n    it('debe actualizar un usuario existente', async () => {\n      const existingUser = {\n        id: 'user_456',\n        email: 'test@example.com',\n        first_name: 'Jane'\n      };\n\n      // Mock: usuario existe y actualización exitosa\n      mockSupabaseChain.single\n        .mockResolvedValueOnce({\n          data: existingUser,\n          error: null\n        })\n        .mockResolvedValueOnce({\n          data: { ...existingUser, first_name: 'John' },\n          error: null\n        });\n\n      const result = await syncUserToSupabase(mockClerkUserData);\n\n      expect(result.success).toBe(true);\n      expect(result.action).toBe('updated');\n    });\n\n    it('debe manejar errores de validación', async () => {\n      const invalidUserData = {\n        ...mockClerkUserData,\n        email_addresses: []\n      };\n\n      const result = await syncUserToSupabase(invalidUserData);\n\n      expect(result.success).toBe(false);\n      expect(result.action).toBe('error');\n      expect(result.error).toContain('Al menos un email es requerido');\n    });\n\n    it('debe reintentar en caso de error temporal', async () => {\n      // Mock: primer intento falla, luego éxito\n      mockSupabaseChain.single\n        .mockRejectedValueOnce(new Error('Conexión temporal perdida'))\n        .mockResolvedValueOnce({\n          data: null,\n          error: { code: 'PGRST116' }\n        })\n        .mockResolvedValueOnce({\n          data: { id: 1 },\n          error: null\n        })\n        .mockResolvedValueOnce({\n          data: { id: 'user_456' },\n          error: null\n        });\n\n      const result = await syncUserToSupabase(mockClerkUserData, {\n        retryAttempts: 2,\n        retryDelay: 100\n      });\n\n      expect(result.success).toBe(true);\n      expect(result.action).toBe('created');\n    });\n\n    it('debe fallar después de agotar reintentos', async () => {\n      // Mock: todos los intentos fallan\n      mockSupabaseChain.single.mockRejectedValue(new Error('Error persistente'));\n\n      const result = await syncUserToSupabase(mockClerkUserData, {\n        retryAttempts: 2,\n        retryDelay: 100\n      });\n\n      expect(result.success).toBe(false);\n      expect(result.action).toBe('error');\n      expect(result.error).toContain('Error después de 2 intentos');\n    });\n  });\n\n  describe('deleteUserFromSupabase', () => {\n    it('debe eliminar usuario exitosamente (soft delete)', async () => {\n      const existingUser = {\n        id: 'user_456',\n        email: 'test@example.com',\n        is_active: true\n      };\n\n      // Mock: actualización exitosa (soft delete)\n      mockSupabase.from().update().eq().select().single.mockResolvedValue({\n        data: { ...existingUser, is_active: false },\n        error: null\n      });\n\n      const result = await deleteUserFromSupabase('user_123');\n\n      expect(result.success).toBe(true);\n      expect(result.action).toBe('deleted');\n    });\n\n    it('debe manejar usuario no encontrado', async () => {\n      // Mock: usuario no encontrado\n      mockSupabase.from().update().eq().select().single.mockResolvedValue({\n        data: null,\n        error: { code: 'PGRST116' }\n      });\n\n      const result = await deleteUserFromSupabase('user_not_found');\n\n      expect(result.success).toBe(true);\n      expect(result.action).toBe('deleted');\n      expect(result.details?.message).toContain('Usuario no encontrado');\n    });\n  });\n\n  describe('syncUserFromClerk', () => {\n    it('debe sincronizar usuario desde Clerk exitosamente', async () => {\n      const mockClerkUser = {\n        id: 'user_123',\n        emailAddresses: [{\n          emailAddress: 'test@example.com',\n          id: 'email_123',\n          verification: { status: 'verified', strategy: 'email_code' }\n        }],\n        firstName: 'John',\n        lastName: 'Doe',\n        createdAt: Date.now(),\n        updatedAt: Date.now(),\n        imageUrl: 'https://example.com/avatar.jpg',\n        phoneNumbers: [],\n        publicMetadata: { role: 'customer' },\n        privateMetadata: {}\n      };\n\n      mockClerkClient.mockReturnValue({\n        users: {\n          getUser: jest.fn().mockResolvedValue(mockClerkUser)\n        }\n      } as any);\n\n      // Mock: usuario no existe, crear nuevo\n      mockSupabase.from().select().or().single.mockResolvedValue({\n        data: null,\n        error: { code: 'PGRST116' }\n      });\n\n      mockSupabase.from().select().eq().eq().single.mockResolvedValue({\n        data: { id: 1 },\n        error: null\n      });\n\n      mockSupabase.from().insert().select().single.mockResolvedValue({\n        data: { id: 'user_456' },\n        error: null\n      });\n\n      const result = await syncUserFromClerk('user_123');\n\n      expect(result.success).toBe(true);\n      expect(result.action).toBe('created');\n    });\n\n    it('debe manejar usuario no encontrado en Clerk', async () => {\n      mockClerkClient.mockReturnValue({\n        users: {\n          getUser: jest.fn().mockResolvedValue(null)\n        }\n      } as any);\n\n      const result = await syncUserFromClerk('user_not_found');\n\n      expect(result.success).toBe(false);\n      expect(result.error).toContain('Usuario no encontrado en Clerk');\n    });\n  });\n\n  describe('bulkSyncUsersFromClerk', () => {\n    it('debe sincronizar múltiples usuarios exitosamente', async () => {\n      const mockClerkUsers = [\n        {\n          id: 'user_1',\n          emailAddresses: [{ emailAddress: 'user1@example.com', id: 'email_1', verification: { status: 'verified' } }],\n          firstName: 'User',\n          lastName: 'One',\n          createdAt: Date.now(),\n          updatedAt: Date.now(),\n          imageUrl: '',\n          phoneNumbers: [],\n          publicMetadata: {},\n          privateMetadata: {}\n        },\n        {\n          id: 'user_2',\n          emailAddresses: [{ emailAddress: 'user2@example.com', id: 'email_2', verification: { status: 'verified' } }],\n          firstName: 'User',\n          lastName: 'Two',\n          createdAt: Date.now(),\n          updatedAt: Date.now(),\n          imageUrl: '',\n          phoneNumbers: [],\n          publicMetadata: {},\n          privateMetadata: {}\n        }\n      ];\n\n      mockClerkClient.mockReturnValue({\n        users: {\n          getUserList: jest.fn().mockResolvedValue(mockClerkUsers)\n        }\n      } as any);\n\n      // Mock: usuarios no existen, crear nuevos\n      mockSupabase.from().select().or().single.mockResolvedValue({\n        data: null,\n        error: { code: 'PGRST116' }\n      });\n\n      mockSupabase.from().select().eq().eq().single.mockResolvedValue({\n        data: { id: 1 },\n        error: null\n      });\n\n      mockSupabase.from().insert().select().single.mockResolvedValue({\n        data: { id: 'new_user' },\n        error: null\n      });\n\n      const result = await bulkSyncUsersFromClerk({\n        batchSize: 2,\n        maxUsers: 2\n      });\n\n      expect(result.success).toBe(true);\n      expect(result.totalProcessed).toBe(2);\n      expect(result.successful).toBe(2);\n      expect(result.failed).toBe(0);\n    });\n\n    it('debe manejar errores en sincronización masiva', async () => {\n      mockClerkClient.mockReturnValue({\n        users: {\n          getUserList: jest.fn().mockRejectedValue(new Error('Error de Clerk'))\n        }\n      } as any);\n\n      const result = await bulkSyncUsersFromClerk();\n\n      expect(result.success).toBe(false);\n      expect(result.failed).toBe(1);\n      expect(result.results[0].error).toContain('Error en sincronización masiva');\n    });\n  });\n});\n"],"names":["jest","mock","clerkClient","fn","users","getUser","getUserList","supabaseAdmin","from","mockSupabaseChain","logSecurityEvent","logAdminAction","single","eq","or","select","insert","update","describe","mockClerkClient","beforeEach","clearAllMocks","mockReset","mockReturnValue","mockClerkUserData","id","email_addresses","email_address","verification","status","strategy","first_name","last_name","created_at","Date","now","updated_at","image_url","public_metadata","role","it","mockResolvedValueOnce","data","error","code","email","result","syncUserToSupabase","expect","success","toBe","action","userId","existingUser","invalidUserData","toContain","mockRejectedValueOnce","Error","retryAttempts","retryDelay","mockRejectedValue","is_active","mockSupabase","mockResolvedValue","deleteUserFromSupabase","details","message","mockClerkUser","emailAddresses","emailAddress","firstName","lastName","createdAt","updatedAt","imageUrl","phoneNumbers","publicMetadata","privateMetadata","syncUserFromClerk","mockClerkUsers","bulkSyncUsersFromClerk","batchSize","maxUsers","totalProcessed","successful","failed","results"],"mappings":"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"}