{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\lib\\monitoring\\enterprise-metrics.ts"],"sourcesContent":["// ===================================\n// PINTEYA E-COMMERCE - ENTERPRISE METRICS SYSTEM\n// ===================================\n\nimport { logger, LogLevel, LogCategory } from '@/lib/logger';\nimport { getSupabaseClient } from '@/lib/supabase';\nimport { CacheUtils } from '@/lib/cache-manager';\nimport { enterpriseAlertSystem, AlertLevel as AlertSystemLevel } from './alert-system';\n\n// Tipos de métricas enterprise\nexport enum MetricType {\n  COUNTER = 'counter',           // Contador incremental\n  GAUGE = 'gauge',              // Valor actual\n  HISTOGRAM = 'histogram',       // Distribución de valores\n  TIMER = 'timer',              // Medición de tiempo\n  RATE = 'rate'                 // Tasa por unidad de tiempo\n}\n\n// Categorías de métricas de negocio\nexport enum BusinessMetricCategory {\n  PERFORMANCE = 'performance',\n  SECURITY = 'security',\n  BUSINESS = 'business',\n  INFRASTRUCTURE = 'infrastructure',\n  USER_EXPERIENCE = 'user_experience'\n}\n\n// Niveles de alerta\nexport enum AlertLevel {\n  INFO = 'info',\n  WARNING = 'warning',\n  CRITICAL = 'critical',\n  EMERGENCY = 'emergency'\n}\n\n// Métrica enterprise\nexport interface EnterpriseMetric {\n  id: string;\n  name: string;\n  type: MetricType;\n  category: BusinessMetricCategory;\n  value: number;\n  timestamp: string;\n  tags: Record<string, string>;\n  metadata?: Record<string, any>;\n  aggregationPeriod?: string; // '1m', '5m', '1h', '1d'\n}\n\n// Configuración de alerta\nexport interface AlertRule {\n  id: string;\n  metricName: string;\n  condition: 'gt' | 'lt' | 'eq' | 'gte' | 'lte';\n  threshold: number;\n  level: AlertLevel;\n  enabled: boolean;\n  cooldownMinutes: number;\n  description: string;\n  actions: AlertAction[];\n}\n\n// Acción de alerta\nexport interface AlertAction {\n  type: 'email' | 'webhook' | 'log' | 'slack';\n  config: Record<string, any>;\n}\n\n// Alerta activa\nexport interface ActiveAlert {\n  id: string;\n  ruleId: string;\n  metricName: string;\n  level: AlertLevel;\n  message: string;\n  value: number;\n  threshold: number;\n  triggeredAt: string;\n  resolvedAt?: string;\n  metadata?: Record<string, any>;\n}\n\n// Agregación temporal\nexport interface MetricAggregation {\n  period: string;\n  startTime: string;\n  endTime: string;\n  count: number;\n  sum: number;\n  avg: number;\n  min: number;\n  max: number;\n  p50: number;\n  p95: number;\n  p99: number;\n}\n\n/**\n * Sistema de Métricas Enterprise con agregación temporal y alertas\n */\nexport class EnterpriseMetricsCollector {\n  private static instance: EnterpriseMetricsCollector;\n  private alertRules: Map<string, AlertRule> = new Map();\n  private activeAlerts: Map<string, ActiveAlert> = new Map();\n  private metricsBuffer: EnterpriseMetric[] = [];\n  private flushInterval: NodeJS.Timeout | null = null;\n\n  constructor() {\n    this.initializeDefaultAlerts();\n    this.startMetricsFlush();\n  }\n\n  static getInstance(): EnterpriseMetricsCollector {\n    if (!EnterpriseMetricsCollector.instance) {\n      EnterpriseMetricsCollector.instance = new EnterpriseMetricsCollector();\n    }\n    return EnterpriseMetricsCollector.instance;\n  }\n\n  /**\n   * Registra una métrica enterprise\n   */\n  async recordMetric(\n    name: string,\n    value: number,\n    type: MetricType = MetricType.GAUGE,\n    category: BusinessMetricCategory = BusinessMetricCategory.PERFORMANCE,\n    tags: Record<string, string> = {},\n    metadata?: Record<string, any>\n  ): Promise<void> {\n    try {\n      const metric: EnterpriseMetric = {\n        id: this.generateMetricId(),\n        name,\n        type,\n        category,\n        value,\n        timestamp: new Date().toISOString(),\n        tags,\n        metadata\n      };\n\n      // Agregar a buffer para flush batch\n      this.metricsBuffer.push(metric);\n\n      // Verificar alertas\n      await this.checkAlerts(metric);\n\n      // Log para debugging\n      logger.debug(LogLevel.DEBUG, `Metric recorded: ${name}`, {\n        value,\n        type,\n        category,\n        tags\n      }, LogCategory.SYSTEM);\n\n    } catch (error) {\n      logger.error(LogLevel.ERROR, `Failed to record metric: ${name}`, {\n        error: error instanceof Error ? error.message : 'Unknown error',\n        value,\n        type\n      }, LogCategory.SYSTEM);\n    }\n  }\n\n  /**\n   * Métricas de performance específicas\n   */\n  async recordPerformanceMetric(\n    operation: string,\n    duration: number,\n    success: boolean,\n    tags: Record<string, string> = {}\n  ): Promise<void> {\n    await this.recordMetric(\n      `performance.${operation}.duration`,\n      duration,\n      MetricType.TIMER,\n      BusinessMetricCategory.PERFORMANCE,\n      { ...tags, success: success.toString() }\n    );\n\n    await this.recordMetric(\n      `performance.${operation}.count`,\n      1,\n      MetricType.COUNTER,\n      BusinessMetricCategory.PERFORMANCE,\n      { ...tags, success: success.toString() }\n    );\n  }\n\n  /**\n   * Métricas de negocio específicas\n   */\n  async recordBusinessMetric(\n    event: string,\n    value: number = 1,\n    tags: Record<string, string> = {}\n  ): Promise<void> {\n    await this.recordMetric(\n      `business.${event}`,\n      value,\n      MetricType.COUNTER,\n      BusinessMetricCategory.BUSINESS,\n      tags\n    );\n  }\n\n  /**\n   * Métricas de seguridad específicas\n   */\n  async recordSecurityMetric(\n    event: string,\n    severity: 'low' | 'medium' | 'high' | 'critical',\n    tags: Record<string, string> = {}\n  ): Promise<void> {\n    await this.recordMetric(\n      `security.${event}`,\n      1,\n      MetricType.COUNTER,\n      BusinessMetricCategory.SECURITY,\n      { ...tags, severity }\n    );\n  }\n\n  /**\n   * Métricas de experiencia de usuario\n   */\n  async recordUserExperienceMetric(\n    metric: string,\n    value: number,\n    userId?: string,\n    tags: Record<string, string> = {}\n  ): Promise<void> {\n    await this.recordMetric(\n      `ux.${metric}`,\n      value,\n      MetricType.GAUGE,\n      BusinessMetricCategory.USER_EXPERIENCE,\n      { ...tags, userId: userId || 'anonymous' }\n    );\n  }\n\n  /**\n   * Configura una regla de alerta\n   */\n  setAlertRule(rule: AlertRule): void {\n    this.alertRules.set(rule.id, rule);\n    logger.info(LogLevel.INFO, `Alert rule configured: ${rule.id}`, {\n      metricName: rule.metricName,\n      threshold: rule.threshold,\n      level: rule.level\n    }, LogCategory.SYSTEM);\n  }\n\n  /**\n   * Verifica alertas para una métrica\n   */\n  private async checkAlerts(metric: EnterpriseMetric): Promise<void> {\n    for (const rule of this.alertRules.values()) {\n      if (!rule.enabled || rule.metricName !== metric.name) {\n        continue;\n      }\n\n      // Verificar si ya hay una alerta activa en cooldown\n      const existingAlert = Array.from(this.activeAlerts.values())\n        .find(alert => alert.ruleId === rule.id && !alert.resolvedAt);\n\n      if (existingAlert) {\n        const cooldownEnd = new Date(existingAlert.triggeredAt);\n        cooldownEnd.setMinutes(cooldownEnd.getMinutes() + rule.cooldownMinutes);\n        \n        if (new Date() < cooldownEnd) {\n          continue; // Aún en cooldown\n        }\n      }\n\n      // Evaluar condición\n      const triggered = this.evaluateCondition(metric.value, rule.condition, rule.threshold);\n\n      if (triggered) {\n        await this.triggerAlert(rule, metric);\n      }\n    }\n  }\n\n  /**\n   * Evalúa condición de alerta\n   */\n  private evaluateCondition(value: number, condition: string, threshold: number): boolean {\n    switch (condition) {\n      case 'gt': return value > threshold;\n      case 'gte': return value >= threshold;\n      case 'lt': return value < threshold;\n      case 'lte': return value <= threshold;\n      case 'eq': return value === threshold;\n      default: return false;\n    }\n  }\n\n  /**\n   * Dispara una alerta usando el sistema enterprise\n   */\n  private async triggerAlert(rule: AlertRule, metric: EnterpriseMetric): Promise<void> {\n    // Convertir nivel de alerta al sistema enterprise\n    const alertLevel = this.convertToAlertSystemLevel(rule.level);\n\n    // Usar el sistema de alertas enterprise\n    const alert = await enterpriseAlertSystem.triggerAlert(\n      rule.id,\n      rule.metricName,\n      metric.value,\n      `${rule.description} - Value: ${metric.value}, Threshold: ${rule.threshold}`\n    );\n\n    if (alert) {\n      // Mantener referencia local para compatibilidad\n      const localAlert: ActiveAlert = {\n        id: alert.id,\n        ruleId: alert.ruleId,\n        metricName: alert.metricName,\n        level: rule.level,\n        message: alert.message,\n        value: alert.value,\n        threshold: alert.threshold,\n        triggeredAt: alert.triggeredAt,\n        metadata: {\n          metric: metric,\n          rule: rule\n        }\n      };\n\n      this.activeAlerts.set(alert.id, localAlert);\n\n      // Log alerta\n      logger.warn(LogLevel.WARN, `Alert triggered via enterprise system: ${rule.id}`, {\n        alertId: alert.id,\n        level: alert.level,\n        metricName: alert.metricName,\n        value: alert.value,\n        threshold: alert.threshold\n      }, LogCategory.SYSTEM);\n    }\n  }\n\n  /**\n   * Ejecuta acción de alerta\n   */\n  private async executeAlertAction(action: AlertAction, alert: ActiveAlert): Promise<void> {\n    try {\n      switch (action.type) {\n        case 'log':\n          logger.error(LogLevel.ERROR, `ALERT: ${alert.message}`, {\n            alertId: alert.id,\n            level: alert.level\n          }, LogCategory.SYSTEM);\n          break;\n\n        case 'webhook':\n          if (action.config.url) {\n            await fetch(action.config.url, {\n              method: 'POST',\n              headers: { 'Content-Type': 'application/json' },\n              body: JSON.stringify(alert)\n            });\n          }\n          break;\n\n        case 'email':\n          // TODO: Implementar envío de email\n          logger.info(LogLevel.INFO, `Email alert would be sent to: ${action.config.to}`, {\n            alertId: alert.id\n          }, LogCategory.SYSTEM);\n          break;\n\n        case 'slack':\n          // TODO: Implementar notificación Slack\n          logger.info(LogLevel.INFO, `Slack alert would be sent to: ${action.config.channel}`, {\n            alertId: alert.id\n          }, LogCategory.SYSTEM);\n          break;\n      }\n    } catch (error) {\n      logger.error(LogLevel.ERROR, `Failed to execute alert action: ${action.type}`, {\n        error: error instanceof Error ? error.message : 'Unknown error',\n        alertId: alert.id\n      }, LogCategory.SYSTEM);\n    }\n  }\n\n  /**\n   * Obtiene métricas agregadas\n   */\n  async getAggregatedMetrics(\n    metricName: string,\n    period: '1m' | '5m' | '1h' | '1d' | '7d',\n    startTime: string,\n    endTime: string\n  ): Promise<MetricAggregation[]> {\n    const cacheKey = `metrics:aggregated:${metricName}:${period}:${startTime}:${endTime}`;\n    \n    return CacheUtils.cacheMetricsAggregation(cacheKey, async () => {\n      const supabase = getSupabaseClient(true);\n      \n      if (!supabase) {\n        throw new Error('Supabase client not available');\n      }\n\n      // Query con agregación SQL\n      const { data, error } = await supabase.rpc('aggregate_metrics', {\n        metric_name: metricName,\n        period_interval: period,\n        start_time: startTime,\n        end_time: endTime\n      });\n\n      if (error) {\n        throw new Error(`Failed to aggregate metrics: ${error.message}`);\n      }\n\n      return data || [];\n    });\n  }\n\n  /**\n   * Flush métricas a base de datos\n   */\n  private async flushMetrics(): Promise<void> {\n    if (this.metricsBuffer.length === 0) {\n      return;\n    }\n\n    try {\n      const metrics = [...this.metricsBuffer];\n      this.metricsBuffer = [];\n\n      const supabase = getSupabaseClient(true);\n      if (!supabase) {\n        logger.error(LogLevel.ERROR, 'Supabase client not available for metrics flush', {}, LogCategory.SYSTEM);\n        return;\n      }\n\n      const { error } = await supabase\n        .from('enterprise_metrics')\n        .insert(metrics.map(metric => ({\n          id: metric.id,\n          name: metric.name,\n          type: metric.type,\n          category: metric.category,\n          value: metric.value,\n          timestamp: metric.timestamp,\n          tags: metric.tags,\n          metadata: metric.metadata\n        })));\n\n      if (error) {\n        logger.error(LogLevel.ERROR, 'Failed to flush metrics to database', {\n          error: error.message,\n          metricsCount: metrics.length\n        }, LogCategory.SYSTEM);\n      } else {\n        logger.debug(LogLevel.DEBUG, `Flushed ${metrics.length} metrics to database`, {}, LogCategory.SYSTEM);\n      }\n\n    } catch (error) {\n      logger.error(LogLevel.ERROR, 'Error during metrics flush', {\n        error: error instanceof Error ? error.message : 'Unknown error'\n      }, LogCategory.SYSTEM);\n    }\n  }\n\n  /**\n   * Inicializa alertas por defecto\n   */\n  private initializeDefaultAlerts(): void {\n    // Alerta de response time alto\n    this.setAlertRule({\n      id: 'high_response_time',\n      metricName: 'performance.api.duration',\n      condition: 'gt',\n      threshold: 5000, // 5 segundos\n      level: AlertLevel.WARNING,\n      enabled: true,\n      cooldownMinutes: 5,\n      description: 'API response time is too high',\n      actions: [{ type: 'log', config: {} }]\n    });\n\n    // Alerta de error rate alto\n    this.setAlertRule({\n      id: 'high_error_rate',\n      metricName: 'performance.api.error_rate',\n      condition: 'gt',\n      threshold: 0.05, // 5%\n      level: AlertLevel.CRITICAL,\n      enabled: true,\n      cooldownMinutes: 2,\n      description: 'API error rate is too high',\n      actions: [{ type: 'log', config: {} }]\n    });\n\n    // Alerta de violaciones de seguridad\n    this.setAlertRule({\n      id: 'security_violations',\n      metricName: 'security.violation',\n      condition: 'gte',\n      threshold: 1,\n      level: AlertLevel.EMERGENCY,\n      enabled: true,\n      cooldownMinutes: 1,\n      description: 'Security violation detected',\n      actions: [{ type: 'log', config: {} }]\n    });\n  }\n\n  /**\n   * Inicia flush automático de métricas\n   */\n  private startMetricsFlush(): void {\n    this.flushInterval = setInterval(() => {\n      this.flushMetrics();\n    }, 30000); // Flush cada 30 segundos\n  }\n\n  /**\n   * Almacena alerta en base de datos\n   */\n  private async storeAlert(alert: ActiveAlert): Promise<void> {\n    try {\n      const supabase = getSupabaseClient(true);\n      if (!supabase) return;\n\n      await supabase.from('enterprise_alerts').insert({\n        id: alert.id,\n        rule_id: alert.ruleId,\n        metric_name: alert.metricName,\n        level: alert.level,\n        message: alert.message,\n        value: alert.value,\n        threshold: alert.threshold,\n        triggered_at: alert.triggeredAt,\n        resolved_at: alert.resolvedAt,\n        metadata: alert.metadata\n      });\n    } catch (error) {\n      logger.error(LogLevel.ERROR, 'Failed to store alert', {\n        error: error instanceof Error ? error.message : 'Unknown error',\n        alertId: alert.id\n      }, LogCategory.SYSTEM);\n    }\n  }\n\n  /**\n   * Genera ID único para métrica\n   */\n  private generateMetricId(): string {\n    return `metric_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  }\n\n  /**\n   * Convierte nivel de alerta al sistema enterprise\n   */\n  private convertToAlertSystemLevel(level: AlertLevel): AlertSystemLevel {\n    switch (level) {\n      case AlertLevel.INFO:\n        return AlertSystemLevel.INFO;\n      case AlertLevel.WARNING:\n        return AlertSystemLevel.WARNING;\n      case AlertLevel.CRITICAL:\n        return AlertSystemLevel.CRITICAL;\n      case AlertLevel.EMERGENCY:\n        return AlertSystemLevel.EMERGENCY;\n      default:\n        return AlertSystemLevel.INFO;\n    }\n  }\n\n  /**\n   * Genera ID único para alerta\n   */\n  private generateAlertId(): string {\n    return `alert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  }\n\n  /**\n   * Limpia recursos\n   */\n  destroy(): void {\n    if (this.flushInterval) {\n      clearInterval(this.flushInterval);\n      this.flushInterval = null;\n    }\n    this.flushMetrics(); // Flush final\n  }\n}\n\n// Instancia singleton\nexport const enterpriseMetrics = EnterpriseMetricsCollector.getInstance();\n\n// Funciones de conveniencia\nexport const recordPerformanceMetric = enterpriseMetrics.recordPerformanceMetric.bind(enterpriseMetrics);\nexport const recordBusinessMetric = enterpriseMetrics.recordBusinessMetric.bind(enterpriseMetrics);\nexport const recordSecurityMetric = enterpriseMetrics.recordSecurityMetric.bind(enterpriseMetrics);\nexport const recordUserExperienceMetric = enterpriseMetrics.recordUserExperienceMetric.bind(enterpriseMetrics);\n"],"names":["AlertLevel","BusinessMetricCategory","EnterpriseMetricsCollector","MetricType","enterpriseMetrics","recordBusinessMetric","recordPerformanceMetric","recordSecurityMetric","recordUserExperienceMetric","constructor","alertRules","Map","activeAlerts","metricsBuffer","flushInterval","initializeDefaultAlerts","startMetricsFlush","getInstance","instance","recordMetric","name","value","type","category","tags","metadata","metric","id","generateMetricId","timestamp","Date","toISOString","push","checkAlerts","logger","debug","LogLevel","DEBUG","LogCategory","SYSTEM","error","ERROR","Error","message","operation","duration","success","toString","event","severity","userId","setAlertRule","rule","set","info","INFO","metricName","threshold","level","values","enabled","existingAlert","Array","from","find","alert","ruleId","resolvedAt","cooldownEnd","triggeredAt","setMinutes","getMinutes","cooldownMinutes","triggered","evaluateCondition","condition","triggerAlert","alertLevel","convertToAlertSystemLevel","enterpriseAlertSystem","description","localAlert","warn","WARN","alertId","executeAlertAction","action","config","url","fetch","method","headers","body","JSON","stringify","to","channel","getAggregatedMetrics","period","startTime","endTime","cacheKey","CacheUtils","cacheMetricsAggregation","supabase","getSupabaseClient","data","rpc","metric_name","period_interval","start_time","end_time","flushMetrics","length","metrics","insert","map","metricsCount","actions","setInterval","storeAlert","rule_id","triggered_at","resolved_at","now","Math","random","substr","AlertSystemLevel","WARNING","CRITICAL","EMERGENCY","generateAlertId","destroy","clearInterval","bind"],"mappings":"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"}