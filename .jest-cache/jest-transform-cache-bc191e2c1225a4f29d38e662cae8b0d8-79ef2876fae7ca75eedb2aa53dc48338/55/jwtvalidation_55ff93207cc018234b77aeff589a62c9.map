{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\lib\\auth\\jwt-validation.ts"],"sourcesContent":["/**\n * Validaciones Avanzadas de JWT para Seguridad\n * Implementa verificación de integridad, autenticidad y validez de tokens\n */\n\nimport { auth } from '@/auth';\nimport { NextRequest } from 'next/server';\nimport type { NextApiRequest } from 'next';\n\n// =====================================================\n// TIPOS Y INTERFACES\n// =====================================================\n\nexport interface JWTValidationResult {\n  valid: boolean;\n  payload?: any;\n  error?: string;\n  code?: string;\n  severity?: 'low' | 'medium' | 'high' | 'critical';\n  details?: {\n    issuer?: string;\n    audience?: string;\n    expiresAt?: number;\n    issuedAt?: number;\n    notBefore?: number;\n    subject?: string;\n    sessionId?: string;\n    metadata?: any;\n  };\n}\n\nexport interface TokenSecurityChecks {\n  signatureValid: boolean;\n  notExpired: boolean;\n  notBeforeValid: boolean;\n  issuerValid: boolean;\n  audienceValid: boolean;\n  subjectValid: boolean;\n  metadataValid: boolean;\n  sessionValid: boolean;\n}\n\n// =====================================================\n// CONFIGURACIÓN DE SEGURIDAD\n// =====================================================\n\nconst JWT_SECURITY_CONFIG = {\n  // Tiempo máximo de vida del token (24 horas)\n  maxTokenAge: 24 * 60 * 60 * 1000,\n  \n  // Tiempo mínimo antes de expiración para considerar válido (5 minutos)\n  minTimeBeforeExpiry: 5 * 60 * 1000,\n  \n  // Issuer esperado de Clerk\n  expectedIssuer: process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY?.split('_')[1] || 'clerk',\n  \n  // Audience esperada\n  expectedAudience: process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY || '',\n  \n  // Algoritmos permitidos\n  allowedAlgorithms: ['RS256', 'HS256'],\n  \n  // Claims requeridos\n  requiredClaims: ['sub', 'iat', 'exp', 'iss', 'aud']\n};\n\n// =====================================================\n// FUNCIONES DE VALIDACIÓN DE JWT\n// =====================================================\n\n/**\n * Valida la integridad y autenticidad de un token JWT\n */\nexport async function validateJWTIntegrity(\n  request?: NextRequest | NextApiRequest\n): Promise<JWTValidationResult> {\n  try {\n    let token: string | null = null;\n    let payload: any = null;\n\n    // NextAuth.js - Obtener sesión en lugar de token JWT\n    if (request && 'query' in request) {\n      // Pages Router - No soportado con NextAuth.js\n      return {\n        valid: false,\n        error: 'Pages Router no soportado con NextAuth.js',\n        code: 'NOT_SUPPORTED',\n        severity: 'medium'\n      };\n    } else {\n      // App Router - NextAuth.js\n      try {\n        const session = await auth();\n        if (!session?.user) {\n          return {\n            valid: false,\n            error: 'Usuario no autenticado',\n            code: 'NOT_AUTHENTICATED',\n            severity: 'medium'\n          };\n        }\n        // Para NextAuth.js, consideramos válida la sesión si existe\n        return {\n          valid: true,\n          payload: {\n            userId: session.user.id,\n            email: session.user.email,\n            name: session.user.name\n          },\n          claims: {\n            sub: session.user.id,\n            email: session.user.email\n          }\n        };\n      } catch (error) {\n        return {\n          valid: false,\n          error: 'Error obteniendo sesión desde NextAuth.js',\n          code: 'SESSION_RETRIEVAL_ERROR',\n          severity: 'medium'\n        };\n      }\n    }\n\n    if (!token) {\n      return {\n        valid: false,\n        error: 'Token JWT no encontrado',\n        code: 'TOKEN_NOT_FOUND',\n        severity: 'high'\n      };\n    }\n\n    // Decodificar token (sin verificar firma - solo para inspección)\n    try {\n      const parts = token.split('.');\n      if (parts.length !== 3) {\n        return {\n          valid: false,\n          error: 'Formato de token JWT inválido',\n          code: 'INVALID_TOKEN_FORMAT',\n          severity: 'high'\n        };\n      }\n\n      const header = JSON.parse(atob(parts[0]));\n      payload = JSON.parse(atob(parts[1]));\n\n      // Validar algoritmo\n      if (!JWT_SECURITY_CONFIG.allowedAlgorithms.includes(header.alg)) {\n        return {\n          valid: false,\n          error: `Algoritmo de token no permitido: ${header.alg}`,\n          code: 'INVALID_ALGORITHM',\n          severity: 'critical'\n        };\n      }\n\n    } catch (decodeError) {\n      return {\n        valid: false,\n        error: 'Error decodificando token JWT',\n        code: 'TOKEN_DECODE_ERROR',\n        severity: 'high'\n      };\n    }\n\n    // Ejecutar verificaciones de seguridad\n    const securityChecks = await performTokenSecurityChecks(payload, token);\n    \n    if (!securityChecks.signatureValid) {\n      return {\n        valid: false,\n        error: 'Firma del token inválida',\n        code: 'INVALID_SIGNATURE',\n        severity: 'critical'\n      };\n    }\n\n    if (!securityChecks.notExpired) {\n      return {\n        valid: false,\n        error: 'Token expirado',\n        code: 'TOKEN_EXPIRED',\n        severity: 'high'\n      };\n    }\n\n    if (!securityChecks.issuerValid) {\n      return {\n        valid: false,\n        error: 'Issuer del token inválido',\n        code: 'INVALID_ISSUER',\n        severity: 'high'\n      };\n    }\n\n    // Token válido\n    return {\n      valid: true,\n      payload,\n      details: {\n        issuer: payload.iss,\n        audience: payload.aud,\n        expiresAt: payload.exp,\n        issuedAt: payload.iat,\n        notBefore: payload.nbf,\n        subject: payload.sub,\n        sessionId: payload.sid,\n        metadata: payload.metadata\n      }\n    };\n\n  } catch (error) {\n    console.error('[JWT] Error en validación de integridad:', error);\n    return {\n      valid: false,\n      error: 'Error interno en validación de JWT',\n      code: 'VALIDATION_ERROR',\n      severity: 'critical'\n    };\n  }\n}\n\n/**\n * Realiza verificaciones de seguridad específicas del token\n */\nasync function performTokenSecurityChecks(\n  payload: any,\n  token: string\n): Promise<TokenSecurityChecks> {\n  const now = Math.floor(Date.now() / 1000);\n\n  return {\n    // Verificar que el token no esté expirado\n    notExpired: payload.exp && payload.exp > now,\n    \n    // Verificar notBefore si existe\n    notBeforeValid: !payload.nbf || payload.nbf <= now,\n    \n    // Verificar issuer\n    issuerValid: payload.iss && payload.iss.includes('clerk'),\n    \n    // Verificar audience\n    audienceValid: payload.aud && typeof payload.aud === 'string',\n    \n    // Verificar subject (userId)\n    subjectValid: payload.sub && typeof payload.sub === 'string',\n    \n    // Verificar metadata básica\n    metadataValid: true, // Clerk maneja esto internamente\n    \n    // Verificar sesión\n    sessionValid: payload.sid && typeof payload.sid === 'string',\n    \n    // Nota: La verificación de firma la hace Clerk internamente\n    signatureValid: true\n  };\n}\n\n/**\n * Valida permisos específicos en el token JWT\n */\nexport async function validateJWTPermissions(\n  requiredRole: string,\n  requiredPermissions: string[] = [],\n  request?: NextRequest | NextApiRequest\n): Promise<JWTValidationResult> {\n  try {\n    const jwtValidation = await validateJWTIntegrity(request);\n    \n    if (!jwtValidation.valid) {\n      return jwtValidation;\n    }\n\n    const payload = jwtValidation.payload;\n    \n    // Verificar rol en metadata\n    const userRole = payload.metadata?.role || payload.role;\n    if (requiredRole && userRole !== requiredRole) {\n      return {\n        valid: false,\n        error: `Rol requerido: ${requiredRole}, rol actual: ${userRole}`,\n        code: 'INSUFFICIENT_ROLE',\n        severity: 'high'\n      };\n    }\n\n    // Verificar permisos específicos si se proporcionan\n    if (requiredPermissions.length > 0) {\n      const userPermissions = payload.metadata?.permissions || [];\n      const hasAllPermissions = requiredPermissions.every(\n        permission => userPermissions.includes(permission)\n      );\n      \n      if (!hasAllPermissions) {\n        return {\n          valid: false,\n          error: `Permisos insuficientes. Requeridos: ${requiredPermissions.join(', ')}`,\n          code: 'INSUFFICIENT_PERMISSIONS',\n          severity: 'high'\n        };\n      }\n    }\n\n    return {\n      valid: true,\n      payload,\n      details: jwtValidation.details\n    };\n\n  } catch (error) {\n    console.error('[JWT] Error en validación de permisos:', error);\n    return {\n      valid: false,\n      error: 'Error interno en validación de permisos JWT',\n      code: 'PERMISSION_VALIDATION_ERROR',\n      severity: 'critical'\n    };\n  }\n}\n\n/**\n * Middleware para validación automática de JWT\n */\nexport function withJWTValidation(\n  requiredRole?: string,\n  requiredPermissions?: string[]\n) {\n  return function (handler: Function) {\n    return async (request: NextRequest | NextApiRequest, ...args: any[]) => {\n      try {\n        // Validar integridad del JWT\n        const jwtValidation = await validateJWTIntegrity(request);\n        \n        if (!jwtValidation.valid) {\n          const errorResponse = {\n            success: false,\n            error: jwtValidation.error,\n            code: jwtValidation.code,\n            severity: jwtValidation.severity\n          };\n\n          if ('query' in request) {\n            // Pages Router\n            const res = args[0] as any;\n            return res.status(401).json(errorResponse);\n          } else {\n            // App Router\n            return new Response(JSON.stringify(errorResponse), {\n              status: 401,\n              headers: { 'Content-Type': 'application/json' }\n            });\n          }\n        }\n\n        // Validar permisos si se especifican\n        if (requiredRole || requiredPermissions) {\n          const permissionValidation = await validateJWTPermissions(\n            requiredRole || '',\n            requiredPermissions || [],\n            request\n          );\n          \n          if (!permissionValidation.valid) {\n            const errorResponse = {\n              success: false,\n              error: permissionValidation.error,\n              code: permissionValidation.code,\n              severity: permissionValidation.severity\n            };\n\n            if ('query' in request) {\n              // Pages Router\n              const res = args[0] as any;\n              return res.status(403).json(errorResponse);\n            } else {\n              // App Router\n              return new Response(JSON.stringify(errorResponse), {\n                status: 403,\n                headers: { 'Content-Type': 'application/json' }\n              });\n            }\n          }\n        }\n\n        // Añadir información del JWT al request\n        (request as any).jwtPayload = jwtValidation.payload;\n        (request as any).jwtDetails = jwtValidation.details;\n\n        return handler(request, ...args);\n\n      } catch (error) {\n        console.error('[JWT] Error en middleware de validación:', error);\n        \n        const errorResponse = {\n          success: false,\n          error: 'Error interno en validación JWT',\n          code: 'JWT_MIDDLEWARE_ERROR'\n        };\n\n        if ('query' in request) {\n          // Pages Router\n          const res = args[0] as any;\n          return res.status(500).json(errorResponse);\n        } else {\n          // App Router\n          return new Response(JSON.stringify(errorResponse), {\n            status: 500,\n            headers: { 'Content-Type': 'application/json' }\n          });\n        }\n      }\n    };\n  };\n}\n"],"names":["validateJWTIntegrity","validateJWTPermissions","withJWTValidation","JWT_SECURITY_CONFIG","maxTokenAge","minTimeBeforeExpiry","expectedIssuer","process","env","NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY","split","expectedAudience","allowedAlgorithms","requiredClaims","request","token","payload","valid","error","code","severity","session","auth","user","userId","id","email","name","claims","sub","parts","length","header","JSON","parse","atob","includes","alg","decodeError","securityChecks","performTokenSecurityChecks","signatureValid","notExpired","issuerValid","details","issuer","iss","audience","aud","expiresAt","exp","issuedAt","iat","notBefore","nbf","subject","sessionId","sid","metadata","console","now","Math","floor","Date","notBeforeValid","audienceValid","subjectValid","metadataValid","sessionValid","requiredRole","requiredPermissions","jwtValidation","userRole","role","userPermissions","permissions","hasAllPermissions","every","permission","join","handler","args","errorResponse","success","res","status","json","Response","stringify","headers","permissionValidation","jwtPayload","jwtDetails"],"mappings":"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"}