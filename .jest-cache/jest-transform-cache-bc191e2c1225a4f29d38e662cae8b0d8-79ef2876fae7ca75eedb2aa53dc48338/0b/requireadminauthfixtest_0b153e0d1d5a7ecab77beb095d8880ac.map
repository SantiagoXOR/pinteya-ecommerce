{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\__tests__\\auth\\require-admin-auth-fix.test.ts"],"sourcesContent":["// ===================================\r\n// PINTEYA E-COMMERCE - TEST PARA VERIFICAR CORRECCIÓN requireAdminAuth\r\n// ===================================\r\n\r\nimport { NextRequest } from 'next/server';\r\n\r\n// Mock completo de supabase-auth-utils\r\njest.mock('@/lib/auth/supabase-auth-utils', () => ({\r\n  requireAdminAuth: jest.fn(),\r\n}));\r\n\r\n// Mock de authenticatedAdmin\r\njest.mock('@/lib/auth/admin-auth', () => ({\r\n  authenticatedAdmin: jest.fn(),\r\n}));\r\n\r\nconst mockAuthenticatedAdmin = authenticatedAdmin as jest.MockedFunction<typeof authenticatedAdmin>;\r\n\r\ndescribe('requireAdminAuth - Corrección Error 401', () => {\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n    console.log = jest.fn(); // Silenciar logs en tests\r\n    console.warn = jest.fn();\r\n  });\r\n\r\n  it('debe usar authenticatedAdmin corregida y autorizar admin correctamente', async () => {\r\n    // Mock de usuario admin válido\r\n    mockAuthenticatedAdmin.mockResolvedValue({\r\n      userId: 'user_admin123',\r\n      sessionId: 'sess_123',\r\n      isAdmin: true,\r\n      user: {\r\n        id: 'user_admin123',\r\n        email: 'santiago@xor.com.ar'\r\n      }\r\n    });\r\n\r\n    const mockRequest = new NextRequest('https://example.com/api/admin/monitoring');\r\n    const result = await requireAdminAuth(mockRequest);\r\n\r\n    expect(result).toEqual({\r\n      success: true,\r\n      user: {\r\n        id: 'user_admin123',\r\n        email: 'santiago@xor.com.ar',\r\n        role: 'admin',\r\n        permissions: {}\r\n      },\r\n      supabase: undefined,\r\n      isAdmin: true\r\n    });\r\n\r\n    expect(mockAuthenticatedAdmin).toHaveBeenCalledWith(mockRequest);\r\n  });\r\n\r\n  it('debe rechazar usuario no autenticado', async () => {\r\n    // Mock de usuario no autenticado\r\n    mockAuthenticatedAdmin.mockResolvedValue({\r\n      userId: null,\r\n      isAdmin: false,\r\n      error: 'Usuario no autenticado',\r\n      status: 401\r\n    });\r\n\r\n    const mockRequest = new NextRequest('https://example.com/api/admin/monitoring');\r\n    const result = await requireAdminAuth(mockRequest);\r\n\r\n    expect(result).toEqual({\r\n      success: false,\r\n      error: 'Usuario no autenticado',\r\n      status: 401\r\n    });\r\n  });\r\n\r\n  it('debe rechazar usuario autenticado pero no admin', async () => {\r\n    // Mock de usuario regular (no admin)\r\n    mockAuthenticatedAdmin.mockResolvedValue({\r\n      userId: 'user_regular123',\r\n      isAdmin: false,\r\n      user: {\r\n        id: 'user_regular123',\r\n        email: 'user@example.com'\r\n      }\r\n    });\r\n\r\n    const mockRequest = new NextRequest('https://example.com/api/admin/monitoring');\r\n    const result = await requireAdminAuth(mockRequest);\r\n\r\n    expect(result).toEqual({\r\n      success: false,\r\n      error: 'Acceso denegado: se requiere rol de administrador',\r\n      status: 403\r\n    });\r\n  });\r\n\r\n  it('debe manejar errores de authenticatedAdmin', async () => {\r\n    // Mock de error en authenticatedAdmin\r\n    mockAuthenticatedAdmin.mockRejectedValue(new Error('Clerk API error'));\r\n\r\n    const mockRequest = new NextRequest('https://example.com/api/admin/monitoring');\r\n    const result = await requireAdminAuth(mockRequest);\r\n\r\n    expect(result).toEqual({\r\n      success: false,\r\n      error: 'Error interno del servidor',\r\n      status: 500\r\n    });\r\n  });\r\n\r\n  it('debe manejar usuario admin sin objeto user completo', async () => {\r\n    // Mock de admin con datos mínimos\r\n    mockAuthenticatedAdmin.mockResolvedValue({\r\n      userId: 'user_admin123',\r\n      isAdmin: true,\r\n      user: undefined // Sin objeto user completo\r\n    });\r\n\r\n    const mockRequest = new NextRequest('https://example.com/api/admin/monitoring');\r\n    const result = await requireAdminAuth(mockRequest);\r\n\r\n    expect(result).toEqual({\r\n      success: true,\r\n      user: {\r\n        id: 'user_admin123',\r\n        email: 'unknown',\r\n        role: 'admin',\r\n        permissions: {}\r\n      },\r\n      supabase: undefined,\r\n      isAdmin: true\r\n    });\r\n  });\r\n});\r\n\r\ndescribe('requireAdminAuth - Integración con APIs de Monitoreo', () => {\r\n  it('debe funcionar correctamente para /api/admin/monitoring', async () => {\r\n    mockAuthenticatedAdmin.mockResolvedValue({\r\n      userId: 'user_admin123',\r\n      isAdmin: true,\r\n      user: {\r\n        id: 'user_admin123',\r\n        email: 'santiago@xor.com.ar'\r\n      }\r\n    });\r\n\r\n    const mockRequest = new NextRequest('https://pinteya.com/api/admin/monitoring');\r\n    const result = await requireAdminAuth(mockRequest);\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(result.user?.role).toBe('admin');\r\n  });\r\n\r\n  it('debe funcionar correctamente para /api/admin/monitoring/enterprise-metrics', async () => {\r\n    mockAuthenticatedAdmin.mockResolvedValue({\r\n      userId: 'user_admin123',\r\n      isAdmin: true,\r\n      user: {\r\n        id: 'user_admin123',\r\n        email: 'santiago@xor.com.ar'\r\n      }\r\n    });\r\n\r\n    const mockRequest = new NextRequest('https://pinteya.com/api/admin/monitoring/enterprise-metrics');\r\n    const result = await requireAdminAuth(mockRequest, ['admin_access', 'monitoring_access']);\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(result.isAdmin).toBe(true);\r\n  });\r\n});\r\n\r\ndescribe('requireAdminAuth - Verificación de Regresión', () => {\r\n  it('NO debe usar la función authenticatedUser antigua (que esperaba Bearer token)', async () => {\r\n    // Este test verifica que ya no se use la función que esperaba Bearer tokens\r\n    mockAuthenticatedAdmin.mockResolvedValue({\r\n      userId: 'user_admin123',\r\n      isAdmin: true,\r\n      user: {\r\n        id: 'user_admin123',\r\n        email: 'santiago@xor.com.ar'\r\n      }\r\n    });\r\n\r\n    const mockRequest = new NextRequest('https://pinteya.com/api/admin/monitoring');\r\n    // NO agregar header Authorization - debe funcionar con cookies de sesión\r\n    \r\n    const result = await requireAdminAuth(mockRequest);\r\n\r\n    expect(result.success).toBe(true);\r\n    expect(mockAuthenticatedAdmin).toHaveBeenCalledWith(mockRequest);\r\n  });\r\n});\r\n"],"names":["jest","mock","requireAdminAuth","fn","authenticatedAdmin","mockAuthenticatedAdmin","describe","beforeEach","clearAllMocks","console","log","warn","it","mockResolvedValue","userId","sessionId","isAdmin","user","id","email","mockRequest","NextRequest","result","expect","toEqual","success","role","permissions","supabase","undefined","toHaveBeenCalledWith","error","status","mockRejectedValue","Error","toBe"],"mappings":"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"}