2f2602aed318106316800db8485acd46
// ===================================
// PINTEYA E-COMMERCE - HEALTH CHECKS API
// ===================================
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: all[name]
    });
}
_export(exports, {
    GET: function() {
        return GET;
    },
    HealthStatus: function() {
        return HealthStatus;
    },
    POST: function() {
        return POST;
    }
});
const _server = require("next/server");
const _adminauth = require("../../../../../lib/auth/admin-auth");
const _healthchecks = require("../../../../../lib/monitoring/health-checks");
const _logger = require("../../../../../lib/logger");
var HealthStatus = /*#__PURE__*/ function(HealthStatus) {
    HealthStatus["HEALTHY"] = "healthy";
    HealthStatus["DEGRADED"] = "degraded";
    HealthStatus["UNHEALTHY"] = "unhealthy";
    HealthStatus["UNKNOWN"] = "unknown";
    return HealthStatus;
}({});
async function GET(request) {
    try {
        // Para health checks, permitir acceso sin autenticación completa para monitoreo externo
        const searchParams = request.nextUrl.searchParams;
        const detailed = searchParams.get('detailed') === 'true';
        const services = searchParams.get('services')?.split(',') || [];
        // Si se solicita información detallada, verificar autenticación
        if (detailed) {
            const authResult = await (0, _adminauth.getAuthenticatedAdmin)(request);
            if (!authResult.isAdmin) {
                return _server.NextResponse.json({
                    success: false,
                    error: 'Acceso no autorizado para información detallada'
                }, {
                    status: 401
                });
            }
        }
        // Usar el sistema enterprise de health checks
        let serviceResults;
        if (services.length > 0) {
            // Ejecutar health checks específicos
            serviceResults = await Promise.all(services.map(async (service)=>{
                try {
                    return await _healthchecks.enterpriseHealthSystem.runHealthCheck(service);
                } catch (error) {
                    return {
                        service,
                        status: "unhealthy",
                        severity: 'critical',
                        responseTime: 0,
                        message: `Health check failed: ${error instanceof Error ? error.message : 'Unknown error'}`,
                        details: {},
                        lastChecked: new Date().toISOString()
                    };
                }
            }));
        } else {
            // Ejecutar todos los health checks
            serviceResults = await _healthchecks.enterpriseHealthSystem.runAllHealthChecks();
        }
        // Obtener resumen del sistema
        const healthData = _healthchecks.enterpriseHealthSystem.getSystemHealth();
        const summary = healthData.summary;
        const overall = healthData.overall;
        const systemHealth = {
            overall,
            services: serviceResults,
            summary,
            uptime: process.uptime(),
            version: process.env.npm_package_version || '3.0.0',
            timestamp: new Date().toISOString()
        };
        // Log health check
        _logger.logger.info(_logger.LogLevel.INFO, 'Health check performed', {
            overall,
            servicesChecked: serviceResults.length,
            healthy: summary.healthy,
            degraded: summary.degraded,
            unhealthy: summary.unhealthy
        }, _logger.LogCategory.SYSTEM);
        // Retornar respuesta con código de estado apropiado
        const statusCode = overall === "healthy" ? 200 : overall === "degraded" ? 200 : 503;
        return _server.NextResponse.json({
            success: overall !== "unhealthy",
            data: systemHealth
        }, {
            status: statusCode
        });
    } catch (error) {
        _logger.logger.error(_logger.LogLevel.ERROR, 'Health check failed', {
            error: error instanceof Error ? error.message : 'Unknown error'
        }, _logger.LogCategory.SYSTEM);
        return _server.NextResponse.json({
            success: false,
            data: {
                overall: "unhealthy",
                services: [],
                summary: {
                    healthy: 0,
                    degraded: 0,
                    unhealthy: 1,
                    total: 1
                },
                uptime: process.uptime(),
                version: '3.0.0',
                timestamp: new Date().toISOString()
            }
        }, {
            status: 503
        });
    }
}
async function POST(request) {
    try {
        // Verificar autenticación de admin
        const authResult = await (0, _adminauth.getAuthenticatedAdmin)(request);
        if (!authResult.isAdmin || !authResult.userId) {
            return _server.NextResponse.json({
                success: false,
                error: 'Acceso no autorizado'
            }, {
                status: 401
            });
        }
        const body = await request.json();
        const { action, service, config } = body;
        if (!action) {
            return _server.NextResponse.json({
                success: false,
                error: 'Falta parámetro: action'
            }, {
                status: 400
            });
        }
        let result = {};
        switch(action){
            case 'check':
                if (!service) {
                    return _server.NextResponse.json({
                        success: false,
                        error: 'Service requerido para check'
                    }, {
                        status: 400
                    });
                }
                result = await _healthchecks.enterpriseHealthSystem.runHealthCheck(service);
                break;
            case 'recover':
                if (!service) {
                    return _server.NextResponse.json({
                        success: false,
                        error: 'Service requerido para recover'
                    }, {
                        status: 400
                    });
                }
                const recoveryActionId = getRecoveryActionId(service);
                if (recoveryActionId) {
                    const success = await _healthchecks.enterpriseHealthSystem.executeRecoveryAction(recoveryActionId, config);
                    result = {
                        success,
                        service,
                        action: 'recover'
                    };
                } else {
                    result = {
                        success: false,
                        service,
                        error: 'No recovery action available'
                    };
                }
                break;
            case 'reset':
                if (service === 'circuit_breakers' || !service) {
                    const success = await _healthchecks.enterpriseHealthSystem.executeRecoveryAction('reset_circuit_breakers');
                    result = {
                        success,
                        service: service || 'circuit_breakers',
                        action: 'reset'
                    };
                } else {
                    result = {
                        success: false,
                        service,
                        error: 'Reset not supported for this service'
                    };
                }
                break;
            default:
                return _server.NextResponse.json({
                    success: false,
                    error: 'Acción no válida'
                }, {
                    status: 400
                });
        }
        _logger.logger.info(_logger.LogLevel.INFO, `Health action performed: ${action}`, {
            userId: authResult.userId,
            action,
            service,
            success: result.success
        }, _logger.LogCategory.SYSTEM);
        return _server.NextResponse.json({
            success: true,
            data: result
        });
    } catch (error) {
        _logger.logger.error(_logger.LogLevel.ERROR, 'Health action failed', {
            error: error instanceof Error ? error.message : 'Unknown error'
        }, _logger.LogCategory.SYSTEM);
        return _server.NextResponse.json({
            success: false,
            error: 'Error interno del servidor'
        }, {
            status: 500
        });
    }
}
/**
 * Obtiene el ID de acción de recuperación para un servicio
 */ function getRecoveryActionId(service) {
    switch(service){
        case 'circuit_breakers':
            return 'reset_circuit_breakers';
        case 'cache':
            return 'clear_cache';
        default:
            return null;
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbWFydGlcXERlc2t0b3BcXERFU0FSUk9MTE9TV1xcQk9JTEVSUExBVFRFIEUtQ09NTUVSQ0VcXHNyY1xcYXBwXFxhcGlcXGFkbWluXFxtb25pdG9yaW5nXFxoZWFsdGhcXHJvdXRlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBQSU5URVlBIEUtQ09NTUVSQ0UgLSBIRUFMVEggQ0hFQ0tTIEFQSVxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuaW1wb3J0IHsgTmV4dFJlcXVlc3QsIE5leHRSZXNwb25zZSB9IGZyb20gJ25leHQvc2VydmVyJztcbmltcG9ydCB7IGdldEF1dGhlbnRpY2F0ZWRBZG1pbiB9IGZyb20gJ0AvbGliL2F1dGgvYWRtaW4tYXV0aCc7XG5pbXBvcnQgeyBlbnRlcnByaXNlSGVhbHRoU3lzdGVtLCBIZWFsdGhTdGF0dXMgfSBmcm9tICdAL2xpYi9tb25pdG9yaW5nL2hlYWx0aC1jaGVja3MnO1xuaW1wb3J0IHsgbG9nZ2VyLCBMb2dMZXZlbCwgTG9nQ2F0ZWdvcnkgfSBmcm9tICdAL2xpYi9sb2dnZXInO1xuXG4vLyBFc3RhZG9zIGRlIHNhbHVkXG5leHBvcnQgZW51bSBIZWFsdGhTdGF0dXMge1xuICBIRUFMVEhZID0gJ2hlYWx0aHknLFxuICBERUdSQURFRCA9ICdkZWdyYWRlZCcsXG4gIFVOSEVBTFRIWSA9ICd1bmhlYWx0aHknLFxuICBVTktOT1dOID0gJ3Vua25vd24nXG59XG5cbi8vIFJlc3VsdGFkbyBkZSBoZWFsdGggY2hlY2tcbmludGVyZmFjZSBIZWFsdGhDaGVja1Jlc3VsdCB7XG4gIHNlcnZpY2U6IHN0cmluZztcbiAgc3RhdHVzOiBIZWFsdGhTdGF0dXM7XG4gIHJlc3BvbnNlVGltZTogbnVtYmVyO1xuICBtZXNzYWdlPzogc3RyaW5nO1xuICBkZXRhaWxzPzogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgbGFzdENoZWNrZWQ6IHN0cmluZztcbn1cblxuLy8gUmVzdW1lbiBkZSBzYWx1ZCBkZWwgc2lzdGVtYVxuaW50ZXJmYWNlIFN5c3RlbUhlYWx0aCB7XG4gIG92ZXJhbGw6IEhlYWx0aFN0YXR1cztcbiAgc2VydmljZXM6IEhlYWx0aENoZWNrUmVzdWx0W107XG4gIHN1bW1hcnk6IHtcbiAgICBoZWFsdGh5OiBudW1iZXI7XG4gICAgZGVncmFkZWQ6IG51bWJlcjtcbiAgICB1bmhlYWx0aHk6IG51bWJlcjtcbiAgICB0b3RhbDogbnVtYmVyO1xuICB9O1xuICB1cHRpbWU6IG51bWJlcjtcbiAgdmVyc2lvbjogc3RyaW5nO1xuICB0aW1lc3RhbXA6IHN0cmluZztcbn1cblxuLyoqXG4gKiBHRVQgL2FwaS9hZG1pbi9tb25pdG9yaW5nL2hlYWx0aFxuICogT2J0aWVuZSBlbCBlc3RhZG8gZGUgc2FsdWQgZGUgdG9kb3MgbG9zIHNlcnZpY2lvc1xuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gR0VUKHJlcXVlc3Q6IE5leHRSZXF1ZXN0KSB7XG4gIHRyeSB7XG4gICAgLy8gUGFyYSBoZWFsdGggY2hlY2tzLCBwZXJtaXRpciBhY2Nlc28gc2luIGF1dGVudGljYWNpw7NuIGNvbXBsZXRhIHBhcmEgbW9uaXRvcmVvIGV4dGVybm9cbiAgICBjb25zdCBzZWFyY2hQYXJhbXMgPSByZXF1ZXN0Lm5leHRVcmwuc2VhcmNoUGFyYW1zO1xuICAgIGNvbnN0IGRldGFpbGVkID0gc2VhcmNoUGFyYW1zLmdldCgnZGV0YWlsZWQnKSA9PT0gJ3RydWUnO1xuICAgIGNvbnN0IHNlcnZpY2VzID0gc2VhcmNoUGFyYW1zLmdldCgnc2VydmljZXMnKT8uc3BsaXQoJywnKSB8fCBbXTtcblxuICAgIC8vIFNpIHNlIHNvbGljaXRhIGluZm9ybWFjacOzbiBkZXRhbGxhZGEsIHZlcmlmaWNhciBhdXRlbnRpY2FjacOzblxuICAgIGlmIChkZXRhaWxlZCkge1xuICAgICAgY29uc3QgYXV0aFJlc3VsdCA9IGF3YWl0IGdldEF1dGhlbnRpY2F0ZWRBZG1pbihyZXF1ZXN0KTtcbiAgICAgIGlmICghYXV0aFJlc3VsdC5pc0FkbWluKSB7XG4gICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6ICdBY2Nlc28gbm8gYXV0b3JpemFkbyBwYXJhIGluZm9ybWFjacOzbiBkZXRhbGxhZGEnXG4gICAgICAgIH0sIHsgc3RhdHVzOiA0MDEgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gVXNhciBlbCBzaXN0ZW1hIGVudGVycHJpc2UgZGUgaGVhbHRoIGNoZWNrc1xuICAgIGxldCBzZXJ2aWNlUmVzdWx0cztcblxuICAgIGlmIChzZXJ2aWNlcy5sZW5ndGggPiAwKSB7XG4gICAgICAvLyBFamVjdXRhciBoZWFsdGggY2hlY2tzIGVzcGVjw61maWNvc1xuICAgICAgc2VydmljZVJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgc2VydmljZXMubWFwKGFzeW5jIChzZXJ2aWNlKSA9PiB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBlbnRlcnByaXNlSGVhbHRoU3lzdGVtLnJ1bkhlYWx0aENoZWNrKHNlcnZpY2UpO1xuICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICBzZXJ2aWNlLFxuICAgICAgICAgICAgICBzdGF0dXM6IEhlYWx0aFN0YXR1cy5VTkhFQUxUSFksXG4gICAgICAgICAgICAgIHNldmVyaXR5OiAnY3JpdGljYWwnIGFzIGNvbnN0LFxuICAgICAgICAgICAgICByZXNwb25zZVRpbWU6IDAsXG4gICAgICAgICAgICAgIG1lc3NhZ2U6IGBIZWFsdGggY2hlY2sgZmFpbGVkOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InfWAsXG4gICAgICAgICAgICAgIGRldGFpbHM6IHt9LFxuICAgICAgICAgICAgICBsYXN0Q2hlY2tlZDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEVqZWN1dGFyIHRvZG9zIGxvcyBoZWFsdGggY2hlY2tzXG4gICAgICBzZXJ2aWNlUmVzdWx0cyA9IGF3YWl0IGVudGVycHJpc2VIZWFsdGhTeXN0ZW0ucnVuQWxsSGVhbHRoQ2hlY2tzKCk7XG4gICAgfVxuXG4gICAgLy8gT2J0ZW5lciByZXN1bWVuIGRlbCBzaXN0ZW1hXG4gICAgY29uc3QgaGVhbHRoRGF0YSA9IGVudGVycHJpc2VIZWFsdGhTeXN0ZW0uZ2V0U3lzdGVtSGVhbHRoKCk7XG4gICAgY29uc3Qgc3VtbWFyeSA9IGhlYWx0aERhdGEuc3VtbWFyeTtcbiAgICBjb25zdCBvdmVyYWxsID0gaGVhbHRoRGF0YS5vdmVyYWxsO1xuXG4gICAgY29uc3Qgc3lzdGVtSGVhbHRoOiBTeXN0ZW1IZWFsdGggPSB7XG4gICAgICBvdmVyYWxsLFxuICAgICAgc2VydmljZXM6IHNlcnZpY2VSZXN1bHRzLFxuICAgICAgc3VtbWFyeSxcbiAgICAgIHVwdGltZTogcHJvY2Vzcy51cHRpbWUoKSxcbiAgICAgIHZlcnNpb246IHByb2Nlc3MuZW52Lm5wbV9wYWNrYWdlX3ZlcnNpb24gfHwgJzMuMC4wJyxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgfTtcblxuICAgIC8vIExvZyBoZWFsdGggY2hlY2tcbiAgICBsb2dnZXIuaW5mbyhMb2dMZXZlbC5JTkZPLCAnSGVhbHRoIGNoZWNrIHBlcmZvcm1lZCcsIHtcbiAgICAgIG92ZXJhbGwsXG4gICAgICBzZXJ2aWNlc0NoZWNrZWQ6IHNlcnZpY2VSZXN1bHRzLmxlbmd0aCxcbiAgICAgIGhlYWx0aHk6IHN1bW1hcnkuaGVhbHRoeSxcbiAgICAgIGRlZ3JhZGVkOiBzdW1tYXJ5LmRlZ3JhZGVkLFxuICAgICAgdW5oZWFsdGh5OiBzdW1tYXJ5LnVuaGVhbHRoeVxuICAgIH0sIExvZ0NhdGVnb3J5LlNZU1RFTSk7XG5cbiAgICAvLyBSZXRvcm5hciByZXNwdWVzdGEgY29uIGPDs2RpZ28gZGUgZXN0YWRvIGFwcm9waWFkb1xuICAgIGNvbnN0IHN0YXR1c0NvZGUgPSBvdmVyYWxsID09PSBIZWFsdGhTdGF0dXMuSEVBTFRIWSA/IDIwMCA6XG4gICAgICAgICAgICAgICAgICAgICAgb3ZlcmFsbCA9PT0gSGVhbHRoU3RhdHVzLkRFR1JBREVEID8gMjAwIDpcbiAgICAgICAgICAgICAgICAgICAgICA1MDM7XG5cbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xuICAgICAgc3VjY2Vzczogb3ZlcmFsbCAhPT0gSGVhbHRoU3RhdHVzLlVOSEVBTFRIWSxcbiAgICAgIGRhdGE6IHN5c3RlbUhlYWx0aFxuICAgIH0sIHsgc3RhdHVzOiBzdGF0dXNDb2RlIH0pO1xuXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKExvZ0xldmVsLkVSUk9SLCAnSGVhbHRoIGNoZWNrIGZhaWxlZCcsIHtcbiAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ1xuICAgIH0sIExvZ0NhdGVnb3J5LlNZU1RFTSk7XG5cbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIG92ZXJhbGw6IEhlYWx0aFN0YXR1cy5VTkhFQUxUSFksXG4gICAgICAgIHNlcnZpY2VzOiBbXSxcbiAgICAgICAgc3VtbWFyeTogeyBoZWFsdGh5OiAwLCBkZWdyYWRlZDogMCwgdW5oZWFsdGh5OiAxLCB0b3RhbDogMSB9LFxuICAgICAgICB1cHRpbWU6IHByb2Nlc3MudXB0aW1lKCksXG4gICAgICAgIHZlcnNpb246ICczLjAuMCcsXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICB9XG4gICAgfSwgeyBzdGF0dXM6IDUwMyB9KTtcbiAgfVxufVxuXG4vKipcbiAqIFBPU1QgL2FwaS9hZG1pbi9tb25pdG9yaW5nL2hlYWx0aFxuICogRWplY3V0YSBoZWFsdGggY2hlY2tzIGVzcGVjw61maWNvcyBvIGFjY2lvbmVzIGRlIHJlY3VwZXJhY2nDs25cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIFBPU1QocmVxdWVzdDogTmV4dFJlcXVlc3QpIHtcbiAgdHJ5IHtcbiAgICAvLyBWZXJpZmljYXIgYXV0ZW50aWNhY2nDs24gZGUgYWRtaW5cbiAgICBjb25zdCBhdXRoUmVzdWx0ID0gYXdhaXQgZ2V0QXV0aGVudGljYXRlZEFkbWluKHJlcXVlc3QpO1xuICAgIFxuICAgIGlmICghYXV0aFJlc3VsdC5pc0FkbWluIHx8ICFhdXRoUmVzdWx0LnVzZXJJZCkge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiAnQWNjZXNvIG5vIGF1dG9yaXphZG8nXG4gICAgICB9LCB7IHN0YXR1czogNDAxIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGJvZHkgPSBhd2FpdCByZXF1ZXN0Lmpzb24oKTtcbiAgICBjb25zdCB7IGFjdGlvbiwgc2VydmljZSwgY29uZmlnIH0gPSBib2R5O1xuXG4gICAgaWYgKCFhY3Rpb24pIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogJ0ZhbHRhIHBhcsOhbWV0cm86IGFjdGlvbidcbiAgICAgIH0sIHsgc3RhdHVzOiA0MDAgfSk7XG4gICAgfVxuXG4gICAgbGV0IHJlc3VsdDogYW55ID0ge307XG5cbiAgICBzd2l0Y2ggKGFjdGlvbikge1xuICAgICAgY2FzZSAnY2hlY2snOlxuICAgICAgICBpZiAoIXNlcnZpY2UpIHtcbiAgICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICBlcnJvcjogJ1NlcnZpY2UgcmVxdWVyaWRvIHBhcmEgY2hlY2snXG4gICAgICAgICAgfSwgeyBzdGF0dXM6IDQwMCB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXN1bHQgPSBhd2FpdCBlbnRlcnByaXNlSGVhbHRoU3lzdGVtLnJ1bkhlYWx0aENoZWNrKHNlcnZpY2UpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3JlY292ZXInOlxuICAgICAgICBpZiAoIXNlcnZpY2UpIHtcbiAgICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICBlcnJvcjogJ1NlcnZpY2UgcmVxdWVyaWRvIHBhcmEgcmVjb3ZlcidcbiAgICAgICAgICB9LCB7IHN0YXR1czogNDAwIH0pO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJlY292ZXJ5QWN0aW9uSWQgPSBnZXRSZWNvdmVyeUFjdGlvbklkKHNlcnZpY2UpO1xuICAgICAgICBpZiAocmVjb3ZlcnlBY3Rpb25JZCkge1xuICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCBlbnRlcnByaXNlSGVhbHRoU3lzdGVtLmV4ZWN1dGVSZWNvdmVyeUFjdGlvbihyZWNvdmVyeUFjdGlvbklkLCBjb25maWcpO1xuICAgICAgICAgIHJlc3VsdCA9IHsgc3VjY2Vzcywgc2VydmljZSwgYWN0aW9uOiAncmVjb3ZlcicgfTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQgPSB7IHN1Y2Nlc3M6IGZhbHNlLCBzZXJ2aWNlLCBlcnJvcjogJ05vIHJlY292ZXJ5IGFjdGlvbiBhdmFpbGFibGUnIH07XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdyZXNldCc6XG4gICAgICAgIGlmIChzZXJ2aWNlID09PSAnY2lyY3VpdF9icmVha2VycycgfHwgIXNlcnZpY2UpIHtcbiAgICAgICAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQgZW50ZXJwcmlzZUhlYWx0aFN5c3RlbS5leGVjdXRlUmVjb3ZlcnlBY3Rpb24oJ3Jlc2V0X2NpcmN1aXRfYnJlYWtlcnMnKTtcbiAgICAgICAgICByZXN1bHQgPSB7IHN1Y2Nlc3MsIHNlcnZpY2U6IHNlcnZpY2UgfHwgJ2NpcmN1aXRfYnJlYWtlcnMnLCBhY3Rpb246ICdyZXNldCcgfTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQgPSB7IHN1Y2Nlc3M6IGZhbHNlLCBzZXJ2aWNlLCBlcnJvcjogJ1Jlc2V0IG5vdCBzdXBwb3J0ZWQgZm9yIHRoaXMgc2VydmljZScgfTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6ICdBY2Npw7NuIG5vIHbDoWxpZGEnXG4gICAgICAgIH0sIHsgc3RhdHVzOiA0MDAgfSk7XG4gICAgfVxuXG4gICAgbG9nZ2VyLmluZm8oTG9nTGV2ZWwuSU5GTywgYEhlYWx0aCBhY3Rpb24gcGVyZm9ybWVkOiAke2FjdGlvbn1gLCB7XG4gICAgICB1c2VySWQ6IGF1dGhSZXN1bHQudXNlcklkLFxuICAgICAgYWN0aW9uLFxuICAgICAgc2VydmljZSxcbiAgICAgIHN1Y2Nlc3M6IHJlc3VsdC5zdWNjZXNzXG4gICAgfSwgTG9nQ2F0ZWdvcnkuU1lTVEVNKTtcblxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YTogcmVzdWx0XG4gICAgfSk7XG5cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoTG9nTGV2ZWwuRVJST1IsICdIZWFsdGggYWN0aW9uIGZhaWxlZCcsIHtcbiAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ1xuICAgIH0sIExvZ0NhdGVnb3J5LlNZU1RFTSk7XG5cbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjogJ0Vycm9yIGludGVybm8gZGVsIHNlcnZpZG9yJ1xuICAgIH0sIHsgc3RhdHVzOiA1MDAgfSk7XG4gIH1cbn1cblxuLyoqXG4gKiBPYnRpZW5lIGVsIElEIGRlIGFjY2nDs24gZGUgcmVjdXBlcmFjacOzbiBwYXJhIHVuIHNlcnZpY2lvXG4gKi9cbmZ1bmN0aW9uIGdldFJlY292ZXJ5QWN0aW9uSWQoc2VydmljZTogc3RyaW5nKTogc3RyaW5nIHwgbnVsbCB7XG4gIHN3aXRjaCAoc2VydmljZSkge1xuICAgIGNhc2UgJ2NpcmN1aXRfYnJlYWtlcnMnOlxuICAgICAgcmV0dXJuICdyZXNldF9jaXJjdWl0X2JyZWFrZXJzJztcbiAgICBjYXNlICdjYWNoZSc6XG4gICAgICByZXR1cm4gJ2NsZWFyX2NhY2hlJztcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cblxuXG4iXSwibmFtZXMiOlsiR0VUIiwiSGVhbHRoU3RhdHVzIiwiUE9TVCIsInJlcXVlc3QiLCJzZWFyY2hQYXJhbXMiLCJuZXh0VXJsIiwiZGV0YWlsZWQiLCJnZXQiLCJzZXJ2aWNlcyIsInNwbGl0IiwiYXV0aFJlc3VsdCIsImdldEF1dGhlbnRpY2F0ZWRBZG1pbiIsImlzQWRtaW4iLCJOZXh0UmVzcG9uc2UiLCJqc29uIiwic3VjY2VzcyIsImVycm9yIiwic3RhdHVzIiwic2VydmljZVJlc3VsdHMiLCJsZW5ndGgiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwic2VydmljZSIsImVudGVycHJpc2VIZWFsdGhTeXN0ZW0iLCJydW5IZWFsdGhDaGVjayIsInNldmVyaXR5IiwicmVzcG9uc2VUaW1lIiwibWVzc2FnZSIsIkVycm9yIiwiZGV0YWlscyIsImxhc3RDaGVja2VkIiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwicnVuQWxsSGVhbHRoQ2hlY2tzIiwiaGVhbHRoRGF0YSIsImdldFN5c3RlbUhlYWx0aCIsInN1bW1hcnkiLCJvdmVyYWxsIiwic3lzdGVtSGVhbHRoIiwidXB0aW1lIiwicHJvY2VzcyIsInZlcnNpb24iLCJlbnYiLCJucG1fcGFja2FnZV92ZXJzaW9uIiwidGltZXN0YW1wIiwibG9nZ2VyIiwiaW5mbyIsIkxvZ0xldmVsIiwiSU5GTyIsInNlcnZpY2VzQ2hlY2tlZCIsImhlYWx0aHkiLCJkZWdyYWRlZCIsInVuaGVhbHRoeSIsIkxvZ0NhdGVnb3J5IiwiU1lTVEVNIiwic3RhdHVzQ29kZSIsImRhdGEiLCJFUlJPUiIsInRvdGFsIiwidXNlcklkIiwiYm9keSIsImFjdGlvbiIsImNvbmZpZyIsInJlc3VsdCIsInJlY292ZXJ5QWN0aW9uSWQiLCJnZXRSZWNvdmVyeUFjdGlvbklkIiwiZXhlY3V0ZVJlY292ZXJ5QWN0aW9uIl0sIm1hcHBpbmdzIjoiQUFBQSxzQ0FBc0M7QUFDdEMseUNBQXlDO0FBQ3pDLHNDQUFzQzs7Ozs7Ozs7Ozs7O0lBNENoQkEsR0FBRztlQUFIQTs7SUFwQ1ZDLFlBQVk7ZUFBWkE7O0lBeUlVQyxJQUFJO2VBQUpBOzs7d0JBL0lvQjsyQkFDSjs4QkFDZTt3QkFDUDtBQUd2QyxJQUFBLEFBQUtELHNDQUFBQTs7Ozs7V0FBQUE7O0FBb0NMLGVBQWVELElBQUlHLE9BQW9CO0lBQzVDLElBQUk7UUFDRix3RkFBd0Y7UUFDeEYsTUFBTUMsZUFBZUQsUUFBUUUsT0FBTyxDQUFDRCxZQUFZO1FBQ2pELE1BQU1FLFdBQVdGLGFBQWFHLEdBQUcsQ0FBQyxnQkFBZ0I7UUFDbEQsTUFBTUMsV0FBV0osYUFBYUcsR0FBRyxDQUFDLGFBQWFFLE1BQU0sUUFBUSxFQUFFO1FBRS9ELGdFQUFnRTtRQUNoRSxJQUFJSCxVQUFVO1lBQ1osTUFBTUksYUFBYSxNQUFNQyxJQUFBQSxnQ0FBcUIsRUFBQ1I7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