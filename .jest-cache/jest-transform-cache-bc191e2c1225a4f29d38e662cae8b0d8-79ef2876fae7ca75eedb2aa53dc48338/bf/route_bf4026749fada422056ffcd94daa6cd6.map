{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\app\\api\\admin\\orders\\route.ts"],"sourcesContent":["// ===================================\r\n// PINTEYA E-COMMERCE - ADMIN ORDERS API ENTERPRISE\r\n// ===================================\r\n\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport { supabaseAdmin } from '@/lib/supabase';\r\nimport { auth } from '@/auth';\r\nimport { ApiResponse } from '@/types/api';\r\nimport { z } from 'zod';\r\nimport { logger, LogLevel, LogCategory } from '@/lib/logger';\r\nimport { checkRateLimit, addRateLimitHeaders, RATE_LIMIT_CONFIGS } from '@/lib/rate-limiter';\r\nimport { metricsCollector } from '@/lib/metrics';\r\n\r\n// ===================================\r\n// SCHEMAS DE VALIDACIÓN ENTERPRISE\r\n// ===================================\r\n\r\nconst OrderFiltersSchema = z.object({\r\n  page: z.coerce.number().min(1).default(1),\r\n  limit: z.coerce.number().min(1).max(100).default(20),\r\n  status: z.string().optional(),\r\n  payment_status: z.string().optional(),\r\n  date_from: z.string().optional(),\r\n  date_to: z.string().optional(),\r\n  search: z.string().optional(),\r\n  sort_by: z.enum(['created_at', 'total_amount', 'order_number']).default('created_at'),\r\n  sort_order: z.enum(['asc', 'desc']).default('desc'),\r\n});\r\n\r\nconst CreateOrderSchema = z.object({\r\n  user_id: z.string().uuid('ID de usuario inválido'),\r\n  items: z.array(z.object({\r\n    product_id: z.number().min(1),\r\n    quantity: z.number().min(1).max(99),\r\n    unit_price: z.number().min(0),\r\n  })).min(1, 'Al menos un item es requerido'),\r\n  shipping_address: z.object({\r\n    street_name: z.string().min(1),\r\n    street_number: z.string().min(1),\r\n    zip_code: z.string().min(1),\r\n    city_name: z.string().min(1),\r\n    state_name: z.string().min(1),\r\n  }).optional(),\r\n  notes: z.string().optional(),\r\n});\r\n\r\n// ===================================\r\n// MIDDLEWARE DE AUTENTICACIÓN ADMIN\r\n// ===================================\r\n\r\nasync function validateAdminAuth() {\r\n  try {\r\n    const session = await auth();\r\n    if (!session?.user) {\r\n      return { error: 'Usuario no autenticado', status: 401 };\r\n    }\r\n\r\n    // Verificar si es admin (usando email como en otros endpoints admin)\r\n    const isAdmin = session.user.email === 'santiago@xor.com.ar';\r\n    if (!isAdmin) {\r\n      return { error: 'Acceso denegado - Se requieren permisos de administrador', status: 403 };\r\n    }\r\n\r\n    return { user: session.user, userId: session.user.id };\r\n  } catch (error) {\r\n    logger.log(LogLevel.ERROR, LogCategory.AUTH, 'Error en validación admin', { error });\r\n    return { error: 'Error de autenticación', status: 500 };\r\n  }\r\n}\r\n\r\n// ===================================\r\n// GET - Listar órdenes con filtros avanzados\r\n// ===================================\r\nexport async function GET(request: NextRequest) {\r\n  const startTime = Date.now();\r\n\r\n  try {\r\n    // Rate limiting\r\n    const rateLimitResult = await checkRateLimit(\r\n      request,\r\n      RATE_LIMIT_CONFIGS.admin.requests,\r\n      RATE_LIMIT_CONFIGS.admin.window,\r\n      'admin-orders'\r\n    );\r\n\r\n    if (!rateLimitResult.success) {\r\n      const response = NextResponse.json(\r\n        { error: 'Demasiadas solicitudes' },\r\n        { status: 429 }\r\n      );\r\n      addRateLimitHeaders(response, rateLimitResult);\r\n      return response;\r\n    }\r\n\r\n    // Validar autenticación admin\r\n    const authResult = await validateAdminAuth();\r\n    if ('error' in authResult) {\r\n      return NextResponse.json(\r\n        { error: authResult.error },\r\n        { status: authResult.status }\r\n      );\r\n    }\r\n\r\n    // Validar parámetros de consulta\r\n    const { searchParams } = new URL(request.url);\r\n    const filtersResult = OrderFiltersSchema.safeParse({\r\n      page: searchParams.get('page'),\r\n      limit: searchParams.get('limit'),\r\n      status: searchParams.get('status'),\r\n      payment_status: searchParams.get('payment_status'),\r\n      date_from: searchParams.get('date_from'),\r\n      date_to: searchParams.get('date_to'),\r\n      search: searchParams.get('search'),\r\n      sort_by: searchParams.get('sort_by'),\r\n      sort_order: searchParams.get('sort_order'),\r\n    });\r\n\r\n    if (!filtersResult.success) {\r\n      return NextResponse.json(\r\n        { error: 'Parámetros de consulta inválidos', details: filtersResult.error.errors },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const filters = filtersResult.data;\r\n\r\n    // Construir query base con joins optimizados\r\n    let query = supabaseAdmin\r\n      .from('orders')\r\n      .select(`\r\n        id,\r\n        order_number,\r\n        status,\r\n        payment_status,\r\n        total_amount,\r\n        currency,\r\n        created_at,\r\n        updated_at,\r\n        shipping_address,\r\n        notes,\r\n        user_profiles!orders_user_id_fkey (\r\n          id,\r\n          name,\r\n          email\r\n        ),\r\n        order_items (\r\n          id,\r\n          quantity,\r\n          unit_price,\r\n          total_price,\r\n          products (\r\n            id,\r\n            name,\r\n            images\r\n          )\r\n        )\r\n      `, { count: 'exact' });\r\n\r\n    // Aplicar filtros\r\n    if (filters.status) {\r\n      query = query.eq('status', filters.status);\r\n    }\r\n\r\n    if (filters.payment_status) {\r\n      query = query.eq('payment_status', filters.payment_status);\r\n    }\r\n\r\n    if (filters.date_from) {\r\n      query = query.gte('created_at', filters.date_from);\r\n    }\r\n\r\n    if (filters.date_to) {\r\n      query = query.lte('created_at', filters.date_to);\r\n    }\r\n\r\n    if (filters.search) {\r\n      query = query.or(`order_number.ilike.%${filters.search}%,notes.ilike.%${filters.search}%`);\r\n    }\r\n\r\n    // Aplicar ordenamiento y paginación\r\n    const from = (filters.page - 1) * filters.limit;\r\n    const to = from + filters.limit - 1;\r\n\r\n    const { data: orders, error, count } = await query\r\n      .order(filters.sort_by, { ascending: filters.sort_order === 'asc' })\r\n      .range(from, to);\r\n\r\n    if (error) {\r\n      logger.log(LogLevel.ERROR, LogCategory.DATABASE, 'Error al obtener órdenes admin', { error });\r\n      return NextResponse.json(\r\n        { error: 'Error al obtener órdenes' },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // Calcular estadísticas\r\n    const totalPages = Math.ceil((count || 0) / filters.limit);\r\n    const hasNextPage = filters.page < totalPages;\r\n    const hasPreviousPage = filters.page > 1;\r\n\r\n    // Métricas de performance\r\n    const responseTime = Date.now() - startTime;\r\n    metricsCollector.recordApiCall('admin-orders-list', responseTime, 200);\r\n\r\n    const response: ApiResponse<{\r\n      orders: typeof orders;\r\n      pagination: {\r\n        page: number;\r\n        limit: number;\r\n        total: number;\r\n        totalPages: number;\r\n        hasNextPage: boolean;\r\n        hasPreviousPage: boolean;\r\n      };\r\n      filters: typeof filters;\r\n    }> = {\r\n      data: {\r\n        orders,\r\n        pagination: {\r\n          page: filters.page,\r\n          limit: filters.limit,\r\n          total: count || 0,\r\n          totalPages,\r\n          hasNextPage,\r\n          hasPreviousPage,\r\n        },\r\n        filters,\r\n      },\r\n      success: true,\r\n      error: null,\r\n    };\r\n\r\n    const nextResponse = NextResponse.json(response);\r\n    addRateLimitHeaders(nextResponse, rateLimitResult);\r\n\r\n    logger.log(LogLevel.INFO, LogCategory.API, 'Órdenes admin obtenidas exitosamente', {\r\n      count: orders?.length,\r\n      total: count,\r\n      responseTime,\r\n    });\r\n\r\n    return nextResponse;\r\n\r\n  } catch (error) {\r\n    const responseTime = Date.now() - startTime;\r\n    metricsCollector.recordApiCall('admin-orders-list', responseTime, 500);\r\n\r\n    logger.log(LogLevel.ERROR, LogCategory.API, 'Error en GET /api/admin/orders', { error });\r\n\r\n    return NextResponse.json(\r\n      { error: 'Error interno del servidor' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n// ===================================\r\n// POST - Crear nueva orden (admin)\r\n// ===================================\r\nexport async function POST(request: NextRequest) {\r\n  const startTime = Date.now();\r\n\r\n  try {\r\n    // Rate limiting\r\n    const rateLimitResult = await checkRateLimit(\r\n      request,\r\n      RATE_LIMIT_CONFIGS.admin.requests,\r\n      RATE_LIMIT_CONFIGS.admin.window,\r\n      'admin-orders-create'\r\n    );\r\n\r\n    if (!rateLimitResult.success) {\r\n      const response = NextResponse.json(\r\n        { error: 'Demasiadas solicitudes' },\r\n        { status: 429 }\r\n      );\r\n      addRateLimitHeaders(response, rateLimitResult);\r\n      return response;\r\n    }\r\n\r\n    // Validar autenticación admin\r\n    const authResult = await validateAdminAuth();\r\n    if ('error' in authResult) {\r\n      return NextResponse.json(\r\n        { error: authResult.error },\r\n        { status: authResult.status }\r\n      );\r\n    }\r\n\r\n    // Validar datos de entrada\r\n    const body = await request.json();\r\n    const validationResult = CreateOrderSchema.safeParse(body);\r\n\r\n    if (!validationResult.success) {\r\n      return NextResponse.json(\r\n        { error: 'Datos de orden inválidos', details: validationResult.error.errors },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const orderData = validationResult.data;\r\n\r\n    // Generar número de orden único\r\n    const orderNumber = `ORD-${Date.now()}-${Math.random().toString(36).substr(2, 9).toUpperCase()}`;\r\n\r\n    // Calcular total\r\n    const totalAmount = orderData.items.reduce((sum, item) =>\r\n      sum + (item.unit_price * item.quantity), 0\r\n    );\r\n\r\n    // Crear orden en transacción\r\n    const { data: order, error: orderError } = await supabaseAdmin\r\n      .from('orders')\r\n      .insert({\r\n        user_id: orderData.user_id,\r\n        order_number: orderNumber,\r\n        status: 'pending',\r\n        payment_status: 'pending',\r\n        total_amount: totalAmount,\r\n        currency: 'ARS',\r\n        shipping_address: orderData.shipping_address ? JSON.stringify(orderData.shipping_address) : null,\r\n        notes: orderData.notes,\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (orderError) {\r\n      logger.log(LogLevel.ERROR, LogCategory.DATABASE, 'Error al crear orden', { orderError });\r\n      return NextResponse.json(\r\n        { error: 'Error al crear orden' },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // Crear items de la orden\r\n    const orderItems = orderData.items.map(item => ({\r\n      order_id: order.id,\r\n      product_id: item.product_id,\r\n      quantity: item.quantity,\r\n      unit_price: item.unit_price,\r\n      total_price: item.unit_price * item.quantity,\r\n    }));\r\n\r\n    const { error: itemsError } = await supabaseAdmin\r\n      .from('order_items')\r\n      .insert(orderItems);\r\n\r\n    if (itemsError) {\r\n      // Rollback: eliminar orden creada\r\n      await supabaseAdmin.from('orders').delete().eq('id', order.id);\r\n\r\n      logger.log(LogLevel.ERROR, LogCategory.DATABASE, 'Error al crear items de orden', { itemsError });\r\n      return NextResponse.json(\r\n        { error: 'Error al crear items de orden' },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // Métricas de performance\r\n    const responseTime = Date.now() - startTime;\r\n    metricsCollector.recordApiCall('admin-orders-create', responseTime, 201);\r\n\r\n    const response: ApiResponse<typeof order> = {\r\n      data: order,\r\n      success: true,\r\n      error: null,\r\n    };\r\n\r\n    const nextResponse = NextResponse.json(response, { status: 201 });\r\n    addRateLimitHeaders(nextResponse, rateLimitResult);\r\n\r\n    logger.log(LogLevel.INFO, LogCategory.API, 'Orden creada exitosamente por admin', {\r\n      orderId: order.id,\r\n      orderNumber,\r\n      totalAmount,\r\n      responseTime,\r\n    });\r\n\r\n    return nextResponse;\r\n\r\n  } catch (error) {\r\n    const responseTime = Date.now() - startTime;\r\n    metricsCollector.recordApiCall('admin-orders-create', responseTime, 500);\r\n\r\n    logger.log(LogLevel.ERROR, LogCategory.API, 'Error en POST /api/admin/orders', { error });\r\n\r\n    return NextResponse.json(\r\n      { error: 'Error interno del servidor' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":["GET","POST","OrderFiltersSchema","z","object","page","coerce","number","min","default","limit","max","status","string","optional","payment_status","date_from","date_to","search","sort_by","enum","sort_order","CreateOrderSchema","user_id","uuid","items","array","product_id","quantity","unit_price","shipping_address","street_name","street_number","zip_code","city_name","state_name","notes","validateAdminAuth","session","auth","user","error","isAdmin","email","userId","id","logger","log","LogLevel","ERROR","LogCategory","AUTH","request","startTime","Date","now","rateLimitResult","checkRateLimit","RATE_LIMIT_CONFIGS","admin","requests","window","success","response","NextResponse","json","addRateLimitHeaders","authResult","searchParams","URL","url","filtersResult","safeParse","get","details","errors","filters","data","query","supabaseAdmin","from","select","count","eq","gte","lte","or","to","orders","order","ascending","range","DATABASE","totalPages","Math","ceil","hasNextPage","hasPreviousPage","responseTime","metricsCollector","recordApiCall","pagination","total","nextResponse","INFO","API","length","body","validationResult","orderData","orderNumber","random","toString","substr","toUpperCase","totalAmount","reduce","sum","item","orderError","insert","order_number","total_amount","currency","JSON","stringify","single","orderItems","map","order_id","total_price","itemsError","delete","orderId"],"mappings":"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"}