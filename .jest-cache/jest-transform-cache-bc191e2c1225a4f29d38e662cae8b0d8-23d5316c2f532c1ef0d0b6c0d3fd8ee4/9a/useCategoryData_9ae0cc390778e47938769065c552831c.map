{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\hooks\\useCategoryData.ts"],"sourcesContent":["/**\r\n * useCategoryData Hook\r\n * Manages category data fetching, caching, and state\r\n * Pinteya E-commerce - Enterprise-ready implementation\r\n */\r\n\r\nimport { useState, useEffect, useCallback, useMemo } from 'react';\r\nimport type { Category, UseCategoryDataReturn } from '@/types/categories';\r\n\r\n/**\r\n * Configuration options for the category data hook\r\n */\r\ninterface UseCategoryDataOptions {\r\n  /** Whether to fetch data immediately on mount */\r\n  autoFetch?: boolean;\r\n  /** Cache duration in milliseconds */\r\n  cacheDuration?: number;\r\n  /** Whether to enable background refresh */\r\n  enableBackgroundRefresh?: boolean;\r\n  /** Refresh interval in milliseconds */\r\n  refreshInterval?: number;\r\n  /** Maximum number of categories to fetch */\r\n  maxCategories?: number;\r\n  /** Whether to enable analytics tracking */\r\n  enableAnalytics?: boolean;\r\n  /** Fallback categories if API fails */\r\n  fallbackCategories?: Category[];\r\n  /** API endpoint for categories */\r\n  apiEndpoint?: string;\r\n}\r\n\r\n/**\r\n * Cache interface for storing category data\r\n */\r\ninterface CategoryCache {\r\n  data: Category[];\r\n  timestamp: number;\r\n  expiresAt: number;\r\n}\r\n\r\n/**\r\n * In-memory cache for category data\r\n */\r\nconst categoryCache = new Map<string, CategoryCache>();\r\n\r\n/**\r\n * Default categories data (fallback) - ELIMINADO\r\n * DATOS HARDCODEADOS ELIMINADOS - Ahora usa solo API real de Supabase\r\n * Las categorías se obtienen dinámicamente desde /api/categories\r\n */\r\nconst DEFAULT_CATEGORIES: Category[] = [];\r\n\r\n/**\r\n * Custom hook for managing category data\r\n * \r\n * Features:\r\n * - Data fetching with caching\r\n * - Background refresh\r\n * - Error handling and fallbacks\r\n * - Performance optimization\r\n * - Analytics tracking\r\n * \r\n * @param options Configuration options\r\n * @returns Category data state and actions\r\n */\r\nexport const useCategoryData = (\r\n  options: UseCategoryDataOptions = {}\r\n): UseCategoryDataReturn => {\r\n  const {\r\n    autoFetch = true,\r\n    cacheDuration = 5 * 60 * 1000, // 5 minutes\r\n    enableBackgroundRefresh = true,\r\n    refreshInterval = 30 * 60 * 1000, // 30 minutes\r\n    maxCategories = 20,\r\n    enableAnalytics = true,\r\n    fallbackCategories = [], // Sin fallback - usar solo datos de API\r\n    apiEndpoint = '/api/categories',\r\n  } = options;\r\n\r\n  const [categories, setCategories] = useState<Category[]>(fallbackCategories);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  /**\r\n   * Generate cache key based on options\r\n   */\r\n  const cacheKey = useMemo(() => {\r\n    return `categories_${maxCategories}_${apiEndpoint}`;\r\n  }, [maxCategories, apiEndpoint]);\r\n\r\n  /**\r\n   * Check if cached data is valid\r\n   */\r\n  const isCacheValid = useCallback((cache: CategoryCache): boolean => {\r\n    return Date.now() < cache.expiresAt;\r\n  }, []);\r\n\r\n  /**\r\n   * Get data from cache if valid\r\n   */\r\n  const getCachedData = useCallback((): Category[] | null => {\r\n    const cached = categoryCache.get(cacheKey);\r\n    if (cached && isCacheValid(cached)) {\r\n      return cached.data;\r\n    }\r\n    return null;\r\n  }, [cacheKey, isCacheValid]);\r\n\r\n  /**\r\n   * Store data in cache\r\n   */\r\n  const setCachedData = useCallback((data: Category[]) => {\r\n    const now = Date.now();\r\n    categoryCache.set(cacheKey, {\r\n      data,\r\n      timestamp: now,\r\n      expiresAt: now + cacheDuration,\r\n    });\r\n  }, [cacheKey, cacheDuration]);\r\n\r\n  /**\r\n   * Track analytics event\r\n   */\r\n  const trackAnalytics = useCallback((event: string, data?: any) => {\r\n    if (!enableAnalytics) {return;}\r\n\r\n    if (typeof window !== 'undefined' && window.gtag) {\r\n      window.gtag('event', 'category_data', {\r\n        event_category: 'data',\r\n        event_label: event,\r\n        custom_parameters: data,\r\n      });\r\n    }\r\n\r\n    if (process.env.NODE_ENV === 'development') {\r\n    }\r\n  }, [enableAnalytics]);\r\n\r\n  /**\r\n   * Fetch categories from API\r\n   */\r\n  const fetchCategories = useCallback(async (): Promise<Category[]> => {\r\n    try {\r\n      const response = await fetch(apiEndpoint);\r\n      \r\n      if (!response.ok) {\r\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n      }\r\n\r\n      const result = await response.json();\r\n      \r\n      // Handle different API response formats\r\n      let categoriesData: Category[];\r\n      if (Array.isArray(result)) {\r\n        categoriesData = result;\r\n      } else if (result.data && Array.isArray(result.data)) {\r\n        categoriesData = result.data;\r\n      } else if (result.categories && Array.isArray(result.categories)) {\r\n        categoriesData = result.categories;\r\n      } else {\r\n        throw new Error('Invalid API response format');\r\n      }\r\n\r\n      // Validate and transform data\r\n      const validCategories = categoriesData\r\n        .filter((cat): cat is any =>\r\n          typeof cat === 'object' &&\r\n          cat !== null &&\r\n          (typeof cat.id === 'string' || typeof cat.id === 'number') &&\r\n          typeof cat.name === 'string'\r\n        )\r\n        .slice(0, maxCategories)\r\n        .map(cat => ({\r\n          id: cat.slug || cat.id.toString(), // Use slug as ID, fallback to string ID\r\n          name: cat.name,\r\n          icon: cat.image_url || (cat.icon ? cat.icon : \"/images/categories/placeholder.png\"), // Safe access to icon property\r\n          description: cat.description || `Productos de ${cat.name.toLowerCase()}`, // Generate description if missing\r\n          isAvailable: cat.isAvailable ?? true,\r\n          // Keep additional API fields for compatibility\r\n          products_count: cat.products_count || 0,\r\n          slug: cat.slug,\r\n          parent_id: cat.parent_id,\r\n          image_url: cat.image_url,\r\n          created_at: cat.created_at,\r\n          updated_at: cat.updated_at\r\n        }));\r\n\r\n      trackAnalytics('fetch_success', { count: validCategories.length });\r\n      return validCategories;\r\n\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      trackAnalytics('fetch_error', { error: errorMessage });\r\n      throw new Error(`Failed to fetch categories: ${errorMessage}`);\r\n    }\r\n  }, [apiEndpoint, maxCategories, trackAnalytics]);\r\n\r\n  /**\r\n   * Refresh categories data\r\n   */\r\n  const refresh = useCallback(async (): Promise<void> => {\r\n    setLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      // Check cache first\r\n      const cachedData = getCachedData();\r\n      if (cachedData && !enableBackgroundRefresh) {\r\n        setCategories(cachedData);\r\n        setLoading(false);\r\n        return;\r\n      }\r\n\r\n      // Fetch fresh data\r\n      const freshData = await fetchCategories();\r\n\r\n      // Update state and cache\r\n      setCategories(freshData);\r\n      setCachedData(freshData);\r\n      setError(null);\r\n\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Failed to load categories';\r\n      setError(errorMessage);\r\n\r\n      // Use cached data as fallback if available\r\n      const cachedData = getCachedData();\r\n      if (cachedData) {\r\n        setCategories(cachedData);\r\n      } else {\r\n        setCategories(fallbackCategories);\r\n      }\r\n\r\n      console.error('Category data error:', error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [\r\n    getCachedData,\r\n    enableBackgroundRefresh,\r\n    fetchCategories,\r\n    setCachedData,\r\n    fallbackCategories,\r\n  ]);\r\n\r\n  /**\r\n   * Get category by ID\r\n   */\r\n  const getCategoryById = useCallback((id: string): Category | undefined => {\r\n    return categories.find(cat => cat.id === id);\r\n  }, [categories]);\r\n\r\n  /**\r\n   * Initial data load\r\n   */\r\n  useEffect(() => {\r\n    if (autoFetch) {\r\n      refresh();\r\n    }\r\n  }, [autoFetch]); // Removed refresh dependency to prevent infinite loop\r\n\r\n  /**\r\n   * Background refresh interval\r\n   */\r\n  useEffect(() => {\r\n    if (!enableBackgroundRefresh || refreshInterval <= 0) {return;}\r\n\r\n    const interval = setInterval(() => {\r\n      refresh();\r\n    }, refreshInterval);\r\n\r\n    return () => clearInterval(interval);\r\n  }, [enableBackgroundRefresh, refreshInterval]); // Removed refresh dependency to prevent infinite loop\r\n\r\n  /**\r\n   * Memoized return object for performance\r\n   */\r\n  const returnValue = useMemo((): UseCategoryDataReturn => ({\r\n    categories,\r\n    loading,\r\n    error,\r\n    refresh,\r\n    getCategoryById,\r\n  }), [categories, loading, error, refresh, getCategoryById]);\r\n\r\n  return returnValue;\r\n};\r\n\r\n/**\r\n * Utility to preload category images\r\n */\r\nexport const preloadCategoryImages = (categories: Category[]): void => {\r\n  if (typeof window === 'undefined') {return;}\r\n\r\n  categories.forEach(category => {\r\n    if (category && category.icon) {\r\n      const img = new Image();\r\n      img.src = category.icon;\r\n    }\r\n  });\r\n};\r\n\r\n/**\r\n * Utility to clear category cache\r\n */\r\nexport const clearCategoryCache = (): void => {\r\n  categoryCache.clear();\r\n};\r\n\r\n/**\r\n * Default export for convenience\r\n */\r\nexport default useCategoryData;\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"names":["clearCategoryCache","preloadCategoryImages","useCategoryData","categoryCache","Map","DEFAULT_CATEGORIES","options","autoFetch","cacheDuration","enableBackgroundRefresh","refreshInterval","maxCategories","enableAnalytics","fallbackCategories","apiEndpoint","categories","setCategories","useState","loading","setLoading","error","setError","cacheKey","useMemo","isCacheValid","useCallback","cache","Date","now","expiresAt","getCachedData","cached","get","data","setCachedData","set","timestamp","trackAnalytics","event","window","gtag","event_category","event_label","custom_parameters","process","env","NODE_ENV","fetchCategories","response","fetch","ok","Error","status","statusText","result","json","categoriesData","Array","isArray","validCategories","filter","cat","id","name","slice","map","slug","toString","icon","image_url","description","toLowerCase","isAvailable","products_count","parent_id","created_at","updated_at","count","length","errorMessage","message","refresh","cachedData","freshData","console","getCategoryById","find","useEffect","interval","setInterval","clearInterval","returnValue","forEach","category","img","Image","src","clear"],"mappings":"AAAA;;;;CAIC;;;;;;;;;;;QA6SYA;eAAAA;;QAIb;;CAEC,GACD;eAAA;;QArBaC;eAAAA;;QAlOAC;eAAAA;;;uBA3D6C;AAkC1D;;CAEC,GACD,MAAMC,gBAAgB,IAAIC;AAE1B;;;;CAIC,GACD,MAAMC,qBAAiC,EAAE;AAelC,MAAMH,kBAAkB,CAC7BI,UAAkC,CAAC,CAAC;IAEpC,MAAM,EACJC,YAAY,IAAI,EAChBC,gBAAgB,IAAI,KAAK,IAAI,EAC7BC,0BAA0B,IAAI,EAC9BC,kBAAkB,KAAK,KAAK,IAAI,EAChCC,gBAAgB,EAAE,EAClBC,kBAAkB,IAAI,EACtBC,qBAAqB,EAAE,EACvBC,cAAc,iBAAiB,EAChC,GAAGR;IAEJ,MAAM,CAACS,YAAYC,cAAc,GAAGC,IAAAA,eAAQ,EAAaJ;IACzD,MAAM,CAACK,SAASC,WAAW,GAAGF,IAAAA,eAAQ,EAAC;IACvC,MAAM,CAACG,OAAOC,SAAS,GAAGJ,IAAAA,eAAQ,EAAgB;IAElD;;GAEC,GACD,MAAMK,WAAWC,IAAAA,cAAO,EAAC;QACvB,OAAO,CAAC,WAAW,EAAEZ,cAAc,CAAC,EAAEG,aAAa;IACrD,GAAG;QAACH;QAAeG;KAAY;IAE/B;;GAEC,GACD,MAAMU,eAAeC,IAAAA,kBAAW,EAAC,CAACC;QAChC,OAAOC,KAAKC,GAAG,KAAKF,MAAMG,SAAS;IACrC,GAAG,EAAE;IAEL;;GAEC,GACD,MAAMC,gBAAgBL,IAAAA,kBAAW,EAAC;QAChC,MAAMM,SAAS5B,cAAc6B,GAAG,CAACV;QACjC,IAAIS,UAAUP,aAAaO,SAAS;YAClC,OAAOA,OAAOE,IAAI;QACpB;QACA,OAAO;IACT,GAAG;QAACX;QAAUE;KAAa;IAE3B;;GAEC,GACD,MAAMU,gBAAgBT,IAAAA,kBAAW,EAAC,CAACQ;QACjC,MAAML,MAAMD,KAAKC,GAAG;QACpBzB,cAAcgC,GAAG,CAACb,UAAU;YAC1BW;YACAG,WAAWR;YACXC,WAAWD,MAAMpB;QACnB;IACF,GAAG;QAACc;QAAUd;KAAc;IAE5B;;GAEC,GACD,MAAM6B,iBAAiBZ,IAAAA,kBAAW,EAAC,CAACa,OAAeL;QACjD,IAAI,CAACrB,iBAAiB;YAAC;QAAO;QAE9B,IAAI,OAAO2B,WAAW,eAAeA,OAAOC,IAAI,EAAE;YAChDD,OAAOC,IAAI,CAAC,SAAS,iBAAiB;gBACpCC,gBAAgB;gBAChBC,aAAaJ;gBACbK,mBAAmBV;YACrB;QACF;QAEA,IAAIW,QAAQC,GAAG,CAACC,QAAQ,KAAK,eAAe,CAC5C;IACF,GAAG;QAAClC;KAAgB;IAEpB;;GAEC,GACD,MAAMmC,kBAAkBtB,IAAAA,kBAAW,EAAC;QAClC,IAAI;YACF,MAAMuB,WAAW,MAAMC,MAAMnC;YAE7B,IAAI,CAACkC,SAASE,EAAE,EAAE;gBAChB,MAAM,IAAIC,MAAM,CAAC,KAAK,EAAEH,SAASI,MAAM,CAAC,EAAE,EAAEJ,SAASK,UAAU,EAAE;YACnE;YAEA,MAAMC,SAAS,MAAMN,SAASO,IAAI;YAElC,wCAAwC;YACxC,IAAIC;YACJ,IAAIC,MAAMC,OAAO,CAACJ,SAAS;gBACzBE,iBAAiBF;YACnB,OAAO,IAAIA,OAAOrB,IAAI,IAAIwB,MAAMC,OAAO,CAACJ,OAAOrB,IAAI,GAAG;gBACpDuB,iBAAiBF,OAAOrB,IAAI;YAC9B,OAAO,IAAIqB,OAAOvC,UAAU,IAAI0C,MAAMC,OAAO,CAACJ,OAAOvC,UAAU,GAAG;gBAChEyC,iBAAiBF,OAAOvC,UAAU;YACpC,OAAO;gBACL,MAAM,IAAIoC,MAAM;YAClB;YAEA,8BAA8B;YAC9B,MAAMQ,kBAAkBH,eACrBI,MAAM,CAAC,CAACC,MACP,OAAOA,QAAQ,YACfA,QAAQ,QACP,CAAA,OAAOA,IAAIC,EAAE,KAAK,YAAY,OAAOD,IAAIC,EAAE,KAAK,QAAO,KACxD,OAAOD,IAAIE,IAAI,KAAK,UAErBC,KAAK,CAAC,GAAGrD,eACTsD,GAAG,CAACJ,CAAAA,MAAQ,CAAA;oBACXC,IAAID,IAAIK,IAAI,IAAIL,IAAIC,EAAE,CAACK,QAAQ;oBAC/BJ,MAAMF,IAAIE,IAAI;oBACdK,MAAMP,IAAIQ,SAAS,IAAKR,CAAAA,IAAIO,IAAI,GAAGP,IAAIO,IAAI,GAAG,oCAAmC;oBACjFE,aAAaT,IAAIS,WAAW,IAAI,CAAC,aAAa,EAAET,IAAIE,IAAI,CAACQ,WAAW,IAAI;oBACxEC,aAAaX,IAAIW,WAAW,IAAI;oBAChC,+CAA+C;oBAC/CC,gBAAgBZ,IAAIY,cAAc,IAAI;oBACtCP,MAAML,IAAIK,IAAI;oBACdQ,WAAWb,IAAIa,SAAS;oBACxBL,WAAWR,IAAIQ,SAAS;oBACxBM,YAAYd,IAAIc,UAAU;oBAC1BC,YAAYf,IAAIe,UAAU;gBAC5B,CAAA;YAEFvC,eAAe,iBAAiB;gBAAEwC,OAAOlB,gBAAgBmB,MAAM;YAAC;YAChE,OAAOnB;QAET,EAAE,OAAOvC,OAAO;YACd,MAAM2D,eAAe3D,iBAAiB+B,QAAQ/B,MAAM4D,OAAO,GAAG;YAC9D3C,eAAe,eAAe;gBAAEjB,OAAO2D;YAAa;YACpD,MAAM,IAAI5B,MAAM,CAAC,4BAA4B,EAAE4B,cAAc;QAC/D;IACF,GAAG;QAACjE;QAAaH;QAAe0B;KAAe;IAE/C;;GAEC,GACD,MAAM4C,UAAUxD,IAAAA,kBAAW,EAAC;QAC1BN,WAAW;QACXE,SAAS;QAET,IAAI;YACF,oBAAoB;YACpB,MAAM6D,aAAapD;YACnB,IAAIoD,cAAc,CAACzE,yBAAyB;gBAC1CO,cAAckE;gBACd/D,WAAW;gBACX;YACF;YAEA,mBAAmB;YACnB,MAAMgE,YAAY,MAAMpC;YAExB,yBAAyB;YACzB/B,cAAcmE;YACdjD,cAAciD;YACd9D,SAAS;QAEX,EAAE,OAAOD,OAAO;YACd,MAAM2D,eAAe3D,iBAAiB+B,QAAQ/B,MAAM4D,OAAO,GAAG;YAC9D3D,SAAS0D;YAET,2CAA2C;YAC3C,MAAMG,aAAapD;YACnB,IAAIoD,YAAY;gBACdlE,cAAckE;YAChB,OAAO;gBACLlE,cAAcH;YAChB;YAEAuE,QAAQhE,KAAK,CAAC,wBAAwBA;QACxC,SAAU;YACRD,WAAW;QACb;IACF,GAAG;QACDW;QACArB;QACAsC;QACAb;QACArB;KACD;IAED;;GAEC,GACD,MAAMwE,kBAAkB5D,IAAAA,kBAAW,EAAC,CAACqC;QACnC,OAAO/C,WAAWuE,IAAI,CAACzB,CAAAA,MAAOA,IAAIC,EAAE,KAAKA;IAC3C,GAAG;QAAC/C;KAAW;IAEf;;GAEC,GACDwE,IAAAA,gBAAS,EAAC;QACR,IAAIhF,WAAW;YACb0E;QACF;IACF,GAAG;QAAC1E;KAAU,GAAG,sDAAsD;IAEvE;;GAEC,GACDgF,IAAAA,gBAAS,EAAC;QACR,IAAI,CAAC9E,2BAA2BC,mBAAmB,GAAG;YAAC;QAAO;QAE9D,MAAM8E,WAAWC,YAAY;YAC3BR;QACF,GAAGvE;QAEH,OAAO,IAAMgF,cAAcF;IAC7B,GAAG;QAAC/E;QAAyBC;KAAgB,GAAG,sDAAsD;IAEtG;;GAEC,GACD,MAAMiF,cAAcpE,IAAAA,cAAO,EAAC,IAA8B,CAAA;YACxDR;YACAG;YACAE;YACA6D;YACAI;QACF,CAAA,GAAI;QAACtE;QAAYG;QAASE;QAAO6D;QAASI;KAAgB;IAE1D,OAAOM;AACT;AAKO,MAAM1F,wBAAwB,CAACc;IACpC,IAAI,OAAOwB,WAAW,aAAa;QAAC;IAAO;IAE3CxB,WAAW6E,OAAO,CAACC,CAAAA;QACjB,IAAIA,YAAYA,SAASzB,IAAI,EAAE;YAC7B,MAAM0B,MAAM,IAAIC;YAChBD,IAAIE,GAAG,GAAGH,SAASzB,IAAI;QACzB;IACF;AACF;AAKO,MAAMpE,qBAAqB;IAChCG,cAAc8F,KAAK;AACrB;MAKA,WAAe/F"}