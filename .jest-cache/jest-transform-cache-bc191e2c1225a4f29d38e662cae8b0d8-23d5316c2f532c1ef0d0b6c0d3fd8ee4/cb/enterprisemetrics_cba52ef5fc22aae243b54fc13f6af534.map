{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\lib\\monitoring\\enterprise-metrics.ts"],"sourcesContent":["// ===================================\r\n// PINTEYA E-COMMERCE - ENTERPRISE METRICS SYSTEM\r\n// ===================================\r\n\r\nimport { logger, LogLevel, LogCategory } from '@/lib/enterprise/logger';\r\nimport { getSupabaseClient } from '@/lib/integrations/supabase';\r\nimport { enterpriseAlertSystem, AlertLevel as AlertSystemLevel } from './alert-system';\r\n\r\n// ✅ IMPORT CONDICIONAL: Solo cargar CacheUtils en servidor para evitar errores de ioredis en cliente\r\nlet CacheUtils: any = null;\r\nif (typeof window === 'undefined') {\r\n  // Solo en servidor\r\n  try {\r\n    CacheUtils = require('@/lib/cache-manager').CacheUtils;\r\n  } catch (error) {\r\n    console.warn('[EnterpriseMetrics] CacheUtils not available:', error);\r\n  }\r\n}\r\n\r\n// Tipos de métricas enterprise\r\nexport enum MetricType {\r\n  COUNTER = 'counter',           // Contador incremental\r\n  GAUGE = 'gauge',              // Valor actual\r\n  HISTOGRAM = 'histogram',       // Distribución de valores\r\n  TIMER = 'timer',              // Medición de tiempo\r\n  RATE = 'rate'                 // Tasa por unidad de tiempo\r\n}\r\n\r\n// Categorías de métricas de negocio\r\nexport enum BusinessMetricCategory {\r\n  PERFORMANCE = 'performance',\r\n  SECURITY = 'security',\r\n  BUSINESS = 'business',\r\n  INFRASTRUCTURE = 'infrastructure',\r\n  USER_EXPERIENCE = 'user_experience'\r\n}\r\n\r\n// Niveles de alerta\r\nexport enum AlertLevel {\r\n  INFO = 'info',\r\n  WARNING = 'warning',\r\n  CRITICAL = 'critical',\r\n  EMERGENCY = 'emergency'\r\n}\r\n\r\n// Métrica enterprise\r\nexport interface EnterpriseMetric {\r\n  id: string;\r\n  name: string;\r\n  type: MetricType;\r\n  category: BusinessMetricCategory;\r\n  value: number;\r\n  timestamp: string;\r\n  tags: Record<string, string>;\r\n  metadata?: Record<string, any>;\r\n  aggregationPeriod?: string; // '1m', '5m', '1h', '1d'\r\n}\r\n\r\n// Configuración de alerta\r\nexport interface AlertRule {\r\n  id: string;\r\n  metricName: string;\r\n  condition: 'gt' | 'lt' | 'eq' | 'gte' | 'lte';\r\n  threshold: number;\r\n  level: AlertLevel;\r\n  enabled: boolean;\r\n  cooldownMinutes: number;\r\n  description: string;\r\n  actions: AlertAction[];\r\n}\r\n\r\n// Acción de alerta\r\nexport interface AlertAction {\r\n  type: 'email' | 'webhook' | 'log' | 'slack';\r\n  config: Record<string, any>;\r\n}\r\n\r\n// Alerta activa\r\nexport interface ActiveAlert {\r\n  id: string;\r\n  ruleId: string;\r\n  metricName: string;\r\n  level: AlertLevel;\r\n  message: string;\r\n  value: number;\r\n  threshold: number;\r\n  triggeredAt: string;\r\n  resolvedAt?: string;\r\n  metadata?: Record<string, any>;\r\n}\r\n\r\n// Agregación temporal\r\nexport interface MetricAggregation {\r\n  period: string;\r\n  startTime: string;\r\n  endTime: string;\r\n  count: number;\r\n  sum: number;\r\n  avg: number;\r\n  min: number;\r\n  max: number;\r\n  p50: number;\r\n  p95: number;\r\n  p99: number;\r\n}\r\n\r\n/**\r\n * Sistema de Métricas Enterprise con agregación temporal y alertas\r\n */\r\nexport class EnterpriseMetricsCollector {\r\n  private static instance: EnterpriseMetricsCollector;\r\n  private alertRules: Map<string, AlertRule> = new Map();\r\n  private activeAlerts: Map<string, ActiveAlert> = new Map();\r\n  private metricsBuffer: EnterpriseMetric[] = [];\r\n  private flushInterval: NodeJS.Timeout | null = null;\r\n\r\n  constructor() {\r\n    this.initializeDefaultAlerts();\r\n    this.startMetricsFlush();\r\n  }\r\n\r\n  static getInstance(): EnterpriseMetricsCollector {\r\n    if (!EnterpriseMetricsCollector.instance) {\r\n      EnterpriseMetricsCollector.instance = new EnterpriseMetricsCollector();\r\n    }\r\n    return EnterpriseMetricsCollector.instance;\r\n  }\r\n\r\n  /**\r\n   * Registra una métrica enterprise\r\n   */\r\n  async recordMetric(\r\n    name: string,\r\n    value: number,\r\n    type: MetricType = MetricType.GAUGE,\r\n    category: BusinessMetricCategory = BusinessMetricCategory.PERFORMANCE,\r\n    tags: Record<string, string> = {},\r\n    metadata?: Record<string, any>\r\n  ): Promise<void> {\r\n    try {\r\n      const metric: EnterpriseMetric = {\r\n        id: this.generateMetricId(),\r\n        name,\r\n        type,\r\n        category,\r\n        value,\r\n        timestamp: new Date().toISOString(),\r\n        tags,\r\n        metadata\r\n      };\r\n\r\n      // Agregar a buffer para flush batch\r\n      this.metricsBuffer.push(metric);\r\n\r\n      // Verificar alertas\r\n      await this.checkAlerts(metric);\r\n\r\n      // Log para debugging\r\n      logger.debug(LogLevel.DEBUG, `Metric recorded: ${name}`, {\r\n        value,\r\n        type,\r\n        category,\r\n        tags\r\n      }, LogCategory.SYSTEM);\r\n\r\n    } catch (error) {\r\n      logger.error(LogLevel.ERROR, `Failed to record metric: ${name}`, {\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n        value,\r\n        type\r\n      }, LogCategory.SYSTEM);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Métricas de performance específicas\r\n   */\r\n  async recordPerformanceMetric(\r\n    operation: string,\r\n    duration: number,\r\n    success: boolean,\r\n    tags: Record<string, string> = {}\r\n  ): Promise<void> {\r\n    await this.recordMetric(\r\n      `performance.${operation}.duration`,\r\n      duration,\r\n      MetricType.TIMER,\r\n      BusinessMetricCategory.PERFORMANCE,\r\n      { ...tags, success: success.toString() }\r\n    );\r\n\r\n    await this.recordMetric(\r\n      `performance.${operation}.count`,\r\n      1,\r\n      MetricType.COUNTER,\r\n      BusinessMetricCategory.PERFORMANCE,\r\n      { ...tags, success: success.toString() }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Métricas de negocio específicas\r\n   */\r\n  async recordBusinessMetric(\r\n    event: string,\r\n    value: number = 1,\r\n    tags: Record<string, string> = {}\r\n  ): Promise<void> {\r\n    await this.recordMetric(\r\n      `business.${event}`,\r\n      value,\r\n      MetricType.COUNTER,\r\n      BusinessMetricCategory.BUSINESS,\r\n      tags\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Métricas de seguridad específicas\r\n   */\r\n  async recordSecurityMetric(\r\n    event: string,\r\n    severity: 'low' | 'medium' | 'high' | 'critical',\r\n    tags: Record<string, string> = {}\r\n  ): Promise<void> {\r\n    await this.recordMetric(\r\n      `security.${event}`,\r\n      1,\r\n      MetricType.COUNTER,\r\n      BusinessMetricCategory.SECURITY,\r\n      { ...tags, severity }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Métricas de experiencia de usuario\r\n   */\r\n  async recordUserExperienceMetric(\r\n    metric: string,\r\n    value: number,\r\n    userId?: string,\r\n    tags: Record<string, string> = {}\r\n  ): Promise<void> {\r\n    await this.recordMetric(\r\n      `ux.${metric}`,\r\n      value,\r\n      MetricType.GAUGE,\r\n      BusinessMetricCategory.USER_EXPERIENCE,\r\n      { ...tags, userId: userId || 'anonymous' }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Configura una regla de alerta\r\n   */\r\n  setAlertRule(rule: AlertRule): void {\r\n    this.alertRules.set(rule.id, rule);\r\n    logger.info(LogLevel.INFO, `Alert rule configured: ${rule.id}`, {\r\n      metricName: rule.metricName,\r\n      threshold: rule.threshold,\r\n      level: rule.level\r\n    }, LogCategory.SYSTEM);\r\n  }\r\n\r\n  /**\r\n   * Verifica alertas para una métrica\r\n   */\r\n  private async checkAlerts(metric: EnterpriseMetric): Promise<void> {\r\n    for (const rule of this.alertRules.values()) {\r\n      if (!rule.enabled || rule.metricName !== metric.name) {\r\n        continue;\r\n      }\r\n\r\n      // Verificar si ya hay una alerta activa en cooldown\r\n      const existingAlert = Array.from(this.activeAlerts.values())\r\n        .find(alert => alert.ruleId === rule.id && !alert.resolvedAt);\r\n\r\n      if (existingAlert) {\r\n        const cooldownEnd = new Date(existingAlert.triggeredAt);\r\n        cooldownEnd.setMinutes(cooldownEnd.getMinutes() + rule.cooldownMinutes);\r\n        \r\n        if (new Date() < cooldownEnd) {\r\n          continue; // Aún en cooldown\r\n        }\r\n      }\r\n\r\n      // Evaluar condición\r\n      const triggered = this.evaluateCondition(metric.value, rule.condition, rule.threshold);\r\n\r\n      if (triggered) {\r\n        await this.triggerAlert(rule, metric);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Evalúa condición de alerta\r\n   */\r\n  private evaluateCondition(value: number, condition: string, threshold: number): boolean {\r\n    switch (condition) {\r\n      case 'gt': return value > threshold;\r\n      case 'gte': return value >= threshold;\r\n      case 'lt': return value < threshold;\r\n      case 'lte': return value <= threshold;\r\n      case 'eq': return value === threshold;\r\n      default: return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Dispara una alerta usando el sistema enterprise\r\n   */\r\n  private async triggerAlert(rule: AlertRule, metric: EnterpriseMetric): Promise<void> {\r\n    // Convertir nivel de alerta al sistema enterprise\r\n    const alertLevel = this.convertToAlertSystemLevel(rule.level);\r\n\r\n    // Usar el sistema de alertas enterprise\r\n    const alert = await enterpriseAlertSystem.triggerAlert(\r\n      rule.id,\r\n      rule.metricName,\r\n      metric.value,\r\n      `${rule.description} - Value: ${metric.value}, Threshold: ${rule.threshold}`\r\n    );\r\n\r\n    if (alert) {\r\n      // Mantener referencia local para compatibilidad\r\n      const localAlert: ActiveAlert = {\r\n        id: alert.id,\r\n        ruleId: alert.ruleId,\r\n        metricName: alert.metricName,\r\n        level: rule.level,\r\n        message: alert.message,\r\n        value: alert.value,\r\n        threshold: alert.threshold,\r\n        triggeredAt: alert.triggeredAt,\r\n        metadata: {\r\n          metric: metric,\r\n          rule: rule\r\n        }\r\n      };\r\n\r\n      this.activeAlerts.set(alert.id, localAlert);\r\n\r\n      // Log alerta\r\n      logger.warn(LogLevel.WARN, `Alert triggered via enterprise system: ${rule.id}`, {\r\n        alertId: alert.id,\r\n        level: alert.level,\r\n        metricName: alert.metricName,\r\n        value: alert.value,\r\n        threshold: alert.threshold\r\n      }, LogCategory.SYSTEM);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Ejecuta acción de alerta\r\n   */\r\n  private async executeAlertAction(action: AlertAction, alert: ActiveAlert): Promise<void> {\r\n    try {\r\n      switch (action.type) {\r\n        case 'log':\r\n          logger.error(LogLevel.ERROR, `ALERT: ${alert.message}`, {\r\n            alertId: alert.id,\r\n            level: alert.level\r\n          }, LogCategory.SYSTEM);\r\n          break;\r\n\r\n        case 'webhook':\r\n          if (action.config.url) {\r\n            await fetch(action.config.url, {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify(alert)\r\n            });\r\n          }\r\n          break;\r\n\r\n        case 'email':\r\n          // TODO: Implementar envío de email\r\n          logger.info(LogLevel.INFO, `Email alert would be sent to: ${action.config.to}`, {\r\n            alertId: alert.id\r\n          }, LogCategory.SYSTEM);\r\n          break;\r\n\r\n        case 'slack':\r\n          // TODO: Implementar notificación Slack\r\n          logger.info(LogLevel.INFO, `Slack alert would be sent to: ${action.config.channel}`, {\r\n            alertId: alert.id\r\n          }, LogCategory.SYSTEM);\r\n          break;\r\n      }\r\n    } catch (error) {\r\n      logger.error(LogLevel.ERROR, `Failed to execute alert action: ${action.type}`, {\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n        alertId: alert.id\r\n      }, LogCategory.SYSTEM);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene métricas agregadas\r\n   */\r\n  async getAggregatedMetrics(\r\n    metricName: string,\r\n    period: '1m' | '5m' | '1h' | '1d' | '7d',\r\n    startTime: string,\r\n    endTime: string\r\n  ): Promise<MetricAggregation[]> {\r\n    const cacheKey = `metrics:aggregated:${metricName}:${period}:${startTime}:${endTime}`;\r\n    \r\n    // ✅ CACHE CONDICIONAL: Solo usar cache en servidor\r\n    const fetchData = async () => {\r\n      const supabase = getSupabaseClient(true);\r\n\r\n      if (!supabase) {\r\n        throw new Error('Supabase client not available');\r\n      }\r\n\r\n      // Query con agregación SQL\r\n      const { data, error } = await supabase.rpc('aggregate_metrics', {\r\n        metric_name: metricName,\r\n        period_interval: period,\r\n        start_time: startTime,\r\n        end_time: endTime\r\n      });\r\n\r\n      if (error) {\r\n        throw new Error(`Failed to aggregate metrics: ${error.message}`);\r\n      }\r\n\r\n      return data || [];\r\n    };\r\n\r\n    // Usar cache solo si está disponible (servidor)\r\n    if (CacheUtils && typeof window === 'undefined') {\r\n      return CacheUtils.cacheMetricsAggregation(cacheKey, fetchData);\r\n    } else {\r\n      return fetchData();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Flush métricas a base de datos\r\n   */\r\n  private async flushMetrics(): Promise<void> {\r\n    if (this.metricsBuffer.length === 0) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const metrics = [...this.metricsBuffer];\r\n      this.metricsBuffer = [];\r\n\r\n      const supabase = getSupabaseClient(true);\r\n      if (!supabase) {\r\n        logger.error(LogLevel.ERROR, 'Supabase client not available for metrics flush', {}, LogCategory.SYSTEM);\r\n        return;\r\n      }\r\n\r\n      const { error } = await supabase\r\n        .from('enterprise_metrics')\r\n        .insert(metrics.map(metric => ({\r\n          id: metric.id,\r\n          name: metric.name,\r\n          type: metric.type,\r\n          category: metric.category,\r\n          value: metric.value,\r\n          timestamp: metric.timestamp,\r\n          tags: metric.tags,\r\n          metadata: metric.metadata\r\n        })));\r\n\r\n      if (error) {\r\n        logger.error(LogLevel.ERROR, 'Failed to flush metrics to database', {\r\n          error: error.message,\r\n          metricsCount: metrics.length\r\n        }, LogCategory.SYSTEM);\r\n      } else {\r\n        logger.debug(LogLevel.DEBUG, `Flushed ${metrics.length} metrics to database`, {}, LogCategory.SYSTEM);\r\n      }\r\n\r\n    } catch (error) {\r\n      logger.error(LogLevel.ERROR, 'Error during metrics flush', {\r\n        error: error instanceof Error ? error.message : 'Unknown error'\r\n      }, LogCategory.SYSTEM);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Inicializa alertas por defecto\r\n   */\r\n  private initializeDefaultAlerts(): void {\r\n    // Alerta de response time alto\r\n    this.setAlertRule({\r\n      id: 'high_response_time',\r\n      metricName: 'performance.api.duration',\r\n      condition: 'gt',\r\n      threshold: 5000, // 5 segundos\r\n      level: AlertLevel.WARNING,\r\n      enabled: true,\r\n      cooldownMinutes: 5,\r\n      description: 'API response time is too high',\r\n      actions: [{ type: 'log', config: {} }]\r\n    });\r\n\r\n    // Alerta de error rate alto\r\n    this.setAlertRule({\r\n      id: 'high_error_rate',\r\n      metricName: 'performance.api.error_rate',\r\n      condition: 'gt',\r\n      threshold: 0.05, // 5%\r\n      level: AlertLevel.CRITICAL,\r\n      enabled: true,\r\n      cooldownMinutes: 2,\r\n      description: 'API error rate is too high',\r\n      actions: [{ type: 'log', config: {} }]\r\n    });\r\n\r\n    // Alerta de violaciones de seguridad\r\n    this.setAlertRule({\r\n      id: 'security_violations',\r\n      metricName: 'security.violation',\r\n      condition: 'gte',\r\n      threshold: 1,\r\n      level: AlertLevel.EMERGENCY,\r\n      enabled: true,\r\n      cooldownMinutes: 1,\r\n      description: 'Security violation detected',\r\n      actions: [{ type: 'log', config: {} }]\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Inicia flush automático de métricas\r\n   */\r\n  private startMetricsFlush(): void {\r\n    this.flushInterval = setInterval(() => {\r\n      this.flushMetrics();\r\n    }, 30000); // Flush cada 30 segundos\r\n  }\r\n\r\n  /**\r\n   * Almacena alerta en base de datos\r\n   */\r\n  private async storeAlert(alert: ActiveAlert): Promise<void> {\r\n    try {\r\n      const supabase = getSupabaseClient(true);\r\n      if (!supabase) {return;}\r\n\r\n      await supabase.from('enterprise_alerts').insert({\r\n        id: alert.id,\r\n        rule_id: alert.ruleId,\r\n        metric_name: alert.metricName,\r\n        level: alert.level,\r\n        message: alert.message,\r\n        value: alert.value,\r\n        threshold: alert.threshold,\r\n        triggered_at: alert.triggeredAt,\r\n        resolved_at: alert.resolvedAt,\r\n        metadata: alert.metadata\r\n      });\r\n    } catch (error) {\r\n      logger.error(LogLevel.ERROR, 'Failed to store alert', {\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n        alertId: alert.id\r\n      }, LogCategory.SYSTEM);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Genera ID único para métrica\r\n   */\r\n  private generateMetricId(): string {\r\n    return `metric_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n  }\r\n\r\n  /**\r\n   * Convierte nivel de alerta al sistema enterprise\r\n   */\r\n  private convertToAlertSystemLevel(level: AlertLevel): AlertSystemLevel {\r\n    switch (level) {\r\n      case AlertLevel.INFO:\r\n        return AlertSystemLevel.INFO;\r\n      case AlertLevel.WARNING:\r\n        return AlertSystemLevel.WARNING;\r\n      case AlertLevel.CRITICAL:\r\n        return AlertSystemLevel.CRITICAL;\r\n      case AlertLevel.EMERGENCY:\r\n        return AlertSystemLevel.EMERGENCY;\r\n      default:\r\n        return AlertSystemLevel.INFO;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Genera ID único para alerta\r\n   */\r\n  private generateAlertId(): string {\r\n    return `alert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n  }\r\n\r\n  /**\r\n   * Limpia recursos\r\n   */\r\n  destroy(): void {\r\n    if (this.flushInterval) {\r\n      clearInterval(this.flushInterval);\r\n      this.flushInterval = null;\r\n    }\r\n    this.flushMetrics(); // Flush final\r\n  }\r\n}\r\n\r\n// Instancia singleton\r\nexport const enterpriseMetrics = EnterpriseMetricsCollector.getInstance();\r\n\r\n// Funciones de conveniencia\r\nexport const recordPerformanceMetric = enterpriseMetrics.recordPerformanceMetric.bind(enterpriseMetrics);\r\nexport const recordBusinessMetric = enterpriseMetrics.recordBusinessMetric.bind(enterpriseMetrics);\r\nexport const recordSecurityMetric = enterpriseMetrics.recordSecurityMetric.bind(enterpriseMetrics);\r\nexport const recordUserExperienceMetric = enterpriseMetrics.recordUserExperienceMetric.bind(enterpriseMetrics);\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"names":["AlertLevel","BusinessMetricCategory","EnterpriseMetricsCollector","MetricType","enterpriseMetrics","recordBusinessMetric","recordPerformanceMetric","recordSecurityMetric","recordUserExperienceMetric","CacheUtils","window","require","error","console","warn","alertRules","Map","activeAlerts","metricsBuffer","flushInterval","initializeDefaultAlerts","startMetricsFlush","getInstance","instance","recordMetric","name","value","type","category","tags","metadata","metric","id","generateMetricId","timestamp","Date","toISOString","push","checkAlerts","logger","debug","LogLevel","DEBUG","LogCategory","SYSTEM","ERROR","Error","message","operation","duration","success","toString","event","severity","userId","setAlertRule","rule","set","info","INFO","metricName","threshold","level","values","enabled","existingAlert","Array","from","find","alert","ruleId","resolvedAt","cooldownEnd","triggeredAt","setMinutes","getMinutes","cooldownMinutes","triggered","evaluateCondition","condition","triggerAlert","alertLevel","convertToAlertSystemLevel","enterpriseAlertSystem","description","localAlert","WARN","alertId","executeAlertAction","action","config","url","fetch","method","headers","body","JSON","stringify","to","channel","getAggregatedMetrics","period","startTime","endTime","cacheKey","fetchData","supabase","getSupabaseClient","data","rpc","metric_name","period_interval","start_time","end_time","cacheMetricsAggregation","flushMetrics","length","metrics","insert","map","metricsCount","actions","setInterval","storeAlert","rule_id","triggered_at","resolved_at","now","Math","random","substr","AlertSystemLevel","WARNING","CRITICAL","EMERGENCY","generateAlertId","destroy","clearInterval","bind"],"mappings":"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"}