{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\lib\\monitoring\\proactive-monitoring.ts"],"sourcesContent":["'use client'\r\n\r\nimport { logger, LogLevel, LogCategory } from '../enterprise/logger'\r\nimport { EnterpriseAlertSystem } from './alert-system'\r\nimport { EnterpriseMetricsCollector } from './enterprise-metrics'\r\nimport { emailService } from '../notifications/email'\r\nimport { slackService } from '../notifications/slack'\r\n\r\nexport interface ErrorPattern {\r\n  id: string\r\n  name: string\r\n  pattern: RegExp | string\r\n  severity: 'low' | 'medium' | 'high' | 'critical'\r\n  threshold: number // Número de ocurrencias antes de alertar\r\n  timeWindow: number // Ventana de tiempo en minutos\r\n  description: string\r\n  isActive: boolean\r\n}\r\n\r\nexport interface SystemHealth {\r\n  status: 'healthy' | 'warning' | 'critical' | 'down'\r\n  uptime: number\r\n  responseTime: number\r\n  errorRate: number\r\n  memoryUsage: number\r\n  cpuUsage: number\r\n  activeConnections: number\r\n  lastCheck: Date\r\n  issues: HealthIssue[]\r\n}\r\n\r\nexport interface HealthIssue {\r\n  id: string\r\n  type: 'performance' | 'error' | 'resource' | 'security'\r\n  severity: 'low' | 'medium' | 'high' | 'critical'\r\n  message: string\r\n  details: Record<string, any>\r\n  firstDetected: Date\r\n  lastSeen: Date\r\n  count: number\r\n}\r\n\r\nexport interface MonitoringConfig {\r\n  enabled: boolean\r\n  checkInterval: number // en segundos\r\n  errorThreshold: number\r\n  responseTimeThreshold: number\r\n  memoryThreshold: number\r\n  cpuThreshold: number\r\n  enableAutoRecovery: boolean\r\n  notificationChannels: string[]\r\n}\r\n\r\nexport class ProactiveMonitoringService {\r\n  private static instance: ProactiveMonitoringService\r\n  private alertSystem: EnterpriseAlertSystem\r\n  private metricsCollector: EnterpriseMetricsCollector\r\n  private errorPatterns: Map<string, ErrorPattern> = new Map()\r\n  private errorCounts: Map<string, { count: number; firstSeen: Date; lastSeen: Date }> = new Map()\r\n  private healthChecks: Map<string, () => Promise<any>> = new Map()\r\n  private monitoringInterval: NodeJS.Timeout | null = null\r\n  private config: MonitoringConfig\r\n\r\n  static getInstance(): ProactiveMonitoringService {\r\n    if (!ProactiveMonitoringService.instance) {\r\n      ProactiveMonitoringService.instance = new ProactiveMonitoringService()\r\n    }\r\n    return ProactiveMonitoringService.instance\r\n  }\r\n\r\n  constructor() {\r\n    // Solo inicializar en el servidor\r\n    if (typeof window === 'undefined') {\r\n      this.alertSystem = EnterpriseAlertSystem.getInstance()\r\n      this.metricsCollector = EnterpriseMetricsCollector.getInstance()\r\n    }\r\n    this.config = {\r\n      enabled: true,\r\n      checkInterval: 30, // 30 segundos\r\n      errorThreshold: 5, // 5% error rate\r\n      responseTimeThreshold: 2000, // 2 segundos\r\n      memoryThreshold: 80, // 80% memoria\r\n      cpuThreshold: 70, // 70% CPU\r\n      enableAutoRecovery: true,\r\n      notificationChannels: ['email', 'slack']\r\n    }\r\n    this.initializeDefaultPatterns()\r\n  }\r\n\r\n  private initializeDefaultPatterns(): void {\r\n    const defaultPatterns: ErrorPattern[] = [\r\n      {\r\n        id: 'database_connection_error',\r\n        name: 'Database Connection Error',\r\n        pattern: /database.*connection.*failed|connection.*timeout|pool.*exhausted/i,\r\n        severity: 'critical',\r\n        threshold: 3,\r\n        timeWindow: 5,\r\n        description: 'Errores de conexión a la base de datos',\r\n        isActive: true\r\n      },\r\n      {\r\n        id: 'payment_processing_error',\r\n        name: 'Payment Processing Error',\r\n        pattern: /payment.*failed|transaction.*error|mercadopago.*error/i,\r\n        severity: 'high',\r\n        threshold: 5,\r\n        timeWindow: 10,\r\n        description: 'Errores en el procesamiento de pagos',\r\n        isActive: true\r\n      },\r\n      {\r\n        id: 'authentication_error',\r\n        name: 'Authentication Error',\r\n        pattern: /auth.*failed|unauthorized|invalid.*token|session.*expired/i,\r\n        severity: 'medium',\r\n        threshold: 10,\r\n        timeWindow: 15,\r\n        description: 'Errores de autenticación',\r\n        isActive: true\r\n      },\r\n      {\r\n        id: 'api_rate_limit',\r\n        name: 'API Rate Limit Exceeded',\r\n        pattern: /rate.*limit.*exceeded|too.*many.*requests|429/i,\r\n        severity: 'medium',\r\n        threshold: 20,\r\n        timeWindow: 5,\r\n        description: 'Límite de velocidad de API excedido',\r\n        isActive: true\r\n      },\r\n      {\r\n        id: 'server_error',\r\n        name: 'Internal Server Error',\r\n        pattern: /internal.*server.*error|500.*error|unhandled.*exception/i,\r\n        severity: 'high',\r\n        threshold: 5,\r\n        timeWindow: 10,\r\n        description: 'Errores internos del servidor',\r\n        isActive: true\r\n      }\r\n    ]\r\n\r\n    defaultPatterns.forEach(pattern => {\r\n      this.errorPatterns.set(pattern.id, pattern)\r\n    })\r\n  }\r\n\r\n  /**\r\n   * Inicia el monitoreo proactivo\r\n   */\r\n  start(): void {\r\n    // Solo ejecutar en el servidor\r\n    if (typeof window !== 'undefined') {\r\n      return\r\n    }\r\n\r\n    if (!this.config.enabled) {\r\n      logger.info(LogLevel.INFO, 'Proactive monitoring is disabled', {}, LogCategory.SYSTEM)\r\n      return\r\n    }\r\n\r\n    if (this.monitoringInterval) {\r\n      this.stop()\r\n    }\r\n\r\n    this.monitoringInterval = setInterval(() => {\r\n      this.performHealthCheck()\r\n    }, this.config.checkInterval * 1000)\r\n\r\n    logger.info(LogLevel.INFO, 'Proactive monitoring started', {\r\n      interval: this.config.checkInterval,\r\n      patterns: this.errorPatterns.size\r\n    }, LogCategory.SYSTEM)\r\n  }\r\n\r\n  /**\r\n   * Detiene el monitoreo proactivo\r\n   */\r\n  stop(): void {\r\n    if (this.monitoringInterval) {\r\n      clearInterval(this.monitoringInterval)\r\n      this.monitoringInterval = null\r\n      logger.info(LogLevel.INFO, 'Proactive monitoring stopped', {}, LogCategory.SYSTEM)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Registra un error para análisis\r\n   */\r\n  async reportError(error: Error | string, context?: Record<string, any>): Promise<void> {\r\n    const errorMessage = error instanceof Error ? error.message : error\r\n    const errorStack = error instanceof Error ? error.stack : undefined\r\n\r\n    // Solo procesar en el servidor\r\n    if (typeof window === 'undefined') {\r\n      // Analizar patrones de error\r\n      for (const [patternId, pattern] of this.errorPatterns) {\r\n        if (!pattern.isActive) {continue}\r\n\r\n        const regex = pattern.pattern instanceof RegExp ? pattern.pattern : new RegExp(pattern.pattern, 'i')\r\n        if (regex.test(errorMessage)) {\r\n          await this.handlePatternMatch(patternId, pattern, errorMessage, context)\r\n        }\r\n      }\r\n\r\n      // Registrar métricas si está disponible\r\n      if (this.metricsCollector) {\r\n        await this.metricsCollector.recordMetric('errors_total', 1, undefined, undefined, {\r\n          type: 'application_error',\r\n          ...context\r\n        })\r\n      }\r\n    }\r\n\r\n    // Log del error\r\n    logger.error(LogLevel.ERROR, 'Error reported to monitoring', {\r\n      error: errorMessage,\r\n      stack: errorStack,\r\n      context\r\n    }, LogCategory.SYSTEM)\r\n  }\r\n\r\n  private async handlePatternMatch(\r\n    patternId: string,\r\n    pattern: ErrorPattern,\r\n    errorMessage: string,\r\n    context?: Record<string, any>\r\n  ): Promise<void> {\r\n    const now = new Date()\r\n    const key = `${patternId}_${Math.floor(now.getTime() / (pattern.timeWindow * 60 * 1000))}`\r\n    \r\n    const existing = this.errorCounts.get(key)\r\n    if (existing) {\r\n      existing.count++\r\n      existing.lastSeen = now\r\n    } else {\r\n      this.errorCounts.set(key, {\r\n        count: 1,\r\n        firstSeen: now,\r\n        lastSeen: now\r\n      })\r\n    }\r\n\r\n    const errorCount = this.errorCounts.get(key)!\r\n    \r\n    // Verificar si se alcanzó el umbral (solo en servidor)\r\n    if (errorCount.count >= pattern.threshold && this.alertSystem) {\r\n      await this.triggerAlert(pattern, errorCount, errorMessage, context)\r\n      \r\n      // Limpiar contador para evitar spam de alertas\r\n      this.errorCounts.delete(key)\r\n    }\r\n  }\r\n\r\n  private async triggerAlert(\r\n    pattern: ErrorPattern,\r\n    errorCount: { count: number; firstSeen: Date; lastSeen: Date },\r\n    errorMessage: string,\r\n    context?: Record<string, any>\r\n  ): Promise<void> {\r\n    const alert = {\r\n      id: `pattern_${pattern.id}_${Date.now()}`,\r\n      title: `Error Pattern Detected: ${pattern.name}`,\r\n      message: `Pattern \"${pattern.name}\" detected ${errorCount.count} times in ${pattern.timeWindow} minutes`,\r\n      severity: pattern.severity,\r\n      details: {\r\n        pattern: pattern.name,\r\n        description: pattern.description,\r\n        count: errorCount.count,\r\n        threshold: pattern.threshold,\r\n        timeWindow: pattern.timeWindow,\r\n        firstSeen: errorCount.firstSeen.toISOString(),\r\n        lastSeen: errorCount.lastSeen.toISOString(),\r\n        lastError: errorMessage,\r\n        context\r\n      }\r\n    }\r\n\r\n    // Enviar notificaciones\r\n    if (this.config.notificationChannels.includes('email')) {\r\n      await this.sendEmailAlert(alert)\r\n    }\r\n\r\n    if (this.config.notificationChannels.includes('slack')) {\r\n      await this.sendSlackAlert(alert)\r\n    }\r\n\r\n    logger.warn(LogLevel.WARN, 'Error pattern alert triggered', alert, LogCategory.SYSTEM)\r\n  }\r\n\r\n  private async sendEmailAlert(alert: any): Promise<void> {\r\n    try {\r\n      await emailService.sendNotification({\r\n        to: ['admin@example.com'], // Configurar emails de admin\r\n        subject: `🚨 ${alert.title}`,\r\n        template: 'error-pattern-alert',\r\n        data: alert,\r\n        priority: alert.severity === 'critical' ? 'high' : 'normal'\r\n      })\r\n    } catch (error) {\r\n      logger.error(LogLevel.ERROR, 'Failed to send email alert', { error }, LogCategory.SYSTEM)\r\n    }\r\n  }\r\n\r\n  private async sendSlackAlert(alert: any): Promise<void> {\r\n    try {\r\n      await slackService.sendErrorAlert({\r\n        error: alert.message,\r\n        context: alert.title,\r\n        timestamp: new Date(),\r\n        severity: alert.severity\r\n      })\r\n    } catch (error) {\r\n      logger.error(LogLevel.ERROR, 'Failed to send Slack alert', { error }, LogCategory.SYSTEM)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Realiza verificación de salud del sistema\r\n   */\r\n  private async performHealthCheck(): Promise<void> {\r\n    try {\r\n      const health = await this.getSystemHealth()\r\n      \r\n      // Verificar umbrales críticos\r\n      if (health.status === 'critical' || health.status === 'down') {\r\n        await this.handleCriticalHealth(health)\r\n      } else if (health.status === 'warning') {\r\n        await this.handleWarningHealth(health)\r\n      }\r\n\r\n      // Actualizar métricas si está disponible\r\n      if (this.metricsCollector) {\r\n        await this.metricsCollector.recordMetric('system_health_score', this.calculateHealthScore(health))\r\n        await this.metricsCollector.recordMetric('system_response_time', health.responseTime)\r\n        await this.metricsCollector.recordMetric('system_error_rate', health.errorRate)\r\n        await this.metricsCollector.recordMetric('system_memory_usage', health.memoryUsage)\r\n        await this.metricsCollector.recordMetric('system_cpu_usage', health.cpuUsage)\r\n      }\r\n\r\n    } catch (error) {\r\n      logger.error(LogLevel.ERROR, 'Health check failed', {\r\n        error: error instanceof Error ? error.message : 'Unknown error'\r\n      }, LogCategory.SYSTEM)\r\n    }\r\n  }\r\n\r\n  private async getSystemHealth(): Promise<SystemHealth> {\r\n    const issues: HealthIssue[] = []\r\n    let status: SystemHealth['status'] = 'healthy'\r\n\r\n    // Simular verificaciones de salud (en producción, estas serían verificaciones reales)\r\n    const responseTime = Math.random() * 1000 + 200 // 200-1200ms\r\n    const errorRate = Math.random() * 5 // 0-5%\r\n    const memoryUsage = Math.random() * 40 + 40 // 40-80%\r\n    const cpuUsage = Math.random() * 30 + 20 // 20-50%\r\n    const activeConnections = Math.floor(Math.random() * 100) + 50\r\n\r\n    // Verificar umbrales\r\n    if (responseTime > this.config.responseTimeThreshold) {\r\n      issues.push({\r\n        id: 'high_response_time',\r\n        type: 'performance',\r\n        severity: 'medium',\r\n        message: 'High response time detected',\r\n        details: { responseTime, threshold: this.config.responseTimeThreshold },\r\n        firstDetected: new Date(),\r\n        lastSeen: new Date(),\r\n        count: 1\r\n      })\r\n      status = 'warning'\r\n    }\r\n\r\n    if (errorRate > this.config.errorThreshold) {\r\n      issues.push({\r\n        id: 'high_error_rate',\r\n        type: 'error',\r\n        severity: 'high',\r\n        message: 'High error rate detected',\r\n        details: { errorRate, threshold: this.config.errorThreshold },\r\n        firstDetected: new Date(),\r\n        lastSeen: new Date(),\r\n        count: 1\r\n      })\r\n      status = 'critical'\r\n    }\r\n\r\n    if (memoryUsage > this.config.memoryThreshold) {\r\n      issues.push({\r\n        id: 'high_memory_usage',\r\n        type: 'resource',\r\n        severity: 'medium',\r\n        message: 'High memory usage detected',\r\n        details: { memoryUsage, threshold: this.config.memoryThreshold },\r\n        firstDetected: new Date(),\r\n        lastSeen: new Date(),\r\n        count: 1\r\n      })\r\n      if (status === 'healthy') {status = 'warning'}\r\n    }\r\n\r\n    return {\r\n      status,\r\n      uptime: typeof process !== 'undefined' && process.uptime ? process.uptime() : Date.now() / 1000,\r\n      responseTime,\r\n      errorRate,\r\n      memoryUsage,\r\n      cpuUsage,\r\n      activeConnections,\r\n      lastCheck: new Date(),\r\n      issues\r\n    }\r\n  }\r\n\r\n  private calculateHealthScore(health: SystemHealth): number {\r\n    let score = 100\r\n    \r\n    health.issues.forEach(issue => {\r\n      switch (issue.severity) {\r\n        case 'critical':\r\n          score -= 30\r\n          break\r\n        case 'high':\r\n          score -= 20\r\n          break\r\n        case 'medium':\r\n          score -= 10\r\n          break\r\n        case 'low':\r\n          score -= 5\r\n          break\r\n      }\r\n    })\r\n\r\n    return Math.max(0, score)\r\n  }\r\n\r\n  private async handleCriticalHealth(health: SystemHealth): Promise<void> {\r\n    logger.error(LogLevel.ERROR, 'Critical system health detected', { health }, LogCategory.SYSTEM)\r\n    \r\n    // Enviar alertas críticas\r\n    await this.sendSlackAlert({\r\n      title: '🚨 CRITICAL: System Health Alert',\r\n      message: 'System health is critical - immediate attention required',\r\n      severity: 'critical',\r\n      details: health\r\n    })\r\n\r\n    // Auto-recovery si está habilitado\r\n    if (this.config.enableAutoRecovery) {\r\n      await this.attemptAutoRecovery(health)\r\n    }\r\n  }\r\n\r\n  private async handleWarningHealth(health: SystemHealth): Promise<void> {\r\n    logger.warn(LogLevel.WARN, 'System health warning', { health }, LogCategory.SYSTEM)\r\n  }\r\n\r\n  private async attemptAutoRecovery(health: SystemHealth): Promise<void> {\r\n    logger.info(LogLevel.INFO, 'Attempting auto-recovery', { health }, LogCategory.SYSTEM)\r\n    \r\n    // Implementar lógica de auto-recuperación\r\n    // Por ejemplo: reiniciar servicios, limpiar cache, etc.\r\n  }\r\n\r\n  /**\r\n   * Configuración del servicio\r\n   */\r\n  updateConfig(newConfig: Partial<MonitoringConfig>): void {\r\n    this.config = { ...this.config, ...newConfig }\r\n    \r\n    if (this.config.enabled && !this.monitoringInterval) {\r\n      this.start()\r\n    } else if (!this.config.enabled && this.monitoringInterval) {\r\n      this.stop()\r\n    }\r\n  }\r\n\r\n  getConfig(): MonitoringConfig {\r\n    return { ...this.config }\r\n  }\r\n\r\n  /**\r\n   * Gestión de patrones de error\r\n   */\r\n  addErrorPattern(pattern: ErrorPattern): void {\r\n    this.errorPatterns.set(pattern.id, pattern)\r\n    logger.info(LogLevel.INFO, 'Error pattern added', { patternId: pattern.id }, LogCategory.SYSTEM)\r\n  }\r\n\r\n  removeErrorPattern(patternId: string): void {\r\n    this.errorPatterns.delete(patternId)\r\n    logger.info(LogLevel.INFO, 'Error pattern removed', { patternId }, LogCategory.SYSTEM)\r\n  }\r\n\r\n  getErrorPatterns(): ErrorPattern[] {\r\n    return Array.from(this.errorPatterns.values())\r\n  }\r\n\r\n  /**\r\n   * Obtener estadísticas de monitoreo\r\n   */\r\n  async getMonitoringStats(): Promise<{\r\n    totalErrors: number\r\n    activePatterns: number\r\n    recentAlerts: number\r\n    systemHealth: SystemHealth\r\n  }> {\r\n    const totalErrors = Array.from(this.errorCounts.values())\r\n      .reduce((sum, count) => sum + count.count, 0)\r\n    \r\n    const activePatterns = Array.from(this.errorPatterns.values())\r\n      .filter(p => p.isActive).length\r\n    \r\n    const recentAlerts = this.alertSystem ? \r\n      Array.from(this.errorCounts.values())\r\n        .filter(count => Date.now() - count.lastSeen.getTime() < 24 * 60 * 60 * 1000).length\r\n      : 0\r\n    \r\n    const systemHealth = await this.getSystemHealth()\r\n\r\n    return {\r\n      totalErrors,\r\n      activePatterns,\r\n      recentAlerts,\r\n      systemHealth\r\n    }\r\n  }\r\n}\r\n\r\n// Instancia singleton\r\nexport const proactiveMonitoring = ProactiveMonitoringService.getInstance()\r\n\r\n// Funciones de conveniencia\r\nexport const reportError = (error: Error | string, context?: Record<string, any>) =>\r\n  proactiveMonitoring.reportError(error, context)\r\n\r\nexport const startMonitoring = () => proactiveMonitoring.start()\r\nexport const stopMonitoring = () => proactiveMonitoring.stop()\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"names":["ProactiveMonitoringService","proactiveMonitoring","reportError","startMonitoring","stopMonitoring","getInstance","instance","errorPatterns","Map","errorCounts","healthChecks","monitoringInterval","window","alertSystem","EnterpriseAlertSystem","metricsCollector","EnterpriseMetricsCollector","config","enabled","checkInterval","errorThreshold","responseTimeThreshold","memoryThreshold","cpuThreshold","enableAutoRecovery","notificationChannels","initializeDefaultPatterns","defaultPatterns","id","name","pattern","severity","threshold","timeWindow","description","isActive","forEach","set","start","logger","info","LogLevel","INFO","LogCategory","SYSTEM","stop","setInterval","performHealthCheck","interval","patterns","size","clearInterval","error","context","errorMessage","Error","message","errorStack","stack","undefined","patternId","regex","RegExp","test","handlePatternMatch","recordMetric","type","ERROR","now","Date","key","Math","floor","getTime","existing","get","count","lastSeen","firstSeen","errorCount","triggerAlert","delete","alert","title","details","toISOString","lastError","includes","sendEmailAlert","sendSlackAlert","warn","WARN","emailService","sendNotification","to","subject","template","data","priority","slackService","sendErrorAlert","timestamp","health","getSystemHealth","status","handleCriticalHealth","handleWarningHealth","calculateHealthScore","responseTime","errorRate","memoryUsage","cpuUsage","issues","random","activeConnections","push","firstDetected","uptime","process","lastCheck","score","issue","max","attemptAutoRecovery","updateConfig","newConfig","getConfig","addErrorPattern","removeErrorPattern","getErrorPatterns","Array","from","values","getMonitoringStats","totalErrors","reduce","sum","activePatterns","filter","p","length","recentAlerts","systemHealth"],"mappings":"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"}