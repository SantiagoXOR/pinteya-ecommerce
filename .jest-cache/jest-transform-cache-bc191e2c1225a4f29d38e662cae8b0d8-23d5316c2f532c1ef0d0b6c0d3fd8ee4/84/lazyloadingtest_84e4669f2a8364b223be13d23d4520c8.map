{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\__tests__\\performance\\lazy-loading.test.tsx"],"sourcesContent":["// ===================================\n// PINTEYA E-COMMERCE - LAZY LOADING PERFORMANCE TEST\n// Tests para verificar que el lazy loading funciona correctamente\n// ===================================\n\nimport React from 'react'\nimport { render, screen, waitFor } from '@testing-library/react'\nimport { describe, it, expect, beforeEach, afterEach } from '@jest/globals'\nimport { jest } from '@jest/globals'\n\n// ===================================\n// MOCKS\n// ===================================\n\n// Mock de performance para medir tiempos de carga\nconst mockPerformanceNow = jest.fn()\nObject.defineProperty(global, 'performance', {\n  value: { now: mockPerformanceNow },\n  writable: true,\n})\n\n// Mock de console para capturar logs de lazy loading\nconst mockConsoleLog = jest.spyOn(console, 'log').mockImplementation(() => {})\n\n// Mock de dynamic imports\nconst mockDynamicImport = jest.fn()\njest.mock('next/dynamic', () => {\n  return (importFn: () => Promise<any>, options?: any) => {\n    const LazyComponent = React.lazy(() => {\n      mockDynamicImport()\n      return importFn()\n    })\n\n    return React.forwardRef((props: any, ref: any) => (\n      <React.Suspense fallback={options?.loading?.() || <div>Loading...</div>}>\n        <LazyComponent {...props} ref={ref} />\n      </React.Suspense>\n    ))\n  }\n})\n\n// ===================================\n// SETUP Y CLEANUP\n// ===================================\n\nbeforeEach(() => {\n  jest.clearAllMocks()\n  mockPerformanceNow.mockReturnValue(1000)\n})\n\nafterEach(() => {\n  jest.clearAllTimers()\n})\n\n// ===================================\n// TESTS DE LAZY LOADING\n// ===================================\n\ndescribe('Lazy Loading Performance Tests', () => {\n  it('debe cargar componentes admin bajo demanda', async () => {\n    jest.useFakeTimers()\n\n    // Simular tiempo de carga inicial\n    mockPerformanceNow.mockReturnValueOnce(1000)\n\n    // Importar componente lazy\n    const { LazyAdminDashboard } = await import('@/components/admin/LazyAdminDashboard')\n\n    // Renderizar componente\n    render(<LazyAdminDashboard />)\n\n    // Verificar que muestra skeleton inicialmente\n    expect(screen.getByText(/cargando/i) || screen.getAllByRole('generic').length > 0).toBeTruthy()\n\n    // Simular tiempo después de la carga\n    mockPerformanceNow.mockReturnValueOnce(1200)\n\n    // Avanzar timers para que se complete la carga\n    jest.advanceTimersByTime(1000)\n\n    // Verificar que el componente se carga\n    await waitFor(\n      () => {\n        // El componente debería estar cargado o mostrar contenido\n        expect(screen.queryByText(/cargando/i)).toBeFalsy()\n      },\n      { timeout: 3000 }\n    )\n\n    jest.useRealTimers()\n  })\n\n  it('debe mostrar skeletons apropiados durante la carga', async () => {\n    const { LazyProductList } = await import('@/components/admin/products/LazyProductComponents')\n\n    render(<LazyProductList />)\n\n    // Verificar que muestra skeleton de productos\n    const skeletonElements = screen.getAllByRole('generic')\n    expect(skeletonElements.length).toBeGreaterThan(0)\n\n    // Verificar estructura del skeleton\n    expect(screen.getByText(/filtros/i) || skeletonElements.length > 4).toBeTruthy()\n  })\n\n  it('debe manejar errores de carga gracefully', async () => {\n    // Mock de error en import dinámico\n    const originalImport = jest.requireActual('next/dynamic')\n    jest.doMock('next/dynamic', () => {\n      return () => {\n        throw new Error('Failed to load component')\n      }\n    })\n\n    try {\n      const { LazyLogisticsMap } = await import(\n        '@/components/admin/logistics/LazyLogisticsComponents'\n      )\n\n      render(<LazyLogisticsMap />)\n\n      // Verificar que muestra error boundary\n      await waitFor(() => {\n        expect(\n          screen.getByText(/error de carga/i) || screen.getByText(/error/i)\n        ).toBeInTheDocument()\n      })\n    } catch (error) {\n      // Error esperado durante el test\n      expect(error).toBeDefined()\n    }\n  })\n\n  it('debe precargar componentes cuando se solicita', async () => {\n    const { usePreloadAdminComponents } = await import('@/components/admin/LazyAdminDashboard')\n\n    // Crear componente de prueba que usa el hook\n    function TestComponent() {\n      const { preloadAdmin, preloadMonitoring } = usePreloadAdminComponents()\n\n      React.useEffect(() => {\n        preloadAdmin()\n        preloadMonitoring()\n      }, [preloadAdmin, preloadMonitoring])\n\n      return <div>Test Component</div>\n    }\n\n    render(<TestComponent />)\n\n    // Verificar que el componente se renderiza\n    expect(screen.getByText('Test Component')).toBeInTheDocument()\n\n    // Los imports dinámicos deberían haberse llamado\n    await waitFor(() => {\n      // Verificar que se intentó precargar (esto es difícil de testear directamente)\n      expect(true).toBe(true) // Placeholder - en un entorno real verificaríamos network requests\n    })\n  })\n\n  it('debe tener performance aceptable en carga de componentes', async () => {\n    const startTime = 1000\n    const endTime = 1200\n\n    mockPerformanceNow.mockReturnValueOnce(startTime).mockReturnValueOnce(endTime)\n\n    const { LazyCarrierPerformanceTable } = await import(\n      '@/components/admin/logistics/LazyLogisticsComponents'\n    )\n\n    const start = performance.now()\n    render(<LazyCarrierPerformanceTable />)\n    const end = performance.now()\n\n    // Verificar que el tiempo de render inicial es rápido (< 200ms)\n    const renderTime = end - start\n    expect(renderTime).toBeLessThan(200)\n  })\n\n  it('debe limpiar recursos correctamente al desmontar', async () => {\n    const { LazyRealTimeDashboard } = await import(\n      '@/components/admin/logistics/LazyLogisticsComponents'\n    )\n\n    const { unmount } = render(<LazyRealTimeDashboard />)\n\n    // Desmontar componente\n    unmount()\n\n    // Verificar que no hay memory leaks (esto es más conceptual en el test)\n    expect(mockConsoleLog).not.toHaveBeenCalledWith(expect.stringContaining('memory leak'))\n  })\n\n  it('debe manejar múltiples componentes lazy simultáneamente', async () => {\n    const components = await Promise.all([\n      import('@/components/admin/LazyAdminDashboard'),\n      import('@/components/admin/products/LazyProductComponents'),\n      import('@/components/admin/logistics/LazyLogisticsComponents'),\n    ])\n\n    const [{ LazyAdminDashboard }, { LazyProductList }, { LazyLogisticsMap }] = components\n\n    // Renderizar múltiples componentes lazy\n    render(\n      <div>\n        <LazyAdminDashboard />\n        <LazyProductList />\n        <LazyLogisticsMap />\n      </div>\n    )\n\n    // Verificar que todos muestran skeletons inicialmente\n    const loadingElements = screen.getAllByText(/cargando/i)\n    expect(loadingElements.length).toBeGreaterThanOrEqual(0) // Pueden ser skeletons sin texto \"cargando\"\n\n    // Verificar que no hay conflictos entre componentes\n    expect(screen.getByRole('main') || document.body).toBeInTheDocument()\n  })\n\n  it('debe optimizar bundle size con lazy loading', async () => {\n    // Este test es más conceptual - verificamos que los imports son dinámicos\n    const modulePromises = [\n      import('@/components/admin/LazyAdminDashboard'),\n      import('@/components/admin/products/LazyProductComponents'),\n      import('@/components/admin/logistics/LazyLogisticsComponents'),\n    ]\n\n    // Verificar que los imports son promesas (lazy)\n    modulePromises.forEach(modulePromise => {\n      expect(modulePromise).toBeInstanceOf(Promise)\n    })\n\n    // Verificar que se resuelven correctamente\n    const modules = await Promise.all(modulePromises)\n    modules.forEach(module => {\n      expect(module).toBeDefined()\n      expect(typeof module).toBe('object')\n    })\n  })\n\n  it('debe funcionar correctamente con Suspense boundaries', async () => {\n    const { LazyProductForm } = await import('@/components/admin/products/LazyProductComponents')\n\n    // Renderizar con Suspense personalizado\n    render(\n      <React.Suspense fallback={<div>Custom Loading...</div>}>\n        <LazyProductForm />\n      </React.Suspense>\n    )\n\n    // Verificar que muestra el fallback personalizado o el del componente\n    expect(\n      screen.getByText(/custom loading/i) ||\n        screen.getByText(/loading/i) ||\n        screen.getAllByRole('generic').length > 0\n    ).toBeTruthy()\n  })\n})\n"],"names":["mockPerformanceNow","jest","fn","Object","defineProperty","global","value","now","writable","mockConsoleLog","spyOn","console","mockImplementation","mockDynamicImport","mock","importFn","options","LazyComponent","React","lazy","forwardRef","props","ref","Suspense","fallback","loading","div","beforeEach","clearAllMocks","mockReturnValue","afterEach","clearAllTimers","describe","it","useFakeTimers","mockReturnValueOnce","LazyAdminDashboard","render","expect","screen","getByText","getAllByRole","length","toBeTruthy","advanceTimersByTime","waitFor","queryByText","toBeFalsy","timeout","useRealTimers","LazyProductList","skeletonElements","toBeGreaterThan","originalImport","requireActual","doMock","Error","LazyLogisticsMap","toBeInTheDocument","error","toBeDefined","usePreloadAdminComponents","TestComponent","preloadAdmin","preloadMonitoring","useEffect","toBe","startTime","endTime","LazyCarrierPerformanceTable","start","performance","end","renderTime","toBeLessThan","LazyRealTimeDashboard","unmount","not","toHaveBeenCalledWith","stringContaining","components","Promise","all","loadingElements","getAllByText","toBeGreaterThanOrEqual","getByRole","document","body","modulePromises","forEach","modulePromise","toBeInstanceOf","modules","module","LazyProductForm"],"mappings":"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"}