ec0b7942fd394b231bcdaa3ba8edb095
// üñºÔ∏è Enterprise Product Images API
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: Object.getOwnPropertyDescriptor(all, name).get
    });
}
_export(exports, {
    get GET () {
        return GET;
    },
    get POST () {
        return POST;
    }
});
const _server = require("next/server");
const _zod = require("zod");
const _middlewarecomposer = require("../../../../../../lib/api/middleware-composer");
const _errorhandler = require("../../../../../../lib/api/error-handler");
const _apilogger = require("../../../../../../lib/api/api-logger");
const _apiauthmiddleware = require("../../../../../../lib/auth/api-auth-middleware");
const _supabasejs = require("@supabase/supabase-js");
// Validation schemas
const ImageUploadSchema = _zod.z.object({
    file: _zod.z.any(),
    alt_text: _zod.z.string().optional(),
    is_primary: _zod.z.boolean().default(false)
});
const ImageUpdateSchema = _zod.z.object({
    alt_text: _zod.z.string().optional(),
    is_primary: _zod.z.boolean().optional(),
    display_order: _zod.z.number().int().min(0).optional()
});
const ProductParamsSchema = _zod.z.object({
    id: _zod.z.string().uuid('ID de producto inv√°lido')
});
const ImageParamsSchema = _zod.z.object({
    id: _zod.z.string().uuid('ID de producto inv√°lido'),
    imageId: _zod.z.string().uuid('ID de imagen inv√°lido')
});
// Helper function to get Supabase Storage client
function getStorageClient() {
    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
    return (0, _supabasejs.createClient)(supabaseUrl, supabaseServiceKey);
}
// Helper function to validate file
function validateImageFile(file) {
    const allowedTypes = [
        'image/jpeg',
        'image/jpg',
        'image/png',
        'image/webp'
    ];
    const maxSize = 5 * 1024 * 1024 // 5MB
    ;
    if (!allowedTypes.includes(file.type)) {
        throw new _errorhandler.ValidationError('Tipo de archivo no permitido. Use JPG, PNG o WebP');
    }
    if (file.size > maxSize) {
        throw new _errorhandler.ValidationError('El archivo es demasiado grande. M√°ximo 5MB');
    }
}
// Helper function to generate unique filename
function generateImageFilename(originalName, productId) {
    const timestamp = Date.now();
    const extension = originalName.split('.').pop();
    const cleanName = originalName.replace(/[^a-zA-Z0-9.-]/g, '_');
    return `products/${productId}/${timestamp}_${cleanName}`;
}
// Helper function to upload image to Supabase Storage
async function uploadImageToStorage(file, filename) {
    const supabase = getStorageClient();
    const { data, error } = await supabase.storage.from('product-images').upload(filename, file, {
        cacheControl: '3600',
        upsert: false
    });
    if (error) {
        throw new _errorhandler.ApiError('Error al subir imagen', 500, 'STORAGE_ERROR', error);
    }
    // Get public URL
    const { data: urlData } = supabase.storage.from('product-images').getPublicUrl(filename);
    return {
        path: data.path,
        url: urlData.publicUrl
    };
}
// Helper function to delete image from storage
async function deleteImageFromStorage(path) {
    const supabase = getStorageClient();
    const { error } = await supabase.storage.from('product-images').remove([
        path
    ]);
    if (error) {
        console.warn('Error deleting image from storage:', error);
    // Don't throw error, just log warning
    }
}
/**
 * POST /api/admin/products/[id]/images
 * Upload new image for product
 */ const postHandler = async (request, { params })=>{
    const { supabase, user } = request;
    const productId = params.id;
    // Validate params
    const paramsValidation = ProductParamsSchema.safeParse({
        id: productId
    });
    if (!paramsValidation.success) {
        throw new _errorhandler.ValidationError('ID de producto inv√°lido', paramsValidation.error.errors);
    }
    // Check if product exists
    const { data: product, error: productError } = await supabase.from('products').select('id, name').eq('id', productId).single();
    if (productError || !product) {
        throw new _errorhandler.NotFoundError('Producto');
    }
    // Parse form data
    const formData = await request.formData();
    const file = formData.get('file');
    const altText = formData.get('alt_text');
    const isPrimary = formData.get('is_primary') === 'true';
    if (!file) {
        throw new _errorhandler.ValidationError('No se proporcion√≥ archivo');
    }
    // Validate file
    validateImageFile(file);
    // Generate filename and upload
    const filename = generateImageFilename(file.name, productId);
    const uploadResult = await uploadImageToStorage(file, filename);
    // Save image record to database
    const { data: imageRecord, error: dbError } = await supabase.from('product_images').insert({
        product_id: productId,
        url: uploadResult.url,
        storage_path: uploadResult.path,
        alt_text: altText || null,
        is_primary: isPrimary,
        file_size: file.size,
        file_type: file.type,
        original_filename: file.name,
        created_at: new Date().toISOString()
    }).select().single();
    if (dbError) {
        // Clean up uploaded file if database insert fails
        await deleteImageFromStorage(uploadResult.path);
        throw new _errorhandler.ApiError('Error al guardar imagen en base de datos', 500, 'DATABASE_ERROR', dbError);
    }
    // If this is set as primary, update other images
    if (isPrimary) {
        await supabase.from('product_images').update({
            is_primary: false
        }).eq('product_id', productId).neq('id', imageRecord.id);
    }
    // Log action
    await (0, _apilogger.logAdminAction)(user.id, 'CREATE', 'product_image', imageRecord.id, null, imageRecord);
    return _server.NextResponse.json({
        data: imageRecord,
        success: true,
        message: 'Imagen subida exitosamente'
    }, {
        status: 201
    });
};
/**
 * GET /api/admin/products/[id]/images
 * Get all images for product
 */ const getHandler = async (request, { params })=>{
    const { supabase } = request;
    const productId = params.id;
    // Validate params
    const paramsValidation = ProductParamsSchema.safeParse({
        id: productId
    });
    if (!paramsValidation.success) {
        throw new _errorhandler.ValidationError('ID de producto inv√°lido', paramsValidation.error.errors);
    }
    // Get images
    const { data: images, error } = await supabase.from('product_images').select('*').eq('product_id', productId).order('display_order', {
        ascending: true
    }).order('created_at', {
        ascending: true
    });
    if (error) {
        throw new _errorhandler.ApiError('Error al obtener im√°genes', 500, 'DATABASE_ERROR', error);
    }
    return _server.NextResponse.json({
        data: images,
        success: true,
        message: 'Im√°genes obtenidas exitosamente'
    });
};
const GET = (0, _middlewarecomposer.composeMiddlewares)(_errorhandler.withErrorHandler, _apilogger.withApiLogging, (0, _apiauthmiddleware.withAdminAuth)([
    'products_read'
]))(getHandler);
const POST = (0, _middlewarecomposer.composeMiddlewares)(_errorhandler.withErrorHandler, _apilogger.withApiLogging, (0, _apiauthmiddleware.withAdminAuth)([
    'products_update'
]))(postHandler);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbWFydGlcXERlc2t0b3BcXERFU0FSUk9MTE9TV1xcQk9JTEVSUExBVFRFIEUtQ09NTUVSQ0VcXHNyY1xcYXBwXFxhcGlcXGFkbWluXFxwcm9kdWN0c1xcW2lkXVxcaW1hZ2VzXFxyb3V0ZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyDwn5a877iPIEVudGVycHJpc2UgUHJvZHVjdCBJbWFnZXMgQVBJXG5cbmltcG9ydCB7IE5leHRSZXF1ZXN0LCBOZXh0UmVzcG9uc2UgfSBmcm9tICduZXh0L3NlcnZlcidcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnXG5pbXBvcnQgeyBjb21wb3NlTWlkZGxld2FyZXMgfSBmcm9tICdAL2xpYi9hcGkvbWlkZGxld2FyZS1jb21wb3NlcidcbmltcG9ydCB7IHdpdGhFcnJvckhhbmRsZXIsIEFwaUVycm9yLCBWYWxpZGF0aW9uRXJyb3IsIE5vdEZvdW5kRXJyb3IgfSBmcm9tICdAL2xpYi9hcGkvZXJyb3ItaGFuZGxlcidcbmltcG9ydCB7IHdpdGhBcGlMb2dnaW5nLCBsb2dBZG1pbkFjdGlvbiB9IGZyb20gJ0AvbGliL2FwaS9hcGktbG9nZ2VyJ1xuaW1wb3J0IHsgd2l0aEFkbWluQXV0aCB9IGZyb20gJ0AvbGliL2F1dGgvYXBpLWF1dGgtbWlkZGxld2FyZSdcbmltcG9ydCB7IHdpdGhWYWxpZGF0aW9uIH0gZnJvbSAnQC9saWIvdmFsaWRhdGlvbi9hZG1pbi1zY2hlbWFzJ1xuaW1wb3J0IHsgY3JlYXRlQ2xpZW50IH0gZnJvbSAnQHN1cGFiYXNlL3N1cGFiYXNlLWpzJ1xuXG4vLyBWYWxpZGF0aW9uIHNjaGVtYXNcbmNvbnN0IEltYWdlVXBsb2FkU2NoZW1hID0gei5vYmplY3Qoe1xuICBmaWxlOiB6LmFueSgpLCAvLyBGaWxlIG9iamVjdFxuICBhbHRfdGV4dDogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICBpc19wcmltYXJ5OiB6LmJvb2xlYW4oKS5kZWZhdWx0KGZhbHNlKSxcbn0pXG5cbmNvbnN0IEltYWdlVXBkYXRlU2NoZW1hID0gei5vYmplY3Qoe1xuICBhbHRfdGV4dDogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICBpc19wcmltYXJ5OiB6LmJvb2xlYW4oKS5vcHRpb25hbCgpLFxuICBkaXNwbGF5X29yZGVyOiB6Lm51bWJlcigpLmludCgpLm1pbigwKS5vcHRpb25hbCgpLFxufSlcblxuY29uc3QgUHJvZHVjdFBhcmFtc1NjaGVtYSA9IHoub2JqZWN0KHtcbiAgaWQ6IHouc3RyaW5nKCkudXVpZCgnSUQgZGUgcHJvZHVjdG8gaW52w6FsaWRvJyksXG59KVxuXG5jb25zdCBJbWFnZVBhcmFtc1NjaGVtYSA9IHoub2JqZWN0KHtcbiAgaWQ6IHouc3RyaW5nKCkudXVpZCgnSUQgZGUgcHJvZHVjdG8gaW52w6FsaWRvJyksXG4gIGltYWdlSWQ6IHouc3RyaW5nKCkudXVpZCgnSUQgZGUgaW1hZ2VuIGludsOhbGlkbycpLFxufSlcblxuLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGdldCBTdXBhYmFzZSBTdG9yYWdlIGNsaWVudFxuZnVuY3Rpb24gZ2V0U3RvcmFnZUNsaWVudCgpIHtcbiAgY29uc3Qgc3VwYWJhc2VVcmwgPSBwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19TVVBBQkFTRV9VUkwhXG4gIGNvbnN0IHN1cGFiYXNlU2VydmljZUtleSA9IHByb2Nlc3MuZW52LlNVUEFCQVNFX1NFUlZJQ0VfUk9MRV9LRVkhXG5cbiAgcmV0dXJuIGNyZWF0ZUNsaWVudChzdXBhYmFzZVVybCwgc3VwYWJhc2VTZXJ2aWNlS2V5KVxufVxuXG4vLyBIZWxwZXIgZnVuY3Rpb24gdG8gdmFsaWRhdGUgZmlsZVxuZnVuY3Rpb24gdmFsaWRhdGVJbWFnZUZpbGUoZmlsZTogRmlsZSkge1xuICBjb25zdCBhbGxvd2VkVHlwZXMgPSBbJ2ltYWdlL2pwZWcnLCAnaW1hZ2UvanBnJywgJ2ltYWdlL3BuZycsICdpbWFnZS93ZWJwJ11cbiAgY29uc3QgbWF4U2l6ZSA9IDUgKiAxMDI0ICogMTAyNCAvLyA1TUJcblxuICBpZiAoIWFsbG93ZWRUeXBlcy5pbmNsdWRlcyhmaWxlLnR5cGUpKSB7XG4gICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignVGlwbyBkZSBhcmNoaXZvIG5vIHBlcm1pdGlkby4gVXNlIEpQRywgUE5HIG8gV2ViUCcpXG4gIH1cblxuICBpZiAoZmlsZS5zaXplID4gbWF4U2l6ZSkge1xuICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoJ0VsIGFyY2hpdm8gZXMgZGVtYXNpYWRvIGdyYW5kZS4gTcOheGltbyA1TUInKVxuICB9XG59XG5cbi8vIEhlbHBlciBmdW5jdGlvbiB0byBnZW5lcmF0ZSB1bmlxdWUgZmlsZW5hbWVcbmZ1bmN0aW9uIGdlbmVyYXRlSW1hZ2VGaWxlbmFtZShvcmlnaW5hbE5hbWU6IHN0cmluZywgcHJvZHVjdElkOiBzdHJpbmcpOiBzdHJpbmcge1xuICBjb25zdCB0aW1lc3RhbXAgPSBEYXRlLm5vdygpXG4gIGNvbnN0IGV4dGVuc2lvbiA9IG9yaWdpbmFsTmFtZS5zcGxpdCgnLicpLnBvcCgpXG4gIGNvbnN0IGNsZWFuTmFtZSA9IG9yaWdpbmFsTmFtZS5yZXBsYWNlKC9bXmEtekEtWjAtOS4tXS9nLCAnXycpXG4gIHJldHVybiBgcHJvZHVjdHMvJHtwcm9kdWN0SWR9LyR7dGltZXN0YW1wfV8ke2NsZWFuTmFtZX1gXG59XG5cbi8vIEhlbHBlciBmdW5jdGlvbiB0byB1cGxvYWQgaW1hZ2UgdG8gU3VwYWJhc2UgU3RvcmFnZVxuYXN5bmMgZnVuY3Rpb24gdXBsb2FkSW1hZ2VUb1N0b3JhZ2UoZmlsZTogRmlsZSwgZmlsZW5hbWU6IHN0cmluZykge1xuICBjb25zdCBzdXBhYmFzZSA9IGdldFN0b3JhZ2VDbGllbnQoKVxuXG4gIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlLnN0b3JhZ2UuZnJvbSgncHJvZHVjdC1pbWFnZXMnKS51cGxvYWQoZmlsZW5hbWUsIGZpbGUsIHtcbiAgICBjYWNoZUNvbnRyb2w6ICczNjAwJyxcbiAgICB1cHNlcnQ6IGZhbHNlLFxuICB9KVxuXG4gIGlmIChlcnJvcikge1xuICAgIHRocm93IG5ldyBBcGlFcnJvcignRXJyb3IgYWwgc3ViaXIgaW1hZ2VuJywgNTAwLCAnU1RPUkFHRV9FUlJPUicsIGVycm9yKVxuICB9XG5cbiAgLy8gR2V0IHB1YmxpYyBVUkxcbiAgY29uc3QgeyBkYXRhOiB1cmxEYXRhIH0gPSBzdXBhYmFzZS5zdG9yYWdlLmZyb20oJ3Byb2R1Y3QtaW1hZ2VzJykuZ2V0UHVibGljVXJsKGZpbGVuYW1lKVxuXG4gIHJldHVybiB7XG4gICAgcGF0aDogZGF0YS5wYXRoLFxuICAgIHVybDogdXJsRGF0YS5wdWJsaWNVcmwsXG4gIH1cbn1cblxuLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGRlbGV0ZSBpbWFnZSBmcm9tIHN0b3JhZ2VcbmFzeW5jIGZ1bmN0aW9uIGRlbGV0ZUltYWdlRnJvbVN0b3JhZ2UocGF0aDogc3RyaW5nKSB7XG4gIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3RvcmFnZUNsaWVudCgpXG5cbiAgY29uc3QgeyBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2Uuc3RvcmFnZS5mcm9tKCdwcm9kdWN0LWltYWdlcycpLnJlbW92ZShbcGF0aF0pXG5cbiAgaWYgKGVycm9yKSB7XG4gICAgY29uc29sZS53YXJuKCdFcnJvciBkZWxldGluZyBpbWFnZSBmcm9tIHN0b3JhZ2U6JywgZXJyb3IpXG4gICAgLy8gRG9uJ3QgdGhyb3cgZXJyb3IsIGp1c3QgbG9nIHdhcm5pbmdcbiAgfVxufVxuXG4vKipcbiAqIFBPU1QgL2FwaS9hZG1pbi9wcm9kdWN0cy9baWRdL2ltYWdlc1xuICogVXBsb2FkIG5ldyBpbWFnZSBmb3IgcHJvZHVjdFxuICovXG5jb25zdCBwb3N0SGFuZGxlciA9IGFzeW5jIChyZXF1ZXN0OiBOZXh0UmVxdWVzdCwgeyBwYXJhbXMgfTogeyBwYXJhbXM6IHsgaWQ6IHN0cmluZyB9IH0pID0+IHtcbiAgY29uc3QgeyBzdXBhYmFzZSwgdXNlciB9ID0gcmVxdWVzdCBhcyBhbnlcbiAgY29uc3QgcHJvZHVjdElkID0gcGFyYW1zLmlkXG5cbiAgLy8gVmFsaWRhdGUgcGFyYW1zXG4gIGNvbnN0IHBhcmFtc1ZhbGlkYXRpb24gPSBQcm9kdWN0UGFyYW1zU2NoZW1hLnNhZmVQYXJzZSh7IGlkOiBwcm9kdWN0SWQgfSlcbiAgaWYgKCFwYXJhbXNWYWxpZGF0aW9uLnN1Y2Nlc3MpIHtcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdJRCBkZSBwcm9kdWN0byBpbnbDoWxpZG8nLCBwYXJhbXNWYWxpZGF0aW9uLmVycm9yLmVycm9ycylcbiAgfVxuXG4gIC8vIENoZWNrIGlmIHByb2R1Y3QgZXhpc3RzXG4gIGNvbnN0IHsgZGF0YTogcHJvZHVjdCwgZXJyb3I6IHByb2R1Y3RFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcbiAgICAuZnJvbSgncHJvZHVjdHMnKVxuICAgIC5zZWxlY3QoJ2lkLCBuYW1lJylcbiAgICAuZXEoJ2lkJywgcHJvZHVjdElkKVxuICAgIC5zaW5nbGUoKVxuXG4gIGlmIChwcm9kdWN0RXJyb3IgfHwgIXByb2R1Y3QpIHtcbiAgICB0aHJvdyBuZXcgTm90Rm91bmRFcnJvcignUHJvZHVjdG8nKVxuICB9XG5cbiAgLy8gUGFyc2UgZm9ybSBkYXRhXG4gIGNvbnN0IGZvcm1EYXRhID0gYXdhaXQgcmVxdWVzdC5mb3JtRGF0YSgpXG4gIGNvbnN0IGZpbGUgPSBmb3JtRGF0YS5nZXQoJ2ZpbGUnKSBhcyBGaWxlXG4gIGNvbnN0IGFsdFRleHQgPSBmb3JtRGF0YS5nZXQoJ2FsdF90ZXh0JykgYXMgc3RyaW5nXG4gIGNvbnN0IGlzUHJpbWFyeSA9IGZvcm1EYXRhLmdldCgnaXNfcHJpbWFyeScpID09PSAndHJ1ZSdcblxuICBpZiAoIWZpbGUpIHtcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdObyBzZSBwcm9wb3JjaW9uw7MgYXJjaGl2bycpXG4gIH1cblxuICAvLyBWYWxpZGF0ZSBmaWxlXG4gIHZhbGlkYXRlSW1hZ2VGaWxlKGZpbGUpXG5cbiAgLy8gR2VuZXJhdGUgZmlsZW5hbWUgYW5kIHVwbG9hZFxuICBjb25zdCBmaWxlbmFtZSA9IGdlbmVyYXRlSW1hZ2VGaWxlbmFtZShmaWxlLm5hbWUsIHByb2R1Y3RJZClcbiAgY29uc3QgdXBsb2FkUmVzdWx0ID0gYXdhaXQgdXBsb2FkSW1hZ2VUb1N0b3JhZ2UoZmlsZSwgZmlsZW5hbWUpXG5cbiAgLy8gU2F2ZSBpbWFnZSByZWNvcmQgdG8gZGF0YWJhc2VcbiAgY29uc3QgeyBkYXRhOiBpbWFnZVJlY29yZCwgZXJyb3I6IGRiRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgLmZyb20oJ3Byb2R1Y3RfaW1hZ2VzJylcbiAgICAuaW5zZXJ0KHtcbiAgICAgIHByb2R1Y3RfaWQ6IHByb2R1Y3RJZCxcbiAgICAgIHVybDogdXBsb2FkUmVzdWx0LnVybCxcbiAgICAgIHN0b3JhZ2VfcGF0aDogdXBsb2FkUmVzdWx0LnBhdGgsXG4gICAgICBhbHRfdGV4dDogYWx0VGV4dCB8fCBudWxsLFxuICAgICAgaXNfcHJpbWFyeTogaXNQcmltYXJ5LFxuICAgICAgZmlsZV9zaXplOiBmaWxlLnNpemUsXG4gICAgICBmaWxlX3R5cGU6IGZpbGUudHlwZSxcbiAgICAgIG9yaWdpbmFsX2ZpbGVuYW1lOiBmaWxlLm5hbWUsXG4gICAgICBjcmVhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgfSlcbiAgICAuc2VsZWN0KClcbiAgICAuc2luZ2xlKClcblxuICBpZiAoZGJFcnJvcikge1xuICAgIC8vIENsZWFuIHVwIHVwbG9hZGVkIGZpbGUgaWYgZGF0YWJhc2UgaW5zZXJ0IGZhaWxzXG4gICAgYXdhaXQgZGVsZXRlSW1hZ2VGcm9tU3RvcmFnZSh1cGxvYWRSZXN1bHQucGF0aClcbiAgICB0aHJvdyBuZXcgQXBpRXJyb3IoJ0Vycm9yIGFsIGd1YXJkYXIgaW1hZ2VuIGVuIGJhc2UgZGUgZGF0b3MnLCA1MDAsICdEQVRBQkFTRV9FUlJPUicsIGRiRXJyb3IpXG4gIH1cblxuICAvLyBJZiB0aGlzIGlzIHNldCBhcyBwcmltYXJ5LCB1cGRhdGUgb3RoZXIgaW1hZ2VzXG4gIGlmIChpc1ByaW1hcnkpIHtcbiAgICBhd2FpdCBzdXBhYmFzZVxuICAgICAgLmZyb20oJ3Byb2R1Y3RfaW1hZ2VzJylcbiAgICAgIC51cGRhdGUoeyBpc19wcmltYXJ5OiBmYWxzZSB9KVxuICAgICAgLmVxKCdwcm9kdWN0X2lkJywgcHJvZHVjdElkKVxuICAgICAgLm5lcSgnaWQnLCBpbWFnZVJlY29yZC5pZClcbiAgfVxuXG4gIC8vIExvZyBhY3Rpb25cbiAgYXdhaXQgbG9nQWRtaW5BY3Rpb24odXNlci5pZCwgJ0NSRUFURScsICdwcm9kdWN0X2ltYWdlJywgaW1hZ2VSZWNvcmQuaWQsIG51bGwsIGltYWdlUmVjb3JkKVxuXG4gIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICB7XG4gICAgICBkYXRhOiBpbWFnZVJlY29yZCxcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBtZXNzYWdlOiAnSW1hZ2VuIHN1YmlkYSBleGl0b3NhbWVudGUnLFxuICAgIH0sXG4gICAgeyBzdGF0dXM6IDIwMSB9XG4gIClcbn1cblxuLyoqXG4gKiBHRVQgL2FwaS9hZG1pbi9wcm9kdWN0cy9baWRdL2ltYWdlc1xuICogR2V0IGFsbCBpbWFnZXMgZm9yIHByb2R1Y3RcbiAqL1xuY29uc3QgZ2V0SGFuZGxlciA9IGFzeW5jIChyZXF1ZXN0OiBOZXh0UmVxdWVzdCwgeyBwYXJhbXMgfTogeyBwYXJhbXM6IHsgaWQ6IHN0cmluZyB9IH0pID0+IHtcbiAgY29uc3QgeyBzdXBhYmFzZSB9ID0gcmVxdWVzdCBhcyBhbnlcbiAgY29uc3QgcHJvZHVjdElkID0gcGFyYW1zLmlkXG5cbiAgLy8gVmFsaWRhdGUgcGFyYW1zXG4gIGNvbnN0IHBhcmFtc1ZhbGlkYXRpb24gPSBQcm9kdWN0UGFyYW1zU2NoZW1hLnNhZmVQYXJzZSh7IGlkOiBwcm9kdWN0SWQgfSlcbiAgaWYgKCFwYXJhbXNWYWxpZGF0aW9uLnN1Y2Nlc3MpIHtcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdJRCBkZSBwcm9kdWN0byBpbnbDoWxpZG8nLCBwYXJhbXNWYWxpZGF0aW9uLmVycm9yLmVycm9ycylcbiAgfVxuXG4gIC8vIEdldCBpbWFnZXNcbiAgY29uc3QgeyBkYXRhOiBpbWFnZXMsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgIC5mcm9tKCdwcm9kdWN0X2ltYWdlcycpXG4gICAgLnNlbGVjdCgnKicpXG4gICAgLmVxKCdwcm9kdWN0X2lkJywgcHJvZHVjdElkKVxuICAgIC5vcmRlcignZGlzcGxheV9vcmRlcicsIHsgYXNjZW5kaW5nOiB0cnVlIH0pXG4gICAgLm9yZGVyKCdjcmVhdGVkX2F0JywgeyBhc2NlbmRpbmc6IHRydWUgfSlcblxuICBpZiAoZXJyb3IpIHtcbiAgICB0aHJvdyBuZXcgQXBpRXJyb3IoJ0Vycm9yIGFsIG9idGVuZXIgaW3DoWdlbmVzJywgNTAwLCAnREFUQUJBU0VfRVJST1InLCBlcnJvcilcbiAgfVxuXG4gIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7XG4gICAgZGF0YTogaW1hZ2VzLFxuICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgbWVzc2FnZTogJ0ltw6FnZW5lcyBvYnRlbmlkYXMgZXhpdG9zYW1lbnRlJyxcbiAgfSlcbn1cblxuLy8gQXBwbHkgZW50ZXJwcmlzZSBtaWRkbGV3YXJlcyBhbmQgZXhwb3J0IGhhbmRsZXJzXG5leHBvcnQgY29uc3QgR0VUID0gY29tcG9zZU1pZGRsZXdhcmVzKFxuICB3aXRoRXJyb3JIYW5kbGVyLFxuICB3aXRoQXBpTG9nZ2luZyxcbiAgd2l0aEFkbWluQXV0aChbJ3Byb2R1Y3RzX3JlYWQnXSlcbikoZ2V0SGFuZGxlcilcblxuZXhwb3J0IGNvbnN0IFBPU1QgPSBjb21wb3NlTWlkZGxld2FyZXMoXG4gIHdpdGhFcnJvckhhbmRsZXIsXG4gIHdpdGhBcGlMb2dnaW5nLFxuICB3aXRoQWRtaW5BdXRoKFsncHJvZHVjdHNfdXBkYXRlJ10pXG4pKHBvc3RIYW5kbGVyKVxuIl0sIm5hbWVzIjpbIkdFVCIsIlBPU1QiLCJJbWFnZVVwbG9hZFNjaGVtYSIsInoiLCJvYmplY3QiLCJmaWxlIiwiYW55IiwiYWx0X3RleHQiLCJzdHJpbmciLCJvcHRpb25hbCIsImlzX3ByaW1hcnkiLCJib29sZWFuIiwiZGVmYXVsdCIsIkltYWdlVXBkYXRlU2NoZW1hIiwiZGlzcGxheV9vcmRlciIsIm51bWJlciIsImludCIsIm1pbiIsIlByb2R1Y3RQYXJhbXNTY2hlbWEiLCJpZCIsInV1aWQiLCJJbWFnZVBhcmFtc1NjaGVtYSIsImltYWdlSWQiLCJnZXRTdG9yYWdlQ2xpZW50Iiwic3VwYWJhc2VVcmwiLCJwcm9jZXNzIiwiZW52IiwiTkVYVF9QVUJMSUNfU1VQQUJBU0VfVVJMIiwic3VwYWJhc2VTZXJ2aWNlS2V5IiwiU1VQQUJBU0VfU0VSVklDRV9ST0xFX0tFWSIsImNyZWF0ZUNsaWVudCIsInZhbGlkYXRlSW1hZ2VGaWxlIiwiYWxsb3dlZFR5cGVzIiwibWF4U2l6ZSIsImluY2x1ZGVzIiwidHlwZSIsIlZhbGlkYXRpb25FcnJvciIsInNpemUiLCJnZW5lcmF0ZUltYWdlRmlsZW5hbWUiLCJvcmlnaW5hbE5hbWUiLCJwcm9kdWN0SWQiLCJ0aW1lc3RhbXAiLCJEYXRlIiwibm93IiwiZXh0ZW5zaW9uIiwic3BsaXQiLCJwb3AiLCJjbGVhbk5hbWUiLCJyZXBsYWNlIiwidXBsb2FkSW1hZ2VUb1N0b3JhZ2UiLCJmaWxlbmFtZSIsInN1cGFiYXNlIiwiZGF0YSIsImVycm9yIiwic3RvcmFnZSIsImZyb20iLCJ1cGxvYWQiLCJjYWNoZUNvbnRyb2wiLCJ1cHNlcnQiLCJBcGlFcnJvciIsInVybERhdGEiLCJnZXRQdWJsaWNVcmwiLCJwYXRoIiwidXJsIiwicHVibGljVXJsIiwiZGVsZXRlSW1hZ2VGcm9tU3RvcmFnZSIsInJlbW92ZSIsImNvbnNvbGUiLCJ3YXJuIiwicG9zdEhhbmRsZXIiLCJyZXF1ZXN0IiwicGFyYW1zIiwidXNlciIsInBhcmFtc1ZhbGlkYXRpb24iLCJzYWZlUGFyc2UiLCJzdWNjZXNzIiwiZXJyb3JzIiwicHJvZHVjdCIsInByb2R1Y3RFcnJvciIsInNlbGVjdCIsImVxIiwic2luZ2xlIiwiTm90Rm91bmRFcnJvciIsImZvcm1EYXRhIiwiZ2V0IiwiYWx0VGV4dCIsImlzUHJpbWFyeSIsIm5hbWUiLCJ1cGxvYWRSZXN1bHQiLCJpbWFnZVJlY29yZCIsImRiRXJyb3IiLCJpbnNlcnQiLCJwcm9kdWN0X2lkIiwic3RvcmFnZV9wYXRoIiwiZmlsZV9zaXplIiwiZmlsZV90eXBlIiwib3JpZ2luYWxfZmlsZW5hbWUiLCJjcmVhdGVkX2F0IiwidG9JU09TdHJpbmciLCJ1cGRhdGUiLCJuZXEiLCJsb2dBZG1pbkFjdGlvbiIsIk5leHRSZXNwb25zZSIsImpzb24iLCJtZXNzYWdlIiwic3RhdHVzIiwiZ2V0SGFuZGxlciIsImltYWdlcyIsIm9yZGVyIiwiYXNjZW5kaW5nIiwiY29tcG9zZU1pZGRsZXdhcmVzIiwid2l0aEVycm9ySGFuZGxlciIsIndpdGhBcGlMb2dnaW5nIiwid2l0aEFkbWluQXV0aCJdLCJtYXBwaW5ncyI6IkFBQUEsb0NBQW9DOzs7Ozs7Ozs7Ozs7UUEwTnZCQTtlQUFBQTs7UUFNQUM7ZUFBQUE7Ozt3QkE5TjZCO3FCQUN4QjtvQ0FDaUI7OEJBQ3dDOzJCQUM1QjttQ0FDakI7NEJBRUQ7QUFFN0IscUJBQXFCO0FBQ3JCLE1BQU1DLG9CQUFvQkMsTUFBQyxDQUFDQyxNQUFNLENBQUM7SUFDakNDLE1BQU1GLE1BQUMsQ0FBQ0csR0FBRztJQUNYQyxVQUFVSixNQUFDLENBQUNLLE1BQU0sR0FBR0MsUUFBUTtJQUM3QkMsWUFBWVAsTUFBQyxDQUFDUSxPQUFPLEdBQUdDLE9BQU8sQ0FBQztBQUNsQztBQUVBLE1BQU1DLG9CQUFvQlYsTUFBQyxDQUFDQyxNQUFNLENBQUM7SUFDakNHLFVBQVVKLE1BQUMsQ0FBQ0ssTUFBTSxHQUFHQyxRQUFRO0lBQzdCQyxZQUFZUCxNQUFDLENBQUNRLE9BQU8sR0FBR0YsUUFBUTtJQUNoQ0ssZUFBZVgsTUFBQyxDQUFDWSxNQUFNLEdBQUdDLEdBQUcsR0FBR0MsR0FB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