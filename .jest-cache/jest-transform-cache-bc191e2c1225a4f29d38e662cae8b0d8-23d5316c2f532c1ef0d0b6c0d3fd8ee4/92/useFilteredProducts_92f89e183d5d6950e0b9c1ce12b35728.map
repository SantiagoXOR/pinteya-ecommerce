{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\hooks\\useFilteredProducts.ts"],"sourcesContent":["'use client'\n\nimport { useQuery } from '@tanstack/react-query'\nimport { ProductWithCategory, PaginatedResponse } from '@/types/api'\nimport { safeApiResponseJson } from '@/lib/json-utils'\n\n// ===================================\n// TIPOS PARA FILTROS DE PRODUCTOS\n// ===================================\n\nexport interface ProductFilters {\n  // Filtros básicos\n  category?: string\n  brand?: string\n  search?: string\n  priceMin?: number\n  priceMax?: number\n  hasDiscount?: boolean\n\n  // Filtros avanzados (múltiples valores)\n  categories?: string[]\n  brands?: string[]\n  paintTypes?: string[]\n\n  // Paginación y ordenamiento\n  page?: number\n  limit?: number\n  sortBy?: 'price' | 'name' | 'created_at' | 'brand'\n  sortOrder?: 'asc' | 'desc'\n}\n\n// ===================================\n// HOOK PARA PRODUCTOS FILTRADOS\n// ===================================\n\nexport const useFilteredProducts = (filters: ProductFilters = {}) => {\n  return useQuery({\n    queryKey: ['filtered-products', filters],\n    queryFn: async (): Promise<PaginatedResponse<ProductWithCategory>> => {\n      // Construir URL con parámetros\n      const searchParams = new URLSearchParams()\n\n      // Filtros básicos\n      if (filters.category) {\n        searchParams.set('category', filters.category)\n      }\n      if (filters.brand) {\n        searchParams.set('brand', filters.brand)\n      }\n      if (filters.search) {\n        searchParams.set('search', filters.search)\n      }\n      if (filters.priceMin !== undefined) {\n        searchParams.set('priceMin', filters.priceMin.toString())\n      }\n      if (filters.priceMax !== undefined) {\n        searchParams.set('priceMax', filters.priceMax.toString())\n      }\n\n      // Filtros avanzados (arrays)\n      if (filters.categories && filters.categories.length > 0) {\n        searchParams.set('categories', filters.categories.join(','))\n      }\n      if (filters.brands && filters.brands.length > 0) {\n        searchParams.set('brands', filters.brands.join(','))\n      }\n      if (filters.paintTypes && filters.paintTypes.length > 0) {\n        searchParams.set('paintTypes', filters.paintTypes.join(','))\n      }\n\n      // Filtro de descuento\n      if (filters.hasDiscount !== undefined) {\n        searchParams.set('hasDiscount', filters.hasDiscount.toString())\n      }\n\n      // Paginación y ordenamiento\n      if (filters.page) {\n        searchParams.set('page', filters.page.toString())\n      }\n      if (filters.limit) {\n        searchParams.set('limit', filters.limit.toString())\n      }\n      if (filters.sortBy) {\n        searchParams.set('sortBy', filters.sortBy)\n      }\n      if (filters.sortOrder) {\n        searchParams.set('sortOrder', filters.sortOrder)\n      }\n\n      const url = `/api/products?${searchParams.toString()}`\n\n      const response = await fetch(url)\n\n      if (!response.ok) {\n        throw new Error(`Error ${response.status}: ${response.statusText}`)\n      }\n\n      const result = await safeApiResponseJson<PaginatedResponse<ProductWithCategory>>(response)\n\n      if (!result.success) {\n        throw new Error(result.error || 'Error parsing response')\n      }\n\n      return result.data!\n    },\n    staleTime: 5 * 60 * 1000, // 5 minutos\n    gcTime: 10 * 60 * 1000, // 10 minutos\n    retry: 2,\n    retryDelay: attemptIndex => Math.min(1000 * 2 ** attemptIndex, 30000),\n    enabled: true, // Siempre habilitado, incluso sin filtros\n  })\n}\n\n// ===================================\n// HOOK PARA CONTEO DE PRODUCTOS\n// ===================================\n\nexport const useProductCount = (filters: Omit<ProductFilters, 'page' | 'limit'> = {}) => {\n  return useQuery({\n    queryKey: ['product-count', filters],\n    queryFn: async (): Promise<number> => {\n      // Usar los mismos filtros pero con limit=1 para obtener solo el count\n      const countFilters = { ...filters, page: 1, limit: 1 }\n      const searchParams = new URLSearchParams()\n\n      // Aplicar los mismos filtros que useFilteredProducts\n      if (countFilters.category) {\n        searchParams.set('category', countFilters.category)\n      }\n      if (countFilters.brand) {\n        searchParams.set('brand', countFilters.brand)\n      }\n      if (countFilters.search) {\n        searchParams.set('search', countFilters.search)\n      }\n      if (countFilters.priceMin !== undefined) {\n        searchParams.set('priceMin', countFilters.priceMin.toString())\n      }\n      if (countFilters.priceMax !== undefined) {\n        searchParams.set('priceMax', countFilters.priceMax.toString())\n      }\n\n      if (countFilters.categories && countFilters.categories.length > 0) {\n        searchParams.set('categories', countFilters.categories.join(','))\n      }\n      if (countFilters.brands && countFilters.brands.length > 0) {\n        searchParams.set('brands', countFilters.brands.join(','))\n      }\n      if (countFilters.paintTypes && countFilters.paintTypes.length > 0) {\n        searchParams.set('paintTypes', countFilters.paintTypes.join(','))\n      }\n\n      // Filtro de descuento\n      if (countFilters.hasDiscount !== undefined) {\n        searchParams.set('hasDiscount', countFilters.hasDiscount.toString())\n      }\n\n      searchParams.set('page', '1')\n      searchParams.set('limit', '1')\n\n      const url = `/api/products?${searchParams.toString()}`\n      const response = await fetch(url)\n\n      if (!response.ok) {\n        throw new Error(`Error ${response.status}: ${response.statusText}`)\n      }\n\n      const result = await safeApiResponseJson<PaginatedResponse<ProductWithCategory>>(response)\n\n      if (!result.success) {\n        throw new Error(result.error || 'Error parsing response')\n      }\n\n      const count = result.data?.pagination?.total || 0\n\n      return count\n    },\n    staleTime: 5 * 60 * 1000, // 5 minutos\n    gcTime: 10 * 60 * 1000, // 10 minutos\n    retry: 2,\n    enabled: true,\n  })\n}\n\n// ===================================\n// HOOK PARA CONTEO DINÁMICO POR CATEGORÍA\n// ===================================\n\nexport const useCategoryProductCounts = (\n  categoryIds: string[],\n  baseFilters: Omit<ProductFilters, 'categories' | 'category'> = {}\n) => {\n  return useQuery({\n    queryKey: ['category-product-counts', categoryIds, baseFilters],\n    queryFn: async (): Promise<Record<string, number>> => {\n      const counts: Record<string, number> = {}\n\n      // Obtener conteo para cada categoría individualmente\n      const promises = categoryIds.map(async categoryId => {\n        const filters = { ...baseFilters, categories: [categoryId] }\n        const searchParams = new URLSearchParams()\n\n        // IMPORTANTE: Aplicar filtro de categoría PRIMERO para evitar conflictos de parámetros\n        searchParams.set('categories', categoryId)\n\n        // Aplicar filtros base\n        if (filters.brand) {\n          searchParams.set('brand', filters.brand)\n        }\n        if (filters.search) {\n          searchParams.set('search', filters.search)\n        }\n        if (filters.priceMin !== undefined) {\n          searchParams.set('priceMin', filters.priceMin.toString())\n        }\n        if (filters.priceMax !== undefined) {\n          searchParams.set('priceMax', filters.priceMax.toString())\n        }\n        if (filters.brands && filters.brands.length > 0) {\n          searchParams.set('brands', filters.brands.join(','))\n        }\n        if (filters.paintTypes && filters.paintTypes.length > 0) {\n          searchParams.set('paintTypes', filters.paintTypes.join(','))\n        }\n\n        // Filtro de descuento\n        if (filters.hasDiscount !== undefined) {\n          searchParams.set('hasDiscount', filters.hasDiscount.toString())\n        }\n\n        // Aplicar paginación al final\n        searchParams.set('limit', '1')\n        searchParams.set('page', '1')\n\n        const url = `/api/products?${searchParams.toString()}`\n\n        const response = await fetch(url)\n\n        if (!response.ok) {\n          return { categoryId, count: 0 }\n        }\n\n        const result = await safeApiResponseJson<PaginatedResponse<ProductWithCategory>>(response)\n\n        if (!result.success) {\n          return { categoryId, count: 0 }\n        }\n\n        const count = result.data?.pagination?.total || 0\n        return { categoryId, count }\n      })\n\n      const results = await Promise.all(promises)\n\n      results.forEach(({ categoryId, count }) => {\n        counts[categoryId] = count\n      })\n\n      return counts\n    },\n    staleTime: 2 * 60 * 1000, // 2 minutos (más frecuente para conteos dinámicos)\n    gcTime: 5 * 60 * 1000, // 5 minutos\n    retry: 1,\n    enabled: categoryIds.length > 0,\n  })\n}\n\n// ===================================\n// UTILIDADES\n// ===================================\n\nexport const getActiveFiltersCount = (filters: ProductFilters): number => {\n  let count = 0\n\n  if (filters.categories && filters.categories.length > 0) {\n    count += filters.categories.length\n  }\n  if (filters.brands && filters.brands.length > 0) {\n    count += filters.brands.length\n  }\n  if (filters.paintTypes && filters.paintTypes.length > 0) {\n    count += filters.paintTypes.length\n  }\n  if (filters.priceMin !== undefined || filters.priceMax !== undefined) {\n    count += 1\n  }\n  if (filters.search) {\n    count += 1\n  }\n\n  return count\n}\n\nexport const hasActiveFilters = (filters: ProductFilters): boolean => {\n  return getActiveFiltersCount(filters) > 0\n}\n"],"names":["getActiveFiltersCount","hasActiveFilters","useCategoryProductCounts","useFilteredProducts","useProductCount","filters","useQuery","queryKey","queryFn","searchParams","URLSearchParams","category","set","brand","search","priceMin","undefined","toString","priceMax","categories","length","join","brands","paintTypes","hasDiscount","page","limit","sortBy","sortOrder","url","response","fetch","ok","Error","status","statusText","result","safeApiResponseJson","success","error","data","staleTime","gcTime","retry","retryDelay","attemptIndex","Math","min","enabled","countFilters","count","pagination","total","categoryIds","baseFilters","counts","promises","map","categoryId","results","Promise","all","forEach"],"mappings":"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"}