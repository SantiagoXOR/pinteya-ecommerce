98eae0bb4f86fcdb45411627aedfc881
// ===================================
// PINTEYA E-COMMERCE - HOOK PARA PERFIL DE USUARIO
// ===================================
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "useUserProfile", {
    enumerable: true,
    get: function() {
        return useUserProfile;
    }
});
const _react = require("react");
const _useAuth = require("./useAuth");
const _sonner = require("sonner");
const _useNotifications = require("./useNotifications");
function useUserProfile() {
    const { isSignedIn, isLoaded } = (0, _useAuth.useAuth)();
    const { notifyProfileChange, notifySecurityAlert } = (0, _useNotifications.useNotifications)();
    const [profile, setProfile] = (0, _react.useState)(null);
    const [loading, setLoading] = (0, _react.useState)(true);
    const [error, setError] = (0, _react.useState)(null);
    const fetchProfile = (0, _react.useCallback)(async ()=>{
        if (!isSignedIn || !isLoaded) {
            setLoading(false);
            return;
        }
        try {
            setLoading(true);
            setError(null);
            const response = await fetch('/api/user/profile', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            if (!response.ok) {
                throw new Error('Error al obtener el perfil');
            }
            const data = await response.json();
            if (data.success && data.user) {
                setProfile(data.user);
            } else {
                throw new Error(data.error || 'Error al cargar el perfil');
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'Error desconocido';
            setError(errorMessage);
            console.error('Error al obtener perfil:', err);
        } finally{
            setLoading(false);
        }
    }, [
        isSignedIn,
        isLoaded
    ]);
    const updateProfile = (0, _react.useCallback)(async (data)=>{
        if (!isSignedIn) {
            _sonner.toast.error('Debes estar autenticado para actualizar tu perfil');
            return false;
        }
        try {
            setLoading(true);
            setError(null);
            // Guardar valores anteriores para notificaciones
            const oldEmail = profile?.email;
            const oldPhone = profile?.phone;
            const response = await fetch('/api/user/profile', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            if (!response.ok) {
                throw new Error('Error al actualizar el perfil');
            }
            const result = await response.json();
            if (result.success && result.user) {
                setProfile(result.user);
                // Notificaciones básicas
                await notifyProfileChange('Perfil actualizado correctamente');
                // Notificaciones por email para cambios críticos
                if (data.email && data.email !== oldEmail) {
                    await notifySecurityAlert('Tu email ha sido actualizado. Revisa tu bandeja de entrada.', {
                        type: 'profile_email_changed',
                        oldValue: oldEmail,
                        newValue: data.email
                    }, {
                        toastType: 'info',
                        toastDuration: 6000
                    });
                }
                if (data.phone && data.phone !== oldPhone) {
                    await notifySecurityAlert('Tu teléfono ha sido actualizado.', {
                        type: 'profile_phone_changed',
                        oldValue: oldPhone,
                        newValue: data.phone
                    }, {
                        toastType: 'info',
                        toastDuration: 4000
                    });
                }
                return true;
            } else {
                throw new Error(result.error || 'Error al actualizar el perfil');
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'Error desconocido';
            setError(errorMessage);
            _sonner.toast.error(errorMessage);
            console.error('Error al actualizar perfil:', err);
            return false;
        } finally{
            setLoading(false);
        }
    }, [
        isSignedIn,
        profile,
        notifyProfileChange,
        notifySecurityAlert
    ]);
    const uploadAvatar = (0, _react.useCallback)(async (file)=>{
        if (!isSignedIn) {
            _sonner.toast.error('Debes estar autenticado para subir un avatar');
            return false;
        }
        try {
            setLoading(true);
            setError(null);
            const formData = new FormData();
            formData.append('avatar', file);
            const response = await fetch('/api/user/avatar', {
                method: 'POST',
                body: formData
            });
            if (!response.ok) {
                throw new Error('Error al subir el avatar');
            }
            const result = await response.json();
            if (result.success) {
                if (profile) {
                    setProfile({
                        ...profile,
                        avatar_url: result.avatar_url,
                        updated_at: new Date().toISOString()
                    });
                }
                _sonner.toast.success('Avatar actualizado correctamente');
                return true;
            } else {
                throw new Error(result.error || 'Error al subir el avatar');
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'Error desconocido';
            setError(errorMessage);
            _sonner.toast.error(errorMessage);
            console.error('Error al subir avatar:', err);
            return false;
        } finally{
            setLoading(false);
        }
    }, [
        isSignedIn,
        profile
    ]);
    const deleteAvatar = (0, _react.useCallback)(async ()=>{
        if (!isSignedIn) {
            _sonner.toast.error('Debes estar autenticado para eliminar tu avatar');
            return false;
        }
        try {
            setLoading(true);
            setError(null);
            const response = await fetch('/api/user/avatar', {
                method: 'DELETE'
            });
            if (!response.ok) {
                throw new Error('Error al eliminar el avatar');
            }
            const result = await response.json();
            if (result.success) {
                if (profile) {
                    setProfile({
                        ...profile,
                        avatar_url: undefined,
                        updated_at: new Date().toISOString()
                    });
                }
                _sonner.toast.success('Avatar eliminado correctamente');
                return true;
            } else {
                throw new Error(result.error || 'Error al eliminar el avatar');
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'Error desconocido';
            setError(errorMessage);
            _sonner.toast.error(errorMessage);
            console.error('Error al eliminar avatar:', err);
            return false;
        } finally{
            setLoading(false);
        }
    }, [
        isSignedIn,
        profile
    ]);
    const refreshProfile = (0, _react.useCallback)(async ()=>{
        await fetchProfile();
    }, [
        fetchProfile
    ]);
    (0, _react.useEffect)(()=>{
        fetchProfile();
    }, [
        fetchProfile
    ]);
    return {
        profile,
        loading,
        error,
        updateProfile,
        refreshProfile,
        uploadAvatar,
        deleteAvatar
    };
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbWFydGlcXERlc2t0b3BcXERFU0FSUk9MTE9TV1xcQk9JTEVSUExBVFRFIEUtQ09NTUVSQ0VcXHNyY1xcaG9va3NcXHVzZVVzZXJQcm9maWxlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBQSU5URVlBIEUtQ09NTUVSQ0UgLSBIT09LIFBBUkEgUEVSRklMIERFIFVTVUFSSU9cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmltcG9ydCB7IHVzZVN0YXRlLCB1c2VFZmZlY3QsIHVzZUNhbGxiYWNrIH0gZnJvbSAncmVhY3QnXG5pbXBvcnQgeyB1c2VBdXRoIH0gZnJvbSAnLi91c2VBdXRoJ1xuaW1wb3J0IHsgdG9hc3QgfSBmcm9tICdzb25uZXInXG5pbXBvcnQgeyB1c2VOb3RpZmljYXRpb25zIH0gZnJvbSAnLi91c2VOb3RpZmljYXRpb25zJ1xuXG5leHBvcnQgaW50ZXJmYWNlIFVzZXJQcm9maWxlIHtcbiAgaWQ6IHN0cmluZ1xuICBjbGVya19pZDogc3RyaW5nXG4gIG5hbWU6IHN0cmluZ1xuICBlbWFpbDogc3RyaW5nXG4gIHBob25lPzogc3RyaW5nXG4gIGF2YXRhcl91cmw/OiBzdHJpbmdcbiAgY3JlYXRlZF9hdDogc3RyaW5nXG4gIHVwZGF0ZWRfYXQ6IHN0cmluZ1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFVwZGF0ZVByb2ZpbGVEYXRhIHtcbiAgbmFtZTogc3RyaW5nXG4gIGVtYWlsOiBzdHJpbmdcbiAgcGhvbmU/OiBzdHJpbmdcbn1cblxuZXhwb3J0IGludGVyZmFjZSBVc2VVc2VyUHJvZmlsZVJldHVybiB7XG4gIHByb2ZpbGU6IFVzZXJQcm9maWxlIHwgbnVsbFxuICBsb2FkaW5nOiBib29sZWFuXG4gIGVycm9yOiBzdHJpbmcgfCBudWxsXG4gIHVwZGF0ZVByb2ZpbGU6IChkYXRhOiBVcGRhdGVQcm9maWxlRGF0YSkgPT4gUHJvbWlzZTxib29sZWFuPlxuICByZWZyZXNoUHJvZmlsZTogKCkgPT4gUHJvbWlzZTx2b2lkPlxuICB1cGxvYWRBdmF0YXI6IChmaWxlOiBGaWxlKSA9PiBQcm9taXNlPGJvb2xlYW4+XG4gIGRlbGV0ZUF2YXRhcjogKCkgPT4gUHJvbWlzZTxib29sZWFuPlxufVxuXG5leHBvcnQgZnVuY3Rpb24gdXNlVXNlclByb2ZpbGUoKTogVXNlVXNlclByb2ZpbGVSZXR1cm4ge1xuICBjb25zdCB7IGlzU2lnbmVkSW4sIGlzTG9hZGVkIH0gPSB1c2VBdXRoKClcbiAgY29uc3QgeyBub3RpZnlQcm9maWxlQ2hhbmdlLCBub3RpZnlTZWN1cml0eUFsZXJ0IH0gPSB1c2VOb3RpZmljYXRpb25zKClcbiAgY29uc3QgW3Byb2ZpbGUsIHNldFByb2ZpbGVdID0gdXNlU3RhdGU8VXNlclByb2ZpbGUgfCBudWxsPihudWxsKVxuICBjb25zdCBbbG9hZGluZywgc2V0TG9hZGluZ10gPSB1c2VTdGF0ZSh0cnVlKVxuICBjb25zdCBbZXJyb3IsIHNldEVycm9yXSA9IHVzZVN0YXRlPHN0cmluZyB8IG51bGw+KG51bGwpXG5cbiAgY29uc3QgZmV0Y2hQcm9maWxlID0gdXNlQ2FsbGJhY2soYXN5bmMgKCkgPT4ge1xuICAgIGlmICghaXNTaWduZWRJbiB8fCAhaXNMb2FkZWQpIHtcbiAgICAgIHNldExvYWRpbmcoZmFsc2UpXG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgc2V0TG9hZGluZyh0cnVlKVxuICAgICAgc2V0RXJyb3IobnVsbClcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCgnL2FwaS91c2VyL3Byb2ZpbGUnLCB7XG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICB9LFxuICAgICAgfSlcblxuICAgICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Vycm9yIGFsIG9idGVuZXIgZWwgcGVyZmlsJylcbiAgICAgIH1cblxuICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKVxuXG4gICAgICBpZiAoZGF0YS5zdWNjZXNzICYmIGRhdGEudXNlcikge1xuICAgICAgICBzZXRQcm9maWxlKGRhdGEudXNlcilcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihkYXRhLmVycm9yIHx8ICdFcnJvciBhbCBjYXJnYXIgZWwgcGVyZmlsJylcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGVyciBpbnN0YW5jZW9mIEVycm9yID8gZXJyLm1lc3NhZ2UgOiAnRXJyb3IgZGVzY29ub2NpZG8nXG4gICAgICBzZXRFcnJvcihlcnJvck1lc3NhZ2UpXG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBhbCBvYnRlbmVyIHBlcmZpbDonLCBlcnIpXG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHNldExvYWRpbmcoZmFsc2UpXG4gICAgfVxuICB9LCBbaXNTaWduZWRJbiwgaXNMb2FkZWRdKVxuXG4gIGNvbnN0IHVwZGF0ZVByb2ZpbGUgPSB1c2VDYWxsYmFjayhcbiAgICBhc3luYyAoZGF0YTogVXBkYXRlUHJvZmlsZURhdGEpOiBQcm9taXNlPGJvb2xlYW4+ID0+IHtcbiAgICAgIGlmICghaXNTaWduZWRJbikge1xuICAgICAgICB0b2FzdC5lcnJvcignRGViZXMgZXN0YXIgYXV0ZW50aWNhZG8gcGFyYSBhY3R1YWxpemFyIHR1IHBlcmZpbCcpXG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfVxuXG4gICAgICB0cnkge1xuICAgICAgICBzZXRMb2FkaW5nKHRydWUpXG4gICAgICAgIHNldEVycm9yKG51bGwpXG5cbiAgICAgICAgLy8gR3VhcmRhciB2YWxvcmVzIGFudGVyaW9yZXMgcGFyYSBub3RpZmljYWNpb25lc1xuICAgICAgICBjb25zdCBvbGRFbWFpbCA9IHByb2ZpbGU/LmVtYWlsXG4gICAgICAgIGNvbnN0IG9sZFBob25lID0gcHJvZmlsZT8ucGhvbmVcblxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKCcvYXBpL3VzZXIvcHJvZmlsZScsIHtcbiAgICAgICAgICBtZXRob2Q6ICdQVVQnLFxuICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShkYXRhKSxcbiAgICAgICAgfSlcblxuICAgICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFcnJvciBhbCBhY3R1YWxpemFyIGVsIHBlcmZpbCcpXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXNwb25zZS5qc29uKClcblxuICAgICAgICBpZiAocmVzdWx0LnN1Y2Nlc3MgJiYgcmVzdWx0LnVzZXIpIHtcbiAgICAgICAgICBzZXRQcm9maWxlKHJlc3VsdC51c2VyKVxuXG4gICAgICAgICAgLy8gTm90aWZpY2FjaW9uZXMgYsOhc2ljYXNcbiAgICAgICAgICBhd2FpdCBub3RpZnlQcm9maWxlQ2hhbmdlKCdQZXJmaWwgYWN0dWFsaXphZG8gY29ycmVjdGFtZW50ZScpXG5cbiAgICAgICAgICAvLyBOb3RpZmljYWNpb25lcyBwb3IgZW1haWwgcGFyYSBjYW1iaW9zIGNyw610aWNvc1xuICAgICAgICAgIGlmIChkYXRhLmVtYWlsICYmIGRhdGEuZW1haWwgIT09IG9sZEVtYWlsKSB7XG4gICAgICAgICAgICBhd2FpdCBub3RpZnlTZWN1cml0eUFsZXJ0KFxuICAgICAgICAgICAgICAnVHUgZW1haWwgaGEgc2lkbyBhY3R1YWxpemFkby4gUmV2aXNhIHR1IGJhbmRlamEgZGUgZW50cmFkYS4nLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgdHlwZTogJ3Byb2ZpbGVfZW1haWxfY2hhbmdlZCcsXG4gICAgICAgICAgICAgICAgb2xkVmFsdWU6IG9sZEVtYWlsLFxuICAgICAgICAgICAgICAgIG5ld1ZhbHVlOiBkYXRhLmVtYWlsLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB7IHRvYXN0VHlwZTogJ2luZm8nLCB0b2FzdER1cmF0aW9uOiA2MDAwIH1cbiAgICAgICAgICAgIClcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoZGF0YS5waG9uZSAmJiBkYXRhLnBob25lICE9PSBvbGRQaG9uZSkge1xuICAgICAgICAgICAgYXdhaXQgbm90aWZ5U2VjdXJpdHlBbGVydChcbiAgICAgICAgICAgICAgJ1R1IHRlbMOpZm9ubyBoYSBzaWRvIGFjdHVhbGl6YWRvLicsXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB0eXBlOiAncHJvZmlsZV9waG9uZV9jaGFuZ2VkJyxcbiAgICAgICAgICAgICAgICBvbGRWYWx1ZTogb2xkUGhvbmUsXG4gICAgICAgICAgICAgICAgbmV3VmFsdWU6IGRhdGEucGhvbmUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIHsgdG9hc3RUeXBlOiAnaW5mbycsIHRvYXN0RHVyYXRpb246IDQwMDAgfVxuICAgICAgICAgICAgKVxuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHJlc3VsdC5lcnJvciB8fCAnRXJyb3IgYWwgYWN0dWFsaXphciBlbCBwZXJmaWwnKVxuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIubWVzc2FnZSA6ICdFcnJvciBkZXNjb25vY2lkbydcbiAgICAgICAgc2V0RXJyb3IoZXJyb3JNZXNzYWdlKVxuICAgICAgICB0b2FzdC5lcnJvcihlcnJvck1lc3NhZ2UpXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGFsIGFjdHVhbGl6YXIgcGVyZmlsOicsIGVycilcbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9IGZpbmFsbHkge1xuICAgICAgICBzZXRMb2FkaW5nKGZhbHNlKVxuICAgICAgfVxuICAgIH0sXG4gICAgW2lzU2lnbmVkSW4sIHByb2ZpbGUsIG5vdGlmeVByb2ZpbGVDaGFuZ2UsIG5vdGlmeVNlY3VyaXR5QWxlcnRdXG4gIClcblxuICBjb25zdCB1cGxvYWRBdmF0YXIgPSB1c2VDYWxsYmFjayhcbiAgICBhc3luYyAoZmlsZTogRmlsZSk6IFByb21pc2U8Ym9vbGVhbj4gPT4ge1xuICAgICAgaWYgKCFpc1NpZ25lZEluKSB7XG4gICAgICAgIHRvYXN0LmVycm9yKCdEZWJlcyBlc3RhciBhdXRlbnRpY2FkbyBwYXJhIHN1YmlyIHVuIGF2YXRhcicpXG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfVxuXG4gICAgICB0cnkge1xuICAgICAgICBzZXRMb2FkaW5nKHRydWUpXG4gICAgICAgIHNldEVycm9yKG51bGwpXG5cbiAgICAgICAgY29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKVxuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2F2YXRhcicsIGZpbGUpXG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCgnL2FwaS91c2VyL2F2YXRhcicsIHtcbiAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICBib2R5OiBmb3JtRGF0YSxcbiAgICAgICAgfSlcblxuICAgICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFcnJvciBhbCBzdWJpciBlbCBhdmF0YXInKVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVzcG9uc2UuanNvbigpXG5cbiAgICAgICAgaWYgKHJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICAgICAgaWYgKHByb2ZpbGUpIHtcbiAgICAgICAgICAgIHNldFByb2ZpbGUoe1xuICAgICAgICAgICAgICAuLi5wcm9maWxlLFxuICAgICAgICAgICAgICBhdmF0YXJfdXJsOiByZXN1bHQuYXZhdGFyX3VybCxcbiAgICAgICAgICAgICAgdXBkYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9XG4gICAgICAgICAgdG9hc3Quc3VjY2VzcygnQXZhdGFyIGFjdHVhbGl6YWRvIGNvcnJlY3RhbWVudGUnKVxuICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHJlc3VsdC5lcnJvciB8fCAnRXJyb3IgYWwgc3ViaXIgZWwgYXZhdGFyJylcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGVyciBpbnN0YW5jZW9mIEVycm9yID8gZXJyLm1lc3NhZ2UgOiAnRXJyb3IgZGVzY29ub2NpZG8nXG4gICAgICAgIHNldEVycm9yKGVycm9yTWVzc2FnZSlcbiAgICAgICAgdG9hc3QuZXJyb3IoZXJyb3JNZXNzYWdlKVxuICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBhbCBzdWJpciBhdmF0YXI6JywgZXJyKVxuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH0gZmluYWxseSB7XG4gICAgICAgIHNldExvYWRpbmcoZmFsc2UpXG4gICAgICB9XG4gICAgfSxcbiAgICBbaXNTaWduZWRJbiwgcHJvZmlsZV1cbiAgKVxuXG4gIGNvbnN0IGRlbGV0ZUF2YXRhciA9IHVzZUNhbGxiYWNrKGFzeW5jICgpOiBQcm9taXNlPGJvb2xlYW4+ID0+IHtcbiAgICBpZiAoIWlzU2lnbmVkSW4pIHtcbiAgICAgIHRvYXN0LmVycm9yKCdEZWJlcyBlc3RhciBhdXRlbnRpY2FkbyBwYXJhIGVsaW1pbmFyIHR1IGF2YXRhcicpXG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgc2V0TG9hZGluZyh0cnVlKVxuICAgICAgc2V0RXJyb3IobnVsbClcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCgnL2FwaS91c2VyL2F2YXRhcicsIHtcbiAgICAgICAgbWV0aG9kOiAnREVMRVRFJyxcbiAgICAgIH0pXG5cbiAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFcnJvciBhbCBlbGltaW5hciBlbCBhdmF0YXInKVxuICAgICAgfVxuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXNwb25zZS5qc29uKClcblxuICAgICAgaWYgKHJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICAgIGlmIChwcm9maWxlKSB7XG4gICAgICAgICAgc2V0UHJvZmlsZSh7XG4gICAgICAgICAgICAuLi5wcm9maWxlLFxuICAgICAgICAgICAgYXZhdGFyX3VybDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgdXBkYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgICAgdG9hc3Quc3VjY2VzcygnQXZhdGFyIGVsaW1pbmFkbyBjb3JyZWN0YW1lbnRlJylcbiAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihyZXN1bHQuZXJyb3IgfHwgJ0Vycm9yIGFsIGVsaW1pbmFyIGVsIGF2YXRhcicpXG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogJ0Vycm9yIGRlc2Nvbm9jaWRvJ1xuICAgICAgc2V0RXJyb3IoZXJyb3JNZXNzYWdlKVxuICAgICAgdG9hc3QuZXJyb3IoZXJyb3JNZXNzYWdlKVxuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgYWwgZWxpbWluYXIgYXZhdGFyOicsIGVycilcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH0gZmluYWxseSB7XG4gICAgICBzZXRMb2FkaW5nKGZhbHNlKVxuICAgIH1cbiAgfSwgW2lzU2lnbmVkSW4sIHByb2ZpbGVdKVxuXG4gIGNvbnN0IHJlZnJlc2hQcm9maWxlID0gdXNlQ2FsbGJhY2soYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGZldGNoUHJvZmlsZSgpXG4gIH0sIFtmZXRjaFByb2ZpbGVdKVxuXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgZmV0Y2hQcm9maWxlKClcbiAgfSwgW2ZldGNoUHJvZmlsZV0pXG5cbiAgcmV0dXJuIHtcbiAgICBwcm9maWxlLFxuICAgIGxvYWRpbmcsXG4gICAgZXJyb3IsXG4gICAgdXBkYXRlUHJvZmlsZSxcbiAgICByZWZyZXNoUHJvZmlsZSxcbiAgICB1cGxvYWRBdmF0YXIsXG4gICAgZGVsZXRlQXZhdGFyLFxuICB9XG59XG4iXSwibmFtZXMiOlsidXNlVXNlclByb2ZpbGUiLCJpc1NpZ25lZEluIiwiaXNMb2FkZWQiLCJ1c2VBdXRoIiwibm90aWZ5UHJvZmlsZUNoYW5nZSIsIm5vdGlmeVNlY3VyaXR5QWxlcnQiLCJ1c2VOb3RpZmljYXRpb25zIiwicHJvZmlsZSIsInNldFByb2ZpbGUiLCJ1c2VTdGF0ZSIsImxvYWRpbmciLCJzZXRMb2FkaW5nIiwiZXJyb3IiLCJzZXRFcnJvciIsImZldGNoUHJvZmlsZSIsInVzZUNhbGxiYWNrIiwicmVzcG9uc2UiLCJmZXRjaCIsIm1ldGhvZCIsImhlYWRlcnMiLCJvayIsIkVycm9yIiwiZGF0YSIsImpzb24iLCJzdWNjZXNzIiwidXNlciIsImVyciIsImVycm9yTWVzc2FnZSIsIm1lc3NhZ2UiLCJjb25zb2xlIiwidXBkYXRlUHJvZmlsZSIsInRvYXN0Iiwib2xkRW1haWwiLCJlbWFpbCIsIm9sZFBob25lIiwicGhvbmUiLCJib2R5IiwiSlNPTiIsInN0cmluZ2lmeSIsInJlc3VsdCIsInR5cGUiLCJvbGRWYWx1ZSIsIm5ld1ZhbHVlIiwidG9hc3RUeXBlIiwidG9hc3REdXJhdGlvbiIsInVwbG9hZEF2YXRhciIsImZpbGUiLCJmb3JtRGF0YSIsIkZvcm1EYXRhIiwiYXBwZW5kIiwiYXZhdGFyX3VybCIsInVwZGF0ZWRfYXQiLCJEYXRlIiwidG9JU09TdHJpbmciLCJkZWxldGVBdmF0YXIiLCJ1bmRlZmluZWQiLCJyZWZyZXNoUHJvZmlsZSIsInVzZUVmZmVjdCJdLCJtYXBwaW5ncyI6IkFBQUEsc0NBQXNDO0FBQ3RDLG1EQUFtRDtBQUNuRCxzQ0FBc0M7Ozs7OytCQWtDdEJBOzs7ZUFBQUE7Ozt1QkFoQ2lDO3lCQUN6Qjt3QkFDRjtrQ0FDVztBQTZCMUIsU0FBU0E7SUFDZCxNQUFNLEVBQUVDLFVBQVUsRUFBRUMsUUFBUSxFQUFFLEdBQUdDLElBQUFBLGdCQUFPO0lBQ3hDLE1BQU0sRUFBRUMsbUJBQW1CLEVBQUVDLG1CQUFtQixFQUFFLEdBQUdDLElBQUFBLGtDQUFnQjtJQUNyRSxNQUFNLENBQUNDLFNBQVNDLFdBQVcsR0FBR0MsSUFBQUEsZUFBUSxFQUFxQjtJQUMzRCxNQUFNLENBQUNDLFNBQVNDLFdBQVcsR0FBR0YsSUFBQUEsZUFBUSxFQUFDO0lBQ3ZDLE1BQU0sQ0FBQ0csT0FBT0MsU0FBUyxHQUFHSixJQUFBQSxlQUFRLEVBQWdCO0lBRWxELE1BQU1LLGVBQWVDLElBQUFBLGtCQUFXLEVBQUM7UUFDL0IsSUFBSSxDQUFDZCxjQUFjLENBQUNDLFVBQVU7WUFDNUJTLFdBQVc7WUFDWDtRQUNGO1FBRUEsSUFBSTtZQUNGQSxXQUFXO1lBQ1hFLFNBQVM7WUFFVCxNQUFNRyxXQUFXLE1BQU1DLE1BQU0scUJBQXFCO2dCQUNoREMsUUFBUTtnQkFDUkMsU0FBUztvQkFDUCxnQkFBZ0I7Z0JBQ2xCO1lBQ0Y7WUFFQSxJQUFJLENBQUNILFNBQVNJLEVBQUUsRUFBRTtnQkFDaEIsTUFBTSxJQUFJQyxNQUFNO1lBQ2xCO1lBRUEsTUFB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