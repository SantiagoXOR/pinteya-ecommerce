{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\app\\api\\admin\\products\\[id]\\images\\route.ts"],"sourcesContent":["// üñºÔ∏è Enterprise Product Images API\r\n\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport { z } from 'zod';\r\nimport { composeMiddlewares } from '@/lib/api/middleware-composer';\r\nimport { withErrorHandler, ApiError, ValidationError, NotFoundError } from '@/lib/api/error-handler';\r\nimport { withApiLogging, logAdminAction } from '@/lib/api/api-logger';\r\nimport { withAdminAuth } from '@/lib/auth/api-auth-middleware';\r\nimport { withValidation } from '@/lib/validation/admin-schemas';\r\nimport { createClient } from '@supabase/supabase-js';\r\n\r\n// Validation schemas\r\nconst ImageUploadSchema = z.object({\r\n  file: z.any(), // File object\r\n  alt_text: z.string().optional(),\r\n  is_primary: z.boolean().default(false)\r\n});\r\n\r\nconst ImageUpdateSchema = z.object({\r\n  alt_text: z.string().optional(),\r\n  is_primary: z.boolean().optional(),\r\n  display_order: z.number().int().min(0).optional()\r\n});\r\n\r\nconst ProductParamsSchema = z.object({\r\n  id: z.string().uuid('ID de producto inv√°lido')\r\n});\r\n\r\nconst ImageParamsSchema = z.object({\r\n  id: z.string().uuid('ID de producto inv√°lido'),\r\n  imageId: z.string().uuid('ID de imagen inv√°lido')\r\n});\r\n\r\n// Helper function to get Supabase Storage client\r\nfunction getStorageClient() {\r\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\n  const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\r\n  \r\n  return createClient(supabaseUrl, supabaseServiceKey);\r\n}\r\n\r\n// Helper function to validate file\r\nfunction validateImageFile(file: File) {\r\n  const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];\r\n  const maxSize = 5 * 1024 * 1024; // 5MB\r\n\r\n  if (!allowedTypes.includes(file.type)) {\r\n    throw new ValidationError('Tipo de archivo no permitido. Use JPG, PNG o WebP');\r\n  }\r\n\r\n  if (file.size > maxSize) {\r\n    throw new ValidationError('El archivo es demasiado grande. M√°ximo 5MB');\r\n  }\r\n}\r\n\r\n// Helper function to generate unique filename\r\nfunction generateImageFilename(originalName: string, productId: string): string {\r\n  const timestamp = Date.now();\r\n  const extension = originalName.split('.').pop();\r\n  const cleanName = originalName.replace(/[^a-zA-Z0-9.-]/g, '_');\r\n  return `products/${productId}/${timestamp}_${cleanName}`;\r\n}\r\n\r\n// Helper function to upload image to Supabase Storage\r\nasync function uploadImageToStorage(file: File, filename: string) {\r\n  const supabase = getStorageClient();\r\n  \r\n  const { data, error } = await supabase.storage\r\n    .from('product-images')\r\n    .upload(filename, file, {\r\n      cacheControl: '3600',\r\n      upsert: false\r\n    });\r\n\r\n  if (error) {\r\n    throw new ApiError('Error al subir imagen', 500, 'STORAGE_ERROR', error);\r\n  }\r\n\r\n  // Get public URL\r\n  const { data: urlData } = supabase.storage\r\n    .from('product-images')\r\n    .getPublicUrl(filename);\r\n\r\n  return {\r\n    path: data.path,\r\n    url: urlData.publicUrl\r\n  };\r\n}\r\n\r\n// Helper function to delete image from storage\r\nasync function deleteImageFromStorage(path: string) {\r\n  const supabase = getStorageClient();\r\n  \r\n  const { error } = await supabase.storage\r\n    .from('product-images')\r\n    .remove([path]);\r\n\r\n  if (error) {\r\n    console.warn('Error deleting image from storage:', error);\r\n    // Don't throw error, just log warning\r\n  }\r\n}\r\n\r\n/**\r\n * POST /api/admin/products/[id]/images\r\n * Upload new image for product\r\n */\r\nconst postHandler = async (request: NextRequest, { params }: { params: { id: string } }) => {\r\n  const { supabase, user } = request as any;\r\n  const productId = params.id;\r\n\r\n  // Validate params\r\n  const paramsValidation = ProductParamsSchema.safeParse({ id: productId });\r\n  if (!paramsValidation.success) {\r\n    throw new ValidationError('ID de producto inv√°lido', paramsValidation.error.errors);\r\n  }\r\n\r\n  // Check if product exists\r\n  const { data: product, error: productError } = await supabase\r\n    .from('products')\r\n    .select('id, name')\r\n    .eq('id', productId)\r\n    .single();\r\n\r\n  if (productError || !product) {\r\n    throw new NotFoundError('Producto');\r\n  }\r\n\r\n  // Parse form data\r\n  const formData = await request.formData();\r\n  const file = formData.get('file') as File;\r\n  const altText = formData.get('alt_text') as string;\r\n  const isPrimary = formData.get('is_primary') === 'true';\r\n\r\n  if (!file) {\r\n    throw new ValidationError('No se proporcion√≥ archivo');\r\n  }\r\n\r\n  // Validate file\r\n  validateImageFile(file);\r\n\r\n  // Generate filename and upload\r\n  const filename = generateImageFilename(file.name, productId);\r\n  const uploadResult = await uploadImageToStorage(file, filename);\r\n\r\n  // Save image record to database\r\n  const { data: imageRecord, error: dbError } = await supabase\r\n    .from('product_images')\r\n    .insert({\r\n      product_id: productId,\r\n      url: uploadResult.url,\r\n      storage_path: uploadResult.path,\r\n      alt_text: altText || null,\r\n      is_primary: isPrimary,\r\n      file_size: file.size,\r\n      file_type: file.type,\r\n      original_filename: file.name,\r\n      created_at: new Date().toISOString()\r\n    })\r\n    .select()\r\n    .single();\r\n\r\n  if (dbError) {\r\n    // Clean up uploaded file if database insert fails\r\n    await deleteImageFromStorage(uploadResult.path);\r\n    throw new ApiError('Error al guardar imagen en base de datos', 500, 'DATABASE_ERROR', dbError);\r\n  }\r\n\r\n  // If this is set as primary, update other images\r\n  if (isPrimary) {\r\n    await supabase\r\n      .from('product_images')\r\n      .update({ is_primary: false })\r\n      .eq('product_id', productId)\r\n      .neq('id', imageRecord.id);\r\n  }\r\n\r\n  // Log action\r\n  await logAdminAction(user.id, 'CREATE', 'product_image', imageRecord.id, null, imageRecord);\r\n\r\n  return NextResponse.json({\r\n    data: imageRecord,\r\n    success: true,\r\n    message: 'Imagen subida exitosamente'\r\n  }, { status: 201 });\r\n};\r\n\r\n/**\r\n * GET /api/admin/products/[id]/images\r\n * Get all images for product\r\n */\r\nconst getHandler = async (request: NextRequest, { params }: { params: { id: string } }) => {\r\n  const { supabase } = request as any;\r\n  const productId = params.id;\r\n\r\n  // Validate params\r\n  const paramsValidation = ProductParamsSchema.safeParse({ id: productId });\r\n  if (!paramsValidation.success) {\r\n    throw new ValidationError('ID de producto inv√°lido', paramsValidation.error.errors);\r\n  }\r\n\r\n  // Get images\r\n  const { data: images, error } = await supabase\r\n    .from('product_images')\r\n    .select('*')\r\n    .eq('product_id', productId)\r\n    .order('display_order', { ascending: true })\r\n    .order('created_at', { ascending: true });\r\n\r\n  if (error) {\r\n    throw new ApiError('Error al obtener im√°genes', 500, 'DATABASE_ERROR', error);\r\n  }\r\n\r\n  return NextResponse.json({\r\n    data: images,\r\n    success: true,\r\n    message: 'Im√°genes obtenidas exitosamente'\r\n  });\r\n};\r\n\r\n// Apply enterprise middlewares and export handlers\r\nexport const GET = composeMiddlewares(\r\n  withErrorHandler,\r\n  withApiLogging,\r\n  withAdminAuth(['products_read'])\r\n)(getHandler);\r\n\r\nexport const POST = composeMiddlewares(\r\n  withErrorHandler,\r\n  withApiLogging,\r\n  withAdminAuth(['products_update'])\r\n)(postHandler);\r\n"],"names":["GET","POST","ImageUploadSchema","z","object","file","any","alt_text","string","optional","is_primary","boolean","default","ImageUpdateSchema","display_order","number","int","min","ProductParamsSchema","id","uuid","ImageParamsSchema","imageId","getStorageClient","supabaseUrl","process","env","NEXT_PUBLIC_SUPABASE_URL","supabaseServiceKey","SUPABASE_SERVICE_ROLE_KEY","createClient","validateImageFile","allowedTypes","maxSize","includes","type","ValidationError","size","generateImageFilename","originalName","productId","timestamp","Date","now","extension","split","pop","cleanName","replace","uploadImageToStorage","filename","supabase","data","error","storage","from","upload","cacheControl","upsert","ApiError","urlData","getPublicUrl","path","url","publicUrl","deleteImageFromStorage","remove","console","warn","postHandler","request","params","user","paramsValidation","safeParse","success","errors","product","productError","select","eq","single","NotFoundError","formData","get","altText","isPrimary","name","uploadResult","imageRecord","dbError","insert","product_id","storage_path","file_size","file_type","original_filename","created_at","toISOString","update","neq","logAdminAction","NextResponse","json","message","status","getHandler","images","order","ascending","composeMiddlewares","withErrorHandler","withApiLogging","withAdminAuth"],"mappings":"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"}