{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\hooks\\__tests__\\useGeolocation.test.ts"],"sourcesContent":["/**\r\n * Tests para el hook useGeolocation\r\n * Verifica la funcionalidad de geolocalización automática y detección de zonas\r\n */\r\n\r\nimport { renderHook, act, waitFor } from '@testing-library/react';\r\nimport { useGeolocation } from '../useGeolocation';\r\n\r\n// Mock del navigator.geolocation\r\nconst mockGeolocation = {\r\n  getCurrentPosition: jest.fn(),\r\n  watchPosition: jest.fn(),\r\n  clearWatch: jest.fn(),\r\n};\r\n\r\n// Mock del navigator.permissions\r\nconst mockPermissions = {\r\n  query: jest.fn().mockResolvedValue({ state: 'prompt' }),\r\n};\r\n\r\n// Setup global mocks\r\nObject.defineProperty(global.navigator, 'geolocation', {\r\n  value: mockGeolocation,\r\n  writable: true,\r\n});\r\n\r\nObject.defineProperty(global.navigator, 'permissions', {\r\n  value: mockPermissions,\r\n  writable: true,\r\n});\r\n\r\n// Mock console.log para evitar spam en tests\r\nconst originalConsoleLog = console.log;\r\nbeforeAll(() => {\r\n  console.log = jest.fn();\r\n});\r\n\r\nafterAll(() => {\r\n  console.log = originalConsoleLog;\r\n});\r\n\r\ndescribe('useGeolocation Hook', () => {\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n  });\r\n\r\n  describe('Estado inicial', () => {\r\n    it('debe inicializar con valores por defecto', () => {\r\n      const { result } = renderHook(() => useGeolocation());\r\n\r\n      expect(result.current.location).toBeNull();\r\n      expect(result.current.isLoading).toBe(false);\r\n      expect(result.current.error).toBeNull();\r\n      expect(result.current.permissionStatus).toBe('unknown');\r\n      expect(result.current.detectedZone).toBeNull();\r\n    });\r\n\r\n    it('debe tener las funciones necesarias', () => {\r\n      const { result } = renderHook(() => useGeolocation());\r\n\r\n      expect(typeof result.current.requestLocation).toBe('function');\r\n      expect(typeof result.current.getAvailableZones).toBe('function');\r\n      expect(typeof result.current.selectZone).toBe('function');\r\n      expect(Array.isArray(result.current.deliveryZones)).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe('Verificación de permisos', () => {\r\n    it('debe verificar permisos al montar el componente', async () => {\r\n      const mockPermissionResult = {\r\n        state: 'prompt',\r\n      };\r\n\r\n      mockPermissions.query.mockResolvedValue(mockPermissionResult);\r\n\r\n      renderHook(() => useGeolocation());\r\n\r\n      await waitFor(() => {\r\n        expect(mockPermissions.query).toHaveBeenCalledWith({ name: 'geolocation' });\r\n      });\r\n    });\r\n\r\n    it('debe solicitar ubicación automáticamente si ya tiene permisos', async () => {\r\n      const mockPermissionResult = {\r\n        state: 'granted',\r\n      };\r\n\r\n      const mockPosition = {\r\n        coords: {\r\n          latitude: -31.4201,\r\n          longitude: -64.1888,\r\n        },\r\n      };\r\n\r\n      mockPermissions.query.mockResolvedValue(mockPermissionResult);\r\n      mockGeolocation.getCurrentPosition.mockImplementation((success) => {\r\n        success(mockPosition);\r\n      });\r\n\r\n      const { result } = renderHook(() => useGeolocation());\r\n\r\n      await waitFor(() => {\r\n        expect(result.current.permissionStatus).toBe('granted');\r\n      });\r\n\r\n      // Verificar que el hook está funcionando correctamente con permisos granted\r\n      expect(result.current.error).toBeNull();\r\n    });\r\n  });\r\n\r\n  describe('Solicitud de ubicación', () => {\r\n    it('debe manejar ubicación exitosa', async () => {\r\n      const mockPosition = {\r\n        coords: {\r\n          latitude: -31.4201,\r\n          longitude: -64.1888,\r\n        },\r\n      };\r\n\r\n      mockGeolocation.getCurrentPosition.mockImplementation((success) => {\r\n        success(mockPosition);\r\n      });\r\n\r\n      const { result } = renderHook(() => useGeolocation());\r\n\r\n      act(() => {\r\n        result.current.requestLocation();\r\n      });\r\n\r\n      await waitFor(() => {\r\n        expect(result.current.location).toEqual({\r\n          lat: -31.4201,\r\n          lng: -64.1888,\r\n        });\r\n        expect(result.current.isLoading).toBe(false);\r\n        expect(result.current.permissionStatus).toBe('granted');\r\n        expect(result.current.detectedZone?.name).toBe('Córdoba Capital');\r\n      });\r\n    });\r\n\r\n    it('debe manejar error de permisos denegados', async () => {\r\n      const mockError = {\r\n        code: 1, // PERMISSION_DENIED\r\n        message: 'Permission denied',\r\n      };\r\n\r\n      mockGeolocation.getCurrentPosition.mockImplementation((success, error) => {\r\n        error(mockError);\r\n      });\r\n\r\n      const { result } = renderHook(() => useGeolocation());\r\n\r\n      act(() => {\r\n        result.current.requestLocation();\r\n      });\r\n\r\n      await waitFor(() => {\r\n        expect(result.current.error).toBe('Error al obtener ubicación');\r\n        expect(result.current.isLoading).toBe(false);\r\n        expect(result.current.permissionStatus).toBe('unknown');\r\n      });\r\n    });\r\n\r\n    it('debe manejar timeout de geolocalización', async () => {\r\n      const mockError = {\r\n        code: 3, // TIMEOUT\r\n        message: 'Timeout',\r\n      };\r\n\r\n      mockGeolocation.getCurrentPosition.mockImplementation((success, error) => {\r\n        error(mockError);\r\n      });\r\n\r\n      const { result } = renderHook(() => useGeolocation());\r\n\r\n      act(() => {\r\n        result.current.requestLocation();\r\n      });\r\n\r\n      await waitFor(() => {\r\n        expect(result.current.error).toBe('Error al obtener ubicación');\r\n        expect(result.current.isLoading).toBe(false);\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('Detección de zonas', () => {\r\n    it('debe detectar Córdoba Capital para coordenadas locales', async () => {\r\n      const mockPosition = {\r\n        coords: {\r\n          latitude: -31.4201,\r\n          longitude: -64.1888,\r\n        },\r\n      };\r\n\r\n      mockGeolocation.getCurrentPosition.mockImplementation((success) => {\r\n        success(mockPosition);\r\n      });\r\n\r\n      const { result } = renderHook(() => useGeolocation());\r\n\r\n      act(() => {\r\n        result.current.requestLocation();\r\n      });\r\n\r\n      await waitFor(() => {\r\n        expect(result.current.detectedZone?.name).toBe('Córdoba Capital');\r\n        expect(result.current.detectedZone?.available).toBe(true);\r\n      });\r\n    });\r\n\r\n    it('debe usar Interior de Córdoba como fallback', async () => {\r\n      const mockPosition = {\r\n        coords: {\r\n          latitude: -32.0000, // Fuera del radio de Córdoba Capital\r\n          longitude: -65.0000,\r\n        },\r\n      };\r\n\r\n      mockGeolocation.getCurrentPosition.mockImplementation((success) => {\r\n        success(mockPosition);\r\n      });\r\n\r\n      const { result } = renderHook(() => useGeolocation());\r\n\r\n      act(() => {\r\n        result.current.requestLocation();\r\n      });\r\n\r\n      await waitFor(() => {\r\n        expect(result.current.detectedZone?.name).toBe('Interior de Córdoba');\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('Selección manual de zona', () => {\r\n    it('debe permitir seleccionar zona manualmente', () => {\r\n      const { result } = renderHook(() => useGeolocation());\r\n\r\n      act(() => {\r\n        result.current.selectZone('buenos-aires');\r\n      });\r\n\r\n      expect(result.current.detectedZone?.name).toBe('Buenos Aires');\r\n    });\r\n\r\n    it('debe ignorar IDs de zona inválidos', () => {\r\n      const { result } = renderHook(() => useGeolocation());\r\n\r\n      act(() => {\r\n        result.current.selectZone('zona-inexistente');\r\n      });\r\n\r\n      expect(result.current.detectedZone).toBeNull();\r\n    });\r\n  });\r\n\r\n  describe('Zonas disponibles', () => {\r\n    it('debe retornar todas las zonas de entrega', () => {\r\n      const { result } = renderHook(() => useGeolocation());\r\n\r\n      const zones = result.current.getAvailableZones();\r\n\r\n      expect(zones).toHaveLength(4);\r\n      expect(zones.map(z => z.name)).toContain('Córdoba Capital');\r\n      expect(zones.map(z => z.name)).toContain('Interior de Córdoba');\r\n      expect(zones.map(z => z.name)).toContain('Buenos Aires');\r\n      expect(zones.map(z => z.name)).toContain('Rosario');\r\n    });\r\n  });\r\n\r\n  describe('Navegador sin soporte', () => {\r\n    it('debe manejar navegador sin geolocalización', () => {\r\n      // Temporalmente remover geolocation\r\n      const originalGeolocation = global.navigator.geolocation;\r\n      Object.defineProperty(global.navigator, 'geolocation', {\r\n        value: undefined,\r\n        writable: true,\r\n      });\r\n\r\n      const { result } = renderHook(() => useGeolocation());\r\n\r\n      act(() => {\r\n        result.current.requestLocation();\r\n      });\r\n\r\n      expect(result.current.error).toBe('Geolocalización no soportada por este navegador');\r\n      expect(result.current.permissionStatus).toBe('denied');\r\n\r\n      // Restaurar geolocation\r\n      Object.defineProperty(global.navigator, 'geolocation', {\r\n        value: originalGeolocation,\r\n        writable: true,\r\n      });\r\n    });\r\n  });\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"names":["mockGeolocation","getCurrentPosition","jest","fn","watchPosition","clearWatch","mockPermissions","query","mockResolvedValue","state","Object","defineProperty","global","navigator","value","writable","originalConsoleLog","console","log","beforeAll","afterAll","describe","beforeEach","clearAllMocks","it","result","renderHook","useGeolocation","expect","current","location","toBeNull","isLoading","toBe","error","permissionStatus","detectedZone","requestLocation","getAvailableZones","selectZone","Array","isArray","deliveryZones","mockPermissionResult","waitFor","toHaveBeenCalledWith","name","mockPosition","coords","latitude","longitude","mockImplementation","success","act","toEqual","lat","lng","mockError","code","message","available","zones","toHaveLength","map","z","toContain","originalGeolocation","geolocation","undefined"],"mappings":"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"}