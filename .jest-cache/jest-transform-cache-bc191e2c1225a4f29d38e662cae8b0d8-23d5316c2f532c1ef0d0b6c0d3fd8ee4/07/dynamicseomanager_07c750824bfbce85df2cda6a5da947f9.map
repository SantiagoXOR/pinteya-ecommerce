{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\lib\\seo\\dynamic-seo-manager.ts"],"sourcesContent":["// ===================================\r\n// PINTEYA E-COMMERCE - DYNAMIC SEO MANAGER - ENHANCED\r\n// Sistema de gestión dinámica de SEO para productos, categorías y páginas\r\n// Versión mejorada con templates, cache y análisis automático\r\n// ===================================\r\n\r\nimport type { Metadata } from 'next';\r\nimport { generateProductSEOText, generateCategorySEOText } from './dynamic-seo-text';\r\nimport { logger, LogCategory, LogLevel } from '@/lib/enterprise/logger';\r\nimport { getRedisClient } from '@/lib/integrations/redis';\r\n\r\n// ===================================\r\n// INTERFACES Y TIPOS MEJORADOS\r\n// ===================================\r\n\r\n// Configuración SEO mejorada\r\nexport interface SEOConfig {\r\n  title: string;\r\n  description: string;\r\n  keywords: string[];\r\n  canonical?: string;\r\n  noindex?: boolean;\r\n  nofollow?: boolean;\r\n  ogImage?: string;\r\n  ogType?: string;\r\n  twitterCard?: 'summary' | 'summary_large_image' | 'app' | 'player';\r\n  structuredData?: object[];\r\n}\r\n\r\n// Template SEO para generación dinámica\r\nexport interface SEOTemplate {\r\n  id: string;\r\n  name: string;\r\n  type: 'product' | 'category' | 'page' | 'blog' | 'custom';\r\n  titleTemplate: string;\r\n  descriptionTemplate: string;\r\n  keywordsTemplate: string[];\r\n  robotsDirective?: string;\r\n  priority: number;\r\n  isActive: boolean;\r\n  variables: string[];\r\n  conditions?: SEOCondition[];\r\n}\r\n\r\n// Condiciones para aplicar templates\r\nexport interface SEOCondition {\r\n  field: string;\r\n  operator: 'equals' | 'contains' | 'startsWith' | 'endsWith' | 'greaterThan' | 'lessThan';\r\n  value: any;\r\n}\r\n\r\n// Análisis SEO\r\nexport interface SEOAnalysis {\r\n  score: number;\r\n  issues: SEOIssue[];\r\n  recommendations: SEORecommendation[];\r\n  metrics: {\r\n    titleLength: number;\r\n    descriptionLength: number;\r\n    keywordDensity: number;\r\n    readabilityScore: number;\r\n    imageOptimization: number;\r\n  };\r\n}\r\n\r\n// Problemas SEO detectados\r\nexport interface SEOIssue {\r\n  type: 'error' | 'warning' | 'info';\r\n  category: 'title' | 'description' | 'keywords' | 'images' | 'structure' | 'performance';\r\n  message: string;\r\n  impact: 'high' | 'medium' | 'low';\r\n  fix?: string;\r\n}\r\n\r\n// Recomendaciones SEO\r\nexport interface SEORecommendation {\r\n  category: string;\r\n  message: string;\r\n  priority: 'high' | 'medium' | 'low';\r\n  implementation: string;\r\n}\r\n\r\n// Configuración global del sistema SEO\r\nexport interface DynamicSEOConfig {\r\n  defaultLanguage: string;\r\n  supportedLanguages: string[];\r\n  baseUrl: string;\r\n  siteName: string;\r\n  defaultImage: string;\r\n  twitterHandle: string;\r\n  facebookAppId?: string;\r\n  enableAutoGeneration: boolean;\r\n  enableAnalytics: boolean;\r\n  cacheEnabled: boolean;\r\n  cacheTTL: number;\r\n}\r\n\r\n// ===================================\r\n// CONFIGURACIÓN POR DEFECTO\r\n// ===================================\r\n\r\nconst DEFAULT_SEO_CONFIG: DynamicSEOConfig = {\r\n  defaultLanguage: 'es',\r\n  supportedLanguages: ['es', 'en'],\r\n  baseUrl: process.env.NEXT_PUBLIC_APP_URL || 'https://pinteya.com',\r\n  siteName: 'Pinteya E-commerce',\r\n  defaultImage: '/images/og-default.jpg',\r\n  twitterHandle: '@pinteya',\r\n  enableAutoGeneration: true,\r\n  enableAnalytics: true,\r\n  cacheEnabled: true,\r\n  cacheTTL: 3600 // 1 hora\r\n};\r\n\r\nconst DEFAULT_TEMPLATES: SEOTemplate[] = [\r\n  {\r\n    id: 'product-default',\r\n    name: 'Producto por Defecto',\r\n    type: 'product',\r\n    titleTemplate: '{productName} - {categoryName} | {siteName}',\r\n    descriptionTemplate: 'Compra {productName} en {siteName}. {productDescription} Precio: ${productPrice}. Envío gratis.',\r\n    keywordsTemplate: ['{productName}', '{categoryName}', 'comprar', 'precio', '{siteName}'],\r\n    robotsDirective: 'index,follow',\r\n    priority: 1,\r\n    isActive: true,\r\n    variables: ['productName', 'categoryName', 'productDescription', 'productPrice', 'siteName']\r\n  },\r\n  {\r\n    id: 'category-default',\r\n    name: 'Categoría por Defecto',\r\n    type: 'category',\r\n    titleTemplate: '{categoryName} - Productos de Calidad | {siteName}',\r\n    descriptionTemplate: 'Descubre nuestra selección de {categoryName} en {siteName}. {productCount} productos disponibles con envío gratis.',\r\n    keywordsTemplate: ['{categoryName}', 'productos', 'comprar', '{siteName}'],\r\n    robotsDirective: 'index,follow',\r\n    priority: 1,\r\n    isActive: true,\r\n    variables: ['categoryName', 'productCount', 'siteName']\r\n  },\r\n  {\r\n    id: 'page-default',\r\n    name: 'Página por Defecto',\r\n    type: 'page',\r\n    titleTemplate: '{pageTitle} | {siteName}',\r\n    descriptionTemplate: '{pageDescription}',\r\n    keywordsTemplate: ['{pageKeywords}'],\r\n    robotsDirective: 'index,follow',\r\n    priority: 1,\r\n    isActive: true,\r\n    variables: ['pageTitle', 'pageDescription', 'pageKeywords', 'siteName']\r\n  }\r\n];\r\n\r\nexport interface ProductSEOData {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  price: number;\r\n  currency: string;\r\n  brand: string;\r\n  category: string;\r\n  subcategory?: string;\r\n  images: string[];\r\n  availability: 'InStock' | 'OutOfStock' | 'PreOrder';\r\n  condition: 'NewCondition' | 'UsedCondition' | 'RefurbishedCondition';\r\n  sku?: string;\r\n  gtin?: string;\r\n  mpn?: string;\r\n  slug: string;\r\n}\r\n\r\nexport interface CategorySEOData {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  slug: string;\r\n  parentCategory?: string;\r\n  productCount: number;\r\n  image?: string;\r\n  subcategories?: string[];\r\n}\r\n\r\nexport interface PageSEOData {\r\n  path: string;\r\n  title: string;\r\n  description: string;\r\n  type: 'page' | 'article' | 'product' | 'category' | 'checkout' | 'profile';\r\n  lastModified?: Date;\r\n  priority?: number;\r\n  changeFreq?: 'always' | 'hourly' | 'daily' | 'weekly' | 'monthly' | 'yearly' | 'never';\r\n}\r\n\r\n// ===================================\r\n// ENHANCED DYNAMIC SEO MANAGER CLASS\r\n// ===================================\r\n\r\nexport class EnhancedDynamicSEOManager {\r\n  private static instance: EnhancedDynamicSEOManager;\r\n  private config: DynamicSEOConfig;\r\n  private templates: Map<string, SEOTemplate>;\r\n  private cache: Map<string, { metadata: SEOConfig; timestamp: number }>;\r\n  private redis: any;\r\n\r\n  private constructor(config?: Partial<DynamicSEOConfig>) {\r\n    this.config = { ...DEFAULT_SEO_CONFIG, ...config };\r\n    this.templates = new Map();\r\n    this.cache = new Map();\r\n\r\n    // Cargar templates por defecto\r\n    DEFAULT_TEMPLATES.forEach(template => {\r\n      this.templates.set(template.id, template);\r\n    });\r\n\r\n    // Inicializar Redis si está disponible\r\n    this.initializeRedis();\r\n\r\n    logger.info(LogLevel.INFO, 'Enhanced Dynamic SEO Manager initialized', {\r\n      templatesCount: this.templates.size,\r\n      cacheEnabled: this.config.cacheEnabled\r\n    }, LogCategory.SEO);\r\n  }\r\n\r\n  public static getInstance(config?: Partial<DynamicSEOConfig>): EnhancedDynamicSEOManager {\r\n    if (!EnhancedDynamicSEOManager.instance) {\r\n      EnhancedDynamicSEOManager.instance = new EnhancedDynamicSEOManager(config);\r\n    }\r\n    return EnhancedDynamicSEOManager.instance;\r\n  }\r\n\r\n  private async initializeRedis(): Promise<void> {\r\n    try {\r\n      this.redis = await getRedisClient();\r\n      logger.info(LogLevel.INFO, 'Redis initialized for SEO caching', {}, LogCategory.SEO);\r\n    } catch (error) {\r\n      logger.warn(LogLevel.WARN, 'Redis not available, using memory cache only', {}, LogCategory.SEO);\r\n    }\r\n  }\r\n\r\n  // ===================================\r\n  // GESTIÓN DE TEMPLATES\r\n  // ===================================\r\n\r\n  public addTemplate(template: SEOTemplate): void {\r\n    this.templates.set(template.id, template);\r\n\r\n    logger.info(LogLevel.INFO, 'SEO template added', {\r\n      templateId: template.id,\r\n      type: template.type,\r\n      priority: template.priority\r\n    }, LogCategory.SEO);\r\n  }\r\n\r\n  public updateTemplate(templateId: string, updates: Partial<SEOTemplate>): boolean {\r\n    const template = this.templates.get(templateId);\r\n    if (!template) {\r\n      logger.warn(LogLevel.WARN, 'SEO template not found for update', {\r\n        templateId\r\n      }, LogCategory.SEO);\r\n      return false;\r\n    }\r\n\r\n    const updatedTemplate = { ...template, ...updates };\r\n    this.templates.set(templateId, updatedTemplate);\r\n\r\n    // Limpiar cache relacionado\r\n    this.clearCacheByType(template.type);\r\n\r\n    logger.info(LogLevel.INFO, 'SEO template updated', {\r\n      templateId,\r\n      changes: Object.keys(updates)\r\n    }, LogCategory.SEO);\r\n\r\n    return true;\r\n  }\r\n\r\n  public getTemplatesByType(type: SEOTemplate['type']): SEOTemplate[] {\r\n    return Array.from(this.templates.values())\r\n      .filter(template => template.type === type && template.isActive)\r\n      .sort((a, b) => b.priority - a.priority);\r\n  }\r\n\r\n  // ===================================\r\n  // GENERACIÓN DE METADATA MEJORADA\r\n  // ===================================\r\n\r\n  public async generateMetadata(\r\n    type: SEOTemplate['type'],\r\n    data: Record<string, any>,\r\n    options?: {\r\n      templateId?: string;\r\n      language?: string;\r\n      customTemplate?: Partial<SEOTemplate>;\r\n    }\r\n  ): Promise<SEOConfig> {\r\n    const cacheKey = this.generateCacheKey(type, data, options);\r\n\r\n    // Verificar cache\r\n    if (this.config.cacheEnabled) {\r\n      const cached = await this.getCachedMetadata(cacheKey);\r\n      if (cached) {\r\n        return cached;\r\n      }\r\n    }\r\n\r\n    try {\r\n      // Seleccionar template\r\n      const template = this.selectTemplate(type, data, options);\r\n\r\n      if (!template) {\r\n        throw new Error(`No template found for type: ${type}`);\r\n      }\r\n\r\n      // Generar metadata\r\n      const metadata = await this.processTemplate(template, data, options);\r\n\r\n      // Cachear resultado\r\n      if (this.config.cacheEnabled) {\r\n        await this.setCachedMetadata(cacheKey, metadata);\r\n      }\r\n\r\n      logger.info(LogLevel.INFO, 'SEO metadata generated', {\r\n        type,\r\n        templateId: template.id,\r\n        cacheKey,\r\n        titleLength: metadata.title.length,\r\n        descriptionLength: metadata.description.length\r\n      }, LogCategory.SEO);\r\n\r\n      return metadata;\r\n\r\n    } catch (error) {\r\n      logger.error(LogLevel.ERROR, 'Failed to generate SEO metadata', error as Error, LogCategory.SEO);\r\n\r\n      // Fallback a metadata básica\r\n      return this.generateFallbackMetadata(type, data);\r\n    }\r\n  }\r\n\r\n  private selectTemplate(\r\n    type: SEOTemplate['type'],\r\n    data: Record<string, any>,\r\n    options?: { templateId?: string; customTemplate?: Partial<SEOTemplate> }\r\n  ): SEOTemplate | null {\r\n    // Template personalizado\r\n    if (options?.customTemplate) {\r\n      return {\r\n        id: 'custom',\r\n        name: 'Custom Template',\r\n        type,\r\n        priority: 999,\r\n        isActive: true,\r\n        variables: [],\r\n        titleTemplate: '',\r\n        descriptionTemplate: '',\r\n        keywordsTemplate: [],\r\n        ...options.customTemplate\r\n      } as SEOTemplate;\r\n    }\r\n\r\n    // Template específico\r\n    if (options?.templateId) {\r\n      const template = this.templates.get(options.templateId);\r\n      if (template && template.isActive) {\r\n        return template;\r\n      }\r\n    }\r\n\r\n    // Buscar template por tipo y condiciones\r\n    const candidates = this.getTemplatesByType(type);\r\n\r\n    for (const template of candidates) {\r\n      if (this.evaluateConditions(template, data)) {\r\n        return template;\r\n      }\r\n    }\r\n\r\n    return candidates[0] || null;\r\n  }\r\n\r\n  private evaluateConditions(template: SEOTemplate, data: Record<string, any>): boolean {\r\n    if (!template.conditions || template.conditions.length === 0) {\r\n      return true;\r\n    }\r\n\r\n    return template.conditions.every(condition => {\r\n      const value = this.getNestedValue(data, condition.field);\r\n\r\n      switch (condition.operator) {\r\n        case 'equals':\r\n          return value === condition.value;\r\n        case 'contains':\r\n          return String(value).includes(String(condition.value));\r\n        case 'startsWith':\r\n          return String(value).startsWith(String(condition.value));\r\n        case 'endsWith':\r\n          return String(value).endsWith(String(condition.value));\r\n        case 'greaterThan':\r\n          return Number(value) > Number(condition.value);\r\n        case 'lessThan':\r\n          return Number(value) < Number(condition.value);\r\n        default:\r\n          return true;\r\n      }\r\n    });\r\n  }\r\n\r\n  private async processTemplate(\r\n    template: SEOTemplate,\r\n    data: Record<string, any>,\r\n    options?: { language?: string }\r\n  ): Promise<SEOConfig> {\r\n    const language = options?.language || this.config.defaultLanguage;\r\n    const processedData = this.enrichData(data, language);\r\n\r\n    // Procesar title\r\n    const title = this.processTemplateString(template.titleTemplate, processedData);\r\n\r\n    // Procesar description\r\n    const description = this.processTemplateString(template.descriptionTemplate, processedData);\r\n\r\n    // Procesar keywords\r\n    const keywords = template.keywordsTemplate.map(keyword =>\r\n      this.processTemplateString(keyword, processedData)\r\n    ).filter(Boolean);\r\n\r\n    // Generar URL canónica\r\n    const canonical = this.generateCanonicalUrl(data, language);\r\n\r\n    // Generar structured data\r\n    const structuredData = await this.generateStructuredData(template.type, processedData);\r\n\r\n    return {\r\n      title: this.optimizeTitle(title),\r\n      description: this.optimizeDescription(description),\r\n      keywords: this.optimizeKeywords(keywords),\r\n      canonical,\r\n      ogImage: data.image || this.config.defaultImage,\r\n      ogType: this.getOGType(template.type),\r\n      twitterCard: 'summary_large_image',\r\n      structuredData: structuredData ? [structuredData] : undefined,\r\n      noindex: template.robotsDirective?.includes('noindex') || false,\r\n      nofollow: template.robotsDirective?.includes('nofollow') || false\r\n    };\r\n  }\r\n\r\n  private processTemplateString(template: string, data: Record<string, any>): string {\r\n    return template.replace(/\\{([^}]+)\\}/g, (match, key) => {\r\n      const value = this.getNestedValue(data, key);\r\n      return value !== undefined ? String(value) : match;\r\n    });\r\n  }\r\n\r\n  private enrichData(data: Record<string, any>, language: string): Record<string, any> {\r\n    return {\r\n      ...data,\r\n      siteName: this.config.siteName,\r\n      baseUrl: this.config.baseUrl,\r\n      language,\r\n      currentDate: new Date().toISOString().split('T')[0],\r\n      currentYear: new Date().getFullYear()\r\n    };\r\n  }\r\n\r\n  private getNestedValue(obj: Record<string, any>, path: string): any {\r\n    return path.split('.').reduce((current, key) => current?.[key], obj);\r\n  }\r\n\r\n  // ===================================\r\n  // OPTIMIZACIÓN DE METADATA\r\n  // ===================================\r\n\r\n  private optimizeTitle(title: string): string {\r\n    // Límite recomendado: 60 caracteres\r\n    if (title.length <= 60) {\r\n      return title;\r\n    }\r\n\r\n    // Truncar en palabra completa\r\n    const truncated = title.substring(0, 57);\r\n    const lastSpace = truncated.lastIndexOf(' ');\r\n\r\n    return lastSpace > 40 ? truncated.substring(0, lastSpace) + '...' : truncated + '...';\r\n  }\r\n\r\n  private optimizeDescription(description: string): string {\r\n    // Límite recomendado: 160 caracteres\r\n    if (description.length <= 160) {\r\n      return description;\r\n    }\r\n\r\n    // Truncar en palabra completa\r\n    const truncated = description.substring(0, 157);\r\n    const lastSpace = truncated.lastIndexOf(' ');\r\n\r\n    return lastSpace > 140 ? truncated.substring(0, lastSpace) + '...' : truncated + '...';\r\n  }\r\n\r\n  private optimizeKeywords(keywords: string[]): string[] {\r\n    // Filtrar keywords vacías y duplicadas\r\n    const unique = [...new Set(keywords.filter(Boolean))];\r\n\r\n    // Límite recomendado: 10 keywords\r\n    return unique.slice(0, 10);\r\n  }\r\n\r\n  // ===================================\r\n  // UTILIDADES\r\n  // ===================================\r\n\r\n  private generateCanonicalUrl(data: Record<string, any>, language: string): string {\r\n    const baseUrl = this.config.baseUrl;\r\n    const path = data.path || data.slug || '';\r\n    const langPrefix = language !== this.config.defaultLanguage ? `/${language}` : '';\r\n\r\n    return `${baseUrl}${langPrefix}${path}`;\r\n  }\r\n\r\n  private getOGType(type: SEOTemplate['type']): string {\r\n    switch (type) {\r\n      case 'product':\r\n        return 'product';\r\n      case 'blog':\r\n        return 'article';\r\n      default:\r\n        return 'website';\r\n    }\r\n  }\r\n\r\n  private async generateStructuredData(type: SEOTemplate['type'], data: Record<string, any>): Promise<any> {\r\n    switch (type) {\r\n      case 'product':\r\n        return this.generateProductStructuredData(data);\r\n      case 'category':\r\n        return this.generateCategoryStructuredData(data);\r\n      case 'blog':\r\n        return this.generateArticleStructuredData(data);\r\n      default:\r\n        return this.generateWebsiteStructuredData(data);\r\n    }\r\n  }\r\n\r\n  private generateProductStructuredData(data: Record<string, any>): any {\r\n    return {\r\n      '@context': 'https://schema.org',\r\n      '@type': 'Product',\r\n      name: data.productName || data.name,\r\n      description: data.productDescription || data.description,\r\n      image: data.image || this.config.defaultImage,\r\n      brand: {\r\n        '@type': 'Brand',\r\n        name: this.config.siteName\r\n      },\r\n      offers: {\r\n        '@type': 'Offer',\r\n        price: data.productPrice || data.price,\r\n        priceCurrency: 'ARS',\r\n        availability: data.stock > 0 ? 'https://schema.org/InStock' : 'https://schema.org/OutOfStock',\r\n        seller: {\r\n          '@type': 'Organization',\r\n          name: this.config.siteName\r\n        }\r\n      }\r\n    };\r\n  }\r\n\r\n  private generateCategoryStructuredData(data: Record<string, any>): any {\r\n    return {\r\n      '@context': 'https://schema.org',\r\n      '@type': 'CollectionPage',\r\n      name: data.categoryName || data.name,\r\n      description: data.categoryDescription || data.description,\r\n      url: this.generateCanonicalUrl(data, this.config.defaultLanguage)\r\n    };\r\n  }\r\n\r\n  private generateArticleStructuredData(data: Record<string, any>): any {\r\n    return {\r\n      '@context': 'https://schema.org',\r\n      '@type': 'Article',\r\n      headline: data.title,\r\n      description: data.description,\r\n      image: data.image || this.config.defaultImage,\r\n      author: {\r\n        '@type': 'Person',\r\n        name: data.author || this.config.siteName\r\n      },\r\n      publisher: {\r\n        '@type': 'Organization',\r\n        name: this.config.siteName,\r\n        logo: {\r\n          '@type': 'ImageObject',\r\n          url: `${this.config.baseUrl}/logo.png`\r\n        }\r\n      },\r\n      datePublished: data.publishedAt || data.createdAt,\r\n      dateModified: data.updatedAt || data.publishedAt || data.createdAt\r\n    };\r\n  }\r\n\r\n  private generateWebsiteStructuredData(data: Record<string, any>): any {\r\n    return {\r\n      '@context': 'https://schema.org',\r\n      '@type': 'WebSite',\r\n      name: this.config.siteName,\r\n      url: this.config.baseUrl,\r\n      potentialAction: {\r\n        '@type': 'SearchAction',\r\n        target: `${this.config.baseUrl}/search?q={search_term_string}`,\r\n        'query-input': 'required name=search_term_string'\r\n      }\r\n    };\r\n  }\r\n\r\n  private generateFallbackMetadata(type: SEOTemplate['type'], data: Record<string, any>): SEOConfig {\r\n    const title = data.title || data.name || `${this.config.siteName}`;\r\n    const description = data.description || `Descubre productos de calidad en ${this.config.siteName}`;\r\n\r\n    return {\r\n      title: this.optimizeTitle(title),\r\n      description: this.optimizeDescription(description),\r\n      keywords: ['ecommerce', 'productos', 'comprar'],\r\n      canonical: this.generateCanonicalUrl(data, this.config.defaultLanguage),\r\n      ogImage: this.config.defaultImage,\r\n      ogType: 'website',\r\n      twitterCard: 'summary_large_image',\r\n      noindex: false,\r\n      nofollow: false\r\n    };\r\n  }\r\n\r\n  // ===================================\r\n  // GESTIÓN DE CACHE\r\n  // ===================================\r\n\r\n  private generateCacheKey(\r\n    type: SEOTemplate['type'],\r\n    data: Record<string, any>,\r\n    options?: any\r\n  ): string {\r\n    const keyData = {\r\n      type,\r\n      id: data.id || data.slug,\r\n      templateId: options?.templateId,\r\n      language: options?.language || this.config.defaultLanguage\r\n    };\r\n\r\n    return `seo:${JSON.stringify(keyData)}`;\r\n  }\r\n\r\n  private async getCachedMetadata(cacheKey: string): Promise<SEOConfig | null> {\r\n    try {\r\n      // Intentar Redis primero\r\n      if (this.redis) {\r\n        const cached = await this.redis.get(cacheKey);\r\n        if (cached) {\r\n          return JSON.parse(cached);\r\n        }\r\n      }\r\n\r\n      // Fallback a cache en memoria\r\n      const memoryCached = this.cache.get(cacheKey);\r\n      if (memoryCached) {\r\n        const isExpired = Date.now() - memoryCached.timestamp > this.config.cacheTTL * 1000;\r\n        if (!isExpired) {\r\n          return memoryCached.metadata;\r\n        } else {\r\n          this.cache.delete(cacheKey);\r\n        }\r\n      }\r\n\r\n      return null;\r\n    } catch (error) {\r\n      logger.warn(LogLevel.WARN, 'Failed to get cached SEO metadata', { cacheKey }, LogCategory.SEO);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  private async setCachedMetadata(cacheKey: string, metadata: SEOConfig): Promise<void> {\r\n    try {\r\n      // Cachear en Redis si está disponible\r\n      if (this.redis) {\r\n        await this.redis.setex(cacheKey, this.config.cacheTTL, JSON.stringify(metadata));\r\n      }\r\n\r\n      // Cachear en memoria como backup\r\n      this.cache.set(cacheKey, {\r\n        metadata,\r\n        timestamp: Date.now()\r\n      });\r\n    } catch (error) {\r\n      logger.warn(LogLevel.WARN, 'Failed to cache SEO metadata', { cacheKey }, LogCategory.SEO);\r\n    }\r\n  }\r\n\r\n  private clearCacheByType(type: SEOTemplate['type']): void {\r\n    const keysToDelete = Array.from(this.cache.keys())\r\n      .filter(key => key.includes(`\"type\":\"${type}\"`));\r\n\r\n    keysToDelete.forEach(key => this.cache.delete(key));\r\n\r\n    logger.info(LogLevel.INFO, 'SEO cache cleared by type', {\r\n      type,\r\n      clearedKeys: keysToDelete.length\r\n    }, LogCategory.SEO);\r\n  }\r\n\r\n  public clearCache(): void {\r\n    this.cache.clear();\r\n    logger.info(LogLevel.INFO, 'SEO cache cleared completely', {}, LogCategory.SEO);\r\n  }\r\n\r\n  // ===================================\r\n  // ANÁLISIS SEO\r\n  // ===================================\r\n\r\n  public analyzeSEO(metadata: SEOConfig): SEOAnalysis {\r\n    const issues: SEOIssue[] = [];\r\n    const recommendations: SEORecommendation[] = [];\r\n\r\n    // Analizar título\r\n    if (!metadata.title) {\r\n      issues.push({\r\n        type: 'error',\r\n        category: 'title',\r\n        message: 'El título es requerido',\r\n        impact: 'high',\r\n        fix: 'Agregar un título descriptivo'\r\n      });\r\n    } else if (metadata.title.length > 60) {\r\n      issues.push({\r\n        type: 'warning',\r\n        category: 'title',\r\n        message: 'El título es demasiado largo (>60 caracteres)',\r\n        impact: 'medium',\r\n        fix: 'Reducir la longitud del título'\r\n      });\r\n    } else if (metadata.title.length < 30) {\r\n      issues.push({\r\n        type: 'warning',\r\n        category: 'title',\r\n        message: 'El título es demasiado corto (<30 caracteres)',\r\n        impact: 'medium',\r\n        fix: 'Expandir el título con más información relevante'\r\n      });\r\n    }\r\n\r\n    // Analizar descripción\r\n    if (!metadata.description) {\r\n      issues.push({\r\n        type: 'error',\r\n        category: 'description',\r\n        message: 'La descripción es requerida',\r\n        impact: 'high',\r\n        fix: 'Agregar una descripción informativa'\r\n      });\r\n    } else if (metadata.description.length > 160) {\r\n      issues.push({\r\n        type: 'warning',\r\n        category: 'description',\r\n        message: 'La descripción es demasiado larga (>160 caracteres)',\r\n        impact: 'medium',\r\n        fix: 'Reducir la longitud de la descripción'\r\n      });\r\n    } else if (metadata.description.length < 120) {\r\n      issues.push({\r\n        type: 'info',\r\n        category: 'description',\r\n        message: 'La descripción podría ser más descriptiva',\r\n        impact: 'low',\r\n        fix: 'Expandir la descripción con más detalles'\r\n      });\r\n    }\r\n\r\n    // Analizar keywords\r\n    if (!metadata.keywords || metadata.keywords.length === 0) {\r\n      issues.push({\r\n        type: 'warning',\r\n        category: 'keywords',\r\n        message: 'No hay palabras clave definidas',\r\n        impact: 'medium',\r\n        fix: 'Agregar palabras clave relevantes'\r\n      });\r\n    } else if (metadata.keywords.length > 10) {\r\n      issues.push({\r\n        type: 'warning',\r\n        category: 'keywords',\r\n        message: 'Demasiadas palabras clave (>10)',\r\n        impact: 'low',\r\n        fix: 'Reducir a las palabras clave más importantes'\r\n      });\r\n    }\r\n\r\n    // Calcular score\r\n    const totalIssues = issues.length;\r\n    const criticalIssues = issues.filter(i => i.impact === 'high').length;\r\n    const mediumIssues = issues.filter(i => i.impact === 'medium').length;\r\n\r\n    let score = 100;\r\n    score -= criticalIssues * 20;\r\n    score -= mediumIssues * 10;\r\n    score -= (totalIssues - criticalIssues - mediumIssues) * 5;\r\n    score = Math.max(0, score);\r\n\r\n    return {\r\n      score,\r\n      issues,\r\n      recommendations,\r\n      metrics: {\r\n        titleLength: metadata.title?.length || 0,\r\n        descriptionLength: metadata.description?.length || 0,\r\n        keywordDensity: metadata.keywords?.length || 0,\r\n        readabilityScore: 0, // TODO: Implementar análisis de legibilidad\r\n        imageOptimization: metadata.ogImage ? 100 : 0\r\n      }\r\n    };\r\n  }\r\n\r\n  // ===================================\r\n  // CONFIGURACIÓN Y ESTADÍSTICAS\r\n  // ===================================\r\n\r\n  public updateConfig(updates: Partial<DynamicSEOConfig>): void {\r\n    this.config = { ...this.config, ...updates };\r\n\r\n    logger.info(LogLevel.INFO, 'SEO configuration updated', {\r\n      changes: Object.keys(updates)\r\n    }, LogCategory.SEO);\r\n  }\r\n\r\n  public getConfig(): DynamicSEOConfig {\r\n    return { ...this.config };\r\n  }\r\n\r\n  public getStats(): {\r\n    templatesCount: number;\r\n    cacheSize: number;\r\n    activeTemplatesByType: Record<string, number>;\r\n  } {\r\n    const activeTemplatesByType = Array.from(this.templates.values())\r\n      .filter(t => t.isActive)\r\n      .reduce((acc, template) => {\r\n        acc[template.type] = (acc[template.type] || 0) + 1;\r\n        return acc;\r\n      }, {} as Record<string, number>);\r\n\r\n    return {\r\n      templatesCount: this.templates.size,\r\n      cacheSize: this.cache.size,\r\n      activeTemplatesByType\r\n    };\r\n  }\r\n\r\n  public destroy(): void {\r\n    this.cache.clear();\r\n    this.templates.clear();\r\n    EnhancedDynamicSEOManager.instance = null as any;\r\n  }\r\n}\r\n\r\n// ===================================\r\n// INSTANCIA SINGLETON Y UTILIDADES\r\n// ===================================\r\n\r\nexport const enhancedDynamicSEOManager = EnhancedDynamicSEOManager.getInstance();\r\n\r\n// Configuración base del sitio (mantenida para compatibilidad)\r\nconst SITE_CONFIG = {\r\n  name: 'Pinteya E-commerce',\r\n  description: 'Tu pinturería online especializada en productos de pintura, ferretería y corralón',\r\n  url: 'https://pinteya-ecommerce.vercel.app',\r\n  logo: '/images/logo/LOGO POSITIVO.svg',\r\n  defaultImage: '/images/hero/hero-bg.jpg',\r\n  locale: 'es_AR',\r\n  currency: 'ARS',\r\n  themeColor: '#ea5a17',\r\n  twitterHandle: '@pinteya_ecommerce',\r\n};\r\n\r\n// Plantillas de SEO optimizadas (mantenidas para compatibilidad)\r\nconst SEO_TEMPLATES = {\r\n  product: {\r\n    title: (product: ProductSEOData) =>\r\n      `${product.name} - ${product.brand} | Pinteya E-commerce`,\r\n    description: async (product: ProductSEOData) => await generateProductSEOText(product),\r\n    keywords: (product: ProductSEOData) => [\r\n      product.name.toLowerCase(),\r\n      product.brand.toLowerCase(),\r\n      product.category.toLowerCase(),\r\n      ...(product.subcategory ? [product.subcategory.toLowerCase()] : []),\r\n      'pinturería online',\r\n      'envío gratis',\r\n      'argentina',\r\n      'comprar online'\r\n    ]\r\n  },\r\n  category: {\r\n    title: (category: CategorySEOData) =>\r\n      `${category.name} | Pinteya E-commerce - Tu Pinturería Online`,\r\n    description: (category: CategorySEOData) =>\r\n      `Descubre nuestra selección de ${category.name.toLowerCase()} en Pinteya. ${category.description} ${category.productCount} productos disponibles. Envío gratis en compras superiores a $50.000.`,\r\n    keywords: (category: CategorySEOData) => [\r\n      category.name.toLowerCase(),\r\n      'pinturería online',\r\n      'ferretería',\r\n      'corralón',\r\n      'envío gratis',\r\n      'argentina',\r\n      'productos de calidad'\r\n    ]\r\n  },\r\n  page: {\r\n    title: (page: PageSEOData) =>\r\n      `${page.title} | Pinteya E-commerce`,\r\n    description: (page: PageSEOData) =>\r\n      page.description,\r\n    keywords: () => [\r\n      'pinturería online',\r\n      'pinturas',\r\n      'ferretería',\r\n      'corralón',\r\n      'argentina'\r\n    ]\r\n  }\r\n};\r\n\r\nclass DynamicSEOManager {\r\n  private static instance: DynamicSEOManager;\r\n\r\n  static getInstance(): DynamicSEOManager {\r\n    if (!DynamicSEOManager.instance) {\r\n      DynamicSEOManager.instance = new DynamicSEOManager();\r\n    }\r\n    return DynamicSEOManager.instance;\r\n  }\r\n\r\n  // Generar metadata para productos\r\n  generateProductMetadata(product: ProductSEOData): Metadata {\r\n    const title = SEO_TEMPLATES.product.title(product);\r\n    const description = SEO_TEMPLATES.product.description(product);\r\n    const keywords = SEO_TEMPLATES.product.keywords(product);\r\n    \r\n    // Validar que product.slug existe antes de generar canonical\r\n    if (!product.slug) {\r\n      console.warn('Product slug is missing, using fallback');\r\n    }\r\n    \r\n    const canonical = product.slug ? `${SITE_CONFIG.url}/products/${product.slug}` : SITE_CONFIG.url;\r\n    const ogImage = product.images?.[0] || SITE_CONFIG.defaultImage;\r\n\r\n    return {\r\n      title,\r\n      description,\r\n      keywords,\r\n      alternates: canonical ? {\r\n        canonical,\r\n      } : undefined,\r\n      openGraph: {\r\n        title,\r\n        description,\r\n        url: canonical,\r\n        siteName: SITE_CONFIG.name,\r\n        images: [\r\n          {\r\n            url: ogImage,\r\n            width: 1200,\r\n            height: 630,\r\n            alt: product.name,\r\n          },\r\n        ],\r\n        locale: SITE_CONFIG.locale,\r\n        type: 'website',\r\n      },\r\n      twitter: {\r\n        card: 'summary_large_image',\r\n        title,\r\n        description,\r\n        images: [ogImage],\r\n      },\r\n      robots: {\r\n        index: true,\r\n        follow: true,\r\n        googleBot: {\r\n          index: true,\r\n          follow: true,\r\n          'max-video-preview': -1,\r\n          'max-image-preview': 'large',\r\n          'max-snippet': -1,\r\n        },\r\n      },\r\n      other: {\r\n        'product:price:amount': product.price.toString(),\r\n        'product:price:currency': 'ARS',\r\n        'product:availability': product.stock > 0 ? 'InStock' : 'OutOfStock',\r\n        'product:condition': 'NewCondition',\r\n        'product:brand': product.brand,\r\n        'product:category': product.category,\r\n      },\r\n    };\r\n  }\r\n\r\n  // Generar metadata para categorías\r\n  generateCategoryMetadata(category: CategorySEOData): Metadata {\r\n    const title = SEO_TEMPLATES.category.title(category);\r\n    const description = SEO_TEMPLATES.category.description(category);\r\n    const keywords = SEO_TEMPLATES.category.keywords(category);\r\n    \r\n    // Validar que category.slug existe antes de generar canonical\r\n    if (!category.slug) {\r\n      console.warn('Category slug is missing, using fallback');\r\n    }\r\n    \r\n    const canonical = category.slug ? `${SITE_CONFIG.url}/categories/${category.slug}` : SITE_CONFIG.url;\r\n    const ogImage = category.image || SITE_CONFIG.defaultImage;\r\n\r\n    return {\r\n      title,\r\n      description,\r\n      keywords,\r\n      alternates: canonical ? {\r\n        canonical,\r\n      } : undefined,\r\n      openGraph: {\r\n        title,\r\n        description,\r\n        url: canonical,\r\n        siteName: SITE_CONFIG.name,\r\n        images: [\r\n          {\r\n            url: ogImage,\r\n            width: 1200,\r\n            height: 630,\r\n            alt: `${category.name} - ${SITE_CONFIG.name}`,\r\n          },\r\n        ],\r\n        locale: SITE_CONFIG.locale,\r\n        type: 'website',\r\n      },\r\n      twitter: {\r\n        card: 'summary_large_image',\r\n        title,\r\n        description,\r\n        images: [ogImage],\r\n      },\r\n      robots: {\r\n        index: true,\r\n        follow: true,\r\n        googleBot: {\r\n          index: true,\r\n          follow: true,\r\n          'max-video-preview': -1,\r\n          'max-image-preview': 'large',\r\n          'max-snippet': -1,\r\n        },\r\n      },\r\n      other: {\r\n        'category:name': category.name,\r\n        'category:product_count': category.productCount.toString(),\r\n      },\r\n    };\r\n  }\r\n\r\n  // Generar metadata para páginas generales\r\n  generatePageMetadata(page: PageSEOData): Metadata {\r\n    const title = SEO_TEMPLATES.page.title(page);\r\n    const description = SEO_TEMPLATES.page.description(page);\r\n    const keywords = SEO_TEMPLATES.page.keywords();\r\n    \r\n    // Validar que page.path existe antes de generar canonical\r\n    if (!page.path) {\r\n      console.warn('Page path is missing, using fallback');\r\n    }\r\n    \r\n    const canonical = page.path ? `${SITE_CONFIG.url}${page.path}` : SITE_CONFIG.url;\r\n\r\n    return {\r\n      title,\r\n      description,\r\n      keywords,\r\n      alternates: canonical ? {\r\n        canonical,\r\n      } : undefined,\r\n      openGraph: {\r\n        title,\r\n        description,\r\n        url: canonical,\r\n        siteName: SITE_CONFIG.name,\r\n        images: [\r\n          {\r\n            url: SITE_CONFIG.defaultImage,\r\n            width: 1200,\r\n            height: 630,\r\n            alt: `${page.title} - ${SITE_CONFIG.name}`,\r\n          },\r\n        ],\r\n        locale: SITE_CONFIG.locale,\r\n        type: page.type === 'article' ? 'article' : 'website',\r\n      },\r\n      twitter: {\r\n        card: 'summary_large_image',\r\n        title,\r\n        description,\r\n        images: [SITE_CONFIG.defaultImage],\r\n      },\r\n      robots: {\r\n        index: page.type !== 'checkout' && page.type !== 'profile',\r\n        follow: true,\r\n        googleBot: {\r\n          index: page.type !== 'checkout' && page.type !== 'profile',\r\n          follow: true,\r\n          'max-video-preview': -1,\r\n          'max-image-preview': 'large',\r\n          'max-snippet': -1,\r\n        },\r\n      },\r\n    };\r\n  }\r\n\r\n  // Optimizar título para SEO\r\n  optimizeTitle(title: string, maxLength: number = 60): string {\r\n    if (title.length <= maxLength) {return title;}\r\n    \r\n    // Truncar en la última palabra completa\r\n    const truncated = title.slice(0, maxLength);\r\n    const lastSpace = truncated.lastIndexOf(' ');\r\n    \r\n    return lastSpace > 0 ? truncated.slice(0, lastSpace) + '...' : truncated + '...';\r\n  }\r\n\r\n  // Optimizar descripción para SEO\r\n  optimizeDescription(description: string, maxLength: number = 160): string {\r\n    if (description.length <= maxLength) {return description;}\r\n    \r\n    // Truncar en la última oración completa\r\n    const truncated = description.slice(0, maxLength);\r\n    const lastPeriod = truncated.lastIndexOf('.');\r\n    const lastSpace = truncated.lastIndexOf(' ');\r\n    \r\n    const cutPoint = lastPeriod > 0 ? lastPeriod + 1 : lastSpace;\r\n    return cutPoint > 0 ? truncated.slice(0, cutPoint) + '...' : truncated + '...';\r\n  }\r\n\r\n  // Generar slug SEO-friendly\r\n  generateSlug(text: string): string {\r\n    return text\r\n      .toLowerCase()\r\n      .normalize('NFD')\r\n      .replace(/[\\u0300-\\u036f]/g, '') // Remover acentos\r\n      .replace(/[^a-z0-9\\s-]/g, '') // Solo letras, números, espacios y guiones\r\n      .replace(/\\s+/g, '-') // Espacios a guiones\r\n      .replace(/-+/g, '-') // Múltiples guiones a uno\r\n      .replace(/^-|-$/g, ''); // Remover guiones al inicio y final\r\n  }\r\n\r\n  // Extraer keywords relevantes del texto\r\n  extractKeywords(text: string, maxKeywords: number = 10): string[] {\r\n    const stopWords = new Set([\r\n      'el', 'la', 'de', 'que', 'y', 'a', 'en', 'un', 'es', 'se', 'no', 'te', 'lo', 'le',\r\n      'da', 'su', 'por', 'son', 'con', 'para', 'al', 'del', 'los', 'las', 'una', 'como',\r\n      'pero', 'sus', 'le', 'ya', 'o', 'porque', 'cuando', 'muy', 'sin', 'sobre', 'también',\r\n      'me', 'hasta', 'donde', 'quien', 'desde', 'todos', 'durante', 'todo', 'esto', 'eso'\r\n    ]);\r\n\r\n    const words = text\r\n      .toLowerCase()\r\n      .replace(/[^\\w\\s]/g, ' ')\r\n      .split(/\\s+/)\r\n      .filter(word => word.length > 3 && !stopWords.has(word));\r\n\r\n    // Contar frecuencia de palabras\r\n    const wordCount = words.reduce((acc, word) => {\r\n      acc[word] = (acc[word] || 0) + 1;\r\n      return acc;\r\n    }, {} as Record<string, number>);\r\n\r\n    // Ordenar por frecuencia y tomar las más relevantes\r\n    return Object.entries(wordCount)\r\n      .sort(([, a], [, b]) => b - a)\r\n      .slice(0, maxKeywords)\r\n      .map(([word]) => word);\r\n  }\r\n\r\n  // Validar configuración SEO\r\n  validateSEOConfig(config: SEOConfig): { isValid: boolean; errors: string[] } {\r\n    const errors: string[] = [];\r\n\r\n    if (!config.title || config.title.length === 0) {\r\n      errors.push('El título es requerido');\r\n    } else if (config.title.length > 60) {\r\n      errors.push('El título no debe exceder 60 caracteres');\r\n    }\r\n\r\n    if (!config.description || config.description.length === 0) {\r\n      errors.push('La descripción es requerida');\r\n    } else if (config.description.length > 160) {\r\n      errors.push('La descripción no debe exceder 160 caracteres');\r\n    }\r\n\r\n    if (config.keywords && config.keywords.length === 0) {\r\n      errors.push('Se recomienda incluir al menos 3 keywords');\r\n    }\r\n\r\n    return {\r\n      isValid: errors.length === 0,\r\n      errors\r\n    };\r\n  }\r\n}\r\n\r\n// Exportar instancia singleton\r\nexport const dynamicSEOManager = DynamicSEOManager.getInstance();\r\n\r\n// Exportar tipos y utilidades\r\nexport { DynamicSEOManager, SITE_CONFIG, SEO_TEMPLATES };\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"names":["DynamicSEOManager","EnhancedDynamicSEOManager","SEO_TEMPLATES","SITE_CONFIG","dynamicSEOManager","enhancedDynamicSEOManager","DEFAULT_SEO_CONFIG","defaultLanguage","supportedLanguages","baseUrl","process","env","NEXT_PUBLIC_APP_URL","siteName","defaultImage","twitterHandle","enableAutoGeneration","enableAnalytics","cacheEnabled","cacheTTL","DEFAULT_TEMPLATES","id","name","type","titleTemplate","descriptionTemplate","keywordsTemplate","robotsDirective","priority","isActive","variables","config","templates","Map","cache","forEach","template","set","initializeRedis","logger","info","LogLevel","INFO","templatesCount","size","LogCategory","SEO","getInstance","instance","redis","getRedisClient","error","warn","WARN","addTemplate","templateId","updateTemplate","updates","get","updatedTemplate","clearCacheByType","changes","Object","keys","getTemplatesByType","Array","from","values","filter","sort","a","b","generateMetadata","data","options","cacheKey","generateCacheKey","cached","getCachedMetadata","selectTemplate","Error","metadata","processTemplate","setCachedMetadata","titleLength","title","length","descriptionLength","description","ERROR","generateFallbackMetadata","customTemplate","candidates","evaluateConditions","conditions","every","condition","value","getNestedValue","field","operator","String","includes","startsWith","endsWith","Number","language","processedData","enrichData","processTemplateString","keywords","map","keyword","Boolean","canonical","generateCanonicalUrl","structuredData","generateStructuredData","optimizeTitle","optimizeDescription","optimizeKeywords","ogImage","image","ogType","getOGType","twitterCard","undefined","noindex","nofollow","replace","match","key","currentDate","Date","toISOString","split","currentYear","getFullYear","obj","path","reduce","current","truncated","substring","lastSpace","lastIndexOf","unique","Set","slice","slug","langPrefix","generateProductStructuredData","generateCategoryStructuredData","generateArticleStructuredData","generateWebsiteStructuredData","productName","productDescription","brand","offers","price","productPrice","priceCurrency","availability","stock","seller","categoryName","categoryDescription","url","headline","author","publisher","logo","datePublished","publishedAt","createdAt","dateModified","updatedAt","potentialAction","target","keyData","JSON","stringify","parse","memoryCached","isExpired","now","timestamp","delete","setex","keysToDelete","clearedKeys","clearCache","clear","analyzeSEO","issues","recommendations","push","category","message","impact","fix","totalIssues","criticalIssues","i","mediumIssues","score","Math","max","metrics","keywordDensity","readabilityScore","imageOptimization","updateConfig","getConfig","getStats","activeTemplatesByType","t","acc","cacheSize","destroy","locale","currency","themeColor","product","generateProductSEOText","toLowerCase","subcategory","productCount","page","generateProductMetadata","console","images","alternates","openGraph","width","height","alt","twitter","card","robots","index","follow","googleBot","other","toString","generateCategoryMetadata","generatePageMetadata","maxLength","lastPeriod","cutPoint","generateSlug","text","normalize","extractKeywords","maxKeywords","stopWords","words","word","has","wordCount","entries","validateSEOConfig","errors","isValid"],"mappings":"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"}