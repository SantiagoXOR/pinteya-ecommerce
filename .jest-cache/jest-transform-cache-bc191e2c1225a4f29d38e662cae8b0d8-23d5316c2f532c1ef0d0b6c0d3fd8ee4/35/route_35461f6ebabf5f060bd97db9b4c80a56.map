{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\app\\api\\driver\\profile\\route.ts"],"sourcesContent":["// Configuración para Node.js Runtime\r\nexport const runtime = 'nodejs';\r\n\r\n/**\r\n * API para obtener el perfil del driver y sus rutas asignadas\r\n * GET /api/driver/profile\r\n */\r\n\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport { auth } from '@/lib/auth/config';\r\nimport { createClient } from '@/lib/integrations/supabase/server';\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    // Verificar autenticación\r\n    const session = await auth();\r\n    \r\n    if (!session?.user?.email) {\r\n      return NextResponse.json(\r\n        { error: 'No autorizado' },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const supabase = await createClient();\r\n\r\n    // Obtener información del driver\r\n    const { data: driver, error: driverError } = await supabase\r\n      .from('drivers')\r\n      .select('id, first_name, last_name, email, phone, status, rating, total_deliveries, created_at, updated_at')\r\n      .eq('email', session.user.email)\r\n      .single();\r\n\r\n    if (driverError || !driver) {\r\n      console.error('Driver not found:', driverError);\r\n      return NextResponse.json(\r\n        { error: 'Driver no encontrado' },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Obtener rutas asignadas al driver\r\n    const { data: routes, error: routesError } = await supabase\r\n      .from('optimized_routes')\r\n      .select('*')\r\n      .eq('driver_id', driver.id)\r\n      .in('status', ['planned', 'active'])\r\n      .order('created_at', { ascending: true });\r\n\r\n    if (routesError) {\r\n      console.error('Error fetching routes:', routesError);\r\n    }\r\n\r\n    // Obtener estadísticas del día\r\n    const today = new Date().toISOString().split('T')[0];\r\n    \r\n    const { data: todayDeliveries, error: deliveriesError } = await supabase\r\n      .from('optimized_routes')\r\n      .select('shipments')\r\n      .eq('driver_id', driver.id)\r\n      .eq('status', 'completed')\r\n      .gte('created_at', `${today}T00:00:00.000Z`)\r\n      .lte('created_at', `${today}T23:59:59.999Z`);\r\n\r\n    let completedDeliveries = 0;\r\n    let totalDistance = 0;\r\n\r\n    if (todayDeliveries) {\r\n      todayDeliveries.forEach(route => {\r\n        if (route.shipments && Array.isArray(route.shipments)) {\r\n          completedDeliveries += route.shipments.filter(\r\n            (shipment: any) => shipment.status === 'delivered'\r\n          ).length;\r\n        }\r\n      });\r\n    }\r\n\r\n    // Calcular distancia total del día\r\n    const { data: todayRoutes, error: todayRoutesError } = await supabase\r\n      .from('optimized_routes')\r\n      .select('total_distance')\r\n      .eq('driver_id', driver.id)\r\n      .gte('created_at', `${today}T00:00:00.000Z`)\r\n      .lte('created_at', `${today}T23:59:59.999Z`);\r\n\r\n    if (todayRoutes) {\r\n      totalDistance = todayRoutes.reduce(\r\n        (sum, route) => sum + (route.total_distance || 0), \r\n        0\r\n      );\r\n    }\r\n\r\n    const response = {\r\n      driver: {\r\n        id: driver.id,\r\n        name: `${driver.first_name} ${driver.last_name}`,\r\n        first_name: driver.first_name,\r\n        last_name: driver.last_name,\r\n        email: driver.email,\r\n        phone: driver.phone,\r\n        status: driver.status,\r\n        rating: driver.rating,\r\n        total_deliveries: driver.total_deliveries\r\n      },\r\n      routes: routes || [],\r\n      todayStats: {\r\n        completedDeliveries,\r\n        totalDistance: Math.round(totalDistance * 100) / 100,\r\n        activeTime: '0h 0m', // TODO: Implementar tracking de tiempo activo\r\n        efficiency: routes?.length > 0 ? \r\n          Math.round(routes.reduce((sum, route) => sum + (route.optimization_score || 0), 0) / routes.length) : 0\r\n      }\r\n    };\r\n\r\n    return NextResponse.json(response);\r\n\r\n  } catch (error) {\r\n    console.error('Error in driver profile API:', error);\r\n    return NextResponse.json(\r\n      { error: 'Error interno del servidor' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nexport async function PUT(request: NextRequest) {\r\n  try {\r\n    // Verificar autenticación\r\n    const session = await auth();\r\n    \r\n    if (!session?.user?.email) {\r\n      return NextResponse.json(\r\n        { error: 'No autorizado' },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const { status, current_location } = body;\r\n\r\n    const supabase = await createClient();\r\n\r\n    // Actualizar información del driver\r\n    const { data: driver, error } = await supabase\r\n      .from('drivers')\r\n      .update({\r\n        status: status || undefined,\r\n        current_location: current_location || undefined,\r\n        updated_at: new Date().toISOString()\r\n      })\r\n      .eq('email', session.user.email)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error('Error updating driver:', error);\r\n      return NextResponse.json(\r\n        { error: 'Error actualizando driver' },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    return NextResponse.json({ driver });\r\n\r\n  } catch (error) {\r\n    console.error('Error in driver profile update API:', error);\r\n    return NextResponse.json(\r\n      { error: 'Error interno del servidor' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"names":["GET","PUT","runtime","request","session","auth","user","email","NextResponse","json","error","status","supabase","createClient","data","driver","driverError","from","select","eq","single","console","routes","routesError","id","in","order","ascending","today","Date","toISOString","split","todayDeliveries","deliveriesError","gte","lte","completedDeliveries","totalDistance","forEach","route","shipments","Array","isArray","filter","shipment","length","todayRoutes","todayRoutesError","reduce","sum","total_distance","response","name","first_name","last_name","phone","rating","total_deliveries","todayStats","Math","round","activeTime","efficiency","optimization_score","body","current_location","update","undefined","updated_at"],"mappings":"AAAA,qCAAqC;;;;;;;;;;;;QAYfA;eAAAA;;QAiHAC;eAAAA;;QA5HTC;eAAAA;;;wBAO6B;wBACrB;yBACQ;AATtB,MAAMA,UAAU;AAWhB,eAAeF,IAAIG,OAAoB;IAC5C,IAAI;QACF,0BAA0B;QAC1B,MAAMC,UAAU,MAAMC,IAAAA,YAAI;QAE1B,IAAI,CAACD,SAASE,MAAMC,OAAO;YACzB,OAAOC,oBAAY,CAACC,IAAI,CACtB;gBAAEC,OAAO;YAAgB,GACzB;gBAAEC,QAAQ;YAAI;QAElB;QAEA,MAAMC,WAAW,MAAMC,IAAAA,qBAAY;QAEnC,iCAAiC;QACjC,MAAM,EAAEC,MAAMC,MAAM,EAAEL,OAAOM,WAAW,EAAE,GAAG,MAAMJ,SAChDK,IAAI,CAAC,WACLC,MAAM,CAAC,qGACPC,EAAE,CAAC,SAASf,QAAQE,IAAI,CAACC,KAAK,EAC9Ba,MAAM;QAET,IAAIJ,eAAe,CAACD,QAAQ;YAC1BM,QAAQX,KAAK,CAAC,qBAAqBM;YACnC,OAAOR,oBAAY,CAACC,IAAI,CACtB;gBAAEC,OAAO;YAAuB,GAChC;gBAAEC,QAAQ;YAAI;QAElB;QAEA,oCAAoC;QACpC,MAAM,EAAEG,MAAMQ,MAAM,EAAEZ,OAAOa,WAAW,EAAE,GAAG,MAAMX,SAChDK,IAAI,CAAC,oBACLC,MAAM,CAAC,KACPC,EAAE,CAAC,aAAaJ,OAAOS,EAAE,EACzBC,EAAE,CAAC,UAAU;YAAC;YAAW;SAAS,EAClCC,KAAK,CAAC,cAAc;YAAEC,WAAW;QAAK;QAEzC,IAAIJ,aAAa;YACfF,QAAQX,KAAK,CAAC,0BAA0Ba;QAC1C;QAEA,+BAA+B;QAC/B,MAAMK,QAAQ,IAAIC,OAAOC,WAAW,GAAGC,KAAK,CAAC,IAAI,CAAC,EAAE;QAEpD,MAAM,EAAEjB,MAAMkB,eAAe,EAAEtB,OAAOuB,eAAe,EAAE,GAAG,MAAMrB,SAC7DK,IAAI,CAAC,oBACLC,MAAM,CAAC,aACPC,EAAE,CAAC,aAAaJ,OAAOS,EAAE,EACzBL,EAAE,CAAC,UAAU,aACbe,GAAG,CAAC,cAAc,GAAGN,MAAM,cAAc,CAAC,EAC1CO,GAAG,CAAC,cAAc,GAAGP,MAAM,cAAc,CAAC;QAE7C,IAAIQ,sBAAsB;QAC1B,IAAIC,gBAAgB;QAEpB,IAAIL,iBAAiB;YACnBA,gBAAgBM,OAAO,CAACC,CAAAA;gBACtB,IAAIA,MAAMC,SAAS,IAAIC,MAAMC,OAAO,CAACH,MAAMC,SAAS,GAAG;oBACrDJ,uBAAuBG,MAAMC,SAAS,CAACG,MAAM,CAC3C,CAACC,WAAkBA,SAASjC,MAAM,KAAK,aACvCkC,MAAM;gBACV;YACF;QACF;QAEA,mCAAmC;QACnC,MAAM,EAAE/B,MAAMgC,WAAW,EAAEpC,OAAOqC,gBAAgB,EAAE,GAAG,MAAMnC,SAC1DK,IAAI,CAAC,oBACLC,MAAM,CAAC,kBACPC,EAAE,CAAC,aAAaJ,OAAOS,EAAE,EACzBU,GAAG,CAAC,cAAc,GAAGN,MAAM,cAAc,CAAC,EAC1CO,GAAG,CAAC,cAAc,GAAGP,MAAM,cAAc,CAAC;QAE7C,IAAIkB,aAAa;YACfT,gBAAgBS,YAAYE,MAAM,CAChC,CAACC,KAAKV,QAAUU,MAAOV,CAAAA,MAAMW,cAAc,IAAI,CAAA,GAC/C;QAEJ;QAEA,MAAMC,WAAW;YACfpC,QAAQ;gBACNS,IAAIT,OAAOS,EAAE;gBACb4B,MAAM,GAAGrC,OAAOsC,UAAU,CAAC,CAAC,EAAEtC,OAAOuC,SAAS,EAAE;gBAChDD,YAAYtC,OAAOsC,UAAU;gBAC7BC,WAAWvC,OAAOuC,SAAS;gBAC3B/C,OAAOQ,OAAOR,KAAK;gBACnBgD,OAAOxC,OAAOwC,KAAK;gBACnB5C,QAAQI,OAAOJ,MAAM;gBACrB6C,QAAQzC,OAAOyC,MAAM;gBACrBC,kBAAkB1C,OAAO0C,gBAAgB;YAC3C;YACAnC,QAAQA,UAAU,EAAE;YACpBoC,YAAY;gBACVtB;gBACAC,eAAesB,KAAKC,KAAK,CAACvB,gBAAgB,OAAO;gBACjDwB,YAAY;gBACZC,YAAYxC,QAAQuB,SAAS,IAC3Bc,KAAKC,KAAK,CAACtC,OAAO0B,MAAM,CAAC,CAACC,KAAKV,QAAUU,MAAOV,CAAAA,MAAMwB,kBAAkB,IAAI,CAAA,GAAI,KAAKzC,OAAOuB,MAAM,IAAI;YAC1G;QACF;QAEA,OAAOrC,oBAAY,CAACC,IAAI,CAAC0C;IAE3B,EAAE,OAAOzC,OAAO;QACdW,QAAQX,KAAK,CAAC,gCAAgCA;QAC9C,OAAOF,oBAAY,CAACC,IAAI,CACtB;YAAEC,OAAO;QAA6B,GACtC;YAAEC,QAAQ;QAAI;IAElB;AACF;AAEO,eAAeV,IAAIE,OAAoB;IAC5C,IAAI;QACF,0BAA0B;QAC1B,MAAMC,UAAU,MAAMC,IAAAA,YAAI;QAE1B,IAAI,CAACD,SAASE,MAAMC,OAAO;YACzB,OAAOC,oBAAY,CAACC,IAAI,CACtB;gBAAEC,OAAO;YAAgB,GACzB;gBAAEC,QAAQ;YAAI;QAElB;QAEA,MAAMqD,OAAO,MAAM7D,QAAQM,IAAI;QAC/B,MAAM,EAAEE,MAAM,EAAEsD,gBAAgB,EAAE,GAAGD;QAErC,MAAMpD,WAAW,MAAMC,IAAAA,qBAAY;QAEnC,oCAAoC;QACpC,MAAM,EAAEC,MAAMC,MAAM,EAAEL,KAAK,EAAE,GAAG,MAAME,SACnCK,IAAI,CAAC,WACLiD,MAAM,CAAC;YACNvD,QAAQA,UAAUwD;YAClBF,kBAAkBA,oBAAoBE;YACtCC,YAAY,IAAIvC,OAAOC,WAAW;QACpC,GACCX,EAAE,CAAC,SAASf,QAAQE,IAAI,CAACC,KAAK,EAC9BW,MAAM,GACNE,MAAM;QAET,IAAIV,OAAO;YACTW,QAAQX,KAAK,CAAC,0BAA0BA;YACxC,OAAOF,oBAAY,CAACC,IAAI,CACtB;gBAAEC,OAAO;YAA4B,GACrC;gBAAEC,QAAQ;YAAI;QAElB;QAEA,OAAOH,oBAAY,CAACC,IAAI,CAAC;YAAEM;QAAO;IAEpC,EAAE,OAAOL,OAAO;QACdW,QAAQX,KAAK,CAAC,uCAAuCA;QACrD,OAAOF,oBAAY,CAACC,IAAI,CACtB;YAAEC,OAAO;QAA6B,GACtC;YAAEC,QAAQ;QAAI;IAElB;AACF"}