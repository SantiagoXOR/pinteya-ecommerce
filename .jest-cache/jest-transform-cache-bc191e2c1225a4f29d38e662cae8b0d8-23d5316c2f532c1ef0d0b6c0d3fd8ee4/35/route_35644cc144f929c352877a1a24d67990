48033e68b23c0a554b735d32a0d0a1dc
// Configuración para Node.js Runtime
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: Object.getOwnPropertyDescriptor(all, name).get
    });
}
_export(exports, {
    get GET () {
        return GET;
    },
    get POST () {
        return POST;
    },
    get runtime () {
        return runtime;
    }
});
const _server = require("next/server");
const _supabase = require("../../../lib/integrations/supabase");
const _validations = require("../../../lib/validations");
const _ratelimiter = require("../../../lib/rate-limiting/rate-limiter");
const _apitimeouts = require("../../../lib/config/api-timeouts");
const _securitylogger = require("../../../lib/logging/security-logger");
function _getRequireWildcardCache(nodeInterop) {
    if (typeof WeakMap !== "function") return null;
    var cacheBabelInterop = new WeakMap();
    var cacheNodeInterop = new WeakMap();
    return (_getRequireWildcardCache = function(nodeInterop) {
        return nodeInterop ? cacheNodeInterop : cacheBabelInterop;
    })(nodeInterop);
}
function _interop_require_wildcard(obj, nodeInterop) {
    if (!nodeInterop && obj && obj.__esModule) {
        return obj;
    }
    if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
        return {
            default: obj
        };
    }
    var cache = _getRequireWildcardCache(nodeInterop);
    if (cache && cache.has(obj)) {
        return cache.get(obj);
    }
    var newObj = {
        __proto__: null
    };
    var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;
    for(var key in obj){
        if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) {
            var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;
            if (desc && (desc.get || desc.set)) {
                Object.defineProperty(newObj, key, desc);
            } else {
                newObj[key] = obj[key];
            }
        }
    }
    newObj.default = obj;
    if (cache) {
        cache.set(obj, newObj);
    }
    return newObj;
}
const runtime = 'nodejs';
async function GET(request) {
    // Crear logger de seguridad con contexto
    const securityLogger = (0, _securitylogger.createSecurityLogger)(request);
    // Aplicar rate limiting para APIs de categorías
    const rateLimitResult = await (0, _ratelimiter.withRateLimit)(request, _ratelimiter.RATE_LIMIT_CONFIGS.products, async ()=>{
        // Log de acceso a la API
        securityLogger.log({
            type: 'data_access',
            severity: 'low',
            message: 'Categories API accessed',
            context: securityLogger.context,
            metadata: {
                endpoint: '/api/categories',
                method: 'GET',
                userAgent: request.headers.get('user-agent')
            }
        });
        try {
            const { searchParams } = new URL(request.url);
            // Extraer parámetros de query
            const queryParams = {
                search: searchParams.get('search') || undefined
            };
            // Validar parámetros (simplificado para la estructura actual)
            const filters = {
                search: queryParams.search
            };
            const supabase = (0, _supabase.getSupabaseClient)();
            // Verificar que el cliente de Supabase esté disponible
            if (!supabase) {
                console.error('Cliente de Supabase no disponible en GET /api/categories');
                const errorResponse = {
                    data: null,
                    success: false,
                    error: 'Servicio de base de datos no disponible'
                };
                return _server.NextResponse.json(errorResponse, {
                    status: 503
                });
            }
            // Construir query base - simplificado para la estructura actual
            const baseQuery = supabase.from('categories').select(`
        *,
        products_count:products(count)
      `).order('name');
            // Aplicar filtros
            let query = baseQuery;
            if (filters.search) {
                query = query.ilike('name', `%${filters.search}%`);
            }
            // Ejecutar query con timeout de base de datos
            const { data: categories, error } = await (0, _apitimeouts.withDatabaseTimeout)(async (signal)=>{
                return await query.abortSignal(signal);
            }, _apitimeouts.API_TIMEOUTS.database);
            if (error) {
                console.error('Error en GET /api/categories:', error);
                // Log de error de seguridad
                securityLogger.logApiError(securityLogger.context, new Error(`Database error: ${error.message}`), {
                    endpoint: '/api/categories',
                    operation: 'select_categories'
                });
                const errorResponse = {
                    data: null,
                    success: false,
                    error: error.message || 'Error obteniendo categorías'
                };
                return _server.NextResponse.json(errorResponse, {
                    status: 500
                });
            }
            // Procesar datos para incluir conteo de productos
            const processedCategories = categories?.map((category)=>({
                    ...category,
                    products_count: category.products_count?.[0]?.count || 0
                })) || [];
            // Log de operación exitosa
            securityLogger.log({
                type: 'data_access',
                severity: 'low',
                message: 'Categories retrieved successfully',
                context: securityLogger.context,
                metadata: {
                    categoriesCount: processedCategories.length,
                    hasSearch: !!filters.search,
                    searchTerm: filters.search
                }
            });
            const response = {
                data: processedCategories,
                success: true,
                message: `${processedCategories.length} categorías encontradas`
            };
            return _server.NextResponse.json(response);
        } catch (error) {
            console.error('Error en GET /api/categories:', error);
            // Log de error de seguridad
            securityLogger.logApiError(securityLogger.context, error instanceof Error ? error : new Error('Unknown error'), {
                endpoint: '/api/categories'
            });
            const errorResponse = {
                data: null,
                success: false,
                error: error.message || 'Error interno del servidor'
            };
            return _server.NextResponse.json(errorResponse, {
                status: 500
            });
        }
    });
    // Manejar rate limit excedido
    if (rateLimitResult instanceof _server.NextResponse) {
        securityLogger.logRateLimitExceeded(securityLogger.context, {
            endpoint: '/api/categories',
            method: 'GET'
        });
        return rateLimitResult;
    }
    return rateLimitResult;
}
async function POST(request) {
    try {
        // ENTERPRISE: Usar nueva autenticación enterprise para admin
        const { requireAdminAuth } = await Promise.resolve().then(()=>/*#__PURE__*/ _interop_require_wildcard(require("../../../lib/auth/enterprise-auth-utils")));
        const authResult = await requireAdminAuth(request, [
            'categories_create'
        ]);
        if (!authResult.success) {
            return _server.NextResponse.json({
                error: authResult.error,
                code: authResult.code,
                enterprise: true,
                timestamp: new Date().toISOString()
            }, {
                status: authResult.status || 401
            });
        }
        const context = authResult.context;
        const body = await request.json();
        // Validar datos de la categoría
        const categoryData = (0, _validations.validateData)(_validations.CategorySchema, body);
        const supabase = (0, _supabase.getSupabaseClient)(true) // Usar cliente admin
        ;
        // Verificar que el cliente administrativo esté disponible
        if (!supabase) {
            console.error('Cliente administrativo de Supabase no disponible en POST /api/categories');
            const errorResponse = {
                data: null,
                success: false,
                error: 'Servicio administrativo no disponible'
            };
            return _server.NextResponse.json(errorResponse, {
                status: 503
            });
        }
        // Crear slug si no se proporciona
        if (!categoryData.slug) {
            categoryData.slug = categoryData.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
        }
        // Insertar categoría
        const { data: category, error } = await supabase.from('categories').insert(categoryData).select().single();
        if (error) {
            (0, _supabase.handleSupabaseError)(error, 'POST /api/categories');
        }
        const response = {
            data: category,
            success: true,
            message: 'Categoría creada exitosamente'
        };
        return _server.NextResponse.json(response, {
            status: 201
        });
    } catch (error) {
        console.error('Error en POST /api/categories:', error);
        const errorResponse = {
            data: null,
            success: false,
            error: error.message || 'Error interno del servidor'
        };
        return _server.NextResponse.json(errorResponse, {
            status: 500
        });
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbWFydGlcXERlc2t0b3BcXERFU0FSUk9MTE9TV1xcQk9JTEVSUExBVFRFIEUtQ09NTUVSQ0VcXHNyY1xcYXBwXFxhcGlcXGNhdGVnb3JpZXNcXHJvdXRlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvbmZpZ3VyYWNpw7NuIHBhcmEgTm9kZS5qcyBSdW50aW1lXG5leHBvcnQgY29uc3QgcnVudGltZSA9ICdub2RlanMnXG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBQSU5URVlBIEUtQ09NTUVSQ0UgLSBBUEkgREUgQ0FURUdPUsONQVNcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmltcG9ydCB7IE5leHRSZXF1ZXN0LCBOZXh0UmVzcG9uc2UgfSBmcm9tICduZXh0L3NlcnZlcidcbmltcG9ydCB7IGdldFN1cGFiYXNlQ2xpZW50LCBoYW5kbGVTdXBhYmFzZUVycm9yIH0gZnJvbSAnQC9saWIvaW50ZWdyYXRpb25zL3N1cGFiYXNlJ1xuaW1wb3J0IHsgdmFsaWRhdGVEYXRhLCBDYXRlZ29yeUZpbHRlcnNTY2hlbWEsIENhdGVnb3J5U2NoZW1hIH0gZnJvbSAnQC9saWIvdmFsaWRhdGlvbnMnXG5pbXBvcnQgeyBBcGlSZXNwb25zZSB9IGZyb20gJ0AvdHlwZXMvYXBpJ1xuaW1wb3J0IHsgQ2F0ZWdvcnkgfSBmcm9tICdAL3R5cGVzL2RhdGFiYXNlJ1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gTUVKT1JBUyBERSBTRUdVUklEQUQgLSBBTFRBIFBSSU9SSURBRFxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbmltcG9ydCB7IHdpdGhSYXRlTGltaXQsIFJBVEVfTElNSVRfQ09ORklHUyB9IGZyb20gJ0AvbGliL3JhdGUtbGltaXRpbmcvcmF0ZS1saW1pdGVyJ1xuaW1wb3J0IHsgQVBJX1RJTUVPVVRTLCB3aXRoRGF0YWJhc2VUaW1lb3V0LCBnZXRFbmRwb2ludFRpbWVvdXRzIH0gZnJvbSAnQC9saWIvY29uZmlnL2FwaS10aW1lb3V0cydcbmltcG9ydCB7IGNyZWF0ZVNlY3VyaXR5TG9nZ2VyIH0gZnJvbSAnQC9saWIvbG9nZ2luZy9zZWN1cml0eS1sb2dnZXInXG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBHRVQgL2FwaS9jYXRlZ29yaWVzIC0gT2J0ZW5lciBjYXRlZ29yw61hc1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBHRVQocmVxdWVzdDogTmV4dFJlcXVlc3QpIHtcbiAgLy8gQ3JlYXIgbG9nZ2VyIGRlIHNlZ3VyaWRhZCBjb24gY29udGV4dG9cbiAgY29uc3Qgc2VjdXJpdHlMb2dnZXIgPSBjcmVhdGVTZWN1cml0eUxvZ2dlcihyZXF1ZXN0KVxuXG4gIC8vIEFwbGljYXIgcmF0ZSBsaW1pdGluZyBwYXJhIEFQSXMgZGUgY2F0ZWdvcsOtYXNcbiAgY29uc3QgcmF0ZUxpbWl0UmVzdWx0ID0gYXdhaXQgd2l0aFJhdGVMaW1pdChcbiAgICByZXF1ZXN0LFxuICAgIFJBVEVfTElNSVRfQ09ORklHUy5wcm9kdWN0cywgLy8gVXNhciBjb25maWcgZGUgcHJvZHVjdG9zIHBhcmEgY2F0ZWdvcsOtYXNcbiAgICBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBMb2cgZGUgYWNjZXNvIGEgbGEgQVBJXG4gICAgICBzZWN1cml0eUxvZ2dlci5sb2coe1xuICAgICAgICB0eXBlOiAnZGF0YV9hY2Nlc3MnLFxuICAgICAgICBzZXZlcml0eTogJ2xvdycsXG4gICAgICAgIG1lc3NhZ2U6ICdDYXRlZ29yaWVzIEFQSSBhY2Nlc3NlZCcsXG4gICAgICAgIGNvbnRleHQ6IHNlY3VyaXR5TG9nZ2VyLmNvbnRleHQsXG4gICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgZW5kcG9pbnQ6ICcvYXBpL2NhdGVnb3JpZXMnLFxuICAgICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgICAgdXNlckFnZW50OiByZXF1ZXN0LmhlYWRlcnMuZ2V0KCd1c2VyLWFnZW50JyksXG4gICAgICAgIH0sXG4gICAgICB9KVxuXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB7IHNlYXJjaFBhcmFtcyB9ID0gbmV3IFVSTChyZXF1ZXN0LnVybClcblxuICAgICAgICAvLyBFeHRyYWVyIHBhcsOhbWV0cm9zIGRlIHF1ZXJ5XG4gICAgICAgIGNvbnN0IHF1ZXJ5UGFyYW1zID0ge1xuICAgICAgICAgIHNlYXJjaDogc2VhcmNoUGFyYW1zLmdldCgnc2VhcmNoJykgfHwgdW5kZWZpbmVkLFxuICAgICAgICB9XG5cbiAgICAgICAgLy8gVmFsaWRhciBwYXLDoW1ldHJvcyAoc2ltcGxpZmljYWRvIHBhcmEgbGEgZXN0cnVjdHVyYSBhY3R1YWwpXG4gICAgICAgIGNvbnN0IGZpbHRlcnMgPSB7XG4gICAgICAgICAgc2VhcmNoOiBxdWVyeVBhcmFtcy5zZWFyY2gsXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzdXBhYmFzZSA9IGdldFN1cGFiYXNlQ2xpZW50KClcblxuICAgICAgICAvLyBWZXJpZmljYXIgcXVlIGVsIGNsaWVudGUgZGUgU3VwYWJhc2UgZXN0w6kgZGlzcG9uaWJsZVxuICAgICAgICBpZiAoIXN1cGFiYXNlKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignQ2xpZW50ZSBkZSBTdXBhYmFzZSBubyBkaXNwb25pYmxlIGVuIEdFVCAvYXBpL2NhdGVnb3JpZXMnKVxuICAgICAgICAgIGNvbnN0IGVycm9yUmVzcG9uc2U6IEFwaVJlc3BvbnNlPG51bGw+ID0ge1xuICAgICAgICAgICAgZGF0YTogbnVsbCxcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgZXJyb3I6ICdTZXJ2aWNpbyBkZSBiYXNlIGRlIGRhdG9zIG5vIGRpc3BvbmlibGUnLFxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oZXJyb3JSZXNwb25zZSwgeyBzdGF0dXM6IDUwMyB9KVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ29uc3RydWlyIHF1ZXJ5IGJhc2UgLSBzaW1wbGlmaWNhZG8gcGFyYSBsYSBlc3RydWN0dXJhIGFjdHVhbFxuICAgICAgICBjb25zdCBiYXNlUXVlcnkgPSBzdXBhYmFzZVxuICAgICAgICAgIC5mcm9tKCdjYXRlZ29yaWVzJylcbiAgICAgICAgICAuc2VsZWN0KFxuICAgICAgICAgICAgYFxuICAgICAgICAqLFxuICAgICAgICBwcm9kdWN0c19jb3VudDpwcm9kdWN0cyhjb3VudClcbiAgICAgIGBcbiAgICAgICAgICApXG4gICAgICAgICAgLm9yZGVyKCduYW1lJylcblxuICAgICAgICAvLyBBcGxpY2FyIGZpbHRyb3NcbiAgICAgICAgbGV0IHF1ZXJ5ID0gYmFzZVF1ZXJ5XG4gICAgICAgIGlmIChmaWx0ZXJzLnNlYXJjaCkge1xuICAgICAgICAgIHF1ZXJ5ID0gcXVlcnkuaWxpa2UoJ25hbWUnLCBgJSR7ZmlsdGVycy5zZWFyY2h9JWApXG4gICAgICAgIH1cblxuICAgICAgICAvLyBFamVjdXRhciBxdWVyeSBjb24gdGltZW91dCBkZSBiYXNlIGRlIGRhdG9zXG4gICAgICAgIGNvbnN0IHsgZGF0YTogY2F0ZWdvcmllcywgZXJyb3IgfSA9IGF3YWl0IHdpdGhEYXRhYmFzZVRpbWVvdXQoYXN5bmMgc2lnbmFsID0+IHtcbiAgICAgICAgICByZXR1cm4gYXdhaXQgcXVlcnkuYWJvcnRTaWduYWwoc2lnbmFsKVxuICAgICAgICB9LCBBUElfVElNRU9VVFMuZGF0YWJhc2UpXG5cbiAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZW4gR0VUIC9hcGkvY2F0ZWdvcmllczonLCBlcnJvcilcblxuICAgICAgICAgIC8vIExvZyBkZSBlcnJvciBkZSBzZWd1cmlkYWRcbiAgICAgICAgICBzZWN1cml0eUxvZ2dlci5sb2dBcGlFcnJvcihcbiAgICAgICAgICAgIHNlY3VyaXR5TG9nZ2VyLmNvbnRleHQsXG4gICAgICAgICAgICBuZXcgRXJyb3IoYERhdGFiYXNlIGVycm9yOiAke2Vycm9yLm1lc3NhZ2V9YCksXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIGVuZHBvaW50OiAnL2FwaS9jYXRlZ29yaWVzJyxcbiAgICAgICAgICAgICAgb3BlcmF0aW9uOiAnc2VsZWN0X2NhdGVnb3JpZXMnLFxuICAgICAgICAgICAgfVxuICAgICAgICAgIClcblxuICAgICAgICAgIGNvbnN0IGVycm9yUmVzcG9uc2U6IEFwaVJlc3BvbnNlPG51bGw+ID0ge1xuICAgICAgICAgICAgZGF0YTogbnVsbCxcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfHwgJ0Vycm9yIG9idGVuaWVuZG8gY2F0ZWdvcsOtYXMnLFxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oZXJyb3JSZXNwb25zZSwgeyBzdGF0dXM6IDUwMCB9KVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gUHJvY2VzYXIgZGF0b3MgcGFyYSBpbmNsdWlyIGNvbnRlbyBkZSBwcm9kdWN0b3NcbiAgICAgICAgY29uc3QgcHJvY2Vzc2VkQ2F0ZWdvcmllcyA9XG4gICAgICAgICAgY2F0ZWdvcmllcz8ubWFwKGNhdGVnb3J5ID0+ICh7XG4gICAgICAgICAgICAuLi5jYXRlZ29yeSxcbiAgICAgICAgICAgIHByb2R1Y3RzX2NvdW50OiBjYXRlZ29yeS5wcm9kdWN0c19jb3VudD8uWzBdPy5jb3VudCB8fCAwLFxuICAgICAgICAgIH0pKSB8fCBbXVxuXG4gICAgICAgIC8vIExvZyBkZSBvcGVyYWNpw7NuIGV4aXRvc2FcbiAgICAgICAgc2VjdXJpdHlMb2dnZXIubG9nKHtcbiAgICAgICAgICB0eXBlOiAnZGF0YV9hY2Nlc3MnLFxuICAgICAgICAgIHNldmVyaXR5OiAnbG93JyxcbiAgICAgICAgICBtZXNzYWdlOiAnQ2F0ZWdvcmllcyByZXRyaWV2ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgICAgICAgICBjb250ZXh0OiBzZWN1cml0eUxvZ2dlci5jb250ZXh0LFxuICAgICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgICBjYXRlZ29yaWVzQ291bnQ6IHByb2Nlc3NlZENhdGVnb3JpZXMubGVuZ3RoLFxuICAgICAgICAgICAgaGFzU2VhcmNoOiAhIWZpbHRlcnMuc2VhcmNoLFxuICAgICAgICAgICAgc2VhcmNoVGVybTogZmlsdGVycy5zZWFyY2gsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSlcblxuICAgICAgICBjb25zdCByZXNwb25zZTogQXBpUmVzcG9uc2U8Q2F0ZWdvcnlbXT4gPSB7XG4gICAgICAgICAgZGF0YTogcHJvY2Vzc2VkQ2F0ZWdvcmllcyxcbiAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgIG1lc3NhZ2U6IGAke3Byb2Nlc3NlZENhdGVnb3JpZXMubGVuZ3RofSBjYXRlZ29yw61hcyBlbmNvbnRyYWRhc2AsXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24ocmVzcG9uc2UpXG4gICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGVuIEdFVCAvYXBpL2NhdGVnb3JpZXM6JywgZXJyb3IpXG5cbiAgICAgICAgLy8gTG9nIGRlIGVycm9yIGRlIHNlZ3VyaWRhZFxuICAgICAgICBzZWN1cml0eUxvZ2dlci5sb2dBcGlFcnJvcihcbiAgICAgICAgICBzZWN1cml0eUxvZ2dlci5jb250ZXh0LFxuICAgICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvciA6IG5ldyBFcnJvcignVW5rbm93biBlcnJvcicpLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGVuZHBvaW50OiAnL2FwaS9jYXRlZ29yaWVzJyxcbiAgICAgICAgICB9XG4gICAgICAgIClcblxuICAgICAgICBjb25zdCBlcnJvclJlc3BvbnNlOiBBcGlSZXNwb25zZTxudWxsPiA9IHtcbiAgICAgICAgICBkYXRhOiBudWxsLFxuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlIHx8ICdFcnJvciBpbnRlcm5vIGRlbCBzZXJ2aWRvcicsXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oZXJyb3JSZXNwb25zZSwgeyBzdGF0dXM6IDUwMCB9KVxuICAgICAgfVxuICAgIH1cbiAgKVxuXG4gIC8vIE1hbmVqYXIgcmF0ZSBsaW1pdCBleGNlZGlkb1xuICBpZiAocmF0ZUxpbWl0UmVzdWx0IGluc3RhbmNlb2YgTmV4dFJlc3BvbnNlKSB7XG4gICAgc2VjdXJpdHlMb2dnZXIubG9nUmF0ZUxpbWl0RXhjZWVkZWQoc2VjdXJpdHlMb2dnZXIuY29udGV4dCwge1xuICAgICAgZW5kcG9pbnQ6ICcvYXBpL2NhdGVnb3JpZXMnLFxuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICB9KVxuICAgIHJldHVybiByYXRlTGltaXRSZXN1bHRcbiAgfVxuXG4gIHJldHVybiByYXRlTGltaXRSZXN1bHRcbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFBPU1QgL2FwaS9jYXRlZ29yaWVzIC0gQ3JlYXIgY2F0ZWdvcsOtYSAoQWRtaW4pXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIFBPU1QocmVxdWVzdDogTmV4dFJlcXVlc3QpIHtcbiAgdHJ5IHtcbiAgICAvLyBFTlRFUlBSSVNFOiBVc2FyIG51ZXZhIGF1dGVudGljYWNpw7NuIGVudGVycHJpc2UgcGFyYSBhZG1pblxuICAgIGNvbnN0IHsgcmVxdWlyZUFkbWluQXV0aCB9ID0gYXdhaXQgaW1wb3J0KCdAL2xpYi9hdXRoL2VudGVycHJpc2UtYXV0aC11dGlscycpXG5cbiAgICBjb25zdCBhdXRoUmVzdWx0ID0gYXdhaXQgcmVxdWlyZUFkbWluQXV0aChyZXF1ZXN0LCBbJ2NhdGVnb3JpZXNfY3JlYXRlJ10pXG5cbiAgICBpZiAoIWF1dGhSZXN1bHQuc3VjY2Vzcykge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7XG4gICAgICAgICAgZXJyb3I6IGF1dGhSZXN1bHQuZXJyb3IsXG4gICAgICAgICAgY29kZTogYXV0aFJlc3VsdC5jb2RlLFxuICAgICAgICAgIGVudGVycHJpc2U6IHRydWUsXG4gICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIH0sXG4gICAgICAgIHsgc3RhdHVzOiBhdXRoUmVzdWx0LnN0YXR1cyB8fCA0MDEgfVxuICAgICAgKVxuICAgIH1cblxuICAgIGNvbnN0IGNvbnRleHQgPSBhdXRoUmVzdWx0LmNvbnRleHQhXG5cbiAgICBjb25zdCBib2R5ID0gYXdhaXQgcmVxdWVzdC5qc29uKClcblxuICAgIC8vIFZhbGlkYXIgZGF0b3MgZGUgbGEgY2F0ZWdvcsOtYVxuICAgIGNvbnN0IGNhdGVnb3J5RGF0YSA9IHZhbGlkYXRlRGF0YShDYXRlZ29yeVNjaGVtYSwgYm9keSlcblxuICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2VDbGllbnQodHJ1ZSkgLy8gVXNhciBjbGllbnRlIGFkbWluXG5cbiAgICAvLyBWZXJpZmljYXIgcXVlIGVsIGNsaWVudGUgYWRtaW5pc3RyYXRpdm8gZXN0w6kgZGlzcG9uaWJsZVxuICAgIGlmICghc3VwYWJhc2UpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0NsaWVudGUgYWRtaW5pc3RyYXRpdm8gZGUgU3VwYWJhc2Ugbm8gZGlzcG9uaWJsZSBlbiBQT1NUIC9hcGkvY2F0ZWdvcmllcycpXG4gICAgICBjb25zdCBlcnJvclJlc3BvbnNlOiBBcGlSZXNwb25zZTxudWxsPiA9IHtcbiAgICAgICAgZGF0YTogbnVsbCxcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiAnU2VydmljaW8gYWRtaW5pc3RyYXRpdm8gbm8gZGlzcG9uaWJsZScsXG4gICAgICB9XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oZXJyb3JSZXNwb25zZSwgeyBzdGF0dXM6IDUwMyB9KVxuICAgIH1cblxuICAgIC8vIENyZWFyIHNsdWcgc2kgbm8gc2UgcHJvcG9yY2lvbmFcbiAgICBpZiAoIWNhdGVnb3J5RGF0YS5zbHVnKSB7XG4gICAgICBjYXRlZ29yeURhdGEuc2x1ZyA9IGNhdGVnb3J5RGF0YS5uYW1lXG4gICAgICAgIC50b0xvd2VyQ2FzZSgpXG4gICAgICAgIC5yZXBsYWNlKC9bXmEtejAtOV0rL2csICctJylcbiAgICAgICAgLnJlcGxhY2UoLyheLXwtJCkvZywgJycpXG4gICAgfVxuXG4gICAgLy8gSW5zZXJ0YXIgY2F0ZWdvcsOtYVxuICAgIGNvbnN0IHsgZGF0YTogY2F0ZWdvcnksIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgLmZyb20oJ2NhdGVnb3JpZXMnKVxuICAgICAgLmluc2VydChjYXRlZ29yeURhdGEpXG4gICAgICAuc2VsZWN0KClcbiAgICAgIC5zaW5nbGUoKVxuXG4gICAgaWYgKGVycm9yKSB7XG4gICAgICBoYW5kbGVTdXBhYmFzZUVycm9yKGVycm9yLCAnUE9TVCAvYXBpL2NhdGVnb3JpZXMnKVxuICAgIH1cblxuICAgIGNvbnN0IHJlc3BvbnNlOiBBcGlSZXNwb25zZTxDYXRlZ29yeT4gPSB7XG4gICAgICBkYXRhOiBjYXRlZ29yeSxcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBtZXNzYWdlOiAnQ2F0ZWdvcsOtYSBjcmVhZGEgZXhpdG9zYW1lbnRlJyxcbiAgICB9XG5cbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24ocmVzcG9uc2UsIHsgc3RhdHVzOiAyMDEgfSlcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGVuIFBPU1QgL2FwaS9jYXRlZ29yaWVzOicsIGVycm9yKVxuXG4gICAgY29uc3QgZXJyb3JSZXNwb25zZTogQXBpUmVzcG9uc2U8bnVsbD4gPSB7XG4gICAgICBkYXRhOiBudWxsLFxuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSB8fCAnRXJyb3IgaW50ZXJubyBkZWwgc2Vydmlkb3InLFxuICAgIH1cblxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihlcnJvclJlc3BvbnNlLCB7IHN0YXR1czogNTAwIH0pXG4gIH1cbn1cbiJdLCJuYW1lcyI6WyJHRVQiLCJQT1NUIiwicnVudGltZSIsInJlcXVlc3QiLCJzZWN1cml0eUxvZ2dlciIsImNyZWF0ZVNlY3VyaXR5TG9nZ2VyIiwicmF0ZUxpbWl0UmVzdWx0Iiwid2l0aFJhdGVMaW1pdCIsIlJBVEVfTElNSVRfQ09ORklHUyIsInByb2R1Y3RzIiwibG9nIiwidHlwZSIsInNldmVyaXR5IiwibWVzc2FnZSIsImNvbnRleHQiLCJtZXRhZGF0YSIsImVuZHBvaW50IiwibWV0aG9kIiwidXNlckFnZW50IiwiaGVhZGVycyIsImdldCIsInNlYXJjaFBhcmFtcyIsIlVSTCIsInVybCIsInF1ZXJ5UGFyYW1zIiwic2VhcmNoIiwidW5kZWZpbmVkIiwiZmlsdGVycyIsInN1cGFiYXNlIiwiZ2V0U3VwYWJhc2VDbGllbnQiLCJjb25zb2xlIiwiZXJyb3IiLCJlcnJvclJlc3BvbnNlIiwiZGF0YSIsInN1Y2Nlc3MiLCJOZXh0UmVzcG9uc2UiLCJqc29uIiwic3RhdHVzIiwiYmFzZVF1ZXJ5IiwiZnJvbSIsInNlbGVjdCIsIm9yZGVyIiwicXVlcnkiLCJpbGlrZSIsImNhdGVnb3JpZXMiLCJ3aXRoRGF0YWJhc2VUaW1lb3V0Iiwic2lnbmFsIiwiYWJvcnRTaWduYWwiLCJBUElfVElNRU9VVFMiLCJkYXRhYmFzZSIsImxvZ0FwaUVycm9yIiwiRXJyb3IiLCJvcGVyYXRpb24iLCJwcm9jZXNzZWRDYXRlZ29yaWVzIiwibWFwIiwiY2F0ZWdvcnkiLCJwcm9kdWN0c19jb3VudCIsImNvdW50IiwiY2F0ZWdvcmllc0NvdW50IiwibGVuZ3RoIiwiaGFzU2VhcmNoIiwic2VhcmNoVGVybSIsInJlc3BvbnNlIiwibG9nUmF0ZUxpbWl0RXhjZWVkZWQiLCJyZXF1aXJlQWRtaW5BdXRoIiwiYXV0aFJlc3VsdCIsImNvZGUiLCJlbnRlcnByaXNlIiwidGltZXN0YW1wIiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwiYm9keSIsImNhdGVnb3J5RGF0YSIsInZhbGlkYXRlRGF0YSIsIkNhdGVnb3J5U2NoZW1hIiwic2x1ZyIsIm5hbWUiLCJ0b0xvd2VyQ2FzZSIsInJlcGxhY2UiLCJpbnNlcnQiLCJzaW5nbGUiLCJoYW5kbGVTdXBhYmFzZUVycm9yIl0sIm1hcHBpbmdzIjoiQUFBQSxxQ0FBcUM7Ozs7Ozs7Ozs7OztRQXVCZkE7ZUFBQUE7O1FBNEpBQztlQUFBQTs7UUFsTFRDO2VBQUFBOzs7d0JBTTZCOzBCQUNhOzZCQUNhOzZCQU9sQjs2QkFDcUI7Z0NBQ2xDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFqQjlCLE1BQU1BLFVBQVU7QUFzQmhCLGVBQWVGLElBQUlHLE9BQW9CO0lBQzVDLHlDQUF5QztJQUN6QyxNQUFNQyxpQkFBaUJDLElBQUFBLG9DQUFvQixFQUFDRjtJQUU1QyxnREFBZ0Q7SUFDaEQsTUFBTUcsa0JBQWtCLE1BQU1DLElBQUFBLDBCQUFhLEVBQ3pDSixTQUNBSywrQkFBa0IsQ0FBQ0MsUUFBUSxFQUMzQjtRQUNFLHlCQUF5QjtRQUN6QkwsZUFBZU0sR0FBRyxDQUFDO1lBQ2pCQyxNQUFNO1lBQ05DLFVBQVU7WUFDVkMsU0FBUztZQUNUQyxTQUFTVixlQUFlVSxPQUFPO1lBQy9CQyxVQUFVO2dCQUNSQyxVQUFVO2dCQUNWQyxRQUFRO2dCQUNSQyxXQUFXZixRQUFRZ0IsT0FBTyxDQUFDQyxHQUFHLENBQUM7WUFDakM7UUFDRjtRQUVBLElBQUk7WUFDRixNQUFNLEVBQUVDLFlBQVksRUFB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