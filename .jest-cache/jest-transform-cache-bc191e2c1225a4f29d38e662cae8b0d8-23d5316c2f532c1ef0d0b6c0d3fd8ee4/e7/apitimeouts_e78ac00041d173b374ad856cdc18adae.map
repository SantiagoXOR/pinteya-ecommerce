{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\lib\\config\\api-timeouts.ts"],"sourcesContent":["// ===================================\r\n// PINTEYA E-COMMERCE - CONFIGURACIÓN CENTRALIZADA DE TIMEOUTS\r\n// ===================================\r\n// Configuración centralizada para todos los timeouts de APIs\r\n// con valores por defecto y variables de entorno\r\n\r\n// ===================================\r\n// TIPOS Y INTERFACES\r\n// ===================================\r\n\r\nexport interface TimeoutConfig {\r\n  default: number;\r\n  database: number;\r\n  external: number;\r\n  upload: number;\r\n  payment: number;\r\n  auth: number;\r\n  admin: number;\r\n  webhook: number;\r\n  email: number;\r\n  image: number;\r\n}\r\n\r\nexport interface EndpointTimeouts {\r\n  connection: number;\r\n  request: number;\r\n  response: number;\r\n  total: number;\r\n}\r\n\r\n// ===================================\r\n// CONFIGURACIÓN BASE DE TIMEOUTS\r\n// ===================================\r\n\r\nconst DEFAULT_TIMEOUTS = {\r\n  // Timeout por defecto para operaciones generales\r\n  default: 30000,        // 30 segundos\r\n  \r\n  // Timeout para operaciones de base de datos\r\n  database: 15000,       // 15 segundos\r\n  \r\n  // Timeout para APIs externas (MercadoPago, etc.)\r\n  external: 45000,       // 45 segundos\r\n  \r\n  // Timeout para uploads de archivos\r\n  upload: 120000,        // 2 minutos\r\n  \r\n  // Timeout para operaciones de pago\r\n  payment: 60000,        // 1 minuto\r\n  \r\n  // Timeout para operaciones de autenticación\r\n  auth: 20000,           // 20 segundos\r\n  \r\n  // Timeout para operaciones administrativas\r\n  admin: 45000,          // 45 segundos\r\n  \r\n  // Timeout para webhooks\r\n  webhook: 10000,        // 10 segundos\r\n  \r\n  // Timeout para envío de emails\r\n  email: 30000,          // 30 segundos\r\n  \r\n  // Timeout para procesamiento de imágenes\r\n  image: 90000,          // 1.5 minutos\r\n} as const;\r\n\r\n// ===================================\r\n// FUNCIÓN PARA OBTENER TIMEOUT DESDE ENV\r\n// ===================================\r\n\r\nfunction getTimeoutFromEnv(key: string, defaultValue: number): number {\r\n  const envValue = process.env[`API_TIMEOUT_${key.toUpperCase()}`];\r\n  if (!envValue) {return defaultValue;}\r\n  \r\n  const parsed = parseInt(envValue, 10);\r\n  if (isNaN(parsed) || parsed <= 0) {\r\n    console.warn(`[TIMEOUT_CONFIG] Invalid timeout value for ${key}: ${envValue}, using default: ${defaultValue}`);\r\n    return defaultValue;\r\n  }\r\n  \r\n  return parsed;\r\n}\r\n\r\n// ===================================\r\n// CONFIGURACIÓN FINAL DE TIMEOUTS\r\n// ===================================\r\n\r\nexport const API_TIMEOUTS: TimeoutConfig = {\r\n  default: getTimeoutFromEnv('DEFAULT', DEFAULT_TIMEOUTS.default),\r\n  database: getTimeoutFromEnv('DATABASE', DEFAULT_TIMEOUTS.database),\r\n  external: getTimeoutFromEnv('EXTERNAL', DEFAULT_TIMEOUTS.external),\r\n  upload: getTimeoutFromEnv('UPLOAD', DEFAULT_TIMEOUTS.upload),\r\n  payment: getTimeoutFromEnv('PAYMENT', DEFAULT_TIMEOUTS.payment),\r\n  auth: getTimeoutFromEnv('AUTH', DEFAULT_TIMEOUTS.auth),\r\n  admin: getTimeoutFromEnv('ADMIN', DEFAULT_TIMEOUTS.admin),\r\n  webhook: getTimeoutFromEnv('WEBHOOK', DEFAULT_TIMEOUTS.webhook),\r\n  email: getTimeoutFromEnv('EMAIL', DEFAULT_TIMEOUTS.email),\r\n  image: getTimeoutFromEnv('IMAGE', DEFAULT_TIMEOUTS.image),\r\n};\r\n\r\n// ===================================\r\n// TIMEOUTS ESPECÍFICOS POR ENDPOINT\r\n// ===================================\r\n\r\nexport const ENDPOINT_TIMEOUTS: Record<string, EndpointTimeouts> = {\r\n  // APIs de productos\r\n  '/api/products': {\r\n    connection: 5000,\r\n    request: API_TIMEOUTS.database,\r\n    response: 10000,\r\n    total: API_TIMEOUTS.database + 15000, // database + buffer\r\n  },\r\n\r\n  // APIs de órdenes\r\n  '/api/orders': {\r\n    connection: 5000,\r\n    request: API_TIMEOUTS.database,\r\n    response: 15000,\r\n    total: API_TIMEOUTS.database + 20000, // database + buffer\r\n  },\r\n  \r\n  // APIs de pagos\r\n  '/api/payments': {\r\n    connection: 10000,\r\n    request: API_TIMEOUTS.payment,\r\n    response: 20000,\r\n    total: Math.max(API_TIMEOUTS.payment + 30000, API_TIMEOUTS.external),\r\n  },\r\n\r\n  // APIs de autenticación\r\n  '/api/auth': {\r\n    connection: 3000,\r\n    request: API_TIMEOUTS.auth,\r\n    response: 5000,\r\n    total: API_TIMEOUTS.auth + 8000,\r\n  },\r\n\r\n  // APIs administrativas\r\n  '/api/admin': {\r\n    connection: 5000,\r\n    request: API_TIMEOUTS.admin,\r\n    response: 15000,\r\n    total: API_TIMEOUTS.admin + 20000,\r\n  },\r\n\r\n  // Webhooks\r\n  '/api/webhooks': {\r\n    connection: 2000,\r\n    request: API_TIMEOUTS.webhook,\r\n    response: 3000,\r\n    total: API_TIMEOUTS.webhook + 5000,\r\n  },\r\n\r\n  // APIs de upload\r\n  '/api/upload': {\r\n    connection: 10000,\r\n    request: API_TIMEOUTS.upload,\r\n    response: 30000,\r\n    total: API_TIMEOUTS.upload + 40000,\r\n  },\r\n};\r\n\r\n// ===================================\r\n// HELPERS PARA OBTENER TIMEOUTS\r\n// ===================================\r\n\r\n/**\r\n * Obtiene el timeout apropiado para un tipo de operación\r\n */\r\nexport function getTimeout(type: keyof TimeoutConfig): number {\r\n  return API_TIMEOUTS[type];\r\n}\r\n\r\n/**\r\n * Obtiene los timeouts específicos para un endpoint\r\n */\r\nexport function getEndpointTimeouts(path: string): EndpointTimeouts {\r\n  // Buscar coincidencia exacta primero\r\n  if (ENDPOINT_TIMEOUTS[path]) {\r\n    return ENDPOINT_TIMEOUTS[path];\r\n  }\r\n  \r\n  // Buscar coincidencia por prefijo\r\n  const matchingPath = Object.keys(ENDPOINT_TIMEOUTS).find(key => \r\n    path.startsWith(key)\r\n  );\r\n  \r\n  if (matchingPath) {\r\n    return ENDPOINT_TIMEOUTS[matchingPath];\r\n  }\r\n  \r\n  // Fallback a timeouts por defecto\r\n  return {\r\n    connection: 5000,\r\n    request: API_TIMEOUTS.default,\r\n    response: 10000,\r\n    total: API_TIMEOUTS.default,\r\n  };\r\n}\r\n\r\n/**\r\n * Crea un AbortController con timeout automático\r\n */\r\nexport function createTimeoutController(timeout: number): {\r\n  controller: AbortController;\r\n  timeoutId: NodeJS.Timeout;\r\n} {\r\n  const controller = new AbortController();\r\n  const timeoutId = setTimeout(() => {\r\n    controller.abort();\r\n  }, timeout);\r\n  \r\n  return { controller, timeoutId };\r\n}\r\n\r\n/**\r\n * Wrapper para fetch con timeout automático\r\n */\r\nexport async function fetchWithTimeout(\r\n  url: string,\r\n  options: RequestInit & { timeout?: number } = {}\r\n): Promise<Response> {\r\n  const timeout = options.timeout || API_TIMEOUTS.default;\r\n  const { controller, timeoutId } = createTimeoutController(timeout);\r\n  \r\n  try {\r\n    const response = await fetch(url, {\r\n      ...options,\r\n      signal: controller.signal,\r\n    });\r\n    \r\n    clearTimeout(timeoutId);\r\n    return response;\r\n  } catch (error) {\r\n    clearTimeout(timeoutId);\r\n    \r\n    if (error instanceof Error && error.name === 'AbortError') {\r\n      throw new Error(`Request timeout after ${timeout}ms`);\r\n    }\r\n    \r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Wrapper para operaciones de base de datos con timeout\r\n */\r\nexport function withDatabaseTimeout<T>(\r\n  operation: (signal: AbortSignal) => Promise<T>,\r\n  timeout: number = API_TIMEOUTS.database\r\n): Promise<T> {\r\n  const { controller, timeoutId } = createTimeoutController(timeout);\r\n  \r\n  return operation(controller.signal)\r\n    .finally(() => clearTimeout(timeoutId));\r\n}\r\n\r\n/**\r\n * Wrapper para operaciones externas con timeout\r\n */\r\nexport function withExternalTimeout<T>(\r\n  operation: (signal: AbortSignal) => Promise<T>,\r\n  timeout: number = API_TIMEOUTS.external\r\n): Promise<T> {\r\n  const { controller, timeoutId } = createTimeoutController(timeout);\r\n\r\n  return operation(controller.signal)\r\n    .finally(() => clearTimeout(timeoutId));\r\n}\r\n\r\n/**\r\n * Wrapper genérico para operaciones con timeout\r\n */\r\nexport function withTimeout<T>(\r\n  operation: () => Promise<T>,\r\n  timeout: number = API_TIMEOUTS.default\r\n): Promise<T> {\r\n  return new Promise((resolve, reject) => {\r\n    const timeoutId = setTimeout(() => {\r\n      reject(new Error(`Operation timeout after ${timeout}ms`));\r\n    }, timeout);\r\n\r\n    operation()\r\n      .then(resolve)\r\n      .catch(reject)\r\n      .finally(() => clearTimeout(timeoutId));\r\n  });\r\n}\r\n\r\n// ===================================\r\n// CONFIGURACIÓN DE LOGGING\r\n// ===================================\r\n\r\n/**\r\n * Log de timeout configurado\r\n */\r\nexport function logTimeoutConfig(): void {\r\n  console.log('[TIMEOUT_CONFIG] Configuración de timeouts cargada:', {\r\n    environment: process.env.NODE_ENV,\r\n    timeouts: API_TIMEOUTS,\r\n    customEnvVars: Object.keys(process.env)\r\n      .filter(key => key.startsWith('API_TIMEOUT_'))\r\n      .reduce((acc, key) => {\r\n        acc[key] = process.env[key];\r\n        return acc;\r\n      }, {} as Record<string, string | undefined>),\r\n  });\r\n}\r\n\r\n// ===================================\r\n// VALIDACIÓN DE CONFIGURACIÓN\r\n// ===================================\r\n\r\n/**\r\n * Valida que todos los timeouts estén configurados correctamente\r\n */\r\nexport function validateTimeoutConfig(): boolean {\r\n  const errors: string[] = [];\r\n  \r\n  Object.entries(API_TIMEOUTS).forEach(([key, value]) => {\r\n    if (typeof value !== 'number' || value <= 0) {\r\n      errors.push(`Invalid timeout for ${key}: ${value}`);\r\n    }\r\n    \r\n    if (value > 300000) { // 5 minutos máximo\r\n      errors.push(`Timeout too high for ${key}: ${value}ms (max: 300000ms)`);\r\n    }\r\n  });\r\n  \r\n  if (errors.length > 0) {\r\n    console.error('[TIMEOUT_CONFIG] Validation errors:', errors);\r\n    return false;\r\n  }\r\n  \r\n  return true;\r\n}\r\n\r\n// ===================================\r\n// INICIALIZACIÓN\r\n// ===================================\r\n\r\n// Validar configuración al cargar el módulo\r\nif (process.env.NODE_ENV !== 'test') {\r\n  validateTimeoutConfig();\r\n  \r\n  if (process.env.NODE_ENV === 'development') {\r\n    logTimeoutConfig();\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"names":["API_TIMEOUTS","ENDPOINT_TIMEOUTS","createTimeoutController","fetchWithTimeout","getEndpointTimeouts","getTimeout","logTimeoutConfig","validateTimeoutConfig","withDatabaseTimeout","withExternalTimeout","withTimeout","DEFAULT_TIMEOUTS","default","database","external","upload","payment","auth","admin","webhook","email","image","getTimeoutFromEnv","key","defaultValue","envValue","process","env","toUpperCase","parsed","parseInt","isNaN","console","warn","connection","request","response","total","Math","max","type","path","matchingPath","Object","keys","find","startsWith","timeout","controller","AbortController","timeoutId","setTimeout","abort","url","options","fetch","signal","clearTimeout","error","Error","name","operation","finally","Promise","resolve","reject","then","catch","log","environment","NODE_ENV","timeouts","customEnvVars","filter","reduce","acc","errors","entries","forEach","value","push","length"],"mappings":"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"}