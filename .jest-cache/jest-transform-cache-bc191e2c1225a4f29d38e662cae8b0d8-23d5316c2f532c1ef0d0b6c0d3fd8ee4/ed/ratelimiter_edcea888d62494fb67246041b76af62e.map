{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\lib\\rate-limiting\\rate-limiter.ts"],"sourcesContent":["// ===================================\n// PINTEYA E-COMMERCE - RATE LIMITING MIDDLEWARE\n// ===================================\n// Sistema de rate limiting enterprise con configuración flexible\n// y logging estructurado para APIs críticas\n\nimport { NextRequest, NextResponse } from 'next/server'\nimport { headers } from 'next/headers'\n\n// ===================================\n// TIPOS Y INTERFACES\n// ===================================\n\nexport interface RateLimitConfig {\n  windowMs: number // Ventana de tiempo en milisegundos\n  maxRequests: number // Máximo de requests por ventana\n  keyGenerator?: (req: NextRequest) => string // Generador de clave personalizado\n  skipSuccessfulRequests?: boolean // Omitir requests exitosos\n  skipFailedRequests?: boolean // Omitir requests fallidos\n  message?: string // Mensaje de error personalizado\n  headers?: boolean // Incluir headers de rate limit\n  standardHeaders?: boolean // Usar headers estándar RFC\n  legacyHeaders?: boolean // Incluir headers legacy\n}\n\nexport interface RateLimitResult {\n  allowed: boolean\n  limit: number\n  remaining: number\n  resetTime: number\n  retryAfter?: number\n}\n\nexport interface RateLimitStore {\n  get(key: string): Promise<{ count: number; resetTime: number } | null>\n  set(key: string, value: { count: number; resetTime: number }, ttl: number): Promise<void>\n  increment(key: string, ttl: number): Promise<{ count: number; resetTime: number }>\n}\n\n// ===================================\n// CONFIGURACIONES PREDEFINIDAS\n// ===================================\n\n// Configuraciones base para producción\nconst PRODUCTION_CONFIGS = {\n  public: {\n    windowMs: 15 * 60 * 1000, // 15 minutos\n    maxRequests: 1000, // 1000 requests por ventana\n    message: 'Demasiadas solicitudes. Intente nuevamente en 15 minutos.',\n  },\n  products: {\n    windowMs: 5 * 60 * 1000, // 5 minutos\n    maxRequests: 200, // 200 requests por ventana\n    message: 'Límite de consultas de productos excedido. Intente en 5 minutos.',\n  },\n  search: {\n    windowMs: 5 * 60 * 1000, // 5 minutos\n    maxRequests: 150, // 150 requests por ventana\n    message: 'Límite de búsquedas excedido. Intente en 5 minutos.',\n  },\n}\n\n// Configuraciones relajadas para desarrollo\nconst DEVELOPMENT_CONFIGS = {\n  public: {\n    windowMs: 15 * 60 * 1000, // 15 minutos\n    maxRequests: 10000, // 10000 requests por ventana (muy generoso)\n    message: 'Demasiadas solicitudes. Intente nuevamente en 15 minutos.',\n  },\n  products: {\n    windowMs: 1 * 60 * 1000, // 1 minuto\n    maxRequests: 1000, // 1000 requests por minuto (muy generoso)\n    message: 'Límite de consultas de productos excedido. Intente en 1 minuto.',\n  },\n  search: {\n    windowMs: 1 * 60 * 1000, // 1 minuto\n    maxRequests: 500, // 500 requests por minuto (muy generoso)\n    message: 'Límite de búsquedas excedido. Intente en 1 minuto.',\n  },\n}\n\n// ===================================\n// HELPER PARA VERIFICAR SI RATE LIMITING ESTÁ HABILITADO\n// ===================================\n\nfunction isRateLimitingEnabled(): boolean {\n  // Permitir deshabilitar rate limiting en desarrollo con variable de entorno\n  if (process.env.DISABLE_RATE_LIMITING === 'true') {\n    return false\n  }\n\n  // En desarrollo, usar rate limiting relajado pero habilitado por defecto\n  return true\n}\n\n// Seleccionar configuración según el entorno\nconst isDevelopment = process.env.NODE_ENV === 'development'\nconst baseConfigs = isDevelopment ? DEVELOPMENT_CONFIGS : PRODUCTION_CONFIGS\n\nexport const RATE_LIMIT_CONFIGS = {\n  // APIs públicas - límites generosos\n  public: baseConfigs.public,\n\n  // APIs de productos - límites moderados\n  products: baseConfigs.products,\n\n  // APIs de búsqueda - límites moderados\n  search: baseConfigs.search,\n\n  // APIs de autenticación - límites estrictos\n  auth: {\n    windowMs: 15 * 60 * 1000, // 15 minutos\n    maxRequests: isDevelopment ? 100 : 10, // 100 en dev, 10 en prod\n    message: 'Demasiados intentos de autenticación. Intente en 15 minutos.',\n  },\n\n  // APIs de admin - límites moderados pero monitoreados\n  admin: {\n    windowMs: 10 * 60 * 1000, // 10 minutos\n    maxRequests: isDevelopment ? 1000 : 100, // 1000 en dev, 100 en prod\n    message: 'Límite de operaciones administrativas excedido.',\n  },\n\n  // APIs de pagos - límites muy estrictos\n  payment: {\n    windowMs: 15 * 60 * 1000, // 15 minutos\n    maxRequests: isDevelopment ? 100 : 30, // 100 en dev, 30 en prod\n    message: 'Límite de operaciones de pago excedido. Intente en 15 minutos.',\n  },\n\n  // APIs de creación - límites estrictos\n  creation: {\n    windowMs: 10 * 60 * 1000, // 10 minutos\n    maxRequests: isDevelopment ? 200 : 20, // 200 en dev, 20 en prod\n    message: 'Límite de creación de recursos excedido.',\n  },\n\n  // Webhooks - límites rápidos pero altos\n  webhook: {\n    windowMs: 1 * 60 * 1000, // 1 minuto\n    maxRequests: isDevelopment ? 1000 : 100, // 1000 en dev, 100 en prod\n    message: 'Límite de webhooks excedido. Intente en 1 minuto.',\n  },\n} as const\n\n// ===================================\n// LOGGING DE CONFIGURACIÓN\n// ===================================\n\n// Log de configuración al cargar el módulo\nif (process.env.NODE_ENV === 'development') {\n  console.log('[RATE_LIMITER] Configuración cargada:', {\n    environment: process.env.NODE_ENV,\n    rateLimitingEnabled: isRateLimitingEnabled(),\n    disableRateLimiting: process.env.DISABLE_RATE_LIMITING,\n    productLimits: {\n      windowMs: RATE_LIMIT_CONFIGS.products.windowMs / 1000 / 60 + ' minutos',\n      maxRequests: RATE_LIMIT_CONFIGS.products.maxRequests,\n    },\n    searchLimits: {\n      windowMs: RATE_LIMIT_CONFIGS.search.windowMs / 1000 / 60 + ' minutos',\n      maxRequests: RATE_LIMIT_CONFIGS.search.maxRequests,\n    },\n  })\n}\n\n// ===================================\n// STORE EN MEMORIA (PARA DESARROLLO)\n// ===================================\n\nclass MemoryStore implements RateLimitStore {\n  private store = new Map<string, { count: number; resetTime: number }>()\n\n  async get(key: string): Promise<{ count: number; resetTime: number } | null> {\n    const data = this.store.get(key)\n    if (!data) {\n      return null\n    }\n\n    // Limpiar datos expirados\n    if (Date.now() > data.resetTime) {\n      this.store.delete(key)\n      return null\n    }\n\n    return data\n  }\n\n  async set(key: string, value: { count: number; resetTime: number }, ttl: number): Promise<void> {\n    this.store.set(key, value)\n\n    // Limpiar automáticamente después del TTL\n    setTimeout(() => {\n      this.store.delete(key)\n    }, ttl)\n  }\n\n  async increment(key: string, ttl: number): Promise<{ count: number; resetTime: number }> {\n    const now = Date.now()\n    const existing = await this.get(key)\n\n    if (!existing) {\n      const newData = { count: 1, resetTime: now + ttl }\n      await this.set(key, newData, ttl)\n      return newData\n    }\n\n    const updatedData = { ...existing, count: existing.count + 1 }\n    await this.set(key, updatedData, existing.resetTime - now)\n    return updatedData\n  }\n}\n\n// ===================================\n// INSTANCIA GLOBAL DEL STORE\n// ===================================\n\nconst defaultStore = new MemoryStore()\n\n// ===================================\n// GENERADORES DE CLAVE\n// ===================================\n\nexport const keyGenerators = {\n  // Por IP\n  ip: (req: NextRequest): string => {\n    const forwarded = req.headers.get('x-forwarded-for')\n    const ip = forwarded ? forwarded.split(',')[0] : req.headers.get('x-real-ip') || 'unknown'\n    return `ip:${ip}`\n  },\n\n  // Por usuario autenticado (requiere implementación específica)\n  user: (req: NextRequest): string => {\n    // TODO: Implementar extracción de user ID desde token/session\n    const userId = req.headers.get('x-user-id') || 'anonymous'\n    return `user:${userId}`\n  },\n\n  // Por endpoint específico\n  endpoint: (req: NextRequest): string => {\n    const url = new URL(req.url)\n    return `endpoint:${url.pathname}`\n  },\n\n  // Combinado IP + endpoint\n  combined: (req: NextRequest): string => {\n    const ip = keyGenerators.ip(req)\n    const endpoint = keyGenerators.endpoint(req)\n    return `${ip}:${endpoint}`\n  },\n}\n\n// ===================================\n// FACTORY PARA CREAR RATE LIMITERS\n// ===================================\n\n/**\n * Crea un rate limiter con configuración específica\n */\nexport function createRateLimiter(\n  config: Partial<RateLimitConfig> = {},\n  store: RateLimitStore = defaultStore\n) {\n  const finalConfig: RateLimitConfig = {\n    windowMs: 15 * 60 * 1000, // 15 minutos por defecto\n    maxRequests: 100, // 100 requests por defecto\n    message: 'Rate limit exceeded',\n    headers: true,\n    standardHeaders: true,\n    legacyHeaders: true,\n    ...config,\n  }\n\n  return async (req: NextRequest): Promise<RateLimitResult> => {\n    return await checkRateLimit(req, finalConfig, store)\n  }\n}\n\n// ===================================\n// FUNCIÓN PRINCIPAL DE RATE LIMITING\n// ===================================\n\nexport async function checkRateLimit(\n  req: NextRequest,\n  config: RateLimitConfig,\n  store: RateLimitStore = defaultStore\n): Promise<RateLimitResult> {\n  const keyGenerator = config.keyGenerator || keyGenerators.combined\n  const key = keyGenerator(req)\n\n  try {\n    const data = await store.increment(key, config.windowMs)\n\n    const result: RateLimitResult = {\n      allowed: data.count <= config.maxRequests,\n      limit: config.maxRequests,\n      remaining: Math.max(0, config.maxRequests - data.count),\n      resetTime: data.resetTime,\n    }\n\n    if (!result.allowed) {\n      result.retryAfter = Math.ceil((data.resetTime - Date.now()) / 1000)\n    }\n\n    return result\n  } catch (error) {\n    console.error('[RATE_LIMITER] Error checking rate limit:', error)\n\n    // En caso de error, permitir la request (fail-open)\n    return {\n      allowed: true,\n      limit: config.maxRequests,\n      remaining: config.maxRequests,\n      resetTime: Date.now() + config.windowMs,\n    }\n  }\n}\n\n// ===================================\n// MIDDLEWARE DE RATE LIMITING\n// ===================================\n\nexport function createRateLimitMiddleware(config: RateLimitConfig) {\n  return async (req: NextRequest): Promise<NextResponse | null> => {\n    const result = await checkRateLimit(req, config)\n\n    // Crear headers de rate limit\n    const headers = new Headers()\n\n    if (config.headers !== false) {\n      if (config.standardHeaders !== false) {\n        // Headers estándar RFC 6585\n        headers.set('RateLimit-Limit', result.limit.toString())\n        headers.set('RateLimit-Remaining', result.remaining.toString())\n        headers.set('RateLimit-Reset', new Date(result.resetTime).toISOString())\n      }\n\n      if (config.legacyHeaders !== false) {\n        // Headers legacy para compatibilidad\n        headers.set('X-RateLimit-Limit', result.limit.toString())\n        headers.set('X-RateLimit-Remaining', result.remaining.toString())\n        headers.set('X-RateLimit-Reset', Math.ceil(result.resetTime / 1000).toString())\n      }\n    }\n\n    if (!result.allowed) {\n      if (result.retryAfter) {\n        headers.set('Retry-After', result.retryAfter.toString())\n      }\n\n      // Log del rate limit excedido\n      console.warn('[RATE_LIMITER] Rate limit exceeded:', {\n        key: config.keyGenerator ? config.keyGenerator(req) : 'combined',\n        limit: result.limit,\n        resetTime: new Date(result.resetTime).toISOString(),\n        userAgent: req.headers.get('user-agent'),\n        ip: req.headers.get('x-forwarded-for') || req.headers.get('x-real-ip'),\n      })\n\n      return new NextResponse(\n        JSON.stringify({\n          error: 'Rate limit exceeded',\n          message: config.message || 'Too many requests',\n          retryAfter: result.retryAfter,\n        }),\n        {\n          status: 429,\n          headers,\n        }\n      )\n    }\n\n    // Request permitida, agregar headers informativos\n    return NextResponse.next({\n      headers,\n    })\n  }\n}\n\n// ===================================\n// HELPER PARA APLICAR RATE LIMITING\n// ===================================\n\nexport async function withRateLimit<T>(\n  req: NextRequest,\n  config: RateLimitConfig,\n  handler: () => Promise<T>\n): Promise<T | NextResponse> {\n  // Si rate limiting está deshabilitado, ejecutar directamente el handler\n  if (!isRateLimitingEnabled()) {\n    return await handler()\n  }\n\n  const result = await checkRateLimit(req, config)\n\n  if (!result.allowed) {\n    // Crear headers de rate limit\n    const headers = new Headers()\n\n    if (config.headers !== false) {\n      if (config.standardHeaders !== false) {\n        // Headers estándar RFC 6585\n        headers.set('RateLimit-Limit', result.limit.toString())\n        headers.set('RateLimit-Remaining', result.remaining.toString())\n        headers.set('RateLimit-Reset', new Date(result.resetTime).toISOString())\n      }\n\n      if (config.legacyHeaders !== false) {\n        // Headers legacy para compatibilidad\n        headers.set('X-RateLimit-Limit', result.limit.toString())\n        headers.set('X-RateLimit-Remaining', result.remaining.toString())\n        headers.set('X-RateLimit-Reset', Math.ceil(result.resetTime / 1000).toString())\n      }\n    }\n\n    if (result.retryAfter) {\n      headers.set('Retry-After', result.retryAfter.toString())\n    }\n\n    // Log del rate limit excedido\n    console.warn('[RATE_LIMITER] Rate limit exceeded:', {\n      key: config.keyGenerator ? config.keyGenerator(req) : 'combined',\n      limit: result.limit,\n      resetTime: new Date(result.resetTime).toISOString(),\n      userAgent: req.headers.get('user-agent'),\n      ip: req.headers.get('x-forwarded-for') || req.headers.get('x-real-ip'),\n    })\n\n    return new NextResponse(\n      JSON.stringify({\n        error: 'Rate limit exceeded',\n        message: config.message || 'Too many requests',\n        retryAfter: result.retryAfter,\n      }),\n      {\n        status: 429,\n        headers,\n      }\n    )\n  }\n\n  return handler()\n}\n"],"names":["RATE_LIMIT_CONFIGS","checkRateLimit","createRateLimitMiddleware","createRateLimiter","keyGenerators","withRateLimit","PRODUCTION_CONFIGS","public","windowMs","maxRequests","message","products","search","DEVELOPMENT_CONFIGS","isRateLimitingEnabled","process","env","DISABLE_RATE_LIMITING","isDevelopment","NODE_ENV","baseConfigs","auth","admin","payment","creation","webhook","console","log","environment","rateLimitingEnabled","disableRateLimiting","productLimits","searchLimits","MemoryStore","get","key","data","store","Date","now","resetTime","delete","set","value","ttl","setTimeout","increment","existing","newData","count","updatedData","Map","defaultStore","ip","req","forwarded","headers","split","user","userId","endpoint","url","URL","pathname","combined","config","finalConfig","standardHeaders","legacyHeaders","keyGenerator","result","allowed","limit","remaining","Math","max","retryAfter","ceil","error","Headers","toString","toISOString","warn","userAgent","NextResponse","JSON","stringify","status","next","handler"],"mappings":"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"}