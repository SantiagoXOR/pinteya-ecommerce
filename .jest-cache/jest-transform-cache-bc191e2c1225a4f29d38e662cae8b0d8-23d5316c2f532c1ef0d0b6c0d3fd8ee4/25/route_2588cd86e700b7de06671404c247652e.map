{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\app\\api\\brands\\route.ts"],"sourcesContent":["// Configuración para Node.js Runtime\r\nexport const runtime = 'nodejs';\r\n\r\n// ===================================\r\n// PINTEYA E-COMMERCE - API DE MARCAS\r\n// ===================================\r\n\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport { getSupabaseClient, handleSupabaseError } from '@/lib/integrations/supabase';\r\nimport { ApiResponse } from '@/types/api';\r\n\r\n// ===================================\r\n// TIPOS PARA MARCAS\r\n// ===================================\r\nexport interface Brand {\r\n  name: string;\r\n  products_count: number;\r\n}\r\n\r\nexport interface BrandFilters {\r\n  search?: string;\r\n  minProducts?: number;\r\n}\r\n\r\n// ===================================\r\n// GET /api/brands - Obtener marcas disponibles\r\n// ===================================\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const { searchParams } = new URL(request.url);\r\n    \r\n    // Extraer parámetros de query\r\n    const filters: BrandFilters = {\r\n      search: searchParams.get('search') || undefined,\r\n      minProducts: searchParams.get('minProducts') ? Number(searchParams.get('minProducts')) : 1,\r\n    };\r\n    \r\n    const supabase = getSupabaseClient();\r\n\r\n    // Verificar que el cliente de Supabase esté disponible\r\n    if (!supabase) {\r\n      console.error('Cliente de Supabase no disponible en GET /api/brands');\r\n      const errorResponse: ApiResponse<null> = {\r\n        data: null,\r\n        success: false,\r\n        error: 'Servicio de base de datos no disponible',\r\n      };\r\n      return NextResponse.json(errorResponse, { status: 503 });\r\n    }\r\n\r\n    // Construir query para obtener marcas con conteo de productos\r\n    let query = supabase\r\n      .from('products')\r\n      .select('brand')\r\n      .not('brand', 'is', null)\r\n      .gt('stock', 0); // Solo productos con stock\r\n\r\n    // Aplicar filtro de búsqueda si existe\r\n    if (filters.search) {\r\n      query = query.ilike('brand', `%${filters.search}%`);\r\n    }\r\n\r\n    // Ejecutar query\r\n    const { data: products, error } = await query;\r\n\r\n    if (error) {\r\n      handleSupabaseError(error, 'GET /api/brands');\r\n    }\r\n\r\n    // Procesar datos para obtener marcas únicas con conteo\r\n    const brandCounts: Record<string, number> = {};\r\n    \r\n    products?.forEach(product => {\r\n      if (product.brand) {\r\n        brandCounts[product.brand] = (brandCounts[product.brand] || 0) + 1;\r\n      }\r\n    });\r\n\r\n    // Convertir a array y filtrar por mínimo de productos\r\n    const brands: Brand[] = Object.entries(brandCounts)\r\n      .filter(([_, count]) => count >= (filters.minProducts || 1))\r\n      .map(([name, products_count]) => ({\r\n        name,\r\n        products_count,\r\n      }))\r\n      .sort((a, b) => {\r\n        // Ordenar por número de productos (descendente) y luego por nombre\r\n        if (a.products_count !== b.products_count) {\r\n          return b.products_count - a.products_count;\r\n        }\r\n        return a.name.localeCompare(b.name);\r\n      });\r\n\r\n    const response: ApiResponse<Brand[]> = {\r\n      data: brands,\r\n      success: true,\r\n      message: `${brands.length} marcas encontradas`,\r\n    };\r\n\r\n    return NextResponse.json(response);\r\n\r\n  } catch (error: any) {\r\n    console.error('Error en GET /api/brands:', error);\r\n    \r\n    const errorResponse: ApiResponse<null> = {\r\n      data: null,\r\n      success: false,\r\n      error: error.message || 'Error interno del servidor',\r\n    };\r\n\r\n    return NextResponse.json(errorResponse, { status: 500 });\r\n  }\r\n}\r\n\r\n// ===================================\r\n// GET /api/brands/stats - Estadísticas de marcas\r\n// ===================================\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const supabase = getSupabaseClient();\r\n\r\n    if (!supabase) {\r\n      console.error('Cliente de Supabase no disponible en POST /api/brands');\r\n      const errorResponse: ApiResponse<null> = {\r\n        data: null,\r\n        success: false,\r\n        error: 'Servicio de base de datos no disponible',\r\n      };\r\n      return NextResponse.json(errorResponse, { status: 503 });\r\n    }\r\n\r\n    // Obtener estadísticas detalladas de marcas\r\n    const { data: products, error } = await supabase\r\n      .from('products')\r\n      .select('brand, price, discounted_price, stock, category_id')\r\n      .not('brand', 'is', null);\r\n\r\n    if (error) {\r\n      handleSupabaseError(error, 'POST /api/brands (stats)');\r\n    }\r\n\r\n    // Calcular estadísticas por marca\r\n    const brandStats: Record<string, {\r\n      name: string;\r\n      products_count: number;\r\n      total_stock: number;\r\n      avg_price: number;\r\n      min_price: number;\r\n      max_price: number;\r\n      discounted_products: number;\r\n    }> = {};\r\n\r\n    products?.forEach(product => {\r\n      if (product.brand) {\r\n        if (!brandStats[product.brand]) {\r\n          brandStats[product.brand] = {\r\n            name: product.brand,\r\n            products_count: 0,\r\n            total_stock: 0,\r\n            avg_price: 0,\r\n            min_price: Infinity,\r\n            max_price: 0,\r\n            discounted_products: 0,\r\n          };\r\n        }\r\n\r\n        const stats = brandStats[product.brand];\r\n        const currentPrice = product.discounted_price || product.price;\r\n\r\n        stats.products_count++;\r\n        stats.total_stock += product.stock || 0;\r\n        stats.min_price = Math.min(stats.min_price, currentPrice);\r\n        stats.max_price = Math.max(stats.max_price, currentPrice);\r\n        \r\n        if (product.discounted_price && product.discounted_price < product.price) {\r\n          stats.discounted_products++;\r\n        }\r\n      }\r\n    });\r\n\r\n    // Calcular precio promedio y finalizar estadísticas\r\n    const finalStats = Object.values(brandStats).map(stats => {\r\n      const brandProducts = products?.filter(p => p.brand === stats.name) || [];\r\n      const totalPrice = brandProducts.reduce((sum, p) => sum + (p.discounted_price || p.price), 0);\r\n      \r\n      return {\r\n        ...stats,\r\n        avg_price: Math.round(totalPrice / stats.products_count),\r\n        min_price: stats.min_price === Infinity ? 0 : stats.min_price,\r\n      };\r\n    }).sort((a, b) => b.products_count - a.products_count);\r\n\r\n    const response: ApiResponse<typeof finalStats> = {\r\n      data: finalStats,\r\n      success: true,\r\n      message: `Estadísticas de ${finalStats.length} marcas calculadas`,\r\n    };\r\n\r\n    return NextResponse.json(response);\r\n\r\n  } catch (error: any) {\r\n    console.error('Error en POST /api/brands (stats):', error);\r\n    \r\n    const errorResponse: ApiResponse<null> = {\r\n      data: null,\r\n      success: false,\r\n      error: error.message || 'Error interno del servidor',\r\n    };\r\n\r\n    return NextResponse.json(errorResponse, { status: 500 });\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"names":["GET","POST","runtime","request","searchParams","URL","url","filters","search","get","undefined","minProducts","Number","supabase","getSupabaseClient","console","error","errorResponse","data","success","NextResponse","json","status","query","from","select","not","gt","ilike","products","handleSupabaseError","brandCounts","forEach","product","brand","brands","Object","entries","filter","_","count","map","name","products_count","sort","a","b","localeCompare","response","message","length","brandStats","total_stock","avg_price","min_price","Infinity","max_price","discounted_products","stats","currentPrice","discounted_price","price","stock","Math","min","max","finalStats","values","brandProducts","p","totalPrice","reduce","sum","round"],"mappings":"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"}