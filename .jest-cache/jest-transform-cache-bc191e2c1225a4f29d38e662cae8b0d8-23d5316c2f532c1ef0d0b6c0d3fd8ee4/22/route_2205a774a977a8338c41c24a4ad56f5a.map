{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\app\\api\\debug\\check-admin-access\\route.ts"],"sourcesContent":["// Configuraci√≥n para Node.js Runtime\r\nexport const runtime = 'nodejs';\r\n\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport { checkAdminAccess, getAuthenticatedAdmin } from '@/lib/auth/admin-auth';\r\nimport {\r\n  requireAdminAuth,\r\n  getEnterpriseAuthContext\r\n} from '@/lib/auth/enterprise-auth-utils';\r\nimport {\r\n  validateRLSContext\r\n} from '@/lib/auth/enterprise-rls-utils';\r\nimport {\r\n  getCacheStats\r\n} from '@/lib/auth/enterprise-cache';\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    // ENTERPRISE: Usar nueva autenticaci√≥n enterprise para comparaci√≥n\r\n    const enterpriseResult = await requireAdminAuth(request, ['admin_access']);\r\n\r\n    // LEGACY: Mantener m√©todo anterior para comparaci√≥n\r\n    const adminResult = await getAuthenticatedAdmin(request);\r\n\r\n    if (!adminResult.userId && !enterpriseResult.success) {\r\n      return NextResponse.json({\r\n        success: false,\r\n        error: 'Usuario no autenticado en ning√∫n m√©todo',\r\n        enterprise: {\r\n          error: enterpriseResult.error,\r\n          code: enterpriseResult.code\r\n        },\r\n        legacy: {\r\n          error: adminResult.error\r\n        },\r\n        migration: {\r\n          status: 'ENTERPRISE_MIGRATED',\r\n          comparison: 'Both methods failed - user not authenticated'\r\n        }\r\n      }, { status: 401 });\r\n    }\r\n\r\n    // ENTERPRISE: Obtener contexto completo y validaci√≥n RLS\r\n    let enterpriseContext = null;\r\n    let rlsValidation = null;\r\n\r\n    if (enterpriseResult.success) {\r\n      enterpriseContext = enterpriseResult.context;\r\n      rlsValidation = await validateRLSContext(enterpriseContext!);\r\n    }\r\n\r\n    // LEGACY: Comparar con m√©todo legacy para verificar migraci√≥n\r\n    const clerkUserId = adminResult.userId || (enterpriseResult.success ? enterpriseResult.context!.userId : null);\r\n\r\n    console.log('üîç Debug Enterprise vs Legacy: Testing with user:', clerkUserId);\r\n\r\n    const legacyResult = clerkUserId ? await checkAdminAccess(clerkUserId) : { success: false, error: 'No user ID' };\r\n\r\n    // ENTERPRISE: Obtener estad√≠sticas de cache\r\n    const cacheStats = getCacheStats();\r\n\r\n    return NextResponse.json({\r\n      success: enterpriseResult.success || adminResult.isAdmin,\r\n      enterprise: {\r\n        status: enterpriseResult.success ? 'SUCCESS' : 'FAILED',\r\n        context: enterpriseResult.success ? {\r\n          userId: enterpriseContext?.userId,\r\n          role: enterpriseContext?.role,\r\n          permissions: enterpriseContext?.permissions,\r\n          securityLevel: enterpriseContext?.securityLevel,\r\n          validations: enterpriseContext?.validations\r\n        } : null,\r\n        rls: rlsValidation ? {\r\n          valid: rlsValidation.valid,\r\n          error: rlsValidation.error\r\n        } : null,\r\n        cache: cacheStats,\r\n        error: enterpriseResult.error,\r\n        code: enterpriseResult.code\r\n      },\r\n      legacy: {\r\n        status: adminResult.isAdmin ? 'SUCCESS' : 'FAILED',\r\n        userId: adminResult.userId,\r\n        sessionId: adminResult.sessionId,\r\n        isAdmin: adminResult.isAdmin,\r\n        error: adminResult.error,\r\n        checkAdminAccess: {\r\n          success: legacyResult.success,\r\n          error: legacyResult.error\r\n        }\r\n      },\r\n      migration: {\r\n        status: 'ENTERPRISE_COMPLETED',\r\n        comparison: {\r\n          enterprise_success: enterpriseResult.success,\r\n          legacy_success: adminResult.isAdmin,\r\n          methods_agree: enterpriseResult.success === adminResult.isAdmin,\r\n          recommended: 'enterprise'\r\n        },\r\n        improvements: [\r\n          '‚úÖ ENTERPRISE: Autenticaci√≥n con m√∫ltiples validaciones de seguridad',\r\n          '‚úÖ ENTERPRISE: Row Level Security (RLS) integrado',\r\n          '‚úÖ ENTERPRISE: Cache inteligente con estad√≠sticas',\r\n          '‚úÖ ENTERPRISE: Contexto completo de seguridad',\r\n          '‚úÖ ENTERPRISE: Permisos granulares',\r\n          '‚ö†Ô∏è LEGACY: M√©todo anterior a√∫n funcional para compatibilidad'\r\n        ]\r\n      },\r\n      debug: {\r\n        clerkUserId,\r\n        timestamp: new Date().toISOString(),\r\n        request_info: {\r\n          method: request.method,\r\n          url: request.url,\r\n          user_agent: request.headers.get('user-agent')?.substring(0, 100)\r\n        }\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('üîç Debug checkAdminAccess: Error:', error);\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: 'Unexpected error',\r\n      debug: {\r\n        errorMessage: error instanceof Error ? error.message : 'Unknown error'\r\n      }\r\n    }, { status: 500 });\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"names":["GET","runtime","request","enterpriseResult","requireAdminAuth","adminResult","getAuthenticatedAdmin","userId","success","NextResponse","json","error","enterprise","code","legacy","migration","status","comparison","enterpriseContext","rlsValidation","context","validateRLSContext","clerkUserId","console","log","legacyResult","checkAdminAccess","cacheStats","getCacheStats","isAdmin","role","permissions","securityLevel","validations","rls","valid","cache","sessionId","enterprise_success","legacy_success","methods_agree","recommended","improvements","debug","timestamp","Date","toISOString","request_info","method","url","user_agent","headers","get","substring","errorMessage","Error","message"],"mappings":"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"}