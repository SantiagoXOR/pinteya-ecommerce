{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\hooks\\useUserProfile.ts"],"sourcesContent":["// ===================================\r\n// PINTEYA E-COMMERCE - HOOK PARA PERFIL DE USUARIO\r\n// ===================================\r\n\r\nimport { useState, useEffect, useCallback } from 'react';\r\nimport { useAuth } from './useAuth';\r\nimport { toast } from 'sonner';\r\nimport { useNotifications } from './useNotifications';\r\n\r\nexport interface UserProfile {\r\n  id: string;\r\n  clerk_id: string;\r\n  name: string;\r\n  email: string;\r\n  phone?: string;\r\n  avatar_url?: string;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface UpdateProfileData {\r\n  name: string;\r\n  email: string;\r\n  phone?: string;\r\n}\r\n\r\nexport interface UseUserProfileReturn {\r\n  profile: UserProfile | null;\r\n  loading: boolean;\r\n  error: string | null;\r\n  updateProfile: (data: UpdateProfileData) => Promise<boolean>;\r\n  refreshProfile: () => Promise<void>;\r\n  uploadAvatar: (file: File) => Promise<boolean>;\r\n  deleteAvatar: () => Promise<boolean>;\r\n}\r\n\r\nexport function useUserProfile(): UseUserProfileReturn {\r\n  const { isSignedIn, isLoaded } = useAuth();\r\n  const { notifyProfileChange, notifySecurityAlert } = useNotifications();\r\n  const [profile, setProfile] = useState<UserProfile | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const fetchProfile = useCallback(async () => {\r\n    if (!isSignedIn || !isLoaded) {\r\n      setLoading(false);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setLoading(true);\r\n      setError(null);\r\n\r\n      const response = await fetch('/api/user/profile', {\r\n        method: 'GET',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error('Error al obtener el perfil');\r\n      }\r\n\r\n      const data = await response.json();\r\n\r\n      if (data.success && data.user) {\r\n        setProfile(data.user);\r\n      } else {\r\n        throw new Error(data.error || 'Error al cargar el perfil');\r\n      }\r\n    } catch (err) {\r\n      const errorMessage = err instanceof Error ? err.message : 'Error desconocido';\r\n      setError(errorMessage);\r\n      console.error('Error al obtener perfil:', err);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [isSignedIn, isLoaded]);\r\n\r\n  const updateProfile = useCallback(async (data: UpdateProfileData): Promise<boolean> => {\r\n    if (!isSignedIn) {\r\n      toast.error('Debes estar autenticado para actualizar tu perfil');\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      setLoading(true);\r\n      setError(null);\r\n\r\n      // Guardar valores anteriores para notificaciones\r\n      const oldEmail = profile?.email;\r\n      const oldPhone = profile?.phone;\r\n\r\n      const response = await fetch('/api/user/profile', {\r\n        method: 'PUT',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify(data),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error('Error al actualizar el perfil');\r\n      }\r\n\r\n      const result = await response.json();\r\n\r\n      if (result.success && result.user) {\r\n        setProfile(result.user);\r\n\r\n        // Notificaciones básicas\r\n        await notifyProfileChange('Perfil actualizado correctamente');\r\n\r\n        // Notificaciones por email para cambios críticos\r\n        if (data.email && data.email !== oldEmail) {\r\n          await notifySecurityAlert(\r\n            'Tu email ha sido actualizado. Revisa tu bandeja de entrada.',\r\n            {\r\n              type: 'profile_email_changed',\r\n              oldValue: oldEmail,\r\n              newValue: data.email,\r\n            },\r\n            { toastType: 'info', toastDuration: 6000 }\r\n          );\r\n        }\r\n\r\n        if (data.phone && data.phone !== oldPhone) {\r\n          await notifySecurityAlert(\r\n            'Tu teléfono ha sido actualizado.',\r\n            {\r\n              type: 'profile_phone_changed',\r\n              oldValue: oldPhone,\r\n              newValue: data.phone,\r\n            },\r\n            { toastType: 'info', toastDuration: 4000 }\r\n          );\r\n        }\r\n\r\n        return true;\r\n      } else {\r\n        throw new Error(result.error || 'Error al actualizar el perfil');\r\n      }\r\n    } catch (err) {\r\n      const errorMessage = err instanceof Error ? err.message : 'Error desconocido';\r\n      setError(errorMessage);\r\n      toast.error(errorMessage);\r\n      console.error('Error al actualizar perfil:', err);\r\n      return false;\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [isSignedIn, profile, notifyProfileChange, notifySecurityAlert]);\r\n\r\n  const uploadAvatar = useCallback(async (file: File): Promise<boolean> => {\r\n    if (!isSignedIn) {\r\n      toast.error('Debes estar autenticado para subir un avatar');\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      setLoading(true);\r\n      setError(null);\r\n\r\n      const formData = new FormData();\r\n      formData.append('avatar', file);\r\n\r\n      const response = await fetch('/api/user/avatar', {\r\n        method: 'POST',\r\n        body: formData,\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error('Error al subir el avatar');\r\n      }\r\n\r\n      const result = await response.json();\r\n\r\n      if (result.success) {\r\n        if (profile) {\r\n          setProfile({\r\n            ...profile,\r\n            avatar_url: result.avatar_url,\r\n            updated_at: new Date().toISOString(),\r\n          });\r\n        }\r\n        toast.success('Avatar actualizado correctamente');\r\n        return true;\r\n      } else {\r\n        throw new Error(result.error || 'Error al subir el avatar');\r\n      }\r\n    } catch (err) {\r\n      const errorMessage = err instanceof Error ? err.message : 'Error desconocido';\r\n      setError(errorMessage);\r\n      toast.error(errorMessage);\r\n      console.error('Error al subir avatar:', err);\r\n      return false;\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [isSignedIn, profile]);\r\n\r\n  const deleteAvatar = useCallback(async (): Promise<boolean> => {\r\n    if (!isSignedIn) {\r\n      toast.error('Debes estar autenticado para eliminar tu avatar');\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      setLoading(true);\r\n      setError(null);\r\n\r\n      const response = await fetch('/api/user/avatar', {\r\n        method: 'DELETE',\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error('Error al eliminar el avatar');\r\n      }\r\n\r\n      const result = await response.json();\r\n\r\n      if (result.success) {\r\n        if (profile) {\r\n          setProfile({\r\n            ...profile,\r\n            avatar_url: undefined,\r\n            updated_at: new Date().toISOString(),\r\n          });\r\n        }\r\n        toast.success('Avatar eliminado correctamente');\r\n        return true;\r\n      } else {\r\n        throw new Error(result.error || 'Error al eliminar el avatar');\r\n      }\r\n    } catch (err) {\r\n      const errorMessage = err instanceof Error ? err.message : 'Error desconocido';\r\n      setError(errorMessage);\r\n      toast.error(errorMessage);\r\n      console.error('Error al eliminar avatar:', err);\r\n      return false;\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [isSignedIn, profile]);\r\n\r\n  const refreshProfile = useCallback(async () => {\r\n    await fetchProfile();\r\n  }, [fetchProfile]);\r\n\r\n  useEffect(() => {\r\n    fetchProfile();\r\n  }, [fetchProfile]);\r\n\r\n  return {\r\n    profile,\r\n    loading,\r\n    error,\r\n    updateProfile,\r\n    refreshProfile,\r\n    uploadAvatar,\r\n    deleteAvatar,\r\n  };\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"names":["useUserProfile","isSignedIn","isLoaded","useAuth","notifyProfileChange","notifySecurityAlert","useNotifications","profile","setProfile","useState","loading","setLoading","error","setError","fetchProfile","useCallback","response","fetch","method","headers","ok","Error","data","json","success","user","err","errorMessage","message","console","updateProfile","toast","oldEmail","email","oldPhone","phone","body","JSON","stringify","result","type","oldValue","newValue","toastType","toastDuration","uploadAvatar","file","formData","FormData","append","avatar_url","updated_at","Date","toISOString","deleteAvatar","undefined","refreshProfile","useEffect"],"mappings":"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"}