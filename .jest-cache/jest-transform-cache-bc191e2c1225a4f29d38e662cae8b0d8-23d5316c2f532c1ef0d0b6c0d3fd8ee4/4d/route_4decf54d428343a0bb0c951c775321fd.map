{"version":3,"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\app\\api\\auth\\security\\route.ts"],"sourcesContent":["// Configuraci贸n para Node.js Runtime\nexport const runtime = 'nodejs'\n\n/**\n * API Enterprise de Auditor铆a de Seguridad Mejorada\n * Refactorizada con utilidades enterprise + RLS + validaciones robustas\n */\n\nimport { NextRequest, NextResponse } from 'next/server'\nimport { getAuthenticatedUser } from '@/lib/auth/admin-auth'\nimport { requireAdminAuth } from '@/lib/auth/enterprise-auth-utils'\nimport { executeWithRLS } from '@/lib/auth/enterprise-rls-utils'\nimport { withCache, getCacheStats } from '@/lib/auth/enterprise-cache'\nimport {\n  analyzeSecurityPatterns,\n  getSecurityMetrics,\n  generateSecurityReport,\n  getActiveSecurityAlerts,\n  updateSecurityAlert,\n  resolveSecurityAlert,\n  markAlertAsFalsePositive,\n  runSecurityHealthCheck,\n  cleanupOldSecurityEvents,\n  exportSecurityEvents,\n} from '@/lib/auth/security-audit-enhanced'\nimport { ApiResponse } from '@/types/api'\nimport { withRateLimit, RATE_LIMIT_CONFIGS } from '@/lib/rate-limiting/rate-limiter'\nimport { createSecurityLogger } from '@/lib/logging/security-logger'\nimport { withTimeout, ENDPOINT_TIMEOUTS } from '@/lib/config/api-timeouts'\n\n// =====================================================\n// GET /api/auth/security\n// Obtiene m茅tricas, alertas o ejecuta an谩lisis\n// =====================================================\n\nexport async function GET(request: NextRequest) {\n  // Aplicar rate limiting para APIs de autenticaci贸n\n  const rateLimitResult = await withRateLimit(request, RATE_LIMIT_CONFIGS.auth, async () => {\n    // Crear logger de seguridad\n    const securityLogger = createSecurityLogger(request)\n\n    try {\n      // Log del acceso al API de seguridad\n      securityLogger.logApiAccess(securityLogger.context, 'auth/security', 'read')\n\n      const url = new URL(request.url)\n      const action = url.searchParams.get('action') || 'metrics'\n      const userId = url.searchParams.get('userId')\n      const severity = url.searchParams.get('severity') as any\n\n      // ENTERPRISE: Autenticaci贸n enterprise con permisos espec铆ficos de seguridad\n      const enterpriseResult = await withTimeout(\n        () => requireAdminAuth(request, ['security_read', 'admin_access']),\n        ENDPOINT_TIMEOUTS['/api/auth']?.request || 15000,\n        'Autenticaci贸n enterprise'\n      )\n\n      if (!enterpriseResult.success) {\n        // Log del intento de acceso no autorizado\n        securityLogger.logPermissionDenied(securityLogger.context, 'auth/security', 'read')\n\n        const errorResponse: ApiResponse<null> = {\n          data: null,\n          success: false,\n          error: enterpriseResult.error || 'Permisos de administrador requeridos',\n          enterprise: true,\n          code: enterpriseResult.code,\n        }\n        return NextResponse.json(errorResponse, { status: enterpriseResult.status || 403 })\n      }\n\n      const context = enterpriseResult.context!\n\n      // LEGACY: Mantener compatibilidad con m茅todo anterior\n      const legacyResult = await getAuthenticatedUser(request)\n      console.log(' Security API: Enterprise vs Legacy auth comparison:', {\n        enterprise: enterpriseResult.success,\n        legacy: legacyResult.isAdmin,\n        agree: enterpriseResult.success === legacyResult.isAdmin,\n      })\n\n      switch (action) {\n        case 'metrics':\n          // ENTERPRISE: Obtener m茅tricas de seguridad con cache\n          const metrics = await withCache(\n            `security_metrics_${context.userId}`,\n            () => getSecurityMetrics(),\n            2 * 60 * 1000 // 2 minutos de cache\n          )\n\n          const metricsResponse: ApiResponse<any> = {\n            data: {\n              metrics,\n              cache: getCacheStats(),\n              enterprise: {\n                user: context.userId,\n                role: context.role,\n                permissions: context.permissions,\n              },\n            },\n            success: true,\n            message: 'M茅tricas de seguridad obtenidas (enterprise)',\n            enterprise: true,\n          }\n          return NextResponse.json(metricsResponse)\n\n        case 'alerts':\n          // ENTERPRISE: Obtener alertas activas con cache\n          const alerts = await withCache(\n            `security_alerts_${userId || 'all'}_${severity || 'all'}`,\n            () => getActiveSecurityAlerts(userId || undefined, severity),\n            1 * 60 * 1000 // 1 minuto de cache\n          )\n\n          const alertsResponse: ApiResponse<any> = {\n            data: {\n              alerts,\n              count: alerts.length,\n              cache: getCacheStats(),\n              enterprise: {\n                filtered_by_user: userId,\n                filtered_by_severity: severity,\n                requester: context.userId,\n              },\n            },\n            success: true,\n            message: 'Alertas de seguridad obtenidas',\n          }\n          return NextResponse.json(alertsResponse)\n\n        case 'analyze':\n          // Ejecutar an谩lisis de patrones\n          const timeWindow = parseInt(url.searchParams.get('timeWindow') || '24')\n          const analysisAlerts = await analyzeSecurityPatterns(userId || undefined, timeWindow)\n          const analysisResponse: ApiResponse<any> = {\n            data: { alerts: analysisAlerts, count: analysisAlerts.length },\n            success: true,\n            message: `An谩lisis completado: ${analysisAlerts.length} alertas generadas`,\n          }\n          return NextResponse.json(analysisResponse)\n\n        case 'health':\n          // Ejecutar verificaci贸n de salud de seguridad\n          const healthCheck = await runSecurityHealthCheck()\n          const healthResponse: ApiResponse<any> = {\n            data: healthCheck,\n            success: true,\n            message: `Estado de seguridad: ${healthCheck.status}`,\n          }\n          return NextResponse.json(healthResponse)\n\n        case 'report':\n          // Generar reporte de seguridad\n          const startDateStr = url.searchParams.get('startDate')\n          const endDateStr = url.searchParams.get('endDate')\n\n          if (!startDateStr || !endDateStr) {\n            const errorResponse: ApiResponse<null> = {\n              data: null,\n              success: false,\n              error: 'startDate y endDate son requeridos para generar reporte',\n            }\n            return NextResponse.json(errorResponse, { status: 400 })\n          }\n\n          const startDate = new Date(startDateStr)\n          const endDate = new Date(endDateStr)\n\n          if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {\n            const errorResponse: ApiResponse<null> = {\n              data: null,\n              success: false,\n              error: 'Fechas inv谩lidas',\n            }\n            return NextResponse.json(errorResponse, { status: 400 })\n          }\n\n          const report = await generateSecurityReport(startDate, endDate)\n          const reportResponse: ApiResponse<any> = {\n            data: { report },\n            success: true,\n            message: 'Reporte de seguridad generado',\n          }\n          return NextResponse.json(reportResponse)\n\n        case 'export':\n          // Exportar eventos de seguridad\n          const exportStartStr = url.searchParams.get('startDate')\n          const exportEndStr = url.searchParams.get('endDate')\n          const format = (url.searchParams.get('format') as 'json' | 'csv') || 'json'\n\n          if (!exportStartStr || !exportEndStr) {\n            const errorResponse: ApiResponse<null> = {\n              data: null,\n              success: false,\n              error: 'startDate y endDate son requeridos para exportar',\n            }\n            return NextResponse.json(errorResponse, { status: 400 })\n          }\n\n          const exportStart = new Date(exportStartStr)\n          const exportEnd = new Date(exportEndStr)\n\n          const exportData = await exportSecurityEvents(exportStart, exportEnd, format)\n\n          // Retornar como archivo descargable\n          const headers = new Headers()\n          headers.set('Content-Type', format === 'json' ? 'application/json' : 'text/csv')\n          headers.set(\n            'Content-Disposition',\n            `attachment; filename=\"security-events-${exportStartStr}-${exportEndStr}.${format}\"`\n          )\n\n          return new Response(exportData, { headers })\n\n        default:\n          const errorResponse: ApiResponse<null> = {\n            data: null,\n            success: false,\n            error: `Acci贸n no v谩lida: ${action}`,\n          }\n          return NextResponse.json(errorResponse, { status: 400 })\n      }\n    } catch (error) {\n      // Log del error de seguridad\n      securityLogger.logApiError(securityLogger.context, error as Error, {\n        endpoint: '/api/auth/security',\n        method: 'GET',\n        action: request.url,\n      })\n\n      const errorResponse: ApiResponse<null> = {\n        data: null,\n        success: false,\n        error: 'Error interno del servidor',\n      }\n      return NextResponse.json(errorResponse, { status: 500 })\n    }\n  })\n\n  return rateLimitResult\n}\n\n// =====================================================\n// POST /api/auth/security\n// Acciones sobre alertas y mantenimiento\n// =====================================================\n\nexport async function POST(request: NextRequest) {\n  // Aplicar rate limiting para APIs de autenticaci贸n (acciones administrativas)\n  const rateLimitResult = await withRateLimit(request, RATE_LIMIT_CONFIGS.admin, async () => {\n    // Crear logger de seguridad\n    const securityLogger = createSecurityLogger(request)\n\n    try {\n      // Log del acceso al API de seguridad (POST)\n      securityLogger.logApiAccess(securityLogger.context, 'auth/security', 'write')\n\n      const body = await withTimeout(\n        () => request.json(),\n        ENDPOINT_TIMEOUTS['/api/auth']?.request || 15000,\n        'Lectura del body de la request'\n      )\n\n      const { action, alertId, status, notes, assignedTo } = body\n\n      if (!action) {\n        const errorResponse: ApiResponse<null> = {\n          data: null,\n          success: false,\n          error: 'Acci贸n es requerida',\n        }\n        return NextResponse.json(errorResponse, { status: 400 })\n      }\n\n      // Verificar autenticaci贸n y permisos de admin\n      const authResult = await withTimeout(\n        () => getAuthenticatedUser(request),\n        ENDPOINT_TIMEOUTS['/api/auth']?.request || 15000,\n        'Verificaci贸n de autenticaci贸n'\n      )\n\n      if (!authResult.userId || !authResult.isAdmin) {\n        // Log del intento de acceso no autorizado\n        securityLogger.logPermissionDenied(securityLogger.context, 'auth/security', 'write')\n\n        const errorResponse: ApiResponse<null> = {\n          data: null,\n          success: false,\n          error: 'Permisos de administrador requeridos',\n        }\n        return NextResponse.json(errorResponse, { status: 403 })\n      }\n\n      switch (action) {\n        case 'update_alert':\n          // Actualizar estado de alerta\n          if (!alertId) {\n            const errorResponse: ApiResponse<null> = {\n              data: null,\n              success: false,\n              error: 'alertId es requerido',\n            }\n            return NextResponse.json(errorResponse, { status: 400 })\n          }\n\n          const updateResult = await updateSecurityAlert(alertId, {\n            status,\n            assigned_to: assignedTo,\n            resolution_notes: notes,\n          })\n\n          const updateResponse: ApiResponse<any> = {\n            data: { success: updateResult },\n            success: updateResult,\n            message: updateResult ? 'Alerta actualizada' : 'Error actualizando alerta',\n          }\n          return NextResponse.json(updateResponse, {\n            status: updateResult ? 200 : 500,\n          })\n\n        case 'resolve_alert':\n          // Resolver alerta\n          if (!alertId || !notes) {\n            const errorResponse: ApiResponse<null> = {\n              data: null,\n              success: false,\n              error: 'alertId y notes son requeridos',\n            }\n            return NextResponse.json(errorResponse, { status: 400 })\n          }\n\n          const resolveResult = await resolveSecurityAlert(alertId, notes, authResult.userId)\n\n          const resolveResponse: ApiResponse<any> = {\n            data: { success: resolveResult },\n            success: resolveResult,\n            message: resolveResult ? 'Alerta resuelta' : 'Error resolviendo alerta',\n          }\n          return NextResponse.json(resolveResponse, {\n            status: resolveResult ? 200 : 500,\n          })\n\n        case 'false_positive':\n          // Marcar como falso positivo\n          if (!alertId || !notes) {\n            const errorResponse: ApiResponse<null> = {\n              data: null,\n              success: false,\n              error: 'alertId y notes son requeridos',\n            }\n            return NextResponse.json(errorResponse, { status: 400 })\n          }\n\n          const fpResult = await markAlertAsFalsePositive(alertId, notes, authResult.userId)\n\n          const fpResponse: ApiResponse<any> = {\n            data: { success: fpResult },\n            success: fpResult,\n            message: fpResult ? 'Alerta marcada como falso positivo' : 'Error marcando alerta',\n          }\n          return NextResponse.json(fpResponse, {\n            status: fpResult ? 200 : 500,\n          })\n\n        case 'cleanup':\n          // Limpiar eventos antiguos\n          const daysToKeep = body.daysToKeep || 90\n          const cleanupCount = await cleanupOldSecurityEvents(daysToKeep)\n\n          const cleanupResponse: ApiResponse<any> = {\n            data: { deletedCount: cleanupCount },\n            success: true,\n            message: `Limpieza completada: ${cleanupCount} eventos eliminados`,\n          }\n          return NextResponse.json(cleanupResponse)\n\n        case 'force_analysis':\n          // Forzar an谩lisis de seguridad\n          const forceUserId = body.userId\n          const forceTimeWindow = body.timeWindow || 24\n\n          const forceAlerts = await analyzeSecurityPatterns(forceUserId, forceTimeWindow)\n\n          const forceResponse: ApiResponse<any> = {\n            data: { alerts: forceAlerts, count: forceAlerts.length },\n            success: true,\n            message: `An谩lisis forzado completado: ${forceAlerts.length} alertas generadas`,\n          }\n          return NextResponse.json(forceResponse)\n\n        default:\n          const errorResponse: ApiResponse<null> = {\n            data: null,\n            success: false,\n            error: `Acci贸n no v谩lida: ${action}`,\n          }\n          return NextResponse.json(errorResponse, { status: 400 })\n      }\n    } catch (error) {\n      // Log del error de seguridad\n      securityLogger.logApiError(securityLogger.context, error as Error, {\n        endpoint: '/api/auth/security',\n        method: 'POST',\n        action: request.url,\n      })\n\n      const errorResponse: ApiResponse<null> = {\n        data: null,\n        success: false,\n        error: 'Error interno del servidor',\n      }\n      return NextResponse.json(errorResponse, { status: 500 })\n    }\n  })\n\n  return rateLimitResult\n}\n"],"names":["GET","POST","runtime","request","rateLimitResult","withRateLimit","RATE_LIMIT_CONFIGS","auth","securityLogger","createSecurityLogger","logApiAccess","context","url","URL","action","searchParams","get","userId","severity","enterpriseResult","withTimeout","requireAdminAuth","ENDPOINT_TIMEOUTS","success","logPermissionDenied","errorResponse","data","error","enterprise","code","NextResponse","json","status","legacyResult","getAuthenticatedUser","console","log","legacy","isAdmin","agree","metrics","withCache","getSecurityMetrics","metricsResponse","cache","getCacheStats","user","role","permissions","message","alerts","getActiveSecurityAlerts","undefined","alertsResponse","count","length","filtered_by_user","filtered_by_severity","requester","timeWindow","parseInt","analysisAlerts","analyzeSecurityPatterns","analysisResponse","healthCheck","runSecurityHealthCheck","healthResponse","startDateStr","endDateStr","startDate","Date","endDate","isNaN","getTime","report","generateSecurityReport","reportResponse","exportStartStr","exportEndStr","format","exportStart","exportEnd","exportData","exportSecurityEvents","headers","Headers","set","Response","logApiError","endpoint","method","admin","body","alertId","notes","assignedTo","authResult","updateResult","updateSecurityAlert","assigned_to","resolution_notes","updateResponse","resolveResult","resolveSecurityAlert","resolveResponse","fpResult","markAlertAsFalsePositive","fpResponse","daysToKeep","cleanupCount","cleanupOldSecurityEvents","cleanupResponse","deletedCount","forceUserId","forceTimeWindow","forceAlerts","forceResponse"],"mappings":"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"}