b3c07d3c3e93812325dd9975b17213d9
// ===================================
// PINTEYA E-COMMERCE - ORDERS CACHE HOOK
// Hook especializado para manejo de cache de órdenes
// ===================================
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "useOrdersCache", {
    enumerable: true,
    get: function() {
        return useOrdersCache;
    }
});
const _react = require("react");
// Configuración de cache
const CACHE_CONFIG = {
    MAX_SIZE: 50,
    CLEANUP_INTERVAL: 10 * 60 * 1000,
    MIN_REQUEST_INTERVAL: 1000
};
// ===================================
// CACHE GLOBAL
// ===================================
// Cache compartido entre instancias del hook
const cache = new Map();
const pendingRequests = new Map();
const requestTimestamps = new Map();
// ===================================
// UTILIDADES DE CACHE
// ===================================
function getCacheKey(filters) {
    // Crear clave más estable ordenando las propiedades y normalizando valores
    const normalizedFilters = Object.keys(filters).sort().reduce((result, key)=>{
        const value = filters[key];
        // Normalizar valores para evitar claves duplicadas
        if (value !== undefined && value !== null && value !== '' && value !== 'all') {
            result[key] = value;
        }
        return result;
    }, {});
    return JSON.stringify(normalizedFilters);
}
function cleanupExpiredCache(cacheTimeout) {
    const now = Date.now();
    const expiredKeys = [];
    cache.forEach((entry, key)=>{
        if (now - entry.timestamp > cacheTimeout) {
            expiredKeys.push(key);
        }
    });
    expiredKeys.forEach((key)=>{
        cache.delete(key);
        requestTimestamps.delete(key);
    });
    // Limpiar cache si está muy grande
    if (cache.size > CACHE_CONFIG.MAX_SIZE) {
        const entries = Array.from(cache.entries());
        entries.sort((a, b)=>a[1].timestamp - b[1].timestamp);
        const toDelete = entries.slice(0, cache.size - CACHE_CONFIG.MAX_SIZE);
        toDelete.forEach(([key])=>{
            cache.delete(key);
            requestTimestamps.delete(key);
        });
    }
    if (process.env.NODE_ENV === 'development') {
        console.log('[useOrdersCache] Cache cleanup completed:', {
            expired: expiredKeys.length,
            currentSize: cache.size,
            maxSize: CACHE_CONFIG.MAX_SIZE
        });
    }
}
function useOrdersCache(options) {
    const lastCleanupRef = (0, _react.useRef)(Date.now());
    const getCachedData = (0, _react.useCallback)((filters)=>{
        if (!options.enableCache) {
            return null;
        }
        const key = getCacheKey(filters);
        const entry = cache.get(key);
        if (!entry) {
            return null;
        }
        const isExpired = Date.now() - entry.timestamp > options.cacheTimeout;
        if (isExpired) {
            cache.delete(key);
            requestTimestamps.delete(key);
            return null;
        }
        // Log de cache hit en desarrollo
        if (process.env.NODE_ENV === 'development') {
            console.log('[useOrdersCache] Cache hit:', {
                key: key.substring(0, 100) + '...',
                age: Date.now() - entry.timestamp,
                cacheSize: cache.size
            });
        }
        return entry.data;
    }, [
        options.enableCache,
        options.cacheTimeout
    ]);
    const setCachedData = (0, _react.useCallback)((filters, data)=>{
        if (!options.enableCache) {
            return;
        }
        const key = getCacheKey(filters);
        const requestId = Math.random().toString(36).substr(2, 9);
        cache.set(key, {
            data,
            timestamp: Date.now(),
            filters,
            requestId
        });
        requestTimestamps.set(key, Date.now());
        // Cleanup automático periódico
        const now = Date.now();
        if (now - lastCleanupRef.current > (options.cleanupInterval || CACHE_CONFIG.CLEANUP_INTERVAL)) {
            cleanupExpiredCache(options.cacheTimeout);
            lastCleanupRef.current = now;
        }
        if (process.env.NODE_ENV === 'development') {
            console.log('[useOrdersCache] Data cached:', {
                key: key.substring(0, 100) + '...',
                cacheSize: cache.size,
                requestId
            });
        }
    }, [
        options.enableCache,
        options.cacheTimeout,
        options.cleanupInterval
    ]);
    const clearCache = (0, _react.useCallback)(()=>{
        cache.clear();
        pendingRequests.clear();
        requestTimestamps.clear();
        if (process.env.NODE_ENV === 'development') {
            console.log('[useOrdersCache] Cache cleared');
        }
    }, []);
    const isRequestTooRecent = (0, _react.useCallback)((filters)=>{
        const key = getCacheKey(filters);
        const lastRequestTime = requestTimestamps.get(key);
        if (!lastRequestTime) {
            return false;
        }
        const timeSinceLastRequest = Date.now() - lastRequestTime;
        return timeSinceLastRequest < (options.minRequestInterval || CACHE_CONFIG.MIN_REQUEST_INTERVAL);
    }, [
        options.minRequestInterval
    ]);
    const setPendingRequest = (0, _react.useCallback)((filters, promise)=>{
        const key = getCacheKey(filters);
        pendingRequests.set(key, promise);
        // Limpiar cuando la promesa se resuelve
        promise.finally(()=>{
            pendingRequests.delete(key);
        });
    }, []);
    const getPendingRequest = (0, _react.useCallback)((filters)=>{
        const key = getCacheKey(filters);
        return pendingRequests.get(key) || null;
    }, []);
    const getCacheStats = (0, _react.useCallback)(()=>({
            size: cache.size,
            maxSize: options.maxSize || CACHE_CONFIG.MAX_SIZE,
            pendingRequests: pendingRequests.size
        }), [
        options.maxSize
    ]);
    return {
        getCachedData,
        setCachedData,
        clearCache,
        isRequestTooRecent,
        setPendingRequest,
        getPendingRequest,
        getCacheStats
    };
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbWFydGlcXERlc2t0b3BcXERFU0FSUk9MTE9TV1xcQk9JTEVSUExBVFRFIEUtQ09NTUVSQ0VcXHNyY1xcaG9va3NcXGFkbWluXFx1c2VPcmRlcnNDYWNoZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gUElOVEVZQSBFLUNPTU1FUkNFIC0gT1JERVJTIENBQ0hFIEhPT0tcbi8vIEhvb2sgZXNwZWNpYWxpemFkbyBwYXJhIG1hbmVqbyBkZSBjYWNoZSBkZSDDs3JkZW5lc1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuaW1wb3J0IHsgdXNlQ2FsbGJhY2ssIHVzZVJlZiB9IGZyb20gJ3JlYWN0J1xuaW1wb3J0IHsgU3RyaWN0T3JkZXJzTGlzdFJlc3BvbnNlIH0gZnJvbSAnQC90eXBlcy9hcGktc3RyaWN0J1xuaW1wb3J0IHsgU3RyaWN0T3JkZXJGaWx0ZXJzIH0gZnJvbSAnLi91c2VPcmRlcnNFbnRlcnByaXNlU3RyaWN0J1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gVElQT1MgWSBDT05GSUdVUkFDScOTTlxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuaW50ZXJmYWNlIENhY2hlRW50cnkge1xuICBkYXRhOiBTdHJpY3RPcmRlcnNMaXN0UmVzcG9uc2VcbiAgdGltZXN0YW1wOiBudW1iZXJcbiAgZmlsdGVyczogU3RyaWN0T3JkZXJGaWx0ZXJzXG4gIHJlcXVlc3RJZDogc3RyaW5nXG59XG5cbmludGVyZmFjZSBDYWNoZU9wdGlvbnMge1xuICBlbmFibGVDYWNoZTogYm9vbGVhblxuICBjYWNoZVRpbWVvdXQ6IG51bWJlclxuICBtYXhTaXplPzogbnVtYmVyXG4gIGNsZWFudXBJbnRlcnZhbD86IG51bWJlclxuICBtaW5SZXF1ZXN0SW50ZXJ2YWw/OiBudW1iZXJcbn1cblxuLy8gQ29uZmlndXJhY2nDs24gZGUgY2FjaGVcbmNvbnN0IENBQ0hFX0NPTkZJRyA9IHtcbiAgTUFYX1NJWkU6IDUwLFxuICBDTEVBTlVQX0lOVEVSVkFMOiAxMCAqIDYwICogMTAwMCwgLy8gMTAgbWludXRvc1xuICBNSU5fUkVRVUVTVF9JTlRFUlZBTDogMTAwMCwgLy8gMSBzZWd1bmRvIG3DrW5pbW8gZW50cmUgcGV0aWNpb25lcyBpZMOpbnRpY2FzXG59IGFzIGNvbnN0XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBDQUNIRSBHTE9CQUxcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbi8vIENhY2hlIGNvbXBhcnRpZG8gZW50cmUgaW5zdGFuY2lhcyBkZWwgaG9va1xuY29uc3QgY2FjaGUgPSBuZXcgTWFwPHN0cmluZywgQ2FjaGVFbnRyeT4oKVxuY29uc3QgcGVuZGluZ1JlcXVlc3RzID0gbmV3IE1hcDxzdHJpbmcsIFByb21pc2U8YW55Pj4oKVxuY29uc3QgcmVxdWVzdFRpbWVzdGFtcHMgPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyPigpXG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBVVElMSURBREVTIERFIENBQ0hFXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5mdW5jdGlvbiBnZXRDYWNoZUtleShmaWx0ZXJzOiBTdHJpY3RPcmRlckZpbHRlcnMpOiBzdHJpbmcge1xuICAvLyBDcmVhciBjbGF2ZSBtw6FzIGVzdGFibGUgb3JkZW5hbmRvIGxhcyBwcm9waWVkYWRlcyB5IG5vcm1hbGl6YW5kbyB2YWxvcmVzXG4gIGNvbnN0IG5vcm1hbGl6ZWRGaWx0ZXJzID0gT2JqZWN0LmtleXMoZmlsdGVycylcbiAgICAuc29ydCgpXG4gICAgLnJlZHVjZSgocmVzdWx0LCBrZXkpID0+IHtcbiAgICAgIGNvbnN0IHZhbHVlID0gZmlsdGVyc1trZXkgYXMga2V5b2YgU3RyaWN0T3JkZXJGaWx0ZXJzXVxuICAgICAgLy8gTm9ybWFsaXphciB2YWxvcmVzIHBhcmEgZXZpdGFyIGNsYXZlcyBkdXBsaWNhZGFzXG4gICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gJycgJiYgdmFsdWUgIT09ICdhbGwnKSB7XG4gICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWVcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXN1bHRcbiAgICB9LCB7fSBhcyBhbnkpXG4gIHJldHVybiBKU09OLnN0cmluZ2lmeShub3JtYWxpemVkRmlsdGVycylcbn1cblxuZnVuY3Rpb24gY2xlYW51cEV4cGlyZWRDYWNoZShjYWNoZVRpbWVvdXQ6IG51bWJlcik6IHZvaWQge1xuICBjb25zdCBub3cgPSBEYXRlLm5vdygpXG4gIGNvbnN0IGV4cGlyZWRLZXlzOiBzdHJpbmdbXSA9IFtdXG5cbiAgY2FjaGUuZm9yRWFjaCgoZW50cnksIGtleSkgPT4ge1xuICAgIGlmIChub3cgLSBlbnRyeS50aW1lc3RhbXAgPiBjYWNoZVRpbWVvdXQpIHtcbiAgICAgIGV4cGlyZWRLZXlzLnB1c2goa2V5KVxuICAgIH1cbiAgfSlcblxuICBleHBpcmVkS2V5cy5mb3JFYWNoKGtleSA9PiB7XG4gICAgY2FjaGUuZGVsZXRlKGtleSlcbiAgICByZXF1ZXN0VGltZXN0YW1wcy5kZWxldGUoa2V5KVxuICB9KVxuXG4gIC8vIExpbXBpYXIgY2FjaGUgc2kgZXN0w6EgbXV5IGdyYW5kZVxuICBpZiAoY2FjaGUuc2l6ZSA+IENBQ0hFX0NPTkZJRy5NQVhfU0laRSkge1xuICAgIGNvbnN0IGVudHJpZXMgPSBBcnJheS5mcm9tKGNhY2hlLmVudHJpZXMoKSlcbiAgICBlbnRyaWVzLnNvcnQoKGEsIGIpID0+IGFbMV0udGltZXN0YW1wIC0gYlsxXS50aW1lc3RhbXApXG5cbiAgICBjb25zdCB0b0RlbGV0ZSA9IGVudHJpZXMuc2xpY2UoMCwgY2FjaGUuc2l6ZSAtIENBQ0hFX0NPTkZJRy5NQVhfU0laRSlcbiAgICB0b0RlbGV0ZS5mb3JFYWNoKChba2V5XSkgPT4ge1xuICAgICAgY2FjaGUuZGVsZXRlKGtleSlcbiAgICAgIHJlcXVlc3RUaW1lc3RhbXBzLmRlbGV0ZShrZXkpXG4gICAgfSlcbiAgfVxuXG4gIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ2RldmVsb3BtZW50Jykge1xuICAgIGNvbnNvbGUubG9nKCdbdXNlT3JkZXJzQ2FjaGVdIENhY2hlIGNsZWFudXAgY29tcGxldGVkOicsIHtcbiAgICAgIGV4cGlyZWQ6IGV4cGlyZWRLZXlzLmxlbmd0aCxcbiAgICAgIGN1cnJlbnRTaXplOiBjYWNoZS5zaXplLFxuICAgICAgbWF4U2l6ZTogQ0FDSEVfQ09ORklHLk1BWF9TSVpFLFxuICAgIH0pXG4gIH1cbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIEhPT0sgREUgQ0FDSEVcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmV4cG9ydCBpbnRlcmZhY2UgVXNlT3JkZXJzQ2FjaGVSZXR1cm4ge1xuICBnZXRDYWNoZWREYXRhOiAoZmlsdGVyczogU3RyaWN0T3JkZXJGaWx0ZXJzKSA9PiBTdHJpY3RPcmRlcnNMaXN0UmVzcG9uc2UgfCBudWxsXG4gIHNldENhY2hlZERhdGE6IChmaWx0ZXJzOiBTdHJpY3RPcmRlckZpbHRlcnMsIGRhdGE6IFN0cmljdE9yZGVyc0xpc3RSZXNwb25zZSkgPT4gdm9pZFxuICBjbGVhckNhY2hlOiAoKSA9PiB2b2lkXG4gIGlzUmVxdWVzdFRvb1JlY2VudDogKGZpbHRlcnM6IFN0cmljdE9yZGVyRmlsdGVycykgPT4gYm9vbGVhblxuICBzZXRQZW5kaW5nUmVxdWVzdDogKGZpbHRlcnM6IFN0cmljdE9yZGVyRmlsdGVycywgcHJvbWlzZTogUHJvbWlzZTxhbnk+KSA9PiB2b2lkXG4gIGdldFBlbmRpbmdSZXF1ZXN0OiAoZmlsdGVyczogU3RyaWN0T3JkZXJGaWx0ZXJzKSA9PiBQcm9taXNlPGFueT4gfCBudWxsXG4gIGdldENhY2hlU3RhdHM6ICgpID0+IHsgc2l6ZTogbnVtYmVyOyBtYXhTaXplOiBudW1iZXI7IHBlbmRpbmdSZXF1ZXN0czogbnVtYmVyIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVzZU9yZGVyc0NhY2hlKG9wdGlvbnM6IENhY2hlT3B0aW9ucyk6IFVzZU9yZGVyc0NhY2hlUmV0dXJuIHtcbiAgY29uc3QgbGFzdENsZWFudXBSZWYgPSB1c2VSZWY8bnVtYmVyPihEYXRlLm5vdygpKVxuXG4gIGNvbnN0IGdldENhY2hlZERhdGEgPSB1c2VDYWxsYmFjayhcbiAgICAoZmlsdGVyczogU3RyaWN0T3JkZXJGaWx0ZXJzKTogU3RyaWN0T3JkZXJzTGlzdFJlc3BvbnNlIHwgbnVsbCA9PiB7XG4gICAgICBpZiAoIW9wdGlvbnMuZW5hYmxlQ2FjaGUpIHtcbiAgICAgICAgcmV0dXJuIG51bGxcbiAgICAgIH1cblxuICAgICAgY29uc3Qga2V5ID0gZ2V0Q2FjaGVLZXkoZmlsdGVycylcbiAgICAgIGNvbnN0IGVudHJ5ID0gY2FjaGUuZ2V0KGtleSlcblxuICAgICAgaWYgKCFlbnRyeSkge1xuICAgICAgICByZXR1cm4gbnVsbFxuICAgICAgfVxuXG4gICAgICBjb25zdCBpc0V4cGlyZWQgPSBEYXRlLm5vdygpIC0gZW50cnkudGltZXN0YW1wID4gb3B0aW9ucy5jYWNoZVRpbWVvdXRcbiAgICAgIGlmIChpc0V4cGlyZWQpIHtcbiAgICAgICAgY2FjaGUuZGVsZXRlKGtleSlcbiAgICAgICAgcmVxdWVzdFRpbWVzdGFtcHMuZGVsZXRlKGtleSlcbiAgICAgICAgcmV0dXJuIG51bGxcbiAgICAgIH1cblxuICAgICAgLy8gTG9nIGRlIGNhY2hlIGhpdCBlbiBkZXNhcnJvbGxvXG4gICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdkZXZlbG9wbWVudCcpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ1t1c2VPcmRlcnNDYWNoZV0gQ2FjaGUgaGl0OicsIHtcbiAgICAgICAgICBrZXk6IGtleS5zdWJzdHJpbmcoMCwgMTAwKSArICcuLi4nLFxuICAgICAgICAgIGFnZTogRGF0ZS5ub3coKSAtIGVudHJ5LnRpbWVzdGFtcCxcbiAgICAgICAgICBjYWNoZVNpemU6IGNhY2hlLnNpemUsXG4gICAgICAgIH0pXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBlbnRyeS5kYXRhXG4gICAgfSxcbiAgICBbb3B0aW9ucy5lbmFibGVDYWNoZSwgb3B0aW9ucy5jYWNoZVRpbWVvdXRdXG4gIClcblxuICBjb25zdCBzZXRDYWNoZWREYXRhID0gdXNlQ2FsbGJhY2soXG4gICAgKGZpbHRlcnM6IFN0cmljdE9yZGVyRmlsdGVycywgZGF0YTogU3RyaWN0T3JkZXJzTGlzdFJlc3BvbnNlKTogdm9pZCA9PiB7XG4gICAgICBpZiAoIW9wdGlvbnMuZW5hYmxlQ2FjaGUpIHtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGtleSA9IGdldENhY2hlS2V5KGZpbHRlcnMpXG4gICAgICBjb25zdCByZXF1ZXN0SWQgPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSlcblxuICAgICAgY2FjaGUuc2V0KGtleSwge1xuICAgICAgICBkYXRhLFxuICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICAgIGZpbHRlcnMsXG4gICAgICAgIHJlcXVlc3RJZCxcbiAgICAgIH0pXG5cbiAgICAgIHJlcXVlc3RUaW1lc3RhbXBzLnNldChrZXksIERhdGUubm93KCkpXG5cbiAgICAgIC8vIENsZWFudXAgYXV0b23DoXRpY28gcGVyacOzZGljb1xuICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKVxuICAgICAgaWYgKFxuICAgICAgICBub3cgLSBsYXN0Q2xlYW51cFJlZi5jdXJyZW50ID5cbiAgICAgICAgKG9wdGlvbnMuY2xlYW51cEludGVydmFsIHx8IENBQ0hFX0NPTkZJRy5DTEVBTlVQX0lOVEVSVkFMKVxuICAgICAgKSB7XG4gICAgICAgIGNsZWFudXBFeHBpcmVkQ2FjaGUob3B0aW9ucy5jYWNoZVRpbWVvdXQpXG4gICAgICAgIGxhc3RDbGVhbnVwUmVmLmN1cnJlbnQgPSBub3dcbiAgICAgIH1cblxuICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAnZGV2ZWxvcG1lbnQnKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdbdXNlT3JkZXJzQ2FjaGVdIERhdGEgY2FjaGVkOicsIHtcbiAgICAgICAgICBrZXk6IGtleS5zdWJzdHJpbmcoMCwgMTAwKSArICcuLi4nLFxuICAgICAgICAgIGNhY2hlU2l6ZTogY2FjaGUuc2l6ZSxcbiAgICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSxcbiAgICBbb3B0aW9ucy5lbmFibGVDYWNoZSwgb3B0aW9ucy5jYWNoZVRpbWVvdXQsIG9wdGlvbnMuY2xlYW51cEludGVydmFsXVxuICApXG5cbiAgY29uc3QgY2xlYXJDYWNoZSA9IHVzZUNhbGxiYWNrKCgpOiB2b2lkID0+IHtcbiAgICBjYWNoZS5jbGVhcigpXG4gICAgcGVuZGluZ1JlcXVlc3RzLmNsZWFyKClcbiAgICByZXF1ZXN0VGltZXN0YW1wcy5jbGVhcigpXG5cbiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdkZXZlbG9wbWVudCcpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdbdXNlT3JkZXJzQ2FjaGVdIENhY2hlIGNsZWFyZWQnKVxuICAgIH1cbiAgfSwgW10pXG5cbiAgY29uc3QgaXNSZXF1ZXN0VG9vUmVjZW50ID0gdXNlQ2FsbGJhY2soXG4gICAgKGZpbHRlcnM6IFN0cmljdE9yZGVyRmlsdGVycyk6IGJvb2xlYW4gPT4ge1xuICAgICAgY29uc3Qga2V5ID0gZ2V0Q2FjaGVLZXkoZmlsdGVycylcbiAgICAgIGNvbnN0IGxhc3RSZXF1ZXN0VGltZSA9IHJlcXVlc3RUaW1lc3RhbXBzLmdldChrZXkpXG5cbiAgICAgIGlmICghbGFzdFJlcXVlc3RUaW1lKSB7XG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfVxuXG4gICAgICBjb25zdCB0aW1lU2luY2VMYXN0UmVxdWVzdCA9IERhdGUubm93KCkgLSBsYXN0UmVxdWVzdFRpbWVcbiAgICAgIHJldHVybiAoXG4gICAgICAgIHRpbWVTaW5jZUxhc3RSZXF1ZXN0IDwgKG9wdGlvbnMubWluUmVxdWVzdEludGVydmFsIHx8IENBQ0hFX0NPTkZJRy5NSU5fUkVRVUVTVF9JTlRFUlZBTClcbiAgICAgIClcbiAgICB9LFxuICAgIFtvcHRpb25zLm1pblJlcXVlc3RJbnRlcnZhbF1cbiAgKVxuXG4gIGNvbnN0IHNldFBlbmRpbmdSZXF1ZXN0ID0gdXNlQ2FsbGJhY2soXG4gICAgKGZpbHRlcnM6IFN0cmljdE9yZGVyRmlsdGVycywgcHJvbWlzZTogUHJvbWlzZTxhbnk+KTogdm9pZCA9PiB7XG4gICAgICBjb25zdCBrZXkgPSBnZXRDYWNoZUtleShmaWx0ZXJzKVxuICAgICAgcGVuZGluZ1JlcXVlc3RzLnNldChrZXksIHByb21pc2UpXG5cbiAgICAgIC8vIExpbXBpYXIgY3VhbmRvIGxhIHByb21lc2Egc2UgcmVzdWVsdmVcbiAgICAgIHByb21pc2UuZmluYWxseSgoKSA9PiB7XG4gICAgICAgIHBlbmRpbmdSZXF1ZXN0cy5kZWxldGUoa2V5KVxuICAgICAgfSlcbiAgICB9LFxuICAgIFtdXG4gIClcblxuICBjb25zdCBnZXRQZW5kaW5nUmVxdWVzdCA9IHVzZUNhbGxiYWNrKChmaWx0ZXJzOiBTdHJpY3RPcmRlckZpbHRlcnMpOiBQcm9taXNlPGFueT4gfCBudWxsID0+IHtcbiAgICBjb25zdCBrZXkgPSBnZXRDYWNoZUtleShmaWx0ZXJzKVxuICAgIHJldHVybiBwZW5kaW5nUmVxdWVzdHMuZ2V0KGtleSkgfHwgbnVsbFxuICB9LCBbXSlcblxuICBjb25zdCBnZXRDYWNoZVN0YXRzID0gdXNlQ2FsbGJhY2soXG4gICAgKCkgPT4gKHtcbiAgICAgIHNpemU6IGNhY2hlLnNpemUsXG4gICAgICBtYXhTaXplOiBvcHRpb25zLm1heFNpemUgfHwgQ0FDSEVfQ09ORklHLk1BWF9TSVpFLFxuICAgICAgcGVuZGluZ1JlcXVlc3RzOiBwZW5kaW5nUmVxdWVzdHMuc2l6ZSxcbiAgICB9KSxcbiAgICBbb3B0aW9ucy5tYXhTaXplXVxuICApXG5cbiAgcmV0dXJuIHtcbiAgICBnZXRDYWNoZWREYXRhLFxuICAgIHNldENhY2hlZERhdGEsXG4gICAgY2xlYXJDYWNoZSxcbiAgICBpc1JlcXVlc3RUb29SZWNlbnQsXG4gICAgc2V0UGVuZGluZ1JlcXVlc3QsXG4gICAgZ2V0UGVuZGluZ1JlcXVlc3QsXG4gICAgZ2V0Q2FjaGVTdGF0cyxcbiAgfVxufVxuIl0sIm5hbWVzIjpbInVzZU9yZGVyc0NhY2hlIiwiQ0FDSEVfQ09ORklHIiwiTUFYX1NJWkUiLCJDTEVBTlVQX0lOVEVSVkFMIiwiTUlOX1JFUVVFU1RfSU5URVJWQUwiLCJjYWNoZSIsIk1hcCIsInBlbmRpbmdSZXF1ZXN0cyIsInJlcXVlc3RUaW1lc3RhbXBzIiwiZ2V0Q2FjaGVLZXkiLCJmaWx0ZXJzIiwibm9ybWFsaXplZEZpbHRlcnMiLCJPYmplY3QiLCJrZXlzIiwic29ydCIsInJlZHVjZSIsInJlc3VsdCIsImtleSIsInZhbHVlIiwidW5kZWZpbmVkIiwiSlNPTiIsInN0cmluZ2lmeSIsImNsZWFudXBFeHBpcmVkQ2FjaGUiLCJjYWNoZVRpbWVvdXQiLCJub3ciLCJEYXRlIiwiZXhwaXJlZEtleXMiLCJmb3JFYWNoIiwiZW50cnkiLCJ0aW1lc3RhbXAiLCJwdXNoIiwiZGVsZXRlIiwic2l6ZSIsImVudHJpZXMiLCJBcnJheSIsImZyb20iLCJhIiwiYiIsInRvRGVsZXRlIiwic2xpY2UiLCJwcm9jZXNzIiwiZW52IiwiTk9ERV9FTlYiLCJjb25zb2xlIiwibG9nIiwiZXhwaXJlZCIsImxlbmd0aCIsImN1cnJlbnRTaXplIiwibWF4U2l6ZSIsIm9wdGlvbnMiLCJsYXN0Q2xlYW51cFJlZiIsInVzZVJlZiIsImdldENhY2hlZERhdGEiLCJ1c2VDYWxsYmFjayIsImVuYWJsZUNhY2hlIiwiZ2V0IiwiaXNFeHBpcmVkIiwic3Vic3RyaW5nIiwiYWdlIiwiY2FjaGVTaXplIiwiZGF0YSIsInNldENhY2hlZERhdGEiLCJyZXF1ZXN0SWQiLCJNYXRoIiwicmFuZG9tIiwidG9TdHJpbmciLCJzdWJzdHIiLCJzZXQiLCJjdXJyZW50IiwiY2xlYW51cEludGVydmFsIiwiY2xlYXJDYWNoZSIsImNsZWFyIiwiaXNSZXF1ZXN0VG9vUmVjZW50IiwibGFzdFJlcXVlc3RUaW1lIiwidGltZVNpbmNlTGFzdFJlcXVlc3QiLCJtaW5SZXF1ZXN0SW50ZXJ2YWwiLCJzZXRQZW5kaW5nUmVxdWVzdCIsInByb21pc2UiLCJmaW5hbGx5IiwiZ2V0UGVuZGluZ1JlcXVlc3QiLCJnZXRDYWNoZVN0YXRzIl0sIm1hcHBpbmdzIjoiQUFBQSxzQ0FBc0M7QUFDdEMseUNBQXlDO0FBQ3pDLHFEQUFxRDtBQUNyRCxzQ0FBc0M7Ozs7OytCQThHdEJBOzs7ZUFBQUE7Ozt1QkE1R29CO0FBdUJwQyx5QkFBeUI7QUFDekIsTUFBTUMsZUFBZTtJQUNuQkMsVUFBVTtJQUNWQyxrQkFBa0IsS0FBSyxLQUFLO0lBQzVCQyxzQkFBc0I7QUFDeEI7QUFFQSxzQ0FBc0M7QUFDdEMsZUFBZTtBQUNmLHNDQUFzQztBQUV0Qyw2Q0FBNkM7QUFDN0MsTUFBTUMsUUFBUSxJQUFJQztBQUNsQixNQUFNQyxrQkFBa0IsSUFBSUQ7QUFDNUIsTUFBTUUsb0JBQW9CLElBQUlGO0FBRTlCLHNDQUFzQztBQUN0QyxzQkFBc0I7QUFDdEIsc0NBQXNDO0FBRXRDLFNBQVNHLFlBQVlDLE9BQTJCO0lBQzlDLDJFQUEyRTtJQUMzRSxNQUFNQyxvQkFBb0JDLE9BQU9DLElBQUksQ0FBQ0gsU0FDbkNJLElBQUksR0FDSkMsTUFBTSxDQUFDLENBQUNDLFFBQVFDO1FBQ2YsTUFBTUMsUUFBUVIsT0FBTyxDQUFDTyxJQUFnQztRQUN0RCxtREFBbUQ7UUFDbkQsSUFBSUMsVUFBVUMsYUFBYUQsVUFBVSxRQUFRQSxVQUFVLE1BQU1BLFVBQVUs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