0ba9c98bbe2f4ef60de6da8abe0ef9dc
// Configuración para Node.js Runtime
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: Object.getOwnPropertyDescriptor(all, name).get
    });
}
_export(exports, {
    get GET () {
        return GET;
    },
    get runtime () {
        return runtime;
    }
});
const _server = require("next/server");
const _supabase = require("../../../../lib/integrations/supabase");
const _config = require("../../../../lib/auth/config");
const runtime = 'nodejs';
async function GET(request) {
    try {
        // Verificar que el cliente administrativo esté disponible
        if (!_supabase.supabaseAdmin) {
            console.error('Cliente administrativo de Supabase no disponible en GET /api/user/orders');
            return _server.NextResponse.json({
                error: 'Servicio de base de datos no disponible'
            }, {
                status: 503
            });
        }
        // Obtener usuario autenticado usando NextAuth.js
        const session = await (0, _config.auth)();
        if (!session?.user?.id) {
            console.error('Usuario no autenticado en GET /api/user/orders');
            return _server.NextResponse.json({
                error: 'Usuario no autenticado'
            }, {
                status: 401
            });
        }
        // Obtener parámetros de consulta
        const { searchParams } = new URL(request.url);
        const page = parseInt(searchParams.get('page') || '1');
        const limit = parseInt(searchParams.get('limit') || '10');
        const status = searchParams.get('status');
        console.log(`[API] Obteniendo órdenes para usuario: ${session.user.id}`);
        // Construir query base usando directamente el ID del usuario de NextAuth.js
        let query = _supabase.supabaseAdmin.from('orders').select(`
        *,
        order_items (
          id,
          quantity,
          price,
          products (
            id,
            name,
            images
          )
        )
      `).eq('user_id', session.user.id);
        // Filtrar por status si se especifica
        if (status && status !== 'all') {
            query = query.eq('status', status);
        }
        // Aplicar paginación y ordenamiento
        const from = (page - 1) * limit;
        const to = from + limit - 1;
        const { data: orders, error, count } = await query.order('created_at', {
            ascending: false
        }).range(from, to);
        if (error) {
            console.error('Error al obtener órdenes:', error);
            return _server.NextResponse.json({
                error: 'Error al obtener órdenes'
            }, {
                status: 500
            });
        }
        // Calcular estadísticas
        const { data: stats } = await _supabase.supabaseAdmin.from('orders').select('status, total').eq('user_id', session.user.id);
        const statistics = {
            total_orders: stats?.length || 0,
            total_spent: stats?.reduce((sum, order)=>sum + parseFloat(order.total), 0) || 0,
            pending_orders: stats?.filter((order)=>order.status === 'pending').length || 0,
            completed_orders: stats?.filter((order)=>order.status === 'delivered').length || 0
        };
        return _server.NextResponse.json({
            success: true,
            data: orders || [],
            pagination: {
                page,
                limit,
                total: count || 0,
                pages: Math.ceil((count || 0) / limit)
            },
            statistics
        });
    } catch (error) {
        console.error('Error en GET /api/user/orders:', error);
        return _server.NextResponse.json({
            error: 'Error interno del servidor'
        }, {
            status: 500
        });
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbWFydGlcXERlc2t0b3BcXERFU0FSUk9MTE9TV1xcQk9JTEVSUExBVFRFIEUtQ09NTUVSQ0VcXHNyY1xcYXBwXFxhcGlcXHVzZXJcXG9yZGVyc1xccm91dGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29uZmlndXJhY2nDs24gcGFyYSBOb2RlLmpzIFJ1bnRpbWVcbmV4cG9ydCBjb25zdCBydW50aW1lID0gJ25vZGVqcydcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFBJTlRFWUEgRS1DT01NRVJDRSAtIEFQSSBERSDDk1JERU5FUyBERSBVU1VBUklPXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5pbXBvcnQgeyBOZXh0UmVxdWVzdCwgTmV4dFJlc3BvbnNlIH0gZnJvbSAnbmV4dC9zZXJ2ZXInXG5pbXBvcnQgeyBzdXBhYmFzZUFkbWluIH0gZnJvbSAnQC9saWIvaW50ZWdyYXRpb25zL3N1cGFiYXNlJ1xuaW1wb3J0IHsgYXV0aCB9IGZyb20gJ0AvbGliL2F1dGgvY29uZmlnJ1xuaW1wb3J0IHsgQXBpUmVzcG9uc2UgfSBmcm9tICdAL3R5cGVzL2FwaSdcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIEdFVCAtIE9idGVuZXIgw7NyZGVuZXMgZGVsIHVzdWFyaW9cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gR0VUKHJlcXVlc3Q6IE5leHRSZXF1ZXN0KSB7XG4gIHRyeSB7XG4gICAgLy8gVmVyaWZpY2FyIHF1ZSBlbCBjbGllbnRlIGFkbWluaXN0cmF0aXZvIGVzdMOpIGRpc3BvbmlibGVcbiAgICBpZiAoIXN1cGFiYXNlQWRtaW4pIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0NsaWVudGUgYWRtaW5pc3RyYXRpdm8gZGUgU3VwYWJhc2Ugbm8gZGlzcG9uaWJsZSBlbiBHRVQgL2FwaS91c2VyL29yZGVycycpXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgZXJyb3I6ICdTZXJ2aWNpbyBkZSBiYXNlIGRlIGRhdG9zIG5vIGRpc3BvbmlibGUnIH0sXG4gICAgICAgIHsgc3RhdHVzOiA1MDMgfVxuICAgICAgKVxuICAgIH1cblxuICAgIC8vIE9idGVuZXIgdXN1YXJpbyBhdXRlbnRpY2FkbyB1c2FuZG8gTmV4dEF1dGguanNcbiAgICBjb25zdCBzZXNzaW9uID0gYXdhaXQgYXV0aCgpXG5cbiAgICBpZiAoIXNlc3Npb24/LnVzZXI/LmlkKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdVc3VhcmlvIG5vIGF1dGVudGljYWRvIGVuIEdFVCAvYXBpL3VzZXIvb3JkZXJzJylcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiAnVXN1YXJpbyBubyBhdXRlbnRpY2FkbycgfSwgeyBzdGF0dXM6IDQwMSB9KVxuICAgIH1cblxuICAgIC8vIE9idGVuZXIgcGFyw6FtZXRyb3MgZGUgY29uc3VsdGFcbiAgICBjb25zdCB7IHNlYXJjaFBhcmFtcyB9ID0gbmV3IFVSTChyZXF1ZXN0LnVybClcbiAgICBjb25zdCBwYWdlID0gcGFyc2VJbnQoc2VhcmNoUGFyYW1zLmdldCgncGFnZScpIHx8ICcxJylcbiAgICBjb25zdCBsaW1pdCA9IHBhcnNlSW50KHNlYXJjaFBhcmFtcy5nZXQoJ2xpbWl0JykgfHwgJzEwJylcbiAgICBjb25zdCBzdGF0dXMgPSBzZWFyY2hQYXJhbXMuZ2V0KCdzdGF0dXMnKVxuXG4gICAgY29uc29sZS5sb2coYFtBUEldIE9idGVuaWVuZG8gw7NyZGVuZXMgcGFyYSB1c3VhcmlvOiAke3Nlc3Npb24udXNlci5pZH1gKVxuXG4gICAgLy8gQ29uc3RydWlyIHF1ZXJ5IGJhc2UgdXNhbmRvIGRpcmVjdGFtZW50ZSBlbCBJRCBkZWwgdXN1YXJpbyBkZSBOZXh0QXV0aC5qc1xuICAgIGxldCBxdWVyeSA9IHN1cGFiYXNlQWRtaW5cbiAgICAgIC5mcm9tKCdvcmRlcnMnKVxuICAgICAgLnNlbGVjdChcbiAgICAgICAgYFxuICAgICAgICAqLFxuICAgICAgICBvcmRlcl9pdGVtcyAoXG4gICAgICAgICAgaWQsXG4gICAgICAgICAgcXVhbnRpdHksXG4gICAgICAgICAgcHJpY2UsXG4gICAgICAgICAgcHJvZHVjdHMgKFxuICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgaW1hZ2VzXG4gICAgICAgICAgKVxuICAgICAgICApXG4gICAgICBgXG4gICAgICApXG4gICAgICAuZXEoJ3VzZXJfaWQnLCBzZXNzaW9uLnVzZXIuaWQpXG5cbiAgICAvLyBGaWx0cmFyIHBvciBzdGF0dXMgc2kgc2UgZXNwZWNpZmljYVxuICAgIGlmIChzdGF0dXMgJiYgc3RhdHVzICE9PSAnYWxsJykge1xuICAgICAgcXVlcnkgPSBxdWVyeS5lcSgnc3RhdHVzJywgc3RhdHVzKVxuICAgIH1cblxuICAgIC8vIEFwbGljYXIgcGFnaW5hY2nDs24geSBvcmRlbmFtaWVudG9cbiAgICBjb25zdCBmcm9tID0gKHBhZ2UgLSAxKSAqIGxpbWl0XG4gICAgY29uc3QgdG8gPSBmcm9tICsgbGltaXQgLSAxXG5cbiAgICBjb25zdCB7XG4gICAgICBkYXRhOiBvcmRlcnMsXG4gICAgICBlcnJvcixcbiAgICAgIGNvdW50LFxuICAgIH0gPSBhd2FpdCBxdWVyeS5vcmRlcignY3JlYXRlZF9hdCcsIHsgYXNjZW5kaW5nOiBmYWxzZSB9KS5yYW5nZShmcm9tLCB0bylcblxuICAgIGlmIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgYWwgb2J0ZW5lciDDs3JkZW5lczonLCBlcnJvcilcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiAnRXJyb3IgYWwgb2J0ZW5lciDDs3JkZW5lcycgfSwgeyBzdGF0dXM6IDUwMCB9KVxuICAgIH1cblxuICAgIC8vIENhbGN1bGFyIGVzdGFkw61zdGljYXNcbiAgICBjb25zdCB7IGRhdGE6IHN0YXRzIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXG4gICAgICAuZnJvbSgnb3JkZXJzJylcbiAgICAgIC5zZWxlY3QoJ3N0YXR1cywgdG90YWwnKVxuICAgICAgLmVxKCd1c2VyX2lkJywgc2Vzc2lvbi51c2VyLmlkKVxuXG4gICAgY29uc3Qgc3RhdGlzdGljcyA9IHtcbiAgICAgIHRvdGFsX29yZGVyczogc3RhdHM/Lmxlbmd0aCB8fCAwLFxuICAgICAgdG90YWxfc3BlbnQ6IHN0YXRzPy5yZWR1Y2UoKHN1bSwgb3JkZXIpID0+IHN1bSArIHBhcnNlRmxvYXQob3JkZXIudG90YWwpLCAwKSB8fCAwLFxuICAgICAgcGVuZGluZ19vcmRlcnM6IHN0YXRzPy5maWx0ZXIob3JkZXIgPT4gb3JkZXIuc3RhdHVzID09PSAncGVuZGluZycpLmxlbmd0aCB8fCAwLFxuICAgICAgY29tcGxldGVkX29yZGVyczogc3RhdHM/LmZpbHRlcihvcmRlciA9PiBvcmRlci5zdGF0dXMgPT09ICdkZWxpdmVyZWQnKS5sZW5ndGggfHwgMCxcbiAgICB9XG5cbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IG9yZGVycyB8fCBbXSxcbiAgICAgIHBhZ2luYXRpb246IHtcbiAgICAgICAgcGFnZSxcbiAgICAgICAgbGltaXQsXG4gICAgICAgIHRvdGFsOiBjb3VudCB8fCAwLFxuICAgICAgICBwYWdlczogTWF0aC5jZWlsKChjb3VudCB8fCAwKSAvIGxpbWl0KSxcbiAgICAgIH0sXG4gICAgICBzdGF0aXN0aWNzLFxuICAgIH0pXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgZW4gR0VUIC9hcGkvdXNlci9vcmRlcnM6JywgZXJyb3IpXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6ICdFcnJvciBpbnRlcm5vIGRlbCBzZXJ2aWRvcicgfSwgeyBzdGF0dXM6IDUwMCB9KVxuICB9XG59XG4iXSwibmFtZXMiOlsiR0VUIiwicnVudGltZSIsInJlcXVlc3QiLCJzdXBhYmFzZUFkbWluIiwiY29uc29sZSIsImVycm9yIiwiTmV4dFJlc3BvbnNlIiwianNvbiIsInN0YXR1cyIsInNlc3Npb24iLCJhdXRoIiwidXNlciIsImlkIiwic2VhcmNoUGFyYW1zIiwiVVJMIiwidXJsIiwicGFnZSIsInBhcnNlSW50IiwiZ2V0IiwibGltaXQiLCJsb2ciLCJxdWVyeSIsImZyb20iLCJzZWxlY3QiLCJlcSIsInRvIiwiZGF0YSIsIm9yZGVycyIsImNvdW50Iiwib3JkZXIiLCJhc2NlbmRpbmciLCJyYW5nZSIsInN0YXRzIiwic3RhdGlzdGljcyIsInRvdGFsX29yZGVycyIsImxlbmd0aCIsInRvdGFsX3NwZW50IiwicmVkdWNlIiwic3VtIiwicGFyc2VGbG9hdCIsInRvdGFsIiwicGVuZGluZ19vcmRlcnMiLCJmaWx0ZXIiLCJjb21wbGV0ZWRfb3JkZXJzIiwic3VjY2VzcyIsInBhZ2luYXRpb24iLCJwYWdlcyIsIk1hdGgiLCJjZWlsIl0sIm1hcHBpbmdzIjoiQUFBQSxxQ0FBcUM7Ozs7Ozs7Ozs7OztRQWVmQTtlQUFBQTs7UUFkVEM7ZUFBQUE7Ozt3QkFNNkI7MEJBQ1o7d0JBQ1Q7QUFSZCxNQUFNQSxVQUFVO0FBY2hCLGVBQWVELElBQUlFLE9BQW9CO0lBQzVDLElBQUk7UUFDRiwwREFBMEQ7UUFDMUQsSUFBSSxDQUFDQyx1QkFBYSxFQUFFO1lBQ2xCQyxRQUFRQyxLQUFLLENBQUM7WUFDZCxPQUFPQyxvQkFBWSxDQUFDQyxJQUFJLENBQ3RCO2dCQUFFRixPQUFPO1lBQTBDLEdBQ25EO2dCQUFFRyxRQUFRO1lBQUk7UUFFbEI7UUFFQSxpREFBaUQ7UUFDakQsTUFBTUMsVUFBVSxNQUFNQyxJQUFBQSxZQUFJO1FBRTFCLElBQUksQ0FBQ0QsU0FBU0UsTUFBTUMsSUFBSTtZQUN0QlIsUUFBUUMsS0FBSyxDQUFDO1lBQ2QsT0FBT0Msb0JBQVksQ0FBQ0MsSUFB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