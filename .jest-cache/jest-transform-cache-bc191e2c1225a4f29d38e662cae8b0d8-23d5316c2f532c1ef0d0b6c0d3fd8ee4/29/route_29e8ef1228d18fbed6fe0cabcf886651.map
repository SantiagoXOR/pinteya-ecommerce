{"version":3,"names":["cov_tgzchdsx2","actualCoverage","s","POST","f","runtime","request","logs","push","webhookData","action","api_version","data","id","date_created","live_mode","type","user_id","JSON","stringify","paymentData","status","external_reference","transaction_amount","currency_id","supabase","_supabase","getSupabaseClient","b","_server","NextResponse","json","error","order","orderError","from","select","eq","single","newOrderStatus","newPaymentStatus","updatedOrder","updateError","update","payment_status","payment_id","updated_at","Date","toISOString","success","message","originalOrder","orderComparison","before","total","after","manualOrderInfo","created_manually","customer","payer_info","total_amount","created_at","stack"],"sources":["C:\\Users\\marti\\Desktop\\DESARROLLOSW\\BOILERPLATTE E-COMMERCE\\src\\app\\api\\debug-manual-order\\route.ts"],"sourcesContent":["// Configuración para Node.js Runtime\r\nexport const runtime = 'nodejs';\r\n\r\n// ===================================\r\n// PINTEYA E-COMMERCE - DEBUG MANUAL ORDER WEBHOOK\r\n// Endpoint específico para probar webhook con orden 108 (manual)\r\n// ===================================\r\n\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport { getSupabaseClient } from '@/lib/integrations/supabase';\r\n\r\nexport async function POST(request: NextRequest) {\r\n  const logs: string[] = [];\r\n  \r\n  try {\r\n    logs.push('[DEBUG_MANUAL] Iniciando debug del webhook para orden 108 (manual)...');\r\n\r\n    // Simular datos de webhook para orden 108\r\n    const webhookData = {\r\n      action: \"payment.updated\",\r\n      api_version: \"v1\",\r\n      data: { id: \"manual_test_payment\" },\r\n      date_created: \"2021-11-01T02:02:02Z\",\r\n      id: \"manual_test_payment\",\r\n      live_mode: false,\r\n      type: \"payment\",\r\n      user_id: 452711838\r\n    };\r\n\r\n    logs.push('[DEBUG_MANUAL] Webhook data simulado: ' + JSON.stringify(webhookData));\r\n\r\n    // Simular datos de pago para orden 108\r\n    const paymentData = {\r\n      id: 'manual_test_payment',\r\n      status: 'approved',\r\n      external_reference: 'express_checkout_1757621175964', // Orden 108 manual\r\n      transaction_amount: 13950,\r\n      currency_id: 'ARS'\r\n    };\r\n\r\n    logs.push('[DEBUG_MANUAL] Payment data simulado: ' + JSON.stringify(paymentData));\r\n\r\n    // Probar conexión a Supabase\r\n    logs.push('[DEBUG_MANUAL] Probando conexión a Supabase...');\r\n    const supabase = getSupabaseClient(true);\r\n    \r\n    if (!supabase) {\r\n      logs.push('[DEBUG_MANUAL] ERROR: Cliente de Supabase no disponible');\r\n      return NextResponse.json({ error: 'Supabase not available', logs }, { status: 500 });\r\n    }\r\n\r\n    logs.push('[DEBUG_MANUAL] Cliente de Supabase OK');\r\n\r\n    // Buscar orden 108\r\n    logs.push('[DEBUG_MANUAL] Buscando orden con external_reference: ' + paymentData.external_reference);\r\n    \r\n    const { data: order, error: orderError } = await supabase\r\n      .from('orders')\r\n      .select('*')\r\n      .eq('external_reference', paymentData.external_reference)\r\n      .single();\r\n\r\n    if (orderError) {\r\n      logs.push('[DEBUG_MANUAL] ERROR buscando orden: ' + JSON.stringify(orderError));\r\n      return NextResponse.json({ error: 'Order lookup failed', logs, orderError }, { status: 500 });\r\n    }\r\n\r\n    if (!order) {\r\n      logs.push('[DEBUG_MANUAL] ERROR: Orden no encontrada');\r\n      return NextResponse.json({ error: 'Order not found', logs }, { status: 404 });\r\n    }\r\n\r\n    logs.push('[DEBUG_MANUAL] Orden encontrada: ' + JSON.stringify(order));\r\n\r\n    // Mapear estados\r\n    const newOrderStatus = 'paid';\r\n    const newPaymentStatus = 'paid';\r\n\r\n    logs.push('[DEBUG_MANUAL] Nuevos estados: order=' + newOrderStatus + ', payment=' + newPaymentStatus);\r\n\r\n    // Actualizar orden 108\r\n    logs.push('[DEBUG_MANUAL] Actualizando orden 108...');\r\n    \r\n    const { data: updatedOrder, error: updateError } = await supabase\r\n      .from('orders')\r\n      .update({\r\n        payment_status: newPaymentStatus,\r\n        status: newOrderStatus,\r\n        payment_id: paymentData.id,\r\n        updated_at: new Date().toISOString()\r\n      })\r\n      .eq('id', order.id)\r\n      .select()\r\n      .single();\r\n\r\n    if (updateError) {\r\n      logs.push('[DEBUG_MANUAL] ERROR actualizando orden: ' + JSON.stringify(updateError));\r\n      return NextResponse.json({ error: 'Update failed', logs, updateError }, { status: 500 });\r\n    }\r\n\r\n    logs.push('[DEBUG_MANUAL] Orden 108 actualizada exitosamente: ' + JSON.stringify(updatedOrder));\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: 'Debug webhook para orden 108 (manual) completado exitosamente',\r\n      logs,\r\n      originalOrder: order,\r\n      updatedOrder,\r\n      paymentData,\r\n      orderComparison: {\r\n        before: {\r\n          id: order.id,\r\n          status: order.status,\r\n          payment_status: order.payment_status,\r\n          payment_id: order.payment_id,\r\n          total: order.total,\r\n          external_reference: order.external_reference\r\n        },\r\n        after: {\r\n          id: updatedOrder.id,\r\n          status: updatedOrder.status,\r\n          payment_status: updatedOrder.payment_status,\r\n          payment_id: updatedOrder.payment_id,\r\n          total: updatedOrder.total,\r\n          external_reference: updatedOrder.external_reference\r\n        }\r\n      },\r\n      manualOrderInfo: {\r\n        created_manually: true,\r\n        customer: order.payer_info,\r\n        total_amount: order.total,\r\n        created_at: order.created_at\r\n      }\r\n    }, { status: 200 });\r\n\r\n  } catch (error: any) {\r\n    logs.push('[DEBUG_MANUAL] EXCEPTION: ' + error.message);\r\n    logs.push('[DEBUG_MANUAL] STACK: ' + error.stack);\r\n\r\n    return NextResponse.json({\r\n      error: 'Debug manual order failed',\r\n      message: error.message,\r\n      logs,\r\n      stack: error.stack\r\n    }, { status: 500 });\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"mappings":"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","ignoreList":[]}