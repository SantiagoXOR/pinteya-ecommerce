<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forzar Actualizaci√≥n de Rol - Admin</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Forzar Actualizaci√≥n de Rol Admin</h1>
        <p>Esta herramienta ayuda a forzar la recarga del rol en el token JWT de NextAuth.</p>
        
        <div id="status"></div>
        
        <div>
            <button onclick="checkSession()">1. Verificar Sesi√≥n Actual</button>
            <button onclick="forceUpdate()">2. Forzar Actualizaci√≥n de Rol</button>
            <button onclick="testAdminAccess()">3. Probar Acceso Admin</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        async function checkSession() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            statusDiv.innerHTML = '<div class="status info">Verificando sesi√≥n...</div>';
            resultsDiv.innerHTML = '';
            
            try {
                const response = await fetch('/api/auth/session');
                const session = await response.json();
                
                const sessionInfo = {
                    autenticado: !!session?.user,
                    email: session?.user?.email || 'No autenticado',
                    rol: session?.user?.role || 'No definido',
                    userId: session?.user?.id || 'No disponible'
                };
                
                let statusClass = 'info';
                let statusText = 'Sesi√≥n encontrada';
                
                if (!session?.user) {
                    statusClass = 'error';
                    statusText = '‚ùå No hay sesi√≥n activa. Por favor, inicia sesi√≥n primero.';
                } else if (session.user.role !== 'admin') {
                    statusClass = 'error';
                    statusText = `‚ö†Ô∏è Rol actual: "${session.user.role}". Deber√≠a ser "admin".`;
                } else {
                    statusClass = 'success';
                    statusText = '‚úÖ Rol admin detectado correctamente!';
                }
                
                statusDiv.innerHTML = `<div class="status ${statusClass}">${statusText}</div>`;
                resultsDiv.innerHTML = `
                    <h3>Informaci√≥n de Sesi√≥n:</h3>
                    <pre>${JSON.stringify(sessionInfo, null, 2)}</pre>
                    <pre>${JSON.stringify(session, null, 2)}</pre>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Error: ${error.message}</div>`;
            }
        }
        
        async function forceUpdate() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            statusDiv.innerHTML = '<div class="status info">Forzando actualizaci√≥n del token...</div>';
            
            try {
                // Primero verificar si hay sesi√≥n
                const sessionResponse = await fetch('/api/auth/session');
                const session = await sessionResponse.json();
                
                if (!session?.user) {
                    statusDiv.innerHTML = '<div class="status error">‚ùå No hay sesi√≥n activa. Por favor, inicia sesi√≥n primero.</div>';
                    return;
                }
                
                // Intentar forzar actualizaci√≥n usando el endpoint de NextAuth
                // NextAuth no tiene un endpoint directo, pero podemos intentar
                // hacer una petici√≥n que fuerce la recarga
                
                // Opci√≥n 1: Llamar al endpoint de actualizaci√≥n de rol
                const updateResponse = await fetch('/api/auth/update-role', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const updateResult = await updateResponse.json();
                
                // Opci√≥n 2: Forzar recarga del token haciendo una petici√≥n
                // que NextAuth procese (esto puede no funcionar directamente)
                
                statusDiv.innerHTML = '<div class="status info">‚ö†Ô∏è La actualizaci√≥n del token requiere recargar la p√°gina o cerrar sesi√≥n y volver a iniciar sesi√≥n.</div>';
                
                resultsDiv.innerHTML = `
                    <h3>Resultado:</h3>
                    <pre>${JSON.stringify(updateResult, null, 2)}</pre>
                    <p><strong>Pr√≥ximos pasos:</strong></p>
                    <ol>
                        <li>Cierra sesi√≥n completamente</li>
                        <li>Limpia las cookies del sitio</li>
                        <li>Vuelve a iniciar sesi√≥n</li>
                        <li>El nuevo callback JWT deber√≠a cargar el rol correctamente</li>
                    </ol>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Error: ${error.message}</div>`;
            }
        }
        
        async function testAdminAccess() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            statusDiv.innerHTML = '<div class="status info">Probando acceso al panel admin...</div>';
            
            try {
                const response = await fetch('/admin', {
                    method: 'GET',
                    redirect: 'manual'
                });
                
                const result = {
                    status: response.status,
                    statusText: response.statusText,
                    url: response.url,
                    redirected: response.type === 'opaqueredirect' || response.redirected,
                    headers: Object.fromEntries(response.headers.entries())
                };
                
                let statusClass = 'error';
                let statusText = '‚ùå Acceso denegado';
                
                if (response.status === 200 || response.ok) {
                    statusClass = 'success';
                    statusText = '‚úÖ Acceso permitido al panel admin!';
                } else if (response.status === 401 || response.status === 403) {
                    statusText = '‚ùå Acceso denegado - Verifica tu rol en la sesi√≥n';
                } else if (response.redirected || response.type === 'opaqueredirect') {
                    statusText = '‚ö†Ô∏è Redirigido - Probablemente a /access-denied';
                }
                
                statusDiv.innerHTML = `<div class="status ${statusClass}">${statusText}</div>`;
                resultsDiv.innerHTML = `
                    <h3>Resultado de la Prueba:</h3>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Error: ${error.message}</div>`;
            }
        }
        
        // Verificar sesi√≥n al cargar
        window.addEventListener('load', () => {
            checkSession();
        });
    </script>
</body>
</html>



