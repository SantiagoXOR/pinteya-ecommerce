<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpiar Storage - Pinteya</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #ea5a17;
            text-align: center;
        }
        button {
            background: #ea5a17;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        button:hover {
            background: #d14d0f;
        }
        .success {
            background: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            background: #2196F3;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .warning {
            background: #ff9800;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Limpiar Storage Corrupto - Pinteya</h1>
        
        <div class="info">
            <strong>¬øPara qu√© sirve esta p√°gina?</strong><br>
            Esta herramienta limpia datos corruptos de localStorage que pueden causar errores JSON en la aplicaci√≥n Pinteya.
        </div>

        <div class="warning">
            <strong>‚ö†Ô∏è Advertencia:</strong><br>
            Esto eliminar√° todos los datos guardados localmente (carrito, b√∫squedas recientes, preferencias).
        </div>

        <h3>Acciones Disponibles:</h3>
        
        <button onclick="inspectStorage()">üîç Inspeccionar Storage</button>
        <button onclick="cleanCorrupted()">üßπ Limpiar Solo Corruptos</button>
        <button onclick="clearAll()">üóëÔ∏è Limpiar Todo</button>
        <button onclick="detectProblems()">üö® Detectar Problemas</button>

        <div id="results"></div>

        <h3>Instrucciones:</h3>
        <ol>
            <li><strong>Inspeccionar Storage:</strong> Ver qu√© datos est√°n guardados</li>
            <li><strong>Limpiar Solo Corruptos:</strong> Eliminar solo datos da√±ados</li>
            <li><strong>Limpiar Todo:</strong> Eliminar todos los datos de Pinteya</li>
            <li><strong>Detectar Problemas:</strong> Buscar datos que puedan causar errores</li>
        </ol>

        <div class="info">
            <strong>üí° Tip:</strong> Despu√©s de limpiar, recarga la p√°gina principal de Pinteya.
        </div>
    </div>

    <script>
        const STORAGE_KEYS = {
            CART: 'pinteya-cart',
            RECENT_SEARCHES: 'pinteya-recent-searches',
            USER_PREFERENCES: 'pinteya-user-preferences',
            ANALYTICS: 'pinteya-analytics',
        };

        function showResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            results.appendChild(div);
            
            // Auto-scroll to results
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function inspectStorage() {
            clearResults();
            showResult('<strong>üîç Inspeccionando localStorage...</strong>');
            
            const keys = Object.values(STORAGE_KEYS);
            let report = '<pre>';
            
            keys.forEach(key => {
                try {
                    const stored = localStorage.getItem(key);
                    if (stored) {
                        const isValidJSON = (() => {
                            try {
                                JSON.parse(stored);
                                return '‚úÖ V√°lido';
                            } catch {
                                return '‚ùå Corrupto';
                            }
                        })();
                        
                        report += `üì¶ ${key}:\n`;
                        report += `   Tama√±o: ${stored.length} caracteres\n`;
                        report += `   Estado: ${isValidJSON}\n`;
                        report += `   Preview: ${stored.substring(0, 50)}${stored.length > 50 ? '...' : ''}\n\n`;
                    } else {
                        report += `üì¶ ${key}: (vac√≠o)\n\n`;
                    }
                } catch (error) {
                    report += `üì¶ ${key}: ‚ùå Error de acceso - ${error.message}\n\n`;
                }
            });
            
            report += '</pre>';
            showResult(report, 'info');
        }

        function cleanCorrupted() {
            clearResults();
            showResult('<strong>üßπ Limpiando datos corruptos...</strong>');
            
            const keys = Object.values(STORAGE_KEYS);
            let cleanedCount = 0;
            let report = '<pre>';
            
            keys.forEach(key => {
                try {
                    const stored = localStorage.getItem(key);
                    if (stored) {
                        // Detectar problemas espec√≠ficos
                        let isCorrupted = false;
                        let reason = '';
                        
                        if (stored === '""' || stored === "''") {
                            isCorrupted = true;
                            reason = 'Comillas vac√≠as';
                        } else if (stored.includes('""') && stored.length < 5) {
                            isCorrupted = true;
                            reason = 'Comillas corruptas';
                        } else if (stored.trim() === '') {
                            isCorrupted = true;
                            reason = 'String vac√≠o';
                        } else {
                            try {
                                JSON.parse(stored);
                            } catch (parseError) {
                                isCorrupted = true;
                                reason = 'JSON inv√°lido';
                            }
                        }
                        
                        if (isCorrupted) {
                            localStorage.removeItem(key);
                            cleanedCount++;
                            report += `üßπ Limpiado ${key}: ${reason}\n`;
                        } else {
                            report += `‚úÖ ${key}: OK\n`;
                        }
                    }
                } catch (error) {
                    localStorage.removeItem(key);
                    cleanedCount++;
                    report += `üßπ Limpiado ${key}: Error de acceso\n`;
                }
            });
            
            report += `\nüéâ Total limpiado: ${cleanedCount} entradas`;
            report += '</pre>';
            
            showResult(report, cleanedCount > 0 ? 'success' : 'info');
        }

        function clearAll() {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar TODOS los datos de Pinteya? Esto incluye carrito, b√∫squedas recientes y preferencias.')) {
                return;
            }
            
            clearResults();
            showResult('<strong>üóëÔ∏è Limpiando todos los datos...</strong>');
            
            const keys = Object.values(STORAGE_KEYS);
            let clearedCount = 0;
            let report = '<pre>';
            
            keys.forEach(key => {
                try {
                    if (localStorage.getItem(key)) {
                        localStorage.removeItem(key);
                        clearedCount++;
                        report += `üóëÔ∏è Eliminado: ${key}\n`;
                    } else {
                        report += `üì¶ ${key}: ya estaba vac√≠o\n`;
                    }
                } catch (error) {
                    report += `‚ùå Error eliminando ${key}: ${error.message}\n`;
                }
            });
            
            report += `\nüéâ Total eliminado: ${clearedCount} entradas`;
            report += '</pre>';
            
            showResult(report, 'success');
        }

        function detectProblems() {
            clearResults();
            showResult('<strong>üö® Detectando problemas JSON...</strong>');
            
            const keys = Object.values(STORAGE_KEYS);
            const problems = [];
            
            keys.forEach(key => {
                try {
                    const stored = localStorage.getItem(key);
                    if (stored) {
                        // Detectar problemas espec√≠ficos
                        if (stored === '""' || stored === "''") {
                            problems.push({key, issue: 'Comillas vac√≠as', data: stored});
                        } else if (stored.includes('""') && stored.length < 5) {
                            problems.push({key, issue: 'Comillas corruptas', data: stored});
                        } else if (stored.trim() === '') {
                            problems.push({key, issue: 'String vac√≠o', data: stored});
                        } else {
                            try {
                                JSON.parse(stored);
                            } catch (parseError) {
                                problems.push({key, issue: 'JSON inv√°lido', data: stored.substring(0, 50) + '...'});
                            }
                        }
                    }
                } catch (error) {
                    problems.push({key, issue: 'Error de acceso', data: error.message});
                }
            });

            let report = '<pre>';
            if (problems.length > 0) {
                report += '‚ùå Problemas encontrados:\n\n';
                problems.forEach(problem => {
                    report += `üî¥ ${problem.key}:\n`;
                    report += `   Problema: ${problem.issue}\n`;
                    report += `   Datos: ${problem.data}\n\n`;
                });
            } else {
                report += '‚úÖ No se encontraron problemas JSON\n';
            }
            report += '</pre>';
            
            showResult(report, problems.length > 0 ? 'warning' : 'success');
        }

        // Auto-detectar problemas al cargar la p√°gina
        window.addEventListener('load', () => {
            setTimeout(detectProblems, 1000);
        });
    </script>
</body>
</html>
