# üîß ACTUALIZACIONES DE C√ìDIGO POST-MIGRACI√ìN
## Eliminaci√≥n Dependencias Clerk + Consolidaci√≥n user_profiles

**Fecha**: 13 de Septiembre, 2025  
**Objetivo**: Actualizar c√≥digo para usar user_profiles como tabla principal  
**Tiempo estimado**: 2-3 horas  

---

## üìã RESUMEN DE CAMBIOS REQUERIDOS

### **CAMBIOS ESTRUCTURALES**
- ‚úÖ **Base de datos**: users ‚Üí user_profiles (COMPLETADO)
- üîÑ **Tipos TypeScript**: Actualizar interfaces
- üîÑ **APIs**: Cambiar referencias de tabla
- üîÑ **Componentes**: Actualizar campos de usuario
- ‚ùå **Webhooks Clerk**: Eliminar completamente

---

## üéØ ARCHIVOS A ACTUALIZAR

### **1. TIPOS TYPESCRIPT**

#### **src/types/database.ts**
```typescript
// ANTES (con Clerk)
export interface Database {
  public: {
    Tables: {
      users: {
        Row: {
          id: string;
          clerk_id: string;  // ‚Üê ELIMINAR
          email: string;
          name: string | null;
          created_at: string;
        };
        Insert: {
          id?: string;
          clerk_id: string;  // ‚Üê ELIMINAR
          email: string;
          name?: string | null;
          created_at?: string;
        };
        Update: {
          id?: string;
          clerk_id?: string;  // ‚Üê ELIMINAR
          email?: string;
          name?: string | null;
          created_at?: string;
        };
      };
    };
  };
}

// DESPU√âS (sin Clerk, usando user_profiles)
export interface Database {
  public: {
    Tables: {
      user_profiles: {  // ‚Üê CAMBIO DE NOMBRE
        Row: {
          id: string;
          email: string;
          first_name: string | null;  // ‚Üê NUEVO
          last_name: string | null;   // ‚Üê NUEVO
          role_id: string | null;     // ‚Üê NUEVO
          is_active: boolean;         // ‚Üê NUEVO
          metadata: any;              // ‚Üê NUEVO
          created_at: string;
          updated_at: string;         // ‚Üê NUEVO
        };
        Insert: {
          id?: string;
          email: string;
          first_name?: string | null;
          last_name?: string | null;
          role_id?: string | null;
          is_active?: boolean;
          metadata?: any;
          created_at?: string;
          updated_at?: string;
        };
        Update: {
          id?: string;
          email?: string;
          first_name?: string | null;
          last_name?: string | null;
          role_id?: string | null;
          is_active?: boolean;
          metadata?: any;
          updated_at?: string;
        };
      };
    };
  };
}
```

### **2. APIS DE USUARIO**

#### **src/app/api/user/addresses/route.ts**
```typescript
// ANTES
const { data: user } = await supabaseAdmin
  .from('users')  // ‚Üê CAMBIAR
  .select('id')
  .eq('clerk_id', session.user.id)  // ‚Üê CAMBIAR
  .single();

// DESPU√âS
const { data: user } = await supabaseAdmin
  .from('user_profiles')  // ‚Üê NUEVO
  .select('id')
  .eq('id', session.user.id)  // ‚Üê DIRECTO POR ID
  .single();

// Auto-creaci√≥n de usuario actualizada
if (!user && userError?.code === 'PGRST116') {
  const { data: newUser, error: createError } = await supabaseAdmin
    .from('user_profiles')  // ‚Üê CAMBIO
    .insert({
      id: session.user.id,
      email: session.user.email,
      first_name: session.user.name?.split(' ')[0] || null,  // ‚Üê NUEVO
      last_name: session.user.name?.split(' ').slice(1).join(' ') || null,  // ‚Üê NUEVO
      role_id: null,  // ‚Üê NUEVO
      is_active: true,  // ‚Üê NUEVO
      metadata: {  // ‚Üê NUEVO
        created_via: 'nextauth_auto',
        source: 'address_api',
        created_at: new Date().toISOString()
      },
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    })
    .select('id')
    .single();
}
```

#### **src/app/api/user/profile/route.ts** (si existe)
```typescript
// Actualizar para usar user_profiles con nueva estructura
export async function GET() {
  const session = await auth();
  if (!session?.user) {
    return NextResponse.json({ error: 'No autorizado' }, { status: 401 });
  }

  const { data: profile, error } = await supabaseAdmin
    .from('user_profiles')  // ‚Üê CAMBIO
    .select(`
      id,
      email,
      first_name,
      last_name,
      role_id,
      is_active,
      metadata,
      created_at,
      updated_at,
      user_roles (
        role_name,
        permissions
      )
    `)
    .eq('id', session.user.id)
    .single();

  if (error) {
    return NextResponse.json({ error: 'Usuario no encontrado' }, { status: 404 });
  }

  return NextResponse.json({ profile });
}
```

### **3. COMPONENTES DE USUARIO**

#### **Actualizar componentes que muestran informaci√≥n de usuario**
```typescript
// ANTES
interface UserDisplayProps {
  user: {
    id: string;
    clerk_id: string;  // ‚Üê ELIMINAR
    email: string;
    name: string | null;
  };
}

// DESPU√âS
interface UserDisplayProps {
  user: {
    id: string;
    email: string;
    first_name: string | null;  // ‚Üê NUEVO
    last_name: string | null;   // ‚Üê NUEVO
    role_id: string | null;     // ‚Üê NUEVO
    is_active: boolean;         // ‚Üê NUEVO
  };
}

// Funci√≥n helper para nombre completo
function getFullName(user: UserProfile): string {
  if (user.first_name && user.last_name) {
    return `${user.first_name} ${user.last_name}`;
  }
  return user.first_name || user.email.split('@')[0];
}
```

### **4. HOOKS Y UTILIDADES**

#### **src/hooks/useUser.ts** (si existe)
```typescript
// Actualizar hook para usar user_profiles
export function useUser() {
  const { data: session } = useSession();
  
  const { data: profile, error, isLoading } = useSWR(
    session?.user ? `/api/user/profile` : null,
    fetcher
  );

  return {
    user: profile?.profile,
    isLoading,
    error,
    isAuthenticated: !!session?.user
  };
}
```

---

## üóëÔ∏è ARCHIVOS A ELIMINAR

### **1. WEBHOOKS CLERK**
```bash
# Eliminar completamente
rm src/app/api/webhooks/clerk/route.ts
```

### **2. SCRIPTS LEGACY**
```bash
# Eliminar scripts de migraci√≥n Clerk
rm scripts/sync-admin-clerk.js
rm scripts/update-clerk-metadata.js
rm scripts/migrate-clerk-*.js
```

### **3. UTILIDADES CLERK**
```bash
# Buscar y eliminar archivos con referencias Clerk
find src/ -name "*.ts" -o -name "*.tsx" | xargs grep -l "clerk" | head -10
```

---

## üîß SCRIPTS DE ACTUALIZACI√ìN AUTOM√ÅTICA

### **Script para actualizar imports**
```bash
# scripts/update-imports.sh
#!/bin/bash

echo "üîÑ Actualizando imports de 'users' a 'user_profiles'..."

# Buscar y reemplazar en archivos TypeScript
find src/ -name "*.ts" -o -name "*.tsx" | xargs sed -i 's/\.from('\''users'\'')/\.from('\''user_profiles'\'')/g'

# Buscar y reemplazar referencias a clerk_id
find src/ -name "*.ts" -o -name "*.tsx" | xargs sed -i 's/clerk_id/id/g'

echo "‚úÖ Imports actualizados"
```

### **Script para verificar referencias Clerk**
```bash
# scripts/check-clerk-references.sh
#!/bin/bash

echo "üîç Buscando referencias a Clerk..."

# Buscar archivos con referencias Clerk
echo "Archivos con 'clerk':"
find src/ -name "*.ts" -o -name "*.tsx" | xargs grep -l "clerk" 2>/dev/null || echo "Ninguno encontrado"

echo "Archivos con 'Clerk':"
find src/ -name "*.ts" -o -name "*.tsx" | xargs grep -l "Clerk" 2>/dev/null || echo "Ninguno encontrado"

echo "Archivos con '@clerk':"
find src/ -name "*.ts" -o -name "*.tsx" | xargs grep -l "@clerk" 2>/dev/null || echo "Ninguno encontrado"

echo "‚úÖ Verificaci√≥n completada"
```

---

## üß™ PLAN DE TESTING

### **1. Tests de APIs**
```typescript
// __tests__/api/user/addresses.test.ts
describe('User Addresses API - Post Migration', () => {
  it('should create user automatically in user_profiles', async () => {
    // Mock NextAuth session
    const mockSession = {
      user: {
        id: 'test-user-id',
        email: 'test@example.com',
        name: 'Test User'
      }
    };

    // Test que el usuario se crea en user_profiles
    const response = await POST(mockRequest);
    
    expect(response.status).toBe(200);
    
    // Verificar que se cre√≥ en user_profiles
    const user = await supabase
      .from('user_profiles')
      .select('*')
      .eq('id', 'test-user-id')
      .single();
    
    expect(user.data).toBeTruthy();
    expect(user.data.email).toBe('test@example.com');
    expect(user.data.first_name).toBe('Test');
    expect(user.data.last_name).toBe('User');
  });
});
```

### **2. Tests de Componentes**
```typescript
// __tests__/components/UserProfile.test.tsx
describe('UserProfile Component - Post Migration', () => {
  it('should display user name from first_name + last_name', () => {
    const mockUser = {
      id: 'test-id',
      email: 'test@example.com',
      first_name: 'John',
      last_name: 'Doe',
      role_id: 'customer-role',
      is_active: true
    };

    render(<UserProfile user={mockUser} />);
    
    expect(screen.getByText('John Doe')).toBeInTheDocument();
  });
});
```

### **3. Tests de Integraci√≥n**
```typescript
// __tests__/integration/user-flow.test.ts
describe('User Flow Integration - Post Migration', () => {
  it('should complete full user journey with user_profiles', async () => {
    // 1. Login con NextAuth
    // 2. Auto-creaci√≥n en user_profiles
    // 3. Crear direcci√≥n
    // 4. Crear orden
    // 5. Verificar datos en user_profiles
  });
});
```

---

## üìä CHECKLIST DE VERIFICACI√ìN

### **Pre-Actualizaci√≥n**
- [ ] Backup de c√≥digo actual creado
- [ ] Migraci√≥n de base de datos completada exitosamente
- [ ] Tests existentes documentados

### **Durante Actualizaci√≥n**
- [ ] Tipos TypeScript actualizados
- [ ] APIs de usuario actualizadas
- [ ] Componentes de usuario actualizados
- [ ] Webhooks Clerk eliminados
- [ ] Scripts legacy eliminados

### **Post-Actualizaci√≥n**
- [ ] Funcionalidad de direcciones operativa
- [ ] Sistema de √≥rdenes funcionando
- [ ] Autenticaci√≥n NextAuth estable
- [ ] Tests actualizados y pasando
- [ ] Sin referencias a Clerk en c√≥digo
- [ ] Logs de aplicaci√≥n limpios

### **Verificaci√≥n Final**
- [ ] Usuario puede crear cuenta
- [ ] Usuario puede gestionar direcciones
- [ ] Usuario puede crear √≥rdenes
- [ ] Admin puede ver usuarios en user_profiles
- [ ] M√©tricas y analytics funcionando

---

## üöÄ ORDEN DE EJECUCI√ìN

### **Fase 1: Preparaci√≥n (30 min)**
1. Crear backup del c√≥digo actual
2. Ejecutar scripts de verificaci√≥n
3. Documentar estado actual

### **Fase 2: Actualizaci√≥n Core (1 hora)**
1. Actualizar tipos TypeScript
2. Actualizar APIs de usuario
3. Eliminar webhooks Clerk

### **Fase 3: Actualizaci√≥n UI (30 min)**
1. Actualizar componentes de usuario
2. Actualizar hooks y utilidades
3. Eliminar scripts legacy

### **Fase 4: Testing (1 hora)**
1. Ejecutar tests actualizados
2. Probar flujo completo de usuario
3. Verificar funcionalidades cr√≠ticas

### **Fase 5: Verificaci√≥n (30 min)**
1. Revisar logs de aplicaci√≥n
2. Confirmar m√©tricas funcionando
3. Documentar cambios completados

**Tiempo Total Estimado**: 3.5 horas

---

## üéØ RESULTADO ESPERADO

### **C√≥digo Limpio**
- ‚úÖ 0 referencias a Clerk
- ‚úÖ user_profiles como tabla principal
- ‚úÖ Estructura moderna de usuarios
- ‚úÖ Compatibilidad total con NextAuth

### **Funcionalidad Preservada**
- ‚úÖ Autenticaci√≥n funcionando
- ‚úÖ Gesti√≥n de direcciones operativa
- ‚úÖ Sistema de √≥rdenes estable
- ‚úÖ Analytics sin interrupciones

### **Base para Futuro**
- ‚úÖ Estructura escalable
- ‚úÖ Roles de usuario implementados
- ‚úÖ Metadata flexible
- ‚úÖ Integraci√≥n nativa con Supabase

**¬°Pinteya E-commerce listo para crecer sin dependencias legacy!** üöÄ
