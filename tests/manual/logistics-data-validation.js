// =====================================================
// SCRIPT DE VALIDACI√ìN MANUAL - PANEL DE LOG√çSTICA
// Descripci√≥n: Validaci√≥n exhaustiva de datos y funcionalidades
// Ejecutar en consola del navegador en /admin/logistics
// =====================================================

console.log('üöÄ Iniciando validaci√≥n exhaustiva del Panel de Log√≠stica...');

// =====================================================
// 1. VALIDACI√ìN DE APIS Y DATOS REALES
// =====================================================

async function validateAPIs() {
  console.log('\nüì° 1. VALIDANDO APIS Y DATOS REALES...');
  
  try {
    // Llamar a la API principal de log√≠stica
    const response = await fetch('/api/admin/logistics');
    const data = await response.json();
    
    console.log('‚úÖ API /api/admin/logistics responde correctamente');
    console.log('üìä Datos recibidos:', {
      totalShipments: data.stats?.total_shipments,
      activeShipments: data.stats?.active_shipments,
      deliveredShipments: data.stats?.delivered_shipments,
      recentShipmentsCount: data.recent_shipments?.length,
      performanceMetricsCount: data.performance_metrics?.length
    });
    
    // Verificar que no hay datos hardcodeados
    const hasRealData = data.stats?.total_shipments > 0 && data.recent_shipments?.length > 0;
    console.log(hasRealData ? '‚úÖ Datos reales detectados' : '‚ùå Posibles datos hardcodeados');
    
    return data;
  } catch (error) {
    console.error('‚ùå Error al validar APIs:', error);
    return null;
  }
}

// =====================================================
// 2. VALIDACI√ìN DE ELEMENTOS UI
// =====================================================

function validateUIElements() {
  console.log('\nüé® 2. VALIDANDO ELEMENTOS DE UI...');
  
  const checks = [
    { name: 'T√≠tulo principal', selector: 'h1', expectedText: 'Log√≠stica' },
    { name: 'Badge de estado del sistema', selector: '[class*="badge"]', expectedText: 'Sistema' },
    { name: 'Bot√≥n Actualizar', selector: 'button:has-text("Actualizar")', expectedText: 'Actualizar' },
    { name: 'Bot√≥n Crear Env√≠o', selector: 'button:has-text("Crear Env√≠o")', expectedText: 'Crear Env√≠o' },
    { name: 'Pesta√±a Resumen', selector: '[data-value="overview"]', expectedText: 'Resumen' },
    { name: 'Pesta√±a Env√≠os', selector: '[data-value="shipments"]', expectedText: 'Env√≠os' },
    { name: 'Pesta√±a Performance', selector: '[data-value="performance"]', expectedText: 'Performance' },
    { name: 'Pesta√±a Couriers', selector: '[data-value="carriers"]', expectedText: 'Couriers' }
  ];
  
  const results = checks.map(check => {
    const element = document.querySelector(check.selector);
    const exists = !!element;
    const hasCorrectText = exists && element.textContent.includes(check.expectedText);
    
    console.log(`${exists && hasCorrectText ? '‚úÖ' : '‚ùå'} ${check.name}: ${exists ? 'Encontrado' : 'No encontrado'}`);
    
    return { ...check, exists, hasCorrectText };
  });
  
  return results;
}

// =====================================================
// 3. VALIDACI√ìN DE M√âTRICAS Y N√öMEROS
// =====================================================

function validateMetrics() {
  console.log('\nüìä 3. VALIDANDO M√âTRICAS Y N√öMEROS...');
  
  const metrics = [];
  
  // Buscar todas las m√©tricas num√©ricas
  const metricElements = document.querySelectorAll('[class*="text-2xl"], [class*="text-3xl"]');
  
  metricElements.forEach((element, index) => {
    const text = element.textContent.trim();
    const isNumeric = /\d/.test(text);
    const parentText = element.parentElement?.textContent || '';
    
    if (isNumeric) {
      metrics.push({
        index,
        value: text,
        context: parentText.substring(0, 50) + '...',
        isValidNumber: !isNaN(parseFloat(text.replace(/[^\d.,]/g, '')))
      });
      
      console.log(`üìà M√©trica ${index + 1}: ${text} (${parentText.split(' ')[0]})`);
    }
  });
  
  console.log(`‚úÖ Total de m√©tricas encontradas: ${metrics.length}`);
  return metrics;
}

// =====================================================
// 4. VALIDACI√ìN DE FORMATOS
// =====================================================

function validateFormats() {
  console.log('\nüîç 4. VALIDANDO FORMATOS DE DATOS...');
  
  const results = {
    dates: [],
    currencies: [],
    states: []
  };
  
  // Validar fechas (buscar en tabla de env√≠os)
  const dateElements = document.querySelectorAll('tbody td:last-child');
  dateElements.forEach((element, index) => {
    const text = element.textContent.trim();
    const dateRegex = /^\d{2}\/\d{2}\/\d{4}$/;
    const isValidDate = dateRegex.test(text);
    
    results.dates.push({ index, text, isValid: isValidDate });
    
    if (index < 3) { // Solo mostrar primeros 3
      console.log(`üìÖ Fecha ${index + 1}: ${text} ${isValidDate ? '‚úÖ' : '‚ùå'}`);
    }
  });
  
  // Validar monedas
  const currencyElements = document.querySelectorAll('tbody td:nth-child(6)');
  currencyElements.forEach((element, index) => {
    const text = element.textContent.trim();
    const currencyRegex = /^\$\s*[\d.,]+$/;
    const isValidCurrency = currencyRegex.test(text);
    
    results.currencies.push({ index, text, isValid: isValidCurrency });
    
    if (index < 3) { // Solo mostrar primeros 3
      console.log(`üí∞ Moneda ${index + 1}: ${text} ${isValidCurrency ? '‚úÖ' : '‚ùå'}`);
    }
  });
  
  // Validar estados
  const stateElements = document.querySelectorAll('tbody td:nth-child(3)');
  const validStates = ['Pendiente', 'Confirmado', 'En Tr√°nsito', 'Entregado', 'Cancelado'];
  
  stateElements.forEach((element, index) => {
    const text = element.textContent.trim();
    const isValidState = validStates.some(state => text.includes(state));
    
    results.states.push({ index, text, isValid: isValidState });
    
    if (index < 3) { // Solo mostrar primeros 3
      console.log(`üè∑Ô∏è Estado ${index + 1}: ${text} ${isValidState ? '‚úÖ' : '‚ùå'}`);
    }
  });
  
  return results;
}

// =====================================================
// 5. VALIDACI√ìN DE CONSISTENCIA ENTRE PESTA√ëAS
// =====================================================

async function validateTabConsistency() {
  console.log('\nüîÑ 5. VALIDANDO CONSISTENCIA ENTRE PESTA√ëAS...');
  
  const results = {};
  
  // Obtener datos de pesta√±a Resumen
  const overviewTab = document.querySelector('[data-value="overview"]');
  if (overviewTab) {
    overviewTab.click();
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    const totalShipmentsElement = document.querySelector('text=Total Env√≠os')?.parentElement?.querySelector('[class*="text-2xl"]');
    const totalFromOverview = totalShipmentsElement ? parseInt(totalShipmentsElement.textContent.replace(/[^\d]/g, '')) : 0;
    
    results.overviewTotal = totalFromOverview;
    console.log(`üìä Total env√≠os (Resumen): ${totalFromOverview}`);
  }
  
  // Obtener datos de pesta√±a Env√≠os
  const shipmentsTab = document.querySelector('[data-value="shipments"]');
  if (shipmentsTab) {
    shipmentsTab.click();
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    const shipmentRows = document.querySelectorAll('tbody tr');
    const shipmentsCount = shipmentRows.length;
    
    results.shipmentsTableCount = shipmentsCount;
    console.log(`üìã Env√≠os en tabla: ${shipmentsCount}`);
    
    // Verificar consistencia
    const isConsistent = shipmentsCount <= results.overviewTotal;
    console.log(`${isConsistent ? '‚úÖ' : '‚ùå'} Consistencia: ${isConsistent ? 'OK' : 'FALLO'}`);
  }
  
  return results;
}

// =====================================================
// 6. TESTING DE BOTONES Y FUNCIONALIDADES
// =====================================================

async function testInteractions() {
  console.log('\nüñ±Ô∏è 6. TESTING DE INTERACCIONES...');
  
  const results = [];
  
  // Test bot√≥n Actualizar
  const refreshButton = document.querySelector('button:has-text("Actualizar")');
  if (refreshButton) {
    console.log('üîÑ Testing bot√≥n Actualizar...');
    
    // Interceptar llamadas de red
    let apiCalled = false;
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
      if (args[0].includes('/api/admin/logistics')) {
        apiCalled = true;
        console.log('üì° API llamada detectada:', args[0]);
      }
      return originalFetch.apply(this, args);
    };
    
    refreshButton.click();
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    window.fetch = originalFetch; // Restaurar fetch original
    
    results.push({
      name: 'Bot√≥n Actualizar',
      success: apiCalled,
      message: apiCalled ? 'API llamada correctamente' : 'No se detect√≥ llamada a API'
    });
    
    console.log(`${apiCalled ? '‚úÖ' : '‚ùå'} Bot√≥n Actualizar: ${apiCalled ? 'Funciona' : 'No funciona'}`);
  }
  
  // Test filtros y b√∫squeda
  const searchInput = document.querySelector('input[placeholder*="Buscar"]');
  if (searchInput) {
    console.log('üîç Testing b√∫squeda...');
    
    const initialRows = document.querySelectorAll('tbody tr').length;
    searchInput.value = 'TRK';
    searchInput.dispatchEvent(new Event('input', { bubbles: true }));
    
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    const filteredRows = document.querySelectorAll('tbody tr').length;
    const searchWorks = filteredRows !== initialRows;
    
    results.push({
      name: 'Funcionalidad de b√∫squeda',
      success: searchWorks,
      message: `${initialRows} ‚Üí ${filteredRows} filas`
    });
    
    console.log(`${searchWorks ? '‚úÖ' : '‚ùå'} B√∫squeda: ${searchWorks ? 'Funciona' : 'No funciona'}`);
    
    // Limpiar b√∫squeda
    searchInput.value = '';
    searchInput.dispatchEvent(new Event('input', { bubbles: true }));
  }
  
  return results;
}

// =====================================================
// 7. FUNCI√ìN PRINCIPAL DE VALIDACI√ìN
// =====================================================

async function runCompleteValidation() {
  console.log('üéØ INICIANDO VALIDACI√ìN COMPLETA DEL PANEL DE LOG√çSTICA');
  console.log('=' .repeat(60));
  
  const report = {
    timestamp: new Date().toISOString(),
    results: {}
  };
  
  try {
    // 1. Validar APIs
    report.results.apiData = await validateAPIs();
    
    // 2. Validar elementos UI
    report.results.uiElements = validateUIElements();
    
    // 3. Validar m√©tricas
    report.results.metrics = validateMetrics();
    
    // 4. Validar formatos
    report.results.formats = validateFormats();
    
    // 5. Validar consistencia
    report.results.consistency = await validateTabConsistency();
    
    // 6. Test interacciones
    report.results.interactions = await testInteractions();
    
    // Generar resumen
    console.log('\nüìã RESUMEN DE VALIDACI√ìN:');
    console.log('=' .repeat(40));
    
    const apiValid = !!report.results.apiData;
    const uiValid = report.results.uiElements.every(el => el.exists && el.hasCorrectText);
    const metricsValid = report.results.metrics.length > 0;
    const formatsValid = report.results.formats.dates.every(d => d.isValid) && 
                        report.results.formats.currencies.every(c => c.isValid);
    const interactionsValid = report.results.interactions.every(i => i.success);
    
    console.log(`üì° APIs: ${apiValid ? '‚úÖ PASS' : '‚ùå FAIL'}`);
    console.log(`üé® UI Elements: ${uiValid ? '‚úÖ PASS' : '‚ùå FAIL'}`);
    console.log(`üìä M√©tricas: ${metricsValid ? '‚úÖ PASS' : '‚ùå FAIL'}`);
    console.log(`üîç Formatos: ${formatsValid ? '‚úÖ PASS' : '‚ùå FAIL'}`);
    console.log(`üñ±Ô∏è Interacciones: ${interactionsValid ? '‚úÖ PASS' : '‚ùå FAIL'}`);
    
    const overallScore = [apiValid, uiValid, metricsValid, formatsValid, interactionsValid]
      .filter(Boolean).length;
    
    console.log(`\nüéØ SCORE GENERAL: ${overallScore}/5 (${(overallScore/5*100).toFixed(0)}%)`);
    
    if (overallScore === 5) {
      console.log('üéâ ¬°PANEL DE LOG√çSTICA COMPLETAMENTE FUNCIONAL!');
    } else {
      console.log('‚ö†Ô∏è Panel tiene algunos problemas que requieren atenci√≥n');
    }
    
    return report;
    
  } catch (error) {
    console.error('‚ùå Error durante la validaci√≥n:', error);
    return { error: error.message, timestamp: new Date().toISOString() };
  }
}

// =====================================================
// EJECUTAR VALIDACI√ìN
// =====================================================

// Ejecutar autom√°ticamente
runCompleteValidation().then(report => {
  console.log('\nüíæ Reporte completo guardado en variable global: window.logisticsValidationReport');
  window.logisticsValidationReport = report;
});

// Tambi√©n exportar funciones individuales para testing manual
window.logisticsValidation = {
  validateAPIs,
  validateUIElements,
  validateMetrics,
  validateFormats,
  validateTabConsistency,
  testInteractions,
  runCompleteValidation
};

console.log('\nüîß Funciones disponibles en window.logisticsValidation para testing manual');
